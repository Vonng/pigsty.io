<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="/zh/blog/admin/">
<link rel="alternate" type="application/rss&#43;xml" href="/zh/blog/admin/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>PG 管理 | Pigsty</title>
<meta name="description" content="PostgreSQL 运维管理诊断调优的的经验
">
<meta property="og:title" content="PG 管理" />
<meta property="og:description" content="PostgreSQL 运维管理诊断调优的的经验
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/zh/blog/admin/" />

<meta itemprop="name" content="PG 管理">
<meta itemprop="description" content="PostgreSQL 运维管理诊断调优的的经验
"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="PG 管理"/>
<meta name="twitter:description" content="PostgreSQL 运维管理诊断调优的的经验
"/>




<link rel="preload" href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" as="style">
<link href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="/js/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LG1V9WTKGE');
}
</script>
  </head>
  <body class="td-section td-blog">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/zh/"><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class="navbar-brand__name">Pigsty</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/zh/docs/"><i class='fa-solid fa-book'></i><span>文档</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="/zh/blog/"><i class="fas fa-blog"></i><span>博客</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/Vonng/pigsty/" target="_blank" rel="noopener"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Link</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/docs/">v3 Docs</a></li>
    <li><a class="dropdown-item" href="https://demo.pigsty.cc">Public Demo</a></li>
    <li><a class="dropdown-item" href="https://ext.pigsty.io">Extension Repo</a></li>
    <li><a class="dropdown-item" href="https://pigsty.cc/zh/docs">pigsty.cc</a></li>
    <li><a class="dropdown-item" href="https://pigsty.cc/zh/blog">ZH Blog</a></li>
    </ul>
</div></li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-language"></i>中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/">English</a></li>
    </ul>
</div>
</li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.4254d9d640516c9dc82343a43641b8bc.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/zh/blog/admin/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">PG 管理</h1>
<div class="lead">PostgreSQL 运维管理诊断调优的的经验</div>




    <ul>
    
  
  
  
  

  
    
    
	

    <li><a href="#pg-1a92238e99590240143d4a2a0d17f98b">PostgreSQL 逻辑复制详解</a></li>



    
  
    
    
	

    <li><a href="#pg-f7dcbee2dc636abe5d32bc9a6a706dd1">PostgreSQL 宏观查询优化之 pg_stat_statements</a></li>



    
  
    
    
	

    <li><a href="#pg-84becda4486f629dfc08aa6043d6355d">如何用 pg_filedump 抢救数据？</a></li>



    
  
    
    
	

    <li><a href="#pg-2377d45fe5a041b3e08890413b2432b6">PG中的本地化排序规则</a></li>



    
  
    
    
	

    <li><a href="#pg-eddc668f26db53c6b78bd6f6dd86dc14">PG复制标识详解（Replica Identity）</a></li>



    
  
    
    
	

    <li><a href="#pg-42550a24271212176fd42acc36caec44">PG慢查询诊断方法论</a></li>



    
  
    
    
	

    <li><a href="#pg-79b53a6d42ba827e043f36600910a088">故障档案:时间回溯导致的Patroni故障</a></li>



    
  
    
    
	

    <li><a href="#pg-e0d5ab34ac83091f7c860a6f3e6a2dbf">在线修改主键列类型</a></li>



    
  
    
    
	

    <li><a href="#pg-c52a9f6e2ac5fe0ee06804492be08d23">黄金监控指标：错误延迟吞吐饱和</a></li>



    
  
    
    
	

    <li><a href="#pg-ef792c4864e63a9306b3f73197c2f0b4">数据库集群管理概念与实体命名规范</a></li>



    
  
    
    
	

    <li><a href="#pg-6c9b5e7c5ee28bba5543aa06492d809a">PostgreSQL的KPI</a></li>



    
  
    
    
	

    <li><a href="#pg-abe231067c0dd3bdd1f2c8820ed1c6fa">在线修改PG字段类型</a></li>



    
  
    
    
	

    <li><a href="#pg-d657deb9b88e3f9bf3f7a70c003b7ca8">故障档案：PG安装Extension导致无法连接</a></li>



    
  
    
    
	

    <li><a href="#pg-48a755c71a681b6878f489b26311a081">PostgreSQL 常见复制拓扑方案</a></li>



    
  
    
    
	

    <li><a href="#pg-46f4a828c76bcb305bf3446994999026">温备：使用pg_receivewal</a></li>



    
  
    
    
	

    <li><a href="#pg-3232d7867a0db5797d196e1a182929d8">故障档案：pg_dump导致的连接池污染</a></li>



    
  
    
    
	

    <li><a href="#pg-3ec0db5c033e90581311f93e2d359f59">PostgreSQL数据页面损坏修复</a></li>



    
  
    
    
	

    <li><a href="#pg-370cab4bf0902960a0bf658b2d2c5012">关系膨胀的监控与治理</a></li>



    
  
    
    
	

    <li><a href="#pg-6879266c8aefd5664d6bb062fe6bfdca">PipelineDB快速上手</a></li>



    
  
    
    
	

    <li><a href="#pg-3c080b3e959d9025aaa10b4ffdcc7eac">TimescaleDB 快速上手</a></li>



    
  
    
    
	

    <li><a href="#pg-1ffa0ab167bac4475b9a69f4abbf18e0">故障档案：PostgreSQL事务号回卷</a></li>



    
  
    
    
	

    <li><a href="#pg-961294574a35a9dedff38173eb28701f">故障档案：序列号消耗过快导致整型溢出</a></li>



    
  
    
    
	

    <li><a href="#pg-92a909645a0cf65d2bc3fc154f629d84">监控PG中的表大小</a></li>



    
  
    
    
	

    <li><a href="#pg-7d0a12d18bf823797011a62acdd76153">PgAdmin安装配置</a></li>



    
  
    
    
	

    <li><a href="#pg-4655d4b17c08103df8117b42ac19b781">故障档案：快慢不匀雪崩</a></li>



    
  
    
    
	

    <li><a href="#pg-65f1c440b6445ad21a178cdac3f9e31b">Bash与psql小技巧</a></li>



    
  
    
    
	

    <li><a href="#pg-5404a58698fda52f4400a19c3ac76a67">PostgreSQL例行维护</a></li>



    
  
    
    
	

    <li><a href="#pg-9476bf9d0e915c061ced1461d255c19c">备份恢复手段概览</a></li>



    
  
    
    
	

    <li><a href="#pg-4e34a5f7f29d501e8880ca9e3d3c7fd7">PgBackRest2中文文档</a></li>



    
  
    
    
	

    <li><a href="#pg-b6d04532810e3534f8f94be5a5d5f882">Pgbouncer快速上手</a></li>



    
  
    
    
	

    <li><a href="#pg-a7a6b0d44cfe3a5444b59d6bd20d9679">PG服务器日志常规配置</a></li>



    
  
    
    
	

    <li><a href="#pg-658e59408d0a1041bc6bc51e59b3cf4a">空中换引擎 —— PostgreSQL不停机迁移数据</a></li>



    
  
    
    
	

    <li><a href="#pg-285a7bdf0f6caca3e5d7f97af974ac6e">使用FIO测试磁盘性能</a></li>



    
  
    
    
	

    <li><a href="#pg-c7d8616451a6fb6791bf0707b1e9f97e">使用sysbench测试PostgreSQL性能</a></li>



    
  
    
    
	

    <li><a href="#pg-791abe3b50df5a93fb86b9af6c65497b">找出没用过的索引</a></li>



    
  
    
    
	

    <li><a href="#pg-7ed8fc70d90ab400d2077b51b8877f91">批量配置SSH免密登录</a></li>



    
  
    
    
	

    <li><a href="#pg-73b1e01472e6d2d977cbd40600e2f91b">Wireshark抓包分析协议</a></li>



    
  
    
    
	

    <li><a href="#pg-952ac87bedcf6370ba38c07b37016b21">file_fdw妙用无穷——从数据库读取系统信息</a></li>



    
  
    
    
	

    <li><a href="#pg-c38d4e3664b5a6788de15893db6a0058">Linux 常用统计 CLI 工具</a></li>



    
  
    
    
	

    <li><a href="#pg-569b13a844f150eabaf244a714138e15">源码编译安装 PostGIS</a></li>



    
  
    
    
	

    <li><a href="#pg-a119d2b10267d52b4af6df40d6c9ab02">PostgreSQL MongoFDW安装部署</a></li>



    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-1a92238e99590240143d4a2a0d17f98b">PostgreSQL 逻辑复制详解</h1>
	<div class="lead">本文介绍PostgreSQL 13中逻辑复制的相关原理，以及最佳实践。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2021-03-03" class="text-muted">2021年03月03日</time>
        
	</div>
	<hr>
<h2 id="逻辑复制">逻辑复制</h2>
<p><strong>逻辑复制（Logical Replication）</strong>，是一种根据数据对象的 <a href="/zh/blog/admin/replica-identity/"><strong>复制标识</strong></a>（Replica Identity）（通常是主键）复制数据对象及其变化的方法。</p>
<p><strong>逻辑复制</strong> 这个术语与 <strong>物理复制</strong>相对应，物理复制使用精确的块地址与逐字节复制，而逻辑复制则允许对复制过程进行精细的控制。</p>
<p>逻辑复制基于 <strong>发布（Publication）</strong> 与 <strong>订阅</strong>（<strong>Subscription</strong>）模型：</p>
<ul>
<li>一个 <strong>发布者（Publisher）</strong> 上可以有多个<strong>发布</strong>，一个 <strong>订阅者（Subscriber）</strong> 上可以有多个 <strong>订阅</strong> 。</li>
<li>一个发布可被多个订阅者订阅，一个订阅只能订阅一个<strong>发布者</strong>，但可订阅同发布者上的多个不同发布。</li>
</ul>
<p>针对一张表的逻辑复制通常是这样的：订阅者获取发布者数据库上的一个快照，并拷贝表中的存量数据。一旦完成数据拷贝，发布者上的<strong>变更</strong>（增删改清）就会实时发送到订阅者上。订阅者会按照相同的顺序应用这些变更，因此可以保证逻辑复制的事务一致性。这种方式有时候又称为 <strong>事务性复制（transactional  replication）</strong>。</p>
<p>逻辑复制的典型用途是：</p>
<ul>
<li>迁移，跨PostgreSQL大版本，跨操作系统平台进行复制。</li>
<li>CDC，收集数据库（或数据库的一个子集）中的增量变更，在订阅者上为增量变更触发触发器执行定制逻辑。</li>
<li>分拆，将多个数据库集成为一个，或者将一个数据库拆分为多个，进行精细的分拆集成与访问控制。</li>
</ul>
<p>逻辑订阅者的行为就是一个普通的PostgreSQL实例（主库），逻辑订阅者也可以创建自己的发布，拥有自己的订阅者。</p>
<p>如果逻辑订阅者只读，那么不会有<strong>冲突</strong>。如果会写入逻辑订阅者的订阅集，那么就可能会出现冲突。</p>
<hr>
<h2 id="发布">发布</h2>
<p>一个 <strong>发布（Publication）</strong> 可以在物理复制<strong>主库</strong> 上定义。创建发布的节点被称为 <strong>发布者（Publisher）</strong> 。</p>
<p>一个 <strong>发布</strong> 是 <strong>由一组表构成的变更集合</strong>。也可以被视作一个 <strong>变更集（change set）</strong> 或 <strong>复制集（Replication Set）</strong> 。每个发布都只能在一个 <strong>数据库（Database）</strong> 中存在。</p>
<p>发布不同于<strong>模式（Schema）</strong>，不会影响表的访问方式。（表纳不纳入发布，自身访问不受影响）</p>
<p>发布目前只能包含<strong>表</strong>（即：索引，序列号，物化视图这些不会被发布），每个表可以添加到多个发布中。</p>
<p>除非针对<code>ALL TABLES</code>创建发布，否则发布中的对象（表）只能（通过<code>ALTER PUBLICATION ADD TABLE</code>）被<strong>显式添加</strong>。</p>
<p>发布可以筛选所需的变更类型：包括<code>INSERT</code>、<code>UPDATE</code>、<code>DELETE</code> 和<code>TRUNCATE</code>的任意组合，类似触发器事件，默认所有变更都会被发布。</p>
<h3 id="复制标识">复制标识</h3>
<blockquote>
<p><a href="/zh/blog/admin/replica-identity">复制标识</a></p>
</blockquote>
<p>一个被纳入发布中的表，必须带有 <strong>复制标识（Replica Identity）</strong>，只有这样才可以在订阅者一侧定位到需要更新的行，完成<code>UPDATE</code>与<code>DELETE</code>操作的复制。</p>
<p>默认情况下，<strong>主键</strong> （Primary Key）是表的复制标识，<strong>非空列上的唯一索引</strong> （UNIQUE NOT NULL）也可以用作复制标识。</p>
<p>如果没有任何复制标识，可以将复制标识设置为<code>FULL</code>，也就是把整个行当作复制标识。（一种有趣的情况，表中存在多条完全相同的记录，也可以被正确处理，见后续案例）使用<code>FULL</code>模式的复制标识效率很低（因为每一行修改都需要在订阅者上执行全表扫描，很容易把订阅者拖垮），所以这种配置只能是保底方案。使用<code>FULL</code>模式的复制标识还有一个限制，订阅端的表上的复制身份所包含的列，要么与发布者一致，要么比发布者更少。</p>
<p><code>INSERT</code>操作总是可以无视 复制标识 直接进行（因为插入一条新记录，在订阅者上并不需要定位任何现有记录；而删除和更新则需要通过<strong>复制标识</strong> 定位到需要操作的记录）。如果一个没有 复制标识 的表被加入到带有<code>UPDATE</code>和<code>DELETE</code>的发布中，后续的<code>UPDATE</code>和<code>DELETE</code>会导致发布者上报错。</p>
<p>表的复制标识模式可以查阅<code>pg_class.relreplident</code>获取，可以通过<code>ALTER TABLE</code>进行修改。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IDENTITY</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOTHING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>尽管各种排列组合都是可能的，然而在实际使用中，只有三种可行的情况。</p>
<ul>
<li>表上有主键，使用默认的 <code>default</code> 复制标识</li>
<li>表上没有主键，但是有非空唯一索引，显式配置 <code>index</code> 复制标识</li>
<li>表上既没有主键，也没有非空唯一索引，显式配置<code>full</code>复制标识（运行效率非常低，仅能作为兜底方案）</li>
<li>其他所有情况，都无法正常完成逻辑复制功能。输出的信息不足，可能会报错，也可能不会。</li>
<li>特别需要注意：如果<code>nothing</code>复制标识的表纳入到逻辑复制中，对其进行删改会导致发布端报错！</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">复制身份模式\表上的约束</th>
<th style="text-align:center">主键(p)</th>
<th style="text-align:center">非空唯一索引(u)</th>
<th style="text-align:center">两者皆无(n)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>d</strong>efault</td>
<td style="text-align:center"><strong>有效</strong></td>
<td style="text-align:center">x</td>
<td style="text-align:center">x</td>
</tr>
<tr>
<td style="text-align:center"><strong>i</strong>ndex</td>
<td style="text-align:center">x</td>
<td style="text-align:center"><strong>有效</strong></td>
<td style="text-align:center">x</td>
</tr>
<tr>
<td style="text-align:center"><strong>f</strong>ull</td>
<td style="text-align:center"><strong>低效</strong></td>
<td style="text-align:center"><strong>低效</strong></td>
<td style="text-align:center"><strong>低效</strong></td>
</tr>
<tr>
<td style="text-align:center"><strong>n</strong>othing</td>
<td style="text-align:center">xxxx</td>
<td style="text-align:center">xxxx</td>
<td style="text-align:center">xxxx</td>
</tr>
</tbody>
</table>
<h3 id="管理发布">管理发布</h3>
<p><code>CREATE PUBLICATION</code>用于创建发布，<code>DROP PUBLICATION</code>用于移除发布，<code>ALTER PUBLICATION</code>用于修改发布。</p>
<p>发布创建之后，可以通过<code>ALTER PUBLICATION</code>动态地向发布中添加或移除表，这些操作都是事务性的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PUBLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ONLY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TABLES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">publication_parameter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PUBLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ADD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ONLY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PUBLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ONLY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PUBLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ONLY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PUBLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">publication_parameter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PUBLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OWNER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_owner</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CURRENT_USER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SESSION_USER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PUBLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RENAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PUBLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...];</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><code>publication_parameter</code> 主要包括两个选项：</p>
<ul>
<li><code>publish</code>：定义要发布的变更操作类型，逗号分隔的字符串，默认为<code>insert, update, delete, truncate</code>。</li>
<li><code>publish_via_partition_root</code>：13后的新选项，如果为真，分区表将使用根分区的复制标识进行逻辑复制。</li>
</ul>
<h3 id="查询发布">查询发布</h3>
<p>发布可以使用psql元命令<code>\dRp</code>查询。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># \dRp</span>
</span></span><span style="display:flex;"><span>  Owner   <span style="color:#000;font-weight:bold">|</span> All tables <span style="color:#000;font-weight:bold">|</span> Inserts <span style="color:#000;font-weight:bold">|</span> Updates <span style="color:#000;font-weight:bold">|</span> Deletes <span style="color:#000;font-weight:bold">|</span> Truncates <span style="color:#000;font-weight:bold">|</span> Via root
</span></span><span style="display:flex;"><span>----------+------------+---------+---------+---------+-----------+----------
</span></span><span style="display:flex;"><span> postgres <span style="color:#000;font-weight:bold">|</span> t          <span style="color:#000;font-weight:bold">|</span> t       <span style="color:#000;font-weight:bold">|</span> t       <span style="color:#000;font-weight:bold">|</span> t       <span style="color:#000;font-weight:bold">|</span> t         <span style="color:#000;font-weight:bold">|</span> f
</span></span></code></pre></div><h3 id="pg_publication-发布定义表"><code>pg_publication</code> 发布定义表</h3>
<p>``pg_publication` 包含了发布的原始定义，每一条记录对应一个发布。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># table pg_publication;
</span></span><span style="display:flex;"><span>oid          | 20453
</span></span><span style="display:flex;"><span>pubname      | pg_meta_pub
</span></span><span style="display:flex;"><span>pubowner     | 10
</span></span><span style="display:flex;"><span>puballtables | t
</span></span><span style="display:flex;"><span>pubinsert    | t
</span></span><span style="display:flex;"><span>pubupdate    | t
</span></span><span style="display:flex;"><span>pubdelete    | t
</span></span><span style="display:flex;"><span>pubtruncate  | t
</span></span><span style="display:flex;"><span>pubviaroot   | f
</span></span></code></pre></div><ul>
<li><code>puballtables</code>：是否包含所有的表</li>
<li><code>pubinsert|update|delete|truncate</code> 是否发布这些操作</li>
<li><code>pubviaroot</code>：如果设置了该选项，任何分区表（叶表）都会使用最顶层的（被）分区表的<strong>复制身份</strong>。所以可以把整个分区表当成一个表，而不是一系列表进行发布。</li>
</ul>
<h3 id="pg_publication_tables-发布内容表"><code>pg_publication_tables</code> 发布内容表</h3>
<p><code>pg_publication_tables</code>是由<code>pg_publication</code>，<code>pg_class</code>和<code>pg_namespace</code>拼合而成的视图，记录了发布中包含的表信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>postgres@meta:5432/meta<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># table pg_publication_tables;</span>
</span></span><span style="display:flex;"><span>   pubname   <span style="color:#000;font-weight:bold">|</span> schemaname <span style="color:#000;font-weight:bold">|</span>    tablename
</span></span><span style="display:flex;"><span>-------------+------------+-----------------
</span></span><span style="display:flex;"><span> pg_meta_pub <span style="color:#000;font-weight:bold">|</span> public     <span style="color:#000;font-weight:bold">|</span> spatial_ref_sys
</span></span><span style="display:flex;"><span> pg_meta_pub <span style="color:#000;font-weight:bold">|</span> public     <span style="color:#000;font-weight:bold">|</span> t_normal
</span></span><span style="display:flex;"><span> pg_meta_pub <span style="color:#000;font-weight:bold">|</span> public     <span style="color:#000;font-weight:bold">|</span> t_unique
</span></span><span style="display:flex;"><span> pg_meta_pub <span style="color:#000;font-weight:bold">|</span> public     <span style="color:#000;font-weight:bold">|</span> t_tricky
</span></span></code></pre></div><p>使用<code>pg_get_publication_tables</code>可以根据订阅的名字获取订阅表的OID</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_get_publication_tables</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pg_meta_pub&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pubname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">schemaname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_publication</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:bold">LATERAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_get_publication_tables</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pubname</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gpt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">relid</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_namespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gpt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relid</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>同时，<code>pg_publication_rel</code> 也提供类似的信息，但采用的是多对多的OID对应视角，包含的是原始数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>  oid  | prpubid | prrelid
</span></span><span style="display:flex;"><span>-------+---------+---------
</span></span><span style="display:flex;"><span> 20414 |   20413 |   20397
</span></span><span style="display:flex;"><span> 20415 |   20413 |   20400
</span></span><span style="display:flex;"><span> 20416 |   20413 |   20391
</span></span><span style="display:flex;"><span> 20417 |   20413 |   20394
</span></span></code></pre></div><p>这两者的区别特别需要注意：当针对<code>ALL TABLES</code>发布时，<code>pg_publication_rel</code>中不会有具体表的OID，但是在<code>pg_publication_tables</code>中可以查询到实际纳入逻辑复制的表列表。所以通常应当以<code>pg_publication_tables</code>为准。</p>
<p>创建订阅时，数据库会先修改<code>pg_publication</code>目录，然后将发布表的信息填入<code>pg_publication_rel</code>。</p>
<hr>
<h2 id="订阅">订阅</h2>
<p><strong>订阅（Subscription）</strong> 是逻辑复制的下游。定义订阅的节点被称为 <strong>订阅者（Subscriber）</strong> 。</p>
<p>订阅定义了：如何<strong>连接</strong>到另一个数据库，以及需要订阅目标发布者上的哪些<strong>发布</strong>。</p>
<p>逻辑订阅者的行为与一个普通的PostgreSQL实例（主库）无异，逻辑订阅者也可以创建自己的发布，拥有自己的订阅者。</p>
<p>每个订阅者，都会通过一个 <strong>复制槽（Replication）</strong> 来接收变更，在初始数据复制阶段，可能会需要更多的临时复制槽。</p>
<p>逻辑复制订阅可以作为同步复制的备库，备库的名字默认就是订阅的名字，也可以通过在连接信息中设置<code>application_name</code>来使用别的名字。</p>
<p>只有超级用户才可以用<code>pg_dump</code>转储订阅的定义，因为只有超级用户才可以访问<code>pg_subscription</code>视图，普通用户尝试转储时会跳过并打印警告信息。</p>
<p>逻辑复制不会复制DDL变更，因此发布集中的表必须<strong>已经存在</strong>于订阅端上。只有<strong>普通表</strong>上的变更会被复制，视图、物化视图、序列号，索引这些都不会被复制。</p>
<p>发布与订阅端的表是通过完整限定名（如<code>public.table</code>）进行匹配的，不支持把变更复制到一个名称不同的表上。</p>
<p>发布与订阅端的表的列也是通过<strong>名称</strong>匹配的。列的顺序无关紧要，数据类型也不一定非得一致，只要两个列的<strong>文本表示</strong>兼容即可，即数据的文本表示可以转换为目标列的类型。订阅端的表可以包含有发布端没有的列，这些新列都会使用默认值填充。</p>
<h3 id="管理订阅">管理订阅</h3>
<p><code>CREATE SUBSCRIPTION</code>用于创建订阅，<code>DROP SUBSCRIPTION</code>用于移除订阅，<code>ALTER SUBSCRIPTION</code>用于修改订阅。</p>
<p>订阅创建之后，可以通过<code>ALTER SUBSCRIPTION</code> 随时<strong>暂停</strong>与<strong>恢复</strong>订阅。</p>
<p>移除并重建订阅会导致<strong>同步信息丢失</strong>，这意味着相关数据需要重新进行同步。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SUBSCRIPTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">subscription_name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">CONNECTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;conninfo&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">PUBLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">publication_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">subscription_parameter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SUBSCRIPTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CONNECTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;conninfo&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SUBSCRIPTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PUBLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">publication_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">set_publication_option</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SUBSCRIPTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REFRESH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PUBLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">refresh_option</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SUBSCRIPTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENABLE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SUBSCRIPTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DISABLE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SUBSCRIPTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">subscription_parameter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SUBSCRIPTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OWNER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_owner</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CURRENT_USER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SESSION_USER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SUBSCRIPTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RENAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SUBSCRIPTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><code>subscription_parameter</code>定义了订阅的一些选项，包括：</p>
<ul>
<li><code>copy_data(bool)</code>：复制开始后，是否拷贝数据，默认为真</li>
<li><code>create_slot(bool)</code>：是否在发布者上创建复制槽，默认为真</li>
<li><code>enabled(bool)</code>：是否启用该订阅，默认为真</li>
<li><code>connect(bool)</code>：是否尝试连接到发布者，默认为真，置为假会把上面几个选项强制设置为假。</li>
<li><code>synchronous_commit(bool)</code>：是否启用同步提交，向主库上报自己的进度信息。</li>
<li><code>slot_name</code>：订阅所关联的复制槽名称，设置为空会取消订阅与复制槽的关联。</li>
</ul>
<h3 id="管理复制槽">管理复制槽</h3>
<p>每个活跃的订阅都会通过<strong>复制槽</strong> 从远程发布者接受变更。</p>
<p>通常这个远端的<strong>复制槽</strong>是自动管理的，在<code>CREATE SUBSCRIPTION</code>时自动创建，在<code>DROP SUBSCRIPTION</code>时自动删除。</p>
<p>在特定场景下，可能需要分别操作订阅与底层的复制槽：</p>
<ul>
<li>
<p>创建订阅时，所需的复制槽已经存在。则可以通过<code>create_slot = false</code>关联已有复制槽。</p>
</li>
<li>
<p>创建订阅时，远端不可达或状态不明朗，则可以通过<code>connect = false</code>不访问远程主机，<code>pg_dump</code>就是这么做的。这种情况下，您必须在远端手工创建复制槽后，才能在本地启用该订阅。</p>
</li>
<li>
<p>移除订阅时，需要保留复制槽。这种情况通常是订阅者要搬到另一台机器上去，希望在那里重新开始订阅。这种情况下需要先通过<code>ALTER SUBSCRIPTION</code>解除订阅与复制槽点关联</p>
</li>
<li>
<p>移除订阅时，远端不可达。这种情况下，需要在删除订阅之前使用<code>ALTER SUBSCRIPTION</code>解除复制槽与订阅的关联。</p>
<p>如果远端实例不再使用那么没事，然而如果远端实例只是暂时不可达，那就应该手动删除其上的复制槽；否则它将继续保留WAL，并可能导致磁盘撑爆。</p>
</li>
</ul>
<h3 id="订阅查询">订阅查询</h3>
<p>订阅可以使用psql元命令<code>\dRs</code>查询。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># \dRs</span>
</span></span><span style="display:flex;"><span>     Name     <span style="color:#000;font-weight:bold">|</span>  Owner   <span style="color:#000;font-weight:bold">|</span> Enabled <span style="color:#000;font-weight:bold">|</span>  Publication
</span></span><span style="display:flex;"><span>--------------+----------+---------+----------------
</span></span><span style="display:flex;"><span> pg_bench_sub <span style="color:#000;font-weight:bold">|</span> postgres <span style="color:#000;font-weight:bold">|</span> t       <span style="color:#000;font-weight:bold">|</span> <span style="color:#ce5c00;font-weight:bold">{</span>pg_bench_pub<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="pg_subscription-订阅定义表"><code>pg_subscription</code> 订阅定义表</h3>
<p>每一个逻辑订阅都会有一条记录，注意这个视图是跨数据库集簇范畴的，每个数据库中都可以看到整个集簇中的订阅信息。</p>
<p>只有超级用户才可以访问此视图，因为里面包含有明文密码（连接信息）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20421</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">subdbid</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">19356</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">subname</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_test_sub</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">subowner</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">subenabled</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">subconninfo</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">replicator</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">DBUser</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Replicator</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbname</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">subslotname</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_test_sub</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">subsynccommit</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">off</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">subpublications</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#000">pg_meta_pub</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li><code>subenabled</code>：订阅是否启用</li>
<li><code>subconninfo</code> ：因为包含敏感信息，会针对普通用户进行隐藏。</li>
<li><code>subslotname</code>：订阅使用的复制槽名称，也会被用作逻辑复制的<strong>源名称（Origin Name）</strong>，用于除重。</li>
<li><code>subpublications</code>：订阅的发布名称列表。</li>
<li>其他状态信息：是否启用同步提交等等。</li>
</ul>
<h3 id="pg_subscription_rel-订阅内容表"><code>pg_subscription_rel</code> 订阅内容表</h3>
<p><code>pg_subscription_rel</code> 记录了每张处于订阅中的表的相关信息，包括状态与进度。</p>
<ul>
<li><code>srrelid</code> 订阅中关系的OID</li>
<li><code>srsubstate</code>，订阅中关系的状态：<code>i</code> 初始化中，<code>d</code> 拷贝数据中，<code>s</code> 同步已完成，<code>r</code> 正常复制中。</li>
<li><code>srsublsn</code>，当处于<code>i|d</code>状态时为空，当处于<code>s|r</code>状态时，远端的LSN位置。</li>
</ul>
<h3 id="创建订阅时">创建订阅时</h3>
<p>当一个新的订阅创建时，会依次执行以下操作：</p>
<ul>
<li>将发布的信息存入 <code>pg_subscription</code> 目录中，包括连接信息，复制槽，发布名称，一些配置选项等。</li>
<li>连接至发布者，检查复制权限，（注意这里<strong>不会检查对应发布是否存在</strong>），</li>
<li>创建逻辑复制槽：<code>pg_create_logical_replication_slot(name, 'pgoutput')</code></li>
<li>将复制集中的表注册到订阅端的 <code>pg_subscription_rel</code> 目录中。</li>
<li>执行初始快照同步，注意订阅测表中的原有数据不会被删除。</li>
</ul>
<hr>
<h2 id="复制冲突">复制冲突</h2>
<p>逻辑复制的行为类似于正常的DML操作，即使数据在用户节点上的本地发生了变化，数据也会被更新。如果复制来的数据违反了任何约束，复制就会停止，这种现象被称为 <strong>冲突（Conflict）</strong> 。</p>
<p>当复制<code>UPDATE</code>或<code>DELETE</code>操作时，缺失数据（即要更新/删除的数据已经不存在）不会产生冲突，此类操作直接跳过。</p>
<p>冲突会导致错误，并中止逻辑复制，逻辑复制管理进程会以5秒为间隔不断重试。冲突不会阻塞订阅端对复制集中表上的SQL。关于冲突的细节可以在用户的服务器日志中找到，<strong>冲突必须由用户手动解决</strong>。</p>
<h3 id="日志中可能出现的冲突">日志中可能出现的冲突</h3>
<table>
<thead>
<tr>
<th style="text-align:center">冲突模式</th>
<th style="text-align:center">复制进程</th>
<th style="text-align:center">输出日志</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">缺少UPDATE/DELETE对象</td>
<td style="text-align:center">继续</td>
<td style="text-align:center">不输出</td>
</tr>
<tr>
<td style="text-align:center">表/行锁等待</td>
<td style="text-align:center">等待</td>
<td style="text-align:center">不输出</td>
</tr>
<tr>
<td style="text-align:center">违背主键/唯一/Check约束</td>
<td style="text-align:center"><strong>中止</strong></td>
<td style="text-align:center">输出</td>
</tr>
<tr>
<td style="text-align:center">目标表不存在/目标列不存在</td>
<td style="text-align:center"><strong>中止</strong></td>
<td style="text-align:center">输出</td>
</tr>
<tr>
<td style="text-align:center">无法将数据转换为目标列类型</td>
<td style="text-align:center"><strong>中止</strong></td>
<td style="text-align:center">输出</td>
</tr>
</tbody>
</table>
<p>解决冲突的方法，可以是改变订阅侧的数据，使其不与进入的变更相冲突，或者跳过与现有数据冲突的事务。</p>
<p>使用订阅对应的<code>node_name</code>与LSN位置调用函数<code>pg_replication_origin_advance()</code>可以跳过事务，<code>pg_replication_origin_status</code>系统视图中可以看到当前ORIGIN的位置。</p>
<hr>
<h2 id="局限性">局限性</h2>
<p>逻辑复制目前有以下限制，或者说功能缺失。这些问题可能会在未来的版本中解决。</p>
<p><strong>数据库模式和DDL命令不会被复制</strong>。存量模式可以通过<code>pg_dump --schema-only</code>手动复制，增量模式变更需要手动保持同步（发布订阅两边的模式不需要绝对相同不需要两边的模式绝对相同)。逻辑复制对于对在线DDL变更仍然可靠：在发布数据库中执行DDL变更后，复制的数据到达订阅者但因为表模式不匹配而导致复制出错停止，订阅者的模式更新后复制会继续。在许多情况下，先在订阅者上执行变更可以避免中间的错误。</p>
<p><strong>序列号数据不会被复制</strong>。<strong>序列号</strong>所服务的标识列与<code>SERIAL</code>类型里面的数据作为表的一部分当然会被复制，但序列号本身仍会在订阅者上保持为初始值。如果订阅者被当成只读库使用，那么通常没事。然而如果打算进行某种形式的切换或Failover到订阅者数据库，那么需要将序列号更新为最新的值，要么通过从发布者复制当前数据（也许可以使用<code>pg_dump -t *seq*</code>），要么从表本身的数据内容确定一个足够高的值（例如<code>max(id)+1000000</code>）。否则如果在新库执行获取序列号作为身份的操作时，很可能会产生冲突。</p>
<p><strong>逻辑复制支持复制<code>TRUNCATE</code>命令</strong>，但是在<code>TRUNCATE</code>由外键关联的一组表时需要特别小心。当执行<code>TRUNCATE</code>操作时，发布者上与之关联的一组表（通过显式列举或级连关联）都会被<code>TRUNCATE</code>，但是在订阅者上，不在订阅集中的表不会被<code>TRUNCATE</code>。这样的操作在逻辑上是合理的，因为逻辑复制不应该影响到复制集之外的表。但如果有一些不在订阅集中的表通过外键引用订阅集中被<code>TRUNCATE</code>的表，那么<code>TRUNCATE</code>操作就会失败。</p>
<p><strong>大对象不会被复制</strong></p>
<p><strong>只有表能被复制（包括分区表）</strong>，尝试复制其他类型的表会导致错误（视图，物化视图，外部表，Unlogged表）。具体来说，只有在<code>pg_class.relkind = 'r'</code>的表才可以参与逻辑复制。</p>
<p><strong>复制分区表时默认按子表进行复制</strong>。默认情况下，变更是按照分区表的叶子分区触发的，这意味着发布上的每一个分区子表都需要在订阅上存在（当然，订阅者上的这个分区子表不一定是一个分区子表，也可能本身就是一个分区母表，或者一个普通表）。发布可以声明要不要使用分区根表上的复制标识取代分区叶表上的复制标识，这是PG13提供的新功能，可以在创建发布时通过<code>publish_via_partition_root</code> 选项指定。</p>
<p><strong>触发器的行为表现有所不同</strong>。<strong>行级触发器</strong>会触发，但<code>UPDATE OF cols</code>类型的触发器不触发。而语句级触发器只会在初始数据拷贝时触发。</p>
<p><strong>日志行为不同</strong>。即使设置<code>log_statement = 'all'</code>，日志中也不会记录由复制产生的SQL语句。</p>
<p><strong>双向复制需要极其小心</strong>：互为发布与订阅是可行的，只要两遍的表集合不相交即可。但一旦出现表的交集，就会出现WAL无限循环。</p>
<p><strong>同一实例内的复制</strong>：同一个实例内的逻辑复制需要特别小心，必须<strong>手工创建逻辑复制槽</strong>，并在创建订阅时使用已有的逻辑复制槽，否则会卡死。</p>
<p><strong>只能在主库上进行</strong>：目前不支持从物理复制的从库上进行逻辑解码，也无法在从库上创建复制槽，所以从库无法作为发布者。但这个问题可能会在未来解决。</p>
<hr>
<h2 id="架构">架构</h2>
<p>逻辑复制始于获取发布者数据库上的快照，基于此快照拷贝表上的存量数据。一旦拷贝完成，发布者上的<strong>变更</strong>（增删改等）就会实时发送到订阅者上。</p>
<p>逻辑复制采用与物理复制类似的架构，是通过一个<code>walsender</code>和<code>apply</code>进程实现的。发布端端<code>walsender</code>进程会加载逻辑解码插件（<code>pgoutput</code>），并开始逻辑解码WAL日志。<strong>逻辑解码插件（Logical Decoding Plugin）</strong> 会读取WAL中的变更，按照<strong>发布</strong>的定义筛选变更，将变更转变为特定的形式，以逻辑复制协议传输出去。数据会按照流复制协议传输至订阅者一侧的<code>apply</code>进程，该进程会在接收到变更时，将变更映射至本地表上，然后按照事务顺序重新应用这些变更。</p>
<h3 id="初始快照">初始快照</h3>
<p>订阅侧的表在初始化与拷贝数据期间，会由一种特殊的<code>apply</code>进程负责。这个进程会创建它自己的<strong>临时复制槽</strong>，并拷贝表中的存量数据。</p>
<p>一旦数据拷贝完成，这张表会进入到同步模式（<code>pg_subscription_rel.srsubstate = 's'</code>），同步模式确保了 <strong>主apply进程</strong> 可以使用标准的逻辑复制方式应用拷贝数据期间发生的变更。一旦完成同步，表复制的控制权会转交回 <strong>主apply进程</strong>，恢复正常的复制模式。</p>
<h3 id="进程结构">进程结构</h3>
<p>逻辑复制的发布端会针对来自订阅端端每一条连接，创建一个对应的 <code>walsender</code> 进程，发送解码的WAL日志。在订阅测，则会</p>
<h3 id="复制槽">复制槽</h3>
<p>当创建订阅时，</p>
<p>一条逻辑复制</p>
<h3 id="逻辑解码">逻辑解码</h3>
<h3 id="同步提交">同步提交</h3>
<p>逻辑复制的同步提交是通过Backend与Walsender之间的SIGUSR1通信完成的。</p>
<h3 id="临时数据">临时数据</h3>
<p>逻辑解码的临时数据会落盘为本地日志快照。当walsender接收到walwriter发送的<code>SIGUSR1</code>信号时，就会读取WAL日志并生成相应的逻辑解码快照。当传输结束时会删除这些快照。</p>
<p>文件地址为：<code>$PGDATA/pg_logical/snapshots/{LSN Upper}-{LSN Lower}.snap</code></p>
<hr>
<h2 id="监控">监控</h2>
<p>逻辑复制采用与物理流复制类似的架构，所以监控一个逻辑复制的<strong>发布者节点</strong>与监控一个物理复制主库差别不大。</p>
<p>订阅者的监控信息可以通过<code>pg_stat_subscription</code>视图获取。</p>
<h3 id="pg_stat_subscription-订阅统计表"><code>pg_stat_subscription</code> 订阅统计表</h3>
<p>每个<strong>活跃订阅</strong>都会在这个视图中有<strong>至少一条</strong> 记录，即Main Worker（负责应用逻辑日志）。</p>
<p>Main Worker的<code>relid = NULL</code>，如果有负责初始数据拷贝的进程，也会在这里有一行记录，<code>relid</code>为负责拷贝数据的表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>subid                 <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">20421</span>
</span></span><span style="display:flex;"><span>subname               <span style="color:#000;font-weight:bold">|</span> pg_test_sub
</span></span><span style="display:flex;"><span>pid                   <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">5261</span>
</span></span><span style="display:flex;"><span>relid                 <span style="color:#000;font-weight:bold">|</span> NULL
</span></span><span style="display:flex;"><span>received_lsn          <span style="color:#000;font-weight:bold">|</span> 0/2A4F6B8
</span></span><span style="display:flex;"><span>last_msg_send_time    <span style="color:#000;font-weight:bold">|</span> 2021-02-22 17:05:06.578574+08
</span></span><span style="display:flex;"><span>last_msg_receipt_time <span style="color:#000;font-weight:bold">|</span> 2021-02-22 17:05:06.583326+08
</span></span><span style="display:flex;"><span>latest_end_lsn        <span style="color:#000;font-weight:bold">|</span> 0/2A4F6B8
</span></span><span style="display:flex;"><span>latest_end_time       <span style="color:#000;font-weight:bold">|</span> 2021-02-22 17:05:06.578574+08
</span></span></code></pre></div><ul>
<li><code>received_lsn</code> ：最近<strong>收到</strong>的日志位置。</li>
<li><code>lastest_end_lsn</code>：最后向walsender回报的LSN位置，即主库上的<code>confirmed_flush_lsn</code>。不过这个值更新不太勤快，</li>
</ul>
<p>通常情况下一个活跃的订阅会有一个apply进程在运行，被禁用的订阅或崩溃的订阅则在此视图中没有记录。在初始同步期间，被同步的表会有额外的工作进程记录。</p>
<h3 id="pg_replication_slot-复制槽"><code>pg_replication_slot</code> 复制槽</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>postgres@meta:5432/meta<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># table pg_replication_slots ;</span>
</span></span><span style="display:flex;"><span>-<span style="color:#ce5c00;font-weight:bold">[</span> RECORD <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">]</span>-------+------------
</span></span><span style="display:flex;"><span>slot_name           <span style="color:#000;font-weight:bold">|</span> pg_test_sub
</span></span><span style="display:flex;"><span>plugin              <span style="color:#000;font-weight:bold">|</span> pgoutput
</span></span><span style="display:flex;"><span>slot_type           <span style="color:#000;font-weight:bold">|</span> logical
</span></span><span style="display:flex;"><span>datoid              <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">19355</span>
</span></span><span style="display:flex;"><span>database            <span style="color:#000;font-weight:bold">|</span> meta
</span></span><span style="display:flex;"><span>temporary           <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>active              <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span>active_pid          <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">89367</span>
</span></span><span style="display:flex;"><span>xmin                <span style="color:#000;font-weight:bold">|</span> NULL
</span></span><span style="display:flex;"><span>catalog_xmin        <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">1524</span>
</span></span><span style="display:flex;"><span>restart_lsn         <span style="color:#000;font-weight:bold">|</span> 0/2A08D40
</span></span><span style="display:flex;"><span>confirmed_flush_lsn <span style="color:#000;font-weight:bold">|</span> 0/2A097F8
</span></span><span style="display:flex;"><span>wal_status          <span style="color:#000;font-weight:bold">|</span> reserved
</span></span><span style="display:flex;"><span>safe_wal_size       <span style="color:#000;font-weight:bold">|</span> NULL
</span></span></code></pre></div><p>复制槽视图中同时包含了逻辑复制槽与物理复制槽。逻辑复制槽点主要特点是：</p>
<ul>
<li><code>plugin</code>字段不为空，标识了使用的逻辑解码插件，逻辑复制默认使用<code>pgoutput</code>插件。</li>
<li><code>slot_type = logical</code>，物理复制的槽类型为<code>physical</code>。</li>
<li><code>datoid</code>与<code>database</code>字段不为空，因为物理复制与集簇关联，而逻辑复制与数据库关联。</li>
</ul>
<p>逻辑订阅者也会作为一个标准的 <strong>复制从库</strong> ，出现于 <code>pg_stat_replication</code> 视图中。</p>
<h3 id="pg_replication_origin-复制源"><code>pg_replication_origin</code> 复制源</h3>
<p>复制源</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_replication_origin_status</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RECORD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic">-----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">local_id</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">external_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_19378</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">remote_lsn</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">local_lsn</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000">BB53640</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li><code>local_id</code>：复制源在本地的ID，2字节高效表示。</li>
<li><code>external_id</code>：复制源的ID，可以跨节点引用。</li>
<li><code>remote_lsn</code>：源端最近的<strong>提交位点</strong>。</li>
<li><code>local_lsn</code>：本地已经持久化提交记录的LSN</li>
</ul>
<h3 id="检测复制冲突">检测复制冲突</h3>
<p>最稳妥的检测方法总是从发布与订阅两侧的日志中检测。当出现复制冲突时，发布测上可以看见复制连接中断</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">terminating walsender process due to replication timeout</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">starting logical decoding for slot &#34;pg_test_sub&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DETAIL</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">streaming transactions committing after 0/xxxxx, reading WAL from 0/xxxx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>而订阅端则可以看到复制冲突的具体原因，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#000">logical</span> <span style="color:#000">replication</span> <span style="color:#000">worker</span> <span style="color:#000">PID</span> <span style="color:#0000cf;font-weight:bold">4585</span> <span style="color:#000">exited</span> <span style="color:#000">with</span> <span style="color:#000">exit</span> <span style="color:#000">code</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ERROR</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">duplicate</span> <span style="color:#000">key</span> <span style="color:#000">value</span> <span style="color:#000">violates</span> <span style="color:#000">unique</span> <span style="color:#000">constraint</span> <span style="color:#4e9a06">&#34;pgbench_tellers_pkey&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;Key (tid)=(9) already exists.&#34;</span><span style="color:#000;font-weight:bold">,,,,</span><span style="color:#4e9a06">&#34;COPY pgbench_tellers, line 31&#34;</span><span style="color:#000;font-weight:bold">,,,,</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;logical replication worker&#34;</span>
</span></span></code></pre></div><p>此外，一些监控指标也可以反映逻辑复制的状态：</p>
<p>例如：<code>pg_replication_slots.confirmed_flush_lsn</code> 长期落后于<code>pg_cureent_wal_lsn</code>。或者<code>pg_stat_replication.flush_ag/write_lag</code> 有显著增长。</p>
<hr>
<h2 id="安全">安全</h2>
<p>参与订阅的表，其Ownership与Trigger权限必须控制在超级用户所信任的角色手中（否则修改这些表可能导致逻辑复制中断）。</p>
<p>在发布节点上，如果不受信任的用户具有建表权限，那么创建发布时应当显式指定表名而非通配<code>ALL TABLES</code>。也就是说，只有当超级用户信任所有 可以在发布或订阅侧具有建表（非临时表）权限的用户时，才可以使用<code>FOR ALL TABLES</code>。</p>
<p>用于复制连接的用户必须具有<code>REPLICATION</code>权限（或者为SUPERUSER）。如果该角色缺少<code>SUPERUSER</code>与<code>BYPASSRLS</code>，发布者上的行安全策略可能会被执行。如果表的属主在复制启动之后设置了行级安全策略，这个配置可能会导致复制直接中断，而不是策略生效。该用户必须拥有LOGIN权限，而且HBA规则允许其访问。</p>
<p>为了能够复制初始表数据，用于复制连接的角色必须在已发布的表上拥有<code>SELECT</code>权限（或者属于超级用户）。</p>
<p>创建发布，需要在数据库中的<code>CREATE</code>权限，创建一个<code>FOR ALL TABLES</code>的发布，需要超级用户权限。</p>
<p>将表加入到发布中，用户需要具有表的<strong>属主</strong>权限。</p>
<p>创建订阅需要超级用户权限，因为订阅的apply进程在本地数据库中以超级用户的权限运行。</p>
<p><strong>权限只会在建立复制连接时检查</strong>，不会在发布端读取每条变更记录时重复检查，也不会在订阅端应用每条记录时检查。</p>
<h2 id="配置选项">配置选项</h2>
<p>逻辑复制需要一些配置选项才能正常工作。</p>
<p>在发布者一侧，<code>wal_level</code> 必须设置为<code>logical</code>，<code>max_replication_slots</code>最少需要设为 订阅的数量+用于表数据同步的数量。<code>max_wal_senders</code>最少需要设置为<code>max_replication_slots</code> + 为物理复制保留的数量，</p>
<p>在订阅者一侧，也需要设置<code>max_replication_slots</code>，<code>max_replication_slots</code>，最少需要设为订阅数。</p>
<p><code>max_logical_replication_workers</code>最少需要配置为订阅的数量，再加上一些用于数据同步的工作进程数。</p>
<p>此外，<code>max_worker_processes</code>需要相应调整，至少应当为<code>max_logical_replication_worker</code> + 1。注意一些扩展插件和并行查询也会从工作进程的池子中获取连接使用。</p>
<h3 id="配置参数样例">配置参数样例</h3>
<p>64核机器，1～2个发布与订阅，最多6个同步工作进程，最多8个物理从库的场景，一种样例配置如下所示：</p>
<p>首先决定Slot数量，2个订阅，6个同步工作进程，8个物理从库，所以配置为16。Sender = Slot + Physical Replica = 24。</p>
<p>同步工作进程限制为6，2个订阅，所以逻辑复制的总工作进程设置为8。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">wal_level: logical                      # logical	</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">max_worker_processes: 64                # default 8 -&gt; 64, set to CPU CORE 64</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">max_parallel_workers: 32                # default 8 -&gt; 32, limit by max_worker_processes</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">max_parallel_maintenance_workers: 16    # default 2 -&gt; 16, limit by parallel worker</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">max_parallel_workers_per_gather: 0      # default 2 -&gt; 0,  disable parallel query on OLTP instance</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># max_parallel_workers_per_gather: 16   # default 2 -&gt; 16, enable parallel query on OLAP instance</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">max_wal_senders: 24                     # 10 -&gt; 24</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">max_replication_slots: 16               # 10 -&gt; 16 </span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">max_logical_replication_workers: 8      # 4 -&gt; 8, 6 sync worker + 1~2 apply worker</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">max_sync_workers_per_subscription: 6    # 2 -&gt; 6, 6 sync worker</span>
</span></span></code></pre></div><hr>
<h2 id="快速配置">快速配置</h2>
<p>首先设置发布侧的配置选项 <code>wal_level = logical</code>，该参数需要重启方可生效，其他参数的默认值都不影响使用。</p>
<p>然后创建复制用户，添加<code>pg_hba.conf</code>配置项，允许外部访问，一种典型配置是：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replicator</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">BYPASSRLS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;DBUser.Replicator&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>注意，逻辑复制的用户需要具有<code>SELECT</code>权限，在Pigsty中<code>replicator</code>已经被授予了<code>dbrole_readonly</code>角色。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">host     all          replicator     0.0.0.0/0     md5</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     replicator   replicator     0.0.0.0/0     md5</span>
</span></span></code></pre></div><p>然后在发布侧的数据库中执行：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PUBLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mypub</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">tablename</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>然后在订阅测数据库中执行：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SUBSCRIPTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mysub</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CONNECTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbname=&lt;pub_db&gt; host=&lt;pub_host&gt; user=replicator&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PUBLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mypub</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>以上配置即会开始复制，首先复制表的初始数据，然后开始同步增量变更。</p>
<h3 id="沙箱样例">沙箱样例</h3>
<p>以Pigsty标准4节点两集群沙箱为例，有两套数据库集群<code>pg-meta</code>与<code>pg-test</code>。现在将<code>pg-meta-1</code>作为发布者，<code>pg-test-1</code>作为订阅者。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">PGSRC</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;postgres://dbuser_admin@meta-1/meta&#39;</span>           <span style="color:#8f5902;font-style:italic"># 发布者</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PGDST</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;postgres://dbuser_admin@node-1/test&#39;</span>           <span style="color:#8f5902;font-style:italic"># 订阅者</span>
</span></span><span style="display:flex;"><span>pgbench -is100 <span style="color:#4e9a06">${</span><span style="color:#000">PGSRC</span><span style="color:#4e9a06">}</span>                               <span style="color:#8f5902;font-style:italic"># 在发布端初始化Pgbench</span>
</span></span><span style="display:flex;"><span>pg_dump -Oscx -t pgbench* -s <span style="color:#4e9a06">${</span><span style="color:#000">PGSRC</span><span style="color:#4e9a06">}</span> <span style="color:#000;font-weight:bold">|</span> psql <span style="color:#4e9a06">${</span><span style="color:#000">PGDST</span><span style="color:#4e9a06">}</span> <span style="color:#8f5902;font-style:italic"># 在订阅端同步表结构</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在发布者上创建**发布**，将默认的`pgbench`相关表加入到发布集中。</span>
</span></span><span style="display:flex;"><span>psql <span style="color:#4e9a06">${</span><span style="color:#000">PGSRC</span><span style="color:#4e9a06">}</span> -AXwt <span style="color:#4e9a06">&lt;&lt;-&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">CREATE PUBLICATION &#34;pg_meta_pub&#34; FOR TABLE
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  pgbench_accounts,pgbench_branches,pgbench_history,pgbench_tellers;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在订阅者上创建**订阅**，订阅发布者上的发布。</span>
</span></span><span style="display:flex;"><span>psql <span style="color:#4e9a06">${</span><span style="color:#000">PGDST</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">&lt;&lt;-&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">CREATE SUBSCRIPTION pg_test_sub
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  CONNECTION &#39;host=10.10.10.10 dbname=meta user=replicator&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  PUBLICATION pg_meta_pub;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><hr>
<h2 id="复制流程">复制流程</h2>
<p>逻辑复制的订阅创建后，如果一切正常，逻辑复制会自动开始，针对<strong>每张订阅中的表</strong>执行复制状态机逻辑。</p>
<p>如下图所示。</p>
<div class="mermaid">
stateDiagram-v2
    [*] --> init : 表被加入到订阅集中
    init --> data : 开始同步表的初始快照
    data --> sync : 存量数据同步完成
    sync --> ready : 同步期间的增量变更应用完毕，进入就绪状态
</div>
<p>当所有的表都完成复制，进入<code>r</code>（ready）状态时，逻辑复制的存量同步阶段便完成了，发布端与订阅端整体进入同步状态。</p>
<p>因此从逻辑上讲，存在两种状态机：<strong>表级复制小状态机</strong>与<strong>全局复制大状态机</strong>。每一个Sync Worker负责一张表上的小状态机，而一个Apply Worker负责一条逻辑复制的大状态机。</p>
<hr>
<h2 id="逻辑复制状态机">逻辑复制状态机</h2>
<p>逻辑复制有两种Worker：Sync与Apply。Sync</p>
<p>因此，逻辑复制在逻辑上分为两个部分：<strong>每张表独自进行复制</strong>，当复制进度追赶至最新位置时，由</p>
<p>当创建或刷新订阅时，表会被加入到 订阅集 中，每一张订阅集中的表都会在<code>pg_subscription_rel</code>视图中有一条对应纪录，展示这张表当前的复制状态。刚加入订阅集的表初始状态为<code>i</code>，即<code>initialize</code>，<strong>初始状态</strong>。</p>
<p>如果订阅的<code>copy_data</code>选项为真（默认情况），且工作进程池中有空闲的Worker，PostgreSQL会为这张表分配一个同步工作进程，同步这张表上的存量数据，此时表的状态进入<code>d</code>，即<strong>拷贝数据中</strong>。对表做数据同步类似于对数据库集群进行<code>basebackup</code>，Sync Worker会在发布端创建临时的复制槽，获取表上的快照并通过COPY完成基础数据同步。</p>
<p>当表上的基础数据拷贝完成后，表会进入<code>sync</code>模式，即<strong>数据同步</strong>，同步进程会追赶同步过程中发生的增量变更。当追赶完成时，同步进程会将这张表标记为<code>r</code>（ready）状态，转交逻辑复制主Apply进程管理变更，表示这张表已经处于正常复制中。</p>
<h3 id="24-等待逻辑复制同步">2.4 等待逻辑复制同步</h3>
<p>创建订阅后，首先必须监控 发布端与订阅端两侧的数据库日志，<strong>确保没有错误产生</strong>。</p>
<h4 id="241-逻辑复制状态机">2.4.1 逻辑复制状态机</h4>
<h4 id="242-同步进度跟踪">2.4.2 同步进度跟踪</h4>
<p>数据同步（<code>d</code>）阶段可能需要花费一些时间，取决于网卡，网络，磁盘，表的大小与分布，逻辑复制的同步worker数量等因素。</p>
<p>作为参考，1TB的数据库，20张表，包含有250GB的大表，双万兆网卡，在6个数据同步worker的负责下大约需要6~8小时完成复制。</p>
<p>在数据同步过程中，每个表同步任务都会源端库上创建临时的复制槽。请确保逻辑复制初始同步期间不要给源端主库施加过大的不必要写入压力，以免WAL撑爆磁盘。</p>
<p>发布侧的 <code>pg_stat_replication</code>，<code>pg_replication_slots</code>，订阅端的<code>pg_stat_subscription</code>，<code>pg_subscription_rel</code>提供了逻辑复制状态的相关信息，需要关注。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">psql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">${</span><span style="color:#000">PGDST</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">Xxw</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;-</span><span style="color:#4e9a06">&#39;EOF&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">subname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">json_object_agg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">srsubstate</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cnt</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">pg_subscription</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">srsubid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">srsubstate</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cnt</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_subscription_rel</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">srsubid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">srsubstate</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sr</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">srsubid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">subname</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">EOF</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>可以使用以下SQL确认订阅中表的状态，如果所有表的状态都显示为<code>r</code>，则表示逻辑复制已经成功建立，订阅端可以用于切换。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>   subname   <span style="color:#000;font-weight:bold">|</span> json_object_agg
</span></span><span style="display:flex;"><span>-------------+-----------------
</span></span><span style="display:flex;"><span> pg_test_sub <span style="color:#000;font-weight:bold">|</span> <span style="color:#ce5c00;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;r&#34;</span> : <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>当然，最好的方式始终是通过监控系统来跟踪复制状态。</p>
<hr>
<h2 id="沙箱样例-1">沙箱样例</h2>
<p>以Pigsty标准4节点两集群沙箱为例，有两套数据库集群<code>pg-meta</code>与<code>pg-test</code>。现在将<code>pg-meta-1</code>作为发布者，<code>pg-test-1</code>作为订阅者。</p>
<p>通常逻辑复制的前提是，发布者上设置有<code>wal_level = logical</code>，并且有一个可以正常访问，具有正确权限的复制用户。</p>
<p>Pigsty的默认配置已经符合要求，且带有满足条件的复制用户<code>replicator</code>，以下命令均从元节点以<code>postgres</code>用户发起，数据库用户<code>dbuser_admin</code>，带有<code>SUPERUSER</code>权限。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">PGSRC</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;postgres://dbuser_admin@meta-1/meta&#39;</span>        <span style="color:#8f5902;font-style:italic"># 发布者</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PGDST</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;postgres://dbuser_admin@node-1/test&#39;</span>        <span style="color:#8f5902;font-style:italic"># 订阅者</span>
</span></span></code></pre></div><h3 id="准备逻辑复制">准备逻辑复制</h3>
<p>使用<code>pgbench</code>工具，在<code>pg-meta</code>集群的<code>meta</code>数据库中初始化表结构。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pgbench -is100 <span style="color:#4e9a06">${</span><span style="color:#000">PGSRC</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div><p>使用<code>pg_dump</code>与<code>psql</code>  <strong>同步</strong> <code>pgbench*</code> 相关表的定义。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg_dump -Oscx -t pgbench* -s <span style="color:#4e9a06">${</span><span style="color:#000">PGSRC</span><span style="color:#4e9a06">}</span> <span style="color:#000;font-weight:bold">|</span> psql <span style="color:#4e9a06">${</span><span style="color:#000">PGDST</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div><h3 id="创建发布订阅">创建发布订阅</h3>
<p>在发布者上创建<strong>发布</strong>，将默认的<code>pgbench</code>相关表加入到发布集中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql <span style="color:#4e9a06">${</span><span style="color:#000">PGSRC</span><span style="color:#4e9a06">}</span> -AXwt <span style="color:#4e9a06">&lt;&lt;-&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">CREATE PUBLICATION &#34;pg_meta_pub&#34; FOR TABLE
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  pgbench_accounts,pgbench_branches,pgbench_history,pgbench_tellers;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><p>在订阅者上创建<strong>订阅</strong>，订阅发布者上的发布。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql <span style="color:#4e9a06">${</span><span style="color:#000">PGDST</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">&lt;&lt;-&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">CREATE SUBSCRIPTION pg_test_sub
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  CONNECTION &#39;host=10.10.10.10 dbname=meta user=replicator&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  PUBLICATION pg_meta_pub;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><h3 id="观察复制状态">观察复制状态</h3>
<p>当<code>pg_subscription_rel.srsubstate</code>全部变为<code>r</code> （准备就绪）状态后，逻辑复制就建立起来了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ psql <span style="color:#4e9a06">${</span><span style="color:#000">PGDST</span><span style="color:#4e9a06">}</span> -c <span style="color:#4e9a06">&#39;TABLE pg_subscription_rel;&#39;</span>
</span></span><span style="display:flex;"><span> srsubid <span style="color:#000;font-weight:bold">|</span> srrelid <span style="color:#000;font-weight:bold">|</span> srsubstate <span style="color:#000;font-weight:bold">|</span>  srsublsn
</span></span><span style="display:flex;"><span>---------+---------+------------+------------
</span></span><span style="display:flex;"><span>   <span style="color:#0000cf;font-weight:bold">20451</span> <span style="color:#000;font-weight:bold">|</span>   <span style="color:#0000cf;font-weight:bold">20433</span> <span style="color:#000;font-weight:bold">|</span> d          <span style="color:#000;font-weight:bold">|</span> NULL
</span></span><span style="display:flex;"><span>   <span style="color:#0000cf;font-weight:bold">20451</span> <span style="color:#000;font-weight:bold">|</span>   <span style="color:#0000cf;font-weight:bold">20442</span> <span style="color:#000;font-weight:bold">|</span> r          <span style="color:#000;font-weight:bold">|</span> 0/4ECCDB78
</span></span><span style="display:flex;"><span>   <span style="color:#0000cf;font-weight:bold">20451</span> <span style="color:#000;font-weight:bold">|</span>   <span style="color:#0000cf;font-weight:bold">20436</span> <span style="color:#000;font-weight:bold">|</span> r          <span style="color:#000;font-weight:bold">|</span> 0/4ECCDB78
</span></span><span style="display:flex;"><span>   <span style="color:#0000cf;font-weight:bold">20451</span> <span style="color:#000;font-weight:bold">|</span>   <span style="color:#0000cf;font-weight:bold">20439</span> <span style="color:#000;font-weight:bold">|</span> r          <span style="color:#000;font-weight:bold">|</span> 0/4ECCDBB0
</span></span></code></pre></div><h3 id="校验复制数据">校验复制数据</h3>
<p>可以简单地比较发布与订阅端两侧的表记录条数，与复制标识列的最大最小值来校验数据是否完整地复制。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> compare_relation<span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">local</span> <span style="color:#000">relname</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">local</span> <span style="color:#000">identity</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">2</span><span style="color:#000;font-weight:bold">-</span><span style="color:#4e9a06">&#39;id&#39;</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>	psql <span style="color:#4e9a06">${</span><span style="color:#000">3</span><span style="color:#000;font-weight:bold">-</span><span style="color:#4e9a06">${</span><span style="color:#000">PGPUB</span><span style="color:#4e9a06">}}</span> -AXtwc <span style="color:#4e9a06">&#34;SELECT count(*) AS cnt, max(</span><span style="color:#000">$identity</span><span style="color:#4e9a06">) AS max, min(</span><span style="color:#000">$identity</span><span style="color:#4e9a06">) AS min FROM </span><span style="color:#4e9a06">${</span><span style="color:#000">relname</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">;&#34;</span>
</span></span><span style="display:flex;"><span>	psql <span style="color:#4e9a06">${</span><span style="color:#000">4</span><span style="color:#000;font-weight:bold">-</span><span style="color:#4e9a06">${</span><span style="color:#000">PGSUB</span><span style="color:#4e9a06">}}</span> -AXtwc <span style="color:#4e9a06">&#34;SELECT count(*) AS cnt, max(</span><span style="color:#000">$identity</span><span style="color:#4e9a06">) AS max, min(</span><span style="color:#000">$identity</span><span style="color:#4e9a06">) AS min FROM </span><span style="color:#4e9a06">${</span><span style="color:#000">relname</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>compare_relation pgbench_accounts aid
</span></span><span style="display:flex;"><span>compare_relation pgbench_branches bid
</span></span><span style="display:flex;"><span>compare_relation pgbench_history  tid
</span></span><span style="display:flex;"><span>compare_relation pgbench_tellers  tid
</span></span></code></pre></div><p>更近一步的验证可以通过在发布者上手工创建一条记录，再从订阅者上读取出来。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ psql <span style="color:#4e9a06">${</span><span style="color:#000">PGPUB</span><span style="color:#4e9a06">}</span> -AXtwc <span style="color:#4e9a06">&#39;INSERT INTO pgbench_accounts(aid,bid,abalance) VALUES (99999999,1,0);&#39;</span>
</span></span><span style="display:flex;"><span>INSERT <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>$ psql <span style="color:#4e9a06">${</span><span style="color:#000">PGSUB</span><span style="color:#4e9a06">}</span> -AXtwc <span style="color:#4e9a06">&#39;SELECT * FROM pgbench_accounts WHERE aid = 99999999;&#39;</span>
</span></span><span style="display:flex;"><span>99999999<span style="color:#000;font-weight:bold">|</span>1<span style="color:#000;font-weight:bold">|</span>0<span style="color:#000;font-weight:bold">|</span>
</span></span></code></pre></div><p>现在已经拥有一个正常工作的逻辑复制了。下面让我们来通过一系列实验来掌握逻辑复制的使用与管理，探索可能遇到的各种离奇问题。</p>
<hr>
<h2 id="逻辑复制实验">逻辑复制实验</h2>
<h3 id="将表加入已有发布">将表加入已有发布</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_normal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">BIGSERIAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">TIMESTAMP</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 常规表，带有主键
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PUBLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_meta_pub</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ADD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_normal</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 将新创建的表加入到发布中
</span></span></span></code></pre></div><p>如果这张表在订阅端已经存在，那么即可进入正常的逻辑复制流程：<code>i -&gt; d -&gt; s -&gt; r</code>。</p>
<p>如果向发布加入一张订阅端不存在的表？那么新订阅将会<strong>无法创建</strong>。<strong>已有订阅无法刷新</strong>，但可以保持原有复制继续进行。</p>
<p>如果订阅<strong>还不存在</strong>，那么创建的时候会报错无法进行：在订阅端找不到这张表。如果订阅<strong>已经存在</strong>，无法执行刷新命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SUBSCRIPTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_test_sub</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REFRESH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PUBLICATION</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>如果新加入的表没有任何写入，已有的复制关系不会发生变化，一旦新加入的表发生变更，会立即产生<strong>复制冲突</strong>。</p>
<h3 id="将表从发布中移除">将表从发布中移除</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PUBLICATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_meta_pub</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ADD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_normal</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>从发布移除后，订阅端不会有影响。效果上就是这张表的变更似乎消失了。执行订阅刷新后，这张表会从订阅集中被移除。</p>
<p>另一种情况是<strong>重命名</strong>发布/订阅中的表，在发布端执行表重命名时，发布端的发布集会立刻随之更新。尽管订阅集中的表名不会立刻更新，但只要重命名后的表发生任何变更，而订阅端没有对应的表，那么会立刻出现<strong>复制冲突</strong>。</p>
<p>同理，在订阅端重命名表时，订阅的关系集也会刷新，但因为发布端的表没有对应物了。如果这张表没有变更，那么一切照旧，一旦发生变更，立刻出现<strong>复制冲突</strong>。</p>
<p>直接在发布端<code>DROP</code>此表，会顺带<strong>将该表从发布中移除</strong>，不会有报错或影响。但直接在订阅端<code>DROP</code>表则可能出现<strong>问题</strong>，<code>DROP TABLE</code>时该表也会从订阅集中被移除。如果发布端此时这张表上仍有变更产生，则会导致<strong>复制冲突</strong>。</p>
<p><strong>所以，删表应当先在发布端进行，再在订阅端进行。</strong></p>
<h3 id="两端列定义不一致">两端列定义不一致</h3>
<p>发布与订阅端的表的列通过<strong>名称</strong>匹配，列的顺序无关紧要。</p>
<p><strong>订阅端表的列更多，通常不会有什么影响</strong>。多出来的列会被填充为默认值（通常是<code>NULL</code>）。</p>
<p>特别需要注意的是，如果要为多出来的列添加<code>NOT NULL</code>约束，那么一定要配置一个默认值，否则变更发生时违反约束会导致复制冲突。</p>
<p><strong>订阅端如果列要比发布端更少，会产生复制冲突</strong>。在发布端添加一个新列并不会<strong>立刻</strong>导致复制冲突，随后的第一条变更将导致复制冲突。</p>
<p>所以在执行加列DDL变更时，可以先在订阅者上先执行，然后在发布端进行。</p>
<p>列的<strong>数据类型不需要完全一致</strong>，只要两个列的<strong>文本表示</strong>兼容即可，即数据的文本表示可以转换为目标列的类型。</p>
<p>这意味着任何类型都能转换成TEXT类型，<code>BIGINT</code> 只要不出错，也可以转换成<code>INT</code>，不过一旦溢出，还是会出现<strong>复制冲突</strong>。</p>
<h3 id="复制身份与索引的正确配置">复制身份与索引的正确配置</h3>
<p>表上的复制标识配置，与表上有没有索引是两件独立的事。尽管各种排列组合都是可能的，然而在实际使用中只有三种可行的情况，其他情况都无法正常完成逻辑复制的功能（如果不报错，通常也是侥幸）</p>
<ul>
<li>表上有主键，使用默认的 <code>default</code> 复制标识，不需要额外配置。</li>
<li>表上没有主键，但是有非空唯一索引，显式配置 <code>index</code> 复制标识。</li>
<li>表上既没有主键也没有非空唯一索引，显式配置<code>full</code>复制标识（运行效率低，仅作为兜底方案）</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">复制身份模式\表上的约束</th>
<th style="text-align:center">主键(p)</th>
<th style="text-align:center">非空唯一索引(u)</th>
<th style="text-align:center">两者皆无(n)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>d</strong>efault</td>
<td style="text-align:center"><strong>有效</strong></td>
<td style="text-align:center">x</td>
<td style="text-align:center">x</td>
</tr>
<tr>
<td style="text-align:center"><strong>i</strong>ndex</td>
<td style="text-align:center">x</td>
<td style="text-align:center"><strong>有效</strong></td>
<td style="text-align:center">x</td>
</tr>
<tr>
<td style="text-align:center"><strong>f</strong>ull</td>
<td style="text-align:center"><strong>低效</strong></td>
<td style="text-align:center"><strong>低效</strong></td>
<td style="text-align:center"><strong>低效</strong></td>
</tr>
<tr>
<td style="text-align:center"><strong>n</strong>othing</td>
<td style="text-align:center">x</td>
<td style="text-align:center">x</td>
<td style="text-align:center">x</td>
</tr>
</tbody>
</table>
<blockquote>
<p>在所有情况下，<code>INSERT</code>都可以被正常复制。<code>x</code>代表<code>DELETE|UPDATE</code>所需关键信息缺失无法正常完成。</p>
</blockquote>
<p>最好的方式当然是事前修复，为所有的表指定主键，以下查询可以用于找出缺失主键或非空唯一索引的表：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">quote_ident</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">quote_ident</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">con</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ri</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relreplident</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;d&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;default&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;n&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;nothing&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;f&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;full&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;i&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;index&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica_identity</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_namespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LATERAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">array_agg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">contype</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ri</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_constraint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">conrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">con</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relkind</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;r&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pg_catalog&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;information_schema&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;repack&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pg_toast&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>注意，复制身份为<code>nothing</code>的表可以加入到发布中，但在发布者上对其执行<code>UPDATE|DELETE</code>会直接导致报错。</p>
<hr>
<h2 id="其他问题">其他问题</h2>
<h3 id="q逻辑复制准备工作">Q：逻辑复制准备工作</h3>
<h3 id="q什么样的表可以逻辑复制">Q：什么样的表可以逻辑复制？</h3>
<h3 id="q监控逻辑复制状态">Q：监控逻辑复制状态</h3>
<h3 id="q将新表加入发布">Q：将新表加入发布</h3>
<h3 id="q没有主键的表加入发布">Q：没有主键的表加入发布？</h3>
<h3 id="q没有复制身份的表如何处理">Q：没有复制身份的表如何处理？</h3>
<h3 id="qalter-pub的生效方式">Q：ALTER PUB的生效方式</h3>
<h3 id="q在同一对-发布者-订阅者-上如果存在多对订阅且发布包含的表重叠">Q：在同一对 发布者-订阅者 上如果存在多对订阅，且发布包含的表重叠？</h3>
<h3 id="q订阅者和发布者的表定义有什么限制">Q：订阅者和发布者的表定义有什么限制？</h3>
<h3 id="qpg_dump是如何处理订阅的">Q：pg_dump是如何处理订阅的</h3>
<h3 id="q什么情况下需要手工管理订阅复制槽">Q：什么情况下需要手工管理订阅复制槽？</h3>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-f7dcbee2dc636abe5d32bc9a6a706dd1">PostgreSQL 宏观查询优化之 pg_stat_statements</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）｜ <a href="https://mp.weixin.qq.com/s/VXkpDlUdnKlK3DKtoyg2wA">微信公众号</a></b> |
        
		<time datetime="2023-10-26" class="text-muted">2023年10月26日</time>
        
	</div>
	<p>在线业务数据库中，慢查询不仅影响终端用户体验，还会浪费系统资源、拉高资源饱和度、导致死锁和事务冲突，增加数据库连接压力，导致主从复制延迟等问题。因此，<strong>查询优化</strong>是 DBA 的核心工作内容之一。</p>
<p>在查询优化这条路上，有两种不同的方法：</p>
<p><strong>宏观优化</strong>：整体分析工作负载，对其进行剖分下钻，自上而下地识别并改进其中表现最糟糕的部分。</p>
<p><strong>微观优化</strong>：分析并改进一条特定的查询，这便需要记录慢查询日志，掌握 EXPLAIN 的玄机，领悟执行计划的奥妙。</p>
<p>今天我们先来说说前者，<strong>宏观优化</strong>有三个主要目标与动机：</p>
<p><strong>减少资源消耗</strong>：降低资源饱和的风险，优化CPU/内存/IO，通常以查询<strong>总耗时/总IO</strong>作为优化目标。</p>
<p><strong>改善用户体验</strong>：最常见的优化目标，在OLTP系统中通常以降低<strong>查询平均响应时间</strong>作为优化目标。</p>
<p><strong>平衡工作负载</strong>：确保不同查询组之间的资源使用/性能表现的比例关系得当。</p>
<p>实现这些目标的关键在于<strong>数据支撑</strong>，但是数据从哪里来？</p>
<p>—— <strong>pg_stat_statements</strong>！</p>
<p><img alt="pgss-1.png" src="/zh/blog/admin/pgss/pgss-1.png"></p>
<hr>
<h2 id="扩展插件pgss">扩展插件：PGSS</h2>
<p><strong>pg_stat_statements</strong>，以下简称 <strong>PGSS</strong> ，是践行观宏之道的核心工具。</p>
<p>PGSS 出自 PostgreSQL 全球开发组官方之手，以第一方扩展插件的形式，随数据库内核本体一并发行，提供了跟踪 SQL 查询语句级别指标的方法。</p>
<p>PostgreSQL 生态中有许许多多的扩展，但如果说有哪一个是“<strong>必选</strong>”的，我必定会毫不犹豫的回答：<strong>PGSS</strong>。这也是在 <a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486135&idx=1&sn=7d9c4920e94efba5d0e0b6af467f596c&chksm=fe4b3f6cc93cb67ac570d5280b37328aed392598b13df88545ff0a06f99630801fc999db8de5&scene=21#wechat_redirect"><strong>Pigsty</strong></a> 中，我们宁愿“自作主张”，也要默认启用并主动加载的两个扩展之一。（另一个是用于微观优化的 auto_explain）</p>
<p>PGSS 需要在 <strong>shared_preload_library</strong> 中显式指定加载，并在数据库中通过 <strong>CREATE EXTENSION</strong> 显式创建。创建扩展后即可通过视图 <strong>pg_stat_statements</strong> 访问查询的统计信息。</p>
<p>在 <strong>PGSS</strong> 中，系统中的每一类查询（即抽取变量后，执行计划相同的查询）都会被分配一个查询ID，紧接着是调用次数，执行总耗时，以及各种其他指标，其完整模式定义如下（PG15+）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stat_statements</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">userid</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#000">OID</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic">-- （标签值）执行此语句的用户 OID（标签值）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">dbid</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#000">OID</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic">-- （标签值）此语句所在的数据库 OID（标签值）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">toplevel</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#000">BOOL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">-- （标签值）此语句是否是顶层 SQL 语句（标签值）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">queryid</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （标签值）查询ID：标准化查询的哈希值（标签值）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">query</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">-- （标签值）标准化查询语句的文本内容
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">plans</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）此语句被 PLAN 的次数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">total_plan_time</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- （累积量）此语句花费在 PLAN 上的总时长
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">min_plan_time</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- （测量值）PLAN 的最小时长
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">max_plan_time</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- （测量值）PLAN 的最大时长
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">mean_plan_time</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- （测量值）PLAN 的平均时长
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">stddev_plan_time</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- （测量值）PLAN 时间的标准差
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">calls</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）此语句被调用执行的次数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">total_exec_time</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- （累积量）此语句花费在执行上的总时长
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">min_exec_time</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- （测量值）执行的最小时长
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">max_exec_time</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- （测量值）执行的最大时长
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">mean_exec_time</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- （测量值）执行的平均时长
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">stddev_exec_time</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- （测量值）执行时间的标准差
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）执行此语句返回的总行数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">shared_blks_hit</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）命中的共享缓冲区总块数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">shared_blks_read</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）读取的共享缓冲区总块数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">shared_blks_dirtied</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）写脏的共享缓冲区总块数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">shared_blks_written</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）写入磁盘的共享缓冲区总块数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">local_blks_hit</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）命中的本地缓冲区总块数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">local_blks_read</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）读取的本地缓冲区总块数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">local_blks_dirtied</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）写脏的本地缓冲区总块数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">local_blks_written</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）写入磁盘的本地缓冲区总块数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">temp_blks_read</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）读取的临时缓冲区总块数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">temp_blks_written</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）写入磁盘的临时缓冲区总块数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">blk_read_time</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- （累积量）读取块花费的总时长
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">blk_write_time</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- （累积量）写入块花费的总时长
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">wal_records</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）生成 WAL 的记录总数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">wal_fpi</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）生成的 WAL全页镜像总数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">wal_bytes</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- （累积量）生成的 WAL 字节总数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">jit_functions</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）JIT 编译的函数数量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">jit_generation_time</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- （累积量）生成 JIT 字节码的总时长
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">jit_inlining_count</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）函数被内联的次数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">jit_inlining_time</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- （累积量）花费在内联函数上的总时长
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">jit_optimization_count</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）查询被 JIT优化的次数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">jit_optimization_time</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- （累积量）花费在JIT优化上的总时长
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">jit_emission_count</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- （累积量）代码被 JIT Emit的次数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">jit_emission_time</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- （累积量）花费在 JIT Emit上的总时长
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">queryid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toplevel</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>PGSS 视图的 SQL 定义（PG 15+版本）</p>
<p><strong>PGSS</strong> 也有一些局限性：首先，<strong>正在执行中</strong>的查询语句并不会纳入这里的统计，而需要从 <strong>pg_stat_activity</strong> 中查看获取。其次，执行失败的查询（例如，因为 statement_timeout 超时被取消的语句）也不会被计入这里的统计 —— 这是<strong>错误分析</strong>要解决的问题，而不是<strong>查询优化</strong>所关心的目标。</p>
<p>最后，查询标识符 <strong>queryid</strong> 的稳定性需要特别注意：当数据库二进制版本和系统数据目录完全相同时，同一类查询会具有相同的 <strong>queryid</strong> （即在物理复制的主从上，同类查询的 <strong>queryid</strong> 默认是相同的），然而对于逻辑复制则不然。但用户不应当对这一性质抱有过度的依赖与假设。</p>
<hr>
<h2 id="原始数据">原始数据</h2>
<p><strong>PGSS</strong> 视图中的列可以分为三类：</p>
<p><strong>描述性的标签列（Label）</strong>：查询ID（queryid）、数据库 ID（dbid）、用户（userid），一个顶层查询标记，和标准化的查询文本（query）。</p>
<p><strong>测量性的指标（Gauge）</strong>：与最小、最大、均值标准差有关的八列统计量，以 min，max，mean，stddev 作为前缀，以 plan_time 与 exec_time 作为后缀。</p>
<p><strong>累积性的指标（Counter）</strong>：除了上面八列与标签列的<strong>其他指标</strong>，例如 calls、rows 等，最重要、最有用的指标都在这一类里。</p>
<p>首先解释一下 queryid：queryid 是查询语句被解析后，剥离常量后生成规范化查询的哈希值，因此可以用来标识<strong>同一类查询</strong>。不同的查询语句可能有着同样的 queryid （规范化后结构一样），同样的查询语句也可能有着不同的 queryid （例如因为 search_path 不同，导致实际查询的表不懂）。</p>
<p>同样的查询可能会在不同的数据库中被不同的用户所执行。因此在 PGSS 视图中，queryid，dbid，userid，toplevel 四个标签列，共同组成了唯一标识一条记录的“主键”。</p>
<p>对于指标列而言，<strong>测量性质的指标（GAUGE）</strong> 主要是执行时间与计划时间相关的八个统计量，然而用户没有办法很好地控制这些统计量的统计范围，所以实用价值并不大。</p>
<p>真正重要的指标是<strong>累积性的指标（Counter）</strong>，例如：</p>
<p><strong>calls</strong> ：此查询组发生了多少次调用。</p>
<p><strong>total_exec_time</strong> + <strong>total_plan_time</strong>：查询组累计耗费时间。</p>
<p><strong>rows</strong>：查询组累计返回了多少行。</p>
<p><strong>shared_blks_hit</strong> + <strong>shared_blks_read</strong>：缓冲池累计命中和读取操作次数。</p>
<p><strong>wal_bytes</strong>：此组中的查询累计生成的 WAL 字节数。</p>
<p><strong>blk_read_time</strong> 和 <strong>blk_write_time</strong>：累计花费在块读写IO上的时间</p>
<p>这里，最有意义的指标是 <strong>calls</strong> 与 <strong>total_exec_time</strong>，可以用于计算查询组的核心指标 <strong>QPS</strong> （吞吐量）与 <strong>RT</strong>（延迟/响应时间），但其他的指标也很有参考价值。</p>
<p><img alt="pgss-2.png" src="/zh/blog/admin/pgss/pgss-2.png"></p>
<p>可视化展现 PGSS 视图的某个查询组快照</p>
<p>要解读累积性指标数据，只有某一个时刻的数据是不够的。<strong>我们需要对比至少两个时刻的<strong><strong>快照</strong></strong>，才能得到有意义的结论</strong>。</p>
<p>作为特例，如果您感兴趣的范围正好是从统计周期伊始（通常是启用此扩展时）至今，那么确实不需要对比“两个快照”。但用户感兴趣的时间粒度通常并不会这么粗放，而往往是以分钟、小时、天为单位。</p>
<p><img alt="pgss-3.png" src="/zh/blog/admin/pgss/pgss-3.png"></p>
<blockquote>
<p>根据多个 PGSS 查询组快照计算历史时序指标</p>
</blockquote>
<p>好在类似 <a href="https://pigsty.cc">Pigsty</a> 监控系统这样的工具会定期（默认每隔10s）截取头部查询（耗时Top256）的快照。有了许多不同类型的累积指标 M（etrics）在不同时刻的快照之后，我们就能计算出某个累积性指标的三种重要派生指标：</p>
<p><strong>dM/dt</strong> ：指标 M 基于时间的微分，即每秒的增量。</p>
<p><strong>dM/dc</strong>：指标 M 基于调用次数的微分，即每次调用的平均增量。</p>
<p><strong>%M</strong>：指标 M 在整个工作负载中所占的百分比。</p>
<p>这三类指标正好与宏观优化的三类目标相对应，对时间的微分 <strong>dM/dt</strong> 揭示了<strong>每秒资源使用量</strong>，通常用于减少资源消耗的优化目标。对调用次数的微分 <strong>dM/dc</strong> 揭示了<strong>每次调用的资源使用量</strong>，通常用于改善用户体验的优化目标。而百分比指标 <strong>%M</strong> 展示了查询组在整个工作负载中所占的百分比，通常用于平衡工作负载的优化目标。</p>
<hr>
<h2 id="对时间微分">对时间微分</h2>
<p>让我们首先来看第一类指标：对时间的微分。在这里，我们可以使用的指标 M 包括：calls，total_exec_time，rows，wal_bytes，shared_blks_hit + shared_blks_read，以及 blk_read_time + blk_write_time。其他的指标也有参考意义，但让我们从最重要的开始。</p>
<p><img alt="pgss-4.png" src="/zh/blog/admin/pgss/pgss-4.png"></p>
<blockquote>
<p>可视化展现对时间的微分指标 dM/dt</p>
</blockquote>
<p>计算这些指标的方式其实很简单，我们只需要：</p>
<ul>
<li>首先计算两个快照之间的指标值 M 的差值：<strong>M2 - M1</strong></li>
<li>然后计算两个快照之间的时间差值：<strong>t2 - t1</strong></li>
<li>最终计算 <strong>(M2 - M1) / (t2 - t1)</strong> 即可</li>
</ul>
<p>生产环境通常会使用 5s，10s，15s，30s，60s 这样的数据采样间隔。对于负载分析通常会使用 1m， 5m，15m 作为常用的分析窗口大小。</p>
<p>例如，当我们计算 QPS 时，就会分别计算最近 1分钟，5分钟，15分钟的 QPS。窗口越长曲线就越平稳，更能反映长期变化趋势；但是会隐藏短期波动细节，不利于发现瞬时异常波动，所以不同粒度的指标需要结合来看。</p>
<p><img alt="pgss-5.png" src="/zh/blog/admin/pgss/pgss-5.png"></p>
<blockquote>
<p>展示特定查询组 1/5/15 分钟窗口下的 QPS</p>
</blockquote>
<p>如果您使用 Pigsty / Prometheus 来采集监控数据，那么可以使用 PromQL 简单地完成这些计算工作。例如，计算所有查询最近1分钟的 QPS 指标，使用以下语句就可以了： rate(pg_query_calls{}[1m])</p>
<p><strong>QPS</strong></p>
<p>当 M 是 calls 时，对时间求导的结果是 QPS，它的单位是每秒查询数（req/s），这是一个非常基础的指标。查询 QPS 属于吞吐量指标，直接反应了业务施加的负载状况，如果一个查询的吞吐量过高（例如，10000+）或者过低（例如，1-），有可能是值得关注的。</p>
<p><img alt="pgss-6.png" src="/zh/blog/admin/pgss/pgss-6.png"></p>
<blockquote>
<p>QPS：1/5/15 分钟 µ/CV， ±1/3σ分布</p>
</blockquote>
<p>如果我们把所有查询组的 QPS 指标累加起来（且没超过PGSS的收集范围），就会得到所谓的 “全局QPS”。另一种获得全局 QPS 的方式是在客户端打点，在类似 Pgbouncer 的连接池中间件上采集，或者使用 ebpf 探测。但都不如 PGSS 方便。</p>
<p>请注意，QPS 指标并不具备负载意义上的<strong>横向可比性</strong>。不同查询组可能有着同样的 QPS，而单个查询的耗时却天差地别。甚至同一个查询组在不同时间点上产生的负载水平，也可能因为执行计划不同而发生巨大变化。每秒执行时长是一个更好的衡量负载的指标。</p>
<p><strong>每秒执行时长</strong></p>
<p>当 M 是 total_exec_time （+ total_plan_time，可选 ）时，我们就会得到宏观优化中最重要的指标之一：在查询组上耗费的的执行时间，有意思的是，这个导数的单位是 秒/每秒，所以分子分母相互约掉了，使得它实际上是一个无量纲的指标。</p>
<p>这个指标的涵义是：服务器每秒钟花费多少秒来处理这个查询组中的查询，例如 2 s/s 意味着服务器每秒花费两秒执行时间在这组查询上；对于多核CPU，这当然是有可能的：把两个CPU核的全部时间都拿来就行了。</p>
<p><img alt="pgss-7.png" src="/zh/blog/admin/pgss/pgss-7.png"></p>
<blockquote>
<p>每秒执行时长：1/5/15 分钟均值</p>
</blockquote>
<p>因此这里的值也可以理解为一个百分比：可以超过 100%，在这种视角下，它是一个类似于主机 load1, load5, load15 的指标，揭示了该查询组产生的<strong>负载水平</strong>。如果除以 CPU 核数，甚至可以得到归一化的查询负载贡献度指标。</p>
<p>但是我们需要注意的是，执行时间中包括了等待锁，等待I/O的时间。所以确实可能出现这样的情况：查询执行时间很长，但却没有对 CPU 负载产生影响。所以如果要精细分析慢查询，我们还要参考<strong>等待事件</strong>来进一步分析才行。</p>
<p><strong>每秒行数</strong></p>
<p>当 M 是 rows 时，我们会得到每秒该查询组返回的行数，单位是行/每秒（rows/s）。例如 10000 rows/s 意味着该类查询每秒向客户端吐出1万行数据。返回的行需要耗费客户端的处理资源，当我们需要检视应用客户端的数据处理压力时，这是一个非常有参考意义的指标。</p>
<p><img alt="pgss-8.png" src="/zh/blog/admin/pgss/pgss-8.png"></p>
<blockquote>
<p>每秒返回的行数：1/5/15 分钟均值</p>
</blockquote>
<p><strong>共享缓冲区访问带宽</strong></p>
<p>当 M 是 shared_blks_hit + shared_blks_read 时，我们会得到每秒命中/读取的共享缓冲区块数，如果将其乘以默认块大小 8KiB（极少情况下有可能会是其他的大小，例如32KiB），我们就会得到一类查询“访问”内存磁盘的带宽：单位是字节/秒。</p>
<p>举个例子，如果某一类查询每秒访问50万次共享缓冲区，折合 3.8 GiB/s 的内部访问数据流：那么这就是一个显著负载，也许会是一个很好的优化候选项。也许你应该检查一下这个查询，看看它是否配得上这些“资源消耗”。</p>
<p><img alt="pgss-9.png" src="/zh/blog/admin/pgss/pgss-9.png"></p>
<blockquote>
<p>共享缓冲区访问带宽与缓冲区命中率</p>
</blockquote>
<p>另一个值得参考的衍生指标是缓冲区命中率：即 hit / (hit + read) ，它可以用于分析性能变化的可能原因 —— 缓存未命中。当然，重复访问同一个共享缓冲池里的块，并不会真的重新读取，即使真的去读取，也不一定是读取磁盘，有可能是读内存中的FS Cache。所以这里只是一个参考值，但它确实是一个非常重要的宏观查询优化参考指标。</p>
<p><strong>WAL日志量</strong></p>
<p>当 M 是 wal_bytes 时，我们得到了该查询生成 WAL 的速率，单位是字节/每秒（B/s）。这个指标是在 PostgreSQL 13 新引入的，可以用来定量揭示查询产生的 WAL 大小：写入的 WAL 越多越快，刷写磁盘、物理复制/逻辑复制、日志归档的压力就会越大。</p>
<p>一个典型的例子是：<code>BEGIN; DELETE FROM xxx; ROLLBACK;</code> 。这样的事务删了很多数据，产生了大量 WAL 却没有执行任何有用的工作，通过这个指标可以将其揪出来。</p>
<p><img alt="pgss-10.png" src="/zh/blog/admin/pgss/pgss-10.png"></p>
<blockquote>
<p>WAL字节率：1/5/15 分钟均值</p>
</blockquote>
<p>这里有两个注意事项：上面我们说过，PGSS 无法跟踪执行失败的语句，但这里事务虽然 <strong>ROLLBACK</strong> 失败了，但是语句却是成功执行了的，所以会被 PGSS 跟踪记录。</p>
<p>第二件事是：在 PostgreSQL 中并非仅仅是 INSERT/UPDATE/DELETE 会产生 WAL 日志，SELECT 操作也有可能产生 WAL 日志，因为 SELECT 可能会修改元组上的标记（Hint Bit）让页面校验和出现变化，触发 WAL 日志写入。</p>
<p>甚至存在这种可能，如果读取负载非常大，它会有较大概率导致 FPI 镜像生成，产生可观的 WAL 日志量。你可以通过进一步检查 wal_fpi 指标。</p>
<p><img alt="pgss-11.png" src="/zh/blog/admin/pgss/pgss-11.png"></p>
<blockquote>
<p>共享缓冲区写脏/写回带宽</p>
</blockquote>
<p>对于 13 以下的版本，共享缓冲区写脏/写回带宽指标可以作为一个近似下位替代，用于分析查询组的写入负载特征。</p>
<p><strong>I/O耗时</strong></p>
<p>当 M 是 blks_read_time + blks_write_time ，我们会得到查询组花费在块 I/O 上的耗时比例，单位是 “秒/每秒”，与每秒执行时长指标一样，它也反映出一样操作占用的时间比例。</p>
<blockquote>
<p>I/O 耗时对于分析查询毛刺原因很有帮助</p>
</blockquote>
<p>因为 PostgreSQL 会使用操作系统提供的 FS Cache，所以即使这里执行了块读取/写入，可能在文件系统层面上仍然是发生在内存中的缓冲操作。所以它只能作为一个参考指标，使用时需要谨慎，需要与主机节点上的磁盘 I/O 监控相互对照。</p>
<p><strong>对时间微分的指标</strong> <strong>dM/dt</strong>，可以展现出一个数据库实例/集群内部工作负载的全貌，对于优化资源使用的场景来说尤其有用。但是如果您的优化目标是改善用户体验，那么可能另一组指标 —— <strong>对调用次数的微分 dM/dc</strong>，会更有参考意义。</p>
<hr>
<h2 id="对调用次数微分">对调用次数微分</h2>
<p>上面我们已经计算了六类重要指标对于<strong>时间</strong>的微分，另一类衍生指标计算方式是对 “<strong>调用次数</strong>” 进行微分，也就是分母从时间差变成了 QPS。</p>
<p>这类指标重要性相比前者甚至更高，因为它提供了直接关乎用户体验的几个核心指标，比如最重要的 —— <strong>查询响应时间</strong> <strong>（RT，Response Time）</strong>，或曰 <strong>延迟（Latency）</strong>。</p>
<p>计算这些指标的方式也很简单，我们只需要：</p>
<ul>
<li>计算两个快照之间的指标值 M 的差值：<strong>M2 - M1</strong></li>
<li>然后计算两个快照之间的 calls 差值：<strong>c2 - c1</strong></li>
<li>然后计算 <strong>(M2 - M1) / (c2 - c1)</strong> 即可</li>
</ul>
<p>对于 PromQL 实现来说，对于<strong>调用次数的微分指标 dM/dc</strong>，可以用“<strong>对时间的微分指标 dM/dt</strong>” 计算得到。例如要计算 RT，就可以使用 <strong>每秒执行时长</strong> <strong>/</strong> <strong>每秒查询数</strong> ，两指标相除即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>rate(pg_query_exec_time{}[1m]) / rate(pg_query_calls{}[1m])
</span></span></code></pre></div><p><img alt="pgss-12.png" src="/zh/blog/admin/pgss/pgss-12.png"></p>
<blockquote>
<p>dM/dt 可以用于计算 dM/dc</p>
</blockquote>
<p><strong>调用次数</strong></p>
<p>当 M 是 calls 时，对自己微分没有任何意义（结果会恒为 1）。</p>
<p><strong>平均延迟/响应时间/RT</strong></p>
<p>当 M 是 total_exec_time 时，对调用次数求导的结果是 <strong>RT</strong>，或响应时间/延迟。它的单位是秒（s）。<strong>RT 直接反映了用户体验，是宏观性能分析中最重要的指标</strong>。这个指标的含义是：此查询组在服务器上的平均查询响应时间。如果条件允许启用 pg_stat_statements.track_planning，还可以加上 total_plan_time 一起计算，结果会更精确更具有代表性。</p>
<p><img alt="pgss-13.png" src="/zh/blog/admin/pgss/pgss-13.png"></p>
<blockquote>
<p>RT：1/5/15 分钟 µ/CV， ±1/3σ分布</p>
</blockquote>
<p>这里要特别强调两种特殊情况：第一：PGSS不跟踪失败/执行中的语句；第二：PGSS的统计数据受（pg_stat_statements.max）参数限制，可能出现部分采样偏差。尽管有这些局限性，但想要获取至关重要的查询语句组延迟数据，PGSS 毫无疑问是最为稳妥可靠的来源。正如上面所述，在其他观测点位也有办法采集查询 RT 数据，但会麻烦得多。</p>
<p>你可以在客户端侧打点，采集语句执行时间，通过指标或者日志上报；你也可以尝试使用 ebpf 来探测语句 RT，这对基础设施和工程师要求会比较高。Pgbouncer 和 PostgreSQL （14+） 倒是也提供了 RT 指标，只可惜粒度都是数据库级别，没有一个能做到 PGSS 查询语句组级别的指标收集。</p>
<p><img alt="pgss-14.png" src="/zh/blog/admin/pgss/pgss-14.png"></p>
<blockquote>
<p>RT：语句级/连接池级/数据库级</p>
</blockquote>
<p>不同于 QPS 这样的吞吐量指标，<strong>RT 是具有横向可比性的</strong>：例如某个查询组平时的 RT 都在1毫秒内，那么超过 10ms 的事件应当被视作严重的偏差进行分析。</p>
<p>当出现故障时， RT 视图对于定位原因也很有帮助：如果所有查询整体 RT 变慢，那么最有可能与资源不足有关。如果只是特定查询组的 RT 发生变化，那就更有可能是某些慢查询导致了问题，应当进一步调查分析。如果 RT 变化的时间点与应用发布部署吻合，则应当考虑是否要回滚这些部署。</p>
<p>此外，在性能分析，压力测试，基准测试时，<strong>RT 也是最重要的指标</strong>。你可以通过对比典型查询在不同环境（例如不同PG大版本、不同硬件、不同配置参数）下的延迟表现来评估系统的性能，并以此为依据不断对系统性能进行调整与改进。</p>
<p>RT 是如此重要，以至于 RT 本身又会衍生出许多下游指标来：1分钟/5分钟/15分钟的均值µ与标准差σ自然必不可少；过去15分钟的 ±σ，±3σ 可以用来衡量 RT 的波动范围，过去1小时的 95，99 分位点也很有参考价值。</p>
<p>RT 是评估 OLTP工作负载的核心指标，怎么强调它的重要性都不为过。</p>
<p><strong>平均返回行数</strong></p>
<p>当 M 是 rows 时，我们会得到每次查询<strong>平均返回的行数</strong>，单位是行/每查询。对于 OLTP 工作负载来说，典型查询模式为点查，即每次查询返回几条数据。</p>
<p><img alt="pgss-15.png" src="/zh/blog/admin/pgss/pgss-15.png"></p>
<blockquote>
<p>按照主键查询单条记录，平均返回行数稳定为1</p>
</blockquote>
<p>如果一个查询组每次查询向客户端吐出几百甚至成千上万行记录，那么应当对其进行审视。如果这是有意而为之的设计，比如批量加载任务/数据转储，那么不需要做什么。如果这是由应用/客户端发起的请求，那么可能存在错误，比如语句缺少 LIMIT 限制，查询缺少分页设计，这样的查询应该进行调整修复。</p>
<p><strong>平均共享缓冲区读取/命中</strong></p>
<p>当 M 是 shared_blks_hit + shared_blks_read 时，我们会得到每条查询“命中”与“读取”共享缓冲区的平均次数，如果将其乘以默认块大小 8KiB，我们就会得到这类查询每次执行的“带宽”，单位是 B/s：每次查询平均会访问/读取多少 MB 数据 ？</p>
<p><img alt="pgss-16.png" src="/zh/blog/admin/pgss/pgss-16.png"></p>
<blockquote>
<p>按照主键查询单条记录，平均返回行数稳定为1</p>
</blockquote>
<p>查询平均访问的数据量通常与平均返回的行数相匹配，如果你的查询平均只返回了几行，却访问了成M上G的数据块，那你就需要特别注意了：这样的查询对于数据冷热状态非常敏感，如果所有的块都在缓冲区中，它的性能可能还说的过去，但如果从磁盘冷启动，执行时间可能会出现戏剧性的变化。</p>
<p>当然，不要忘记 PostgreSQL 双缓存问题，所谓“读取”的数据可能已经在操作系统文件系统层面被缓存过一次了。所以你需要与操作系统监控指标，或者 pg_stat_kcache ，pg_stat_io 这些系统视图相互参照进行分析。</p>
<p>另一种值得关注的模式是此指标的突变，这通常意味着该查询组的<strong>执行计划可能出现了翻转/劣化</strong>，非常值得关注与进一步研究。</p>
<p><strong>平均WAL日志量</strong></p>
<p>当 M 是 wal_bytes 时，我们得到了每条查询平均生成 WAL 的大小，这是 PostgreSQL 13 新引入的字段。这个指标可以衡量查询的变更足迹大小，并计算读写比例等重要评估参数。</p>
<p><img alt="pgss-17.png" src="/zh/blog/admin/pgss/pgss-17.png"></p>
<blockquote>
<p>稳定的QPS却有着周期性WAL波动，可推断是 FPI 的影响</p>
</blockquote>
<p>另一个用途是优化检查点/Checkpoint：如果你观察到此指标周期性的起伏（周期约等于 checkpoint_timeout），那么可以通过调整检查点间距，来优化查询产生 WAL 的数量。</p>
<p><strong>对调用次数进行微分的指标 dM/dc</strong>，可以展现出一类查询的工作负载特性，对于优化用户体验来说非常有用。特别是 RT 乃是性能优化的黄金指标，怎样强调其重要性都不为过。</p>
<p><strong>dM/dc</strong> 这样的指标为我们提供类似重要的绝对值指标，但如果想要找出哪些查询的优化潜在收益最大，还需要用到 <strong>%M 百分比指标</strong>。</p>
<hr>
<h2 id="百分比指标">百分比指标</h2>
<p>现在我们来研究第三类指标，<strong>百分比指标</strong>。即某个查询组相对于整体工作负载所占的比例。</p>
<p><strong>百分比指标 M%</strong> 为我们提供了某个查询组相对于整体工作负载的比例，帮助我们在频次、时间、I/O时间/次数上时识别出“主要参与者”，找出潜在优化收益最大的候选查询组，作为优先级评定的重要依据。</p>
<p><img alt="pgss-18.png" src="/zh/blog/admin/pgss/pgss-18.png"></p>
<p>常用百分比指标 %M 一览</p>
<p>举个例子，如果某个查询组有 1000 QPS  的绝对值，看上去不少；但如果它只占整个工作负载的 3%，那么优化此查询的收益与优先级就没那么高了；反之，如果它占据了整个工作负载的 50% 还要多 —— 如果你有办法把它优化掉就可以砍掉整个实例吞吐量的半壁江山，优化它的优先级就会非常之高。</p>
<p>常见的优化策略是这样的：首先把所有查询组分别按照上面提到的重要指标：calls，total_exec_time，rows，wal_bytes，shared_blks_hit + shared_blks_read，以及 blk_read_time + blk_write_time 在一段时间内的 <strong>dM/dt</strong> 值进行排序取 TopN （比如 N=10 或者更多），加入优化候选列表中。</p>
<p><img alt="pgss-19.png" src="/zh/blog/admin/pgss/pgss-19.png"></p>
<blockquote>
<p>按照特定标准，选取待优化的 TopSQL</p>
</blockquote>
<p>然后，对于优化候选列表中的每个查询组，依次分析其 <strong>dM/dc</strong> 指标，结合具体的查询语句与慢查询日志/等待事件进行分析，决定这是不是一个值得优化的查询。对于决定（Plan）进行优化的查询，就可以使用后续篇 <strong>“微观优化”</strong> 将要介绍的技巧进行调优（Do），并使用监控系统评估优化的效果（Check），总结分析后进入下一个 PDCA 戴明循环，持续进行管理优化。</p>
<p>除了对指标取 TopN 之外，还可以使用可视化的方式。可视化非常有助于从工作负载中识别 “主要贡献者”，复杂的判断算法可能还远比不上人类DBA对监控图形模式的直觉。想要形成比例感，我们可以借助饼图，树图或者堆叠的时序图。</p>
<p><img alt="pgss-20.png" src="/zh/blog/admin/pgss/pgss-20.png"></p>
<p>将所有查询组的 QPS 进行堆叠</p>
<p>例如，我们可以使用饼图来标识过去1小时内耗时/IO使用最大的查询，使用二维树图（大小代表总耗时，颜色代表平均RT）来展示一个额外的维度。并用堆叠时序图来展示比例随时间的变化关系。</p>
<p>我们也可以直接分析当下的 PGSS 快照，按照不同的关注点进行排序，按照您自己的标准选择有待优化的查询即可。</p>
<p><img alt="pgss-21.png" src="/zh/blog/admin/pgss/pgss-21.png"></p>
<p>I/O 耗时对于分析查询毛刺原因很有帮助</p>
<hr>
<h2 id="总结">总结</h2>
<p>最后，让我们对上面的内容做一个总结。</p>
<p>PGSS提供了丰富的指标，其中最重要的累积指标可以使用三种方式进行加工处理：</p>
<p><strong>dM/dt</strong> ：指标 M 基于时间的微分，揭示了<strong>每秒资源使用量</strong>，通常用于减少资源消耗的优化目标。</p>
<p><strong>dM/dc</strong>：指标 M 基于调用次数的微分，揭示了<strong>每次调用的资源使用量</strong>，通常用于改善用户体验的优化目标。</p>
<p><strong>%M</strong> ：百分比指标展示了查询组在整个工作负载中所占的百分比，通常用于平衡工作负载的优化目标。</p>
<p>通常，我们会根据 <strong>%M</strong> ：百分比指标 Top 查询选择高价值的备选优化查询，并使用 <strong>dM/dt *<em>dM/dc*</em></strong> 指标进行进一步的评估，确认是否有优化空间和可行性，并评估优化后的效果。如此往复，不断循环。</p>
<p>理解了宏观优化的方法论后，我们就可以用这样的方法去定位优化慢查询了。这里给出了一个具体的 《 <a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247484478&idx=1&sn=ea44675df79b60a12273e78b358bb557&chksm=fe4b31e5c93cb8f325ba1e4389874112bd5441280492c87e259a32aa67e00c7e0028e7dc51eb&scene=21#wechat_redirect">利用监控系统诊断PG慢查询</a>》的例子。在下一篇中，我们将介绍关于 PostgreSQL查询 <strong>微观优化</strong> 的经验技巧。</p>
<hr>
<h2 id="参考">参考</h2>
<p><code>[1]</code> <a href="https://gitlab.com/postgres-ai/postgresql-consulting/postgres-howtos/">PostgreSQL HowTO: pg_stat_statements</a> by Nikolay Samokhvalov</p>
<p><code>[2]</code> <a href="https://www.postgresql.org/docs/current/pgstatstatements.html">pg_stat_statements</a></p>
<p><code>[3]</code> <a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247484478&idx=1&sn=ea44675df79b60a12273e78b358bb557&chksm=fe4b31e5c93cb8f325ba1e4389874112bd5441280492c87e259a32aa67e00c7e0028e7dc51eb&scene=21#wechat_redirect">利用监控系统诊断PG慢查询</a></p>
<p><code>[4]</code> <a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486169&idx=1&sn=697ab3c172fe6cc28e12cff7297bb343&chksm=fe4b3f02c93cb614bbd1d5075120e074cebb5214d3a1a516363582bcee294e02bf5fd0e051ee&scene=21#wechat_redirect">如何用Pigsty监控现有PostgreSQL (RDS/PolarDB/自建)？</a></p>
<p><code>[5]</code> <a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486283&idx=1&sn=4b63f438df33291a3deb1052bea31347&chksm=fe4b3e90c93cb786a54407a4f7e552b2c8b28478b28df852e41f5d9e2c991761dddbc9a5a813&scene=21#wechat_redirect">Pigsty v2.5 发布：Ubuntu/Debian支持与监控改版/新扩展</a></p>
<p><code>[6]</code> <a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247484189&idx=1&sn=19d4381c7ec4bc4498bd56c5ee9f916b&chksm=fe4b36c6c93cbfd06fba1c7a1ad3c5cba8d0060f82acb56e96f0e64694f79c2df9299f0b1115&scene=21#wechat_redirect">PostgreSQL监控系统Pigsty概述</a></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-84becda4486f629dfc08aa6043d6355d">如何用 pg_filedump 抢救数据？</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>） | <a href="https://mp.weixin.qq.com/s/jmlzhktasg06MiA7b4huew">微信公众号</a></b> |
        
		<time datetime="2023-09-27" class="text-muted">2023年09月27日</time>
        
	</div>
	<p><img src="/zh/blog/admin/pg-filedump/featured.jpg"></p>
<blockquote>
<p>备份是DBA的生命线 —— 但如果你的 PostgreSQL 数据库已经爆炸了又没有备份，那么该怎么办呢？也许 pg_filedump 可以帮到你！</p>
</blockquote>
<p>最近遇到了一个比较离谱的活儿，情况是这样的：有个用户的 PostgreSQL 数据库损坏了，是 Gitlab 自己拉起的 PostgreSQL。没有从库，没有备份，也没有 dump。跑在拿 SSD 当透明缓存的BCACHE上，断电后起不来了。</p>
<p>但这还没完，接连经受了几轮摧残之后，它彻底歇菜了：首先是因为忘了挂BCACHE盘，导致 Gitlab重新初始化了一遍新的数据库集群；然后是因为各种原因隔离失效，在同一个集簇目录上运行两个数据库进程烤糊了数据目录；接着是运行 <code>pg_resetwal</code> 不带参数把数据库推回起源点，最后是让空数据库跑了一阵子，然后把烤糊前的临时备份移除了。</p>
<p>看到这个 Case 我确实有点无语：这都成一团浆糊了还恢复个什么，目测只能从底层二进制文件直接抽取数据来恢复了。我建议他去找个数据恢复公司碰碰运气吧，也帮忙问了一圈儿，但是一大堆数据恢复公司里，几乎没有几个有 PostgreSQL 数据恢复服务的，有的也是比较基础的那种问题处理，碰上这种情况都说只能随缘试试。</p>
<p>数据恢复报价通常是按文件数量来收费的，一个文件从 ¥1000 ～ ¥5000 不等。Gitlab库里几千个文件，按表算的话大概有 1000张表，全恢复完几十万可能不至于，但十几万肯定是没跑了。可一天过去了也没人接，这着实让我感觉蛋疼：要是没人能接这活，岂不是显得 PG 社区没人了？</p>
<p>我想了一下，这活看着挺蛋疼，但也挺有挑战趣味的，咱死马当活马医，修不好不收钱就是 —— 不试试咋知道行不行呢？所以就接了自己上了。</p>
<hr>
<h2 id="工具">工具</h2>
<p>工欲善其事，必先利其器。数据恢复首先当然是要找有没有趁手的工具：<code>pg_filedump</code> 就是一把不错的武器，它可以用来从 PostgreSQL 数据页面中抽取原始二进制数据，许多低层次的工作可以交给它。</p>
<p>这个工具可以用 <code>make</code> 三板斧编译安装，当然需要先安装对应大版本的 PostgreSQL 才行。Gitlab 默认使用的是 PG 13，所以确保对应版本的 <code>pg_config</code> 在路径中后直接编译即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/df7cb/pg_filedump
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> pg_filedump <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> make <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo make install
</span></span></code></pre></div><p><code>pg_filedump</code> 的使用方式并不复杂，你把数据文件喂给他，告诉它这张表每一列的类型，它就能帮你解读出来。比如第一步，我们就得知道这个数据库集簇中有哪几个数据库。这个信息记录在系统视图 <code>pg_database</code> 中。这是一张系统层面的表，位于 <code>global</code> 目录中，在集群初始化时会分配固定的 OID <code>1262</code>，所以对应的物理文件通常是： <code>global/1262</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># select &#39;pg_database&#39;::RegClass::OID;</span>
</span></span><span style="display:flex;"><span> oid
</span></span><span style="display:flex;"><span>------
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">1262</span>
</span></span></code></pre></div><p>这张系统视图里有不少字段，但我们主要关心的是前两个： <code>oid</code> 和 <code>datname</code> ，<code>datname</code> 是数据库的名称，<code>oid</code> 则可以用于定位数据库目录位置。以用 <code>pg_filedump</code> 把这张表解出来看一看， <code>-D</code> 参数可以告诉 <code>pg_filedump</code> 如何解释这张表里每一行的二进制数据。你可以指定每个字段的类型，用逗号分隔，<code>~</code> 表示后面的部分都忽略不要。</p>
<p><img alt="pg-filedump-1.png" src="/img/blog/pg/pg-filedump-1.png"></p>
<p>可以看到，每一行数据都以 <code>COPY</code> 开始，这里我们发现了目标数据库 <code>gitlabhq_production</code>，其 OID 为 <strong>16386</strong> 。所以这个数据库内的所有文件都应当位于 <code>base/16386</code> 子目录中。</p>
<hr>
<h2 id="恢复数据字典">恢复数据字典</h2>
<p>知道了要恢复的数据文件目录，下一步就是解出数据字典来，这里面有四张重要的表需要关注：</p>
<p>•<strong><code>pg_class</code></strong>：包含了所有表的重要元数据•<code>pg_namespace</code>：包含了模式的元数据•<code>pg_attribute</code>：包含了所有的列定义•<code>pg_type</code>：包含了类型的名称</p>
<p>其中 <strong><code>pg_class</code></strong> 是最为重要，不可或缺的一张表。其他几张系统视图属于 Nice to have：能让我们的工作更加简单一些。所以，我们首先尝试恢复这张表。</p>
<p><code>pg_class</code> 是数据库级别的系统视图，默认有着 OID = <code>1259</code> ，所以 <code>pg_class</code> 对应的文件应当是： <code>base/16386/1259</code>，在 <code>gitlabhq_production</code> 对应数据库目录下。</p>
<p><img alt="pg-filedump-2.png" src="/img/blog/pg/pg-filedump-2.png"></p>
<p>这里说句题外话：熟悉 PostgreSQL 原理的朋友知道：实际底层存储数据的文件名（RelFileNode）虽然默认与表的 OID 保持一致，但是一些操作可能会改变这一点，在这种情况下，你可以用 <code>pg_filedump -m pg_filenode.map</code> 解析数据库目录下的映射文件，找到 OID 1259 对应的 Filenode。当然这里两者是一致的，就表过不提了。</p>
<p>我们根据 <code>pg_class</code> 的表结构定义（注意要使用对应PG大版本的表结构），解析其二进制文件： pg_filedump -D &lsquo;oid,name,oid,oid,oid,oid,oid,oid,oid,int,real,int,oid,bool,bool,char,char,smallint,smallint,bool,bool,bool,bool,bool,bool,char,bool,oid,xid,xid,text,text,text&rsquo; -i base/16386/1259</p>
<p>然后就可以看到解析出来的数据了。这里的数据是 <code>\t</code> 分隔的单行记录，与 PostgreSQL COPY 命令默认使用的格式相同。所以你可以用脚本 <code>grep</code> 收集过滤，掐掉每行开头的 <code>COPY</code> ，并重新灌入一张真正的数据库表来细看。</p>
<p><img alt="pg-filedump-3.png" src="/img/blog/pg/pg-filedump-3.png"></p>
<p>在数据恢复时需要注意许多细节，其中第一条就是：你需要处理<strong>被删除</strong>的行。怎么识别呢？使用 <code>-i</code> 参数打印每一行的元数据，元数据里有一个 <code>XMAX</code> 字段。如果某一行元组被某个事务删除了，那么这条记录的 <code>XMAX</code> 就会被设置为该事务的 XID 事务号。所以如果某一行的 <code>XMAX</code> 不是零，就意味着这是一条被删除的记录，不应当输出到最终的结果中。</p>
<p><img alt="pg-filedump-4.png" src="/img/blog/pg/pg-filedump-4.png"></p>
<p><strong>这里的 XMAX 代表这是条被删除的记录</strong></p>
<p>有了 <code>pg_class</code> 数据字典之后，你就可以清楚地找到其他表，包括系统视图的 OID 对应关系了。用同样的办法可以恢复 <code>pg_namespace</code> ，<code>pg_attribute</code> ，<code>pg_type</code> 这三张表。有了这四张表就可以干什么呢？</p>
<p><img alt="pg-filedump-5.png" src="/img/blog/pg/pg-filedump-5.png"></p>
<p>你可以用 SQL 生成每张表的输入路径，自动拼出每一列的类型作为 <code>-D</code> 参数，生成临时结果表的 Schema。总而言之，可以用编程自动化的方式，自动生成所有需要完成的任务。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">attrs</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fields</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">has_tough_type</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toast_page</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toast_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toast_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltoastrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#204a87;font-weight:bold">toast</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toast_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">toast</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toast_page</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;data/base/16386/&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relfilenode</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">TEXT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#204a87;font-weight:bold">LEFT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_namespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LATERAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltoastrelid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">toast</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relkind</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;r&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2200</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">35507</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">35508</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">LATERAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string_agg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;,&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">attrs</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#000">string_agg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">std_type</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;,&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fields</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">has_tough_type</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">BOOLEAN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">has_tough_type</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_columns</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">columns</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这里需要注意，<code>pg_filedump -D</code> 参数支持的数据类型名称是有严格限定的标准名称的，所以你必须把 <code>boolean</code> 转为 <code>bool</code>，<code>INTEGER</code> 转为 <code>int</code>。如果你想解析的数据类型不在下面这个列表中，可以首先尝试使用 <code>TEXT</code> 类型，例如表示IP地址的 INET 类型就可以用 <code>TEXT</code> 的方式解析。</p>
<p>bigint bigserial bool char charN date float float4 float8 int json macaddr name numeric oid real serial smallint smallserial text time timestamp timestamptz timetz uuid varchar varcharN xid xml</p>
<p>但确实会有其他的一些特殊情况需要额外的处理，比如 PostgreSQL 中的 <code>ARRAY</code> 数组类型，后面会详细介绍。</p>
<h2 id="恢复一张普通表">恢复一张普通表</h2>
<p>恢复普通数据表和恢复一张系统目录表并没有本质区别：只不过 Catalog 的模式和信息都是公开的标准化的，而待恢复的数据库模式则不一定。</p>
<p>Gitlab 也属于一个开源的很有知名度的软件，所以找到它的数据库模式定义并不是一件难事。如果是一个普通的业务系统，那么多费点功夫也可以从 <code>pg_catalog</code> 中还原出原始 DDL 。</p>
<p>知道了 DDL 定义，我们就可以使用 DDL 中每一列的数据类型，来解释二进制文件中的数据了。下面，我们用 <code>public.approval_merge_request_rules</code> 这张 Gitlab 中的普通表为例，演示如何恢复这样一张普通数据表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">approval_project_rules</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">created_at</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">timestamp</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">with</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">time</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">zone</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">updated_at</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">timestamp</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">with</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">time</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">zone</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">project_id</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">approvals_required</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87">smallint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">rule_type</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#204a87">smallint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">scanners</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">[],</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">vulnerabilities_allowed</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87">smallint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">severity_levels</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">[],</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">report_type</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#204a87">smallint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">vulnerability_states</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">[],</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">orchestration_policy_idx</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">smallint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">applies_to_all_protected_branches</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87">boolean</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">security_orchestration_policy_configuration_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">scan_result_policy_id</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#204a87">bigint</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>首先，我们要将这里的类型转换成 <code>pg_filedump</code> 可以识别的类型，这里涉及到类型映射的问题：如果你有不确定的类型，比如上面的 <code>text[]</code> 字符串数组字段，就可以先用 <code>text</code> 类型占位替代，也可以直接用 <code>~</code> 忽略：</p>
<p>bigint,timestamptz,timestamptz,int,smallint,varchar,smallint,text,smallint,text,smallint,text,smallint,bool,bigint,bigint</p>
<p>当然这里有第一个知识点就是 PostgreSQL 的元组列布局是有顺序的，这个顺序保存在系统视图 <code>pg_attribute</code> 里面的 <code>attrnum</code> 中，而表中每一列的类型ID则保存在 <code>atttypid</code> 字段中，而为了获取类型的<strong>英文名称</strong>，你又需要通过类型ID引用 <code>pg_type</code> 系统视图（当然系统默认类型都有固定ID，也可以直接用ID映射）。综上，为了获取表中物理记录的解释方法，你至少需要用到上面提到的那四张系统字典表。</p>
<p>有了这张表上列的顺序与类型之后，并且知道这张表的二进制文件位置之后，你就可以利用这个信息翻译二进制数据了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg_filedump -i -f -D <span style="color:#4e9a06">&#39;bigint,...,bigint&#39;</span> <span style="color:#0000cf;font-weight:bold">38304</span>
</span></span></code></pre></div><p><img alt="pg-filedump-6.png" src="/img/blog/pg/pg-filedump-6.png"></p>
<p>输出时结果建议添加 <code>-i</code> 与 <code>-f</code> 选项，前者会打印每一行的<strong>元数据</strong>（需要根据 XMAX 判断这一行有没有被删除）；后者会打印原始二进制数据上下文（这一点对于处理 pg_filedump 解决不了的复杂数据是必要的）。</p>
<p>正常情况下，每一条记录都会以 <code>COPY:</code> 或 <code>Error:</code> 开头，前者代表提取成功，后者代表部分成功，或者失败。如果是失败，会有各种各样的原因，需要分别处理。对于成功的数据，你可以直接把它拿出来，每一行就是一条数据，用 <code>\t</code> 分隔，把 <code>\N</code> 替换为 NULL，处理好写入到临时表中保存待用即可。</p>
<p>当然魔鬼其实都在细节里，要是数据恢复真这么容易就好了。</p>
<hr>
<h2 id="魔鬼在细节中">魔鬼在细节中</h2>
<p>在处理数据数据恢复时，有许多小细节需要关注，这里我提几个重要的点。</p>
<p>首先是 <strong>TOAST</strong> 字段的处理。TOAST 是“ The Oversized-Attribute Storage Technique ”的缩写，即<strong>超标属性存储技术</strong>。如果你发现解析出来的字段内容是 <code>(TOASTED)</code>，那就说明这个字段因为太长，被切片转移到另外一张专用的表 —— TOAST 表中了。</p>
<p>如果某张表里有可能 TOAST 的字段，它就会有一张对应的 TOAST 表，在 <code>pg_class</code> 中用 <code>reltoastrelid</code> 标识其 OID。TOAST 其实也可以看做一张普通的表来处理，所以你可以用一样的方法把 TOAST 数据解析出来，拼接回去，再填入到原表中，这里就不展开了。</p>
<p><img alt="pg-filedump-7.png" src="/img/blog/pg/pg-filedump-7.png"></p>
<p>第二个问题<strong>是复杂类型</strong>，正如上一节所说， <code>pg_filedump</code> README里列出了支持的类型，但类似数组这样的类型就需要进行额外的二进制解析处理了。</p>
<p>举个例子，当你转储数组二进制时，看到的结果可能是一串儿 <code>\0\0</code> 。这是因为 <code>pg_filedump</code> 直接把处理不了的复杂类型给吐出来了。当然这里就会带来一些额外的问题 —— 字符串里的零值会让你的插入报错，所以你的解析脚本需要处理好这种问题，当遇到一个解析错误的复杂列时，应该先做个标记占个坑，把二进制值现场给保留下来，留给后面的步骤去具体处理。</p>
<p>这里我们来看个具体的例子：还是以上面 <code>public.approval_merge_request_rules</code> 表为例。我们可以从吐出来的数据，二进制视图，以及 ASCII 视图里面看到一些零星的字符串：<code>critical</code>，<code>unknown</code> 之类的东西，掺杂在一串 <code>\0</code> 与二进制控制字符中。没错，这就是一个字符串数组的二进制表示。PostgreSQL 中的数组允许任意类型任意深度的嵌套，所以这里的数据结构会有一点点复杂。</p>
<p><img alt="pg-filedump-8.png" src="/img/blog/pg/pg-filedump-8.png"></p>
<p>例如，图片中标色的地方对应的数据是一个包含三个字符串的数组：<code>{unknown,high,critical}::TEXT[]</code> 。01 代表这是一个一位数组，紧跟着空值位图，以及代表数组元素的类型OID 的 0x00000019 ，<code>0x19</code> 十进制值为 25 对应 <code>pg_type</code> 中的 <code>text</code>类型，说明这里是一个字符串数组（如果是 <code>0x17</code> 则说明是整型数组）。紧接着是这个数组第一维的维度 0x03，因为这个数组只有一维，三个元素；接下来的 1 告诉我们数组第一维度的起始偏移量在哪儿。再后面才是挨着的三个字符串结构了：由4字节的长度打头（要右移两位处理标记未），接着才是字符串内容，还要考虑布局对齐与填充的问题。</p>
<p>总的来说，你需要对照着源代码实现去挖掘，而这里有无穷无尽的细节：可变长度，空值位图，字段压缩，线外存储，以及大小端序，稍有不慎，你解出来的东西就是一团没用的浆糊。</p>
<p>你可以选择直接用 Python 脚本去记录的上下文中解析原始二进制回补数据，或者在 pg_filedump 源代码中注册新的类型与回调处理函数，复用 PG 提供的 C 解析函数，无论哪一种都称不上是轻松。</p>
<p>好在 PostgreSQL 本身已经提供了一些C语言的辅助函数 &amp; 宏可以帮助你完成大部分工作，而且幸运的是 Gitlab 中的数组都是一维数组，类型也仅限于整型数组与字符串数组，其他带复杂类型的数据页也可以从其他表中重建，所以总体工作量还是可以接受的 。</p>
<p><img alt="pg-filedump-9.png" src="/img/blog/pg/pg-filedump-9.png"></p>
<hr>
<h2 id="后记">后记</h2>
<p>这个活儿折腾了我两天，掏粪细节就不展开了，我估计读者也不会感兴趣。总之经过了一系列处理，校正，补对之后，数据恢复的工作终于完成了！除了有几张表里有几条损坏的数据之外，其他的数据都成功解出来了。好家伙，整整一千张表啊！</p>
<p>我以前也弄过一些数据恢复的活儿，大多数情况都还比较简单，数据坏块儿，控制文件/CLOG损坏，或者是被挖矿病毒种了勒索木马（往Tablespace里写了几个垃圾文件），但炸的这么彻底的Case我还是第一次弄。之所以敢接这个活，也是因为我对PG内核还是有些了解的，知道这些繁琐的实现细节。只要你知道这是一个工程上可解的问题，那么即使过程再脏再累也不会担心完不成。</p>
<p>尽管有些缺陷，但 <code>pg_filedump</code> 还是一个不错的工具，后面我可能会考虑完善一下它，让它对各种数据类型都有完整的支持，这样就不用再自己写一堆 Python 小脚本来处理各种繁琐的细节了。在弄完这个案例后，我已经把  <code>pg_filedump</code> 打好了 PG 12 - 16 x EL 7 - 9 上的 RPM 包放在 Pigsty 的 Yum源中，默认收录在 Pigsty 离线软件包里，目前已经在 <a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486215&idx=1&sn=52ce37a537336a6d07448f35c7bc4cfd&chksm=fe4b3edcc93cb7ca2dc87602430c2beb09ae5e7dcb568158541a1bd026e305d69d94cea81da4&scene=21#wechat_redirect">Pigsty v2.4.1 中实装交付</a>了。我衷心希望您永远也用不上这个扩展，但如果你真的碰上需要它的场景时，我也希望它就在你的手边可以开箱即用。</p>
<p>最后我还是想说一句，许多软件都需要数据库，但数据库的安装部署维护是一件很有门槛的活儿。Gitlab 拉起的 PostgreSQL 质量已经算是相当不错的了，但面对这种情况依然束手无策，更不用提那些土法手造 docker 镜像的简陋单机实例了。一场大故障，就能让一个企业积累的代码数据、CI/CD流程、Issue/PR/MR 记录灰飞烟灭。我真的建议您好好检视一下自己的数据库系统，至少请定期做个备份吧！</p>
<p><img alt="pg-filedump-10.png" src="/img/blog/pg/pg-filedump-10.png"></p>
<p>Gitlab 的企业版和社区版的核心区别就在于它底下的 PG 有没有高可用和监控。而<a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486135&idx=1&sn=7d9c4920e94efba5d0e0b6af467f596c&chksm=fe4b3f6cc93cb67ac570d5280b37328aed392598b13df88545ff0a06f99630801fc999db8de5&scene=21#wechat_redirect"><strong>开箱即用的 PostgreSQL 发行版 —— Pigsty</strong></a> 也可以为您更好地解决这些问题，却完全开源免费，分文不取：无论是高可用，PITR，还是监控系统一应俱全：下次再遇到这种问题时，就可以自动切换/一键回滚，游刃有余得多。之前我们自己的 Gitlab, Jira, Confluence 等软件都跑在上面，如果您有类似需求，倒是不妨试一下哦。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-2377d45fe5a041b3e08890413b2432b6">PG中的本地化排序规则</h1>
	<div class="lead">什么？不知道COLLATTION是什么，那记住一件事，用C COLLATE准没错！</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2021-03-05" class="text-muted">2021年03月05日</time>
        
	</div>
	<p>为什么Pigsty在初始化Postgres数据库时默认指定了<code>locale=C</code>与<code>encoding=UTF8</code></p>
<p>答案其实很简单，<strong>除非真的明确知道自己会用到LOCALE相关功能，否则就根本不应该配置<code>C.UTF8</code>之外的任何字符编码与本地化排序规则选项</strong>。特别是`</p>
<p>关于<a href="/zh/blog/db/character-encoding/"><strong>字符编码</strong></a>的部分，之前写过一篇文章专门介绍，这里表过不提。今天专门说一下<strong>LOCALE</strong>（本地化）的配置问题。</p>
<p>如果说服务端字符编码配置因为某些原因配置为<code>UTF8</code>之外的值也许还情有可原，那么<code>LOCALE</code>配置为<code>C</code>之外的任何选就是<strong>无可救药</strong>了。因为对于PostgreSQL来说，LOCALE不仅仅是控制日期和钱怎么显示这一类无伤大雅的东西，而是会影响到某些关键功能的使用。</p>
<p>错误的LOCALE配置可能导致<strong>几倍到十几倍的性能损失</strong>，还会导致<code>LIKE</code>查询无法在普通索引上使用。而设置<code>LOCALE=C</code>一点也不会影响真正需要本地化规则的使用场景。所以官方文档给出的指导是：“如果你真正需要LOCALE，才去使用它”。</p>
<p>不幸的是，在PostgreSQL<code>locale</code>与<code>encoding</code>的默认配置取决于操作系统的配置，因此<code>C.UTF8</code>可能并不是默认的配置，这就导致了很多人误用LOCALE而不自知，白白折损了大量性能，也导致了某些数据库特性无法正常使用。</p>
<p><img src="/zh/blog/admin/collate/featured.webp"></p>
<hr>
<h2 id="太长不看">太长；不看</h2>
<ul>
<li>强制使用<code>UTF8</code>字符编码，强制数据库使用<code>C</code>的本地化规则。</li>
<li>使用非C本地化规则，可能导致涉及字符串比较的操作开销增大几倍到几十倍，<strong>对性能产生显著负面影响</strong></li>
<li>使用非C本地化规则，会导致<code>LIKE</code>查询无法使用普通索引，容易踩坑雪崩。</li>
<li>使用非C本地化规则的实例，可以通过<code>text_ops COLLATE &quot;C&quot;</code>或<code>text_pattern_ops</code>建立索引，支持<code>LIKE</code>查询。</li>
</ul>
<hr>
<h2 id="locale是什么">LOCALE是什么</h2>
<p>我们经常能在操作系统和各种软件中看到 <strong><code>LOCALE</code>（区域）</strong> 的相关配置，但LOCALE到底是什么呢？</p>
<p><strong>LOCALE</strong>支持指的是应用遵守文化偏好的问题，包括字母表、<strong>排序</strong>、数字格式等。LOCALE由很多规则与定义组成，包括：</p>
<table>
<thead>
<tr>
<th><code>LC_COLLATE</code></th>
<th>字符串排序顺序</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LC_CTYPE</code></td>
<td>字符分类（什么是一个字符？它的大写形式是否等效？）</td>
</tr>
<tr>
<td><code>LC_MESSAGES</code></td>
<td>消息使用的语言Language of messages</td>
</tr>
<tr>
<td><code>LC_MONETARY</code></td>
<td>货币数量使用的格式</td>
</tr>
<tr>
<td><code>LC_NUMERIC</code></td>
<td>数字的格式</td>
</tr>
<tr>
<td><code>LC_TIME</code></td>
<td>日期和时间的格式</td>
</tr>
<tr>
<td>……</td>
<td>其他……</td>
</tr>
</tbody>
</table>
<p>一个LOCALE就是一组规则，LOCALE通常会用语言代码 + 国家代码的方式来命名。例如中国大陆使用的LOCALE <code>zh_CN</code>就分为两个部分：<code>zh</code>是 语言代码，<code>CN</code> 是国家代码。现实世界中，一种语言可能有多个国家在用，一个国家内也可能存在多种语言。还是以中文和中国为例：</p>
<p>中国（<code>COUNTRY=CN</code>）相关的语言<code>LOCALE</code>有：</p>
<ul>
<li><code>zh</code>：汉语：<code>zh_CN</code></li>
<li><code>bo</code>：藏语：<code>bo_CN</code></li>
<li><code>ug</code>：维语：<code>ug_CN</code></li>
</ul>
<p>讲中文（<code>LANG=zh</code>）的国家或地区相关的<code>LOCAL</code>有：</p>
<ul>
<li><code>CN</code> 中国：<code>zh_CN</code></li>
<li><code>HK</code> 香港：<code>zh_HK</code></li>
<li><code>MO</code> 澳门：<code>zh_MO</code></li>
<li><code>TW</code> 台湾：<code>zh_TW</code></li>
<li><code>SG</code> 新加坡：<code>zh_SG</code></li>
</ul>
<hr>
<h2 id="locale的例子">LOCALE的例子</h2>
<p>我们可以参考一个典型的Locale定义文件：Glibc提供的 <a href="https://lh.2xlibre.net/locale/zh_CN/glibc/">zh_CN</a></p>
<p>这里截取一小部分展示，看上去好像都是些鸡零狗碎的格式定义，月份星期怎么叫啊，钱和小数点怎么显示啊之类的东西。</p>
<p>但这里有一个非常关键的东西，叫做<code>LC_COLLATE</code>，即<strong>排序方式（Collation）</strong>，会对数据库行为有显著影响。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">LC_CTYPE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">copy &#34;i18n&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">translit_start</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">include  &#34;translit_combining&#34;;&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">translit_end</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">class	&#34;hanzi&#34;; /</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">&lt;U4E00&gt;..&lt;U9FA5&gt;;/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">&lt;UF92C&gt;;&lt;UF979&gt;;&lt;UF995&gt;;&lt;UF9E7&gt;;&lt;UF9F1&gt;;&lt;UFA0C&gt;;&lt;UFA0D&gt;;&lt;UFA0E&gt;;/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">&lt;UFA0F&gt;;&lt;UFA11&gt;;&lt;UFA13&gt;;&lt;UFA14&gt;;&lt;UFA18&gt;;&lt;UFA1F&gt;;&lt;UFA20&gt;;&lt;UFA21&gt;;/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">&lt;UFA23&gt;;&lt;UFA24&gt;;&lt;UFA27&gt;;&lt;UFA28&gt;;&lt;UFA29&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">END LC_CTYPE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LC_COLLATE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">copy &#34;iso14651_t1_pinyin&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">END LC_COLLATE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LC_TIME</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">% 一月, 二月, 三月, 四月, 五月, 六月, 七月, 八月, 九月, 十月, 十一月, 十二月</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mon           &#34;&lt;U4E00&gt;&lt;U6708&gt;&#34;;/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#4e9a06">&#34;&lt;U4E8C&gt;&lt;U6708&gt;&#34;</span><span style="color:#000">;/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#4e9a06">&#34;&lt;U4E09&gt;&lt;U6708&gt;&#34;</span><span style="color:#000">;/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#4e9a06">&#34;&lt;U56DB&gt;&lt;U6708&gt;&#34;</span><span style="color:#000">;/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">% 星期日, 星期一, 星期二, 星期三, 星期四, 星期五, 星期六</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">day           &#34;&lt;U661F&gt;&lt;U671F&gt;&lt;U65E5&gt;&#34;;/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#4e9a06">&#34;&lt;U661F&gt;&lt;U671F&gt;&lt;U4E00&gt;&#34;</span><span style="color:#000">;/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#4e9a06">&#34;&lt;U661F&gt;&lt;U671F&gt;&lt;U4E8C&gt;&#34;</span><span style="color:#000">;/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">week          7;19971130;1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">first_weekday 2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">% %Y年%m月%d日 %A %H时%M分%S秒</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">d_t_fmt       &#34;%Y&lt;U5E74&gt;%m&lt;U6708&gt;%d&lt;U65E5&gt; %A %H&lt;U65F6&gt;%M&lt;U5206&gt;%S&lt;U79D2&gt;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">% %Y年%m月%d日</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">d_fmt         &#34;%Y&lt;U5E74&gt;%m&lt;U6708&gt;%d&lt;U65E5&gt;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">% %H时%M分%S秒</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">t_fmt         &#34;%H&lt;U65F6&gt;%M&lt;U5206&gt;%S&lt;U79D2&gt;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">% 上午, 下午</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">am_pm         &#34;&lt;U4E0A&gt;&lt;U5348&gt;&#34;;&#34;&lt;U4E0B&gt;&lt;U5348&gt;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">% %p %I时%M分%S秒</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">t_fmt_ampm    &#34;%p %I&lt;U65F6&gt;%M&lt;U5206&gt;%S&lt;U79D2&gt;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">% %Y年 %m月 %d日 %A %H:%M:%S %Z</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">date_fmt      &#34;%Y&lt;U5E74&gt; %m&lt;U6708&gt; %d&lt;U65E5&gt; %A %H:%M:%S %Z&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">END LC_TIME</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LC_NUMERIC</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">decimal_point &#34;.&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">thousands_sep &#34;,&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">grouping      3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">END LC_NUMERIC</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LC_MONETARY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">% ￥</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">currency_symbol    &#34;&lt;UFFE5&gt;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">int_curr_symbol    &#34;CNY &#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>比如<code>zh_CN</code>提供的<code>LC_COLLATE</code>使用了<code>iso14651_t1_pinyin</code>排序规则，这是一个<strong>基于拼音的排序规则</strong>。</p>
<p>下面通过一个例子来介绍LOCALE中的COLLATION如何影响Postgres的行为。</p>
<hr>
<h2 id="排序规则一例">排序规则一例</h2>
<p>创建一张包含7个汉字的表，然后执行排序操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">some_chinese</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">some_chinese</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;阿&#39;</span><span style="color:#000;font-weight:bold">),(</span><span style="color:#4e9a06">&#39;波&#39;</span><span style="color:#000;font-weight:bold">),(</span><span style="color:#4e9a06">&#39;磁&#39;</span><span style="color:#000;font-weight:bold">),(</span><span style="color:#4e9a06">&#39;得&#39;</span><span style="color:#000;font-weight:bold">),(</span><span style="color:#4e9a06">&#39;饿&#39;</span><span style="color:#000;font-weight:bold">),(</span><span style="color:#4e9a06">&#39;佛&#39;</span><span style="color:#000;font-weight:bold">),(</span><span style="color:#4e9a06">&#39;割&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">some_chinese</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>执行以下SQL，按照默认的<code>C</code>排序规则对表中的记录排序。可以看到，这里实际上是按照字符的<code>ascii|unicode</code> <a href="/zh/blog/db/character-encoding#%E7%BC%96%E7%A0%81%E5%AD%97%E7%AC%A6%E9%9B%86-ccs"><strong>码位</strong></a> 进行排序的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># SELECT name, ascii(name) FROM some_chinese ORDER BY name COLLATE &#34;C&#34;;</span>
</span></span><span style="display:flex;"><span> name <span style="color:#000;font-weight:bold">|</span> ascii
</span></span><span style="display:flex;"><span>------+-------
</span></span><span style="display:flex;"><span> 佛   <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">20315</span>
</span></span><span style="display:flex;"><span> 割   <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">21106</span>
</span></span><span style="display:flex;"><span> 得   <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">24471</span>
</span></span><span style="display:flex;"><span> 波   <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">27874</span>
</span></span><span style="display:flex;"><span> 磁   <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">30913</span>
</span></span><span style="display:flex;"><span> 阿   <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">38463</span>
</span></span><span style="display:flex;"><span> 饿   <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">39295</span>
</span></span></code></pre></div><p>但这样基于码位的排序对于中国人来说可能没有任何意义。例如新华字典在收录汉字时，就不会使用这种<strong>排序方式</strong>。而是采用<code>zh_CN</code> 所使用的 <strong>拼音排序</strong> 规则，按照拼音比大小。如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">some_chinese</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLLATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;zh_CN&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">阿</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">波</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">磁</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">得</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">饿</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">佛</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">割</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>可以看到，按照<code>zh_CN</code>排序规则排序得到的结果，就是拼音顺序<code>abcdefg</code>，而不再是不知所云的Unicode码位排序。</p>
<p>当然这个查询结果取决于<code>zh_CN</code> 排序规则的具体定义，像这样的排序规则并不是数据库本身定义的，数据库本身提供的排序规则就是<code>C</code>（或者其别名<code>POSIX</code>）。COLLATION的来源，通常要么是操作系统，要么是<code>glibc</code>，要么是第三方的本地化库（例如<code>icu</code>），所以可能因为不同的<strong>实质定义</strong>出现不同的效果。</p>
<h4 id="但代价是什么"><strong>但代价是什么？</strong></h4>
<p>PostgreSQL中使用非<code>C</code>或非<code>POSIX</code> LOCALE的最大负面影响是：</p>
<p><strong>特定排序规则对涉及字符串大小比较的操作有巨大的性能影响，同时它还会导致无法在<code>LIKE</code>查询子句中使用普通索引。</strong></p>
<p>另外，C LOCALE是由数据库本身确保在任何操作系统与平台上使用的，而其他的LOCALE则不然，所以使用非C Locale的可移植性更差。</p>
<hr>
<h2 id="性能损失">性能损失</h2>
<p>接下来让我们考虑一个使用LOCALE排序规则的例子， 我们有Apple Store 150万款应用的名称，现在希望按照不同的区域规则进行排序。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 创建一张应用名称表，里面有中文也有英文。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COPY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/tmp/app.csv&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 查看表上的统计信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">correlation</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 相关系数 0.03542578 基本随机分布
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">avg_width</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- 平均长度25字节
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">n_distinct</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">-- -1，意味着1508076个记录没有重复
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;app&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 使用不同的排序规则进行一系列的实验
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLLATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLLATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;en_US&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLLATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;zh_CN&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span></code></pre></div><p>相当令人震惊的结果，使用<code>C</code>和<code>zh_CN</code>的结果能相差<strong>十倍</strong>之多：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>场景</th>
<th>耗时(ms)</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>不排序</td>
<td>180</td>
<td>使用索引</td>
</tr>
<tr>
<td>2</td>
<td><code>order by name</code></td>
<td>969</td>
<td>使用索引</td>
</tr>
<tr>
<td>3</td>
<td><code>order by name COLLATE &quot;C&quot;</code></td>
<td>1430</td>
<td>顺序扫描，外部排序</td>
</tr>
<tr>
<td>4</td>
<td><code>order by name COLLATE &quot;en_US&quot;</code></td>
<td>10463</td>
<td>顺序扫描，外部排序</td>
</tr>
<tr>
<td>5</td>
<td><code>order by name COLLATE &quot;zh_CN&quot;</code></td>
<td>14852</td>
<td>顺序扫描，外部排序</td>
</tr>
</tbody>
</table>
<p>下面是实验5对应的详细执行计划，即使配置了足够大的内存，依然会溢出到磁盘执行外部排序。尽管如此，显式指定<code>LOCALE</code>的实验都出现了此情况，因此可以横向对比出C与<code>zh_CN</code>的性能差距来。</p>
<p><img src="/zh/blog/admin/collate/collation-plan.jpg"></p>
<p>另一个更有对比性的例子是<strong>比大小</strong>。</p>
<p>这里，表中的所有的字符串都会和<code>World</code>比一下大小，相当于在表上进行150万次特定规则比大小，而且也不涉及到磁盘IO。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;World&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;World&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLLATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;World&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLLATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;en_US&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;World&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLLATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;zh_CN&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>尽管如此，比起<code>C LOCALE</code>来，<code>zh_CN</code> 还是费了接近3倍的时长。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>场景</th>
<th>耗时(ms)</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>默认</td>
<td>120</td>
</tr>
<tr>
<td>2</td>
<td>C</td>
<td>145</td>
</tr>
<tr>
<td>3</td>
<td>en_US</td>
<td>351</td>
</tr>
<tr>
<td>4</td>
<td>zh_CN</td>
<td>441</td>
</tr>
</tbody>
</table>
<p>如果说排序可能是O(n2)次比较操作有10倍损耗 ，那么这里的O(n)次比较3倍开销也基本能对应上。我们可以得出一个初步的粗略结论：</p>
<p>比起<code>C</code> Locale来，使用<code>zh_CN</code>或其他Locale可能导致<strong>几倍</strong>的额外性能开销。</p>
<p>除此之外，错误的Locale不仅仅会带来性能损失，还会导致<strong>功能损失</strong>。</p>
<hr>
<h2 id="功能缺失">功能缺失</h2>
<p>除了性能表现糟糕外，另一个令人难以接受的问题是，使用非<code>C</code>的LOCALE，<strong>LIKE查询走不了普通索引</strong>。</p>
<p>还是以刚才的实验为例，我们分别在使用<code>C</code>和<code>en_US</code>作为默认LOCALE创建的数据库实例上执行以下查询：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;中国%&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>找出所有以“中国”两字开头的应用。</p>
<h4 id="在使用c的库上"><strong>在使用C的库上</strong></h4>
<p>该查询能正常使用<code>app_pkey</code>索引，利用主键B树的有序性加速查询，约2毫秒内执行完毕。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>postgres@meta:5432/meta<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># show lc_collate;</span>
</span></span><span style="display:flex;"><span> C
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>postgres@meta:5432/meta<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># EXPLAIN SELECT * FROM app WHERE name LIKE &#39;中国%&#39;;</span>
</span></span><span style="display:flex;"><span>                                 QUERY PLAN
</span></span><span style="display:flex;"><span>-----------------------------------------------------------------------------
</span></span><span style="display:flex;"><span> Index Only Scan using app_pkey on app  <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span>0.43..2.65 <span style="color:#000">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1510</span> <span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span>25<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   Index Cond: <span style="color:#ce5c00;font-weight:bold">((</span>name &gt;<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;中国&#39;</span>::text<span style="color:#ce5c00;font-weight:bold">)</span> AND <span style="color:#ce5c00;font-weight:bold">(</span>name &lt; <span style="color:#4e9a06">&#39;中图&#39;</span>::text<span style="color:#ce5c00;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>   Filter: <span style="color:#ce5c00;font-weight:bold">(</span>name ~~ <span style="color:#4e9a06">&#39;中国%&#39;</span>::text<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span> rows<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h4 id="在使用en_us的库上"><strong>在使用en_US的库上</strong></h4>
<p>我们发现，<strong>这个查询无法利用索引</strong>，走了全表扫描。查询劣化至70毫秒，性能恶化了三四十倍。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># show lc_collate;</span>
</span></span><span style="display:flex;"><span> en_US.UTF-8
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># EXPLAIN SELECT * FROM app WHERE name LIKE &#39;中国%&#39;;</span>
</span></span><span style="display:flex;"><span>                        QUERY PLAN
</span></span><span style="display:flex;"><span>----------------------------------------------------------
</span></span><span style="display:flex;"><span> Seq Scan on app  <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span>0.00..29454.95 <span style="color:#000">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">151</span> <span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span>25<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   Filter: <span style="color:#ce5c00;font-weight:bold">(</span>name ~~ <span style="color:#4e9a06">&#39;中国%&#39;</span>::text<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h4 id="为什么"><strong>为什么？</strong></h4>
<p>因为索引（B树索引）的构建，也是建立在<strong>序</strong>的基础上，也就是<strong>等值</strong>和<strong>比大小</strong>这两个操作。</p>
<p>然而，LOCALE关于字符串的等价规则有一套自己的定义，例如在Unicode标准中就定义了很多匪夷所思的等价规则（毕竟是万国语言，比如多个字符复合而成的字符串等价于另一个单体字符，详情参考 <strong>现代字符编码</strong> 一文）。</p>
<p>因此，<strong>只有最朴素的<code>C</code> LOCALE，才能够正常地进行模式匹配</strong>。C LOCALE的比较规则非常简单，就是挨个比较 <strong>字符</strong>码位，不玩那一套花里胡哨虚头巴脑的东西。所以，如果您的数据库不幸使用了非C的LOCALE，那么在执行<code>LIKE</code>查询时就没有办法使用默认的索引了。</p>
<h4 id="解决办法">解决办法</h4>
<p>对于非C LOCALE的实例，只有<strong>建立特殊类型的索引</strong>，才能支持此类查询：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLLATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">text_pattern_ops</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这里使用 <code>text_pattern_ops</code>运算符族来创建索引也可以用来支持<code>LIKE</code>查询，这是专门用于支持模式匹配的运算符族，从原理上讲它会<strong>无视</strong> LOCALE，直接基于 <strong>逐个字符</strong> 比较的方式执行模式匹配，也就是使用C LOCALE的方式。</p>
<p>因此在这种情况下，只有基于<code>text_pattern_ops</code>操作符族建立的索引，或者基于默认的<code>text_ops</code>但使用<code>COLLATE &quot;C&quot;'</code> 的索引，才可以用于支持<code>LIKE</code>查询。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ANALYZE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;中国%&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Only</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app_name_idx</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">43</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">45</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">151</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">actual</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">053</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">731</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2360</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">loops</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">~&gt;=~</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;中国&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">~&lt;~</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;中图&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">Filter</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">~~</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;中国%&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">text</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLLATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;en_US.UTF-8&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>建立完索引后，我们可以看到原来的<code>LIKE</code>查询<strong>可以</strong>走索引了。</p>
<p><code>LIKE</code>无法使用普通索引这个问题，看上去似乎可以通过额外创建一个<code>text_pattern_ops</code>索引来曲线解决。但这也意味着原本可以直接利用现成的<code>PRIMARY KEY</code>或<code>UNIQUE</code>约束自带索引解决的问题，现在需要额外的维护成本与存储空间。</p>
<p>对于不熟悉这一问题的开发者来说，很有可能因为错误的LOCALE配置，导致本地没问题的模式结果在线上因为没有走索引而雪崩。（例如本地使用C，但生产环境用了非C LOCALE）。</p>
<hr>
<h2 id="兼容性">兼容性</h2>
<p>假设您在接手时数据库已经使用了非<code>C</code>的LOCALE（这种事相当常见），现在您在知道了使用非C LOCALE的危害后，决定找个机会改回来。</p>
<p>那么有哪些地方需要注意呢？具体来讲，Locale的配置影响PostgreSQL以下功能：</p>
<ol>
<li>
<p>使用<code>LIKE</code>子句的查询。</p>
</li>
<li>
<p>任何依赖特定LOCALE排序规则的查询，例如依赖拼音排序作为结果排序依据。</p>
</li>
<li>
<p>使用<strong>大小写转换相关功能</strong>的查询，函数<code>upper</code>、<code>lower</code>和<code>initcap</code></p>
</li>
<li>
<p><code>to_char</code>函数家族，涉及到格式化为本地时间时。</p>
</li>
<li>
<p>正则表达式中的<strong>大小写不敏感匹配</strong>模式（<code>SIMILAR TO</code> ,<code>~</code>）。</p>
</li>
</ol>
<p>如果不放心，可以通过<code>pg_stat_statements</code>列出所有涉及到以下关键词的查询语句进行手工排查：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">LIKE</span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#204a87;font-weight:bold">ILIKE</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic">-- 是否使用了模式匹配
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SIMILAR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">regexp_xxx</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- 是否使用了 i 选项
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">upper</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">lower</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">initcap</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic">-- 是否针对其他带有大小写模式的语言使用（西欧字符之类）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">col</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic">-- 按文本类型列排序时，是否依赖特定排序规则？（例如按照拼音）
</span></span></span></code></pre></div><h3 id="兼容性修改">兼容性修改</h3>
<p>通常来说，C LOCALE在功能上是其他LOCALE配置的超集，总是可以从其他LOCALE切换为C。如果您的业务没有使用这些功能，通常什么都不需要做。如果使用本地化规则特性，则总是可以通过**显式指定<code>COLLATE</code>**的方式，在C LOCALE下实现相同的效果。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">upper</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLLATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;zh_CN&#34;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- 基于zh_CN规则执行大小写转换
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#4e9a06">&#39;阿&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;波&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic">-- false, 在默认排序规则下  阿(38463) &gt; 波(27874)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#4e9a06">&#39;阿&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;波&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLLATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;zh_CN&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- true, 显式使用中文拼音排序规则： 阿(a) &lt; 波(bo)
</span></span></span></code></pre></div><p>目前唯一已知的问题出现在扩展<code>pg_trgm</code>上。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-eddc668f26db53c6b78bd6f6dd86dc14">PG复制标识详解（Replica Identity）</h1>
	<div class="lead">复制标识很重要，它关系到逻辑复制的成败</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2021-03-03" class="text-muted">2021年03月03日</time>
        
	</div>
	<h2 id="引子土法逻辑复制">引子：土法逻辑复制</h2>
<p>复制身份的概念，服务于 <a href="/zh/blog/admin/logical-replication/"><strong>逻辑复制</strong></a>。</p>
<p>逻辑复制的基本工作原理是，将逻辑发布相关表上<strong>对行的增删改</strong>事件解码，复制到逻辑订阅者上执行。</p>
<p>逻辑复制的工作方式有点类似于行级触发器，在事务执行后对变更的元组逐行触发。</p>
<p>假设您需要自己通过触发器实现逻辑复制，将一章表A上的变更复制到另一张表B中。通常情况下，这个触发器的函数逻辑通常会长这样：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 通知触发器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replicate_change</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_OP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;INSERT&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- INSERT INTO tbl_b VALUES (NEW.col);
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ELSIF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_OP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;DELETE&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">-- DELETE tbl_b WHERE id = OLD.id;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ELSIF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_OP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;UPDATE&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">-- UPDATE tbl_b SET col = NEW.col,... WHERE id = OLD.id;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">plpgsql</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>触发器中会有两个变量<code>OLD</code>与<code>NEW</code>，分别包含了变更记录的旧值与新值。</p>
<ul>
<li><code>INSERT</code>操作只有<code>NEW</code>变量，因为它是新插入的，我们直接将其插入到另一张表即可。</li>
<li><code>DELETE</code>操作只有<code>OLD</code>变量，因为它只是删除已有记录，我们 <strong>根据ID</strong> 在目标表B上。</li>
<li><code>UPDATE</code>操作同时存在<code>OLD</code>变量与<code>NEW</code>变量，我们需要通过 <code>OLD.id</code> 定位目标表B中的记录，将其更新为新值<code>NEW</code>。</li>
</ul>
<p>这样的基于触发器的“逻辑复制”可以完美达到我们的目的，在逻辑复制中与之类似，表A上带有主键字段<code>id</code>。那么当我们删除表A上的记录时，例如：删除<code>id = 1</code>的记录时，我们只需要告诉订阅方<code>id = 1</code>，而不是把整个被删除的元组传递给订阅方。那么这里主键列<code>id</code>就是逻辑复制的<strong>复制标识</strong>。</p>
<p>但上面的例子中隐含着一个工作假设：表A和表B模式相同，上面有一个名为 <code>id</code> 的主键。</p>
<p>对于生产级的逻辑复制方案，即PostgreSQL 10.0后提供的逻辑复制，<strong>这样的工作假设是不合理的</strong>。因为系统无法要求用户建表时一定会带有主键，也无法要求主键的名字一定叫<code>id</code>。</p>
<p>于是，就有了 <strong>复制标识（Replica Identity）</strong> 的概念。复制标识是对<code>OLD.id</code>这样工作假设的进一步泛化与抽象，它用来告诉逻辑复制系统，<strong>哪些信息可以被用于唯一定位表中的一条记录</strong>。</p>
<h2 id="复制标识">复制标识</h2>
<p>对于逻辑复制而言，<code>INSERT</code> 事件不需要特殊处理，但要想将<code>DELETE|UPDATE</code>复制到订阅者上时，必须提供一种标识行的方式，即<strong>复制标识（Replica Identity）</strong>。复制标识是一组<strong>列的集合</strong>，这些列可以唯一标识一条记录。其实这样的定义在概念上来说就是<strong>构成主键的列集</strong>，当然非空唯一索引中的列集（<strong>候选键</strong>）也可以起到同样的效果。</p>
<p>一个被纳入逻辑复制 <strong>发布</strong>中的表，必须配置有 <strong>复制标识（Replica Identity）</strong>，只有这样才可以在<strong>订阅</strong>者一侧定位到需要更新的行，完成<code>UPDATE</code>与<code>DELETE</code>操作的复制。默认情况下，<strong>主键</strong> （Primary Key）和 <strong>非空列上的唯一索引</strong> （UNIQUE NOT NULL）可以用作复制标识。</p>
<p>注意，<strong>复制标识</strong> 和表上的主键、非空唯一索引并不是一回事。复制标识是<strong>表</strong>上的一个属性，它指明了在逻辑复制时，哪些信息会被用作身份定位标识符写入到逻辑复制的记录中，供订阅端定位并执行变更。</p>
<p>如PostgreSQL 13<a href="https://www.postgresql.org/docs/13/sql-altertable.html#replica_identity">官方文档</a>所述，表上的<strong>复制标识</strong> 共有4种配置模式，分别为：</p>
<ul>
<li>默认模式（default）：非系统表采用的默认模式，如果有主键，则用主键列作为身份标识，否则用完整模式。</li>
<li>索引模式（index）：将某一个符合条件的索引中的列，用作身份标识</li>
<li>完整模式（full）：将整行记录中的所有列作为复制标识（类似于整个表上每一列共同组成主键）</li>
<li>无身份模式（nothing）：不记录任何复制标识，这意味着<code>UPDATE|DELETE</code>操作无法复制到订阅者上。</li>
</ul>
<h3 id="复制标识查询">复制标识查询</h3>
<p>表上的<strong>复制标识</strong>可以通过查阅<code>pg_class.relreplident</code>获取。</p>
<p>这是一个字符类型的“枚举”，标识用于组装 “复制标识” 的列：<code>d</code> = default ，<code>f</code> = 所有的列，<code>i</code> 使用特定的索引，<code>n</code> 没有复制标识。</p>
<p>表上是否具有可用作复制标识的索引约束，可以通过以下查询获取：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">quote_ident</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">quote_ident</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">con</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ri</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relreplident</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;d&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;default&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;n&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;nothing&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;f&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;full&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;i&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;index&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica_identity</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_namespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LATERAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">array_agg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">contype</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ri</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_constraint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">conrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">con</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relkind</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;r&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pg_catalog&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;information_schema&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;repack&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pg_toast&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="复制标识配置">复制标识配置</h3>
<p>表到复制标识可以通过<code>ALTER TABLE</code>进行修改。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IDENTITY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOTHING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 具体有四种形式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_normal</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IDENTITY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#8f5902;font-style:italic">-- 使用主键，如果没有主键则为FULL
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_normal</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IDENTITY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FULL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#8f5902;font-style:italic">-- 使用整行作为标识
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_normal</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IDENTITY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_normal_v_key</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 使用唯一索引
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_normal</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IDENTITY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOTHING</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#8f5902;font-style:italic">-- 不设置复制标识
</span></span></span></code></pre></div><h2 id="复制标识实例">复制标识实例</h2>
<p>下面用一个具体的例子来说明复制标识的效果：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">primary</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">unique</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>现在有一个表<code>test</code>，上面有两列<code>k</code>和<code>v</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Alice&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;1&#39;</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Bob&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;2&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;3&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;Alice&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">-- update Alice value to 3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;Oscar&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;Bob&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- rename Bob to Oscaar
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DELETE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;Alice&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic">-- delete Alice
</span></span></span></code></pre></div><p>在这个例子中，我们对表<code>test</code>执行了增删改操作，与之对应的逻辑解码结果为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">table public.test: INSERT: k[text]:&#39;Alice&#39; v[integer]:1</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">table public.test: INSERT: k[text]:&#39;Bob&#39; v[integer]:2</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">table public.test: UPDATE: k[text]:&#39;Alice&#39; v[integer]:3</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">table public.test: UPDATE: old-key: k[text]:&#39;Bob&#39; new-tuple: k[text]:&#39;Oscar&#39; v[integer]:2</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">table public.test: DELETE: k[text]:&#39;Alice&#39;</span>
</span></span></code></pre></div><p>默认情况下，PostgreSQL会使用表的主键作为<strong>复制标识</strong>，因此在<code>UPDATE|DELETE</code>操作中，都通过<code>k</code>列来定位需要修改的记录。</p>
<p>如果我们手动修改表的复制标识，使用非空且唯一的列<code>v</code>作为复制标识，也是可以的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IDENTITY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_v_key</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 基于UNIQUE索引的复制身份
</span></span></span></code></pre></div><p>同样的变更现在产生如下的逻辑解码结果，这里<code>v</code>作为身份标识，出现在所有的<code>UPDATE|DELETE</code>事件中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">table public.test: INSERT: k[text]:&#39;Alice&#39; v[integer]:1</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">table public.test: INSERT: k[text]:&#39;Bob&#39; v[integer]:2</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">table public.test: UPDATE: old-key: v[integer]:1 new-tuple: k[text]:&#39;Alice&#39; v[integer]:3</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">table public.test: UPDATE: k[text]:&#39;Oscar&#39; v[integer]:2</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">table public.test: DELETE: v[integer]:3</span>
</span></span></code></pre></div><p>如果使用<strong>完整身份模式（full）</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IDENTITY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FULL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 表test现在使用所有列作为表的复制身份
</span></span></span></code></pre></div><p>这里，<code>k</code>和<code>v</code>同时作为身份标识，记录到<code>UPDATE|DELETE</code>的日志中。对于没有主键的表，这是一种保底方案。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">table public.test: INSERT: k[text]:&#39;Alice&#39; v[integer]:1</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">table public.test: INSERT: k[text]:&#39;Bob&#39; v[integer]:2</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">table public.test: UPDATE: old-key: k[text]:&#39;Alice&#39; v[integer]:1 new-tuple: k[text]:&#39;Alice&#39; v[integer]:3</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">table public.test: UPDATE: old-key: k[text]:&#39;Bob&#39; v[integer]:2 new-tuple: k[text]:&#39;Oscar&#39; v[integer]:2</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">table public.test: DELETE: k[text]:&#39;Alice&#39; v[integer]:3</span>
</span></span></code></pre></div><p>如果使用<strong>无身份模式（nothing）</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IDENTITY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOTHING</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 表test现在没有复制标识
</span></span></span></code></pre></div><p>那么逻辑解码的记录中，<code>UPDATE</code>操作中只有新记录，没有包含旧记录中的唯一身份标识，而<code>DELETE</code>操作中则完全没有信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">table public.test: INSERT: k[text]:&#39;Alice&#39; v[integer]:1</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">table public.test: INSERT: k[text]:&#39;Bob&#39; v[integer]:2</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">table public.test: UPDATE: k[text]:&#39;Alice&#39; v[integer]:3</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">table public.test: UPDATE: k[text]:&#39;Oscar&#39; v[integer]:2</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">table public.test: DELETE: (no-tuple-data)</span>
</span></span></code></pre></div><p>这样的逻辑变更日志对于订阅端来说完全没用，在实际使用中，对逻辑复制中的无复制标识的表执行<code>DELETE|UPDATE</code>会直接报错。</p>
<h2 id="复制标识详解">复制标识详解</h2>
<p>表上的复制标识配置，与表上有没有索引，是相对正交的两个因素。</p>
<p>尽管各种排列组合都是可能的，然而在实际使用中，只有三种可行的情况。</p>
<ul>
<li>表上有主键，使用默认的 <code>default</code> 复制标识</li>
<li>表上没有主键，但是有非空唯一索引，显式配置 <code>index</code> 复制标识</li>
<li>表上既没有主键，也没有非空唯一索引，显式配置<code>full</code>复制标识（运行效率非常低，仅能作为兜底方案）</li>
<li>其他所有情况，都无法正常完成逻辑复制功能</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">复制身份模式\表上的约束</th>
<th style="text-align:center">主键(p)</th>
<th style="text-align:center">非空唯一索引(u)</th>
<th style="text-align:center">两者皆无(n)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>d</strong>efault</td>
<td style="text-align:center"><strong>有效</strong></td>
<td style="text-align:center">x</td>
<td style="text-align:center">x</td>
</tr>
<tr>
<td style="text-align:center"><strong>i</strong>ndex</td>
<td style="text-align:center">x</td>
<td style="text-align:center"><strong>有效</strong></td>
<td style="text-align:center">x</td>
</tr>
<tr>
<td style="text-align:center"><strong>f</strong>ull</td>
<td style="text-align:center"><strong>低效</strong></td>
<td style="text-align:center"><strong>低效</strong></td>
<td style="text-align:center"><strong>低效</strong></td>
</tr>
<tr>
<td style="text-align:center"><strong>n</strong>othing</td>
<td style="text-align:center">x</td>
<td style="text-align:center">x</td>
<td style="text-align:center">x</td>
</tr>
</tbody>
</table>
<p>下面，我们来考虑几个边界条件。</p>
<h3 id="重建主键">重建主键</h3>
<p>假设因为索引膨胀，我们希望重建表上的主键索引回收空间。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">primary</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UNIQUE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_pkey2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CONSTRAINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_pkey</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ADD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_pkey2</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在<code>default</code>模式下，重建并替换主键约束与索引<strong>并不会</strong>影响复制标识。</p>
<h3 id="重建唯一索引">重建唯一索引</h3>
<p>假设因为索引膨胀，我们希望重建表上的非空唯一索引回收空间。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">unique</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IDENTITY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_v_key</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UNIQUE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_v_key2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 使用新的test_v_key2索引替换老的Unique索引
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ADD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UNIQUE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_v_key2</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CONSTRAINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_v_key</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>与<code>default</code>模式不同，<code>index</code>模式下，复制标识是与<strong>具体</strong>的索引绑定的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;public.test&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Type</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Collation</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Nullable</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Default</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Storage</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Stats</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">target</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Description</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------+---------+-----------+----------+---------+----------+--------------+-------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">extended</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">plain</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Indexes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;test_v_key&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UNIQUE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CONSTRAINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IDENTITY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;test_v_key2&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UNIQUE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CONSTRAINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这意味着如果采用偷天换日的方式替换UNIQUE索引会导致复制身份的丢失。</p>
<p>解决方案有两种：</p>
<ol>
<li>使用<code>REINDEX INDEX (CONCURRENTLY)</code>的方式重建该索引，不会丢失复制标识信息。</li>
<li>在替换索引时，一并刷新表的默认复制身份：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ADD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UNIQUE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_v_key2</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IDENTITY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_v_key2</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CONSTRAINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_v_key</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>顺带一提，移除作为身份标识的索引。尽管在表的配置信息中仍然为<code>index</code>模式，但效果与<code>nothing</code>相同。所以不要随意折腾作为身份的索引。</p>
<h3 id="使用不合格的索引作为复制标识">使用不合格的索引作为复制标识</h3>
<p>复制标识需要一个 唯一，不可延迟，整表范围的，建立在非空列集上的索引。</p>
<p>最经典的例子就是主键索引，以及通过<code>col type NOT NULL UNIQUE</code>声明的单列非空索引。</p>
<p>之所以要求 NOT NULL，是因为NULL值无法进行等值判断，所以表中允许UNIQE的列上存在多条取值为<code>NULL</code>的记录，允许列为空说明这个列无法起到唯一标识记录的效果。如果尝试使用一个普通的<code>UNIQUE</code>索引（列上没有非空约束）作为复制标识，则会报错。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">[42809] ERROR: index &#34;t_normal_v_key&#34; cannot be used as replica identity because column &#34;v&#34; is nullable</span>
</span></span></code></pre></div><h3 id="使用full复制标识">使用FULL复制标识</h3>
<p>如果没有任何复制标识，可以将复制标识设置为<code>FULL</code>，也就是把整个行当作复制标识。</p>
<p>使用<code>FULL</code>模式的复制标识效率很低，所以这种配置只能是保底方案，或者用于很小的表。因为每一行修改都需要在订阅者上执行<strong>全表扫描</strong>，<strong>很容易把订阅者拖垮</strong>。</p>
<h4 id="full模式限制">FULL模式限制</h4>
<p>使用<code>FULL</code>模式的复制标识还有一个限制，订阅端的表上的复制身份所包含的列，要么与发布者一致，要么比发布者更少，否则也无法保证的正确性，下面具体来看一个例子。</p>
<p>假如发布订阅两侧的表都采用<code>FULL</code>复制标识，但是订阅侧的表要比发布侧多了一列（是的，逻辑复制允许订阅端的表带有发布端表不具有的列）。这样的话，订阅端的表上的复制身份所包含的列要比发布端多了。假设在发布端上删除<code>(f1=a, f2=a)</code>的记录，却会导致在订阅端删除两条满足身份标识等值条件的记录。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>     (Publication)       ------&gt;           (Subscription)
</span></span><span style="display:flex;"><span>|--- f1 ---|--- f2 ---|          |--- f1 ---|--- f2 ---|--- f3 ---|
</span></span><span style="display:flex;"><span>|    a     |     a    |          |    a     |     a    |     b    |
</span></span><span style="display:flex;"><span>                                 |    a     |     a    |     c    |
</span></span></code></pre></div><h4 id="full模式如何应对重复行问题">FULL模式如何应对重复行问题</h4>
<p>PostgreSQL的逻辑复制可以“正确”处理<code>FULL</code>模式下完全相同行的场景。假设有这样一张设计糟糕的表，表中存在多条一模一样的记录。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">shitty_table</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	 </span><span style="color:#000">f1</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	 </span><span style="color:#000">f2</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	 </span><span style="color:#000">f3</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">TEXT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">shitty_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在FULL模式下，整行将作为复制标识使用。假设我们在<code>shitty_table</code>上通过ctid扫描作弊，删除了3条一模一样记录中的其中一条。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">shitty_table</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctid</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------+---+---+---
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DELETE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">shitty_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;(0,1)&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DELETE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">shitty_table</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctid</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------+---+---+---
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>从逻辑上讲，使用整行作为身份标识，那么订阅端执行以下逻辑，会导致全部3条记录被删除。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">DELETE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">shitty_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">f1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">f2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">f3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>但实际情况是，因为PostgreSQL的变更记录以行为单位，这条变更仅会对<strong>第一条匹配</strong>的记录生效，所以在订阅侧的行为也是删除3行中的1行。在逻辑上与发布端等效。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-42550a24271212176fd42acc36caec44">PG慢查询诊断方法论</h1>
	<div class="lead">慢查询是在线业务数据库的大敌，本文介绍了使用监控系统定位诊断慢查询的一般方法论。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2021-02-23" class="text-muted">2021年02月23日</time>
        
	</div>
	<blockquote>
<p>You can&rsquo;t optimize what you can&rsquo;t measure</p>
</blockquote>
<p>慢查询是在线业务数据库的大敌，如何诊断定位慢查询是DBA的必修课题。</p>
<p>本文介绍了使用监控系统 —— Pigsty诊断慢查询的一般方法论。</p>
<hr>
<h2 id="慢查询危害">慢查询：危害</h2>
<p>对于实际服务于在线业务事务处理的PostgreSQL数据库而言，慢查询的危害包括：</p>
<ul>
<li>慢查询挤占数据库连接，导致普通查询无连接可用，堆积并导致数据库雪崩。</li>
<li>慢查询长时间锁住了主库已经清理掉的旧版本元组，导致流复制重放进程锁死，导致主从复制延迟。</li>
<li>查询越慢，查询间相互踩踏的几率越高，越容易产生死锁、锁等待，事务冲突等问题。</li>
<li>慢查询浪费系统资源，拉高系统水位。</li>
</ul>
<p>因此，一个合格的DBA必须知道如何及时定位并处理慢查询。</p>
<p><img src="/zh/blog/admin/slow-query/slow-query-8.png"></p>
<blockquote>
<p>图：一个慢查询优化前后，系统的整体饱和度从40%降到了4%</p>
</blockquote>
<hr>
<h2 id="慢查询诊断--传统方法">慢查询诊断 —— 传统方法</h2>
<p>传统上来说，在PostgreSQL有两种方式可以获得慢查询的相关信息，一个是通过官方的扩展插件<code>pg_stat_statements</code>，另一种是慢查询日志。</p>
<p>慢查询日志顾名思义，所有执行时间长于<code>log_min_duration_statement</code>参数的查询都会被记录到PG的日志中，对于定位慢查询，特别是<strong>对于分析特例、单次慢查询不可或缺</strong>。不过慢查询日志也有自己的局限性。在生产环境中出于性能考虑，通常只会记录时长超出某一阈值的查询，那么许多信息就无法从慢查询日志中获取了。当然值得一提的是，尽管开销很大，但<strong>全量查询日志仍然是慢查询分析的终极杀手锏</strong>。</p>
<p>更常用的慢查询诊断工具可能还是<code>pg_stat_statements</code>。这事是一个非常实用的扩展，它会收集数据库内运行查询的统计信息，<strong>在任何场景下都强烈建议启用该扩展</strong>。</p>
<p><code>pg_stat_statements</code> 提供的原始指标数据以系统视图表的形式呈现。系统中的<strong>每一类</strong>查询（即抽取变量后执行计划相同的查询）都分配有一个查询ID，紧接着是调用次数，总耗时，最大、最小、平均单次耗时，响应时间都标准差，每次调用平均返回的行数，用于块IO的时间这些指标类数据。</p>
<p>一种简单的方式当然是观察 <code>mean_time/max_time</code>这类指标，从系统的Catalog中，您的确可以知道某类查询有<strong>史以来平均的响应时间</strong>。对于定位慢查询来说，也许这样也算得上基本够用了。但是像这样的指标，只是系统在当前时刻的一个<strong>静态快照</strong>，所以能够回答的问题是有限的。譬如说，您想看一看某个查询在加上新索引之后的性能表现是不是有所改善，用这种方式可能就会非常繁琐。</p>
<p><code>pg_stat_statements</code>需要在<code>shared_preload_library</code>中指定，并在数据库中通过<code>CREATE EXTENSION pg_stat_statements</code>显式创建。创建扩展后即可通过视图<code>pg_stat_statements</code>访问查询统计信息</p>
<h3 id="慢查询的定义">慢查询的定义</h3>
<p>多慢的查询算慢查询？</p>
<p>应该说这个问题<strong>取决于业务</strong>、以及实际的查询类型，<strong>并没有通用的标准</strong>。</p>
<p>作为一种经验阈值，频繁的CRUD点查，如果超过<strong>1ms</strong>，可列为慢查询。</p>
<p>对于偶发的单次特例查询而言，通常超过100ms或1s可以列为慢查询。</p>
<h2 id="慢查询诊断--pigsty">慢查询诊断 —— Pigsty</h2>
<p>监控系统就可以更全面地回答关于慢查询的问题。监控系统中的数据是由无数<strong>历史快照</strong>组成的（如5秒一次快照采样）。因此用户可以回溯至任意时间点，考察不同时间段内查询平均响应时间的变化。</p>
<p><img src="/img/concept/slow-query.jpg"></p>
<blockquote>
<p>上图是Pigsty中 <a href="/zh/docs/pgsql/dasdhboard/">PG Query Detail</a>提供的界面，这里展现出了单个查询的详细信息。</p>
<p>这是一个典型的慢查询，平均响应时间几秒钟。为它添加了一个索引后。从右中Query RT仪表盘的上可以看到，查询的平均响应世界从几秒降到了几毫秒。</p>
</blockquote>
<p>用户可以利用监控系统提供的<strong>洞察</strong>迅速定位数据库中的慢查询，定位问题，提出猜想。更重要的是，用户可以<strong>即时地</strong>在不同层次审视表与查询的详细指标，应用解决方案并获取<strong>实时反馈</strong>，这对于紧急故障处理是非常有帮助的。</p>
<p>有时监控系统的用途不仅仅在于提供数据与反馈，它还可以作为一种安抚情绪的良药：设想一个慢查询把生产数据库打雪崩了，如果老板或客户没有一个地方可以透明地知道当前的处理状态，难免会焦急地催问，进一步影响问题解决的速度。监控系统也可以做作为精确管理的依据。您可以有理有据地用监控指标的变化和老板与客户吹牛逼。</p>
<hr>
<h2 id="一个模拟的慢查询案例">一个模拟的慢查询案例</h2>
<blockquote>
<p>Talk is cheap, show me the code</p>
</blockquote>
<p>假设用户已经拥有一个 <a href="/zh/docs/setup/provision/">Pigsty沙箱演示环境</a>，下面将使用Pigsty沙箱，演示模拟的慢查询定位与处理流程。</p>
<hr>
<h3 id="慢查询模拟">慢查询：模拟</h3>
<p>因为没有实际的业务系统，这里我们以一种简单快捷的方式模拟系统中的慢查询。即<code>pgbench</code>自带的类<code>tpc-b</code>场景。</p>
<p>通过<code>make ri / make ro / make rw</code>，在<code>pg-test</code>集群上初始化 pgbench 用例，并对集群施加读写负载</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 50TPS 写入负载</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">while</span> true<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">do</span> pgbench -nv -P1 -c20 --rate<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">50</span> -T10 postgres://test:test@pg-test:5433/test<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1000TPS 只读负载</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">while</span> true<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">do</span> pgbench -nv -P1 -c40 --select-only --rate<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1000</span> -T10 postgres://test:test@pg-test:5434/test<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><p>现在我们已经有了一个模拟运行中的业务系统，让我们通过简单粗暴的方式来模拟一个慢查询场景。在<code>pg-test</code>集群的主库上执行以下命令，删除表<code>pgbench_accounts</code>的主键：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CONSTRAINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts_pkey</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>该命令会移除 <code>pgbench_accounts</code> 表上的主键，导致<strong>相关查询</strong>从索引扫描变为顺序全表扫描，全部变为慢查询，访问<a href="/zh/zh/docs/pgsql/dasdhboard">PG Instance</a> ➡️ Query ➡️ QPS，结果如下图所示：</p>
<p><img src="/zh/blog/admin/slow-query/slow-query-1.jpg"></p>
<blockquote>
<p>图1：平均查询响应时间从1ms飙升为300ms，单个从库实例的QPS从500下降至7。</p>
</blockquote>
<p>与此同时，实例因为慢查询堆积，系统会在瞬间<strong>雪崩过载</strong>，访问<a href="/zh/zh/docs/pgsql/dasdhboard">PG Cluster</a>首页，可以看到集群负载出现飙升。</p>
<p><img src="/zh/blog/admin/slow-query/slow-query-2.png"></p>
<blockquote>
<p>图2：系统负载达到200%，触发机器负载过大，与查询响应时间过长的报警规则。</p>
</blockquote>
<hr>
<h3 id="慢查询定位">慢查询：定位</h3>
<p>首先，使用<a href="/zh/zh/docs/pgsql/dasdhboard">PG Cluster</a>面板定位慢查询所在的具体实例，这里以 <code>pg-test-2</code> 为例。</p>
<p>然后，使用<a href="/zh/zh/docs/pgsql/dasdhboard">PG Query</a>面板定位具体的慢查询：编号为 <strong>-6041100154778468427</strong></p>
<p><img src="/zh/blog/admin/slow-query/slow-query-3.jpg"></p>
<blockquote>
<p>图3：从查询总览中发现异常慢查询</p>
</blockquote>
<p>该查询表现出：</p>
<ul>
<li>响应时间显著上升： 17us 升至 280ms</li>
<li>QPS 显著下降：       从500下降到 7</li>
<li>花费在该查询上的时间占比显著增加</li>
</ul>
<p>可以确定，就是这个查询变慢了！</p>
<p>接下来，利用<a href="/zh/zh/docs/pgsql/dasdhboard/">PG Stat Statements</a>面板或<a href="/zh/zh/docs/pgsql/dasdhboard">PG Query Detail</a>，根据查询ID定位慢查询的<strong>具体语句</strong>。</p>
<p><img src="/zh/blog/admin/slow-query/slow-query-4.png"></p>
<blockquote>
<p>图4：定位查询语句为<code>SELECT abalance FROM pgbench_accounts WHERE aid = $1</code></p>
</blockquote>
<hr>
<h3 id="慢查询猜想">慢查询：猜想</h3>
<p>获知慢查询语句后，接下来需要推断慢查询<strong>产生的原因</strong>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>该查询以 <code>aid</code> 作为过滤条件查询 <code>pgbench_accounts</code> 表，如此简单的查询变慢，大概率是这张表上的索引出了问题。 <em>用屁股想都知道是索引少了，因为就是我们自己删掉的嘛！</em></p>
<p>分析查询后， 可以<strong>提出猜想</strong>： 该查询变慢是<code>pgbench_accounts</code>表上<code>aid</code>列缺少索引。</p>
<p>下一步，我们就要<strong>验证猜想</strong>。</p>
<p>第一步，使用<a href="/zh/zh/docs/pgsql/dasdhboard">PG Table Catalog</a>，我们可以检视表的详情，例如表上建立的索引。</p>
<p>第二步，查阅 <a href="/zh/zh/docs/pgsql/dasdhboard">PG Table Detail</a> 面板，检查 <code>pgbench_accounts</code> 表上的访问，来验证我们的猜想</p>
<p><img src="/zh/blog/admin/slow-query/slow-query-5.png"></p>
<blockquote>
<p>图5： <code>pgbench_accounts</code> 表上的访问情况</p>
</blockquote>
<p>通过观察，我们发现表上的<strong>索引扫描</strong>归零，与此同时<strong>顺序扫描</strong>却有相应增长。这印证了我们的猜想！</p>
<hr>
<h3 id="慢查询方案">慢查询：方案</h3>
<p>假设一旦成立，就可以着手提出方案，解决问题了。</p>
<p>解决慢查询通常有三种方式：<strong>修改表结构</strong>、<strong>修改查询</strong>、<strong>修改索引</strong>。</p>
<p>修改表结构与查询通常涉及到具体的业务知识和领域知识，需要具体问题具体分析。但修改索引通常来说不需要太多的具体业务知识。</p>
<p>这里的问题可以通过添加索引解决，<code>pgbench_accounts</code> 表上 <code>aid</code> 列缺少索引，那么我们尝试在 <code>pgbench_accounts</code> 表上为 <code>aid</code> 列添加索引，看看能否解决这个问题。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UNIQUE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">aid</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>加上索引后，神奇的事情发生了。</p>
<p><img src="/zh/blog/admin/slow-query/slow-query-6.png"></p>
<blockquote>
<p>图6：可以看到，查询的响应时间与QPS已经恢复正常。</p>
</blockquote>
<p><img src="/zh/blog/admin/slow-query/slow-query-7.png"></p>
<blockquote>
<p>图7：系统的负载也恢复正常</p>
</blockquote>
<hr>
<h3 id="慢查询评估">慢查询：评估</h3>
<p>作为慢查询处理的最后一步，我们通常需要对操作的过程进行记录，对效果进行评估。</p>
<p>有时候一个简单的优化可以产生戏剧性的效果。也许本来需要砸几十万加机器的问题，创建一个索引就解决了。</p>
<p>这种故事，就可以通过监控系统，用很生动直观的形式表达出来，赚取KPI与Credit。</p>
<p><img src="/zh/blog/admin/slow-query/slow-query-8.png"></p>
<blockquote>
<p>图：一个慢查询优化前后，系统的整体饱和度从40%降到了4%</p>
<p>（相当于节省了X台机器，XX万元，老板看了心花怒放，下一任CTO就是你了！）</p>
</blockquote>
<hr>
<h3 id="慢查询小结">慢查询：小结</h3>
<p>通过这篇教程，您已经掌握了慢查询优化的一般方法论。即：</p>
<ul>
<li>
<p>定位问题</p>
</li>
<li>
<p>提出猜想</p>
</li>
<li>
<p>验证假设</p>
</li>
<li>
<p>制定方案</p>
</li>
<li>
<p>评估效果</p>
</li>
</ul>
<p>监控系统在慢查询处理的整个生命周期中都能起到重要的效果。更能将运维与DBA的“经验”与“成果”，以可视化，可量化，可复制的方式表达出来。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-79b53a6d42ba827e043f36600910a088">故障档案:时间回溯导致的Patroni故障</h1>
	<div class="lead">机器因为故障重启，NTP服务在PG启动后修复了PG的时间，导致Patroni无法启动。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2021-02-22" class="text-muted">2021年02月22日</time>
        
	</div>
	<p>摘要：机器因为故障重启，NTP服务在PG启动后修复了PG的时间，导致 Patroni 无法启动。</p>
<p>Patroni中的故障信息如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Process %s is not postmaster, too much difference between PID file start time %s and process start time %s
</span></span></code></pre></div><p>patroni 进程启动时间和pid时间不一致。就会认为：postgres is not running。</p>
<p>两个时间相差超过30秒。patroni 就尿了，启动不了了。</p>
<p>打印错误信息的代码为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">start_time</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_postmaster_pid</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;start_time&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">start_time</span> <span style="color:#204a87;font-weight:bold">and</span> <span style="color:#204a87">abs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">create_time</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">start_time</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">logger</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Process </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06"> is not postmaster, too much difference between PID file start time </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06"> and process start time </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">create_time</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">start_time</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>同时，发现了Patroni里的一个BUG：https://github.com/zalando/patroni/issues/811 错误信息里两个时间戳打反了。</p>
<p>经验与教训： NTP 时间同步是非常重要的</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-e0d5ab34ac83091f7c860a6f3e6a2dbf">在线修改主键列类型</h1>
	<div class="lead">如何在线修改表中列的类型，例如从INT升级为BIGINT？</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2021-01-15" class="text-muted">2021年01月15日</time>
        
	</div>
	<p>如何在线修改主键列类型，比如将 <code>INT</code> 至 <code>BIGINT</code>，同时又不影响业务？</p>
<p>假设在PG中有一个表，在设计的时候拍脑袋使用了 INT 整型主键，现在业务蓬勃发展发现序列号不够用了，想升级到BIGINT类型。这时候该怎么做呢？</p>
<p>拍脑袋的方法当然是直接使用DDL修改类型：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DATA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TYPE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>但这种方式对于访问频繁的生产大表是不可行的</p>
<hr>
<h2 id="太长不看">太长；不看</h2>
<p>让我们以 pgbench 自带的场景为例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 操作目标：升级 pgbench_accounts 表普通列 abalance 类型：INT -&gt; BIGINT
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 添加新列：abalance_tmp BIGINT
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ADD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_tmp</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 创建触发器函数：保持新列数据与旧列同步
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sync_pgbench_accounts_abalance</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abalance_tmp</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abalance</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;plpgsql&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 完成整表更新，分批更新的方式见下
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_tmp</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 不要在大表上运行这个
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 创建触发器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tg_sync_pgbench_accounts_abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BEFORE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXECUTE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sync_pgbench_accounts_abalance</span><span style="color:#000;font-weight:bold">();</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 完成列的新旧切换，这时候数据同步方向变化 旧列数据与新列保持同步
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LOCK</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXCLUSIVE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">MODE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DISABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tg_sync_pgbench_accounts_abalance</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RENAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_old</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RENAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_tmp</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RENAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_old</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_tmp</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tg_sync_pgbench_accounts_abalance</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 确认数据完整性
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_new</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 清理触发器与函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sync_pgbench_accounts_abalance</span><span style="color:#000;font-weight:bold">();</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tg_sync_pgbench_accounts_abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="外键">外键</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">add</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">between</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">commit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">between</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100001</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">commit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">between</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200001</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">300000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">commit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">between</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">300001</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">400000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">commit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">unique</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table_pk_idx</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">new_id</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">constraint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table_pk</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nextval</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;my_table_id_seq&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">regclass</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">is</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">add</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">constraint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table_pk</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">primary</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table_pk_idx</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">commit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="以pgbench为例">以pgbench为例</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">\</span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;public.pgbench_accounts&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Column</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:bold">Type</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Collation</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Nullable</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------+---------------+-----------+----------+---------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aid</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bid</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">filler</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">character</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">84</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Indexes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;pgbench_accounts_pkey&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">aid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>升级<code>abalance</code>列为BIGINT</p>
<p>会锁表，在表大小非常小，访问量非常小的的情况下可用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DATA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TYPE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="在线升级流程">在线升级流程</h2>
<ol>
<li>添加新列</li>
<li>更新数据</li>
<li>在新列上创建相关索引（如果没有也可以单列创建，加快第四步的速度）</li>
<li>执行切换<strong>事务</strong>
<ol>
<li>排他锁表</li>
<li>UPDATE更新空列（也可以使用触发器）</li>
<li>删旧列</li>
<li>重命名新列</li>
</ol>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- Step 1 : 创建新列
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ADD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_new</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Step 2 : 更新数据，可以分批更新，分批更新方法详见下面
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_new</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Step 3 : 可选（在新列上创建索引）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CONCURRENTLY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">abalance_new</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_new</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Step 3 :
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Step 4 :
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 同步更新对应列
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sync_abalance</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abalance_new</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OLD</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abalance</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;plpgsql&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts_sync_abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BEFORE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXECUTE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sync_abalance</span><span style="color:#000;font-weight:bold">();</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">add</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">between</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">commit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">between</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100001</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">commit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">between</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200001</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">300000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">commit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">between</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">300001</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">400000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">commit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">unique</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table_pk_idx</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">new_id</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">constraint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table_pk</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nextval</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;my_table_id_seq&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">regclass</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">is</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">add</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">constraint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table_pk</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">primary</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table_pk_idx</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">commit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="批量更新逻辑">批量更新逻辑</h2>
<p>有时候需要为大表添加一个非空的，带有默认值的列。因此需要对整表进行一次更新，可以使用下面的办法，将一次巨大的更新拆分为100次或者更多的小更新。</p>
<p>从统计信息中获取主键的分桶信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">unnest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">histogram_bounds</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">[])</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;signup_users&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">attname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;id&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>直接从统计分桶信息中生成需要执行的SQL，在这里把SQL改成需要更新的语</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SELECT <span style="color:#4e9a06">&#39;UPDATE signup_users SET app_type = &#39;&#39;&#39;&#39; WHERE id BETWEEN &#39;</span> <span style="color:#ce5c00;font-weight:bold">||</span> lo::TEXT <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#4e9a06">&#39; AND &#39;</span> <span style="color:#ce5c00;font-weight:bold">||</span> hi::TEXT <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#4e9a06">&#39;;&#39;</span>
</span></span><span style="display:flex;"><span>FROM <span style="color:#ce5c00;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>         SELECT lo, lead<span style="color:#ce5c00;font-weight:bold">(</span>lo<span style="color:#ce5c00;font-weight:bold">)</span> OVER <span style="color:#ce5c00;font-weight:bold">(</span>ORDER BY lo<span style="color:#ce5c00;font-weight:bold">)</span> as hi
</span></span><span style="display:flex;"><span>         FROM <span style="color:#ce5c00;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>                  SELECT unnest<span style="color:#ce5c00;font-weight:bold">(</span>histogram_bounds::TEXT::BIGINT<span style="color:#ce5c00;font-weight:bold">[])</span> lo
</span></span><span style="display:flex;"><span>                  FROM pg_stats
</span></span><span style="display:flex;"><span>                  WHERE <span style="color:#000">tablename</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;signup_users&#39;</span>
</span></span><span style="display:flex;"><span>                    and <span style="color:#000">attname</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;id&#39;</span>
</span></span><span style="display:flex;"><span>                  ORDER BY <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ce5c00;font-weight:bold">)</span> t1
</span></span><span style="display:flex;"><span>     <span style="color:#ce5c00;font-weight:bold">)</span> t2<span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>直接使用SHELL脚本打印出更新语句</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">DATNAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">RELNAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;pgbench_accounts&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">IDENTITY</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;aid&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">UPDATE_CLAUSE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;abalance_new = abalance&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SQL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>cat <span style="color:#4e9a06">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">SELECT &#39;UPDATE ${RELNAME} SET ${UPDATE_CLAUSE} WHERE ${IDENTITY} BETWEEN &#39; || lo::TEXT || &#39; AND &#39; || hi::TEXT || &#39;;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">FROM (
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">		SELECT lo, lead(lo) OVER (ORDER BY lo) as hi
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">		FROM (
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">				SELECT unnest(histogram_bounds::TEXT::BIGINT[]) lo
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">				FROM pg_stats
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">				WHERE tablename = &#39;${RELNAME}&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">					and attname = &#39;${IDENTITY}&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">				ORDER BY 1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">			) t1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">	) t2;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># echo $SQL</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>psql <span style="color:#4e9a06">${</span><span style="color:#000">DATNAME</span><span style="color:#4e9a06">}</span> -qAXwtc <span style="color:#4e9a06">&#34;ANALYZE </span><span style="color:#4e9a06">${</span><span style="color:#000">RELNAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">;&#34;</span>
</span></span><span style="display:flex;"><span>psql <span style="color:#4e9a06">${</span><span style="color:#000">DATNAME</span><span style="color:#4e9a06">}</span> -qAXwtc <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">SQL</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div><p>处理边界情况。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> UPDATE signup_users SET <span style="color:#000">app_type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;&#39;</span> WHERE app_type !<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><hr>
<h2 id="优化与改进">优化与改进</h2>
<p>也可以加工一下，添加事务语句和休眠间隔</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">DATNAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;test&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">RELNAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;pgbench_accounts&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">COLNAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;aid&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">UPDATE_CLAUSE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;abalance_tmp = abalance&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">SLEEP_INTERVAL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SQL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#a40000">$</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;-</span><span style="color:#000">EOF</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;BEGIN;UPDATE ${RELNAME} SET ${UPDATE_CLAUSE} WHERE ${COLNAME} BETWEEN &#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lo</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">TEXT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39; AND &#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hi</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">TEXT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;;COMMIT;SELECT pg_sleep(${SLEEP_INTERVAL});VACUUM ${RELNAME};&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lo</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lead</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lo</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OVER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lo</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">				</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">unnest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">histogram_bounds</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">[])</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">				</span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">				</span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${RELNAME}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">					</span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">attname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${COLNAME}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">				</span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">			</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t2</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">EOF</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">echo</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#204a87;font-weight:bold">SQL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">psql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">${</span><span style="color:#000">DATNAME</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">qAXwtc</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ANALYZE ${RELNAME};&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">psql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">${</span><span style="color:#000">DATNAME</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">qAXwtc</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${SQL}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_new</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BETWEEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">397</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">103196</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">);</span><span style="color:#204a87;font-weight:bold">VACUUM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_new</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BETWEEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">103196</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">213490</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">);</span><span style="color:#204a87;font-weight:bold">VACUUM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_new</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BETWEEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">213490</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">301811</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">);</span><span style="color:#204a87;font-weight:bold">VACUUM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_new</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BETWEEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">301811</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">400003</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">);</span><span style="color:#204a87;font-weight:bold">VACUUM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_new</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BETWEEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">400003</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">511931</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">);</span><span style="color:#204a87;font-weight:bold">VACUUM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_new</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BETWEEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">511931</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">613890</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">);</span><span style="color:#204a87;font-weight:bold">VACUUM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c52a9f6e2ac5fe0ee06804492be08d23">黄金监控指标：错误延迟吞吐饱和</h1>
	<div class="lead">了解PostgreSQL中的黄金监控指标</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2020-11-06" class="text-muted">2020年11月06日</time>
        
	</div>
	<hr>
<h2 id="前言">前言</h2>
<p>玩数据库和玩车有一个共通之处，就是都需要经常看仪表盘。</p>
<p>盯着仪表盘干什么，看指标。为什么看指标，掌握当前运行状态才能有效施加控制。</p>
<p><img src="/img/blog/golden-metrics-car.jpeg"></p>
<p>车有很多指标：车速，胎压，扭矩，刹车片磨损，各种温度，等等等等，各式各样。</p>
<p>但人的注意力空间有限，仪表盘也就那么大，</p>
<p>所以，指标可以分两类：</p>
<ul>
<li><strong>你会去看的</strong>：<strong>黄金指标 / 关键指标 / 核心指标</strong></li>
<li><strong>你不会看的</strong>：黑匣子指标 / 冷指标。</li>
</ul>
<p>黄金指标就是那几个关键性的核心数据，需要时刻保持关注（或者让自动驾驶系统/报警系统替你时刻保持关注），而冷指标通常只有故障排查时才会去看，故障排查与验尸要求尽可能还原现场，黑匣子指标多多益善。需要时没有就很让人抓狂</p>
<p>今天我们来说说PostgreSQL的核心指标，数据库的核心指标是什么？</p>
<hr>
<h2 id="数据库的指标">数据库的指标</h2>
<p>在讲数据库的核心指标之前，我们先来瞄一眼有哪些指标。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>avg(count by (ins) ({__name__=~&#34;pg.*&#34;}))
</span></span><span style="display:flex;"><span>avg(count by (ins) ({__name__=~&#34;node.*&#34;}))
</span></span></code></pre></div><p>1000多个pg的指标，2000多个机器的指标。</p>
<p>这些指标都是数据宝藏，挖掘与可视化可以提取出其中的价值。</p>
<p>但对于日常管理，只需要少数几个核心指标就可以了。</p>
<p>可用指标千千万，哪些才是核心指标？</p>
<hr>
<h2 id="核心指标">核心指标</h2>
<p>根据经验和使用频度，不断地做减法，可以筛选出一些核心指标：</p>
<table>
<thead>
<tr>
<th>指标</th>
<th>缩写</th>
<th>层次</th>
<th>来源</th>
<th>种类</th>
</tr>
</thead>
<tbody>
<tr>
<td>错误日志条数</td>
<td>Error Count</td>
<td>SYS/DB/APP</td>
<td>日志系统</td>
<td>错误</td>
</tr>
<tr>
<td><strong>连接池排队数</strong></td>
<td>Queue Clients</td>
<td>DB</td>
<td>连接池</td>
<td>错误</td>
</tr>
<tr>
<td><strong>数据库负载</strong></td>
<td>PG Load</td>
<td>DB</td>
<td>连接池</td>
<td>饱和度</td>
</tr>
<tr>
<td><strong>数据库饱和度</strong></td>
<td>PG Saturation</td>
<td>DB</td>
<td>连接池&amp;节点</td>
<td>饱和度</td>
</tr>
<tr>
<td><strong>主从复制延迟</strong></td>
<td>Repl Lag</td>
<td>DB</td>
<td>数据库</td>
<td>延迟</td>
</tr>
<tr>
<td><strong>平均查询响应时间</strong></td>
<td>Query RT</td>
<td>DB</td>
<td>连接池</td>
<td>延迟</td>
</tr>
<tr>
<td><strong>活跃后端进程数</strong></td>
<td>Backends</td>
<td>DB</td>
<td>数据库</td>
<td>饱和度</td>
</tr>
<tr>
<td><strong>数据库年龄</strong></td>
<td>Age</td>
<td>DB</td>
<td>数据库</td>
<td>饱和度</td>
</tr>
<tr>
<td><strong>每秒查询数</strong></td>
<td>QPS</td>
<td><strong>APP</strong></td>
<td>连接池</td>
<td>流量</td>
</tr>
<tr>
<td><strong>CPU使用率</strong></td>
<td>CPU Usage</td>
<td>SYS</td>
<td>机器节点</td>
<td>饱和度</td>
</tr>
</tbody>
</table>
<p>紧急情况下：错误是始终是第一优先级的黄金指标。</p>
<p>常规情况下：应用视角的黄金指标：QPS与RT</p>
<p>常规情况下：DBA视角的黄金指标：DB饱和度（水位）</p>
<hr>
<h2 id="为什么是它们">为什么是它们？</h2>
<h3 id="错误指标"><strong>错误指标</strong></h3>
<p>第一优先级的指标永远是<strong>错误</strong>，错误往往是直接面向终端用户的。</p>
<p>如果只能选一个指标进行监控，那么选<strong>错误指标</strong>，比如应用，系统，DB层的每秒错误日志条数可能最合适。</p>
<p>一辆车，只能选一个仪表盘上的功能，你会选什么？</p>
<p>选<strong>错误指标</strong>，小车不停只管推。</p>
<p>错误类指标非常重要，直接反映出系统的异常，譬如连接池排队。但错误类指标最大的问题就是，它只在告警时有意义，难以用于日常的水位评估与性能分析，此外，错误类指标也往往难以精确量化，往往只能给出定性的结果：有问题 vs 没问题。</p>
<p>此外，错误类指标难以精确量化。我们只能说：当连接池出现排队时，数据库负载比较大；队列越长，负载越大；没有排队时，数据库负载不怎么大，仅此而已。对于日常使用管理来说，这样的能力肯定也是不够的。</p>
<p><strong>定指标，做监控报警系统的一个重要原因就是用于预防系统过载，如果系统已经过载大量报错，那么使用错误现象反过来定义饱和度是没有意义的</strong>。</p>
<p>指标的目的，是为了衡量系统的运行状态。，我们还会关注系统其他方面的能力：吞吐量/流量，响应时间/延迟，饱和度/利用率/水位线。这三者分别代表系统的能力，服务质量，负载水平。</p>
<p>关注点不同，后端（数据库用户）关注系统能力与服务质量，DBA（数据库管理者）更关注系统的负载水平。</p>
<h3 id="流量指标"><strong>流量指标</strong></h3>
<p>流量类的指标很有潜力，特别是QPS，TPS这样的指标相当具有代表性。</p>
<p>流量指标可以直接衡量系统的能力，譬如每秒处理多少笔订单，每秒处理的多少个请求。</p>
<p>与车速计有异曲同工之妙，高速限速，城市限速。环境，负载。</p>
<p>但像TPS QPS这样流量也存在问题。一个数据库实例上的查询往往是五花八门各式各样的，一个耗时10微秒的查询和一个10秒的查询在统计时都被算为一个Q，<strong>类似于QPS这样的指标无法进行横向比较，只有比较粗略的参考意义</strong>，甚至当查询类型发生变化时，都无法和自己的历史数据进行纵向比较。此外也很难针对QPS、TPS这样的指标设置利用率目标，同一个数据库执行<code>SELECT 1</code>可以打到几十万的QPS，但执行复杂SQL时可能就只能打到几千的QPS。不同负载类型和机器硬件会对数据库的QPS上限产生显著影响，只有当一个数据库上的查询都是高度单一同质且没有复杂变化的条件下，QPS才有参考意义，在这种苛刻条件下倒是可以通过压力测试设定一个QPS的水位目标。</p>
<h3 id="延迟指标"><strong>延迟指标</strong></h3>
<p>与档位类似，查询慢，档位低，车速慢。查询档次低，TPS水位低。查询档次高，TPS水位高</p>
<p>延迟适合衡量系统的服务质量。</p>
<p>比起QPS/TPS，RT（响应时间 Response Time）这样的指标反而更具有参考价值。因为响应时间增加往往是系统饱和的前兆。根据经验法则，数据库的负载越大，查询与事务的平均响应时间也会越高。RT相比QPS的一个优势是**，RT是可以设置一个利用率目标的**，比如可以为RT设定一个绝对阈值：不允许生产OLTP库上出现RT超过1ms的慢查询。但QPS这样的指标就很难画出红线来。不过，RT也有自己的问题。第一个问题是它依然是定性而非定量的，延迟增加只是系统饱和的预警，但没法用来精确衡量系统的饱和度。第二个问题通常能从数据库与中间件获取到的RT统计指标都是平均值，但真正起到预警效果的有可能是诸如P99，P999这样的统计量。</p>
<h3 id="饱和度指标"><strong>饱和度指标</strong></h3>
<p>饱和度指标类似汽车的发动机转速表，油量表，水温表。</p>
<p>饱和度指标适合衡量系统的负载</p>
<p>即用户期待的负载指标是一个<strong>饱和度（Saturation）<strong>指标，所谓饱和度，即服务容量有多”满“，通常是系统中目前最为受限的某种资源的某个具体指标的度量。通常来说，0%的饱和度意味着系统完全空闲，100%的饱和度意味着满载，系统在达到100%利用率前就会出现性能的严重下降，因此设定指标时还需要包括一个</strong>利用率目标</strong>，或者说<strong>水位红线、黄线</strong>，当系统瞬时负载超过红线时应当触发告警，长期负载超过黄线时应当进行扩容。</p>
<table>
<thead>
<tr>
<th><strong>其他可选指标</strong></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>每秒事务数</td>
<td>TPS</td>
<td>APP</td>
<td>连接池</td>
<td>流量</td>
</tr>
<tr>
<td>磁盘IO使用率</td>
<td>Disk Usage</td>
<td>SYS</td>
<td>机器节点</td>
<td>饱和度</td>
</tr>
<tr>
<td>内存使用率</td>
<td>Mem Usage</td>
<td>SYS</td>
<td>机器节点</td>
<td>饱和度</td>
</tr>
<tr>
<td>网卡带宽使用率</td>
<td>Net Usage</td>
<td>SYS</td>
<td>机器节点</td>
<td>饱和度</td>
</tr>
<tr>
<td>TCP错误：溢出重传等</td>
<td>TCP ERROR</td>
<td>SYS</td>
<td>机器节点</td>
<td>错误</td>
</tr>
</tbody>
</table>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-ef792c4864e63a9306b3f73197c2f0b4">数据库集群管理概念与实体命名规范</h1>
	<div class="lead">概念及其命名是非常重要的东西，命名风格体现了工程师对系统架构的认知。定义不清的概念将导致沟通困惑，随意设定的名称将产生意想不到的额外负担。因此需要审慎地设计。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2020-06-03" class="text-muted">2020年06月03日</time>
        
	</div>
	<blockquote>
<p>名之则可言也，言之则可行也。</p>
</blockquote>
<p>概念及其命名是非常重要的东西，命名风格体现了工程师对系统架构的认知。定义不清的概念将导致沟通困惑，随意设定的名称将产生意想不到的额外负担。因此需要审慎地设计。</p>
<h2 id="tldr">TL;DR</h2>
<p><img alt="entity-naming.png" src="/img/blog/pg/entity-naming.png"></p>
<ul>
<li>**集群（Cluster）**是基本自治单元，由用户指定唯一标识，表达业务含义，作为顶层命名空间。</li>
<li>集群在硬件层面上包含一系列的<strong>节点（Node）</strong>，即物理机，虚机（或Pod），可以通过IP唯一标识。</li>
<li>集群在软件层面上包含一系列的<strong>实例（Instance）</strong>，即软件服务器，可以通过IP:Port唯一标识。</li>
<li>集群在服务层面上包含一系列的<strong>服务（Service）</strong>，即可访问的域名与端点，可以通过域名唯一标识。</li>
<li>Cluster命名可以使用任意满足DNS域名规范的名称，但不能带点（[a-zA-Z0-9-]+）。</li>
<li>Node/Pod命名采用Cluster名称前缀，后接<code>-</code>连接一个从0开始分配的序号，（与k8s保持一致）</li>
<li>实例命名通常与Node保持一致，即<code>${cluster}-${seq}</code>的方式，这种方式隐含着节点与实例1:1部署的假设。如果这个假设不成立，则可以采用独立于节点的序号，但保持同样的命名规则。</li>
<li>Service命名采用Cluster名称前缀，后接<code>-</code>连接服务具体内容，如<code>primary</code>,<code> standby</code></li>
</ul>
<p>以上图为例，用于测试的数据库集群名为“<code>pg-test</code>”，该集群由一主两从三个数据库服务器实例组成，部署在集群所属的三个节点上。<code>pg-test</code>集群集群对外提供两种服务，读写服务<code>pg-test-primary</code>与只读副本服务<code>pg-test-standby</code>。</p>
<h2 id="基本概念">基本概念</h2>
<p>在Postgres集群管理中，有如下概念：</p>
<h3 id="集群cluster"><strong>集群（Cluster）</strong></h3>
<p><strong>集群</strong>是基本的自治业务单元，这意味着集群能够作为一个整体组织对外提供服务。类似于k8s中Deployment的概念。注意这里的集群是软件层面的概念，不要与PG Cluster（数据库集簇，即包含多个PG Database实例的单个PG Server Instance）或Node Cluster（机器集群）混淆。</p>
<p>集群是管理的基本单位之一，是用于统合各类资源的组织单位。例如一个PG集群可能包括：</p>
<ul>
<li>三个物理机器节点</li>
<li>一个主库实例，对外提供数据库读写服务。</li>
<li>两个从库实例，对外提供数据库只读副本服务。</li>
<li>两个对外暴露的服务：读写服务，只读副本服务。</li>
</ul>
<p>每个集群都有用户根据业务需求定义的唯一标识符，本例中定义了一个名为<code>pg-test</code>的数据库集群。</p>
<h3 id="节点node">节点（Node）</h3>
<p><strong>节点</strong>是对硬件资源的一种抽象，通常指代一台工作机器，无论是物理机（bare metal）还是虚拟机（vm），或者是k8s中的Pod。这里注意k8s中Node是硬件资源的抽象，但在实际管理使用上，是k8s中的Pod而不是Node更类似于这里Node概念。总之，节点的关键要素是：</p>
<ul>
<li>节点是硬件资源的抽象，可以运行一系列的软件服务</li>
<li><strong>节点可以使用IP地址作为唯一标识符</strong></li>
</ul>
<p>尽管可以使用<code>lan_ip</code>地址作为节点唯一标识符，但为了便于管理，节点应当拥有一个人类可读的充满意义的名称作为节点的Hostname，作为另一个常用的节点唯一标识。</p>
<h3 id="服务service">服务（Service）</h3>
<p>服务是对软件服务（例如Postgres，Redis）的一种<strong>命名抽象（named abastraction）</strong>。服务可以有各种各样的实现，但其的关键要素在于：</p>
<ul>
<li><strong>可以寻址访问的服务名称</strong>，用于对外提供接入，例如：
<ul>
<li>一个DNS域名（<code>pg-test-primary</code>）</li>
<li>一个Nginx/Haproxy Endpoint</li>
</ul>
</li>
<li><strong>服务流量路由解析与负载均衡机制</strong>，用于决定哪个实例负责处理请求，例如：
<ul>
<li>DNS L7：DNS解析记录</li>
<li>HTTP Proxy：Nginx/Ingress L7：Nginx Upstream配置</li>
<li>TCP Proxy：Haproxy L4：Haproxy Backend配置</li>
<li>Kubernetes：Ingress：<strong>Pod Selector 选择器</strong>。</li>
</ul>
</li>
</ul>
<p>同一个数据集簇中通常包括主库与从库，两者分别提供读写服务（primary）和只读副本服务(standby)。</p>
<h3 id="实例instance">实例（Instance）</h3>
<p>实例指带<strong>一个具体的数据库服务器</strong>，它可以是单个进程，也可能是共享命运的一组进程，也可以是一个Pod中几个紧密关联的容器。实例的关键要素在于：</p>
<ul>
<li>可以通过IP:Port唯一标识</li>
<li>具有处理请求的能力</li>
</ul>
<p>例如，我们可以把一个Postgres进程，为之服务的独占Pgbouncer连接池，PgExporter监控组件，高可用组件，管理Agent看作一个提供服务的整体，视为一个数据库实例。</p>
<p>实例隶属于集群，每个实例在集群范围内都有着自己的唯一标识用于区分。</p>
<p>实例由服务负责解析，实例提供被寻址的能力，而Service将请求流量解析到具体的实例组上。</p>
<h2 id="命名规则">命名规则</h2>
<p><img alt="entity-naming.png" src="/img/blog/pg/entity-naming.png"></p>
<p>一个对象可以有很多组 <strong>标签（Tag）</strong> 与 <strong>元数据（Metadata/Annotation）</strong> ，但通常只能有一个名字。</p>
<p>管理数据库和软件，其实与管理子女或者宠物类似，都是需要花心思去照顾的。而起名字就是其中非常重要的一项工作。肆意的名字（例如 XÆA-12，NULL，史珍香）很可能会引入不必要的麻烦（额外复杂度），而设计得当的名字则可能会有意想不到的效果。</p>
<p>总的来说，对象起名应当遵循一些原则：</p>
<ul>
<li>
<p>简洁直白，人类可读：名字是给人看的，因此要好记，便于使用。</p>
</li>
<li>
<p>体现功能，反映特征：名字需要反映对象的关键特征</p>
</li>
<li>
<p>独一无二，唯一标识：名字在命名空间内，自己的类目下应当是独一无二，可以惟一标识寻址的。</p>
</li>
<li>
<p>不要把太多无关的东西塞到名字里去：在名字中嵌入很多重要元数据是一个很有吸引力的想法，但维护起来会非常痛苦，例如反例：<code>pg:user:profile:10.11.12.13:5432:replica:13</code>。</p>
</li>
</ul>
<h3 id="集群命名">集群命名</h3>
<p>集群名称，其实类似于命名空间的作用。所有隶属本集群的资源，都会使用该命名空间。</p>
<p><strong>集群命名的形式</strong>，建议采用符合DNS标准 <a href="https://tools.ietf.org/html/rfc1034">RFC1034</a> 的命名规则，以免给后续改造埋坑。例如哪一天想要搬到云上去，发现以前用的名字不支持，那就要再改一遍名，成本巨大。</p>
<p>我认为更好的方式是采用更为严格的限制：集群的名称不应该包括<strong>点（dot）</strong>。应当仅使用小写字母，数字，以及<strong>减号连字符（hyphen）<code>-</code></strong>。这样，集群中的所有对象都可以使用这个名称作为前缀，用于各种各样的地方，而不用担心打破某些约束。即集群命名规则为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f57900">cluster_name</span> <span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">z0</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span>
</span></span></code></pre></div><p>之所以强调不要在集群名称中用<strong>点</strong>，是因为以前很流行一种命名方式，例如<code>com.foo.bar</code>。即由点分割的层次结构命名法。这种命名方式虽然简洁名快，但有一个问题，就是用户给出的名字里可能有任意多的层次，数量不可控。如果集群需要与外部系统交互，而外部系统对于命名有一些约束，那么这样的名字就会带来麻烦。一个最直观的例子是K8s中的Pod，Pod的命名规则中不允许出现<code>.</code>。</p>
<p><strong>集群命名的内涵</strong>，建议采用<code>-</code>分隔的两段式，三段式名称，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;集群类型&gt;-&lt;业务&gt;-&lt;业务线&gt;
</span></span></code></pre></div><p>比如：<code>pg-test-tt</code>就表示<code>tt</code> 业务线下的<code>test</code>集群，类型为<code>pg</code>。<code>pg-user-fin</code>表示<code>fin</code>业务线下的<code>user</code>服务。当然，采集多段命名最好还是保持段数固定。</p>
<h3 id="节点命名">节点命名</h3>
<p>节点命名建议采用与k8s Pod一致的命名规则，即</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;cluster_name&gt;-&lt;seq&gt;
</span></span></code></pre></div><p>Node的名称会在集群资源分配阶段确定下来，每个节点都会分配到一个序号<code>${seq}</code>，从0开始的自增整型。这个与k8s中StatefulSet的命名规则保持一致，因此能够做到云上云下一致管理。</p>
<p>例如，集群<code>pg-test</code>有三个节点，那么这三个节点就可以命名为：</p>
<p><code>pg-test-0</code>, <code>pg-test-1</code>和<code>pg-test2</code>。</p>
<p>节点的命名，在整个集群的生命周期中保持不变，便于监控与管理。</p>
<h3 id="实例命名">实例命名</h3>
<p>对于数据库来说，通常都会采用独占式部署方式，一个实例占用整个机器节点。PG实例与Node是一一对应的关系，因此可以简单地采用Node的标识符作为Instance的标识符。例如，节点<code>pg-test-1</code>上的PG实例名即为：<code>pg-test-1</code>，以此类推。</p>
<p>采用独占部署的方式有很大优势，一个节点即一个实例，这样能最小化管理复杂度。混部的需求通常来自资源利用率的压力，但虚拟机或者云平台可以有效解决这种问题。通过vm或pod的抽象，即使是每个redis（1核1G）实例也可以有一个独占的节点环境。</p>
<p>作为一种约定，每个集群中的0号节点（Pod），会作为默认主库。因为它是初始化时第一个分配的节点。</p>
<h3 id="服务命名">服务命名</h3>
<p>通常来说，数据库对外提供两种基础服务：<code>primary</code> 读写服务，与<code>standby</code>只读副本服务。</p>
<p>那么服务就可以采用一种简单的命名规则：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">&lt;cluster_name&gt;-&lt;service_name&gt;</span>
</span></span></code></pre></div><p>例如这里<code>pg-test</code>集群就包含两个服务：读写服务<code>pg-test-primary</code>与只读副本服务<code>pg-test-standby</code>。</p>
<p>还有一种流行的实例/节点命名规则：<code>&lt;cluster_name&gt;-&lt;service_role&gt;-&lt;sequence&gt;</code>，即把数据库的主从身份嵌入到实例名称中。这种命名方式有好处也有坏处。好处是管理的时候一眼就能看出来哪一个实例/节点是主库，哪些是从库。缺点是一但发生Failover，实例与节点的名称必须进行调整才能维持一执性，这就带来的额外的维护工作。此外，服务与节点实例是相对独立的概念，这种Embedding命名方式扭曲了这一关系，将实例唯一隶属至服务。但复杂的场景下这一假设可能并不满足。例如，集群可能有几种不同的服务划分方式，而不同的划分方式之间很可能会出现重叠。</p>
<ul>
<li>可读从库（解析至包含主库在内的所有实例）</li>
<li>同步从库（解析至采用同步提交的备库）</li>
<li>延迟从库，备份实例（解析至特定具体实例）</li>
</ul>
<p>因此，不要把服务角色嵌入实例名称，而是在服务中维护目标实例列表。</p>
<h2 id="小结">小结</h2>
<p>命名属于相当经验性的知识，很少有地方会专门会讲这件事。这种“细节”其实往往能体现出命名者的一些经验水平来。</p>
<p>标识对象不仅仅可以通过ID和名称，还可以通过标签（Label）和选择器（Selector）。实际上这一种做法会更具有通用性和灵活性，本系列下一篇文章（也许）将会介绍数据库对象的标签设计与管理。</p>
<blockquote>
<p><a href="https://mp.weixin.qq.com/s/_C6cxh1e-pxqB_6viJPa8w">WeChat Column</a></p>
</blockquote>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-6c9b5e7c5ee28bba5543aa06492d809a">PostgreSQL的KPI</h1>
	<div class="lead">管数据库和管人差不多，都需要定KPI（关键性能指标）。那么数据库的KPI是什么？本文介绍了一种衡量PostgreSQL负载的方式：使用一种单一横向可比，与负载类型和机器类型基本无关的指标，名曰<strong>PG Load（PG负载）</strong>。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>） | <a href="https://mp.weixin.qq.com/s/bG6KG7mmu4K7JMYMI34zCQ">微信公众号</a></b> |
        
		<time datetime="2020-05-29" class="text-muted">2020年05月29日</time>
        
	</div>
	<p>管数据库和管人差不多，都需要定KPI（关键性能指标）。那么数据库的KPI是什么？本文介绍了一种衡量PostgreSQL负载的方式：使用一种单一横向可比，与负载类型和机器类型基本无关的指标，名曰<strong>PG Load（PG负载）</strong>。</p>
<hr>
<h2 id="0x01-introduction">0x01 Introduction</h2>
<p>在现实生产中，经常会有衡量数据库性能与负载，评估数据库水位的需求。一种最朴素的形式就是，能不能有一个类似于KPI的单一指标，能直接了当地告诉用户他心爱的数据库负载有没有超过警戒线？工作量到底饱和不饱和？</p>
<p>当然这里其实隐含着一个重要信息，即用户期待的负载指标是一个<strong>饱和度（Saturation）<strong>指标，所谓饱和度，即服务容量有多”满“，通常是系统中目前最为受限的某种资源的某个具体指标的度量。通常来说，0%的饱和度意味着系统完全空闲，100%的饱和度意味着满载，系统在达到100%利用率前就会出现性能的严重下降，因此设定指标时还需要包括一个</strong>利用率目标</strong>，或者说<strong>水位红线、黄线</strong>，当系统瞬时负载超过红线时应当触发告警，长期负载超过黄线时应当进行扩容。</p>
<p>不幸的是，定义系统有多”饱和“并不是一件容易的事情，往往需要借助某些间接指标。评估一个数据库的负载程度，传统上通常会基于这样几类指标进行综合评估：</p>
<ul>
<li>
<p>流量：每秒查询数量QPS，或每秒事务数量TPS。</p>
</li>
<li>
<p>延迟：查询平均响应时间 Query RT，或事务平均响应时间Xact RT</p>
</li>
<li>
<p>饱和度：机器负载（Load），CPU使用率，磁盘读写带宽饱和度，网卡IO带宽饱和度</p>
</li>
<li>
<p>错误：数据库客户端连接排队</p>
</li>
</ul>
<p>这些指标对于数据库性能评估都很有参考意义，但它们也都存在各式各样的问题。</p>
<hr>
<h2 id="0x02-常用评估指标的问题">0x02 常用评估指标的问题</h2>
<p>让我们来看一看，这些现有的常用指标都有哪些问题。</p>
<p>第一个Pass的当然是错误类指标，譬如连接池排队。错误类指标最大的问题就是，当错误出现时，饱和度可能已经没有意义了。<strong>评估饱和度的一个重要原因就是用于预防系统过载，如果系统已经过载大量报错，那么使用错误现象反过来定义饱和度是没有意义的</strong>。此外，错误类指标难以精确量化。我们只能说：当连接池出现排队时，数据库负载比较大；队列越长，负载越大；没有排队时，数据库负载不怎么大，仅此而已。这样的定义当然也无法让人满意。</p>
<p>第二个Pass的则是系统层（机器级别）指标，数据库运行在机器上，CPU使用率，IO使用率这样的指标与数据库负载程度密切相关，<strong>如果CPU和IO是瓶颈，理论上当然是可以直接使用瓶颈资源的饱和度指标</strong>作为数据库的饱和指标，但这一点并非总是成立的，有可能系统瓶颈在于数据库本身。而且严格来说它们是机器的KPI而不是DB的KPI，<strong>评估数据库负载时当然可以参照系统层的指标，但DB层也应该有本层的评估指标</strong>。要先有数据库本身的饱和度指标，才可以去比较底层资源和数据库本身到底谁先饱和谁是瓶颈。这条原则同样适用于应用层观察到的指标。</p>
<p>流量类的指标很有潜力，特别是QPS，TPS这样的指标相当具有代表性。但这些指标也存在问题。一个数据库实例上的查询往往是五花八门各式各样的，一个耗时10微秒的查询和一个10秒的查询在统计时都被算为一个Q，<strong>类似于QPS这样的指标无法进行横向比较，只有比较粗略的参考意义</strong>，甚至当查询类型发生变化时，都无法和自己的历史数据进行纵向比较。此外也很难针对QPS、TPS这样的指标设置利用率目标，同一个数据库执行<code>SELECT 1</code>可以打到几十万的QPS，但执行复杂SQL时可能就只能打到几千的QPS。不同负载类型和机器硬件会对数据库的QPS上限产生显著影响，只有当一个数据库上的查询都是高度单一同质且没有复杂变化的条件下，QPS才有参考意义，在这种苛刻条件下倒是可以通过压力测试设定一个QPS的水位目标。</p>
<p>比起QPS/TPS，RT（响应时间 Response Time）这样的指标反而更具有参考价值。因为响应时间增加往往是系统饱和的前兆。根据经验法则，数据库的负载越大，查询与事务的平均响应时间也会越高。RT相比QPS的一个优势是**，RT是可以设置一个利用率目标的**，比如可以为RT设定一个绝对阈值：不允许生产OLTP库上出现RT超过1ms的慢查询。但QPS这样的指标就很难画出红线来。不过，RT也有自己的问题。第一个问题是它依然是定性而非定量的，延迟增加只是系统饱和的预警，但没法用来精确衡量系统的饱和度。第二个问题通常能从数据库与中间件获取到的RT统计指标都是平均值，但真正起到预警效果的有可能是诸如P99，P999这样的统计量。</p>
<p>这里把常用指标都批判了一番，到底什么样的指标适合作为数据库本身的饱和度呢？</p>
<hr>
<h2 id="0x03-衡量pg的负载">0x03 衡量PG的负载</h2>
<p>我们不妨参考一下**机器负载（Node Load）<strong>和</strong>CPU利用率（CPU Utilization）**的评估指标是如何设计的。</p>
<h3 id="机器负载node-load">机器负载（Node Load）</h3>
<p>想要看到机器的负载水平，可以在Linux系统中使用<code>top</code>命令。<code>top</code>命令的第一行输出就醒目地打印出当前机器1分钟，5分钟，15分钟的<strong>平均负载水平</strong>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ top -b1
</span></span><span style="display:flex;"><span>top - 19:27:38 up 18:49,  <span style="color:#0000cf;font-weight:bold">1</span> user,  load average: 1.15, 0.72, 0.71
</span></span></code></pre></div><p>这里<code>load average</code>后面的三个数字分别表示最近1分钟，5分钟，15分钟系统的平均负载水平。</p>
<p>那么这个数字到底是什么意思呢？简单的解释是，这个数字越大机器越忙。</p>
<p>在单核CPU的场景下，Node Load（以下简称负载）是一个非常标准的饱和度指标。对于单核CPU，负载为0时CPU处于完全空闲的状态，负载为1（100%）时，CPU正好处于满载工作的状态。负载大于100%时，超出100%部分比例的任务正在排队。</p>
<p>Node Load也有自己的<strong>利用率目标</strong>，通常的经验是在单核情况下：0.7（70%）是黄线，意味着系统有问题，需要尽快检查；1.0（100%）是红线，负载大于1意味着进程开始堆积，需要立即着手处理。5.0（500%）是死线，意味着系统基本上已经堵死了。</p>
<p>对于多核CPU，事情稍微有点不一样。假设有n个核，那么当系统负载为n时，所有CPU都处于满载工作的状态；而当系统负载为n/2时，姑且可以认为一半CPU核正在满载运行。因而48核CPU的机器满载时的负载为48。总的来说，如果我们把机器负载除以机器的CPU核数，得到的指标就与单核场景下保持一致了（0%空载，100%满载）。</p>
<h3 id="cpu利用率cpu-utilization">CPU利用率（CPU Utilization）</h3>
<p>另一个很有借鉴意义的指标是<strong>CPU利用率（CPU Utilization）</strong>。CPU利用率其实是通过一个简单的公式计算出来的，对于单核CPU：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>- <span style="color:#000">irate(node_cpu_seconds_total{mode=&#34;idle&#34;}[1m]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这里<code>node_cpu_seconds_total{mode=&quot;idle&quot;}</code>是一个计数器指标，表示CPU处于空闲状态的总时长。<code>irate</code>函数会用该指标对时间进行求导，得出的结果是，每秒CPU处于空闲状态的时长，换句话说也就是CPU空闲率。用1减去该值就得到了CPU的利用率。</p>
<p>对于多核CPU来说，只需要把每个CPU核的利用率加起来，除以CPU的核数，就可以得到CPU的整体利用率。</p>
<p>那么这两个指标对于PG的负载又有什么借鉴意义呢？</p>
<h3 id="数据库负载pg-load">数据库负载（PG Load）</h3>
<p>PG的负载是不是也可以采用类似于CPU利用率和机器负载的方式来定义？当然可以，而且这是一个极棒的主意。</p>
<p>让我们先来考虑单进程情况下的PG负载，假设我们需要这样一个指标，当该PG进程完全空闲时负载因子为0，当该进程处于满载状态时负载为1（100%）。类比CPU利用率的定义，我们可以使用“<em><strong>单个PG进程处于活跃状态的时长占比</strong></em>”来表示“单个PG后端进程的利用率”。</p>
<p>如图1所示，在一秒的统计周期内，PG处于活跃（执行查询或者执行事务）状态的时长为0.6秒，那么这一秒内的PG负载就是60%。如果这个唯一的PG进程在整个统计周期中都处于忙碌状态，而且还有0.4秒的任务在排队，如那么就可以认为PG的负载为140%。</p>
<p><img src="../img/pg-load-fig.png"></p>
<p>对于并行场景，计算方法与多核CPU的利用率类似，首先把所有PG进程在统计周期（1s）内处于活跃状态的时长累加，然后除以“<strong>可用的PG进程/连接数</strong>”，或者说“<strong>可用并行数</strong>”，即可得到PG本身的利用率指标，如图3所示。两个PG后端进程分别有200ms+400ms与800ms的活跃时长，那么整体的负载水平为：<code>(0.2s + 0.4s + 0.8s) / 1s / 2 = 70%</code></p>
<p>总结一下，某一段时间内PG的负载可以定义为：</p>
<p><code>pg_load = pg_active_seconds / time_peroid / parallel  </code></p>
<ul>
<li>
<p><code>pg_active_seconds</code>是该时间段内所有PG进程处于活跃状态的时长之和。</p>
</li>
<li>
<p><code>time_peroid</code>是负载计算的统计周期，通常为1分钟，5分钟，15分钟，以及实时（小于10秒）。</p>
</li>
<li>
<p><code>parallel </code>是PostgreSQL的可用并行数，后面会详细解释。</p>
</li>
</ul>
<p>因为前两项之商实际上就是一段时间内的每秒活跃时长总数，因此这个公式进一步可以简化为活跃时长对时间的导数除以可用并行数，即：</p>
<p><code>rate(pg_active_seconds[time_peroid]) / parallel </code></p>
<p><code>time_peroid</code>通常是固定的常量（1，5，15分钟），所以问题就是如何获取PG进程活跃总时长<code>pg_active_seconds</code>这个指标，以及如何评估计算数据库可用并行数<code>max_parallel </code>了。</p>
<hr>
<h2 id="0x04-计算pg的负载饱和度">0x04 计算PG的负载饱和度</h2>
<h3 id="事务还是查询"><strong>事务还是查询？</strong></h3>
<p>当我们说数据库进程 活跃/空闲 时，究竟在说什么？ <strong>PG处于活跃状态，到底是什么意思</strong>？如果PG后端进程正在执行查询，那么当然可以认为PG正处于忙碌状态。但如果如上图4所示，PG进程正在执行一个交互式事务，但没有实际执行查询，即所谓的“Idle in Transaction”状态，又应该怎么计算“活跃时长”呢？图4中两个查询中空闲的那200ms时间。那么这段时间应该算作“活跃”，还是算作“空闲”呢？</p>
<p><strong>这里的核心问题是怎么定义活跃状态</strong>：数据库进程位于事务中算活跃，还是只有当实际执行查询时才算活跃。对于没有交互式事务的场景，一个查询就是一个事务，用哪种方式都一样，但对于多语句，特别是交互式的多语句事务，这两者就有比较明显的区别了。从资源使用的角度看，没有执行查询也就意味着没有消耗数据库本身的资源。但空闲着的事务本身会占用连接导致连接无法复用，Idle In Transaction本身也应当是一种极力避免的情况。总的来说，这两种定义方式都可以，使用事务的方式会略微高估应用负载，但从负载评估的角度可能会更为合适。</p>
<h3 id="如何获取活跃时长"><strong>如何获取活跃时长</strong></h3>
<p>决定了数据库后端进程的活跃定义后，第二个问题就是，如何获取一段时间的数据库活跃时长？不幸的是在PG中，用户很难通过数据库本身获取这一性能指标。PG提供了一个系统视图：<code>pg_stat_activity</code>，可以看到当前运行着的Postgres进程里列表，但这是一个时间点快照，只能大致告诉在当前时刻，数据库的后端进程中有多少个处于活跃状态，有多少个处于空闲状态。统计一段时间内数据库处于活跃状态的时长，就成了一个难题。一种解决方案是使用类似于Load的计算方式，通过周期性地采样PG中活跃进程的数量，计算出一个负载指标来。不过，这里有更好的办法，但是需要中间件的协助参与。</p>
<p>数据库中间件对于性能监控非常重要，因为很多指标数据库本身并没有提供，只有通过中间件才能暴露出来。以Pgbouncer为例，Pgbouncer在内部维护了一系列统计计数器，使用<code>SHOW STATS</code>可以打印出这些指标，诸如：</p>
<ul>
<li>total_xact_count：总共执行了多少个事务</li>
<li>total_query_count：总共执行了多少个查询</li>
<li>total_xact_time：总共花费在事务执行的时长</li>
<li>total_query_time：总共花费在查询执行上的时长</li>
</ul>
<p>这里<code>total_xact_time</code>就是我们需要的数据，它记录了Pgbouncer中间件中花费在某个数据库上的事务总耗时。我们只需要用这个指标对时间求导，就可以得到想要的数据：每秒活跃时长占比。</p>
<p>这里使用Prometheus的PromQL表达计算逻辑，首先对事务耗时计数器求导，分别算出其1分钟，5分钟，15分钟，以及实时粒度（最近两次采样点之间）上的<strong>每秒活跃时长</strong>。再上卷求和，将数据库层次的指标上卷为实例级别的指标。（连接池<code>SHOW STATS</code>这里的统计指标是以数据库为单位的，因此在计算实例级别的总活跃时长时，应当上卷求和，消除数据库维度的标签：<code>sum without(datname)</code>）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">record</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg:ins:xact_time_realtime</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sum without (datname) (irate(pgbouncer_stat_total_xact_time{}[1m]))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">record</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg:ins:xact_time_rate1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sum without (datname) (rate(pgbouncer_stat_total_xact_time{}[1m]))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">record</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg:ins:xact_time_rate5m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sum without (datname) (rate(pgbouncer_stat_total_xact_time{}[5m]))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">record</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg:ins:xact_time_rate15m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sum without (datname) (rate(pgbouncer_stat_total_xact_time{}[15m]))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这样计算得到的结果指标已经可以相对本身进行纵向比较，并在同样规格的实例间进行横向比较了。而且无论数据库的负载类型怎样，都可以使用这个指标。</p>
<p>不过<strong>不同规格的实例，仍然没法使用这个指标进行对比</strong>。比如对于单核单连接PG，满载时每秒活跃时长可能是1秒，也就是100%利用率。而对于64核64连接的PG，满载时每秒活跃时长是64秒，那么就是6400%的利用率。因此，还需要一个归一化的处理，那么问题又来了。</p>
<h3 id="可用并行数如何定义">可用并行数如何定义？</h3>
<p>不同于CPU利用率，PG的可用并行数并没有一个清晰的定义，而且跟负载类型有一些微妙的关系。但能够确定的是，在一定范围内，<strong>最大可用并行与CPU的核数呈粗略的线性关系</strong>。当然这个结论的前提是数据库最大连接数显著超过CPU核数，如果在64核的CPU上只允许数据库建立30条连接，那么可以肯定最大可用并行就是30而不是CPU核数64。软件的并行最终还是要由硬件的并行度来支撑，因此我们可以简单的使用实例的CPU核数作为可用并行数。</p>
<p>在64核的CPU上运行64个活跃PG进程，则其负载为（6400% / 64 = 100%）。同理运行128个活跃PG进程，负载就是（12800% / 64 = 200%）。</p>
<p>那么利用上面计算得到的每秒活跃时长指标，就可以计算出实例级别的PG负载指数了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">record</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg:ins:load0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">pg:ins:xact_time_realtime / on (ip) group_left()  node:ins:cpu_count</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">record</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg:ins:load1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg:ins:xact_time_rate1m  / on (ip) group_left()  node:ins:cpu_count</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">record</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg:ins:load5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg:ins:xact_time_rate5m  / on (ip) group_left()  node:ins:cpu_count</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">record</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg:ins:load15</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg:ins:xact_time_rate15m  / on (ip) group_left()  node:ins:cpu_count</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="pg-load的另一种解释">PG LOAD的另一种解释</h3>
<p>如果我们仔细审视PG Load的定义，其实可以发现每秒活跃时长这个指标，其实可以粗略等价于：TPS x XactRT，或者QPS x Query RT。这个也很好理解，假设我QPS为1000，每个查询RT为1ms，则每秒花费在查询上的时间为 1000 * 1ms = 1s。</p>
<p>因此，PG Load可以视为一个由三个核心指标复合而成的衍生指标：<code>tps * xact_rt /  cpu_count</code></p>
<p>TPS，RT用于负载评估都有各自的问题，但它们通过简单的乘法结合成一个新的复合指标，一下子就显示出了神奇的力量。（尽管实际上是通过其他更准确的方式计算出来的）</p>
<hr>
<h2 id="0x05-pg-load的实际效果">0x05 PG Load的实际效果</h2>
<p>接下来，我们来看一下PG Load用于实际生产环境的表现。</p>
<p>PG Load最直接的作用有两个，告警以及容量评估。</p>
<h3 id="case-1-用于报警慢查询堆积导致的服务不可用">Case 1: 用于报警：慢查询堆积导致的服务不可用</h3>
<p>下图是一次生产事故的现场，由于某业务上线了一个慢查询，瞬间导致连接池被慢查询占据，发生堆积。可以看出PG Load和RT都很及时地反映出了故障的情况，而TPS看上去则是掉了一个坑，并不是特别显眼。</p>
<p>从效果上看，PG Load1与PG Load0（实时负载）是一个相当灵敏的指标，对于大多数与压力负载有关的故障都能及时准确作出反应。所以被我们采纳为核心报警指标。</p>
<p>PG Load的利用率目标有一些经验值：黄线通常为50%，即需要引起关注的阈值；红线通常为70%，即报警线，需要立刻采取行动的阈值；500%或更高通常意味着这个实例已经被打崩了。</p>
<p><img src="/img/blog/pg/pg-load-compare.png"></p>
<h3 id="case-2用于水位评估与容量规划">Case 2：用于水位评估与容量规划</h3>
<p>比起报警，水位评估与容量规划更像是PG Load的核心用途。毕竟报警之类的的需求还是可以通过延迟，排队连接等指标来满足的。</p>
<p>这里，PG集群的15分钟负载是一个很好的参考值。通过这个指标的历史均值，峰值，以及其他一些统计量，我们可以很轻松地看出哪些集群处于高负载状态需要扩容，哪些集群处于低资源利用率状态需要缩容。</p>
<p>CPU利用率是另一个很重要的容量评估指标。我们可以看出，PG Load与CPU Usage有着很密切的关系。不过相比CPU使用率，PG Load更为纯粹地反映了数据库本身的负载水平，滤除了机器上的无关负载，也可以滤除掉数据库维护工作（备份，清理，垃圾回收）产生的杂音，更为丝滑平顺。因此非常适合用于容量评估。</p>
<p>当系统负载长期位于30%~50%时，就应该考虑进行扩容了。</p>
<p><img src="/img/blog/pg/pg-load-cluster.png"></p>
<hr>
<h2 id="0x06-结论">0x06 结论</h2>
<p>本文介绍了一种定量衡量PG负载的方式，即PG Load指标</p>
<p>该指标可以简单直观地反映数据库实例的负载水平</p>
<p>该指标非常适合作容量评估之用，也可以作为核心报警指标。</p>
<p>该指标可以基本无视负载类型与机器类型，进行纵向历史比较与横向水位比较。</p>
<p>该指标可以通过简单的方式计算得出，即每秒后端进程活跃总时长除以可用并发数。</p>
<p>该指标所需数据需要从数据库中间件获取</p>
<p>PG Load的0代表空载，100%代表满载。黄线经验值为50%，红线经验值为70%，</p>
<p>PG Load是一个好指标👍</p>
<blockquote>
<p><a href="https://mp.weixin.qq.com/s/bG6KG7mmu4K7JMYMI34zCQ">WeChat Column</a></p>
</blockquote>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-abe231067c0dd3bdd1f2c8820ed1c6fa">在线修改PG字段类型</h1>
	<div class="lead">如何在线修改PostgreSQL中的字段类型？一种通用方法</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2020-01-30" class="text-muted">2020年01月30日</time>
        
	</div>
	<h2 id="场景">场景</h2>
<p>在数据库的生命周期中，有一类需求是很常见的，修改字段类型。例如：</p>
<ul>
<li>使用<code>INT</code>作为主键，结果发现业务红红火火，INT32的21亿序号不够用了，想要升级为<code>BIGINT</code></li>
<li>使用<code>BIGINT</code>存身份证号，结果发现里面有个<code>X</code>需要改为<code>TEXT</code>类型。</li>
<li>使用<code>FLOAT</code>存放货币，发现精度丢失，想要修改为Decimal</li>
<li>使用<code>TEXT</code>存储JSON字段，想用到PostgreSQL的JSON特性，修改为JSONB类型。</li>
</ul>
<p>那么，如何应对这种需求呢？</p>
<h2 id="常规操作">常规操作</h2>
<p>通常来说，<code>ALTER TABLE</code>可以用来修改字段类型。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">col_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TYPE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_type</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">expression</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>修改字段类型通常会<strong>重写</strong>整个表。作为一个特例，如果修改后的类型与之前是<a href="https://www.postgresql.org/docs/13/sql-createcast.html">二进制兼容</a>的，则可以跳过<strong>表重写</strong>的过程，但是如果列上有索引，<strong>索引还是需要重建的</strong>。二进制兼容的转换可以使用以下查询列出。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">typname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">typname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">To</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_cast</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">join</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_type</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">castsource</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">join</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_type</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">casttarget</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">castmethod</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;b&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>刨除PostgreSQL内部的类型，二进制兼容的类型转换如下所示</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#000">text</span>     <span style="color:#a40000">→</span> <span style="color:#000">varchar</span> 
</span></span><span style="display:flex;"><span><span style="color:#000">xml</span>      <span style="color:#a40000">→</span> <span style="color:#000">varchar</span> 
</span></span><span style="display:flex;"><span><span style="color:#000">xml</span>      <span style="color:#a40000">→</span> <span style="color:#000">text</span>    
</span></span><span style="display:flex;"><span><span style="color:#000">cidr</span>     <span style="color:#a40000">→</span> <span style="color:#000">inet</span>    
</span></span><span style="display:flex;"><span><span style="color:#000">varchar</span>  <span style="color:#a40000">→</span> <span style="color:#000">text</span>    
</span></span><span style="display:flex;"><span><span style="color:#000">bit</span>      <span style="color:#a40000">→</span> <span style="color:#000">varbit</span>  
</span></span><span style="display:flex;"><span><span style="color:#000">varbit</span>   <span style="color:#a40000">→</span> <span style="color:#000">bit</span>     
</span></span></code></pre></div><p>常见的二进制兼容类型转换基本就是这两种：</p>
<ul>
<li>
<p>varchar(n1) →  varchar(n2)  （n2 ≥ n1）（比较常用，扩大长度约束不会重写，缩小会重写）</p>
</li>
<li>
<p>varchar ↔  text （同义转换，基本没啥用）</p>
</li>
</ul>
<p>也就是说，其他的类型转换，都会涉及到表的<strong>重写</strong>。大表的重写是很慢的，从几分钟到十几小时都有可能。一旦发生<strong>重写</strong>，表上就会有<code>AccessExclusiveLock</code>，阻止一切并发访问。</p>
<p>如果是一个玩具数据库，或者业务还没上线，或者业务根本不在乎停机多久，那么整表重写的方式当然是没有问题的。但绝大多数时候，业务根本不可能接受这样的停机时间。所以，我们需要一种在线升级的办法。在<strong>不停机</strong>的情况完成字段类型的改造。</p>
<h2 id="基本思路">基本思路</h2>
<p>在线改列的基本原理如下：</p>
<ul>
<li>
<p>创建一个新的临时列，使用新的类型</p>
</li>
<li>
<p>旧列的数据同步至新的临时列</p>
<ul>
<li>存量同步：分批更新</li>
<li>增量同步：更新触发器</li>
</ul>
</li>
<li>
<p>处理列依赖：索引</p>
</li>
<li>
<p>执行切换</p>
<ul>
<li>
<p>处理列以来：约束，默认值，分区，继承，触发器</p>
</li>
<li>
<p>通过列重命名的方式完成新旧列切换</p>
</li>
</ul>
</li>
</ul>
<p>在线改造的问题在于<strong>锁粒度拆分</strong>，将原来一次<strong>长期重锁</strong>操作，等效替代为多个<strong>瞬时轻锁</strong>操作。</p>
<p>原来<code>ALTER TYPE</code>重写过程中，会加上<code>AccessExclusiveLock</code>，阻止一切并发访问，持续时间几分钟到几天。</p>
<ul>
<li>添加新列：瞬间完成：<code>AccessExclusiveLock</code></li>
<li>同步新列-增量：创建触发器，瞬间完成，锁级别低。</li>
<li>同步新列-存量：分批次UPDATE，少量多次，每次都能<strong>快速完成</strong>，锁级别低。</li>
<li>新旧切换：锁表，瞬间完成。</li>
</ul>
<p>让我们用<code>pgbench</code>的默认用例来说明在线改列的基本原理。假设我们希望在<code>pgbench_accounts</code>有访问的情况下修改<code>abalance</code>字段类型，从<code>INT</code>修改为<code>BIGINT</code>，那么应该如何处理呢？</p>
<ol>
<li>首先，为<code>pgbench_accounts</code>创建一个名为<code>abalance_tmp</code>，类型为<code>BIGINT</code>的新列。</li>
<li>编写并创建列同步触发器，触发器会在每一行被插入或更新前，使用旧列<code>abalance</code>同步到</li>
</ol>
<p>详情如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 操作目标：升级 pgbench_accounts 表普通列 abalance 类型：INT -&gt; BIGINT
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 添加新列：abalance_tmp BIGINT
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ADD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_tmp</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 创建触发器函数：保持新列数据与旧列同步
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sync_pgbench_accounts_abalance</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abalance_tmp</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abalance</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;plpgsql&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 完成整表更新，分批更新的方式见下
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_tmp</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 不要在大表上运行这个
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 创建触发器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tg_sync_pgbench_accounts_abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BEFORE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXECUTE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sync_pgbench_accounts_abalance</span><span style="color:#000;font-weight:bold">();</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 完成列的新旧切换，这时候数据同步方向变化 旧列数据与新列保持同步
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LOCK</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXCLUSIVE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">MODE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DISABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tg_sync_pgbench_accounts_abalance</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RENAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_old</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RENAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_tmp</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RENAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_old</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_tmp</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tg_sync_pgbench_accounts_abalance</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 确认数据完整性
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance_new</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abalance</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 清理触发器与函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sync_pgbench_accounts_abalance</span><span style="color:#000;font-weight:bold">();</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tg_sync_pgbench_accounts_abalance</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbench_accounts</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="注意事项">注意事项</h2>
<ol>
<li>ALTER TABLE的MVCC安全性</li>
<li>列上如果有约束？（PrimaryKey、ForeignKey，Unique，NotNULL）</li>
<li>列上如果有索引？</li>
<li>ALTER TABLE导致的主从复制延迟</li>
</ol>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-d657deb9b88e3f9bf3f7a70c003b7ca8">故障档案：PG安装Extension导致无法连接</h1>
	<div class="lead">今天遇到一个比较有趣的Case，客户报告说数据库连不上了，发现是扩展导致的。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2019-06-13" class="text-muted">2019年06月13日</time>
        
	</div>
	<p>今天遇到一个比较有趣的Case，客户报告说数据库连不上了。报这个错：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql: FATAL:  could not load library <span style="color:#4e9a06">&#34;/export/servers/pgsql/lib/pg_hint_plan.so&#34;</span>: /export/servers/pgsql/lib/pg_hint_plan.so: undefined symbol: RINFO_IS_PUSHED_DOWN
</span></span></code></pre></div><p>当然，这种错误一眼就知道是插件没编译好，报符号找不到。因此数据库后端进程在启动时尝试加载<code>pg_hint_plan</code>插件时就GG了，报FATAL错误直接退出。</p>
<p>通常来说这个问题还是比较好解决的，这种额外的扩展通常都是在<code>shared_preload_libraries</code>中指定的，只要把这个扩展名称去掉就好了。</p>
<h2 id="结果">结果……</h2>
<p>客户说是通过<code>ALTER ROLE|DATABASE SET session_preload_libraries = pg_hint_plan</code>的方式来启用扩展的。</p>
<p>这两条命令会在使用特定用户，或连接到特定数据库时覆盖系统默认参数，去加载<code>pg_hint_plan</code>插件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#000">ALTER</span> <span style="color:#000">DATABASE</span> <span style="color:#000">postgres</span> <span style="color:#000">SET</span> <span style="color:#000">session_preload_libraries</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pg_hint_plan</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ALTER</span> <span style="color:#000">ROLE</span> <span style="color:#000">postgres</span> <span style="color:#000">SET</span> <span style="color:#000">session_preload_libraries</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pg_hint_plan</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>如果是这样的话，也是可以解决的，通常来说只要有其他的用户或者其他的数据库可以正常登陆，就可以通过<code>ALTER TABLE</code>语句把这两行配置给去掉。</p>
<p>但坏事就坏在，所有的用户和数据库都配了这个参数，以至于没有任何一条连接能连到数据库了。</p>
<p>这种情况下，数据库就成了植物人状态，postmaster还活着，但任何新创建的后端服务器进程都会因为扩展失效自杀……。即使<code>dropdb</code>这种外部自带的二进制命令也无法工作。</p>
<h2 id="于是">于是……</h2>
<p>无法建立到数据库的连接，那么常规手段就都失效了……，只能Dirty hack了。</p>
<p>如果我们从二进制层面把用户和数据库级别的配置项给抹掉，那么就可以连接到数据库，把扩展给清理掉了。</p>
<p>DB与Role级别的配置存储在系统目录<code>pg_db_role_setting</code>中，这个表有着固定的OID = 2964，存储在数据目录下<code>global/2964</code>里。关闭数据库，使用二进制编辑器打开<code>pg_db_role_setting</code>对应的文件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># vim打开后使用 :%!xxd 编辑二进制</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 编辑完成后使用 :%!xxd -r转换回二进制，再用:wq保存</span>
</span></span><span style="display:flex;"><span>vi <span style="color:#4e9a06">${</span><span style="color:#000">PGDATA</span><span style="color:#4e9a06">}</span>/global/2964
</span></span></code></pre></div><p><img src="/img/blog/pg/pit-extension.png"></p>
<p>这里，将所有的<code>pg_hint_plan</code>字符串都替换成等长的<code>^@</code>二进制零字符即可。当然如果不在乎原来的配置，更省事的做法是直接把这个文件截断成零长文件。</p>
<p>重启数据库，终于又能连接上了。</p>
<h2 id="复现">复现</h2>
<p>这个问题复现起来也非常简单，初始化一个新数据库实例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>initdb -D /pg/test -U postgres <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> pg_ctl -D /pg/test start
</span></span></code></pre></div><p>然后执行以下语句，就可以体会这种酸爽了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">psql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;ALTER ROLE postgres SET session_preload_libraries = pg_hint_plan;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="教训">教训……</h2>
<ol>
<li>安装扩展后，一定要先验证扩展本身可以正常工作，再<strong>启用</strong>扩展</li>
<li>凡事留一线，日后好相见：一个紧急备用的纯洁的su，或者一个无污染的可连接数据库，都不至于这么麻烦。</li>
</ol>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-48a755c71a681b6878f489b26311a081">PostgreSQL 常见复制拓扑方案</h1>
	<div class="lead">复制是系统架构中的核心问题之一。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2019-03-29" class="text-muted">2019年03月29日</time>
        
	</div>
	<p>复制是系统架构中的核心问题之一。</p>
<h2 id="集群拓扑">集群拓扑</h2>
<p>假设我们使用4单元的标准配置：主库，同步从库，延迟备库，远程备库，分别用字母M,S,O,R标识。</p>
<ul>
<li><strong>M</strong>：<strong>M</strong>aster, <strong>M</strong>ain, Primary, Leader, 主库，权威数据源。</li>
<li><strong>S</strong>: <strong>S</strong>lave, <strong>S</strong>econdary, <strong>S</strong>tandby, <strong>S</strong>ync Replica，同步副本，需要直接挂载至主库</li>
<li><strong>R</strong>: <strong>R</strong>emote <strong>R</strong>eplica, <strong>R</strong>eport instance，远程副本，可以挂载到主库或同步从库上</li>
<li><strong>O</strong>: <strong>O</strong>ffline，离线延迟备库，可以挂载到主库，同步从库，或者远程备库上。</li>
</ul>
<p>依照R和O的挂载目标不同，复制拓扑关系有以下几种选择：</p>
<p><img src="/img/blog/pg/replication-topo.png"></p>
<p>其中，拓扑2具有显著的优越性：</p>
<p>假设采用同步提交，那么为了安全起见，必须有超过一个的同步从库，这样当采用<code>ANY 1</code>或<code>FIRST 1</code>同步提交时，主库不至于因为从库故障而挂掉。因此，离线库O应当直接挂载到主库上：在具体实现细节上：延迟备库可以采用日志传输的方式实现，这样能够将线上库与延迟库解耦。日志归档使用自带的<code>pg_receivewal</code>采用同步的方式（即<code>pg_receivewal</code>作为一个“备库”，而不是离线数据库实例本身）。</p>
<p>另一方面，当使用同步提交时，假设M出现故障，Failover至S，那么S也需要一个同步从库，以免在切换后立刻因为同步提交而Hang住，因此远程备库适合挂载到S上。</p>
<p><img src="/img/blog/pg/replication-topo-good.png"></p>
<p><img src="/img/blog/pg/backup-types.png"></p>
<h2 id="故障恢复">故障恢复</h2>
<p>当故障发生时，我们需要<strong>尽可能快</strong>地将生产系统救回来，例如通过Failover，并在事后<strong>有时间时</strong>恢复原有的拓扑结构。</p>
<ul>
<li>P0：（M）主库失效，应当在秒级到分钟级内恢复</li>
<li>P1：（S）从库失效，影响只读查询，但主库可以先抗，可以容忍分钟级别到小时级别的问题。</li>
<li>P2：（O，R）离线库与远程备库故障，可能没有直接影响，故障容忍范围可以放宽至小时到天级别。</li>
</ul>
<p>![](<img src="../img/replication-topo-restore.png"></p>
<p>当M失效时，会对所有组件产生影响。需要执行故障转移（Failover）将S提升为新的M以便尽快使系统恢复。手工Failover包括两个步骤：Fencing M（由重到轻：关机，关数据库，改HBA，关连接池，暂停连接池）与Promote S，这两个操作都可以通过脚本在很短的时间内完成。Failover之后，系统基本恢复。还需要在事后重新恢复原来的拓扑结构。例如将原有的M通过<code>pg_rewind</code>变为新的从库，将O挂载到新的M上，将R挂载到新的S上；或者在修复M后，通过计划内的Failover再次回归原有拓扑。</p>
<p>当S失效时，会对R产生直接影响。作为一种HotFix，我们可以将R的复制源由S改到M，即可将R的影响修复。同时，通过连接池倒流将S的原有流量分发至其他从库或M，接下来就可以慢慢研究并修复S上的问题了。</p>
<p>当O和R失效时，因为它们既没有很大的直接影响，也没有直属后代，因此只要重做一个即可。</p>
<h2 id="实施方式">实施方式</h2>
<p><a href="https://github.com/Vonng/pg/blob/master/test/README.md">PostgreSQL Testing Environment</a> 这里给出了一个3节点的样例集群，包含了M，S，O三个节点。R节点是S的一种，因此在此略过。</p>
<p>这里，主库直接挂载了两个“从库”，一个是S节点，一个是O节点上的WAL日志归档器。在丢数据容忍度很低的情况下，可以将两者配置为同步从库。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-46f4a828c76bcb305bf3446994999026">温备：使用pg_receivewal</h1>
	<div class="lead">备份有各种各样的策略，物理备份通常可以分为四种。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2019-03-02" class="text-muted">2019年03月02日</time>
        
	</div>
	<p>备份是DBA的安身立命之本，也是数据库管理中最为关键的工作之一。有各种各样的备份，但今天这里讨论的备份都是物理备份。物理备份通常可以分为以下四种：</p>
<ul>
<li>热备（Hot Standby）：与主库一模一样，当主库出现故障时会接管主库的工作，同时也会用于承接线上只读流量。</li>
<li>温备（Warm Standby）：与热备类似，但不承载线上流量。通常数据库集群需要一个延迟备库，以便出现错误（例如误删数据）时能及时恢复。在这种情况下，因为延迟备库与主库内容不一致，因此不能服务线上查询。</li>
<li>冷备（Code Backup）：冷备数据库以数据目录静态文件的形式存在，是数据库目录的二进制备份。便于制作，管理简单，便于放到其他AZ实现容灾。是数据库的最终保险。</li>
<li>异地副本（Remote Standby）：所谓X地X中心，通常指的就是放在其他AZ的热备实例。</li>
</ul>
<p><img src="/img/blog/pg/backup-types.png"></p>
<p>通常我们所说的备份，指的是冷备和温备。它们与热备的重要区别是：它们通常不是最新的。当服务线上查询时，这种滞后是一个缺陷，但对于故障恢复而言，这是一个非常重要的特性。同步的备库是不足以应对所有的问题。设想这样一种情况：一些人为故障或者软件错误把整个数据表甚至整个数据库删除了，这样的变更会立刻应用到同步从库上。这种情况只能通过从延迟温备中查询，或者从冷备重放日志来恢复。因此无论有没有从库，冷/温备都是必须的。</p>
<p>参考：<a href="/zh/blog/admin/replication-plan/">PostgreSQL复制方案</a></p>
<h2 id="温备方案">温备方案</h2>
<p>通常我比较建议采用延时日志传输备库的方式做温备，从而快速响应故障，并通过异地云存储冷备的方式做容灾。</p>
<p>温备方案有一些显著的优势：</p>
<ul>
<li><strong>可靠</strong>：温备实际上在运行过程中，就在不断地进行“恢复测试”，因此只要温备工作正常没报错，你总是能够相信它是一个可用的备份，但冷备就不一定了。同时，采用同步提交<code>pg_receivewal</code>与日志传输的离线实例，一方面能够降低主库因为单一同步从库故障而挂点的风险，另一方面也消除了备库活动影响主库的风险。</li>
<li><strong>管理简单</strong>：温备的管理方式基本与普通从库类似，因此如果已经有了主从配置，部署一个温备是很简单的事；此外，用到的工具都是PostgreSQL官方提供的工具：<code>pg_basebackup</code>与<code>pg_receivewal</code>。温备的延时窗口可以通过参数简单地调整。</li>
<li><strong>响应快速</strong>：在延迟备库的延时窗口内发生的故障（删库），都可以快速地恢复：从延迟备库中查出来灌回主库，或者直接将延迟备库步进至特定时间点并提升为新主库。同时，采用温备的方式，就不用每天或每周从主库上拉去全量备份了，更省带宽，执行也更快。</li>
</ul>
<h3 id="步骤概览">步骤概览</h3>
<p><img src="/img/blog/pg/backu-setup.png"></p>
<h3 id="日志归档">日志归档</h3>
<p>如何归档主库生成的WAL日志，传统上通常是通过配置主库上的<code>archive_command</code>实现的。不过最近版本的PostgreSQL提供了一个相当实用的工具：<code>pg_receivewal</code>（10以前的版本称为<code>pg_receivexlog</code>）。对于主库而言，这个客户端应用看上去就像一个从库一样，主库会不断发送最新的WAL日志，而<code>pg_receivewal</code>会将其写入本地目录中。这种方式相比<code>archive_command</code>的一个显著优势就是，<code>pg_receivewal</code>不会等到PostgreSQL写满一个WAL段文件之后再进行归档，因此可以在同步提交的情况下做到故障不丢数据。</p>
<p><code>pg_receivewal</code>使用起来也非常简单：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># create a replication slot named walarchiver</span>
</span></span><span style="display:flex;"><span>pg_receivewal --slot<span style="color:#ce5c00;font-weight:bold">=</span>walarchiver --create-slot --if-not-exists
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># add replicator credential to /home/postgres/.pgpass 0600</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># start archiving (with proper supervisor/init scritpts)</span>
</span></span><span style="display:flex;"><span>pg_receivewal <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -D /pg/arcwal <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --slot<span style="color:#ce5c00;font-weight:bold">=</span>walarchiver <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --compress<span style="color:#ce5c00;font-weight:bold">=</span>9<span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -d<span style="color:#4e9a06">&#39;postgres://replicator@master.csq.tsa.md/postgres&#39;</span>
</span></span></code></pre></div><p>当然在实际生产环境中，为了更为鲁棒地归档，通常我们会将其注册为服务，并保存一些命令状态。这里给出了生产环境中使用的一个<code>pg_receivewal</code>命令包装：<a href="https://github.com/Vonng/pg/blob/master/test/pkg/walarchiver"><code>walarchiver</code></a></p>
<h3 id="相关脚本">相关脚本</h3>
<p>这里提供了一个初始化PostgreSQL Offline Instance的脚本，可以作为参考：</p>
<p><a href="https://github.com/Vonng/pg/blob/master/test/bin/offline.sh"><code>pg/test/bin/offline.sh</code></a></p>
<h2 id="备份测试">备份测试</h2>
<p>面对故障时如何充满信心？只要备份还在，再大的问题都能恢复。但如何确保你的备份方案真正有效，这就需要我们事先进行充分的测试。</p>
<p>让我们来设想一些故障场景，以及在本方案下应对这些故障的方式</p>
<ul>
<li><code>pg_receive</code>进程终止</li>
<li>离线节点重启</li>
<li>主库节点重启</li>
<li>干净的故障切换</li>
<li>脑裂的故障切换</li>
<li>误删表一张</li>
<li>误删库</li>
</ul>
<p>To be continue</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-3232d7867a0db5797d196e1a182929d8">故障档案：pg_dump导致的连接池污染</h1>
	<div class="lead">有时候，组件之间的相互作用会以微妙的形式表现出来。例如使用pg_dump从连接池中导出数据，就可能产生连接池污染的问题。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-12-11" class="text-muted">2018年12月11日</time>
        
	</div>
	<p>PostgreSQL很棒，但这并不意味着它是Bug-Free的。这一次在线上环境中，我又遇到了一个很有趣的Case：由<code>pg_dump</code>导致的线上故障。这是一个非常微妙的Bug，由Pgbouncer，<code>search_path</code>，以及特殊的<code>pg_dump</code>操作所触发。</p>
<hr>
<h2 id="背景知识">背景知识</h2>
<h3 id="连接污染">连接污染</h3>
<p>在PostgreSQL中，每条数据库连接对应一个后端进程，会持有一些临时资源（状态），在连接结束时会被销毁，包括：</p>
<ul>
<li>本会话中修改过的参数。<code>RESET ALL;</code></li>
<li>准备好的语句。 <code>DEALLOCATE ALL</code></li>
<li>打开的游标。<code>CLOSE ALL;</code></li>
<li>监听的消息信道。<code>UNLISTEN *</code></li>
<li>执行计划的缓存。<code>DISCARD PLANS;</code></li>
<li>预分配的序列号值及其缓存。<code>DISCARD SEQUENCES;</code></li>
<li>临时表。<code>DISCARD TEMP</code></li>
</ul>
<p>Web应用会频繁建立大量的数据库连接，故在实际应用中通常都会使用连接池，复用连接，以减小连接创建与销毁的开销。除了使用各种语言/驱动内置的连接池外，Pgbouncer是最常用的第三方中间件连接池。Pgbouncer提供了一种Transaction Pooling的模式，即：每当客户端事务开始时，连接池会为客户端连接分配一个服务端连接，当事务结束时，服务端连接会被放回到池中。</p>
<p>事务池化模式也存在一些问题，例如<strong>连接污染</strong>。当某个客户端修改了连接的状态，并将该连接放回池中，其他的应用遍可能受到非预期的影响。如下图所示：</p>
<p><img src="/img/blog/pg/pg-dump-failure.png"></p>
<p>假设有四条客户端连接（前端连接）C1、C2、C3、C4，和两条服务器连接（后端连接）S1，S2。数据库默认搜索路径被配置为：<code>app,$user,public</code>，应用知道该假设，并使用<code>SELECT * FROM tbl;</code>的方式，来默认访问模式<code>app</code>下的表<code>app.tbl</code>。现在假设客户端C2在使用了服务器连接S2的过程中，执行了<code>set search_path = ''</code>清空了连接S2上的搜索路径。当S2被另一个客户端C3复用时，C3执行<code>SELECT * FROM tbl</code>时就会因为<code>search_path</code>中找不到对应的表而报错。</p>
<p>当客户端对于连接的假设被打破时，很容易出现各种错误。</p>
<hr>
<h2 id="故障排查">故障排查</h2>
<p>线上应用突然大量报错触发熔断，错误内容为大量的对象（表，函数）找不到。</p>
<p>第一直觉就是连接池被污染了：某个连接在修改完<code>search_path</code>之后将连接放回池中，当这个后端连接被其他前端连接复用时，就会出现找不到对象的情况。</p>
<p>连接至相应的Pool中，发现确实存在连接的<code>search_path</code>被污染的情况，某些连接的<code>search_path</code>被置空了，因此使用这些连接的应用就找不到对象了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql -p6432 somedb
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># show search_path; \watch 0.1</span>
</span></span></code></pre></div><p>在Pgbouncer中使用管理员账户执行<code>RECONNECT</code>命令，强制重连所有连接，<code>search_path</code>重置为默认值，问题解决。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>reconnect somedb
</span></span></code></pre></div><p>不过问题就来了，究竟是什么应用修改了<code>search_path</code>呢？如果问题来源没有排查清楚，难免以后会重犯。有几种可能：业务代码修改，应用的驱动Bug，人工操作，或者连接池本身的Bug。嫌疑最大的当然是手工操作，有人如果使用生产账号用<code>psql</code>连到连接池，手工修改了<code>search_path</code>，然后退出，这个连接就会被放回到生产池中，导致污染。</p>
<p>首先检查数据库日志，发现报错的日志记录全都来自同一条服务器连接<code>5c06218b.2ca6c</code>，即只有一条连接被污染。找到这条连接开始持续报错的临界时刻：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">cat</span> <span style="color:#000">postgresql</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">Tue</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">csv</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">grep</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000">c06218b</span><span style="color:#0000cf;font-weight:bold">.2</span><span style="color:#000">ca6c</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">44</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">42.766</span> <span style="color:#000">CST</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;xxx&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;xxx-xxx&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">182892</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;127.0.0.1:60114&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000">c06218b</span><span style="color:#0000cf;font-weight:bold">.2</span><span style="color:#000">ca6c</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">36</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;SELECT&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">41</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15</span> <span style="color:#000">CST</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">00000</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;duration: 1067.392 ms  statement: SELECT xxxx FROM x&#34;</span><span style="color:#000;font-weight:bold">,,,,,,,,,</span><span style="color:#4e9a06">&#34;app - xx.xx.xx.xx:23962&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">45</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">03.857</span> <span style="color:#000">CST</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;xxx&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;xxx-xxx&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">182892</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;127.0.0.1:60114&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000">c06218b</span><span style="color:#0000cf;font-weight:bold">.2</span><span style="color:#000">ca6c</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">37</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;SELECT&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">41</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15</span> <span style="color:#000">CST</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">368400961</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">ERROR</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">42883</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;function upsert_xxxxxx(xxx) does not exist&#34;</span><span style="color:#000;font-weight:bold">,,</span><span style="color:#4e9a06">&#34;No function matches the given name and argument types. You might need to add explicit type casts.&#34;</span><span style="color:#000;font-weight:bold">,,,,</span><span style="color:#4e9a06">&#34;select upsert_phone_plan(&#39;965+6628&#39;,1,0,0,0,1,0,&#39;2018-12-03 19:00:00&#39;::timestamp)&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">,,</span><span style="color:#4e9a06">&#34;app - 10.191.160.49:46382&#34;</span>
</span></span></code></pre></div><p>这里<code>5c06218b.2ca6c</code>是该连接的唯一标识符，而后面的数字<code>36,37</code>则是该连接所产生日志的行号。一些操作并不会记录在日志中，但这里幸运的是，正常和出错的两条日志时间相差只有21秒，可以比较精确地定位故障时间点。</p>
<p>通过扫描所有白名单机器上该时刻的命令操作记录，精准定位到了一条执行记录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg_dump --host master.xxxx --port <span style="color:#0000cf;font-weight:bold">6432</span> -d somedb -t sometable
</span></span></code></pre></div><p>嗯？<code>pg_dump</code>不是官方自带的工具吗，难道会修改<code>search_path</code>？不过直觉告诉我，还真不是没可能。例如我想起了一个有趣的行为，因为<code>schema</code>本质上是一个命名空间，因此位于不同schema内的对象可以有相同的名字。在老版本在使用<code>-t</code>转储特定表时，如果提供的表名参数不带schema前缀，<code>pg_dump</code>默认会默认转储所有同名的表。</p>
<p>查阅<code>pg_dump</code>的源码，发现还真有这种操作，以10.5版本为例，发现在<code>setup_connection</code>的时候，确实修改了<code>search_path</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// src/bin/pg_dump/pg_dump.c line 287
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// src/bin/pg_dump/pg_dump.c line 681 main
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">setup_connection</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dumpencoding</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dumpsnapshot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">use_role</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// src/bin/pg_dump/pg_dump.c line 1006 setup_connection
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">PQclear</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ExecuteSqlQueryForSingleRow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ALWAYS_SECURE_SEARCH_PATH_SQL</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// include/server/fe_utils/connect.h
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#define ALWAYS_SECURE_SEARCH_PATH_SQL \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">   &#34;SELECT pg_catalog.set_config(&#39;search_path&#39;, &#39;&#39;, false)&#34; 
</span></span></span></code></pre></div><hr>
<h2 id="bug复现">Bug复现</h2>
<p>接下来就是复现该BUG了。但比较奇怪的是，在使用PostgreSQL11的时候并没能复现出该Bug来，于是我看了一下肇事司机的全部历史记录，还原了其心路历程（发现pg_dump和服务器版本不匹配，来回折腾），使用不同版本的pg_dump终于复现了该BUG。</p>
<p>使用一个现成的数据库，名为<code>data</code>进行测试，版本为11.1。使用的Pgbouncer配置如下，为了便于调试，连接池的大小已经改小，只允许两条服务端连接。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[databases]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">postgres</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">host=127.0.0.1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[pgbouncer]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">logfile</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">/Users/vonng/pgb/pgbouncer.log</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">pidfile</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">/Users/vonng/pgb/pgbouncer.pid</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">listen_addr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">*</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">listen_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">6432</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">auth_type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">trust</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">admin_users</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">postgres</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">stats_users</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">stats, postgres</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">auth_file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">/Users/vonng/pgb/userlist.txt</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">pool_mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">transaction</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">server_reset_query</span> <span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">max_client_conn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">50000</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">default_pool_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">reserve_pool_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">0</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">reserve_pool_timeout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">log_connections</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">1</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">log_disconnections</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">1</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">application_name_add_host</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">ignore_startup_parameters</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">extra_float_digits</span>
</span></span></code></pre></div><p>启动连接池，检查<code>search_path</code>，正常的默认配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ psql postgres://vonng:123456@:6432/data -c <span style="color:#4e9a06">&#39;show search_path;&#39;</span>
</span></span><span style="display:flex;"><span>     search_path
</span></span><span style="display:flex;"><span>-----------------------
</span></span><span style="display:flex;"><span> app, <span style="color:#4e9a06">&#34;</span><span style="color:#000">$user</span><span style="color:#4e9a06">&#34;</span>, public
</span></span></code></pre></div><p>使用10.5版本的pg_dump，从6432端口发起Dump</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/usr/local/Cellar/postgresql/10.5/bin/pg_dump <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	postgres://vonng:123456@:6432/data <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	-t geo.pois -f /dev/null
</span></span><span style="display:flex;"><span>pg_dump: server version: 11.1<span style="color:#000;font-weight:bold">;</span> pg_dump version: 10.5
</span></span><span style="display:flex;"><span>pg_dump: aborting because of server version mismatch
</span></span></code></pre></div><p>虽然Dump失败，但再次检查所有连接的<code>search_path</code>时，就会发现池里的连接已经被污染了，一条连接的<code>search_path</code>已经被修改为空</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ psql postgres://vonng:123456@:6432/data -c <span style="color:#4e9a06">&#39;show search_path;&#39;</span>
</span></span><span style="display:flex;"><span> search_path
</span></span><span style="display:flex;"><span>-------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> row<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><hr>
<h2 id="解决方案">解决方案</h2>
<p>同时配置pgbouncer的<code>server_reset_query</code>以及<code>server_reset_query_always</code>参数，可以彻底解决此问题。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">server_reset_query</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">DISCARD ALL</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">server_reset_query_always</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">1</span>
</span></span></code></pre></div><p>在TransactionPooling模式下，<code>server_reset_query</code>默认是不执行的，因此需要通过配置<code>server_reset_query_always=1</code>使每次事务执行完后强制执行<code>DISCARD ALL</code>清空连接的所有状态。不过，这样的配置是有代价的，<code>DISCARD ALL</code>实质上执行了以下操作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SESSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AUTHORIZATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">RESET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DEALLOCATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CLOSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">UNLISTEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_advisory_unlock_all</span><span style="color:#000;font-weight:bold">();</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">DISCARD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLANS</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">DISCARD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SEQUENCES</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">DISCARD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TEMP</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>如果每个事务后面都要多执行这些语句，确实会带来一些额外的性能开销。</p>
<p>当然，也有其他的方法，譬如从管理上解决，杜绝使用<code>pg_dump</code>访问6432端口的可能，将数据库账号使用专门的加密配置中心管理。或者要求业务方使用带schema限定名的name访问数据库对象。但都可能产生漏网之鱼，不如强制配置来的直接。</p>
<blockquote>
<p><a href="https://mp.weixin.qq.com/s/egK80gEoGv2x6EYUquiLMw">WeChat Column</a></p>
</blockquote>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-3ec0db5c033e90581311f93e2d359f59">PostgreSQL数据页面损坏修复</h1>
	<div class="lead">采用二进制编辑的方式修复PostgreSQL数据页，以及如何让一条主键查询出现两条记录来。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-11-29" class="text-muted">2018年11月29日</time>
        
	</div>
	<p>PostgreSQL是一个很可靠的数据库，但是再可靠的数据库，如果碰上了不可靠的硬件，恐怕也得抓瞎。本文介绍了在PostgreSQL中，应对数据页面损坏的方法。</p>
<h2 id="最初的问题">最初的问题</h2>
<p>线上有一套统计库跑离线任务，业务方反馈跑SQL的时候碰上一个错误：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ERROR:  invalid page in block <span style="color:#0000cf;font-weight:bold">18858877</span> of relation base/16400/275852
</span></span></code></pre></div><p>看到这样的错误信息，第一直觉就是硬件错误导致的关系数据文件损坏，第一步要检查定位具体问题。</p>
<p>这里，16400是数据库的oid，而275852则是数据表的<code>relfilenode</code>，通常等于OID。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">somedb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">275852</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">RegClass</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">regclass</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dailyuseractivities</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 如果relfilenode与oid不一致，则使用以下查询
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">somedb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_relation_filenode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;275852&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dailyuseractivities</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>定位到出问题的表之后，检查出问题的页面，这里错误提示区块号为18858877的页面出现问题。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">somedb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dailyuseractivities</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;(18858877,1)&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ERROR</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">invalid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">page</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">block</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">18858877</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relation</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16400</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">275852</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 打印详细错误位置
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">somedb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">\</span><span style="color:#000">errverbose</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ERROR</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">XX001</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">invalid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">page</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">block</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">18858877</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relation</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16400</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">275852</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LOCATION</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">ReadBuffer_common</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bufmgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">917</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>通过检查，发现该页面无法访问，但该页面前后两个页面都可以正常访问。使用<code>errverbose</code>可以打印出错误所在的源码位置。搜索PostgreSQL源码，发现这个错误信息只在一处位置出现：https://github.com/postgres/postgres/blob/master/src/backend/storage/buffer/bufmgr.c。可以看到，错误发生在页面从磁盘加载到内存共享缓冲区时。PostgreSQL认为这是一个无效的页面，因此报错并中止事务。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* check for garbage data */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">PageIsVerified</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">Page</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">bufBlock</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">blockNum</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">RBM_ZERO_ON_ERROR</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">zero_damaged_pages</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ereport</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">WARNING</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">(</span><span style="color:#000">errcode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ERRCODE_DATA_CORRUPTED</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#000">errmsg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;invalid page in block %u of relation %s; zeroing out page&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">blockNum</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">relpath</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">smgr</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">smgr_rnode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">forkNum</span><span style="color:#000;font-weight:bold">))));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">MemSet</span><span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">bufBlock</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BLCKSZ</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ereport</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ERROR</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">(</span><span style="color:#000">errcode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ERRCODE_DATA_CORRUPTED</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#000">errmsg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;invalid page in block %u of relation %s&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">blockNum</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">relpath</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">smgr</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">smgr_rnode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">forkNum</span><span style="color:#000;font-weight:bold">))));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>进一步检查<code>PageIsVerified</code>函数的逻辑：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 这里的检查并不能保证页面首部是正确的，只是说它看上去足够正常
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 允许其加载至缓冲池中。后续实际使用该页面时仍然可能会出错，这也
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 是我们提供校验和选项的原因。*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">p</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pd_flags</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#000">PD_VALID_FLAG_BITS</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">p</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pd_lower</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">p</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pd_upper</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">p</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pd_upper</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">p</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pd_special</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">p</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pd_special</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">BLCKSZ</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">p</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pd_special</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">MAXALIGN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pd_special</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">header_sane</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">header_sane</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">checksum_failure</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">true</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>接下来就要具体定位问题了，那么第一步，首先要找到问题页面在磁盘上的位置。这其实是两个子问题：在哪个文件里，以及在文件里的偏移量地址。这里，关系文件的<code>relfilenode</code>是275852，在PostgreSQL中，每个关系文件都会被默认切割为1GB大小的段文件，并用<code>relfilenode, relfilenode.1, relfilenode.2, …</code>这样的规则依此命名。</p>
<p>因此，我们可以计算一下，第18858877个页面，每个页面8KB，一个段文件1GB。偏移量为<code>18858877 * 2^13 = 154491920384</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>154491920384 / (1024^3) = 143
</span></span><span style="display:flex;"><span>154491920384 % (1024^3) = 946839552 = 0x386FA000
</span></span></code></pre></div><p>由此可得，问题页面位于第143个段内，偏移量<code>0x386FA000</code>处。</p>
<p>落实到具体文件，也就是<code>${PGDATA}/base/16400/275852.143</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>hexdump 275852.143 <span style="color:#000;font-weight:bold">|</span> grep -w10 386fa00
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>386f9fe0 003b <span style="color:#0000cf;font-weight:bold">0000</span> <span style="color:#0000cf;font-weight:bold">0100</span> <span style="color:#0000cf;font-weight:bold">0000</span> <span style="color:#0000cf;font-weight:bold">0100</span> <span style="color:#0000cf;font-weight:bold">0000</span> 4b00 07c8
</span></span><span style="display:flex;"><span>386f9ff0 9b3d 5ed9 1f40 eb85 b851 44de <span style="color:#0000cf;font-weight:bold">0040</span> <span style="color:#0000cf;font-weight:bold">0000</span>
</span></span><span style="display:flex;"><span>386fa000 <span style="color:#0000cf;font-weight:bold">0000</span> <span style="color:#0000cf;font-weight:bold">0000</span> <span style="color:#0000cf;font-weight:bold">0000</span> <span style="color:#0000cf;font-weight:bold">0000</span> <span style="color:#0000cf;font-weight:bold">0000</span> <span style="color:#0000cf;font-weight:bold">0000</span> <span style="color:#0000cf;font-weight:bold">0000</span> <span style="color:#0000cf;font-weight:bold">0000</span>
</span></span><span style="display:flex;"><span>*
</span></span><span style="display:flex;"><span>386fb000 62df 3d7e <span style="color:#0000cf;font-weight:bold">0000</span> <span style="color:#0000cf;font-weight:bold">0000</span> <span style="color:#0000cf;font-weight:bold">0452</span> <span style="color:#0000cf;font-weight:bold">0000</span> 011f c37d
</span></span><span style="display:flex;"><span>386fb010 <span style="color:#0000cf;font-weight:bold">0040</span> <span style="color:#0000cf;font-weight:bold">0003</span> 0b02 <span style="color:#0000cf;font-weight:bold">0018</span> 18f6 <span style="color:#0000cf;font-weight:bold">0000</span> d66a <span style="color:#0000cf;font-weight:bold">0068</span>
</span></span></code></pre></div><p>使用二进制编辑器打开并定位至相应偏移量，发现该页面的内容已经被抹零，没有抢救价值了。好在线上的数据库至少都是一主一从配置，如果是因为主库上的坏块导致的页面损坏，从库上应该还有原来的数据。在从库上果然能找到对应的数据：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>386f9fe0:3b00 <span style="color:#0000cf;font-weight:bold">0000</span> <span style="color:#0000cf;font-weight:bold">0001</span> <span style="color:#0000cf;font-weight:bold">0000</span> <span style="color:#0000cf;font-weight:bold">0001</span> <span style="color:#0000cf;font-weight:bold">0000</span> 004b c807  <span style="color:#000;font-weight:bold">;</span>............K..
</span></span><span style="display:flex;"><span>386f9ff0:3d9b d95e 401f 85eb 51b8 de44 <span style="color:#0000cf;font-weight:bold">4000</span> <span style="color:#000">0000</span>  <span style="color:#ce5c00;font-weight:bold">=</span>..^@...Q..D@...
</span></span><span style="display:flex;"><span>386fa000:e3bd <span style="color:#0000cf;font-weight:bold">0100</span> 70c8 864a <span style="color:#0000cf;font-weight:bold">0000</span> <span style="color:#0000cf;font-weight:bold">0400</span> f801 <span style="color:#0000cf;font-weight:bold">0002</span>  ....p..J........
</span></span><span style="display:flex;"><span>386fa010:0020 <span style="color:#0000cf;font-weight:bold">0420</span> <span style="color:#0000cf;font-weight:bold">0000</span> <span style="color:#0000cf;font-weight:bold">0000</span> c09f 7a00 809f 7a00  . . ......z...z.
</span></span><span style="display:flex;"><span>386fa020:409f 7a00 009f 7a00 c09e 7a00 809e 7a00  @.z...z...z...z.
</span></span><span style="display:flex;"><span>386fa030:409e 7a00 009e 7a00 c09d 7a00 809d 7a00  @.z...z...z...z.
</span></span></code></pre></div><p>当然，如果页面是正常的，在从库上执行读取操作就不会报错。因此可以直接通过<code>CTID</code>过滤把损坏的数据找回来。</p>
<p>到现在为止，数据虽然找回来，可以松一口气了。但主库上的坏块问题仍然需要处理，这个就比较简单了，直接重建该表，并从从库抽取最新的数据即可。有各种各样的方法，<code>VACUUM FULL</code>，<code>pg_repack</code>，或者手工重建拷贝数据。</p>
<p>不过，我注意到在判定页面有效性的代码中出现了一个从来没见过的参数<code>zero_damaged_pages</code>，查阅文档才发现，这是一个开发者调试用参数，可以允许PostgreSQL忽略损坏的数据页，将其视为全零的空页面。用WARNING替代ERROR。这引发了我的兴趣。毕竟有时候，对于一些粗放的统计业务，跑了几个小时的SQL因为一两条脏数据中断，恐怕要比错漏那么几条记录更令人抓狂。这个参数可不可以满足这样的需求呢？</p>
<blockquote>
<p><code>zero_damaged_pages</code> (<code>boolean</code>)</p>
<p>PostgreSQL在检测到损坏的页面首部时通常会报告一个错误，并中止当前事务。将参数<code>zero_damaged_pages</code>配置为<code>on</code>，会使系统取而代之报告一个WARNING，并将内存中的页面抹为全零。然而该操作会摧毁数据，也就是说损坏页面上的行全都会丢失。不过，这样做确实能允许你略过错误并从未损坏的页面中获取表中未受损的行。当出现软件或硬件导致的数据损坏时，该选项可用于恢复数据。通常情况下只有当您放弃从受损的页面中恢复数据时，才应当使用该选项。抹零的页面并不会强制刷回磁盘，因此建议在重新关闭该选项之前重建受损的表或索引。本选项默认是关闭的，且只有超级用户才能修改。</p>
</blockquote>
<p>毕竟，当重建表之后，原来的坏块就被释放掉了。如果硬件本身没有提供坏块识别与筛除的功能，那么这就是一个定时炸弹，很可能将来又会坑到自己。不幸的是，这台机器上的数据库有14TB，用的16TB的SSD，暂时没有同类型的机器了。只能先苟一下，因此需要研究一下，这个参数能不能让查询在遇到坏页时自动跳过。</p>
<h2 id="苟且的办法">苟且的办法</h2>
<p>如下，在本机搭建一个测试集群，配置一主一从。尝试复现该问题，并确定</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># tear down</span>
</span></span><span style="display:flex;"><span>pg_ctl -D /pg/d1 stop
</span></span><span style="display:flex;"><span>pg_ctl -D /pg/d2 stop
</span></span><span style="display:flex;"><span>rm -rf /pg/d1 /pg/d2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># master @ port5432</span>
</span></span><span style="display:flex;"><span>pg_ctl -D /pg/d1 init
</span></span><span style="display:flex;"><span>pg_ctl -D /pg/d1 start
</span></span><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#34;CREATE USER replication replication;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slave @ port5433</span>
</span></span><span style="display:flex;"><span>pg_basebackup -Xs -Pv -R -D /pg/d2 -Ureplication 
</span></span><span style="display:flex;"><span>pg_ctl -D /pg/d2 start -o<span style="color:#4e9a06">&#34;-p5433&#34;</span>
</span></span></code></pre></div><p>连接至主库，创建样例表并插入555条数据，约占据三个页面。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- psql postgres
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ANALYZE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 注意，插入数据之后一定要执行checkpoint确保落盘
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">generate_series</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">555</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CHECKPOINT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>现在，让我们模拟出现坏块的情况，首先找出主库中<code>test</code>表的对应文件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_relation_filepath</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;test&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">12630</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16385</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ hexdump /pg/d1/base/12630/16385 | head -n 20
</span></span><span style="display:flex;"><span>0000000 00 00 00 00 d0 22 02 03 00 00 00 00 a0 03 c0 03
</span></span><span style="display:flex;"><span>0000010 00 20 04 20 00 00 00 00 e0 9f 34 00 c0 9f 34 00
</span></span><span style="display:flex;"><span>0000020 a0 9f 34 00 80 9f 34 00 60 9f 34 00 40 9f 34 00
</span></span><span style="display:flex;"><span>0000030 20 9f 34 00 00 9f 34 00 e0 9e 34 00 c0 9e 36 00
</span></span><span style="display:flex;"><span>0000040 a0 9e 36 00 80 9e 36 00 60 9e 36 00 40 9e 36 00
</span></span><span style="display:flex;"><span>0000050 20 9e 36 00 00 9e 36 00 e0 9d 36 00 c0 9d 36 00
</span></span><span style="display:flex;"><span>0000060 a0 9d 36 00 80 9d 36 00 60 9d 36 00 40 9d 36 00
</span></span><span style="display:flex;"><span>0000070 20 9d 36 00 00 9d 36 00 e0 9c 36 00 c0 9c 36 00
</span></span></code></pre></div><p><img src="/img/blog/pg/page-corruption-tuple.png"></p>
<p>上面已经给出了PostgreSQL判断页面是否“正常”的逻辑，这里我们就修改一下数据页面，让页面变得“不正常”。页面的第12~16字节，也就是这里第一行的最后四个字节<code>a0 03 c0 03</code>，是页面内空闲空间上下界的指针。这里按小端序解释的意思就是本页面内，空闲空间从<code>0x03A0</code>开始，到<code>0x03C0</code>结束。符合逻辑的空闲空间范围当然需要满足上界小于等于下界。这里我们将上界<code>0x03A0</code>修改为<code>0x03D0</code>，超出下界<code>0x03C0</code>，也就是将第一行的倒数第四个字节由<code>A0</code>修改为<code>D0</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># vim打开后使用 :%!xxd 编辑二进制</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 编辑完成后使用 :%!xxd -r转换回二进制，再用:wq保存</span>
</span></span><span style="display:flex;"><span>vi /pg/d1/base/12630/16385
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看修改后的结果。</span>
</span></span><span style="display:flex;"><span>$ hexdump /pg/d1/base/12630/16385 <span style="color:#000;font-weight:bold">|</span> head -n <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0000000</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">48</span> <span style="color:#0000cf;font-weight:bold">22</span> <span style="color:#0000cf;font-weight:bold">02</span> <span style="color:#0000cf;font-weight:bold">03</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> d0 <span style="color:#0000cf;font-weight:bold">03</span> c0 <span style="color:#0000cf;font-weight:bold">03</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0000010</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">20</span> <span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">20</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> e0 9f <span style="color:#0000cf;font-weight:bold">34</span> <span style="color:#0000cf;font-weight:bold">00</span> c0 9f <span style="color:#0000cf;font-weight:bold">34</span> <span style="color:#0000cf;font-weight:bold">00</span>
</span></span></code></pre></div><p>这里，虽然磁盘上的页面已经被修改，但页面已经缓存到了内存中的共享缓冲池里。因此从主库上仍然可以正常看到页面1中的结果。接下来重启主库，清空其Buffer。不幸的是，当关闭数据库或执行检查点时，内存中的页面会刷写会磁盘中，覆盖我们之前编辑的结果。因此，首先关闭数据库，重新执行编辑后再启动。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg_ctl -D /pg/d1 stop
</span></span><span style="display:flex;"><span>vi /pg/d1/base/12630/16385
</span></span><span style="display:flex;"><span>pg_ctl -D /pg/d1 start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#39;select * from test;&#39;</span>
</span></span><span style="display:flex;"><span>ERROR:  invalid page in block <span style="color:#0000cf;font-weight:bold">0</span> of relation base/12630/16385
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#34;select * from test where id = &#39;10&#39;;&#34;</span>
</span></span><span style="display:flex;"><span>ERROR:  invalid page in block <span style="color:#0000cf;font-weight:bold">0</span> of relation base/12630/16385
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#34;select * from test where ctid = &#39;(0,1)&#39;;&#34;</span>
</span></span><span style="display:flex;"><span>ERROR:  invalid page in block <span style="color:#0000cf;font-weight:bold">0</span> of relation base/12630/16385
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ psql postgres -c <span style="color:#4e9a06">&#34;select * from test where ctid = &#39;(1,1)&#39;;&#34;</span>
</span></span><span style="display:flex;"><span> id
</span></span><span style="display:flex;"><span>-----
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">227</span>
</span></span></code></pre></div><p>可以看到，修改后的0号页面无法被数据库识别出来，但未受影响的页面1仍然可以正常访问。</p>
<p>虽然主库上的查询因为页面损坏无法访问了，这时候在从库上执行类似的查询，都可以正常返回结果</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ psql -p5433 postgres -c <span style="color:#4e9a06">&#39;select * from test limit 2;&#39;</span>
</span></span><span style="display:flex;"><span> id
</span></span><span style="display:flex;"><span>----
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ psql -p5433 postgres -c <span style="color:#4e9a06">&#34;select * from test where id = &#39;10&#39;;&#34;</span>
</span></span><span style="display:flex;"><span> id
</span></span><span style="display:flex;"><span>----
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ psql -p5433 postgres -c <span style="color:#4e9a06">&#34;select * from test where ctid = &#39;(0,1)&#39;;&#34;</span>
</span></span><span style="display:flex;"><span> id
</span></span><span style="display:flex;"><span>----
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> row<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>接下来，让我们打开<code>zero_damaged_pages</code>参数，现在在主库上的查询不报错了。取而代之的是一个警告，页面0中的数据蒸发掉了，返回的结果从第1页开始。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">postgres</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">zero_damaged_pages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">postgres</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">WARNING</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">invalid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">page</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">block</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relation</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">12630</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16385</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">zeroing</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">out</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">page</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">227</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">228</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">229</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">230</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">231</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>第0页确实已经被加载到内存缓冲池里了，而且页面里的数据被抹成了0。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">extension</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_buffercache</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">postgres</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relblocknumber</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">isdirty</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">usagecount</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_buffercache</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relfilenode</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16385</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relblocknumber</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">isdirty</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">usagecount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------+---------+------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">f</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">f</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">f</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><code>zero_damaged_pages</code>参数需要在实例级别进行配置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 确保该选项默认打开，并重启生效</span>
</span></span><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#39;ALTER SYSTEM set zero_damaged_pages = on;&#39;</span>
</span></span><span style="display:flex;"><span>pg_ctl -D /pg/d1 restart
</span></span><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#39;show zero_damaged_pages;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>zero_damaged_pages
</span></span><span style="display:flex;"><span>--------------------
</span></span><span style="display:flex;"><span> on
</span></span></code></pre></div><p>这里，通过配置<code>zero_damaged_pages</code>，能够让主库即使遇到坏块，也能继续应付一下。</p>
<p>垃圾页面被加载到内存并抹零之后，如果执行检查点，这个全零的页面是否又会被重新刷回磁盘覆盖原来的数据呢？这一点很重要，因为脏数据也是数据，起码有抢救的价值。为了一时的方便产生永久性无法挽回的损失，那肯定也是无法接受的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#39;checkpoint;&#39;</span>
</span></span><span style="display:flex;"><span>hexdump /pg/d1/base/12630/16385 <span style="color:#000;font-weight:bold">|</span> head -n <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0000000</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">48</span> <span style="color:#0000cf;font-weight:bold">22</span> <span style="color:#0000cf;font-weight:bold">02</span> <span style="color:#0000cf;font-weight:bold">03</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> d0 <span style="color:#0000cf;font-weight:bold">03</span> c0 <span style="color:#0000cf;font-weight:bold">03</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0000010</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">20</span> <span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">20</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> e0 9f <span style="color:#0000cf;font-weight:bold">34</span> <span style="color:#0000cf;font-weight:bold">00</span> c0 9f <span style="color:#0000cf;font-weight:bold">34</span> <span style="color:#0000cf;font-weight:bold">00</span>
</span></span></code></pre></div><p>可以看到，无论是检查点还是重启，这个内存中的全零页面并不会强制替代磁盘上的损坏页面，留下了抢救的希望，又能保证线上的查询可以苟一下。甚好，甚好。这也符合文档中的描述：“抹零的页面并不会强制刷回磁盘”。</p>
<h2 id="微妙的问题">微妙的问题</h2>
<p>就当我觉得实验完成，可以安心的把这个开关打开先对付一下时。突然又想起了一个微妙的事情，主库和从库上读到的数据是不一样的，这就很尴尬了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql -p5432 postgres -Atqc <span style="color:#4e9a06">&#39;select * from test limit 2;&#39;</span>
</span></span><span style="display:flex;"><span>2018-11-29 22:31:20.777 CST <span style="color:#ce5c00;font-weight:bold">[</span>24175<span style="color:#ce5c00;font-weight:bold">]</span> WARNING:  invalid page in block <span style="color:#0000cf;font-weight:bold">0</span> of relation base/12630/16385<span style="color:#000;font-weight:bold">;</span> zeroing out page
</span></span><span style="display:flex;"><span>WARNING:  invalid page in block <span style="color:#0000cf;font-weight:bold">0</span> of relation base/12630/16385<span style="color:#000;font-weight:bold">;</span> zeroing out page
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">227</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">228</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>psql -p5433 postgres -Atqc <span style="color:#4e9a06">&#39;select * from test limit 2;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span></code></pre></div><p>更尴尬的是，在主库上是看不到第0页中的元组的，也就是说主库认为第0页中的记录都不存在，因此，即使表上存在主键约束，仍然可以插入同一个主键的记录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 表中已经有主键 id = 1的记录了，但是主库抹零了看不到！</span>
</span></span><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#34;INSERT INTO test VALUES(1);&#34;</span>
</span></span><span style="display:flex;"><span>INSERT <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 从从库上查询，夭寿了！主键出现重复了！</span>
</span></span><span style="display:flex;"><span>psql postgres -p5433 -c <span style="color:#4e9a06">&#34;SELECT * FROM test;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> id
</span></span><span style="display:flex;"><span>-----
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">555</span>
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># id列真的是主键……</span>
</span></span><span style="display:flex;"><span>$ psql postgres -p5433 -c <span style="color:#4e9a06">&#34;\d test;&#34;</span>
</span></span><span style="display:flex;"><span>                      Table <span style="color:#4e9a06">&#34;public.test&#34;</span>
</span></span><span style="display:flex;"><span> Column <span style="color:#000;font-weight:bold">|</span>         Type         <span style="color:#000;font-weight:bold">|</span> Collation <span style="color:#000;font-weight:bold">|</span> Nullable <span style="color:#000;font-weight:bold">|</span> Default
</span></span><span style="display:flex;"><span>--------+----------------------+-----------+----------+---------
</span></span><span style="display:flex;"><span> id     <span style="color:#000;font-weight:bold">|</span> character varying<span style="color:#ce5c00;font-weight:bold">(</span>8<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> not null <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>Indexes:
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;test_pkey&#34;</span> PRIMARY KEY, btree <span style="color:#ce5c00;font-weight:bold">(</span>id<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>如果把这个从库Promote成新的主库，这个问题在从库上依然存在：一条主键能返回两条记录！真是夭寿啊……。</p>
<p>此外，还有一个有趣的问题，VACUUM会如何处理这样的零页面呢？</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 对表进行清理</span>
</span></span><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#39;VACUUM VERBOSE;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INFO:  vacuuming <span style="color:#4e9a06">&#34;public.test&#34;</span>
</span></span><span style="display:flex;"><span>2018-11-29 22:18:05.212 CST <span style="color:#ce5c00;font-weight:bold">[</span>23572<span style="color:#ce5c00;font-weight:bold">]</span> WARNING:  invalid page in block <span style="color:#0000cf;font-weight:bold">0</span> of relation base/12630/16385<span style="color:#000;font-weight:bold">;</span> zeroing out page
</span></span><span style="display:flex;"><span>2018-11-29 22:18:05.212 CST <span style="color:#ce5c00;font-weight:bold">[</span>23572<span style="color:#ce5c00;font-weight:bold">]</span> WARNING:  relation <span style="color:#4e9a06">&#34;test&#34;</span> page <span style="color:#0000cf;font-weight:bold">0</span> is uninitialized --- fixing
</span></span><span style="display:flex;"><span>WARNING:  invalid page in block <span style="color:#0000cf;font-weight:bold">0</span> of relation base/12630/16385<span style="color:#000;font-weight:bold">;</span> zeroing out page
</span></span><span style="display:flex;"><span>WARNING:  relation <span style="color:#4e9a06">&#34;test&#34;</span> page <span style="color:#0000cf;font-weight:bold">0</span> is uninitialized --- fixing
</span></span><span style="display:flex;"><span>INFO:  index <span style="color:#4e9a06">&#34;test_pkey&#34;</span> now contains <span style="color:#0000cf;font-weight:bold">329</span> row versions in <span style="color:#0000cf;font-weight:bold">5</span> pages
</span></span><span style="display:flex;"><span>DETAIL:  <span style="color:#0000cf;font-weight:bold">0</span> index row versions were removed.
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0</span> index pages have been deleted, <span style="color:#0000cf;font-weight:bold">0</span> are currently reusable.
</span></span><span style="display:flex;"><span>CPU: user: 0.00 s, system: 0.00 s, elapsed: 0.00 s.
</span></span></code></pre></div><p>VACUUM把这个页面“修好了”？但杯具的是，VACUUM自作主张修好了脏数据页，并不一定是一件好事…。因为当VACUUM完成修复时，这个页面就被视作一个普通的页面了，就会在CHECKPOINT时被刷写回磁盘中……，从而覆盖了原始的脏数据。如果这种修复并不是你想要的结果，那么数据就有可能会丢失。</p>
<h2 id="总结">总结</h2>
<ul>
<li>复制，备份是应对硬件损坏的最佳办法。</li>
<li>当出现数据页面损坏时，可以找到对应的物理页面，进行比较，尝试修复。</li>
<li>当页面损坏导致查询无法进行时，参数<code>zero_damaged_pages</code>可以临时用于跳过错误。</li>
<li>参数<code>zero_damaged_pages</code>极其危险</li>
<li>打开抹零时，损坏页面会被加载至内存缓冲池中并抹零，且在检查点时不会覆盖磁盘原页面。</li>
<li>内存中被抹零的页面会被VACUUM尝试修复，修复后的页面会被检查点刷回磁盘，覆盖原页面。</li>
<li>抹零页面内的内容对数据库不可见，因此可能会出现违反约束的情况出现。</li>
</ul>
<blockquote>
<p><a href="https://mp.weixin.qq.com/s/LFPta3nGD12MRFVyuYEvHA">WeChat Column地址</a></p>
</blockquote>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-370cab4bf0902960a0bf658b2d2c5012">关系膨胀的监控与治理</h1>
	<div class="lead">PostgreSQL使用了MVCC作为主要并发控制技术，它有很多好处，但也会带来一些其他的影响，例如关系膨胀。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-10-06" class="text-muted">2018年10月06日</time>
        
	</div>
	<p>PostgreSQL使用了MVCC作为主要并发控制技术，它有很多好处，但也会带来一些其他的影响，例如关系膨胀。关系（表与索引）膨胀会对数据库性能产生负面影响，并浪费磁盘空间。为了使PostgreSQL始终保持在最佳性能，有必要及时对膨胀的关系进行垃圾回收，并定期重建过度膨胀的关系。</p>
<p>在实际操作中，垃圾回收并没有那么简单，这里有一系列的问题：</p>
<ul>
<li>关系膨胀的原因？</li>
<li>关系膨胀的度量？</li>
<li>关系膨胀的监控？</li>
<li>关系膨胀的处理？</li>
</ul>
<p>本文将详细说明这些问题。</p>
<hr>
<h2 id="关系膨胀概述">关系膨胀概述</h2>
<p>假设某个关系实际占用存储100G，但其中有很多空间被死元组，碎片，空闲区域浪费，如果将其压实为一个新的关系，占用空间变为60G，那么就可以近似认为该关系的膨胀率是 (100 - 60)  / 100 = 40%。</p>
<p>普通的<code>VACUUM</code>不能解决表膨胀的问题，死元组本身能够被并发<code>VACUUM</code>机制回收，但它产生的碎片，留下的空洞却不可以。比如，即使删除了许多死元组，也无法减小表的大小。久而久之，关系文件被大量空洞填满，浪费了大量的磁盘空间。</p>
<p><code>VACUUM FULL</code>命令可以回收这些空间，它将旧表文件中的活元组复制到新表中，通过重写整张表的方式将表压实。但在实际生产中，因为该操作会持有表上的<code>AccessExclusiveLock</code>，阻塞业务正常访问，因此在不间断服务的情况下并不适用，<code>pg_repack</code>是一个实用的第三方插件，能够在线上业务正常进行的同时进行无锁的<code>VACUUM FULL</code>。</p>
<p>不幸的是，关于什么时候需要进行<code>VACUUM FULL</code>处理膨胀并没有一个最佳实践。DBA需要针对自己的业务场景制定清理策略。但无论采用何种策略，实施这些策略的机制都是类似的：</p>
<ul>
<li>监控，检测，衡量关系的膨胀程度</li>
<li>依据关系的膨胀程度，时机等因素，处理关系膨胀。</li>
</ul>
<p>这里有几个关键的问题，首先是，如何定义关系的膨胀率？</p>
<hr>
<h2 id="关系膨胀的度量">关系膨胀的度量</h2>
<p>衡量关系膨胀的程度，首先需要定义一个指标：<strong>膨胀率（bloat rate）</strong>。</p>
<p>膨胀率的计算思想是：通过统计信息估算出目标表如果处于 <strong>紧实（Compact）</strong> 状态所占用的空间，而实际使用空间超出该紧实空间部分的占比，就是膨胀率。因此膨胀率可以被定义为 1 - (活元组占用字节总数 / 关系占用字节总数)。</p>
<p>例如，某个表实际占用存储100G，但其中有很多空间被死元组，碎片，空闲区域浪费，如果将其压实为一张新表，占用空间变为60G，那么膨胀率就是 1 - 60/100 = 40%。</p>
<p>关系的大小获取较为简单，可以直接从系统目录中获取。所以问题的关键在于，<strong>活元组的字节总数</strong>这一数据如何获取。</p>
<h3 id="膨胀率的精确计算">膨胀率的精确计算</h3>
<p>PostgreSQL自带了<code>pgstattuple</code>模块，可用于精确计算表的膨胀率。譬如这里的<code>tuple_percent</code>字段就是元组实际字节占关系总大小的百分比，用1减去该值即为膨胀率。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">local</span><span style="color:#000;font-weight:bold">]:</span><span style="color:#0000cf;font-weight:bold">5432</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">bench</span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tuple_len</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">numeric</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_len</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bloat</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgstattuple</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pgbench_accounts&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">┌─</span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RECORD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#a40000">───────┬────────────────────────┐</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_len</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">136642560</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tuple_count</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000000</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tuple_len</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">121000000</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tuple_percent</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">88</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">55</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dead_tuple_count</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16418</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dead_tuple_len</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1986578</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dead_tuple_percent</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">45</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">free_space</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1674768</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">free_percent</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">23</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bloat</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">11447794889088729017</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">│</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">└────────────────────┴────────────────────────┘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><code>pgstattuple</code>对于精确地判断表与索引的膨胀情况非常有用，具体细节可以参考官方文档：https://www.postgresql.org/docs/current/static/pgstattuple.html。</p>
<p>此外，PostgreSQL还提供了两个自带的扩展，<code>pg_freespacemap</code>与<code>pageinspect</code>，前者可以用于检视每个页面中的空闲空间大小，后者则可以精确地展示关系中每个数据页内物理存储的内容。如果希望检视关系的内部状态，这两个插件非常实用，详细使用方法可以参考官方文档：</p>
<p><a href="https://www.postgresql.org/docs/current/static/pgfreespacemap.html">https://www.postgresql.org/docs/current/static/pgfreespacemap.html</a></p>
<p><a href="https://www.postgresql.org/docs/current/static/pageinspect.html">https://www.postgresql.org/docs/current/static/pageinspect.html</a></p>
<p>不过在绝大多数情况下，我们并不会太在意膨胀率的精确度。在实际生产中对膨胀率的要求并不高：第一位有效数字是准确的，就差不多够用了。另一方面，要想精确地知道活元组占用的字节总数，需要对整个关系执行一遍扫描，这会对线上系统的IO产生压力。如果希望对所有表的膨胀率进行监控，也不适合使用这种方式。</p>
<p>例如一个200G的关系，使用<code>pgstattuple</code>插件执行精确的膨胀率估算大致需要5分钟时间。在9.5及后续版本，<code>pgstattuple</code>插件还提供了<code>pgstattuple_approx</code>函数，以精度换速度。但即使使用估算，也需要秒级的时间。</p>
<p>监控膨胀率，最重要的要求是速度快，影响小。因此当我们需要对很多数据库的很多表同时进行监控时，需要对膨胀率进行<strong>快速估算</strong>，避免对业务产生影响。</p>
<hr>
<h2 id="膨胀率的估算">膨胀率的估算</h2>
<p>PostgreSQL为每个关系都维护了很多的统计信息，利用统计信息，可以快速高效地估算数据库中所有表的膨胀率。估算膨胀率需要使用表与列上的统计信息，直接使用的统计指标有三个：</p>
<ul>
<li>元组的平均宽度<code>avgwidth</code>：从列级统计数据计算而来，用于估计紧实状态占用的空间。</li>
<li>元组数：<code>pg_class.reltuples</code>：用于估计紧实状态占用的空间</li>
<li>页面数：<code>pg_class.relpages</code>：用于测算实际使用的空间</li>
</ul>
<p>而计算公式也很简单：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">reltuples</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">avgwidth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">block_size</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">pageheader</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">relpages</span> 
</span></span></code></pre></div><p>这里<code>block_size</code>是页面大小，默认为8182，<code>pageheader</code>是首部占用的大小，默认为24字节。页面大小减去首部大小就是可以用于元组存储的实际空间，因此<code>(reltuples * avgwidth)</code>给出了元组的估计总大小，而除以前者后，就可以得到预计需要多少个页面才能紧实地存下所有的元组。最后，期待使用的页面数量，除以实际使用的页面数量，就是<strong>利用率</strong>，而1减去利用率，就是膨胀率。</p>
<h3 id="难点">难点</h3>
<p>这里的关键，在于如何使用统计信息估算元组的平均长度，而为了实现这一点，我们需要克服三个困难：</p>
<ul>
<li>当元组中存在空值时，首部会带有空值位图。</li>
<li>首部与数据部分存在Padding，需要考虑边界对齐。</li>
<li>一些字段类型也存在对齐要求</li>
</ul>
<p>但好在，膨胀率本身就是一种估算，只要大致正确即可。</p>
<h3 id="计算元组的平均长度">计算元组的平均长度</h3>
<p>为了理解估算的过程，首先需要理解PostgreSQL中数据页面与元组的的内部布局。</p>
<p>首先来看元组的<strong>平均长度</strong>，PG中元组的布局如下图所示。</p>
<p><img src="/img/blog/pg/page-tuple.png"></p>
<p>一条元组占用的空间可以分为三个部分：</p>
<ul>
<li>定长的行指针（4字节，严格来说这不算元组的一部分，但它与元组一一对应）</li>
<li>变长的首部
<ul>
<li>固定长度部分23字节</li>
<li>当元组中存在空值时，会出现空值位图，每个字段占一位，故其长度为字段数除以8。</li>
<li>在空值位图后需要填充至<code>MAXALIGN</code>，通常为8。</li>
<li>如果表启用了<code>WITH OIDS</code>选项，元组还会有一个4字节的OID，但这里我们不考虑该情况。</li>
</ul>
</li>
<li>数据部分</li>
</ul>
<p>因此，一条元组（包括相应的行指针）的平均长度可以这样计算：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">avg_size_tuple</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">avg_size_hdr</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">avg_size_data</span>
</span></span></code></pre></div><p>关键在于求出<strong>首部的平均长度</strong>与<strong>数据部分的平均长度</strong>。</p>
<h3 id="计算首部的平均长度">计算首部的平均长度</h3>
<p>首部平均长度主要的变数在于<strong>空值位图</strong>与<strong>填充对齐</strong>。为了估算元组首部的平均长度，我们需要知道几个参数：</p>
<ul>
<li>不带空值位图的首部平均长度（带有填充）：<code>normhdr</code></li>
<li>带有空值位图的首部平均长度（带有填充）：<code>nullhdr</code></li>
<li>带有空值的元组比例：<code>nullfrac</code></li>
</ul>
<p>而估算首部平均长度的公式，也非常简单：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">avg_size_hdr</span> <span style="color:#ce5c00;font-weight:bold">=</span>  <span style="color:#000">nullhdr</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">nullfrac</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">normhdr</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">nullfrac</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>因为不带空值位图的首部，其长度是23字节，对齐至8字节的边界，长度为24字节，上式可以改为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">avg_size_hdr</span> <span style="color:#ce5c00;font-weight:bold">=</span>  <span style="color:#000">nullhdr</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">nullfrac</span> <span style="color:#ce5c00;font-weight:bold">+</span>  <span style="color:#0000cf;font-weight:bold">24</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">nullfrac</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>计算某值被补齐至8字节边界的长度，可以使用以下公式进行高效计算：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">padding</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span></code></pre></div><h3 id="计算数据部分的平均长度">计算数据部分的平均长度</h3>
<p>数据部分的平均长度主要取决于每个字段的平均宽度与空值率，加上末尾的对齐。</p>
<p>以下SQL可以利用统计信息算出所有表的平均元组数据部分宽度。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">schemaname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">null_frac</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">avg_width</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schemaname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>例如，以下SQL能够从<code>pg_stats</code>系统统计视图中获取<code>app.apple</code>表上一条元组的平均长度。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#8f5902;font-style:italic">-- 字段数目
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">ceil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic">-- 空值位图占用的字节数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">null_frac</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic">-- 最大空值率
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">null_frac</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">avg_width</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 数据部分的平均宽度
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">schemaname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;app&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;apple&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RECORD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic">-----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">47</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ceil</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1733</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">76873471724</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="整合">整合</h3>
<p>将上面三节的逻辑整合，得到以下的存储过程，给定一个表，返回其膨胀率。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">relation</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">regclass</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">double</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">precision</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">plpgsql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#204a87;font-weight:bold">function</span><span style="color:#a40000">$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">_schemaname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">tuples</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87">BIGINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">pages</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">nullheader</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">nullfrac</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">datawidth</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">avgtuplelen</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RegNamespace</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">relpages</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">_schemaname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pages</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relation</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#0000cf;font-weight:bold">23</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ceil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">null_frac</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">ceil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">null_frac</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">avg_width</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nullheader</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nullfrac</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datawidth</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">schemaname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">_schemaname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relation</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datawidth</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datawidth</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datawidth</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- avg data len
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nullfrac</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nullfrac</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nullheader</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nullheader</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nullheader</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">avgtuplelen</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">raise</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">notice</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;% %&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nullfrac</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datawidth</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ceil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tuples</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">avgtuplelen</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8168</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pages</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$</span><span style="color:#204a87;font-weight:bold">function</span><span style="color:#a40000">$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="批量计算">批量计算</h3>
<p>对于监控而言，我们关注的往往不仅仅是一张表，而是库中所有的表。因此，可以将上面的膨胀率计算逻辑重写为批量计算的查询，并定义为视图便于使用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_bloat_indexes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_bloat_indexes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree_index_atts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">pg_namespace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">indexclass</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline">                                                          </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">indexclass</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">indexclass</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indrelid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">indexclass</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relam</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">tableclass</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline">                                                          </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">regexp_split_to_table</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indkey</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39; &#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">SMALLINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">attnum</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline">                                                         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((((</span><span style="color:#000">pg_index</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indexclass</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indexclass</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">)))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tableclass</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tableclass</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">)))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_namespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">pg_namespace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indexclass</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#000;font-weight:bold">)))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_am</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">indexclass</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relam</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_am</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">)))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">pg_am</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">amname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;btree&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NAME</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">indexclass</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_item_sizes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relam</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indrelid</span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">current_setting</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;block_size&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">NUMERIC</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bs</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline">                                                    </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">maxalign</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#f8f8f8;text-decoration:underline">                                                   </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pagehdr</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">COALESCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">null_frac</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">REAL</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">                                                  </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_tuple_hdr</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">((((</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">COALESCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">null_frac</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">REAL</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">COALESCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">avg_width</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nulldatawidth</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">pg_attribute</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree_index_atts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(((</span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attnum</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attnum</span><span style="color:#000;font-weight:bold">))))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(((</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schemaname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(((</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tablename</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                                          </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                                           </span><span style="color:#000">pg_get_indexdef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attrelid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                                                           </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attnum</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                                                           </span><span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">)))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                                         </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                                          </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#000;font-weight:bold">))))))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attnum</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relam</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indrelid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">current_setting</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;block_size&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_aligned_est</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">maxalign</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bs</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relam</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">table_oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">COALESCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ceil</span><span style="color:#000;font-weight:bold">((((</span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltuples</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((((((((</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">maxalign</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                             </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                             </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_tuple_hdr</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                                    </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">maxalign</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                               </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">maxalign</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                             </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_tuple_hdr</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                                   </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">maxalign</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                             </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nulldatawidth</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                          </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">maxalign</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                           </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                           </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(((</span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nulldatawidth</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                                  </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">maxalign</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                             </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">maxalign</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                           </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nulldatawidth</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                                 </span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">maxalign</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                           </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bs</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index_item_sizes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pagehdr</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">)),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">expected</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_item_sizes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">raw_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">current_database</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">                                                           </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">pg_class</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline">                                                             </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bs</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">totalbytes</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expected</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expected</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">NUMERIC</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bs</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000;font-weight:bold">((((</span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expected</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">                                                                          </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wastedbytes</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expected</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">NUMERIC</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(((</span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bs</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((((</span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                          </span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expected</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bs</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">                                                                          </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">realbloat</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">pg_relation_size</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">table_oid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REGCLASS</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_bytes</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">stat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">idx_scan</span><span style="color:#f8f8f8;text-decoration:underline">                                                                </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_scans</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">index_aligned_est</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">pg_class</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">table_oid</span><span style="color:#000;font-weight:bold">)))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stat_user_indexes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">stat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">index_aligned_est</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">stat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">)))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">format_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">raw_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dbname</span><span style="color:#f8f8f8;text-decoration:underline">                                             </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">database_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">raw_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline">                                            </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">schema_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">raw_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">raw_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#000">raw_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">realbloat</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                                     </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bloat_pct</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">raw_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wastedbytes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(((</span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">^</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                         </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bloat_mb</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">raw_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">totalbytes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(((</span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">^</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                                                     </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_mb</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">raw_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">table_bytes</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">NUMERIC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(((</span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">^</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                                                       </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_mb</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">raw_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_scans</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">raw_bloat</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">format_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">database_name</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">format_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">schema_name</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">format_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">format_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_name</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idxname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">format_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_scans</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_scans</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">format_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bloat_pct</span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bloat_pct</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">format_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">table_mb</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">format_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_mb</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">format_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bloat_mb</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">actual_mb</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">format_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bloat_mb</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">format_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index_mb</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">total_mb</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">format_bloat</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">format_bloat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bloat_mb</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_bloat_indexes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;index bloat monitor&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>虽然看上去很长，但查询该视图获取全库（3TB）所有表的膨胀率，计算只需要50ms。而且只需要访问统计数据，不需要访问关系本体，占用实例的IO。</p>
<hr>
<h2 id="表膨胀的处理">表膨胀的处理</h2>
<p>如果只是玩具数据库，或者业务允许每天有很长的停机维护时间，那么简单地在数据库中执行<code>VACUUM FULL</code>就可以了。但<code>VACUUM FULL</code>需要表上的排它读写锁，但对于需要不间断运行的数据库，我们就需要用到<code>pg_repack</code>来处理表的膨胀。</p>
<ul>
<li>主页：http://reorg.github.io/pg_repack/</li>
</ul>
<p><code>pg_repack</code>已经包含在了PostgreSQL官方的yum源中，因此可以直接通过<code>yum install pg_repack</code>安装。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install pg_repack10
</span></span></code></pre></div><hr>
<h3 id="pg_repack的使用"><code>pg_repack</code>的使用</h3>
<p>与大多数PostgreSQL客户端程序一样，<code>pg_repack</code>也通过类似的参数连接至PostgreSQL服务器。</p>
<p>在使用<code>pg_repack</code>之前，需要在待重整的数据库中创建<code>pg_repack</code>扩展</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_repack</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>然后就可以正常使用了，几种典型的用法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 完全清理整个数据库，开5个并发任务，超时等待10秒</span>
</span></span><span style="display:flex;"><span>pg_repack -d &lt;database&gt; -j <span style="color:#0000cf;font-weight:bold">5</span> -T <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 清理mydb中一张特定的表mytable，超时等待10秒</span>
</span></span><span style="display:flex;"><span>pg_repack mydb -t public.mytable -T <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 清理某个特定的索引 myschema.myindex，注意必须使用带模式的全名</span>
</span></span><span style="display:flex;"><span>pg_repack mydb -i myschema.myindex
</span></span></code></pre></div><p>详细的用法可以参考官方文档。</p>
<hr>
<h3 id="pg_repack的策略"><code>pg_repack</code>的策略</h3>
<p>通常，如果业务存在峰谷周期，则可以选在业务低谷器进行整理。<code>pg_repack</code>执行比较快，但很吃资源。在高峰期执行可能会影响整个数据库的性能表现，也有可能会导致复制滞后。</p>
<p>例如，可以利用上面两节提供的膨胀率监控视图，每天挑选膨胀最为严重的若干张表和若干索引进行自动重整。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#--------------------------------------------------------------#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Name: repack_tables</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Desc: repack table via fullname</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Arg1: database_name</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Argv: list of table full name</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Deps: psql</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#--------------------------------------------------------------#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># repack single table</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> repack_tables<span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">local</span> <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">shift</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    log_info <span style="color:#4e9a06">&#34;repack </span><span style="color:#4e9a06">${</span><span style="color:#000">db</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> tables begin&#34;</span>
</span></span><span style="display:flex;"><span>    log_info <span style="color:#4e9a06">&#34;repack table list: </span><span style="color:#000">$@</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> relname in <span style="color:#000">$@</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">old_size</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>psql <span style="color:#4e9a06">${</span><span style="color:#000">db</span><span style="color:#4e9a06">}</span> -Atqc <span style="color:#4e9a06">&#34;SELECT pg_size_pretty(pg_relation_size(&#39;</span><span style="color:#4e9a06">${</span><span style="color:#000">relname</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#39;));&#34;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># kill_queries ${db}</span>
</span></span><span style="display:flex;"><span>        log_info <span style="color:#4e9a06">&#34;repack table </span><span style="color:#4e9a06">${</span><span style="color:#000">relname</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> begin, old size: </span><span style="color:#4e9a06">${</span><span style="color:#000">old_size</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>        pg_repack <span style="color:#4e9a06">${</span><span style="color:#000">db</span><span style="color:#4e9a06">}</span> -T <span style="color:#0000cf;font-weight:bold">10</span> -t <span style="color:#4e9a06">${</span><span style="color:#000">relname</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">new_size</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>psql <span style="color:#4e9a06">${</span><span style="color:#000">db</span><span style="color:#4e9a06">}</span> -Atqc <span style="color:#4e9a06">&#34;SELECT pg_size_pretty(pg_relation_size(&#39;</span><span style="color:#4e9a06">${</span><span style="color:#000">relname</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#39;));&#34;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        log_info <span style="color:#4e9a06">&#34;repack table </span><span style="color:#4e9a06">${</span><span style="color:#000">relname</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> done , new size: </span><span style="color:#4e9a06">${</span><span style="color:#000">old_size</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> -&gt; </span><span style="color:#4e9a06">${</span><span style="color:#000">new_size</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    log_info <span style="color:#4e9a06">&#34;repack </span><span style="color:#4e9a06">${</span><span style="color:#000">db</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> tables done&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#--------------------------------------------------------------#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Name: get_bloat_tables</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Desc: find bloat tables in given database match some condition</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Arg1: database_name</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Echo: list of full table name</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Deps: psql, monitor.pg_bloat_tables</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#--------------------------------------------------------------#</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> get_bloat_tables<span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#204a87;font-weight:bold">$(</span>psql <span style="color:#4e9a06">${</span><span style="color:#000">1</span><span style="color:#4e9a06">}</span> -Atq <span style="color:#4e9a06">&lt;&lt;-&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    WITH bloat_tables AS (
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        SELECT
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">          nspname || &#39;.&#39; || relname as relname,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">          actual_mb,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">          bloat_pct
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        FROM monitor.pg_bloat_tables
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        WHERE nspname NOT IN (&#39;dba&#39;, &#39;monitor&#39;, &#39;trash&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        ORDER BY 2 DESC,3 DESC
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    )
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -- 64 small + 16 medium + 4 large
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    (SELECT relname FROM bloat_tables WHERE actual_mb &lt; 256 AND bloat_pct &gt; 40 ORDER BY bloat_pct DESC LIMIT 64) UNION
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    (SELECT relname FROM bloat_tables WHERE actual_mb BETWEEN 256 AND 1024  AND bloat_pct &gt; 30 ORDER BY bloat_pct DESC LIMIT 16) UNION
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    (SELECT relname FROM bloat_tables WHERE actual_mb BETWEEN 1024 AND 4096  AND bloat_pct &gt; 20 ORDER BY bloat_pct DESC  LIMIT 4);
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>这里，设置了三条规则：</p>
<ul>
<li>从小于256MB，且膨胀率超过40%的小表中，选出TOP64</li>
<li>从256MB到1GB之间，且膨胀率超过40%的中表中，选出TOP16</li>
<li>从1GB到4GB之间，且膨胀率超过20%的大表中，选出TOP4</li>
</ul>
<p>选出这些表，每天凌晨低谷自动进行重整。超过4GB的表手工处理。</p>
<p>但何时进行重整，还是取决于具体的业务模式。</p>
<hr>
<h3 id="pg_repack的原理"><code>pg_repack</code>的原理</h3>
<p><code>pg_repack</code>的原理相当简单，它会为待重建的表创建一份副本。首先取一份全量快照，将所有活元组写入新表，并通过触发器将所有针对原表的变更同步至新表，最后通过重命名，使用新的紧实副本替换老表。而对于索引，则是通过PostgreSQL的<code>CREATE(DROP) INDEX CONCURRENTLY</code>完成的。</p>
<p><strong>重整表</strong></p>
<ol>
<li>创建一张与原表模式相同，但不带索引的空表。</li>
<li>创建一张与原始表对应的日志表，用于记录<code>pg_repack</code>工作期间该表上发生的变更。</li>
<li>为原始表添加一个行触发器，在相应日志表中记录所有<code>INSERT</code>,<code>DELETE</code>,<code>UPDATE</code>操作。</li>
<li>将老表中的数据复制到新的空表中。</li>
<li>在新表上创建同样的索引</li>
<li>将日志表中的增量变更应用到新表上</li>
<li>通过重命名的方式切换新旧表</li>
<li>将旧的，已经被重命名掉的表<code>DROP</code>掉。</li>
</ol>
<p><strong>重整索引</strong></p>
<ol>
<li>使用<code>CREATE INDEX CONCURRENTLY</code>在原表上创建新索引，保持与旧索引相同的定义。</li>
<li><code>Analyze</code>新索引，并将旧索引设置为无效，在数据目录中将新旧索引交换。</li>
<li>删除旧索引。</li>
</ol>
<hr>
<h3 id="pg_repack的注意事项"><code>pg_repack</code>的注意事项</h3>
<ul>
<li>
<p>重整开始之前，最好取消掉所有正在进行的<code>Vacuum</code>任务。</p>
</li>
<li>
<p>对索引做重整之前，最好能手动清理掉可能正在使用该索引的查询</p>
</li>
<li>
<p>如果出现异常的情况（譬如中途强制退出），有可能会留下未清理的垃圾，需要手工清理。可能包括：</p>
<ul>
<li>临时表与临时索引建立在与原表/索引同一个schema内</li>
<li>临时表的名称为：<code>${schema_name}.table_${table_oid}</code></li>
<li>临时索引的名称为：<code>${schema_name}.index_${table_oid}}</code></li>
<li>原始表上可能会残留相关的触发器，需要手动清理。</li>
</ul>
</li>
<li>
<p>重整特别大的表时，需要预留至少与该表及其索引相同大小的磁盘空间，需要特别小心，手动检查。</p>
</li>
<li>
<p>当完成重整，进行重命名替换时，会产生巨量的WAL，有可能会导致复制延迟，而且无法取消。</p>
</li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-6879266c8aefd5664d6bb062fe6bfdca">PipelineDB快速上手</h1>
	<div class="lead">PipelineDB是PostgreSQL的一个扩展插件，提供流式数据处理的相关功能。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-09-07" class="text-muted">2018年09月07日</time>
        
	</div>
	<h2 id="pipelinedb安装与配置">PipelineDB安装与配置</h2>
<p>PipelineDB可以直接通过官方rpm包安装。</p>
<p>加载PipelineDB需要添加动态链接库，在<code>postgresql.conf</code>中修改配置项并重启：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">shared_preload_libraries</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;pipelinedb&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">max_worker_processes</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">128</span>
</span></span></code></pre></div><p>注意如果不修改<code>max_worker_processes</code>会报错。其他配置都参照标准的PostgreSQL</p>
<h2 id="pipelinedb使用样例--维基pv数据">PipelineDB使用样例 —— 维基PV数据</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 创建Stream
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOREIGN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wiki_stream</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">hour</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">timestamp</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">project</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">title</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">view_count</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">SERVER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pipelinedb</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 在Stream上进行聚合
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wiki_stats</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">materialize</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hour</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">project</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">total_pages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">view_count</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">total_views</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">view_count</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">min_views</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">view_count</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_views</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">avg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">view_count</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">avg_views</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">percentile_cont</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">99</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">WITHIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">view_count</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">p99_views</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">total_bytes_served</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wiki_stream</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hour</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">project</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>然后，向Stream中插入数据：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -sL http://pipelinedb.com/data/wiki-pagecounts <span style="color:#000;font-weight:bold">|</span> gunzip <span style="color:#000;font-weight:bold">|</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>        psql -c <span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        COPY wiki_stream (hour, project, title, view_count, size) FROM STDIN&#34;</span>
</span></span></code></pre></div><h2 id="基本概念">基本概念</h2>
<p>PipelineDB中的基本抽象被称之为：<strong>连续视图（Continuous View）</strong>。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-3c080b3e959d9025aaa10b4ffdcc7eac">TimescaleDB 快速上手</h1>
	<div class="lead">TimescaleDB是PostgreSQL的一个扩展插件，提供时序数据库的一些功能。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-09-07" class="text-muted">2018年09月07日</time>
        
	</div>
	<ul>
<li>官方网站：https://www.timescale.com</li>
<li>官方文档：https://docs.timescale.com/v0.9/main</li>
<li>Github：https://github.com/timescale/timescaledb</li>
</ul>
<hr>
<h2 id="为什么使用timescaledb">为什么使用TimescaleDB</h2>
<h3 id="什么是时间序列数据">什么是时间序列数据？</h3>
<p>我们一直在谈论什么是“时间序列数据”，以及与其他数据有何不同以及为什么？</p>
<p>许多应用程序或数据库实际上采用的是过于狭窄的视图，并将时间序列数据与特定形式的服务器度量值等同起来：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Name:    CPU
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Tags:    Host=MyServer, Region=West
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Data:
</span></span><span style="display:flex;"><span>2017-01-01 01:02:00    70
</span></span><span style="display:flex;"><span>2017-01-01 01:03:00    71
</span></span><span style="display:flex;"><span>2017-01-01 01:04:00    72
</span></span><span style="display:flex;"><span>2017-01-01 01:05:01    68
</span></span></code></pre></div><p>但实际上，在许多监控应用中，通常会收集不同的指标（例如，CPU，内存，网络统计数据，电池寿命）。因此，单独考虑每个度量并不总是有意义的。考虑这种替代性的“更广泛”的数据模型，它保持了同时收集的指标之间的相关性。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Metrics: CPU, free_mem, net_rssi, battery
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Tags:    Host=MyServer, Region=West
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Data:
</span></span><span style="display:flex;"><span>2017-01-01 01:02:00    70    500    -40    80
</span></span><span style="display:flex;"><span>2017-01-01 01:03:00    71    400    -42    80
</span></span><span style="display:flex;"><span>2017-01-01 01:04:00    72    367    -41    80
</span></span><span style="display:flex;"><span>2017-01-01 01:05:01    68    750    -54    79
</span></span></code></pre></div><p>这类数据属于<strong>更广泛的</strong>类别，无论是来自传感器的温度读数，股票价格，机器状态，甚至是登录应用程序的次数。</p>
<p><strong>时间序列数据是统一表示系统，过程或行为随时间变化的数据。</strong></p>
<h3 id="时间序列数据的特征">时间序列数据的特征</h3>
<p>如果仔细研究它是如何生成和摄入的，TimescaleDB等时间序列数据库通常具有以下重要特征：</p>
<ul>
<li><strong>以时间为中心</strong>：数据记录始终有一个时间戳。</li>
<li><strong>仅追加-</strong>：数据是几乎完全追加只（插入）。</li>
<li><strong>最近</strong>：新数据通常是关于最近的时间间隔，我们更少更新或回填旧时间间隔的缺失数据。</li>
</ul>
<p>尽管数据的频率或规律性并不重要，它可以每毫秒或每小时收集一次。它也可以定期或不定期收集（例如，当发生某些<em>事件</em>时，而不是在预先确定的时间）。</p>
<p>但是没有数据库很久没有时间字段？与标准关系“业务”数据等其他数据相比，时间序列数据（以及支持它们的数据库）之间的一个主要区别是<strong>对数据的更改是插入而不是覆盖</strong>。</p>
<h3 id="时间序列数据无处不在">时间序列数据无处不在</h3>
<p>时间序列数据无处不在，但有些环境特别是在洪流中创建。</p>
<ul>
<li><strong>监控计算机系统</strong>：虚拟机，服务器，容器指标（CPU，可用内存，网络/磁盘IOP），服务和应用程序指标（请求率，请求延迟）。</li>
<li><strong>金融交易系统</strong>：经典证券，较新的加密货币，支付，交易事件。</li>
<li><strong>物联网</strong>：工业机器和设备上的传感器，可穿戴设备，车辆，物理容器，托盘，智能家居的消费设备等的数据。</li>
<li><strong>事件应用程序</strong>：用户/客户交互数据，如点击流，综合浏览量，登录，注册等。</li>
<li><strong>商业智能</strong>：跟踪关键指标和业务的整体健康状况。</li>
<li><strong>环境监测</strong>：温度，湿度，压力，pH值，花粉计数，空气流量，一氧化碳（CO），二氧化氮（NO2），颗粒物质（PM10）。</li>
<li>（和更多）</li>
</ul>
<hr>
<h2 id="时序数据模型">时序数据模型</h2>
<p>TimescaleDB使用“宽表”数据模型，这在关系数据库中是非常普遍的。这使得Timescale与大多数其他时间序列数据库有所不同，后者通常使用“窄表”模型。</p>
<p>在这里，我们讨论为什么我们选择宽表模型，以及我们如何推荐将它用于时间序列数据，使用物联网（IoT）示例。</p>
<p>设想一个由1,000个IoT设备组成的分布式组，旨在以不同的时间间隔收集环境数据。这些数据可能包括：</p>
<ul>
<li><strong>标识符：</strong> <code>device_id</code>，<code>timestamp</code></li>
<li><strong>元数据：</strong> <code>location_id</code>，，，<code>dev_type``firmware_version``customer_id</code></li>
<li><strong>设备指标：</strong> <code>cpu_1m_avg</code>，，，，，<code>free_mem``used_mem``net_rssi``net_loss``battery</code></li>
<li><strong>传感器指标：</strong> <code>temperature</code>，，，，，<code>humidity``pressure``CO``NO2``PM10</code></li>
</ul>
<p>例如，您的传入数据可能如下所示：</p>
<table>
<thead>
<tr>
<th>时间戳</th>
<th>设备ID</th>
<th>cpu_1m_avg</th>
<th>Fri_mem</th>
<th>温度</th>
<th>LOCATION_ID</th>
<th>dev_type</th>
</tr>
</thead>
<tbody>
<tr>
<td>2017-01-01 01:02:00</td>
<td>ABC123</td>
<td>80</td>
<td>500MB</td>
<td>72</td>
<td>335</td>
<td>领域</td>
</tr>
<tr>
<td>2017-01-01 01:02:23</td>
<td>def456</td>
<td>90</td>
<td>400MB</td>
<td>64</td>
<td>335</td>
<td>屋顶</td>
</tr>
<tr>
<td>2017-01-01 01:02:30</td>
<td>ghi789</td>
<td>120</td>
<td>0MB</td>
<td>56</td>
<td>77</td>
<td>屋顶</td>
</tr>
<tr>
<td>2017-01-01 01:03:12</td>
<td>ABC123</td>
<td>80</td>
<td>500MB</td>
<td>72</td>
<td>335</td>
<td>领域</td>
</tr>
<tr>
<td>2017-01-01 01:03:35</td>
<td>def456</td>
<td>95</td>
<td>350MB</td>
<td>64</td>
<td>335</td>
<td>屋顶</td>
</tr>
<tr>
<td>2017-01-01 01:03:42</td>
<td>ghi789</td>
<td>100</td>
<td>100MB</td>
<td>56</td>
<td>77</td>
<td>屋顶</td>
</tr>
</tbody>
</table>
<p>现在，我们来看看用这些数据建模的各种方法。</p>
<h3 id="窄表模型">窄表模型</h3>
<p>大多数时间序列数据库将以下列方式表示这些数据：</p>
<ul>
<li>代表每个指标作为一个单独的实体（例如，表示与作为两个不同的东西）<code>cpu_1m_avg``free_mem</code></li>
<li>为该指标存储一系列“时间”，“值”对</li>
<li>将元数据值表示为与该指标/标记集组合关联的“标记集”</li>
</ul>
<p>在这个模型中，每个度量/标签集组合被认为是包含一系列时间/值对的单独“时间序列”。</p>
<p>使用我们上面的例子，这种方法会导致9个不同的“时间序列”，每个“时间序列”由一组独特的标签定义。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1. {name:  cpu_1m_avg,  device_id: abc123,  location_id: 335,  dev_type: field}
</span></span><span style="display:flex;"><span>2. {name:  cpu_1m_avg,  device_id: def456,  location_id: 335,  dev_type: roof}
</span></span><span style="display:flex;"><span>3. {name:  cpu_1m_avg,  device_id: ghi789,  location_id:  77,  dev_type: roof}
</span></span><span style="display:flex;"><span>4. {name:    free_mem,  device_id: abc123,  location_id: 335,  dev_type: field}
</span></span><span style="display:flex;"><span>5. {name:    free_mem,  device_id: def456,  location_id: 335,  dev_type: roof}
</span></span><span style="display:flex;"><span>6. {name:    free_mem,  device_id: ghi789,  location_id:  77,  dev_type: roof}
</span></span><span style="display:flex;"><span>7. {name: temperature,  device_id: abc123,  location_id: 335,  dev_type: field}
</span></span><span style="display:flex;"><span>8. {name: temperature,  device_id: def456,  location_id: 335,  dev_type: roof}
</span></span><span style="display:flex;"><span>9. {name: temperature,  device_id: ghi789,  location_id:  77,  dev_type: roof}
</span></span></code></pre></div><p>这样的时间序列的数量与每个标签的基数的叉积（即，（＃名称）×（＃设备ID）×（＃位置ID）×（设备类型））的交叉积。</p>
<p>而且这些“时间序列”中的每一个都有自己的一组时间/值序列。</p>
<p>现在，如果您独立收集每个指标，而且元数据很少，则此方法可能有用。</p>
<p>但总的来说，我们认为这种方法是有限的。它会丢失数据中的固有结构，使得难以提出各种有用的问题。例如：</p>
<ul>
<li>系统状态到0 时是什么状态？<code>free_mem</code></li>
<li>如何关联？<code>cpu_1m_avg``free_mem</code></li>
<li>平均值是多少？<code>temperature``location_id</code></li>
</ul>
<p>我们也发现这种方法认知混乱。我们是否真的收集了9个不同的时间序列，或者只是一个包含各种元数据和指标读数的数据集？</p>
<h3 id="宽表模型">宽表模型</h3>
<p>相比之下，TimescaleDB使用宽表模型，它反映了数据中的固有结构。</p>
<p>我们的宽表模型看起来与初始数据流完全一样：</p>
<table>
<thead>
<tr>
<th>时间戳</th>
<th>设备ID</th>
<th>cpu_1m_avg</th>
<th>Fri_mem</th>
<th>温度</th>
<th>LOCATION_ID</th>
<th>dev_type</th>
</tr>
</thead>
<tbody>
<tr>
<td>2017-01-01 01:02:00</td>
<td>ABC123</td>
<td>80</td>
<td>500MB</td>
<td>72</td>
<td>42</td>
<td>领域</td>
</tr>
<tr>
<td>2017-01-01 01:02:23</td>
<td>def456</td>
<td>90</td>
<td>400MB</td>
<td>64</td>
<td>42</td>
<td>屋顶</td>
</tr>
<tr>
<td>2017-01-01 01:02:30</td>
<td>ghi789</td>
<td>120</td>
<td>0MB</td>
<td>56</td>
<td>77</td>
<td>屋顶</td>
</tr>
<tr>
<td>2017-01-01 01:03:12</td>
<td>ABC123</td>
<td>80</td>
<td>500MB</td>
<td>72</td>
<td>42</td>
<td>领域</td>
</tr>
<tr>
<td>2017-01-01 01:03:35</td>
<td>def456</td>
<td>95</td>
<td>350MB</td>
<td>64</td>
<td>42</td>
<td>屋顶</td>
</tr>
<tr>
<td>2017-01-01 01:03:42</td>
<td>ghi789</td>
<td>100</td>
<td>100MB</td>
<td>56</td>
<td>77</td>
<td>屋顶</td>
</tr>
</tbody>
</table>
<p>在这里，每一行都是一个新的读数，在给定的时间里有一组度量和元数据。这使我们能够保留数据中的关系，并提出比以前更有趣或探索性更强的问题。</p>
<p>当然，这不是一种新的格式：这是在关系数据库中常见的。这也是为什么我们发现这种格式更直观的原因。</p>
<h3 id="与关系数据join">与关系数据JOIN</h3>
<p>TimescaleDB的数据模型与关系数据库还有另一个相似之处：它支持JOIN。具体来说，可以将附加元数据存储在辅助表中，然后在查询时使用该数据。</p>
<p>在我们的示例中，可以有一个单独的位置表，映射到该位置的其他元数据。例如：<code>location_id</code></p>
<table>
<thead>
<tr>
<th>LOCATION_ID</th>
<th>name</th>
<th>纬度</th>
<th>经度</th>
<th>邮政编码</th>
<th>地区</th>
</tr>
</thead>
<tbody>
<tr>
<td>42</td>
<td>大中央车站</td>
<td>40.7527°N</td>
<td>73.9772°W</td>
<td>10017</td>
<td>NYC</td>
</tr>
<tr>
<td>77</td>
<td>大厅7</td>
<td>42.3593°N</td>
<td>71.0935°W</td>
<td>02139</td>
<td>马萨诸塞</td>
</tr>
</tbody>
</table>
<p>然后在查询时，通过加入我们的两个表格，可以提出如下问题：10017 中我们的设备的平均值是多少？<code>free_mem``zip_code</code></p>
<p>如果没有联接，则需要对数据进行非规范化并将所有元数据存储在每个测量行中。这造成数据膨胀，并使数据管理更加困难。</p>
<p>通过连接，可以独立存储元数据，并更轻松地更新映射。</p>
<p>例如，如果我们想更新我们的“区域”为77（例如从“马萨诸塞州”到“波士顿”），我们可以进行此更改，而不必返回并覆盖历史数据。<code>location_id</code></p>
<hr>
<h2 id="架构与概念">架构与概念</h2>
<p>TimescaleDB作为PostgreSQL的扩展实现，这意味着Timescale数据库在整个PostgreSQL实例中运行。该扩展模型允许数据库利用PostgreSQL的许多属性，如可靠性，安全性以及与各种第三方工具的连接性。同时，TimescaleDB通过在PostgreSQL的查询规划器，数据模型和执行引擎中添加钩子，充分利用扩展可用的高度自定义。</p>
<p>从用户的角度来看，TimescaleDB公开了一些看起来像单数表的称为<strong>hypertable的</strong>表，它们实际上是一个抽象或许多单独表的虚拟视图，称为<strong>块</strong>。</p>
<p><img alt="可改变和块" src="https://assets.iobeam.com/images/docs/illustration-hypertable-chunk.svg"></p>
<p>通过将hypertable的数据划分为一个或多个维度来创建块：所有可编程元素按时间间隔分区，并且可以通过诸如设备ID，位置，用户ID等的关键字进行分区。我们有时将此称为分区横跨“时间和空间”。</p>
<h3 id="术语">术语</h3>
<h4 id="hypertables">Hypertables</h4>
<p>与数据交互的主要点是一个可以抽象化的跨越所有空间和时间间隔的单个连续表，从而可以通过标准SQL查询它。</p>
<p>实际上，所有与TimescaleDB的用户交互都是使用可调整的。创建表格和索引，修改表格，插入数据，选择数据等都可以（也应该）在hypertable上执行。[[跳转到基本的SQL操作] [jumpSQL]]</p>
<p>一个带有列名和类型的标准模式定义了一个hypertable，其中至少一列指定了一个时间值，另一列（可选）指定了一个额外的分区键。</p>
<blockquote>
<p>提示：请参阅我们的[数据模型] []，以进一步讨论组织数据的各种方法，具体取决于您的使用情况; 最简单和最自然的就像许多关系数据库一样在“宽桌”中。</p>
</blockquote>
<p>单个TimescaleDB部署可以存储多个可更改的超文本，每个超文本具有不同的架构。</p>
<p>在TimescaleDB中创建一个可超过的值需要两个简单的SQL命令:( 使用标准的SQL语法），后面跟着。<code>CREATE TABLE``SELECT create_hypertable()</code></p>
<p>时间索引和分区键自动创建在hypertable上，尽管也可以创建附加索引（并且TimescaleDB支持所有PostgreSQL索引类型）。</p>
<h4 id="chunk">Chunk</h4>
<p>在内部，TimescaleDB自动将每个可分<strong>区块</strong>分割成<strong>块</strong>，每个块对应于特定的时间间隔和分区键空间的一个区域（使用散列）。这些分区是不相交的（非重叠的），这有助于查询计划人员最小化它必须接触以解决查询的组块集合。</p>
<p>每个块都使用标准数据库表来实现。（在PostgreSQL内部，这个块实际上是一个“父”可变的“子表”。）</p>
<p>块是正确的大小，确保表的索引的所有B树可以在插入期间驻留在内存中。这样可以避免在修改这些树中的任意位置时发生颠簸。</p>
<p>此外，通过避免过大的块，我们可以避免根据自动化保留策略删除删除的数据时进行昂贵的“抽真空”操作。运行时可以通过简单地删除块（内部表）来执行这些操作，而不是删除单独的行。</p>
<hr>
<h2 id="单节点与集群">单节点与集群</h2>
<p>TimescaleDB在<strong>单节点</strong>部署和<strong>集群</strong>部署（开发中）上执行这种广泛的分区。虽然分区传统上只用于在多台机器上扩展，但它也允许我们扩展到高写入速率（并改进了并行查询），即使在单台机器上也是如此。</p>
<p>TimescaleDB的当前开源版本仅支持单节点部署。值得注意的是，TimescaleDB的单节点版本已经在商用机器上基于超过100亿行高可用性进行了基准测试，而没有插入性能的损失。</p>
<h3 id="单节点分区的好处">单节点分区的好处</h3>
<p>在单台计算机上扩展数据库性能的常见问题是内存和磁盘之间的显着成本/性能折衷。最终，我们的整个数据集不适合内存，我们需要将我们的数据和索引写入磁盘。</p>
<p>一旦数据足够大以至于我们无法将索引的所有页面（例如B树）放入内存中，那么更新树的随机部分可能会涉及从磁盘交换数据。像PostgreSQL这样的数据库为每个表索引保留一个B树（或其他数据结构），以便有效地找到该索引中的值。所以，当您索引更多列时，问题会复杂化。</p>
<p>但是，由于TimescaleDB创建的每个块本身都存储为单独的数据库表，因此其所有索引都只能建立在这些小得多的表中，而不是代表整个数据集的单个表。所以，如果我们正确地确定这些块的大小，我们可以将最新的表（和它们的B-树）完全放入内存中，并避免交换到磁盘的问题，同时保持对多个索引的支持。</p>
<p>有关TimescaleDB自适应空间/时间组块的动机和设计的更多信息，请参阅我们的[技术博客文章] [chunking]。</p>
<hr>
<h2 id="timescaledb-与-postgresql-相比">TimescaleDB 与 PostgreSQL 相比</h2>
<p>TimescaleDB相对于存储时间序列数据的vanilla PostgreSQL或其他传统RDBMS提供了三大优势：</p>
<ol>
<li>数据采集率要高得多，尤其是在数据库规模较大的情况下。</li>
<li>查询性能从相当于<em>数量级更大</em>。</li>
<li>时间导向的功能。</li>
</ol>
<p>而且由于TimescaleDB仍然允许您使用PostgreSQL的全部功能和工具 - 例如，与关系表联接，通过PostGIS进行地理空间查询，以及任何可以说PostgreSQL的连接器 - <strong>都没</strong>有理由<strong>不</strong>使用TimescaleDB来存储时间序列PostgreSQL节点中的数据。<code>pg_dump``pg_restore</code></p>
<h3 id="更高的写入速率">更高的写入速率</h3>
<p>对于时间序列数据，TimescaleDB比PostgreSQL实现更高且更稳定的采集速率。正如我们的<a href="https://docs.timescale.com/introduction/architecture#benefits-chunking">架构讨论中</a>所描述的那样，只要索引表不能再适应内存，PostgreSQL的性能就会显着下降。</p>
<p>特别是，无论何时插入新行，数据库都需要更新表中每个索引列的索引（例如B树），这将涉及从磁盘交换一个或多个页面。在这个问题上抛出更多的内存只会拖延不可避免的，一旦您的时间序列表达到数千万行，每秒10K-100K +行的吞吐量就会崩溃到每秒数百行。</p>
<p>TimescaleDB通过大量利用时空分区来解决这个问题，即使在<em>单台机器上</em>运行<em>也是如此</em>。因此，对最近时间间隔的所有写入操作仅适用于保留在内存中的表，因此更新任何二级索引的速度也很快。</p>
<p>基准测试显示了这种方法的明显优势。数据库客户端插入适度大小的包含时间，设备标记集和多个数字指标（在本例中为10）的批量数据，以下10亿行（在单台计算机上）的基准测试模拟常见监控方案。在这里，实验在具有网络连接的SSD存储的标准Azure VM（DS4 v2,8核心）上执行。</p>
<p><img alt="img" src="https://assets.timescale.com/benchmarks/timescale-vs-postgres-insert-1B.jpg"></p>
<p>我们观察到PostgreSQL和TimescaleDB对于前20M请求的启动速度大约相同（分别为106K和114K），或者每秒超过1M指标。然而，在大约五千万行中，PostgreSQL的表现开始急剧下降。在过去的100M行中，它的平均值仅为5K行/秒，而TimescaleDB保留了111K行/秒的吞吐量。</p>
<p>简而言之，Timescale在PostgreSQL的总时间的<strong>十五分</strong>之一中加载了十亿行数据库，并且吞吐量超过了PostgreSQL在这些较大规模时的<strong>20倍</strong>。</p>
<p>我们的TimescaleDB基准测试表明，即使使用单个磁盘，它仍能保持超过10B行的恒定性能。</p>
<p>此外，用户在一台计算机上利用多个磁盘时，可以为数<strong>以十亿计的行提供</strong>稳定的性能，无论是采用RAID配置，还是使用TimescaleDB支持在多个磁盘上传播单个超级缓存（通过多个表空间传统的PostgreSQL表）。</p>
<h3 id="卓越或类似的查询性能">卓越或类似的查询性能</h3>
<p>在单磁盘机器上，许多只执行索引查找或表扫描的简单查询在PostgreSQL和TimescaleDB之间表现相似。</p>
<p>例如，在具有索引时间，主机名和CPU使用率信息的100M行表上，对于每个数据库，以下查询将少于5毫秒：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SELECT date_trunc(&#39;minute&#39;, time) AS minute, max(user_usage)
</span></span><span style="display:flex;"><span>  FROM cpu
</span></span><span style="display:flex;"><span>  WHERE hostname = &#39;host_1234&#39;
</span></span><span style="display:flex;"><span>    AND time &gt;= &#39;2017-01-01 00:00&#39; AND time &lt; &#39;2017-01-01 01:00&#39;
</span></span><span style="display:flex;"><span>  GROUP BY minute ORDER BY minute;
</span></span></code></pre></div><p>涉及对索引进行基本扫描的类似查询在两者之间也是等效的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SELECT * FROM cpu
</span></span><span style="display:flex;"><span>  WHERE usage_user &gt; 90.0
</span></span><span style="display:flex;"><span>    AND time &gt;= &#39;2017-01-01&#39; AND time &lt; &#39;2017-01-02&#39;;
</span></span></code></pre></div><p>涉及基于时间的GROUP BY的较大查询 - 在面向时间的分析中很常见 - 通常在TimescaleDB中实现卓越的性能。</p>
<p>例如，当整个（超）表为100M行时，接触33M行的以下查询在TimescaleDB中速度提高<strong>5倍</strong>，而在1B行时速度提高约<strong>2</strong>倍。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SELECT date_trunc(&#39;hour&#39;, time) as hour,
</span></span><span style="display:flex;"><span>    hostname, avg(usage_user)
</span></span><span style="display:flex;"><span>  FROM cpu
</span></span><span style="display:flex;"><span>  WHERE time &gt;= &#39;2017-01-01&#39; AND time &lt; &#39;2017-01-02&#39;
</span></span><span style="display:flex;"><span>  GROUP BY hour, hostname
</span></span><span style="display:flex;"><span>  ORDER BY hour;
</span></span></code></pre></div><p>此外，可以约时间订购专理等查询可以<em>多</em>在TimescaleDB更好的性能。</p>
<p>例如，TimescaleDB引入了基于时间的“合并追加”优化，以最小化必须处理以执行以下操作的组的数量（考虑到时间已经被排序）。对于我们的100M行表，这导致查询延迟比PostgreSQL快<strong>396</strong>倍（82ms vs. 32566ms）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SELECT date_trunc(&#39;minute&#39;, time) AS minute, max(usage_user)
</span></span><span style="display:flex;"><span>  FROM cpu
</span></span><span style="display:flex;"><span>  WHERE time &lt; &#39;2017-01-01&#39;
</span></span><span style="display:flex;"><span>  GROUP BY minute
</span></span><span style="display:flex;"><span>  ORDER BY minute DESC
</span></span><span style="display:flex;"><span>  LIMIT 5;
</span></span></code></pre></div><p>我们将很快发布PostgreSQL和TimescaleDB之间更完整的基准测试比较，以及复制我们基准的软件。</p>
<p>我们的查询基准测试的高级结果是，对于几乎<strong>所有</strong>我们已经尝试过的<strong>查询</strong>，TimescaleDB都可以为PostgreSQL 实现<strong>类似或优越（或极其优越）的性能</strong>。</p>
<p>与PostgreSQL相比，TimescaleDB的一项额外成本是更复杂的计划（假设单个可超集可由许多块组成）。这可以转化为几毫秒的计划时间，这对于非常低延迟的查询（&lt;10ms）可能具有不成比例的影响。</p>
<h3 id="时间导向的功能">时间导向的功能</h3>
<p>TimescaleDB还包含许多在传统关系数据库中没有的时间导向功能。这些包括特殊查询优化（如上面的合并附加），它为面向时间的查询以及其他面向时间的函数（其中一些在下面列出）提供了一些巨大的性能改进。</p>
<h4 id="面向时间的分析">面向时间的分析</h4>
<p>TimescaleDB包含面向时间分析的<em>新</em>功能，其中包括以下一些功能：</p>
<ul>
<li><strong>时间分段</strong>：标准功能的更强大的版本，它允许任意的时间间隔（例如5分钟，6小时等），以及灵活的分组和偏移，而不仅仅是第二，分钟，小时等。<code>date_trunc</code></li>
<li><strong>最后</strong>和<strong>第一个</strong>聚合：这些函数允许您按另一个列的顺序获取一列的值。例如，将返回基于组内时间的最新温度值（例如，一小时）。<code>last(temperature, time)</code></li>
</ul>
<p>这些类型的函数能够实现非常自然的面向时间的查询。例如，以下财务查询打印每个资产的开盘价，收盘价，最高价和最低价。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SELECT time_bucket(&#39;3 hours&#39;, time) AS period
</span></span><span style="display:flex;"><span>    asset_code,
</span></span><span style="display:flex;"><span>    first(price, time) AS opening, last(price, time) AS closing,
</span></span><span style="display:flex;"><span>    max(price) AS high, min(price) AS low
</span></span><span style="display:flex;"><span>  FROM prices
</span></span><span style="display:flex;"><span>  WHERE time &gt; NOW() - interval &#39;7 days&#39;
</span></span><span style="display:flex;"><span>  GROUP BY period, asset_code
</span></span><span style="display:flex;"><span>  ORDER BY period DESC, asset_code;
</span></span></code></pre></div><p>通过辅助列进行排序的能力（甚至不同于集合）能够实现一些强大的查询类型。例如，财务报告中常见的技术是“双时态建模”，它们分别从与记录观察时间有关的观察时间的原因出发。在这样的模型中，更正插入为新行（具有更新的<em>time_recorded</em>字段），并且不替换现有数据。<code>last</code></p>
<p>以下查询返回每个资产的每日价格，按最新记录的价格排序。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SELECT time_bucket(&#39;1 day&#39;, time) AS day,
</span></span><span style="display:flex;"><span>    asset_code,
</span></span><span style="display:flex;"><span>    last(price, time_recorded)
</span></span><span style="display:flex;"><span>  FROM prices
</span></span><span style="display:flex;"><span>  WHERE time &gt; &#39;2017-01-01&#39;
</span></span><span style="display:flex;"><span>  GROUP BY day, asset_code
</span></span><span style="display:flex;"><span>  ORDER BY day DESC, asset_code;
</span></span></code></pre></div><p>有关TimescaleDB当前（和增长中）时间功能列表的更多信息，请<a href="https://docs.timescale.com/api#time_bucket">参阅我们的API</a>。</p>
<h4 id="面向时间的数据管理">面向时间的数据管理</h4>
<p>TimescaleDB还提供了某些在PostgreSQL中不易获取或执行的数据管理功能。例如，在处理时间序列数据时，数据通常会很快建立起来。因此，您希望按照“仅存储一周原始数据”的方式编写<em>数据保留</em>策略。</p>
<p>实际上，将这与使用连续聚合相结合是很常见的，因此您可以保留两个可改写的数据：一个包含原始数据，另一个包含已经汇总为精细或小时聚合的数据。然后，您可能需要在两个（超）表上定义不同的保留策略，以长时间存储汇总的数据。</p>
<p>TimescaleDB允许通过其功能有效地删除<strong>块</strong>级别的旧数据，而不是行级别的旧数据。<code>drop_chunks</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SELECT drop_chunks(interval &#39;7 days&#39;, &#39;conditions&#39;);
</span></span></code></pre></div><p>这将删除只包含比此持续时间早的数据的可超级“条件”中的所有块（文件），而不是删除块中的任何单独数据行。这避免了底层数据库文件中的碎片，这反过来又避免了在非常大的表格中可能过于昂贵的抽真空的需要。</p>
<p>有关更多详细信息，请参阅我们的<a href="https://docs.timescale.com/api/data-retention">数据保留</a>讨论，包括如何自动执行数据保留策略。</p>
<hr>
<h2 id="timescaledb之于nosql">TimescaleDB之于NoSQL</h2>
<p>与一般的NoSQL数据库（例如MongoDB，Cassandra）或更专门的时间导向数据库（例如InfluxDB，KairosDB）相比，TimescaleDB提供了定性和定量差异：</p>
<ul>
<li><strong>普通SQL</strong>：即使在规模上，TimescaleDB也可以为时间序列数据提供标准SQL查询的功能。大多数（所有？）NoSQL数据库都需要学习新的查询语言或使用最好的“SQL-ish”（它仍然与现有工具兼容）。</li>
<li><strong>操作简单</strong>：使用TimescaleDB，您只需要为关系数据和时间序列数据管理一个数据库。否则，用户通常需要将数据存储到两个数据库中：“正常”关系数据库和第二个时间序列数据库。</li>
<li><strong>JOIN</strong>可以通过关系数据和时间序列数据执行。</li>
<li>对于不同的查询集，查询<strong>性能</strong>更快。在NoSQL数据库中，更复杂的查询通常是缓慢或全表扫描，而有些数据库甚至无法支持许多自然查询。</li>
<li>**像PostgreSQL一样管理，**并继承对不同数据类型和索引（B树，哈希，范围，BRIN，GiST，GIN）的支持。</li>
<li><strong>对地理空间数据的本地支持</strong>：存储在TimescaleDB中的数据可以利用PostGIS的几何数据类型，索引和查询。</li>
<li><strong>第三方工具</strong>：TimescaleDB支持任何可以说SQL的东西，包括像Tableau这样的BI工具。</li>
</ul>
<h3 id="何时不使用timescaledb">何时<em>不</em>使用TimescaleDB？</h3>
<p>然后，如果以下任一情况属实，则可能不想使用TimescaleDB：</p>
<ul>
<li><strong>简单的读取要求</strong>：如果您只需要快速键值查找或单列累积，则内存或列导向数据库可能更合适。前者显然不能扩展到相同的数据量，但是，后者的性能明显低于更复杂的查询。</li>
<li><strong>非常稀疏或非结构化的数据</strong>：尽管TimescaleDB利用PostgreSQL对JSON / JSONB格式的支持，并且相当有效地处理稀疏性（空值的位图），但在某些情况下，无模式体系结构可能更合适。</li>
<li><strong>重要的压缩是一个优先事项</strong>：基准测试显示在ZFS上运行的TimescaleDB获得约4倍的压缩率，但压缩优化的列存储可能更适合于更高的压缩率。</li>
<li><strong>不频繁或离线分析</strong>：如果响应时间较慢（或响应时间限于少量预先计算的度量标准），并且您不希望许多应用程序/用户同时访问该数据，则可以避免使用数据库，而只是将数据存储在分布式文件系统中。</li>
</ul>
<hr>
<h2 id="安装">安装</h2>
<p><strong>Mac</strong>下直接使用 brew 安装，最省事的方法，可以连PostgreSQL和PostGIS一起装了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Add our tap</span>
</span></span><span style="display:flex;"><span>brew tap timescale/tap
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># To install</span>
</span></span><span style="display:flex;"><span>brew install timescaledb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Post-install to move files to appropriate place</span>
</span></span><span style="display:flex;"><span>/usr/local/bin/timescaledb_move.sh
</span></span></code></pre></div><p>在 EL 系操作系统下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo yum install -y https://download.postgresql.org/pub/repos/yum/9.6/redhat/fedora-7.2-x86_64/pgdg-redhat10-10-1.noarch.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wget https://timescalereleases.blob.core.windows.net/rpm/timescaledb-0.9.0-postgresql-9.6-0.x86_64.rpm
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For PostgreSQL 10:</span>
</span></span><span style="display:flex;"><span>wget https://timescalereleases.blob.core.windows.net/rpm/timescaledb-0.9.0-postgresql-10-0.x86_64.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># To install</span>
</span></span><span style="display:flex;"><span>sudo yum install timescaledb
</span></span></code></pre></div><hr>
<h2 id="配置">配置</h2>
<p>在<code>postgresql.conf</code>中添加以下配置，即可在PostgreSQL启动时加载该插件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">shared_preload_libraries</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;timescaledb&#39;</span>
</span></span></code></pre></div><p>在数据库中执行以下命令以创建timescaledb扩展。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">timescaledb</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="调参">调参</h2>
<p>对timescaledb比较重要的参数是锁的数量。</p>
<p>TimescaleDB在很大程度上依赖于表分区来扩展时间序列工作负载，这对<a href="https://www.postgresql.org/docs/current/static/runtime-config-locks.html">锁管理</a>有影响。在查询过程中，可修改需要在许多块（子表）上获取锁，这会耗尽所允许的锁的数量的默认限制。这可能会导致如下警告：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>psql: FATAL:  out of shared memory
</span></span><span style="display:flex;"><span>HINT:  You might need to increase max_locks_per_transaction.
</span></span></code></pre></div><p>为了避免这个问题，有必要修改默认值（通常是64），增加最大锁的数量。由于更改此参数需要重新启动数据库，因此建议预估未来的增长。对大多数情况，推荐配置为：<code>max_locks_per_transaction</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">max_locks_per_transaction</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">2 * num_chunks</span>
</span></span></code></pre></div><p><code>num_chunks</code>是在**超级表（HyperTable)<strong>中可能存在的</strong>块（chunk）**数量上限。</p>
<p>这种配置是考虑到对超级表查询可能申请锁的数量粗略等于超级表中的块数量，如果使用索引的话还要翻倍。</p>
<p>注意这个参数并不是精确的限制，它只是控制每个事物中<strong>平均</strong>的对象锁数量。</p>
<hr>
<h2 id="创建超表">创建超表</h2>
<p>为了创建一个可改写的，你从一个普通的SQL表开始，然后通过函数（<a href="https://docs.timescale.com/api#create_hypertable">API参考</a>）将它转换为一个可改写的。<code>create_hypertable</code></p>
<p>以下示例创建一个可随时间跨越一系列设备来跟踪温度和湿度的可调整高度。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>-- We start by creating a regular SQL table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CREATE TABLE conditions (
</span></span><span style="display:flex;"><span>  time        TIMESTAMPTZ       NOT NULL,
</span></span><span style="display:flex;"><span>  location    TEXT              NOT NULL,
</span></span><span style="display:flex;"><span>  temperature DOUBLE PRECISION  NULL,
</span></span><span style="display:flex;"><span>  humidity    DOUBLE PRECISION  NULL
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>接下来，把它变成一个超表：<code>create_hypertable</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- This creates a hypertable that is partitioned by time
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">--   using the values in the `time` column.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">create_hypertable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;conditions&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;time&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- OR you can additionally partition the data on another
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">--   dimension (what we call &#39;space partitioning&#39;).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- E.g., to partition `location` into 4 partitions:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">create_hypertable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;conditions&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;time&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;location&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="插入和查询">插入和查询</h2>
<p>通过普通的SQL 命令将数据插入到hypertable中，例如使用毫秒时间戳：<code>INSERT</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>INSERT INTO conditions(time, location, temperature, humidity)
</span></span><span style="display:flex;"><span>  VALUES (NOW(), &#39;office&#39;, 70.0, 50.0);
</span></span></code></pre></div><p>同样，查询数据是通过正常的SQL 命令完成的。<code>SELECT</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SELECT * FROM conditions ORDER BY time DESC LIMIT 100;
</span></span></code></pre></div><p>SQL 和命令也按预期工作。有关使用TimescaleDB标准SQL接口的更多示例，请参阅我们的<a href="https://docs.timescale.com/using-timescaledb">使用页面</a>。<code>UPDATE``DELETE</code></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-1ffa0ab167bac4475b9a69f4abbf18e0">故障档案：PostgreSQL事务号回卷</h1>
	<div class="lead">XID WrapAround也许是PostgreSQL特有的一种故障</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-07-20" class="text-muted">2018年07月20日</time>
        
	</div>
	<p>遇到一次磁盘坏块导致的事务回卷故障：</p>
<ul>
<li>主库（PostgreSQL 9.3）磁盘坏块导致几张表上的VACUUM FREEZE执行失败。</li>
<li>无法回收老旧事务ID，导致整库事务ID濒临用尽，数据库进入自我保护状态不可用。</li>
<li>磁盘坏块导致手工VACUUM抢救不可行。</li>
<li>提升从库后，需要紧急VACUUM FREEZE才能继续服务，进一步延长了故障时间。</li>
<li>主库进入保护状态后提交日志（clog）没有及时复制到从库，从库产生存疑事务拒绝服务。</li>
</ul>
<hr>
<h2 id="摘要">摘要</h2>
<p>这是一个即将下线老旧库，疏于管理。坏块征兆在一周前就已经出现，没有及时跟进年龄。
通常AutoVacuum会保证很难出现这种故障，但一旦出现往往意味着祸不单行…让救火更加困难了……</p>
<hr>
<h2 id="背景">背景</h2>
<p>PostgreSQL实现了<strong>快照隔离（Snapshot Isolation）</strong>，每个事务开始时都能获取数据库在该时刻的快照（也就是只能看到<strong>过去</strong>事务提交的结果，看不见<strong>后续</strong>事务提交的结果）。这一强大的功能是通过MVCC实现的，但也引入了额外复杂度，例如<strong>事务ID回卷</strong>问题。</p>
<p>事务ID（<code>xid</code>）是用于标识事务的<strong>32位无符号整型数值</strong>，递增分配，其中值0,1,2为保留值，溢出后回卷为3重新开始。<strong>事务ID之间的大小关系决定了事务的先后顺序</strong>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * TransactionIdPrecedes --- is id1 logically &lt; id2?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000">TransactionIdPrecedes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TransactionId</span> <span style="color:#000">id1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">TransactionId</span> <span style="color:#000">id2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * If either ID is a permanent XID then we can just do unsigned
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * comparison.  If both are normal, do a modulo-2^32 comparison.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">int32</span>		<span style="color:#000">diff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">TransactionIdIsNormal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">TransactionIdIsNormal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">id1</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">id2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">diff</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">int32</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">id1</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">id2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">diff</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><img alt="xid-wrap-around" src="/img/blog/pg/xid-wrap-around.png"></p>
<p>可以将<code>xid</code>的取值域视为一个整数环，但刨除<code>0,1,2</code>三个特殊值。0代表无效事务ID，1代表系统事务ID，2代表冻结事务ID。特殊的事务ID比任何普通事务ID小。而普通事务ID之间的比较可参见上图：它取决于两个事务ID的差值是否超出<code>INT32_MAX</code>。对任意一个事务ID，都有约21亿个位于过去的事务和21亿个位于未来的事务。</p>
<p>xid不仅仅存在于活跃的事务上，xid会影响所有的元组：事务会给自己影响的元组打上自己的xid作为记号。每个元组都会用<code>(xmin, xmax)</code>来标识自己的可见性，<code>xmin</code> 记录了最后写入（<code>INSERT</code>, <code>UPDATE</code>）该元组的事务ID，而<code>xmax</code>记录了删除或锁定该元组的事务ID。每个事务只能看见由先前事务提交（<code>xmin &lt; xid</code>）且未被删除的元组（从而实现快照隔离）。</p>
<p>如果一个元组是由很久很久以前的事务产生的，那么在数据库的例行VACUUM FREEZE时，会找出当前活跃事务中最老的xid，将所有<code>xmin &lt; xid</code>的元组的<code>xmin</code>标记为<code>2</code>，也就是冻结事务ID。这意味着这条元组跳出了这个比较环，比所有普通事务ID都要小，所以能被所有的事务看到。通过清理，数据库中最老的xid会不断追赶当前的xid，从而避免事务回卷。</p>
<p>数据库或表的<strong>年龄（age）</strong>，定义为当前事务ID与数据库/表中存在最老的<code>xid</code>之差。最老的<code>xid</code>可能来自一个持续了几天的超长事务。也可能来自几天前老事务写入，但尚未被冻结的元组中。如果数据库的年龄超过了<code>INT32_MAX</code>，灾难性情况就发生了。过去的事务变成了未来的事务，过去事务写入的元组将变得不可见。</p>
<p>为了避免这种情况，需要避免<strong>超长事务</strong>与定期VACUUM FREEZE冻结老元组。如果单库在平均3万TPS的超高负载下，20亿个事务号一整天内就会用完。在这样的库上就无法执行一个超过一天的超长事务。而如果由于某种原因，自动清理工作无法继续进行，一天之内就可能遇到事务回卷。</p>
<p>9.4之后对FREEZE的机制进行了修改，FREEZE使用元组中单独的标记位来表示。</p>
<p>PostgreSQL应对事务回卷有自我保护机制。当临界事务号还剩<strong>一千万</strong>时，会进入紧急状态。</p>
<h2 id="查询">查询</h2>
<p>查询当前所有表的年龄，SQL 语句如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">regclass</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000">greatest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">age</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relfrozenxid</span><span style="color:#000;font-weight:bold">),</span><span style="color:#000">age</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relfrozenxid</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">age</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LEFT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltoastrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relkind</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;r&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;m&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>查询数据库的年龄，SQL语句如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">age</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datfrozenxid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_database</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span></code></pre></div><h4 id="清理">清理</h4>
<p>执行<code>VACUUM FREEZE</code>可以冻结老旧事务的ID</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vacuum_cost_limit</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vacuum_cost_delay</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">VACUUM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FREEZE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VERBOSE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>可以针对特定的表进行VACUUM FREEZE，抓主要矛盾。</p>
<h2 id="问题">问题</h2>
<p>通常来说，PostgreSQL的AutoVacuum机制会自动执行FREEZE操作，冻结老旧事务的ID，从而降低数据库的年龄。因此一旦出现事务ID回卷故障，通常祸不单行，意味着vacuum机制可能被其他的故障挡住了。</p>
<p>目前遇到过三种触发事务ID回卷故障的情况</p>
<h3 id="idle-in-transaction">IDLE IN TRANSACTION</h3>
<p>空闲事务会阻塞VACUUM FREEZE老旧元组。</p>
<p>解决方法很简单，干掉IDEL IN TRANSACTION的长事务然后执行VACUUM FREEZE即可。</p>
<h3 id="存疑事务">存疑事务</h3>
<p>clog损坏，或没有复制到从库，会导致相关表进入事务存疑状态，拒绝服务。</p>
<p>需要手工拷贝，或使用dd生成虚拟的clog来强行逃生。</p>
<h3 id="磁盘内存坏块">磁盘/内存坏块</h3>
<p>因为坏块导致的无法VACUUM比较尴尬。</p>
<p>需要通过二分法定位并跳过脏数据，或者干脆直接抢救从库。</p>
<h3 id="注意事项">注意事项</h3>
<p>紧急抢救的时候，不要整库来，按照年龄大小降序挨个清理表会更快。</p>
<p>注意当主库进入事务回卷保护状态时，从库也会面临同样的问题。</p>
<h2 id="解决方案">解决方案</h2>
<h3 id="autovacuum参数配置">AutoVacuum参数配置</h3>
<h3 id="年龄监控">年龄监控</h3>
<p>[未完待续]</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-961294574a35a9dedff38173eb28701f">故障档案：序列号消耗过快导致整型溢出</h1>
	<div class="lead">如果您在表上用了Interger的序列号，最好还是考虑一下可能溢出的情况。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-07-20" class="text-muted">2018年07月20日</time>
        
	</div>
	<hr>
<h2 id="0x01-概览">0x01 概览</h2>
<ul>
<li>
<p>故障表现：</p>
<ul>
<li>某张使用自增列的表序列号涨至整型上限，无法写入。</li>
<li>发现表中的自增列存在大量空洞，很多序列号没有对应记录就被消耗掉了。</li>
</ul>
</li>
<li>
<p>故障影响：非核心业务某表，10分钟左右无法写入。</p>
</li>
<li>
<p>故障原因：</p>
<ul>
<li>内因：使用了INTEGER而不是BIGINT作为主键类型。</li>
<li>外因：业务方不了解<code>SEQUENCE</code>的特性，执行大量违背约束的无效插入，浪费了大量序列号。</li>
</ul>
</li>
<li>
<p>修复方案：</p>
<ul>
<li>紧急操作：降级线上插入函数为直接返回，避免错误扩大。</li>
<li>应急方案：创建临时表，生成5000万个浪费空洞中的临时ID，修改插入函数，变为先检查再插入，并从该临时ID表中取ID。</li>
<li>解决方案：执行模式迁移，将所有相关表的主键与外键类型更新为Bigint。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="原因分析">原因分析</h2>
<h3 id="内因类型使用不当">内因：类型使用不当</h3>
<p>业务使用32位整型作为主键自增ID，而不是Bigint。</p>
<ul>
<li>除非有特殊的理由，主键，自增列都应当使用BIGINT类型。</li>
</ul>
<h3 id="外因不了解sequence的特性">外因：不了解Sequence的特性</h3>
<ul>
<li>非要使用如果会频繁出现无效插入，或频繁使用UPSERT，需要关注Sequence的消耗问题。</li>
<li>可以考虑使用自定义发号函数（类Snowflake）</li>
</ul>
<p>在PostgreSQL中，Sequence是一个比较特殊的类型。特别是，在事务中消耗的序列号不会回滚。因为序列号能被并发地获取，不存在逻辑上合理的回滚操作。</p>
<p>在生产中，我们就遇到了这样一种故障。有一张表直接使用了Serial作为主键：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">   	</span><span style="color:#000">SERIAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">  	</span><span style="color:#204a87;font-weight:bold">TEXT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UNIQUE</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">value</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>而插入的时候是这样的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>当然，实际上由于<code>name</code>列上的约束，如果插入了重复的<code>name</code>字段，事务就会报错中止并回滚。然而序列号已经被消耗掉了，即使事务回滚了，序列号也不会回滚。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># INSERT INTO sample(name, value) VALUES(&#39;Alice&#39;,1);</span>
</span></span><span style="display:flex;"><span>INSERT <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># SELECT currval(&#39;sample_id_seq&#39;::RegClass);</span>
</span></span><span style="display:flex;"><span> currval
</span></span><span style="display:flex;"><span>---------
</span></span><span style="display:flex;"><span>       <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> row<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># INSERT INTO sample(name, value) VALUES(&#39;Alice&#39;,1);</span>
</span></span><span style="display:flex;"><span>ERROR:  duplicate key value violates unique constraint <span style="color:#4e9a06">&#34;sample_name_key&#34;</span>
</span></span><span style="display:flex;"><span>DETAIL:  Key <span style="color:#ce5c00;font-weight:bold">(</span>name<span style="color:#ce5c00;font-weight:bold">)=(</span>Alice<span style="color:#ce5c00;font-weight:bold">)</span> already exists.
</span></span><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># SELECT currval(&#39;sample_id_seq&#39;::RegClass);</span>
</span></span><span style="display:flex;"><span> currval
</span></span><span style="display:flex;"><span>---------
</span></span><span style="display:flex;"><span>       <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> row<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># BEGIN;</span>
</span></span><span style="display:flex;"><span>BEGIN
</span></span><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># INSERT INTO sample(name, value) VALUES(&#39;Alice&#39;,1);</span>
</span></span><span style="display:flex;"><span>ERROR:  duplicate key value violates unique constraint <span style="color:#4e9a06">&#34;sample_name_key&#34;</span>
</span></span><span style="display:flex;"><span>DETAIL:  Key <span style="color:#ce5c00;font-weight:bold">(</span>name<span style="color:#ce5c00;font-weight:bold">)=(</span>Alice<span style="color:#ce5c00;font-weight:bold">)</span> already exists.
</span></span><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># ROLLBACK;</span>
</span></span><span style="display:flex;"><span>ROLLBACK
</span></span><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># SELECT currval(&#39;sample_id_seq&#39;::RegClass);</span>
</span></span><span style="display:flex;"><span> currval
</span></span><span style="display:flex;"><span>---------
</span></span><span style="display:flex;"><span>       <span style="color:#0000cf;font-weight:bold">3</span>
</span></span></code></pre></div><p>因此，当执行的插入有大量重复，即有大量的冲突时，可能会导致序列号消耗的非常快。出现大量空洞！</p>
<p>另一个需要注意的点在于，UPSERT操作也会消耗序列号！从表现上来看，这就意味着即使实际操作是UPDATE而不是INSERT，也会消耗一个序列号。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Alice&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CONFLICT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXCLUDED</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">currval</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;sample_id_seq&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">RegClass</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">currval</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Alice&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CONFLICT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXCLUDED</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">currval</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;sample_id_seq&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">RegClass</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">currval</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="解决方案">解决方案</h2>
<p>线上所有查询与插入都使用存储过程。非核心业务，允许接受短暂的写入失效。首先降级插入函数，避免错误影响AppServer。因为该表存在大量依赖，无法直接修改其类型，需要一个临时解决方案。</p>
<p>检查发现ID列中存在大量空洞，每10000个序列号中实际只有1%被使用。因此使用下列函数生成临时ID表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sample_temp_id</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 插入约5000w个临时ID，够用十几天了。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sample_temp_id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">SELECTT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">generate_series</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2000000000</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2100000000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXCEPT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 修改插入的存储过程，从临时表中Pop出ID。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DELETE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sample_temp_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sample_temp_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RETURNING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>修改插入存储过程，每次从临时ID表中取一个ID，显式插入表中。</p>
<hr>
<h2 id="经验与教训">经验与教训</h2>
<p>能用 BIGINT 的就别用 INT，另外 <code>UPSERT</code> 的时候需要特别注意。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-92a909645a0cf65d2bc3fc154f629d84">监控PG中的表大小</h1>
	<div class="lead">PostgreSQL中的表对应着许多物理文件，本文介绍如何统计一张表在PostgreSQL的实际大小</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-05-14" class="text-muted">2018年05月14日</time>
        
	</div>
	<h3 id="表的空间布局">表的空间布局</h3>
<p>宽泛意义上的<strong>表（Table）</strong>，包含了<strong>本体表</strong>与<strong>TOAST表</strong>两个部分：</p>
<ul>
<li>本体表，存储关系本身的数据，即狭义的关系，<code>relkind='r'</code>。</li>
<li>TOAST表，与本体表一一对应，存储过大的字段，<code>relinkd='t'</code>。</li>
</ul>
<p>而每个表，又由<strong>主体</strong>与<strong>索引</strong>两个**关系（Relation）**组成（对本体表而言，可以没有索引关系）</p>
<ul>
<li>主体关系：存储元组。</li>
<li>索引关系：存储索引元组。</li>
</ul>
<p>每个<strong>关系</strong>又可能会有<strong>四种分支</strong>：</p>
<ul>
<li>
<p>main: 关系的主文件，编号为0</p>
</li>
<li>
<p>fsm：保存关于main分支中空闲空间的信息，编号为1</p>
</li>
<li>
<p>vm：保存关于main分支中可见性的信息，编号为2</p>
</li>
<li>
<p>init：用于不被日志记录（unlogged）的的表和索引，很少见的特殊分支，编号为3</p>
</li>
</ul>
<p>每个分支存储为磁盘上的一到多个文件：超过1GB的文件会被划分为最大1GB的多个段。</p>
<p>综上所述，一个表并不是看上去那么简单，它由几个关系组成：</p>
<ul>
<li>本体表的主体关系（单个）</li>
<li>本体表的索引（多个）</li>
<li>TOAST表的主体关系（单个）</li>
<li>TOAST表的索引（单个）</li>
</ul>
<p>而每个关系实际上可能又包含了1~3个分支：<code>main</code>（必定存在），<code>fsm</code>，<code>vm</code>。</p>
<h3 id="获取表的附属关系">获取表的附属关系</h3>
<p>使用下列查询，列出所有的分支oid。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">nsp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltoastrelid</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toastid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">toastind</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toastindexid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">ind</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">pg_namespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nsp</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">join</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rel</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nsp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LATERAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">array_agg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indexes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LATERAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltoastrelid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toastind</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pg_catalog&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;information_schema&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relkind</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;r&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span> nspname |  relname   |  nspid  |  relid  | toastid | toastindexid |      indexes
</span></span><span style="display:flex;"><span>---------+------------+---------+---------+---------+--------------+--------------------
</span></span><span style="display:flex;"><span> public  | aoi        | 4310872 | 4320271 | 4320274 |      4320276 | {4325606,4325605}
</span></span><span style="display:flex;"><span> public  | poi        | 4310872 | 4332324 | 4332327 |      4332329 | {4368886}
</span></span></code></pre></div><h3 id="统计函数">统计函数</h3>
<p>PG提供了一系列函数用于确定各个部分占用的空间大小。</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>统计口径</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pg_total_relation_size(oid) </code></td>
<td>整个关系，包括表，索引，TOAST等。</td>
</tr>
<tr>
<td><code>pg_indexes_size(oid) </code></td>
<td>关系索引部分所占空间</td>
</tr>
<tr>
<td><code>pg_table_size(oid)</code></td>
<td>关系中除索引外部分所占空间</td>
</tr>
<tr>
<td><code>pg_relation_size(oid) </code></td>
<td>获取一个关系主文件部分的大小（main分支）</td>
</tr>
<tr>
<td><code>pg_relation_size(oid, 'main')</code></td>
<td>获取关系<code>main</code>分支大小</td>
</tr>
<tr>
<td><code>pg_relation_size(oid, 'fsm')</code></td>
<td>获取关系<code>fsm</code>分支大小</td>
</tr>
<tr>
<td><code>pg_relation_size(oid, 'vm')</code></td>
<td>获取关系<code>vm</code>分支大小</td>
</tr>
<tr>
<td><code>pg_relation_size(oid, 'init')</code></td>
<td>获取关系<code>init</code>分支大小</td>
</tr>
</tbody>
</table>
<p>虽然在物理上一张表由这么多文件组成，但从逻辑上我们通常只关心两个东西的大小：表与索引。因此这里要用到的主要就是两个函数：<code>pg_indexes_size</code>与<code>pg_table_size</code>，对普通表其和为<code>pg_total_relation_size</code>。</p>
<p>而通常表大小的部分可以这样计算：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_table_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">relid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> 	</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">relid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;main&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> 	</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">relid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;fsm&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> 	</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">relid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;vm&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> 	</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_total_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reltoastrelid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> 	
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_indexes_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">relid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> 	</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_total_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>注意，TOAST表也有自己的索引，但有且仅有一个，因此使用<code>pg_total_relation_size(reltoastrelid)</code>可计算TOAST表的整体大小。</p>
<h3 id="例统计某一张表及其相关关系udtf">例：统计某一张表及其相关关系UDTF</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">relnamespace</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">RegNamespace</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">Text</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">relkind</span><span style="color:#f8f8f8;text-decoration:underline">                                        </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relkind</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">reltuples</span><span style="color:#f8f8f8;text-decoration:underline">                                      </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">relpages</span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">pg_total_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ANY</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">array</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16418</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- main
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">UNION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16418</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- index
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">UNION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">reltoastrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16418</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- toast
</span></span></span></code></pre></div><p>可以将其包装为UDTF：<code>pg_table_size_detail</code>，便于使用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_table_size_detail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">relation</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RegClass</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">pid</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">relkind</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;char&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">tuples</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">pages</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">bigint</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">relation</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RegNamespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">Text</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relkind</span><span style="color:#f8f8f8;text-decoration:underline">                              </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relkind</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">bigint</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#f8f8f8;text-decoration:underline">                             </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">pg_total_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rel</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ANY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">array</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relation</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- main
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">UNION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relation</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- index
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">UNION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">reltoastrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relation</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- toast
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PlPgSQL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_table_size_detail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">16418</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>返回结果样例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>geo=# select * from  pg_table_size_detail(4325625);
</span></span><span style="display:flex;"><span>   id    |   pid   |        relname        | nspname  | relkind |  tuples  |  pages  |    size
</span></span><span style="display:flex;"><span>---------+---------+-----------------------+----------+---------+----------+---------+-------------
</span></span><span style="display:flex;"><span> 4325628 | 4325625 | pg_toast_4325625      | pg_toast | t       |   154336 |   23012 |   192077824
</span></span><span style="display:flex;"><span> 4419940 | 4325625 | idx_poi_adcode_btree  | gaode    | i       | 62685464 |  172058 |  1409499136
</span></span><span style="display:flex;"><span> 4419941 | 4325625 | idx_poi_cate_id_btree | gaode    | i       | 62685464 |  172318 |  1411629056
</span></span><span style="display:flex;"><span> 4419942 | 4325625 | idx_poi_lat_btree     | gaode    | i       | 62685464 |  172058 |  1409499136
</span></span><span style="display:flex;"><span> 4419943 | 4325625 | idx_poi_lon_btree     | gaode    | i       | 62685464 |  172058 |  1409499136
</span></span><span style="display:flex;"><span> 4419944 | 4325625 | idx_poi_name_btree    | gaode    | i       | 62685464 |  335624 |  2749431808
</span></span><span style="display:flex;"><span> 4325625 | 4325625 | gaode_poi             | gaode    | r       | 62685464 | 2441923 | 33714962432
</span></span><span style="display:flex;"><span> 4420005 | 4325625 | idx_poi_position_gist | gaode    | i       | 62685464 |  453374 |  3714039808
</span></span><span style="display:flex;"><span> 4420044 | 4325625 | poi_position_geohash6 | gaode    | i       | 62685464 |  172058 |  1409499136
</span></span></code></pre></div><h3 id="例关系大小详情汇总">例：关系大小详情汇总</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">nsp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltoastrelid</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toastid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">toastind</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toastindexid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">pg_total_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">pg_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;fsm&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;vm&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relsize</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">pg_indexes_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indexsize</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">pg_total_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reltoastrelid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toastsize</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">ind</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexids</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">ind</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexnames</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">ind</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexsizes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_namespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nsp</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">join</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rel</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nsp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">LATERAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltoastrelid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toastind</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LATERAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">array_agg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indexids</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#000">array_agg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">RegClass</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indexnames</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#000">array_agg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_total_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indexsizes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pg_catalog&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;information_schema&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relkind</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;r&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-7d0a12d18bf823797011a62acdd76153">PgAdmin安装配置</h1>
	<div class="lead">PgAdmin是一个管理PostgreSQL的GUI程序，用python写成，但实在是过于古早，需要一些额外配置。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-04-14" class="text-muted">2018年04月14日</time>
        
	</div>
	<h2 id="pgadmin4的安装与配置">PgAdmin4的安装与配置</h2>
<p>PgAdmin是一个为PostgreSQL定制设计的GUI。用起来很不错。可以以本地GUI程序或者Web服务的方式运行。因为Retina屏幕下面PgAdmin依赖的GUI组件显示效果有点问题，这里主要介绍如何以Web服务方式（Python Flask）配置运行PgAdmin4。</p>
<h3 id="下载">下载</h3>
<p>PgAdmin可以从官方FTP下载。</p>
<p><a href="https://ftp.postgresql.org/pub/pgadmin3/pgadmin4">postgresql网站FTP目录地址</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://ftp.postgresql.org/pub/pgadmin3/pgadmin4/v1.1/source/pgadmin4-1.1.tar.gz
</span></span><span style="display:flex;"><span>tar -xf pgadmin4-1.1.tar.gz <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87">cd</span> pgadmin4-1.1/
</span></span></code></pre></div><p>也可以从官方<a href="git://git.postgresql.org/git/pgadmin4.git">Git Repo</a>下载：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone git://git.postgresql.org/git/pgadmin4.git
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> pgadmin4
</span></span></code></pre></div><h3 id="安装依赖">安装依赖</h3>
<p>首先，需要安装Python，2或者3都可以。这里使用管理员权限安装Anaconda3发行版作为示例。</p>
<p>首先创建一个虚拟环境，当然直接上物理环境也是可以的……</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>conda create -n pgadmin <span style="color:#000">python</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span> anaconda
</span></span></code></pre></div><p>根据对应的Python版本，按照对应的依赖文件安装依赖。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo pip install -r requirements_py3.txt
</span></span></code></pre></div><h3 id="配置选项">配置选项</h3>
<p>首先执行初始化脚本，创立PgAdmin的管理员用户。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python web/setup.py
</span></span></code></pre></div><p>按照提示输入Email和密码即可。</p>
<p>编辑<code>web/config.py</code>，修改默认配置，主要是改监听地址和端口。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">DEFAULT_SERVER</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;localhost&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">DEFAULT_SERVER_PORT</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5050</span>
</span></span></code></pre></div><p>修改监听地址为<code>0.0.0.0</code>以便从任意IP访问。
按需修改端口。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-4655d4b17c08103df8117b42ac19b781">故障档案：快慢不匀雪崩</h1>
	<div class="lead">最近发生了一起匪夷所思的故障，某数据库切走了一半的数据量和负载，结果却因为负载变大被打挂了。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-04-08" class="text-muted">2018年04月08日</time>
        
	</div>
	<p>最近发生了一起匪夷所思的故障，某数据库切走了一半的数据量和负载。</p>
<p>其他什么都没变，本来还好；压力减小，却在高峰期陷入濒死状态，完全不符合直觉。</p>
<p>但正如福尔摩斯所说，<strong>当你排除掉一切不可能之后，剩下的即使再离奇，也是事实。</strong></p>
<h2 id="一摘要">一、摘要</h2>
<p>某日凌晨4点，进行了核心库进行分库迁移，拆走一半的表和一半的查询负载，原库节点规模不变。</p>
<p>当日晚高峰核心库所有热备库（15台）出现连接堆积，压力暴涨，针对性地清理慢查询不再起效。</p>
<p><strong>无差别持续杀查询</strong>，有立竿见影的救火效果（22:30后），且暂停后故障立刻重现（22:48），杀至高峰期结束。</p>
<p>匪夷所思的是，移走了表（数据量减半），移走了负载（TPS减半），其他什么都没变竟然会导致压力上升？</p>
<h2 id="二现象">二、现象</h2>
<p>CPU使用率的正常水位在25%，警戒水位在45%，极限水位在80%。故障期间所有从库飙升至极限水位。</p>
<p><img src="/img/blog/pg/download-failure-cpu.jpg"></p>
<p>PostgreSQL连接数发生暴涨，通常5~10个左右的数据库连接就足够撑起所有流量，连接池的最大连接数为100。</p>
<p><img alt="pg-conn" src="/img/blog/pg/download-failure-pg-conn.png"></p>
<p>pgbouncer连接池平均响应时间平时在500μs左右，故障期间飙升至百毫秒级别。</p>
<p><img alt="pgb-time" src="/img/blog/pg/download-failure-pgb-time.png"></p>
<p>故障期间，数据库TPS发生显著下滑。进行杀查询抢救后恢复，但处于剧烈抖动状态。</p>
<p><img src="/img/blog/pg/download-failure-tps.png"></p>
<p>故障期间，两个函数的执行时间发生显著恶化，从几百微秒劣化至几十毫秒。</p>
<p><img src="/img/blog/pg/download-failure-functime.png"></p>
<p>故障期间，复制延迟显著上升，开始出现GB级别的复制延迟，业务指标出现显著下滑。</p>
<p>开始杀查询后，大部分指标恢复，但一旦停止马上重新开始出现（22:48尝试性停止故障恢复）。</p>
<h2 id="三原因分析">三、原因分析</h2>
<p>【表因】：所有从库连接池被打满，连接被慢查询占据，快查询无法执行，发生连接堆积。</p>
<p>【主内因】：两个函数的并发数增大到30左右时，性能会发生急剧劣化，变为慢查询（500μs到100ms）。</p>
<p>【副内因】：后端与数据库没有合理的超时取消机制，断路器会放大故障。</p>
<p>【外因】：分库后，快查询比例下降，导致特定查询的相对比例上升，并发数增大至临界点。恶化为慢查询。</p>
<h3 id="表因连接打满">表因：连接打满</h3>
<p>故障的表因是数据库连接池被打满，产生大量堆积连接。进而新连接无法建立，拒绝服务。</p>
<h4 id="原理">原理</h4>
<p>数据库配置的最大连接数<code>max_connections = 100</code>，一个连接实质上就是一个数据库进程。机器能够负载的实际数据库进程数目与查询类型高度相关：如果全是在1ms内的快查询，几百上千个链接都是可以的（生产环境中的正常情况）。而如果全都是CPU和IO密集的慢查询，则最大支持的连接数可能只有（<code>48 * 80% ≈ 38</code>）个左右。</p>
<p>在生产环境中使用了连接池，正常情况下5~10个实际数据库连接就可以支撑起所有快查询。然而一旦有大量慢查询持续进入，长期占用了活跃连接，那么快查询就会排队等待发生堆积，连接池进而启动更多实际数据库的连接，而这些连接上的快查询很快就会执行完毕，最终仍然会被不断进入的慢查询占据。最终导致约100个实际数据库连接都在执行CPU/IO密集的慢查询（<code>max_pool_size=100</code>），CPU暴涨，进一步恶化情况。</p>
<h4 id="证据">证据</h4>
<h5 id="连接池活跃连接数">连接池活跃连接数</h5>
<p><img alt="pgb-active-conn-5888653" src="/img/blog/pg/download-failure-pgb-active-conn.png"></p>
<h5 id="连接池排队连接数"><strong>连接池排队连接数</strong></h5>
<p><img alt="pgb-wait-conn" src="/img/blog/pg/download-failure-pgb-wait-conn.png"></p>
<p><strong>数据库后端连接数</strong></p>
<p><img alt="pg-conn" src="/img/blog/pg/download-failure-pg-conn.png"></p>
<h4 id="修复">修复</h4>
<p>持续地无差别杀掉所有数据库活跃连接，能起到很好的治标效果，且对业务指标影响很小。</p>
<p>但杀掉连接（<code>pg_terminate_backend</code>）会导致连接池重连，更好的做法是取消查询（<code>pg_cancel_backend</code>）</p>
<p>因为快查询走的快，卡在后端实际连接上执行的查询极大概率都是慢查询，这时候无差别取消所有查询命中的绝大多数都是慢查询。杀查询能将连接释放给快查询使用，让应用苟活下去，但必须持续不断的杀才有效果，因为用不了零点几秒，慢查询就会重新占据活跃连接。</p>
<p>使用psql执行以下SQL，每隔0.5秒取消所有活跃查询。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_cancel_backend</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stat_activity</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">application_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;psql&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">\</span><span style="color:#000">watch</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>解决方案：调整了连接池的后端最大连接数，进行快慢分离，强制所有批量任务与慢查询走离线从库。</p>
<h3 id="主内因并行恶化">主内因：并行恶化</h3>
<p>故障的<strong>主内因</strong>是两个函数的执行时间在<strong>并行数增大</strong>时发生恶化。</p>
<h4 id="原理-1">原理</h4>
<p>故障的直接导火索是这两个函数劣化为慢查询。经过单独的压力测试，这两个函数随着并行执行数增高，发生急剧的性能劣化，阈值点为约30个并发进程。（因为所有进程只执行同一个查询，所以可认为并行数等于并发数）</p>
<h4 id="证据-1">证据</h4>
<p><strong>图：故障期间函数平均执行时间出现明显飙升</strong></p>
<p><img src="/img/blog/pg/download-failure-functime.png"></p>
<p><strong>图：在不同并行数下压测该函数能达到的最大QPS</strong></p>
<p><img alt="degenerate-5889931" src="/img/blog/pg/download-failure-degenerate.png"></p>
<h4 id="修复-1">修复</h4>
<ul>
<li>优化函数执行逻辑，将该函数的执行时间优化至原来的一半（最大QPS翻倍）。</li>
<li>新增五台从库，进一步降低单机负载。</li>
</ul>
<h3 id="副内因没有超时">副内因：没有超时</h3>
<p>故障的副内因在于没有合理的超时取消机制，<strong>查询不会因为超时被取消，是发生堆积的必要条件。</strong></p>
<h4 id="原理-2">原理</h4>
<p>发生查询超时时，应用层的合理行为是</p>
<ul>
<li>直接返回，报错。</li>
<li>进行若干次重试（在高峰期可以考虑直接返回错误）</li>
</ul>
<p>查询等待超出合理范围的时间却不取消，就会导致连接堆积。抛弃返回结果并无法取消已经发出的查询，客户端需要主动Cancel Request。Go1.7后的标准实践是通过<code>context</code>包与<code>database/sql</code>提供的<code>QueryContext/ExecContext</code>进行超时控制。</p>
<p>数据库端和连接池端可以配置<strong>语句超时(statement_timeout)</strong>，但实践表明这样的操作很容易误杀查询。</p>
<p>手动杀灭能够立竿见影地治标，但它本质上是一种<strong>人工超时取消机制</strong>。稳健的系统应当有自动化的超时取消机制，这需要在数据库、连接池、应用多个层次协同解决。</p>
<p>检视后端使用的驱动代码，发现<code>pg.v3</code> <code>pg.v5</code>并没有真正意义上的查询超时机制，超时参数不过是为<code>net.Conn</code>加上的TCP超时（通常在分钟级别）。</p>
<h4 id="修复-2">修复</h4>
<ul>
<li>建议使用<code>github.com/jackc/pgx</code>与 <code>github.com/go-pg/pg</code> 第六版驱动替代现有驱动</li>
<li>使用circuit-breaker会导致故障效应被放大，建议后端使用主动超时替代断路器。</li>
<li>建议在应用层面对连接的使用进行更精细的控制。</li>
</ul>
<h3 id="外因分库迁移">外因：分库迁移</h3>
<p>分库导致了原库中的快慢查询比例发生变化，诱发了两个函数的劣化。</p>
<p>问题函数在迁移前后的全局调用次数占比由<code>1/6</code> 变为<code>1/2</code>，导致问题函数的并行数增大。</p>
<h4 id="原理-3">原理</h4>
<ul>
<li>迁走的函数全都是快查询，原本问题函数：普通函数的比例为1：5</li>
<li>迁移负载后，快查询迁走了大半。问题函数：普通函数超过1：1</li>
<li>问题函数的比例大幅升高，导致高峰期其并发数超出阈值点，出现劣化。</li>
</ul>
<h4 id="证据-2">证据</h4>
<p>通过分析分库迁移前后的数据库全量日志，回放查询流量进行压测，重现了现象，确认了问题原因。</p>
<table>
<thead>
<tr>
<th style="text-align:center">指标</th>
<th style="text-align:center">迁移前</th>
<th style="text-align:center">迁移后</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">问题函数占比</td>
<td style="text-align:center">1/6</td>
<td style="text-align:center">5/9</td>
</tr>
<tr>
<td style="text-align:center">最大QPS</td>
<td style="text-align:center">40k</td>
<td style="text-align:center">8k</td>
</tr>
</tbody>
</table>
<p>QPS/TPS是一个极具误导性的指标，只有在负载类型不变的清空下，比较QPS才有意义。当系统负载类型发生变化时，QPS的水位点也需要重新进行评估测试。</p>
<p>在本例中，在负载变化后，系统的最大QPS水位点已经发生了戏剧性的变化，因为问题函数并发劣化，最大QPS变为原来的五分之一。</p>
<h4 id="修复-3">修复</h4>
<p>对问题函数进行了改写优化，提高了一倍的性能。</p>
<p>通过测试，确定了迁移后的系统水位值，并进行了相应的优化与容量调整。</p>
<h2 id="四经验与教训">四、经验与教训</h2>
<p>在故障排查中，走了一些弯路。比如一开始认为是某个离线批量任务拖慢了查询（根据日志中观察到的前后相关性），也排查了API调用量突增，外部恶意访问，其他变更因素，未知线上操作等。虽然分库迁移被列入怀疑对象，但因为直觉上认为负载小了，系统的Capacity怎么可能会下降？就没有列为优先排查对象。现实马上就给我们上了一课：</p>
<p><strong>当你排除掉一切不可能之后，剩下的即使再离奇，也是事实。</strong></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-65f1c440b6445ad21a178cdac3f9e31b">Bash与psql小技巧</h1>
	<div class="lead">一些PostgreSQL与Bash交互的技巧。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-04-07" class="text-muted">2018年04月07日</time>
        
	</div>
	<p>一些PostgreSQL与Bash交互的技巧。</p>
<h2 id="使用严格模式编写bash脚本">使用严格模式编写Bash脚本</h2>
<p>使用<a href="http://redsymbol.net/articles/unofficial-bash-strict-mode/">Bash严格模式</a>，可以避免很多无谓的错误。在Bash脚本开始的地方放上这一行很有用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">set</span> -euo pipefail
</span></span></code></pre></div><ul>
<li><code>-e</code>：当程序返回非0状态码时报错退出</li>
<li><code>-u</code>：使用未初始化的变量时报错，而不是当成NULL</li>
<li><code>-o pipefail</code>：使用Pipe中出错命令的状态码（而不是最后一个）作为整个Pipe的状态码<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>。</li>
</ul>
<h2 id="执行sql脚本的bash包装脚本">执行SQL脚本的Bash包装脚本</h2>
<p>通过psql运行SQL脚本时，我们期望有这么两个功能：</p>
<ol>
<li>能向脚本中传入变量</li>
<li>脚本出错后立刻中止（而不是默认行为的继续执行）</li>
</ol>
<p>这里给出了一个实际例子，包含了上述两个特性。使用Bash脚本进行包装，传入两个参数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -euo pipefail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#000">$#</span> !<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;please enter a db host and a table suffix&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">DBHOST</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$1</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">TSUFF</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>psql <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -X <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -U user <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -h <span style="color:#000">$DBHOST</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -f /path/to/sql/file.sql <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --echo-all <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --set <span style="color:#000">AUTOCOMMIT</span><span style="color:#ce5c00;font-weight:bold">=</span>off <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --set <span style="color:#000">ON_ERROR_STOP</span><span style="color:#ce5c00;font-weight:bold">=</span>on <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --set <span style="color:#000">TSUFF</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$TSUFF</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --set <span style="color:#000">QTSTUFF</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">\&#39;</span><span style="color:#000">$TSUFF</span><span style="color:#4e9a06">\&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    mydatabase
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">psql_exit_status</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$?</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#000">$psql_exit_status</span> !<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;psql failed while trying to run this sql script&#34;</span> 1&gt;<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">exit</span> <span style="color:#000">$psql_exit_status</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;sql script successful&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><p>一些要点：</p>
<ul>
<li>参数<code>TSTUFF</code>会传入SQL脚本中，同时作为一个裸值和一个单引号包围的值，因此，裸值可以当成表名，模式名，引用值可以当成字符串值。</li>
<li>使用<code>-X</code>选项确保当前用户的<code>.psqlrc</code>文件不会被自动加载</li>
<li>将所有消息打印到控制台，这样可以知道脚本的执行情况。(失效的时候很管用)</li>
<li>使用<code>ON_ERROR_STOP</code>选项，当出问题时立即终止。</li>
<li>关闭<code>AUTOCOMMIT</code>，所以SQL脚本文件不会每一行都提交一次。取而代之的是SQL脚本中出现<code>COMMIT</code>时才提交。如果希望整个脚本作为一个事务提交，在sql脚本最后一行加上<code>COMMIT</code>（其它地方不要加），否则整个脚本就会成功运行却什么也没提交（自动回滚）。也可以使用<code>--single-transaction</code>标记来实现。</li>
</ul>
<p><code>/path/to/sql/file.sql</code>的内容如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">this_index_</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">TSUFF</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">commit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_table_</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">TSUFF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">greeting</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">commit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_table_</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">TSUFF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">greeting</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Hello from table &#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">QTSUFF</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">commit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="使用pg环境变量让脚本更简练">使用PG环境变量让脚本更简练</h2>
<p>使用PG环境变量非常方便，例如用<code>PGUSER</code>替代<code>-U &lt;user&gt;</code>，用<code>PGHOST</code>替代<code>-h &lt;host&gt;</code>，用户可以通过修改环境变量来切换数据源。还可以通过Bash为这些环境变量提供默认值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> -euo pipefail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Set these environmental variables to override them,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># but they have safe defaults.</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">PGHOST</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">PGHOST</span><span style="color:#000;font-weight:bold">-localhost</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">PGPORT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">PGPORT</span><span style="color:#000;font-weight:bold">-5432</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">PGDATABASE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">PGDATABASE</span><span style="color:#000;font-weight:bold">-my_database</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">PGUSER</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">PGUSER</span><span style="color:#000;font-weight:bold">-my_user</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">PGPASSWORD</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">PGPASSWORD</span><span style="color:#000;font-weight:bold">-my_password</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">RUN_PSQL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;psql -X --set AUTOCOMMIT=off --set ON_ERROR_STOP=on &#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">${</span><span style="color:#000">RUN_PSQL</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">&lt;&lt;SQL
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">select blah_column 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  from blahs 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"> where blah_column = &#39;foo&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">rollback;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">SQL</span>
</span></span></code></pre></div><h2 id="在单个事务中执行一系列sql命令">在单个事务中执行一系列SQL命令</h2>
<p>你有一个写满SQL的脚本，希望将整个脚本作为单个事务执行。一种经常出现的情况是在最后忘记加一行<code>COMMIT</code>。一种解决办法是使用<code>—single-transaction</code>标记：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -X <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -U myuser <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -h myhost <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -f /path/to/sql/file.sql <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --echo-all <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --single-transaction <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --set <span style="color:#000">AUTOCOMMIT</span><span style="color:#ce5c00;font-weight:bold">=</span>off <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --set <span style="color:#000">ON_ERROR_STOP</span><span style="color:#ce5c00;font-weight:bold">=</span>on <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    mydatabase
</span></span></code></pre></div><p><code>file.sql</code>的内容变为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>insert into foo <span style="color:#ce5c00;font-weight:bold">(</span>bar<span style="color:#ce5c00;font-weight:bold">)</span> values <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;baz&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>insert into yikes <span style="color:#ce5c00;font-weight:bold">(</span>mycol<span style="color:#ce5c00;font-weight:bold">)</span> values <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;hello&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>两条插入都会被包裹在同一对<code>BEGIN/COMMIT</code>中。</p>
<h2 id="让多行sql语句更美观">让多行SQL语句更美观</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -euo pipefail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">RUN_ON_MYDB</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;psql -X -U myuser -h myhost --set ON_ERROR_STOP=on --set AUTOCOMMIT=off mydb&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">$RUN_ON_MYDB</span> <span style="color:#4e9a06">&lt;&lt;SQL
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">drop schema if exists new_my_schema;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">create table my_new_schema.my_new_table (like my_schema.my_table);
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">create table my_new_schema.my_new_table2 (like my_schema.my_table2);
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">commit;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">SQL</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用&#39;包围的界定符意味着HereDocument中的内容不会被Bash转义。</span>
</span></span><span style="display:flex;"><span><span style="color:#000">$RUN_ON_MYDB</span> <span style="color:#4e9a06">&lt;&lt;&#39;SQL&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">create index my_new_table_id_idx on my_new_schema.my_new_table(id);
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">create index my_new_table2_id_idx on my_new_schema.my_new_table2(id);
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">commit;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">SQL</span>
</span></span></code></pre></div><p>也可以使用Bash技巧，将多行语句赋值给变量，并稍后使用。</p>
<p>注意，Bash会自动清除多行输入中的换行符。实际上整个Here Document中的内容在传输时会重整为一行，你需要添加合适的分隔符，例如分号，来避免格式被搞乱。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">CREATE_MY_TABLE_SQL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>cat <span style="color:#4e9a06">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    create table foo (
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        id bigint not null,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        name text not null
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    );
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">$RUN_ON_MYDB</span> <span style="color:#4e9a06">&lt;&lt;SQL
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">$CREATE_MY_TABLE_SQL</span>
</span></span><span style="display:flex;"><span>commit<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>SQL
</span></span></code></pre></div><h2 id="如何将单个select标量结果赋值给bash变量">如何将单个SELECT标量结果赋值给Bash变量</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">CURRENT_ID</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#000">$PSQL</span> -X -U <span style="color:#000">$PROD_USER</span> -h myhost -P t -P <span style="color:#000">format</span><span style="color:#ce5c00;font-weight:bold">=</span>unaligned <span style="color:#000">$PROD_DB</span> -c <span style="color:#4e9a06">&#34;select max(id) from users&#34;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">let</span> <span style="color:#000">NEXT_ID</span><span style="color:#ce5c00;font-weight:bold">=</span>CURRENT_ID+1
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;next user.id is </span><span style="color:#000">$NEXT_ID</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;about to reset user id sequence on other database&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">$PSQL</span> -X -U <span style="color:#000">$DEV_USER</span> <span style="color:#000">$DEV_DB</span> -c <span style="color:#4e9a06">&#34;alter sequence user_ids restart with </span><span style="color:#000">$NEXT_ID</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div><h2 id="如何将单行结果赋给bash变量">如何将单行结果赋给Bash变量</h2>
<p>并且每个变量都以列名命名。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">read</span> username first_name last_name <span style="color:#ce5c00;font-weight:bold">&lt;&lt;&lt;</span> <span style="color:#204a87;font-weight:bold">$(</span>psql <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -X <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -U myuser <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -h myhost <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -d mydb <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --single-transaction <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --set <span style="color:#000">ON_ERROR_STOP</span><span style="color:#ce5c00;font-weight:bold">=</span>on <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --no-align <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -t <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --field-separator <span style="color:#4e9a06">&#39; &#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --quiet <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -c <span style="color:#4e9a06">&#34;select username, first_name, last_name from users where id = 5489&#34;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;username: </span><span style="color:#000">$username</span><span style="color:#4e9a06">, first_name: </span><span style="color:#000">$first_name</span><span style="color:#4e9a06">, last_name: </span><span style="color:#000">$last_name</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div><p>也可以使用数组的方式</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -euo pipefail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">declare</span> -a <span style="color:#000">ROW</span><span style="color:#ce5c00;font-weight:bold">=(</span><span style="color:#204a87;font-weight:bold">$(</span>psql <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -X <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -h myhost <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -U myuser <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -c <span style="color:#4e9a06">&#34;select username, first_name, last_name from users where id = 5489&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --single-transaction <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --set <span style="color:#000">AUTOCOMMIT</span><span style="color:#ce5c00;font-weight:bold">=</span>off <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --set <span style="color:#000">ON_ERROR_STOP</span><span style="color:#ce5c00;font-weight:bold">=</span>on <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --no-align <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -t <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --field-separator <span style="color:#4e9a06">&#39; &#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --quiet <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    mydb<span style="color:#204a87;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">ROW</span><span style="color:#000;font-weight:bold">[0]</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">first_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">ROW</span><span style="color:#000;font-weight:bold">[1]</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">last_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">ROW</span><span style="color:#000;font-weight:bold">[2]</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;username: </span><span style="color:#000">$username</span><span style="color:#4e9a06">, first_name: </span><span style="color:#000">$first_name</span><span style="color:#4e9a06">, last_name: </span><span style="color:#000">$last_name</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div><h2 id="如何在bash脚本中迭代查询结果集">如何在Bash脚本中迭代查询结果集</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -euo pipefail
</span></span><span style="display:flex;"><span><span style="color:#000">PSQL</span><span style="color:#ce5c00;font-weight:bold">=</span>/usr/bin/psql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">DB_USER</span><span style="color:#ce5c00;font-weight:bold">=</span>myuser
</span></span><span style="display:flex;"><span><span style="color:#000">DB_HOST</span><span style="color:#ce5c00;font-weight:bold">=</span>myhost
</span></span><span style="display:flex;"><span><span style="color:#000">DB_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>mydb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">$PSQL</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -X <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -h <span style="color:#000">$DB_HOST</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -U <span style="color:#000">$DB_USER</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -c <span style="color:#4e9a06">&#34;select username, password, first_name, last_name from users&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --single-transaction <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --set <span style="color:#000">AUTOCOMMIT</span><span style="color:#ce5c00;font-weight:bold">=</span>off <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --set <span style="color:#000">ON_ERROR_STOP</span><span style="color:#ce5c00;font-weight:bold">=</span>on <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --no-align <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -t <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --field-separator <span style="color:#4e9a06">&#39; &#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --quiet <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -d <span style="color:#000">$DB_NAME</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span><span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#204a87">read</span> username password first_name last_name <span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;USER: </span><span style="color:#000">$username</span><span style="color:#4e9a06"> </span><span style="color:#000">$password</span><span style="color:#4e9a06"> </span><span style="color:#000">$first_name</span><span style="color:#4e9a06"> </span><span style="color:#000">$last_name</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><p>也可以读进数组里：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -euo pipefail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">PSQL</span><span style="color:#ce5c00;font-weight:bold">=</span>/usr/bin/psql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">DB_USER</span><span style="color:#ce5c00;font-weight:bold">=</span>myuser
</span></span><span style="display:flex;"><span><span style="color:#000">DB_HOST</span><span style="color:#ce5c00;font-weight:bold">=</span>myhost
</span></span><span style="display:flex;"><span><span style="color:#000">DB_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>mydb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">$PSQL</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -X <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -h <span style="color:#000">$DB_HOST</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -U <span style="color:#000">$DB_USER</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -c <span style="color:#4e9a06">&#34;select username, password, first_name, last_name from users&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --single-transaction <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --set <span style="color:#000">AUTOCOMMIT</span><span style="color:#ce5c00;font-weight:bold">=</span>off <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --set <span style="color:#000">ON_ERROR_STOP</span><span style="color:#ce5c00;font-weight:bold">=</span>on <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --no-align <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -t <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --field-separator <span style="color:#4e9a06">&#39; &#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --quiet <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    <span style="color:#000">$DB_NAME</span> <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#204a87">read</span> -a Record <span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">Record</span><span style="color:#000;font-weight:bold">[0]</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">Record</span><span style="color:#000;font-weight:bold">[1]</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">first_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">Record</span><span style="color:#000;font-weight:bold">[2]</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">last_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">Record</span><span style="color:#000;font-weight:bold">[3]</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;USER: </span><span style="color:#000">$username</span><span style="color:#4e9a06"> </span><span style="color:#000">$password</span><span style="color:#4e9a06"> </span><span style="color:#000">$first_name</span><span style="color:#4e9a06"> </span><span style="color:#000">$last_name</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><h2 id="如何使用状态表来控制多个pg任务">如何使用状态表来控制多个PG任务</h2>
<p>假设你有一份如此之大的工作，以至于你一次只想做一件事。 您决定一次可以完成一项任务，而这对数据库来说更容易，而不是执行一个长时间运行的查询。 您创建一个名为my_schema.items_to_process的表，其中包含要处理的每个项目的item_id，并且您将一列添加到名为done的items_to_process表中，该表默认为false。 然后，您可以使用脚本从items_to_process中获取每个未完成项目，对其进行处理，然后在items_to_process中将该项目更新为done = true。 一个bash脚本可以这样做：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -euo pipefail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">PSQL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/u99/pgsql-9.1/bin/psql&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">DNL_TABLE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;items_to_process&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#DNL_TABLE=&#34;test&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FETCH_QUERY</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;select item_id from my_schema.</span><span style="color:#4e9a06">${</span><span style="color:#000">DNL_TABLE</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> where done is false limit 1&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>process_item<span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">local</span> <span style="color:#000">item_id</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">local</span> <span style="color:#000">dt</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>date<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;[</span><span style="color:#4e9a06">${</span><span style="color:#000">dt</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">] processing item_id </span><span style="color:#000">$item_id</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">$PSQL</span> -X -U myuser -h myhost -c <span style="color:#4e9a06">&#34;insert into my_schema.thingies select thingie_id, salutation, name, ddr from thingies where item_id = </span><span style="color:#000">$item_id</span><span style="color:#4e9a06"> and salutation like &#39;Mr.%&#39;&#34;</span> mydb
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">item_id</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#000">$PSQL</span> -X -U myuser -h myhost -P t -P <span style="color:#000">format</span><span style="color:#ce5c00;font-weight:bold">=</span>unaligned -c <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">FETCH_QUERY</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> mydb<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dt</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>date<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">while</span> <span style="color:#ce5c00;font-weight:bold">[</span> -n <span style="color:#4e9a06">&#34;</span><span style="color:#000">$item_id</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>    process_item <span style="color:#000">$item_id</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;[</span><span style="color:#4e9a06">${</span><span style="color:#000">dt</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">] marking item_id </span><span style="color:#000">$item_id</span><span style="color:#4e9a06"> as done...&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">$PSQL</span> -X -U myuser -h myhost -c <span style="color:#4e9a06">&#34;update my_schema.</span><span style="color:#4e9a06">${</span><span style="color:#000">DNL_TABLE</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> set done = true where item_id = </span><span style="color:#000">$item_id</span><span style="color:#4e9a06">&#34;</span> mydb
</span></span><span style="display:flex;"><span>    <span style="color:#000">item_id</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#000">$PSQL</span> -X -U myuser -h myhost -P t -P <span style="color:#000">format</span><span style="color:#ce5c00;font-weight:bold">=</span>unaligned -c <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">FETCH_QUERY</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> mydb<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dt</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>date<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><h2 id="跨数据库拷贝表">跨数据库拷贝表</h2>
<p>有很多方式可以实现这一点，利用<code>psql</code>的<code>\copy</code>命令可能是最简单的方式。假设你有两个数据库<code>olddb</code>与<code>newdb</code>，有一张<code>users</code>表需要从老库同步到新库。如何用一条命令实现：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -X <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -U user <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -h oldhost <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -d olddb <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -c <span style="color:#4e9a06">&#34;\\copy users to stdout&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span><span style="color:#000;font-weight:bold">|</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>psql <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -X <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -U user <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -h newhost <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -d newdb <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -c <span style="color:#4e9a06">&#34;\\copy users from stdin&#34;</span>
</span></span></code></pre></div><p>一个更困难的例子：假如你的表在老数据库中有三列：<code>first_name</code>, <code>middle_name</code>, <code>last_name</code>。</p>
<p>但在新数据库中只有两列，<code>first_name</code>，<code>last_name</code>，则可以使用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -X <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -U user <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -h oldhost <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -d olddb <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -c <span style="color:#4e9a06">&#34;\\copy (select first_name, last_name from users) to stdout&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span><span style="color:#000;font-weight:bold">|</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>psql <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -X <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -U user <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -h newhost <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -d newdb <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -c <span style="color:#4e9a06">&#34;\\copy users from stdin&#34;</span>
</span></span></code></pre></div><h2 id="获取表定义的方式">获取表定义的方式</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg_dump <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -U db_user <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -h db_host <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -p <span style="color:#0000cf;font-weight:bold">55432</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --table my_table <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --schema-only my_db
</span></span></code></pre></div><h2 id="将bytea列中的二进制数据导出到文件">将bytea列中的二进制数据导出到文件</h2>
<p>注意<code>bytea</code>列，在PostgreSQL 9.0 以上是使用十六进制表示的，带有一个恼人的前缀<code>\x</code>，可以用<code>substring</code>去除。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -euo pipefail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>psql <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -P t <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -P <span style="color:#000">format</span><span style="color:#ce5c00;font-weight:bold">=</span>unaligned <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -X <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -U myuser <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -h myhost <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -c <span style="color:#4e9a06">&#34;select substring(my_bytea_col::text from 3) from my_table where id = 12&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    mydb <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span><span style="color:#000;font-weight:bold">|</span> xxd -r -p &gt; dump.txt
</span></span></code></pre></div><h2 id="将文件内容作为一个列的值插入">将文件内容作为一个列的值插入</h2>
<p>有两种思路完成这件事，第一种是在外部拼SQL，第二种是在脚本中作为变量。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">filename</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">value</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">JSON</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql <span style="color:#4e9a06">&lt;&lt;SQL
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">\set content `cat ${filename}`
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">INSERT INTO sample VALUES(\&#39;${filename}\&#39;,:&#39;content&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">SQL</span>
</span></span></code></pre></div><h2 id="显示特定数据库中特定表的统计信息">显示特定数据库中特定表的统计信息</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -euo pipefail
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> -z <span style="color:#4e9a06">&#34;</span><span style="color:#000">$1</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Usage: </span><span style="color:#000">$0</span><span style="color:#4e9a06"> table [db]&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SCMTBL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#000">$1</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">SCHEMANAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">SCMTBL</span><span style="color:#000;font-weight:bold">%%.*</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>  <span style="color:#8f5902;font-style:italic"># everything before the dot (or SCMTBL if there is no dot)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">TABLENAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">SCMTBL</span><span style="color:#000;font-weight:bold">#*.</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>  <span style="color:#8f5902;font-style:italic"># everything after the dot (or SCMTBL if there is no dot)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">SCHEMANAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">TABLENAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">SCHEMANAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;public&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> -n <span style="color:#4e9a06">&#34;</span><span style="color:#000">$2</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">DB</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#000">$2</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">DB</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;my_default_db&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">PSQL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;psql -U my_default_user -h my_default_host -d </span><span style="color:#000">$DB</span><span style="color:#4e9a06"> -x -c &#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">$PSQL</span> <span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">select &#39;-----------&#39; as \&#34;-------------\&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">       schemaname,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">       tablename,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">       attname,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">       null_frac,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">       avg_width,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">       n_distinct,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">       correlation,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">       most_common_vals,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">       most_common_freqs,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">       histogram_bounds
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  from pg_stats
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"> where schemaname=&#39;</span><span style="color:#000">$SCHEMANAME</span><span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">   and tablename=&#39;</span><span style="color:#000">$TABLENAME</span><span style="color:#4e9a06">&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> <span style="color:#000;font-weight:bold">|</span> grep -v <span style="color:#4e9a06">&#34;\-\[ RECORD &#34;</span>
</span></span></code></pre></div><p>使用方式</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./table-stats.sh myschema.mytable
</span></span></code></pre></div><p>对于public模式中的表</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./table-stats.sh mytable
</span></span></code></pre></div><p>连接其他数据库</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./table-stats.sh mytable myotherdb
</span></span></code></pre></div><h2 id="将psql的默认输出转换为markdown表格">将psql的默认输出转换为Markdown表格</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">pg2md</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39; sed &#39;</span><span style="color:#4e9a06">\&#39;</span><span style="color:#4e9a06">&#39;s/+/|/g&#39;</span><span style="color:#4e9a06">\&#39;</span><span style="color:#4e9a06">&#39; | sed &#39;</span><span style="color:#4e9a06">\&#39;</span><span style="color:#4e9a06">&#39;s/^/|/&#39;</span><span style="color:#4e9a06">\&#39;</span><span style="color:#4e9a06">&#39; | sed &#39;</span><span style="color:#4e9a06">\&#39;</span><span style="color:#4e9a06">&#39;s/$/|/&#39;</span><span style="color:#4e9a06">\&#39;</span><span style="color:#4e9a06">&#39; |  grep -v rows | grep -v &#39;</span><span style="color:#4e9a06">\&#39;</span><span style="color:#4e9a06">&#39;||&#39;</span><span style="color:#4e9a06">\&#39;</span><span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Usage</span>
</span></span><span style="display:flex;"><span>psql -c <span style="color:#4e9a06">&#39;SELECT * FROM pg_database&#39;</span> <span style="color:#000;font-weight:bold">|</span> pg2md
</span></span></code></pre></div><p>输出的结果贴到Markdown编辑器即可。</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>管道程序的退出状态放置在环境变量数组<code>PIPESTATUS</code>中&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-5404a58698fda52f4400a19c3ac76a67">PostgreSQL例行维护</h1>
	<div class="lead">汽车需要上油，数据库也需要维护保养。对Pg而言，有三项比较重要的维护工作：备份、重整、清理</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-02-10" class="text-muted">2018年02月10日</time>
        
	</div>
	<p>汽车需要上油，数据库也需要维护保养。</p>
<h2 id="pg中的维护工作">PG中的维护工作</h2>
<p>对Pg而言，有三项比较重要的维护工作：备份、重整、清理</p>
<ul>
<li><strong>备份（backup）</strong>：最重要的例行工作，生命线。
<ul>
<li>制作基础备份</li>
<li>归档增量WAL</li>
</ul>
</li>
<li><strong>重整（repack）</strong>
<ul>
<li>重整表与索引能消除其中的膨胀，节约空间，确保查询性能不会劣化。</li>
</ul>
</li>
<li><strong>清理（vacuum）</strong>
<ul>
<li>维护表与库的年龄，避免事务ID回卷故障。</li>
<li>更新统计数据，生成更好的执行计划。</li>
<li>回收死元组。节约空间，提高性能。</li>
</ul>
</li>
</ul>
<h2 id="备份">备份</h2>
<p>备份可以使用<code>pg_backrest</code> 作为一条龙解决方案，但这里考虑使用脚本进行备份。</p>
<p>参考：<a href="https://github.com/Vonng/pigsty/blob/master/roles/postgres/files/pg/pg-backup"><code>pg-backup</code></a></p>
<h2 id="重整">重整</h2>
<p>重整使用<code>pg_repack</code>，PostgreSQL自带源里包含了pg_repack</p>
<p>参考：<a href="https://github.com/Vonng/pigsty/blob/master/roles/postgres/files/pg/pg-repack"><code>pg-repack</code></a></p>
<h2 id="清理">清理</h2>
<p>虽然有AutoVacuum，但手动执行Vacuum仍然有帮助。检查数据库的年龄，当出现老化时及时上报。</p>
<p>参考：<a href="https://github.com/Vonng/pigsty/blob/master/roles/postgres/files/pg/pg-vacuum"><code>pg-vacuum</code></a></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-9476bf9d0e915c061ced1461d255c19c">备份恢复手段概览</h1>
	<div class="lead">备份是DBA的安身立命之本，有备份，就不用慌。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-02-09" class="text-muted">2018年02月09日</time>
        
	</div>
	<p>备份是DBA的安身立命之本，有备份，就不用慌。</p>
<p>备份有三种形式：SQL转储，文件系统备份，连续归档</p>
<h2 id="1-sql转储">1. SQL转储</h2>
<p>SQL 转储方法的思想是：</p>
<p>创建一个由SQL命令组成的文件，服务器能利用其中的SQL命令重建与转储时状态一样的数据库。</p>
<h3 id="11-转储">1.1 转储</h3>
<p>工具<code>pg_dump</code>、<code>pg_dumpall</code>用于进行SQL转储。结果输出到stdout。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg_dump dbname &gt; filename
</span></span><span style="display:flex;"><span>pg_dump dbname -f filename
</span></span></code></pre></div><ul>
<li><code>pg_dump</code>是一个普通的PostgreSQL客户端应用。可以在任何可以访问该数据库的远端主机上进行备份工作。</li>
<li><code>pg_dump</code>不会以任何特殊权限运行，必须要有你想备份的表的读权限，同时它也遵循同样的HBA机制。</li>
<li>要备份整个数据库，几乎总是需要一个数据库超级用户。</li>
<li>该备份方式的重要优势是，它是跨版本、跨机器架构的备份方式。（最远回溯至7.0）</li>
<li><code>pg_dump</code>的备份是内部一致的，是转储开始时刻的数据库快照，转储期间的更新不被包括在内。</li>
<li><code>pg_dump</code>不会阻塞其他数据库操作，但需要排它锁的命令除外（例如大多数 ALTER TABLE）</li>
</ul>
<h3 id="12-恢复">1.2 恢复</h3>
<p>文本转储文件可由psql读取，从转储中恢复的常用命令是：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql dbname &lt; infile
</span></span></code></pre></div><ul>
<li>
<p>这条命令不会创建数据库<code>dbname</code>，必须在执行psql前自己从<code>template0</code>创建。例如，用命令<code>createdb -T template0 dbname</code>。默认<code>template1</code>和<code>template0</code>是一样的，新创建的数据库默认以<code>template1</code>为模板。</p>
<p><code>CREATE DATABASE dbname TEMPLATE template0;</code></p>
</li>
<li>
<p>非文本文件转储可以使用<a href="http://www.postgres.cn/docs/9.6/app-pgrestore.html">pg_restore</a>工具来恢复。</p>
</li>
<li>
<p>在开始恢复之前，转储库中对象的拥有者以及在其上被授予了权限的用户必须已经存在。如果它们不存在，那么恢复过程将无法将对象创建成具有原来的所属关系以及权限（有时候这就是你所需要的，但通常不是）。</p>
</li>
<li>
<p>恢复时遇到错误自动终止，则可以设置<code>ON_ERROR_STOP</code>变量来运行psql，遇到SQL错误后退出并返回状态3：</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql --set <span style="color:#000">ON_ERROR_STOP</span><span style="color:#ce5c00;font-weight:bold">=</span>on dbname &lt; infile
</span></span></code></pre></div><ul>
<li>恢复时可以使用单个事务来保证要么完全正确恢复，要么完全回滚。使用<code>-1</code>或<code>--single-transaction</code></li>
<li>pg_dump和psql可以通过管道on-the-fly做转储与恢复</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pg_dump -h host1 dbname | psql -h host2 dbname
</span></span></code></pre></div><h3 id="13-全局转储">1.3 全局转储</h3>
<p>一些信息属于数据库集簇，而不是单个数据库的，例如角色、表空间。如果希望转储这些，可使用<code>pg_dumpall</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pg_dumpall &gt; outfile
</span></span></code></pre></div><p>如果只想要全局的数据（角色与表空间），则可以使用<code>-g, --globals-only</code>参数。</p>
<p>转储的结果可以使用psql恢复，通常将转储载入到一个空集簇中可以用<code>postgres</code>作为数据库名</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>psql -f infile postgres
</span></span></code></pre></div><ul>
<li>在恢复一个pg_dumpall转储时常常需要具有数据库超级用户访问权限，因为它需要恢复角色和表空间信息。</li>
<li>如果使用了表空间，请确保转储中的表空间路径适合于新的安装。</li>
<li>pg_dumpall工作步骤是，先创建角色、表空间转储，再为每一个数据库做pg_dump。这意味着每个数据库自身是一致的，但是不同数据库的快照并不同步。</li>
</ul>
<h3 id="14-命令实践">1.4 命令实践</h3>
<p>准备环境，创建测试数据库</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#34;CREATE DATABASE testdb;&#34;</span>
</span></span><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#34;CREATE ROLE test_user LOGIN;&#34;</span>
</span></span><span style="display:flex;"><span>psql testdb -c <span style="color:#4e9a06">&#34;CREATE TABLE test_table(i INTEGER);&#34;</span>
</span></span><span style="display:flex;"><span>psql testdb -c <span style="color:#4e9a06">&#34;INSERT INTO test_table SELECT generate_series(1,16);&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dump到本地文件</span>
</span></span><span style="display:flex;"><span>pg_dump testdb -f testdb.sql 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dump并用xz压缩，-c指定从stdio接受，-d指定解压模式</span>
</span></span><span style="display:flex;"><span>pg_dump testdb <span style="color:#000;font-weight:bold">|</span> xz -cd &gt; testdb.sql.xz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dump，压缩，分割为1m的小块</span>
</span></span><span style="display:flex;"><span>pg_dump testdb <span style="color:#000;font-weight:bold">|</span> xz <span style="color:#000;font-weight:bold">|</span> split -b 1m - testdb.sql.xz
</span></span><span style="display:flex;"><span>cat testdb.sql.xz* <span style="color:#000;font-weight:bold">|</span> xz -cd <span style="color:#000;font-weight:bold">|</span> psql <span style="color:#8f5902;font-style:italic"># 恢复</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pg_dump 常用参数参考</span>
</span></span><span style="display:flex;"><span>-s --schema-only
</span></span><span style="display:flex;"><span>-a --data-only
</span></span><span style="display:flex;"><span>-t --table
</span></span><span style="display:flex;"><span>-n --schema
</span></span><span style="display:flex;"><span>-c --clean
</span></span><span style="display:flex;"><span>-f --file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--inserts
</span></span><span style="display:flex;"><span>--if-exists
</span></span><span style="display:flex;"><span>-N --exclude-schema
</span></span><span style="display:flex;"><span>-T --exclude-table
</span></span></code></pre></div><h2 id="2-文件系统转储">2. 文件系统转储</h2>
<p>SQL 转储方法的思想是：拷贝数据目录的所有文件。为了得到一个可用的备份，所有备份文件都应当保持一致。</p>
<p>所以通常比而且为了得到一个可用的备份，所有备份文件都应当保持一致。</p>
<ul>
<li>文件系统拷贝不做逻辑解析，只是简单拷贝文件。好处是执行快，省掉了逻辑解析和重建索引的时间，坏处是占用空间更大，而且只能用于整个数据库集簇的备份</li>
</ul>
<ul>
<li>
<p>最简单的方式：停机，直接拷贝数据目录的所有文件。</p>
</li>
<li>
<p>有办法通过文件系统（例如xfs）获得一致的冻结快照也可以不停机，但wal和数据目录必须是一致的。</p>
</li>
<li>
<p>可以通过制作pg_basebackup进行远程归档备份，可以不停机。</p>
</li>
<li>
<p>可以通过停机执行rsync的方式向远端增量同步数据变更。</p>
</li>
</ul>
<h2 id="3-pitr-连续归档与时间点恢复">3. PITR 连续归档与时间点恢复</h2>
<p>Pg在运行中会不断产生WAL，WAL记录了操作日志，从某一个基础的全量备份开始回放后续的WAL，就可以恢复数据库到任意的时刻的状态。为了实现这样的功能，就需要配置WAL归档，将数据库生成的WAL不断保存起来。</p>
<p>WAL在逻辑上是一段无限的字节流。<code>pg_lsn</code>类型（bigint）可以标记WAL中的位置，<code>pg_lsn</code>代表一个WAL中的字节位置偏移量。但实践中WAL不是连续的一个文件，而被分割为每16MB一段。</p>
<p>WAL文件名是有规律的，而且归档时不允许更改。通常为24位十六进制数字，<code>000000010000000000000003</code>，其中前面8位十六进制数字表示时间线，后面的16位表示16MB块的序号。即<code>lsn &gt;&gt; 24</code>的值。</p>
<p>查看<code>pg_lsn</code>时，例如<code>0/84A8300</code>，只要去掉最后六位hex，就可以得到WAL文件序号的后面部分，这里，也就是<code>8</code>，如果使用的是默认时间线1，那么对应的WAL文件就是<code>000000010000000000000008</code>。</p>
<h3 id="31-准备环境">3.1 准备环境</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 目录：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用/var/lib/pgsql/data 作为主库目录，使用/var/lib/pgsql/wal作为日志归档目录</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># sudo mkdir /var/lib/pgsql &amp;&amp; sudo chown postgres:postgres /var/lib/pgsql/</span>
</span></span><span style="display:flex;"><span>pg_ctl stop -D /var/lib/pgsql/data
</span></span><span style="display:flex;"><span>rm -rf /var/lib/pgsql/<span style="color:#ce5c00;font-weight:bold">{</span>data,wal<span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> mkdir -p /var/lib/pgsql/<span style="color:#ce5c00;font-weight:bold">{</span>data,wal<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 初始化：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 初始化主库并修改配置文件</span>
</span></span><span style="display:flex;"><span>pg_ctl -D /var/lib/pgsql/data init 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 配置文件</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建默认额外配置文件夹，并在postgresql.conf中配置include_dir</span>
</span></span><span style="display:flex;"><span>mkdir -p /var/lib/pgsql/data/conf.d
</span></span><span style="display:flex;"><span>cat &gt;&gt; /var/lib/pgsql/data/postgresql.conf <span style="color:#4e9a06">&lt;&lt;- &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">include_dir = &#39;conf.d&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><h3 id="32--配置自动归档命令">3.2  配置自动归档命令</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 归档配置</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># %p 代表 src wal path, %f 代表 filename</span>
</span></span><span style="display:flex;"><span>cat &gt; /var/lib/pgsql/data/conf.d/archive.conf <span style="color:#4e9a06">&lt;&lt;- &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">archive_mode = on
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">archive_command = &#39;conf.d/archive.sh %p %f&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 归档脚本 </span>
</span></span><span style="display:flex;"><span>cat &gt; /var/lib/pgsql/data/conf.d/archive.sh <span style="color:#4e9a06">&lt;&lt;- &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">test ! -f /var/lib/pgsql/wal/${2} &amp;&amp; cp ${1} /var/lib/pgsql/wal/${2}
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>chmod a+x /var/lib/pgsql/data/conf.d/archive.sh
</span></span></code></pre></div><p>归档脚本可以简单到只是一个<code>cp</code>，也可以非常复杂。但需要注意以下事项：</p>
<ul>
<li>
<p>归档命令使用数据库用户<code>postgres</code>执行，最好放在0700的目录下面。</p>
</li>
<li>
<p>归档命令应当拒绝覆盖现有文件，出现覆盖时，返回一个错误代码。</p>
</li>
<li>
<p>归档命令可以通过reload配置更新。</p>
</li>
<li>
<p>处理归档失败时的情形</p>
</li>
<li>
<p>归档文件应当保留原有文件名。</p>
</li>
<li>
<p>WAL不会记录对配置文件的变更。</p>
</li>
<li>
<p>归档命令中：<code>%p</code> 会替换为生成待归档WAL的路径，而<code>%f</code>会替换为待归档WAL的文件名</p>
</li>
<li>
<p>归档脚本可以使用更复杂的逻辑，例如下面的归档命令，在归档目录中每天创建一个以日期YYYYMMDD命名的文件夹，在每天12点移除前一天的归档日志。每天的归档日志使用xz压缩存储。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">wal_dir</span><span style="color:#ce5c00;font-weight:bold">=</span>/var/lib/pgsql/wal<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[[</span> <span style="color:#204a87;font-weight:bold">$(</span>date +%H%M<span style="color:#204a87;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1200</span> <span style="color:#ce5c00;font-weight:bold">]]</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> rm -rf <span style="color:#4e9a06">${</span><span style="color:#000">wal_dir</span><span style="color:#4e9a06">}</span>/<span style="color:#204a87;font-weight:bold">$(</span>date -d<span style="color:#4e9a06">&#34;yesterday&#34;</span> +%Y%m%d<span style="color:#204a87;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span> /bin/mkdir -p <span style="color:#4e9a06">${</span><span style="color:#000">wal_dir</span><span style="color:#4e9a06">}</span>/<span style="color:#204a87;font-weight:bold">$(</span>date +%Y%m%d<span style="color:#204a87;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span><span style="color:#204a87">test</span> ! -f <span style="color:#4e9a06">${</span><span style="color:#000">wal_dir</span><span style="color:#4e9a06">}</span>/ <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\ </span>
</span></span><span style="display:flex;"><span>xz -c %p &gt; <span style="color:#4e9a06">${</span><span style="color:#000">wal_dir</span><span style="color:#4e9a06">}</span>/<span style="color:#204a87;font-weight:bold">$(</span>date +%Y%m%d<span style="color:#204a87;font-weight:bold">)</span>/%f.xz
</span></span></code></pre></div></li>
<li>
<p>归档也可以使用外部专用备份工具进行。例如<code>pgbackrest</code>与<code>barman</code>等。</p>
</li>
</ul>
<h3 id="33-测试归档">3.3 测试归档</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启动数据库</span>
</span></span><span style="display:flex;"><span>pg_ctl -D /var/lib/pgsql/data start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 确认配置</span>
</span></span><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#34;SELECT name,setting FROM pg_settings where name like &#39;%archive%&#39;;&#34;</span>
</span></span></code></pre></div><p>在当前shell开启监视循环，不断查询WAL的位置，以及归档目录和<code>pg_wal</code>中的文件变化</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#000;font-weight:bold">;</span>i&lt;100<span style="color:#000;font-weight:bold">;</span>i++<span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#204a87;font-weight:bold">do</span> 
</span></span><span style="display:flex;"><span>	sleep <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	ls /var/lib/pgsql/data/pg_wal <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ls /var/lib/pgsql/data/pg_wal/archive_status/
</span></span><span style="display:flex;"><span>	psql postgres -c <span style="color:#4e9a06">&#39;SELECT pg_current_wal_lsn() as current, pg_current_wal_insert_lsn() as insert, pg_current_wal_flush_lsn() as flush;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><p>在另一个Shell中创建一张测试表<code>foobar</code>，包含单一的时间戳列，并引入负载，每秒写入一万条记录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#39;CREATE TABLE foobar(ts TIMESTAMP);&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#000;font-weight:bold">;</span>i&lt;1000<span style="color:#000;font-weight:bold">;</span>i++<span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#204a87;font-weight:bold">do</span> 
</span></span><span style="display:flex;"><span>	sleep <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	psql postgres -c <span style="color:#4e9a06">&#39;INSERT INTO foobar SELECT now() FROM generate_series(1,10000)&#39;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	psql postgres -c <span style="color:#4e9a06">&#39;SELECT pg_current_wal_lsn() as current, pg_current_wal_insert_lsn() as insert, pg_current_wal_flush_lsn() as flush;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><h4 id="自然切换wal">自然切换WAL</h4>
<p>可以看到，当WAL LSN的位置超过16M（可以由后6个hex表示）之后，就会rotate到一个新的WAL文件，归档命令会将写完的WAL归档。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">000000010000000000000001</span> archive_status
</span></span><span style="display:flex;"><span>  current  <span style="color:#000;font-weight:bold">|</span>  insert   <span style="color:#000;font-weight:bold">|</span>   flush
</span></span><span style="display:flex;"><span>-----------+-----------+-----------
</span></span><span style="display:flex;"><span> 0/1FC2630 <span style="color:#000;font-weight:bold">|</span> 0/1FC2630 <span style="color:#000;font-weight:bold">|</span> 0/1FC2630
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> row<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># rotate here</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">000000010000000000000001</span> <span style="color:#0000cf;font-weight:bold">000000010000000000000002</span> archive_status
</span></span><span style="display:flex;"><span>000000010000000000000001.done
</span></span><span style="display:flex;"><span>  current  <span style="color:#000;font-weight:bold">|</span>  insert   <span style="color:#000;font-weight:bold">|</span>   flush
</span></span><span style="display:flex;"><span>-----------+-----------+-----------
</span></span><span style="display:flex;"><span> 0/205F1B8 <span style="color:#000;font-weight:bold">|</span> 0/205F1B8 <span style="color:#000;font-weight:bold">|</span> 0/205F1B8
</span></span></code></pre></div><h4 id="手工切换wal">手工切换WAL</h4>
<p>再开启一个Shell，执行<code>pg_switch_wal</code>，强制写入一个新的WAL文件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#39;SELECT pg_switch_wal();&#39;</span>
</span></span></code></pre></div><p>可以看到，虽然位置才到<code>32C1D68</code>，但立即就跳到了下一个16MB的边界点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">000000010000000000000001</span> <span style="color:#0000cf;font-weight:bold">000000010000000000000002</span> <span style="color:#0000cf;font-weight:bold">000000010000000000000003</span> archive_status
</span></span><span style="display:flex;"><span>000000010000000000000001.done 000000010000000000000002.done
</span></span><span style="display:flex;"><span>  current  <span style="color:#000;font-weight:bold">|</span>  insert   <span style="color:#000;font-weight:bold">|</span>   flush
</span></span><span style="display:flex;"><span>-----------+-----------+-----------
</span></span><span style="display:flex;"><span> 0/32C1D68 <span style="color:#000;font-weight:bold">|</span> 0/32C1D68 <span style="color:#000;font-weight:bold">|</span> 0/32C1D68
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> row<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># switch here</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">000000010000000000000001</span> <span style="color:#0000cf;font-weight:bold">000000010000000000000002</span> <span style="color:#0000cf;font-weight:bold">000000010000000000000003</span> archive_status
</span></span><span style="display:flex;"><span>000000010000000000000001.done 000000010000000000000002.done 000000010000000000000003.done
</span></span><span style="display:flex;"><span>  current  <span style="color:#000;font-weight:bold">|</span>  insert   <span style="color:#000;font-weight:bold">|</span>   flush
</span></span><span style="display:flex;"><span>-----------+-----------+-----------
</span></span><span style="display:flex;"><span> 0/4000000 <span style="color:#000;font-weight:bold">|</span> 0/4000028 <span style="color:#000;font-weight:bold">|</span> 0/4000000
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> row<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">000000010000000000000001</span> <span style="color:#0000cf;font-weight:bold">000000010000000000000002</span> <span style="color:#0000cf;font-weight:bold">000000010000000000000003</span> <span style="color:#0000cf;font-weight:bold">000000010000000000000004</span> archive_status
</span></span><span style="display:flex;"><span>000000010000000000000001.done 000000010000000000000002.done 000000010000000000000003.done
</span></span><span style="display:flex;"><span>  current  <span style="color:#000;font-weight:bold">|</span>  insert   <span style="color:#000;font-weight:bold">|</span>   flush
</span></span><span style="display:flex;"><span>-----------+-----------+-----------
</span></span><span style="display:flex;"><span> 0/409CBA0 <span style="color:#000;font-weight:bold">|</span> 0/409CBA0 <span style="color:#000;font-weight:bold">|</span> 0/409CBA0
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> row<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h4 id="强制kill数据库">强制kill数据库</h4>
<p>数据库因为故障异常关闭，重启之后，会从最近的检查点，也就是<code>0/2FB0160</code>开始重放WAL。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>17:03:37<span style="color:#ce5c00;font-weight:bold">]</span> vonng@vonng-mac /var/lib/pgsql
</span></span><span style="display:flex;"><span>$  ps axu <span style="color:#000;font-weight:bold">|</span> grep postgres <span style="color:#000;font-weight:bold">|</span> grep data <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $2}&#39;</span> <span style="color:#000;font-weight:bold">|</span> xargs <span style="color:#204a87">kill</span> -9
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>17:06:31<span style="color:#ce5c00;font-weight:bold">]</span> vonng@vonng-mac /var/lib/pgsql
</span></span><span style="display:flex;"><span>$ pg_ctl -D /var/lib/pgsql/data start
</span></span><span style="display:flex;"><span>pg_ctl: another server might be running<span style="color:#000;font-weight:bold">;</span> trying to start server anyway
</span></span><span style="display:flex;"><span>waiting <span style="color:#204a87;font-weight:bold">for</span> server to start....2018-01-25 17:07:27.063 CST <span style="color:#ce5c00;font-weight:bold">[</span>9762<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  listening on IPv6 address <span style="color:#4e9a06">&#34;::1&#34;</span>, port <span style="color:#0000cf;font-weight:bold">5432</span>
</span></span><span style="display:flex;"><span>2018-01-25 17:07:27.063 CST <span style="color:#ce5c00;font-weight:bold">[</span>9762<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  listening on IPv4 address <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span>, port <span style="color:#0000cf;font-weight:bold">5432</span>
</span></span><span style="display:flex;"><span>2018-01-25 17:07:27.064 CST <span style="color:#ce5c00;font-weight:bold">[</span>9762<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  listening on Unix socket <span style="color:#4e9a06">&#34;/tmp/.s.PGSQL.5432&#34;</span>
</span></span><span style="display:flex;"><span>2018-01-25 17:07:27.078 CST <span style="color:#ce5c00;font-weight:bold">[</span>9763<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  database system was interrupted<span style="color:#000;font-weight:bold">;</span> last known up at 2018-01-25 17:06:01 CST
</span></span><span style="display:flex;"><span>2018-01-25 17:07:27.117 CST <span style="color:#ce5c00;font-weight:bold">[</span>9763<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  database system was not properly shut down<span style="color:#000;font-weight:bold">;</span> automatic recovery in progress
</span></span><span style="display:flex;"><span>2018-01-25 17:07:27.120 CST <span style="color:#ce5c00;font-weight:bold">[</span>9763<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  redo starts at 0/2FB0160
</span></span><span style="display:flex;"><span>2018-01-25 17:07:27.722 CST <span style="color:#ce5c00;font-weight:bold">[</span>9763<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  invalid record length at 0/49CBE78: wanted 24, got <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>2018-01-25 17:07:27.722 CST <span style="color:#ce5c00;font-weight:bold">[</span>9763<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  redo <span style="color:#204a87;font-weight:bold">done</span> at 0/49CBE50
</span></span><span style="display:flex;"><span>2018-01-25 17:07:27.722 CST <span style="color:#ce5c00;font-weight:bold">[</span>9763<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  last completed transaction was at log <span style="color:#204a87">time</span> 2018-01-25 17:06:30.158602+08
</span></span><span style="display:flex;"><span>2018-01-25 17:07:27.741 CST <span style="color:#ce5c00;font-weight:bold">[</span>9762<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  database system is ready to accept connections
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">done</span>
</span></span><span style="display:flex;"><span>server started
</span></span></code></pre></div><p>至此，WAL归档已经确认可以正常工作了。</p>
<h3 id="34-制作基础备份">3.4 制作基础备份</h3>
<p>首先，查看当前WAL的位置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ psql postgres -c <span style="color:#4e9a06">&#39;SELECT pg_current_wal_lsn() as current, pg_current_wal_insert_lsn() as insert, pg_current_wal_flush_lsn() as flush;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  current  <span style="color:#000;font-weight:bold">|</span>  insert   <span style="color:#000;font-weight:bold">|</span>   flush
</span></span><span style="display:flex;"><span>-----------+-----------+-----------
</span></span><span style="display:flex;"><span> 0/49CBF20 <span style="color:#000;font-weight:bold">|</span> 0/49CBF20 <span style="color:#000;font-weight:bold">|</span> 0/49CBF20
</span></span></code></pre></div><p>使用<code>pg_basebackup</code>制作基础备份</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#39;SELECT now();&#39;</span>
</span></span><span style="display:flex;"><span>pg_basebackup -Fp -Pv -Xs -c fast -D /var/lib/pgsql/bkup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 常用选项</span>
</span></span><span style="display:flex;"><span>-D  : 必选项，基础备份的位置。
</span></span><span style="display:flex;"><span>-Fp : 备份格式: plain 普通文件 tar 归档文件
</span></span><span style="display:flex;"><span>-Pv : -P 启用进度报告 -v 启用详细输出
</span></span><span style="display:flex;"><span>-Xs : 在备份中包括备份期间产生的WAL日志 f:备份完后拉取 s:备份时流式传输
</span></span><span style="display:flex;"><span>-c  : fast 立即执行Checkpoint而不是均摊IO spread:均摊IO
</span></span><span style="display:flex;"><span>-R  : 设置recovery.conf
</span></span></code></pre></div><p>制作基础备份时，会立即创建一个检查点使得所有脏数据页落盘。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg_basebackup -Fp -Pv -Xs -c fast -D /var/lib/pgsql/bkup
</span></span><span style="display:flex;"><span>pg_basebackup: initiating base backup, waiting <span style="color:#204a87;font-weight:bold">for</span> checkpoint to <span style="color:#204a87">complete</span>
</span></span><span style="display:flex;"><span>pg_basebackup: checkpoint completed
</span></span><span style="display:flex;"><span>pg_basebackup: write-ahead log start point: 0/5000028 on timeline <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>pg_basebackup: starting background WAL receiver
</span></span><span style="display:flex;"><span>45751/45751 kB <span style="color:#ce5c00;font-weight:bold">(</span>100%<span style="color:#ce5c00;font-weight:bold">)</span>, 1/1 tablespace
</span></span><span style="display:flex;"><span>pg_basebackup: write-ahead log end point: 0/50000F8
</span></span><span style="display:flex;"><span>pg_basebackup: waiting <span style="color:#204a87;font-weight:bold">for</span> background process to finish streaming ...
</span></span><span style="display:flex;"><span>pg_basebackup: base backup completed
</span></span></code></pre></div><h3 id="35-使用备份">3.5 使用备份</h3>
<h4 id="直接使用">直接使用</h4>
<p>最简单的使用方式，就是直接用<code>pg_ctl</code>启动它。</p>
<p>当<code>recovery.conf</code>不存在时，这样做会启动一个新的完整数据库实例，原原本本地保留了备份完成时的状态。数据库会并不会意识到自己是一个备份。而是以为自己上次没有正常关闭，应用<code>pg_wal</code>目录中自带的WAL进行修复，正常重启。</p>
<p>基础的全量备份可能每天或每周备份一次，要想恢复到最新的时刻，需要和WAL归档配合使用。</p>
<h4 id="使用wal归档追赶进度">使用WAL归档追赶进度</h4>
<p>可以在备份中数据库下创建一个<code>recovery.conf</code>文件，并指定<code>restore_command</code>选项。这样的话，当使用<code>pg_ctl</code>启动这个数据目录时，postgres会依次拉取所需的WAL，直到没有了为止。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;&gt; /var/lib/pgsql/bkup/recovery.conf <span style="color:#4e9a06">&lt;&lt;- &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">restore_command = &#39;cp /var/lib/pgsql/wal/%f %p&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><p>继续在原始主库中执行负载，这时候WAL的进度已经到了<code>0/9060CE0</code>，而制作备份的时候位置还在<code>0/5000028</code>。</p>
<p>启动备份之后，可以发现，备份数据库自动从归档文件夹拉取了5~8号WAL并应用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg_ctl start -D /var/lib/pgsql/bkup -o <span style="color:#4e9a06">&#39;-p 5433&#39;</span>
</span></span><span style="display:flex;"><span>waiting <span style="color:#204a87;font-weight:bold">for</span> server to start....2018-01-25 17:35:35.001 CST <span style="color:#ce5c00;font-weight:bold">[</span>10862<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  listening on IPv6 address <span style="color:#4e9a06">&#34;::1&#34;</span>, port <span style="color:#0000cf;font-weight:bold">5433</span>
</span></span><span style="display:flex;"><span>2018-01-25 17:35:35.001 CST <span style="color:#ce5c00;font-weight:bold">[</span>10862<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  listening on IPv4 address <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span>, port <span style="color:#0000cf;font-weight:bold">5433</span>
</span></span><span style="display:flex;"><span>2018-01-25 17:35:35.002 CST <span style="color:#ce5c00;font-weight:bold">[</span>10862<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  listening on Unix socket <span style="color:#4e9a06">&#34;/tmp/.s.PGSQL.5433&#34;</span>
</span></span><span style="display:flex;"><span>2018-01-25 17:35:35.016 CST <span style="color:#ce5c00;font-weight:bold">[</span>10863<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  database system was interrupted<span style="color:#000;font-weight:bold">;</span> last known up at 2018-01-25 17:21:15 CST
</span></span><span style="display:flex;"><span>2018-01-25 17:35:35.051 CST <span style="color:#ce5c00;font-weight:bold">[</span>10863<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  starting archive recovery
</span></span><span style="display:flex;"><span>2018-01-25 17:35:35.063 CST <span style="color:#ce5c00;font-weight:bold">[</span>10863<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  restored log file <span style="color:#4e9a06">&#34;000000010000000000000005&#34;</span> from archive
</span></span><span style="display:flex;"><span>2018-01-25 17:35:35.069 CST <span style="color:#ce5c00;font-weight:bold">[</span>10863<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  redo starts at 0/5000028
</span></span><span style="display:flex;"><span>2018-01-25 17:35:35.069 CST <span style="color:#ce5c00;font-weight:bold">[</span>10863<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  consistent recovery state reached at 0/50000F8
</span></span><span style="display:flex;"><span>2018-01-25 17:35:35.070 CST <span style="color:#ce5c00;font-weight:bold">[</span>10862<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  database system is ready to accept <span style="color:#204a87">read</span> only connections
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">done</span>
</span></span><span style="display:flex;"><span>server started
</span></span><span style="display:flex;"><span>2018-01-25 17:35:35.081 CST <span style="color:#ce5c00;font-weight:bold">[</span>10863<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  restored log file <span style="color:#4e9a06">&#34;000000010000000000000006&#34;</span> from archive
</span></span><span style="display:flex;"><span>$ 2018-01-25 17:35:35.924 CST <span style="color:#ce5c00;font-weight:bold">[</span>10863<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  restored log file <span style="color:#4e9a06">&#34;000000010000000000000007&#34;</span> from archive
</span></span><span style="display:flex;"><span>2018-01-25 17:35:36.783 CST <span style="color:#ce5c00;font-weight:bold">[</span>10863<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  restored log file <span style="color:#4e9a06">&#34;000000010000000000000008&#34;</span> from archive
</span></span><span style="display:flex;"><span>cp: /var/lib/pgsql/wal/000000010000000000000009: No such file or directory
</span></span><span style="display:flex;"><span>2018-01-25 17:35:37.604 CST <span style="color:#ce5c00;font-weight:bold">[</span>10863<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  redo <span style="color:#204a87;font-weight:bold">done</span> at 0/8FFFF90
</span></span><span style="display:flex;"><span>2018-01-25 17:35:37.604 CST <span style="color:#ce5c00;font-weight:bold">[</span>10863<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  last completed transaction was at log <span style="color:#204a87">time</span> 2018-01-25 17:30:39.107943+08
</span></span><span style="display:flex;"><span>2018-01-25 17:35:37.614 CST <span style="color:#ce5c00;font-weight:bold">[</span>10863<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  restored log file <span style="color:#4e9a06">&#34;000000010000000000000008&#34;</span> from archive
</span></span><span style="display:flex;"><span>cp: /var/lib/pgsql/wal/00000002.history: No such file or directory
</span></span><span style="display:flex;"><span>2018-01-25 17:35:37.629 CST <span style="color:#ce5c00;font-weight:bold">[</span>10863<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  selected new timeline ID: <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>cp: /var/lib/pgsql/wal/00000001.history: No such file or directory
</span></span><span style="display:flex;"><span>2018-01-25 17:35:37.678 CST <span style="color:#ce5c00;font-weight:bold">[</span>10863<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  archive recovery <span style="color:#204a87">complete</span>
</span></span><span style="display:flex;"><span>2018-01-25 17:35:37.783 CST <span style="color:#ce5c00;font-weight:bold">[</span>10862<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  database system is ready to accept connections
</span></span></code></pre></div><p>但是使用WAL归档的方式来恢复也有问题，例如查询主库与备库最新的数据记录，发现时间戳差了一秒。也就是说，主库还没有写完的WAL并没有被归档，因此也没有应用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>17:37:22<span style="color:#ce5c00;font-weight:bold">]</span> vonng@vonng-mac /var/lib/pgsql
</span></span><span style="display:flex;"><span>$ psql postgres -c <span style="color:#4e9a06">&#39;SELECT max(ts) FROM foobar;&#39;</span>
</span></span><span style="display:flex;"><span>            max
</span></span><span style="display:flex;"><span>----------------------------
</span></span><span style="display:flex;"><span> 2018-01-25 17:30:40.159684
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> row<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>17:37:42<span style="color:#ce5c00;font-weight:bold">]</span> vonng@vonng-mac /var/lib/pgsql
</span></span><span style="display:flex;"><span>$ psql postgres -p <span style="color:#0000cf;font-weight:bold">5433</span> -c <span style="color:#4e9a06">&#39;SELECT max(ts) FROM foobar;&#39;</span>
</span></span><span style="display:flex;"><span>            max
</span></span><span style="display:flex;"><span>----------------------------
</span></span><span style="display:flex;"><span> 2018-01-25 17:30:39.097167
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> row<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>通常<code>archive_command, restore_command</code>主要用于紧急情况下的恢复，比如主库从库都挂了。因为还没有归档</p>
<h3 id="36-指定进度">3.6 指定进度</h3>
<p>默认情况下，恢复将会一直恢复到 WAL 日志的末尾。下面的参数可以被用来指定一个更早的停止点。<code>recovery_target</code>、<code>recovery_target_name</code>、<code>recovery_target_time</code>和<code>recovery_target_xid</code>四个选项中最多只能使用一个，如果在配置文件中使用了多个，将使用最后一个。</p>
<p>上面四个恢复目标中，常用的是 <code>recovery_target_time</code>，用于指明将系统恢复到什么时间。</p>
<p>另外几个常用的选项包括：</p>
<ul>
<li><code>recovery_target_inclusive</code> (<code>boolean</code>) ：是否包括目标点，默认为true</li>
<li><code>recovery_target_timeline</code> (<code>string</code>)： 指定恢复到一个特定的时间线中。</li>
<li><code>recovery_target_action</code> (<code>enum</code>)：指定在达到恢复目标时服务器应该立刻采取的动作。
<ul>
<li><code>pause</code>: 暂停恢复，默认选项，可通过<code>pg_wal_replay_resume</code>恢复。</li>
<li><code>shutdown</code>:  自动关闭。</li>
<li><code>promote</code>: 开始接受连接</li>
</ul>
</li>
</ul>
<p>例如在<code>2018-01-25 18:51:20</code> 创建了一个备份</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ psql postgres -c <span style="color:#4e9a06">&#39;SELECT now();&#39;</span>
</span></span><span style="display:flex;"><span>             now
</span></span><span style="display:flex;"><span>------------------------------
</span></span><span style="display:flex;"><span> 2018-01-25 18:51:20.34732+08
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> row<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>18:51:20<span style="color:#ce5c00;font-weight:bold">]</span> vonng@vonng-mac ~
</span></span><span style="display:flex;"><span>$ pg_basebackup -Fp -Pv -Xs -c fast -D /var/lib/pgsql/bkup
</span></span><span style="display:flex;"><span>pg_basebackup: initiating base backup, waiting <span style="color:#204a87;font-weight:bold">for</span> checkpoint to <span style="color:#204a87">complete</span>
</span></span><span style="display:flex;"><span>pg_basebackup: checkpoint completed
</span></span><span style="display:flex;"><span>pg_basebackup: write-ahead log start point: 0/3000028 on timeline <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>pg_basebackup: starting background WAL receiver
</span></span><span style="display:flex;"><span>33007/33007 kB <span style="color:#ce5c00;font-weight:bold">(</span>100%<span style="color:#ce5c00;font-weight:bold">)</span>, 1/1 tablespace
</span></span><span style="display:flex;"><span>pg_basebackup: write-ahead log end point: 0/30000F8
</span></span><span style="display:flex;"><span>pg_basebackup: waiting <span style="color:#204a87;font-weight:bold">for</span> background process to finish streaming ...
</span></span><span style="display:flex;"><span>pg_basebackup: base backup completed
</span></span></code></pre></div><p>之后运行了两分钟，到了<code>2018-01-25 18:53:05</code>我们发现有几条脏数据，于是从备份开始恢复，希望恢复到脏数据出现前一分钟的状态，例如<code>2018-01-25 18:52</code></p>
<p>可以这样配置</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt;&gt; /var/lib/pgsql/bkup/recovery.conf <span style="color:#4e9a06">&lt;&lt;- &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">restore_command = &#39;cp /var/lib/pgsql/wal/%f %p&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">recovery_target_time = &#39;2018-01-25 18:52:30&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">recovery_target_action = &#39;promote&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><p>当新的数据库实例完成恢复之后，可以看到它的状态确实回到了 18:52分，这正是我们期望的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg_ctl -D /var/lib/pgsql/bkup -o <span style="color:#4e9a06">&#39;-p 5433&#39;</span> start
</span></span><span style="display:flex;"><span>waiting <span style="color:#204a87;font-weight:bold">for</span> server to start....2018-01-25 18:56:24.147 CST <span style="color:#ce5c00;font-weight:bold">[</span>13120<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  listening on IPv6 address <span style="color:#4e9a06">&#34;::1&#34;</span>, port <span style="color:#0000cf;font-weight:bold">5433</span>
</span></span><span style="display:flex;"><span>2018-01-25 18:56:24.147 CST <span style="color:#ce5c00;font-weight:bold">[</span>13120<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  listening on IPv4 address <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span>, port <span style="color:#0000cf;font-weight:bold">5433</span>
</span></span><span style="display:flex;"><span>2018-01-25 18:56:24.148 CST <span style="color:#ce5c00;font-weight:bold">[</span>13120<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  listening on Unix socket <span style="color:#4e9a06">&#34;/tmp/.s.PGSQL.5433&#34;</span>
</span></span><span style="display:flex;"><span>2018-01-25 18:56:24.162 CST <span style="color:#ce5c00;font-weight:bold">[</span>13121<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  database system was interrupted<span style="color:#000;font-weight:bold">;</span> last known up at 2018-01-25 18:51:22 CST
</span></span><span style="display:flex;"><span>2018-01-25 18:56:24.197 CST <span style="color:#ce5c00;font-weight:bold">[</span>13121<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  starting point-in-time recovery to 2018-01-25 18:52:30+08
</span></span><span style="display:flex;"><span>2018-01-25 18:56:24.210 CST <span style="color:#ce5c00;font-weight:bold">[</span>13121<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  restored log file <span style="color:#4e9a06">&#34;000000010000000000000003&#34;</span> from archive
</span></span><span style="display:flex;"><span>2018-01-25 18:56:24.215 CST <span style="color:#ce5c00;font-weight:bold">[</span>13121<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  redo starts at 0/3000028
</span></span><span style="display:flex;"><span>2018-01-25 18:56:24.215 CST <span style="color:#ce5c00;font-weight:bold">[</span>13121<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  consistent recovery state reached at 0/30000F8
</span></span><span style="display:flex;"><span>2018-01-25 18:56:24.216 CST <span style="color:#ce5c00;font-weight:bold">[</span>13120<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  database system is ready to accept <span style="color:#204a87">read</span> only connections
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">done</span>
</span></span><span style="display:flex;"><span>server started
</span></span><span style="display:flex;"><span>2018-01-25 18:56:24.228 CST <span style="color:#ce5c00;font-weight:bold">[</span>13121<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  restored log file <span style="color:#4e9a06">&#34;000000010000000000000004&#34;</span> from archive
</span></span><span style="display:flex;"><span>$ 2018-01-25 18:56:25.034 CST <span style="color:#ce5c00;font-weight:bold">[</span>13121<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  restored log file <span style="color:#4e9a06">&#34;000000010000000000000005&#34;</span> from archive
</span></span><span style="display:flex;"><span>2018-01-25 18:56:25.853 CST <span style="color:#ce5c00;font-weight:bold">[</span>13121<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  restored log file <span style="color:#4e9a06">&#34;000000010000000000000006&#34;</span> from archive
</span></span><span style="display:flex;"><span>2018-01-25 18:56:26.235 CST <span style="color:#ce5c00;font-weight:bold">[</span>13121<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  recovery stopping before commit of transaction 649, <span style="color:#204a87">time</span> 2018-01-25 18:52:30.492371+08
</span></span><span style="display:flex;"><span>2018-01-25 18:56:26.235 CST <span style="color:#ce5c00;font-weight:bold">[</span>13121<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  redo <span style="color:#204a87;font-weight:bold">done</span> at 0/67CFD40
</span></span><span style="display:flex;"><span>2018-01-25 18:56:26.235 CST <span style="color:#ce5c00;font-weight:bold">[</span>13121<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  last completed transaction was at log <span style="color:#204a87">time</span> 2018-01-25 18:52:29.425596+08
</span></span><span style="display:flex;"><span>cp: /var/lib/pgsql/wal/00000002.history: No such file or directory
</span></span><span style="display:flex;"><span>2018-01-25 18:56:26.240 CST <span style="color:#ce5c00;font-weight:bold">[</span>13121<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  selected new timeline ID: <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>cp: /var/lib/pgsql/wal/00000001.history: No such file or directory
</span></span><span style="display:flex;"><span>2018-01-25 18:56:26.293 CST <span style="color:#ce5c00;font-weight:bold">[</span>13121<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  archive recovery <span style="color:#204a87">complete</span>
</span></span><span style="display:flex;"><span>2018-01-25 18:56:26.401 CST <span style="color:#ce5c00;font-weight:bold">[</span>13120<span style="color:#ce5c00;font-weight:bold">]</span> LOG:  database system is ready to accept connections
</span></span><span style="display:flex;"><span>$
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># query new server ，确实回到了18:52分</span>
</span></span><span style="display:flex;"><span>$ psql postgres -p <span style="color:#0000cf;font-weight:bold">5433</span> -c <span style="color:#4e9a06">&#39;SELECT max(ts) FROM foobar;&#39;</span>
</span></span><span style="display:flex;"><span>            max
</span></span><span style="display:flex;"><span>----------------------------
</span></span><span style="display:flex;"><span> 2018-01-25 18:52:29.413911
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> row<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="37-时间线">3.7 时间线</h3>
<p>每当归档文件恢复完成后，也就是服务器可以开始接受新的查询，写新的WAL的时候。会创建一个新的时间线用来区别新生成的WAL记录。WAL文件名由时间线和日志序号组成，因此新的时间线WAL不会覆盖老时间线的WAL。时间线主要用来解决复杂的恢复操作冲突，例如试想一个场景：刚才恢复到18:52分之后，新的服务器开始不断接受请求：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#39;CREATE TABLE foobar(ts TIMESTAMP);&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#000;font-weight:bold">;</span>i&lt;1000<span style="color:#000;font-weight:bold">;</span>i++<span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#204a87;font-weight:bold">do</span> 
</span></span><span style="display:flex;"><span>	sleep <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	psql -p <span style="color:#0000cf;font-weight:bold">5433</span> postgres -c <span style="color:#4e9a06">&#39;INSERT INTO foobar SELECT now() FROM generate_series(1,10000)&#39;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	psql -p <span style="color:#0000cf;font-weight:bold">5433</span> postgres -c <span style="color:#4e9a06">&#39;SELECT pg_current_wal_lsn() as current, pg_current_wal_insert_lsn() as insert, pg_current_wal_flush_lsn() as flush;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><p>可以看到，WAL归档目录中出现了两个<code>6</code>号WAL段文件，如果没有前面的时间线作为区分，WAL就会被覆盖。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls -alh wal
</span></span><span style="display:flex;"><span>total <span style="color:#0000cf;font-weight:bold">262160</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#0000cf;font-weight:bold">12</span> vonng  wheel   384B Jan <span style="color:#0000cf;font-weight:bold">25</span> 18:59 .
</span></span><span style="display:flex;"><span>drwxr-xr-x   <span style="color:#0000cf;font-weight:bold">6</span> vonng  wheel   192B Jan <span style="color:#0000cf;font-weight:bold">25</span> 18:51 ..
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#0000cf;font-weight:bold">1</span> vonng  wheel    16M Jan <span style="color:#0000cf;font-weight:bold">25</span> 18:51 <span style="color:#0000cf;font-weight:bold">000000010000000000000001</span>
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#0000cf;font-weight:bold">1</span> vonng  wheel    16M Jan <span style="color:#0000cf;font-weight:bold">25</span> 18:51 <span style="color:#0000cf;font-weight:bold">000000010000000000000002</span>
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#0000cf;font-weight:bold">1</span> vonng  wheel    16M Jan <span style="color:#0000cf;font-weight:bold">25</span> 18:51 <span style="color:#0000cf;font-weight:bold">000000010000000000000003</span>
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#0000cf;font-weight:bold">1</span> vonng  wheel   302B Jan <span style="color:#0000cf;font-weight:bold">25</span> 18:51 000000010000000000000003.00000028.backup
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#0000cf;font-weight:bold">1</span> vonng  wheel    16M Jan <span style="color:#0000cf;font-weight:bold">25</span> 18:51 <span style="color:#0000cf;font-weight:bold">000000010000000000000004</span>
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#0000cf;font-weight:bold">1</span> vonng  wheel    16M Jan <span style="color:#0000cf;font-weight:bold">25</span> 18:52 <span style="color:#0000cf;font-weight:bold">000000010000000000000005</span>
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#0000cf;font-weight:bold">1</span> vonng  wheel    16M Jan <span style="color:#0000cf;font-weight:bold">25</span> 18:52 <span style="color:#0000cf;font-weight:bold">000000010000000000000006</span>
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#0000cf;font-weight:bold">1</span> vonng  wheel    50B Jan <span style="color:#0000cf;font-weight:bold">25</span> 18:56 00000002.history
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#0000cf;font-weight:bold">1</span> vonng  wheel    16M Jan <span style="color:#0000cf;font-weight:bold">25</span> 18:58 <span style="color:#0000cf;font-weight:bold">000000020000000000000006</span>
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#0000cf;font-weight:bold">1</span> vonng  wheel    16M Jan <span style="color:#0000cf;font-weight:bold">25</span> 18:59 <span style="color:#0000cf;font-weight:bold">000000020000000000000007</span>
</span></span></code></pre></div><p>假设完成恢复之后又反悔了，则可以用基础备份通过指定<code>recovery_target_timeline = '1'</code> 再次恢复回第一次运行到18:53 时的状态。</p>
<h3 id="38-其他注意事项">3.8 其他注意事项</h3>
<ul>
<li>在Pg 10之前，哈希索引上的操作不会被记录在WAL中，需要在Slave上手工REINDEX。</li>
<li>不要在创建基础备份的时候修改任何<strong>模板数据库</strong></li>
<li>注意表空间会严格按照字面值记录其路径，如果使用了表空间，恢复时要非常小心。</li>
</ul>
<h2 id="4-制作备机">4. 制作备机</h2>
<p>通过主从（master-slave），可以同时提高可用性与可靠性。</p>
<ul>
<li>主从读写分离提高性能：写请求落在Master上，通过WAL流复制传输到从库上，从库接受读请求。</li>
<li>通过备份提高可靠性：当一台服务器故障时，可以立即由另一台顶上(promote slave or &amp; make new slave)</li>
</ul>
<p>通常主从、副本、备机这些属于高可用的话题。但从另一个角度来讲，备机也是备份的一种。</p>
<h4 id="创建目录">创建目录</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mkdir /var/lib/pgsql <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo chown postgres:postgres /var/lib/pgsql/
</span></span><span style="display:flex;"><span>mkdir -p /var/lib/pgsql/master /var/lib/pgsql/slave /var/lib/pgsql/wal
</span></span></code></pre></div><h4 id="制作主库">制作主库</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg_ctl -D /var/lib/pgsql/master init <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> pg_ctl -D /var/lib/pgsql/master start
</span></span></code></pre></div><h4 id="创建用户">创建用户</h4>
<p>创建备库需要一个具有<code>REPLICATION</code>权限的用户，这里在Master中创建<code>replication</code>用户</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#39;CREATE USER replication REPLICATION;&#39;</span>
</span></span></code></pre></div><p>为了创建从库，需要一个具有<code>REPLICATION</code>权限的用户，并在<code>pg_hba</code>中允许访问，10中默认允许：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">local   replication     all                                     trust</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host    replication     all             127.0.0.1/32            trust</span>
</span></span></code></pre></div><h4 id="制作备库">制作备库</h4>
<p>通过<code>pg_basebackup</code>创建一个slave实例。实际上是连接到Master实例，并复制一份数据目录到本地。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg_basebackup -Fp -Pv -R -c fast -U replication -h localhost -D /var/lib/pgsql/slave
</span></span></code></pre></div><p>这里的关键是通过<code>-R</code> 选项，在备份的制作过程中自动将主机的连接信息填入<code>recovery.conf</code>，这样使用<code>pg_ctl </code>启动时，数据库会意识到自己是备机，并从主机自动拉取WAL追赶进度。</p>
<h4 id="启动从库">启动从库</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg_ctl -D /var/lib/pgsql/slave -o <span style="color:#4e9a06">&#34;-p 5433&#34;</span> start
</span></span></code></pre></div><p>从库与主库的唯一区别在于，数据目录中多了一个<code>recovery.conf</code>文件。这个文件不仅仅可以用于标识从库的身份，而且在故障恢复时也需要用到。对于<code>pg_basebackup</code>构造的从库，它默认包含两个参数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">standby_mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;on&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">primary_conninfo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;user=replication passfile=&#39;&#39;/Users/vonng/.pgpass&#39;&#39; host=localhost port=5432 sslmode=prefer sslcompression=1 krbsrvname=postgres target_session_attrs=any&#39;</span>
</span></span></code></pre></div><p><code>standby_mode</code>指明是否将PostgreSQL作为从库启动。</p>
<p>在备份时，<code>standby_mode</code>默认关闭，这样当所有的WAL拉取完毕后，就完成恢复，进入正常工作模式。</p>
<p>如果打开，那么数据库会意识到自己是备机，那么即使到达WAL末尾也不会停止，它会持续拉取主库的WAL，追赶主库的进度。</p>
<p>拉取WAL有两种办法，通过<code>primary_conninfo</code>流式复制拉取（9.0后的新特性，推荐，默认），或者通过<code>restore_command</code>来手工指明WAL的获取方式（老办法，恢复时使用）。</p>
<h4 id="查看状态">查看状态</h4>
<p>主库的所有从库可以通过系统视图<code>pg_stat_replication</code>查阅：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ psql postgres -tzxc <span style="color:#4e9a06">&#39;SELECT * FROM pg_stat_replication;&#39;</span>
</span></span><span style="display:flex;"><span>pid              <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">1947</span>
</span></span><span style="display:flex;"><span>usesysid         <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">16384</span>
</span></span><span style="display:flex;"><span>usename          <span style="color:#000;font-weight:bold">|</span> replication
</span></span><span style="display:flex;"><span>application_name <span style="color:#000;font-weight:bold">|</span> walreceiver
</span></span><span style="display:flex;"><span>client_addr      <span style="color:#000;font-weight:bold">|</span> ::1
</span></span><span style="display:flex;"><span>client_hostname  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>client_port      <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">54124</span>
</span></span><span style="display:flex;"><span>backend_start    <span style="color:#000;font-weight:bold">|</span> 2018-01-25 13:24:57.029203+08
</span></span><span style="display:flex;"><span>backend_xmin     <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>state            <span style="color:#000;font-weight:bold">|</span> streaming
</span></span><span style="display:flex;"><span>sent_lsn         <span style="color:#000;font-weight:bold">|</span> 0/5017F88
</span></span><span style="display:flex;"><span>write_lsn        <span style="color:#000;font-weight:bold">|</span> 0/5017F88
</span></span><span style="display:flex;"><span>flush_lsn        <span style="color:#000;font-weight:bold">|</span> 0/5017F88
</span></span><span style="display:flex;"><span>replay_lsn       <span style="color:#000;font-weight:bold">|</span> 0/5017F88
</span></span><span style="display:flex;"><span>write_lag        <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>flush_lag        <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>replay_lag       <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>sync_priority    <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>sync_state       <span style="color:#000;font-weight:bold">|</span> async
</span></span></code></pre></div><p>检查主库和备库的状态可以使用函数<code>pg_is_in_recovery</code>，备库会处于恢复状态：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ psql postgres -Atzc <span style="color:#4e9a06">&#39;SELECT pg_is_in_recovery()&#39;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>psql postgres -p <span style="color:#0000cf;font-weight:bold">5433</span> -Atzc <span style="color:#4e9a06">&#39;SELECT pg_is_in_recovery()&#39;</span>
</span></span><span style="display:flex;"><span>f
</span></span><span style="display:flex;"><span>t
</span></span></code></pre></div><p>在主库中建表，从库也能看到。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#39;CREATE TABLE foobar(i INTEGER);&#39;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> psql postgres -p <span style="color:#0000cf;font-weight:bold">5433</span> -c <span style="color:#4e9a06">&#39;\d&#39;</span>
</span></span></code></pre></div><p>在主库中插入数据，从库也能看到</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres -c <span style="color:#4e9a06">&#39;INSERT INTO foobar VALUES (1);&#39;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>psql postgres -p <span style="color:#0000cf;font-weight:bold">5433</span> -c <span style="color:#4e9a06">&#39;SELECT * FROM foobar;&#39;</span>
</span></span></code></pre></div><p>现在主备已经配置就绪</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-4e34a5f7f29d501e8880ca9e3d3c7fd7">PgBackRest2中文文档</h1>
	<div class="lead">PgBackRest是用perl写的一组PostgreSQL备份工具</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-02-07" class="text-muted">2018年02月07日</time>
        
	</div>
	<p>pgBackRest主页：http://pgbackrest.org</p>
<p>pgBackRest Github主页：https://github.com/pgbackrest/pgbackrest</p>
<h2 id="前言">前言</h2>
<p>pgBackRest旨在提供一个简单可靠，容易纵向扩展的PostgreSQL备份恢复系统。</p>
<p>pgBackRest并不依赖像tar和rsync这样的传统备份工具，而在内部实现所有备份功能，并使用自定义协议来与远程系统进行通信。 消除对tar和rsync的依赖可以更好地解决特定于数据库的备份问题。 自定义远程协议提供了更多的灵活性，并限制执行备份所需的连接类型，从而提高安全性。</p>
<p>pgBackRest <a href="https://github.com/pgbackrest/pgbackrest/releases/tag/release/2.01">v2.01</a>是目前的稳定版本。 发行说明位在发行页面上。</p>
<p>pgBackRest旨在成为一个简单，可靠的备份和恢复系统，可以无缝扩展到最大的数据库和工作负载。</p>
<p>pgBackRest不依赖像tar和rsync这样的传统备份工具，而是在内部实现所有备份功能，并使用自定义协议与远程系统进行通信。消除对tar和rsync的依赖可以更好地解决针对数据库的备份挑战。自定义远程协议允许更大的灵活性，并限制执行备份所需的连接类型，从而提高安全性。</p>
<p>pgBackRest <a href="https://github.com/pgbackrest/pgbackrest/releases/tag/release/2.01">v2.01</a>是当前的稳定版本。发行说明位于<a href="https://pgbackrest.org/release.html">发行版</a>页面上。</p>
<p>只有在EOL之前，pgBackRest v1才会收到修复错误。v1的文档可以在<a href="http://www.pgbackrest.org/1">这里</a>找到。</p>
<h2 id="0-特性">0. 特性</h2>
<ul>
<li>
<p>并行备份和恢复</p>
<p>压缩通常是备份操作的瓶颈，但即使是现在已经很普及的多核服务器，大多数数据库备份解决方案仍然是单进程的。 pgBackRest通过并行处理解决了压缩瓶颈问题。利用多个核心进行压缩，即使在1Gb/s的链路上，也可以实现1TB /小时的原生吞吐量。更多的核心和更大的带宽将带来更高的吞吐量。</p>
</li>
<li>
<p>本地或远程操作</p>
<p>自定义协议允许pgBackRest以最少的配置通过SSH进行本地或远程备份，恢复和归档。通过协议层也提供了查询PostgreSQL的接口，从而不需要对PostgreSQL进行远程访问，从而增强了安全性。</p>
</li>
<li>
<p>全量备份与增量备份</p>
<p>支持全量备份，增量备份，以及差异备份。 pgBackRest不会受到rsync的时间分辨问题的影响，使得差异备份和增量备份完全安全。</p>
</li>
<li>
<p>备份轮换和归档过期</p>
<p>可以为全量备份和增量备份设置保留策略，以创建覆盖任何时间范围的备份。 WAL归档可以设置为为所有的备份或仅最近的备份保留。在后一种情况下，在归档过程中会自动保证更老备份的一致性。</p>
</li>
<li>
<p>备份完整性</p>
<p>每个文件在备份时都会计算校验和，并在还原过程中重新检查。完成文件复制后，备份会等待所有必须的WAL段进入存储库。存储库中的备份以与标准PostgreSQL集群（包括表空间）相同的格式存储。如果禁用压缩并启用硬链接，则可以在存储库中快照备份，并直接在快照上创建PostgreSQL集群。这对于以传统方式恢复很耗时的TB级数据库是有利的。所有操作都使用文件和目录级别fsync来确保持久性。</p>
</li>
<li>
<p>页面校验和</p>
<p>PostgreSQL从9.3开始支持页面级校验和。如果启用页面校验和，pgBackRest将验证在备份过程中复制的每个文件的校验和。所有页面校验和在完整备份过程中均得到验证，在差异备份和增量备份过程中验证了已更改文件中的校验和。
验证失败不会停止备份过程，但会向控制台和文件日志输出具体的哪些页面验证失败的详细警告。</p>
<p>此功能允许在包含有效数据副本的备份已过期之前及早检测到页级损坏。</p>
</li>
<li>
<p>备份恢复</p>
<p>中止的备份可以从停止点恢复。已经复制的文件将与清单中的校验和进行比较，以确保完整性。由于此操作可以完全在备份服务器上进行，因此减少了数据库服务器上的负载，并节省了时间，因为校验和计算比压缩和重新传输数据要快。</p>
</li>
<li>
<p>流压缩和校验和</p>
<p>无论存储库位于本地还是远程，压缩和校验和计算均在流中执行，而文件正在复制到存储库。
如果存储库位于备份服务器上，则在数据库服务器上执行压缩，并以压缩格式传输文件，并将其存储在备份服务器上。当禁用压缩时，利用较低级别的压缩来有效使用可用带宽，同时将CPU成本降至最低。</p>
</li>
<li>
<p>增量恢复</p>
<p>清单包含备份中每个文件的校验和，以便在还原过程中可以使用这些校验和来加快处理速度。在增量恢复时，备份中不存在的任何文件将首先被删除，然后对其余文件执行校验和。与备份相匹配的文件将保留在原位，其余文件将照常恢复。并行处理可能会导致恢复时间大幅减少。</p>
</li>
<li>
<p>并行WAL归档</p>
<p>包括专用的命令将WAL推送到归档并从归档中检索WAL。push命令会自动检测多次推送的WAL段，并在段相同时自动解除重复，否则会引发错误。 push和get命令都通过比较PostgreSQL版本和系统标识符来确保数据库和存储库匹配。这排除了错误配置WAL归档位置的可能性。
异步归档允许将传输转移到另一个并行压缩WAL段的进程，以实现最大的吞吐量。对于写入量非常高的数据库来说，这可能是一个关键功能。</p>
</li>
<li>
<p>表空间和链接支持</p>
<p>完全支持表空间，并且还原表空间可以重映射到任何位置。也可以使用一个对开发恢复有用的命令将所有的表空间重新映射到一个位置。</p>
</li>
<li>
<p>Amazon S3支持</p>
<p>pgBackRest存储库可以存储在Amazon S3上，以实现几乎无限的容量和保留。</p>
</li>
<li>
<p>加密</p>
<p>pgBackRest可以对存储库进行加密，以保护无论存储在何处的备份。</p>
</li>
<li>
<p>与PostgreSQL兼容&gt; = 8.3</p>
<p>pgBackRest包含了对8.3以下版本的支持，因为旧版本的PostgreSQL仍然是经常使用的。</p>
</li>
</ul>
<h2 id="1-简介">1. 简介</h2>
<p>本用户指南旨在从头到尾按顺序进行，每一节依赖上一节。例如“备份”部分依赖“快速入门”部分中执行的设置。</p>
<p>尽管这些例子是针对Debian / Ubuntu和PostgreSQL 9.4的，但是将这个指南应用到任何Unix发行版和PostgreSQL版本上应该相当容易。请注意，由于Perl代码中的64位操作，目前只支持64位发行版。唯一的特定于操作系统的命令是创建，启动，停止和删除PostgreSQL集群的命令。尽管安装Perl库和可执行文件的位置可能有所不同，但任何Unix系统上的pgBackRest命令都是相同的。</p>
<p>PostgreSQL的配置信息和文档可以在PostgreSQL手册中找到。</p>
<p>本用户指南采用了一些新颖的方法来记录。从XML源生成文档时，每个命令都在虚拟机上运行。这意味着您可以高度自信地确保命令按照所呈现的顺序正确工作。捕获输出并在适当的时候显示在命令之下。如果输出不包括，那是因为它被认为是不相关的或者被认为是从叙述中分心的。</p>
<p>所有的命令都是作为非特权用户运行的，它对root用户和postgres用户都具有sudo权限。也可以直接以各自的用户身份运行这些命令而不用修改，在这种情况下，sudo命令可以被剥离。</p>
<h2 id="2-概念">2. 概念</h2>
<h3 id="21-备份">2.1 备份</h3>
<p>备份是数据库集群的一致副本，可以从硬件故障中恢复，执行时间点恢复或启动新的备用数据库。</p>
<ul>
<li>
<p>全量备份（Full Backup）</p>
<p>pgBackRest将数据库集簇的全部文件复制到备份服务器。数据库集簇的第一个备份总是全量备份。</p>
<p>pgBackRest总能从全量备份直接恢复。全量备份的一致性不依赖任何外部文件。</p>
</li>
<li>
<p>差异备份（Differential Backup）</p>
<p>pgBackRest仅复制自上次全量备份以来，内容发生变更的数据库群集文件。恢复时，pgBackRest拷贝差异备份中的所有文件，以及之前一次全量备份中所有未发生变更的文件。差异备份的优点是它比全量备份需要更少的硬盘空间，缺点是差异备份的恢复依赖上一次全量备份的有效性。</p>
</li>
<li>
<p>增量备份（Incremental Backup）</p>
<p>pgBackRest仅复制自上次备份（可能是另一个增量备份，差异备份或完全备份）以来发生更改的数据库群集文件。由于增量备份只包含自上次备份以来更改的那些文件，因此它们通常远远小于完全备份或差异备份。与差异备份一样，增量备份依赖于其他备份才能有效恢复增量备份。由于增量备份只包含自上次备份以来的文件，所有之前的增量备份都恢复到以前的差异，先前的差异备份和先前的完整备份必须全部有效才能执行增量备份的恢复。如果不存在差异备份，则以前的所有增量备份将恢复到之前的完整备份（必须存在），而完全备份本身必须有效才能恢复增量备份。</p>
</li>
</ul>
<h3 id="22-还原">2.2 还原</h3>
<p>还原是将备份复制到将作为实时数据库集群启动的系统的行为。还原需要备份文件和一个或多个WAL段才能正常工作。</p>
<h4 id="23-wal">2.3 WAL</h4>
<p>WAL是PostgreSQL用来确保没有提交的更改丢失的机制。将事务顺序写入WAL，并且在将这些写入刷新到磁盘时认为事务被提交。之后，后台进程将更改写入主数据库集群文件（也称为堆）。在发生崩溃的情况下，重播WAL以使数据库保持一致。</p>
<p>WAL在概念上是无限的，但在实践中被分解成单独的16MB文件称为段。 WAL段按照命名约定<code>0000000100000A1E000000FE</code>，其中前8个十六进制数字表示时间线，接下来的16个数字是逻辑序列号（LSN）。</p>
<h4 id="24-加密">2.4 加密</h4>
<p>加密是将数据转换为无法识别的格式的过程，除非提供了适当的密码（也称为密码短语）。</p>
<p>pgBackRest将根据用户提供的密码加密存储库，从而防止未经授权访问存储库中的数据。</p>
<h2 id="3-安装">3. 安装</h2>
<h3 id="short-version">short version</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cent-os</span>
</span></span><span style="display:flex;"><span>sudo yum install -y pgbackrest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ubuntu</span>
</span></span><span style="display:flex;"><span>sudo apt-get install libdbd-pg-perl libio-socket-ssl-perl libxml-libxml-perl
</span></span></code></pre></div><h3 id="verbose-version">verbose version</h3>
<p>创建一个名为db-primary的新主机来包含演示群集并运行pgBackRest示例。
如果已经安装了pgBackRest，最好确保没有安装先前的副本。取决于pgBackRest的版本可能已经安装在几个不同的位置。以下命令将删除所有先前版本的pgBackRest。</p>
<ul>
<li>db-primary⇒删除以前的pgBackRest安装</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo rm -f /usr/bin/pgbackrest
</span></span><span style="display:flex;"><span>sudo rm -f /usr/bin/pg_backrest
</span></span><span style="display:flex;"><span>sudo rm -rf /usr/lib/perl5/BackRest
</span></span><span style="display:flex;"><span>sudo rm -rf /usr/share/perl5/BackRest
</span></span><span style="display:flex;"><span>sudo rm -rf /usr/lib/perl5/pgBackRest
</span></span><span style="display:flex;"><span>sudo rm -rf /usr/share/perl5/pgBackRest
</span></span></code></pre></div><p>pgBackRest是用Perl编写的，默认包含在Debian/Ubuntu中。一些额外的模块也必须安装，但是它们可以作为标准包使用。</p>
<ul>
<li>db-primary⇒安装必需的Perl软件包</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cent-os</span>
</span></span><span style="display:flex;"><span>sudo yum install -y pgbackrest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ubuntu</span>
</span></span><span style="display:flex;"><span>sudo apt-get install libdbd-pg-perl libio-socket-ssl-perl libxml-libxml-perl
</span></span></code></pre></div><p>适用于pgBackRest的Debian / Ubuntu软件包位于<a href="https://www.postgresql.org/download/linux/ubuntu/">apt.postgresql.org</a>。如果没有为您的发行版/版本提供，则可以轻松下载源代码并手动安装。</p>
<ul>
<li>db-primary⇒下载pgBackRest的2.01版本</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo wget -q -O- <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>       https://github.com/pgbackrest/pgbackrest/archive/release/2.01.tar.gz <span style="color:#000;font-weight:bold">|</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>       sudo tar zx -C /root
</span></span><span style="display:flex;"><span>       
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># or without sudo</span>
</span></span><span style="display:flex;"><span>wget -q -O - https://github.com/pgbackrest/pgbackrest/archive/release/2.01.tar.gz <span style="color:#000;font-weight:bold">|</span> tar zx -C /tmp
</span></span></code></pre></div><ul>
<li>db-primary⇒安装pgBackRest</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo cp -r /root/pgbackrest-release-2.01/lib/pgBackRest <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>       /usr/share/perl5
</span></span><span style="display:flex;"><span>sudo find /usr/share/perl5/pgBackRest -type f -exec chmod <span style="color:#0000cf;font-weight:bold">644</span> <span style="color:#ce5c00;font-weight:bold">{}</span> +
</span></span><span style="display:flex;"><span>sudo find /usr/share/perl5/pgBackRest -type d -exec chmod <span style="color:#0000cf;font-weight:bold">755</span> <span style="color:#ce5c00;font-weight:bold">{}</span> +
</span></span><span style="display:flex;"><span>sudo mkdir -m <span style="color:#0000cf;font-weight:bold">770</span> /var/log/pgbackrest
</span></span><span style="display:flex;"><span>sudo chown postgres:postgres /var/log/pgbackrest
</span></span><span style="display:flex;"><span>sudo touch /etc/pgbackrest.conf
</span></span><span style="display:flex;"><span>sudo chmod <span style="color:#0000cf;font-weight:bold">640</span> /etc/pgbackrest.conf
</span></span><span style="display:flex;"><span>sudo chown postgres:postgres /etc/pgbackrest.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo cp -r /root/pgbackrest-release-1.27/lib/pgBackRest <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>       /usr/share/perl5
</span></span><span style="display:flex;"><span>sudo find /usr/share/perl5/pgBackRest -type f -exec chmod <span style="color:#0000cf;font-weight:bold">644</span> <span style="color:#ce5c00;font-weight:bold">{}</span> +
</span></span><span style="display:flex;"><span>sudo find /usr/share/perl5/pgBackRest -type d -exec chmod <span style="color:#0000cf;font-weight:bold">755</span> <span style="color:#ce5c00;font-weight:bold">{}</span> +
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo cp /root/pgbackrest-release-1.27/bin/pgbackrest /usr/bin/pgbackrest
</span></span><span style="display:flex;"><span>sudo chmod <span style="color:#0000cf;font-weight:bold">755</span> /usr/bin/pgbackrest
</span></span><span style="display:flex;"><span>sudo mkdir -m <span style="color:#0000cf;font-weight:bold">770</span> /var/log/pgbackrest
</span></span><span style="display:flex;"><span>sudo chown postgres:postgres /var/log/pgbackrest
</span></span><span style="display:flex;"><span>sudo touch /etc/pgbackrest.conf
</span></span><span style="display:flex;"><span>sudo chmod <span style="color:#0000cf;font-weight:bold">640</span> /etc/pgbackrest.conf
</span></span><span style="display:flex;"><span>sudo chown postgres:postgres /etc/pgbackrest.conf
</span></span></code></pre></div><p>pgBackRest包含一个可选的伴随C库，可以增强性能并启用<code>checksum-page</code>选项和加密。预构建的软件包通常比手动构建C库更好，但为了完整性，下面给出了所需的步骤。根据分布情况，可能需要一些软件包，这里不一一列举。</p>
<ul>
<li>db-primary⇒构建并安装C库</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo sh -c <span style="color:#4e9a06">&#39;cd /root/pgbackrest-release-2.01/libc &amp;&amp; \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">       perl Makefile.PL INSTALLMAN1DIR=none INSTALLMAN3DIR=none&#39;</span>
</span></span><span style="display:flex;"><span>sudo make -C /root/pgbackrest-release-2.01/libc <span style="color:#204a87">test</span>
</span></span><span style="display:flex;"><span>sudo make -C /root/pgbackrest-release-2.01/libc install
</span></span></code></pre></div><p>现在pgBackRest应该正确安装了，但最好检查一下。如果任何依赖关系被遗漏，那么当你从命令行运行pgBackRest的时候你会得到一个错误。</p>
<ul>
<li>db-primary⇒确保安装正常</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo -u postgres pgbackrest
</span></span><span style="display:flex;"><span>pgBackRest 1.27 - General <span style="color:#204a87">help</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>    pgbackrest <span style="color:#ce5c00;font-weight:bold">[</span>options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>command<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Commands:
</span></span><span style="display:flex;"><span>    archive-get     Get a WAL segment from the archive.
</span></span><span style="display:flex;"><span>    archive-push    Push a WAL segment to the archive.
</span></span><span style="display:flex;"><span>    backup          Backup a database cluster.
</span></span><span style="display:flex;"><span>    check           Check the configuration.
</span></span><span style="display:flex;"><span>    expire          Expire backups that exceed retention.
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">help</span>            Get help.
</span></span><span style="display:flex;"><span>    info            Retrieve information about backups.
</span></span><span style="display:flex;"><span>    restore         Restore a database cluster.
</span></span><span style="display:flex;"><span>    stanza-create   Create the required stanza data.
</span></span><span style="display:flex;"><span>    stanza-upgrade  Upgrade a stanza.
</span></span><span style="display:flex;"><span>    start           Allow pgBackRest processes to run.
</span></span><span style="display:flex;"><span>    stop            Stop pgBackRest processes from running.
</span></span><span style="display:flex;"><span>    version         Get version.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Use <span style="color:#4e9a06">&#39;pgbackrest help [command]&#39;</span> <span style="color:#204a87;font-weight:bold">for</span> more information.
</span></span></code></pre></div><h3 id="mac-version">mac version</h3>
<p>在MacOS上安装可以按照之前的手动安装教程，参考文章：https://hunleyd.github.io/posts/pgBackRest-2.07-and-macOS-Mojave/</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意如果需要从终端访问代理，可以使用以下命令：</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">proxy</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;export all_proxy=socks5://127.0.0.1:1080&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">unproxy</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;unset all_proxy&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装 homebrew &amp; wget</span>
</span></span><span style="display:flex;"><span>/usr/bin/ruby -e <span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>brew install wget
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># install perl DB driver: Pg</span>
</span></span><span style="display:flex;"><span>perl -MCPAN -e <span style="color:#4e9a06">&#39;install Bundle::DBI&#39;</span>
</span></span><span style="display:flex;"><span>perl -MCPAN -e <span style="color:#4e9a06">&#39;install Bundle::DBD::Pg&#39;</span>
</span></span><span style="display:flex;"><span>perl -MCPAN -e <span style="color:#4e9a06">&#39;install IO::Socket::SSL&#39;</span>
</span></span><span style="display:flex;"><span>perl -MCPAN -e <span style="color:#4e9a06">&#39;install XML::LibXML&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Download and unzip</span>
</span></span><span style="display:flex;"><span>wget https://github.com/pgbackrest/pgbackrest/archive/release/2.07.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Copy to Perls lib</span>
</span></span><span style="display:flex;"><span>sudo cp -r  ~/Downloads/pgbackrest-release-1.27/lib/pgBackRest /Library/Perl/5.18
</span></span><span style="display:flex;"><span>sudo find /Library/Perl/5.18/pgBackRest -type f -exec chmod <span style="color:#0000cf;font-weight:bold">644</span> <span style="color:#ce5c00;font-weight:bold">{}</span> +
</span></span><span style="display:flex;"><span>sudo find /Library/Perl/5.18/pgBackRest -type d -exec chmod <span style="color:#0000cf;font-weight:bold">755</span> <span style="color:#ce5c00;font-weight:bold">{}</span> +
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Copy binary to your path</span>
</span></span><span style="display:flex;"><span>sudo cp ~/Downloads/pgbackrest-release-1.27/bin/pgbackrest /usr/local/bin/
</span></span><span style="display:flex;"><span>sudo chmod <span style="color:#0000cf;font-weight:bold">755</span> /usr/local/bin/pgbackrest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Make log dir &amp; conf file. maybe you will change vonng to postgres</span>
</span></span><span style="display:flex;"><span>sudo mkdir -m <span style="color:#0000cf;font-weight:bold">770</span> /var/log/pgbackrest <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo touch /etc/pgbackrest.conf
</span></span><span style="display:flex;"><span>sudo chmod <span style="color:#0000cf;font-weight:bold">640</span> /etc/pgbackrest.conf
</span></span><span style="display:flex;"><span>sudo chown vonng /etc/pgbackrest.conf /var/log/pgbackrest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Uninstall</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># sudo rm -rf /usr/local/bin/pgbackrest /Library/Perl/5.18/pgBackRest /var/log/pgbackrest /etc/pgbackrest.conf</span>
</span></span></code></pre></div><h2 id="4-快速入门">4. 快速入门</h2>
<h3 id="41-搭建测试数据库集群">4.1 搭建测试数据库集群</h3>
<p>创建示例群集是可选的，但强烈建议试一遍，尤其对于新用户，因为用户指南中的示例命令引用了示例群集。 示例假定演示群集正在默认端口（即5432）上运行。直到后面的部分才会启动群集，因为还有一些配置要做。</p>
<ul>
<li>db-primary⇒创建演示群集</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># create database cluster</span>
</span></span><span style="display:flex;"><span>pg_ctl init -D /var/lib/pgsql/data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># change listen address to *</span>
</span></span><span style="display:flex;"><span>sed -ie <span style="color:#4e9a06">&#34;s/^#listen_addresses = &#39;localhost&#39;/listen_addresses = &#39;*&#39;/g&#34;</span> /var/lib/pgsql/data/postgresql.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># change log prefix </span>
</span></span><span style="display:flex;"><span>sed -ie <span style="color:#4e9a06">&#34;s/^#log_line_prefix = &#39;%m [%p] &#39;/log_line_prefix = &#39;&#39;/g&#34;</span> /var/lib/pgsql/data/postgresql.conf
</span></span></code></pre></div><p>默认情况下PostgreSQL只接受本地连接。本示例需要来自其他服务器的连接，将listen_addresses配置为在所有端口上侦听。如果有安全性要求，这样做可能是不合适的。</p>
<p>出于演示目的，log_line_prefix设置将被最低限度地配置。这使日志输出尽可能简短，以更好地说明重要的信息。</p>
<h3 id="42-配置集群的备份单元stanza">4.2 配置集群的备份单元（Stanza）</h3>
<p>一个备份单元是指 一组关于PostgreSQL数据库集簇的配置，它定义了数据库的位置，如何备份，归档选项等。大多数数据库服务器只有一个Postgres数据库集簇，因此只有一个备份单元，而备份服务器则对每一个需要备份的数据库集簇都有一个备份单元。</p>
<p>在主群集之后命名该节是诱人的，但是更好的名称描述群集中包含的数据库。由于节名称将用于主节点名称和所有副本，因此选择描述群集实际功能（例如app或dw）的名称（而不是本地群集名称（如main或prod））会更合适。</p>
<p>“Demo”这个名字可以准确地描述这个数据库集簇的目的，所以这里就这么用了。</p>
<p><code>pgBackRest</code>需要知道PostgreSQL集簇的<strong>数据目录</strong>所在的位置。备份的时候PostgreSQL可以使用该目录，但恢复的时候PostgreSQL必须停机。备份期，提供给pgBackRest的值将与PostgreSQL运行的路径比较，如果它们不相等则备份将报错。确保<code>db-path</code>与<code>postgresql.conf</code>中的<code>data_directory</code>完全相同。</p>
<p>默认情况下，Debian / Ubuntu在/ var / lib / postgresql / [版本] / [集群]中存储集群，因此很容易确定数据目录的正确路径。</p>
<p>在创建<code>/etc/pgbackrest.conf</code>文件时，数据库所有者（通常是postgres）必须被授予读取权限。</p>
<ul>
<li>db-primary：<code>/etc/pgbackrest.conf</code>⇒配置PostgreSQL集群数据目录</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[demo]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">db-path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">/var/lib/pgsql/data</span>
</span></span></code></pre></div><p>pgBackRest配置文件遵循Windows INI约定。部分用括号中的文字表示，每个部分包含键/值对。以<code>#</code>开始的行被忽略，可以用作注释。</p>
<h3 id="43-创建存储库">4.3 创建存储库</h3>
<p>存储库是pgBackRest存储备份和归档WAL段的地方。</p>
<p>新备份很难提前估计需要多少空间。最好的办法是做一些备份，然后记录不同类型备份的大小（full / incr / diff），并测量每天产生的WAL数量。这将给你一个大致需要多少空间的概念。当然随着数据库的发展，需求可能会随着时间而变化。</p>
<p>对于这个演示，存储库将被存储在与PostgreSQL服务器相同的主机上。这是最简单的配置，在使用传统备份软件备份数据库主机的情况下非常有用。</p>
<ul>
<li>db-primary⇒创建pgBackRest存储库</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mkdir /var/lib/pgbackrest
</span></span><span style="display:flex;"><span>sudo chmod <span style="color:#0000cf;font-weight:bold">750</span> /var/lib/pgbackrest
</span></span><span style="display:flex;"><span>sudo chown postgres:postgres /var/lib/pgbackrest
</span></span></code></pre></div><p>存储库路径必须配置，以便pgBackRest知道在哪里找到它。</p>
<ul>
<li>db-primary：<code>/etc/pgbackrest.conf</code> ⇒配置pgBackRest存储库路径</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[demo]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">db-path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">/var/lib/postgresql/9.4/demo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[global]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">repo-path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">/var/lib/pgbackrest</span>
</span></span></code></pre></div><h3 id="44-配置归档">4.4 配置归档</h3>
<p>备份正在运行的PostgreSQL集群需要启用WAL归档。请注意，即使没有对群集进行明确写入，在备份过程中也会创建至少一个WAL段。</p>
<ul>
<li>db-primary：<code>/var/lib/pgsql/data/postgresql.conf</code>⇒ 配置存档设置</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">archive_command</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;pgbackrest --stanza=demo archive-push %p&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">archive_mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">on</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">listen_addresses</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;*&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">log_line_prefix</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">max_wal_senders</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">3</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">wal_level</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">hot_standby</span>
</span></span></code></pre></div><p>wal_level设置必须至少设置为<code>archive</code>，但<code>hot_standby</code>和<code>logical</code>也适用于备份。 在PostgreSQL 10中，相应的wal_level是<code>replica</code>。将wal_level设置为hot_standy并增加max_wal_senders是一个好主意，即使您当前没有运行热备用数据库也是一个好主意，因为这样可以在不重新启动主群集的情况下添加它们。在进行这些更改之后和执行备份之前，必须重新启动PostgreSQL群集。</p>
<h3 id="45-保留配置retention">4.5 保留配置（retention）</h3>
<p>pgBackRest会根据保留配置对备份进行过期处理。</p>
<ul>
<li>db-primary: <code>/etc/pgbackrest.conf</code>  ⇒ 配置为保留两个全量备份</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[demo]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">db-path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">/var/lib/postgresql/9.4/demo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[global]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">repo-path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">/var/lib/pgbackrest</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">retention-full</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">2</span>
</span></span></code></pre></div><p>更多关于保留的信息可以在<code>Retention</code>一节找到。</p>
<h3 id="46-配置存储库加密">4.6 配置存储库加密</h3>
<p>该节创建命令必须在仓库位于初始化节的主机上运行。建议的检查命令后运行节创建，确保归档和备份的配置是否正确。</p>
<ul>
<li>db-primary: <code>/etc/pgbackrest.conf</code>  ⇒ 配置pgBackRest存储库加密</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[demo]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">db-path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">/var/lib/postgresql/9.4/demo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[global]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">repo-cipher-pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">zWaf6XtpjIVZC5444yXB+cgFDFl7MxGlgkZSaoPvTGirhPygu4jOKOXf9LO4vjfO</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">repo-cipher-type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">aes-256-cbc</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">repo-path</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">/var/lib/pgbackrest</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">retention-full</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">2</span>
</span></span></code></pre></div><p>一旦存储库（repository）配置完成且备份单元创建并检查完毕，存储库加密设置便不能更改。</p>
<h3 id="47-创建存储单元">4.7 创建存储单元</h3>
<p><code>stanza-create</code>命令必须在仓库位于初始化节的主机上运行。建议在<code>stanza-create</code>命令之后运行<code>check</code>命令，确保归档和备份的配置是否正确。</p>
<ul>
<li>db-primary  ⇒ 创建存储单元并检查配置</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>postgres$ pgbackrest --stanza<span style="color:#ce5c00;font-weight:bold">=</span>demo --log-level-console<span style="color:#ce5c00;font-weight:bold">=</span>info stanza-create
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>P00   INFO: stanza-create <span style="color:#204a87">command</span> begin 1.27: --db1-path<span style="color:#ce5c00;font-weight:bold">=</span>/var/lib/postgresql/9.4/demo --log-level-console<span style="color:#ce5c00;font-weight:bold">=</span>info --no-log-timestamp --repo-cipher-pass<span style="color:#ce5c00;font-weight:bold">=</span> --repo-cipher-type<span style="color:#ce5c00;font-weight:bold">=</span>aes-256-cbc --repo-path<span style="color:#ce5c00;font-weight:bold">=</span>/var/lib/pgbackrest --stanza<span style="color:#ce5c00;font-weight:bold">=</span>demo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>P00   INFO: stanza-create <span style="color:#204a87">command</span> end: completed successfully
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1.</span> <span style="color:#000">Install</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">yum</span> <span style="color:#000">install</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">y</span> <span style="color:#000">pgbackrest</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">2.</span> <span style="color:#000">configuration</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">pgbackrest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">conf</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">vim</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">etc</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgbackrest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">conf</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">[</span><span style="color:#000">global</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cipher</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#204a87;font-weight:bold">pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">O8lotSfiXYSYomc9BQ0UzgM9PgXoyNo1t3c0UmiM7M26rOETVNawbsW7BYn</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">I9es</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cipher</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">aes</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cbc</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">backups</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">retention</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">full</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">retention</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">diff</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">retention</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">archive</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">start</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">fast</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">y</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">stop</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">auto</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">y</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">archive</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">copy</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">y</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">[</span><span style="color:#000">global</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">archive</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">archive</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">async</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">y</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">process</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#204a87">max</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">[</span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">process</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#204a87">max</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">postgresql</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">conf</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">vim</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">postgresql</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">conf</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">archive_command</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;/usr/bin/pgbackrest --stanza=test archive-push %p&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">3.</span> <span style="color:#000">Initial</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">chown</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">R</span> <span style="color:#000">postgres</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">postgres</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">backups</span><span style="color:#ce5c00;font-weight:bold">/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">u</span> <span style="color:#000">postgres</span> <span style="color:#000">pgbackrest</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">stanza</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">test</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#204a87">log</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">console</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">info</span> <span style="color:#000">stanza</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">create</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">38</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">21.082</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stanza</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">create</span> <span style="color:#000">command</span> <span style="color:#000">begin</span> <span style="color:#0000cf;font-weight:bold">1.27</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">db1</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#204a87">log</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">console</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">info</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cipher</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#204a87;font-weight:bold">pass</span><span style="color:#ce5c00;font-weight:bold">=&lt;</span><span style="color:#000">redacted</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cipher</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">aes</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cbc</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">backups</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">stanza</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">38</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">21.533</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stanza</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">create</span> <span style="color:#000">command</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">completed</span> <span style="color:#000">successfully</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">service</span> <span style="color:#000">postgresql</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">9.5</span> <span style="color:#000">reload</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">u</span> <span style="color:#000">postgres</span> <span style="color:#000">pgbackrest</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">stanza</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">test</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#204a87">log</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">console</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">info</span> <span style="color:#000">info</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">stanza</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">test</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">status</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">error</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">no</span> <span style="color:#000">valid</span> <span style="color:#000">backups</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>      <span style="color:#000">db</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">current</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">wal</span> <span style="color:#000">archive</span> <span style="color:#204a87">min</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87">max</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#0000cf;font-weight:bold">0000000500041</span><span style="color:#000">CFD000000BE</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">0000000500041</span><span style="color:#000">CFD000000BE</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">4.</span> <span style="color:#000">Backup</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">u</span> <span style="color:#000">postgres</span> <span style="color:#000">pgbackrest</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">stanza</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">test</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#204a87">log</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">console</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">info</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">full</span> <span style="color:#000">backup</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">57.329</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">command</span> <span style="color:#000">begin</span> <span style="color:#0000cf;font-weight:bold">1.27</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">archive</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">copy</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">db1</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#204a87">log</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">console</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">info</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">process</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#204a87">max</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">40</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cipher</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#204a87;font-weight:bold">pass</span><span style="color:#ce5c00;font-weight:bold">=&lt;</span><span style="color:#000">redacted</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cipher</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">aes</span><span style="color:#ce5c00;font-weight:bold">-</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">256</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cbc</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">backups</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">retention</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">archive</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">retention</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">diff</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">retention</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">full</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">stanza</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">test</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">start</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">fast</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">stop</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">auto</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">full</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">58.192</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">execute</span> <span style="color:#000">exclusive</span> <span style="color:#000">pg_start_backup</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">with</span> <span style="color:#000">label</span> <span style="color:#4e9a06">&#34;pgBackRest backup started at 2018-01-04 16:24:57&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">begins</span> <span style="color:#000">after</span> <span style="color:#000">the</span> <span style="color:#000">requested</span> <span style="color:#000">immediate</span> <span style="color:#000">checkpoint</span> <span style="color:#000">completes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">58.495</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">start</span> <span style="color:#000">archive</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0000000500041</span><span style="color:#000">CFD000000C0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lsn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">41</span><span style="color:#000">CFD</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">C0000060</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">04.863</span> <span style="color:#000">P34</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016471.83</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#000">ab17fdd9f70652a0de55fd0da5d2b6b1f48de490</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">04.923</span> <span style="color:#000">P35</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016471.82</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000">acba8d0eb70dcdc64199201ee3999743e747699</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05.208</span> <span style="color:#000">P37</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016471.80</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#0000cf;font-weight:bold">74e2</span><span style="color:#000">f876d8e7d68ab29624d53d33b0c6cb078382</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">06.973</span> <span style="color:#000">P30</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016471.87</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#000">b6d6884724178476ee24a9a1a812e8941d4da396</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09.434</span> <span style="color:#000">P24</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016471.92</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#000">c5e6232171e0a7cadc7fc57f459a7bc75c2955d8</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09.860</span> <span style="color:#000">P40</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016471.78</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#0000cf;font-weight:bold">95</span><span style="color:#000">d94b1bac488592677f7942b85ab5cc2a39bf62</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">10.708</span> <span style="color:#000">P33</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016471.84</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#0000cf;font-weight:bold">32e8</span><span style="color:#000">c83f9bdc5934552f54ee59841f1877b04f69</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">11.035</span> <span style="color:#000">P28</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016471.89</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#000">aa7bee244d2d2c49b56bc9b2e0b9bf36f2bcc227</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">11.239</span> <span style="color:#000">P17</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016471.99</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#0000cf;font-weight:bold">218</span><span style="color:#000">bcecf7da2230363926ca00d719011a6c27467</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">11.383</span> <span style="color:#000">P18</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016471.98</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#0000cf;font-weight:bold">38744</span><span style="color:#000">d27867017dfadb6b520b6c0034daca67481</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">07.782</span> <span style="color:#000">P32</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016471.184</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">852.7</span><span style="color:#000">MB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">98</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#0000cf;font-weight:bold">92990e159</span><span style="color:#000">b0436d5a6843d21b2d888b636e246cf</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">07.935</span> <span style="color:#000">P10</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016468.100</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">98</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#000">d9e0009447a5ef068ce214239f1c999cc5251462</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">10.212</span> <span style="color:#000">P35</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016476.3</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">569.6</span><span style="color:#000">MB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">98</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#000">d02e6efed6cea3005e1342d9d6a8e27afa5239d7</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">12.289</span> <span style="color:#000">P20</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016468.10</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">98</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">a99468cd18e9399ade9ddc446eb21f1c4a1f137</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">13.270</span> <span style="color:#000">P03</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016468.1</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">99</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#000">c0ddb80d5f1be83aa4557777ad05adb7cbc47e72</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">13.792</span> <span style="color:#000">P38</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016468</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">99</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#0000cf;font-weight:bold">767</span><span style="color:#000">a2e0d21063b92b9cebc735fbb0e3c7332218d</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">18.446</span> <span style="color:#000">P26</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016473.3</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">863.9</span><span style="color:#000">MB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">99</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#0000cf;font-weight:bold">87</span><span style="color:#000">ba54690ea418c2ddd1d488c56fa164ebda5042</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">23.551</span> <span style="color:#000">P13</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016475.7</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">895.4</span><span style="color:#000">MB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#000">a2693bfdc84940c82b7d77a13b752e33448bb008</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">23.648</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">full</span> <span style="color:#000">backup</span> <span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">341.5</span><span style="color:#000">GB</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">23.649</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">execute</span> <span style="color:#000">exclusive</span> <span style="color:#000">pg_stop_backup</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">and</span> <span style="color:#000">wait</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">all</span> <span style="color:#000">WAL</span> <span style="color:#000">segments</span> <span style="color:#000">to</span> <span style="color:#000">archive</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">37.774</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">stop</span> <span style="color:#000">archive</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0000000500041</span><span style="color:#000">CFD000000C0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lsn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">41</span><span style="color:#000">CFD</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">C0000168</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">39.648</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">new</span> <span style="color:#000">backup</span> <span style="color:#000">label</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">20180104</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">162457</span><span style="color:#000">F</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">41.004</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backup</span> <span style="color:#000">command</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">completed</span> <span style="color:#000">successfully</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">41.005</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">expire</span> <span style="color:#000">command</span> <span style="color:#000">begin</span> <span style="color:#0000cf;font-weight:bold">1.27</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#204a87">log</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">console</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">info</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cipher</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#204a87;font-weight:bold">pass</span><span style="color:#ce5c00;font-weight:bold">=&lt;</span><span style="color:#000">redacted</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cipher</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">aes</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cbc</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">backups</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">retention</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">archive</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">retention</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">diff</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">retention</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">full</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">stanza</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">41.028</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">full</span> <span style="color:#000">backup</span> <span style="color:#000">total</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">using</span> <span style="color:#000">oldest</span> <span style="color:#000">full</span> <span style="color:#000">backup</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000">archive</span> <span style="color:#000">retention</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">41.034</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">expire</span> <span style="color:#000">command</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">completed</span> <span style="color:#000">successfully</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">u</span> <span style="color:#000">postgres</span> <span style="color:#000">pgbackrest</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">stanza</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">test</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#204a87">log</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">console</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">info</span> <span style="color:#000">info</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">stanza</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">test</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">status</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">ok</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>      <span style="color:#000">db</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">current</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">wal</span> <span style="color:#000">archive</span> <span style="color:#204a87">min</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87">max</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#0000cf;font-weight:bold">0000000500041</span><span style="color:#000">CFD000000C0</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">0000000500041</span><span style="color:#000">CFD000000C0</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>          <span style="color:#000">full</span> <span style="color:#000">backup</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">20180104</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">162457</span><span style="color:#000">F</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000">timestamp</span> <span style="color:#000">start</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">stop</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">57</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">38</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000">wal</span> <span style="color:#000">start</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">stop</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0000000500041</span><span style="color:#000">CFD000000C0</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">0000000500041</span><span style="color:#000">CFD000000C0</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000">database</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">341.5</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">backup</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">341.5</span><span style="color:#000">GB</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000">repository</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">153.6</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">repository</span> <span style="color:#000">backup</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">153.6</span><span style="color:#000">GB</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">5.</span> <span style="color:#000">restore</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">vim</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">etc</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgbackrest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">conf</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">mkdir</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">chown</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">R</span> <span style="color:#000">postgres</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">postgres</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span><span style="color:#ce5c00;font-weight:bold">/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">chmod</span> <span style="color:#0000cf;font-weight:bold">0700</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span><span style="color:#ce5c00;font-weight:bold">/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">u</span> <span style="color:#000">postgres</span> <span style="color:#000">pgbackrest</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">stanza</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">test</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#204a87">log</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">console</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">info</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">delta</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">set</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">20180104</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">162457</span><span style="color:#000">F</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">time</span> <span style="color:#4e9a06">&#34;--target=2018-01-04 16:34:38&#34;</span> <span style="color:#000">restore</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">23.170</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">restore</span> <span style="color:#000">command</span> <span style="color:#000">begin</span> <span style="color:#0000cf;font-weight:bold">1.27</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">db1</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">delta</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#204a87">log</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">console</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">info</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">process</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#204a87">max</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">40</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cipher</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#204a87;font-weight:bold">pass</span><span style="color:#ce5c00;font-weight:bold">=&lt;</span><span style="color:#000">redacted</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cipher</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">aes</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cbc</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">backups</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">set</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">20180104</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">162457</span><span style="color:#000">F</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">stanza</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">test</span> <span style="color:#4e9a06">&#34;--target=2018-01-04 16:34:38&#34;</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">time</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">WARN</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">delta</span> <span style="color:#204a87;font-weight:bold">or</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">force</span> <span style="color:#000">specified</span> <span style="color:#000">but</span> <span style="color:#000">unable</span> <span style="color:#000">to</span> <span style="color:#000">find</span> <span style="color:#4e9a06">&#39;PG_VERSION&#39;</span> <span style="color:#204a87;font-weight:bold">or</span> <span style="color:#4e9a06">&#39;backup.manifest&#39;</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#4e9a06">&#39;/export/pgdata&#39;</span> <span style="color:#000">to</span> <span style="color:#000">confirm</span> <span style="color:#000">that</span> <span style="color:#000">this</span> <span style="color:#000">is</span> <span style="color:#000">a</span> <span style="color:#000">valid</span> <span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">PGDATA</span> <span style="color:#000">directory</span><span style="color:#ce5c00;font-weight:bold">.</span>  <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">delta</span> <span style="color:#204a87;font-weight:bold">and</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">force</span> <span style="color:#000">have</span> <span style="color:#000">been</span> <span style="color:#000">disabled</span> <span style="color:#204a87;font-weight:bold">and</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">an</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">y</span> <span style="color:#000">files</span> <span style="color:#000">exist</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">the</span> <span style="color:#000">destination</span> <span style="color:#000">directories</span> <span style="color:#000">the</span> <span style="color:#000">restore</span> <span style="color:#000">will</span> <span style="color:#000">be</span> <span style="color:#000">aborted</span><span style="color:#ce5c00;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">23.313</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">restore</span> <span style="color:#000">backup</span> <span style="color:#000">set</span> <span style="color:#0000cf;font-weight:bold">20180104</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">162457</span><span style="color:#000">F</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">23.935</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">remap</span> <span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">PGDATA</span> <span style="color:#000">directory</span> <span style="color:#000">to</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09.626</span> <span style="color:#000">P01</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">restore</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016476.2</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#000">be1145405b8bcfa57c3f1fd8d0a78eee3ed2df21</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09.627</span> <span style="color:#000">P04</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">restore</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016475.6</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#000">d2bc51d5b58dea3d14869244cd5a23345dbc4ffb</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09.627</span> <span style="color:#000">P27</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">restore</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016471.9</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#0000cf;font-weight:bold">94</span><span style="color:#000">cbf743143baffac0b1baf41e60d4ed99ab910f</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09.627</span> <span style="color:#000">P37</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">restore</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016471.80</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#0000cf;font-weight:bold">74e2</span><span style="color:#000">f876d8e7d68ab29624d53d33b0c6cb078382</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09.627</span> <span style="color:#000">P38</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">restore</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016471.8</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000">f0edd85543c9640d2c6cf73257165e621a6b295</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09.652</span> <span style="color:#000">P02</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">restore</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3072016476.1</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checksum</span> <span style="color:#0000cf;font-weight:bold">3e262262</span><span style="color:#000">b106bdc42c9fe17ebdf62bc4ab2e8166</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15.415</span> <span style="color:#000">P34</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">restore</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">13142</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000">B</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15.415</span> <span style="color:#000">P35</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">restore</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">13137</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000">B</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15.415</span> <span style="color:#000">P36</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">restore</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">13132</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000">B</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15.415</span> <span style="color:#000">P37</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">restore</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">13127</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000">B</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15.418</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">write</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">recovery</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">conf</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15.950</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">restore</span> <span style="color:#000">global</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pg_control</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">performed</span> <span style="color:#000">last</span> <span style="color:#000">to</span> <span style="color:#000">ensure</span> <span style="color:#000">aborted</span> <span style="color:#000">restores</span> <span style="color:#000">cannot</span> <span style="color:#000">be</span> <span style="color:#000">started</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">16.588</span> <span style="color:#000">P00</span>   <span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">restore</span> <span style="color:#000">command</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">completed</span> <span style="color:#000">successfully</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">vim</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">postgresql</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">conf</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5433</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">u</span> <span style="color:#000">postgres</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">usr</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">bin</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pg_ctl</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">D</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">export</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdata</span><span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">start</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">server</span> <span style="color:#000">starting</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">47.361</span> <span style="color:#000">CST</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">redirecting</span> <span style="color:#204a87">log</span> <span style="color:#000">output</span> <span style="color:#000">to</span> <span style="color:#000">logging</span> <span style="color:#000">collector</span> <span style="color:#000">process</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span> <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">47.361</span> <span style="color:#000">CST</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000">HINT</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">Future</span> <span style="color:#204a87">log</span> <span style="color:#000">output</span> <span style="color:#000">will</span> <span style="color:#000">appear</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">directory</span> <span style="color:#4e9a06">&#34;pg_log&#34;</span><span style="color:#ce5c00;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">u</span> <span style="color:#000">postgres</span> <span style="color:#000">psql</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">p5433</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">psql</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Type</span> <span style="color:#4e9a06">&#34;help&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">help</span><span style="color:#ce5c00;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#000">postgres</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># \q</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">6.</span> <span style="color:#000">archive_command</span> <span style="color:#204a87;font-weight:bold">and</span> <span style="color:#000">restore_command</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">on</span> <span style="color:#000">master</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">vim</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">postgresql</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">conf</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">archive_command</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;/usr/bin/pgbackrest --stanza=test archive-push %p&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">service</span> <span style="color:#000">postgresql</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">9.5</span> <span style="color:#000">reload</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">yum</span> <span style="color:#000">install</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">q</span> <span style="color:#000">nfs</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">utils</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">echo</span> <span style="color:#4e9a06">&#34;/var/backups 10.191.0.0/16(rw)&#34;</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">etc</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">exports</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">service</span> <span style="color:#000">nfs</span> <span style="color:#000">start</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">on</span> <span style="color:#000">slave</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">mount</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">o</span> <span style="color:#000">v3</span> <span style="color:#000">master_ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">backups</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">backups</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">vim</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">etc</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgbackrest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">conf</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">[</span><span style="color:#000">global</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cipher</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#204a87;font-weight:bold">pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">O8lotSfiXYSYomc9BQ0UzgM9PgXoyNo1t3c0UmiM7M26rOETVNawbsW7BYn</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">I9es</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cipher</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">aes</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cbc</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">backups</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">retention</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">full</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">retention</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">diff</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">retention</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">archive</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">start</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">fast</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">y</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">stop</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">auto</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">y</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">archive</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">copy</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">y</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">[</span><span style="color:#000">global</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">archive</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">archive</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">async</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">y</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">process</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#204a87">max</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">[</span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">=/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">process</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#204a87">max</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">$</span> <span style="color:#000">sudo</span> <span style="color:#000">vim</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">9.5</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">recovery</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">conf</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">restore_command</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;/usr/bin/pgbackrest --stanza=test archive-get </span><span style="color:#4e9a06">%f</span><span style="color:#4e9a06"> &#34;%p&#34;&#39;</span>
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-b6d04532810e3534f8f94be5a5d5f882">Pgbouncer快速上手</h1>
	<div class="lead">Pgbouncer是一个轻量级的数据库连接池，这里简单介绍Pgbouncer的配置、管理与使用。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-02-07" class="text-muted">2018年02月07日</time>
        
	</div>
	<p>Pgbouncer是一个轻量级的数据库连接池。</p>
<h3 id="概要">概要</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pgbouncer <span style="color:#ce5c00;font-weight:bold">[</span>-d<span style="color:#ce5c00;font-weight:bold">][</span>-R<span style="color:#ce5c00;font-weight:bold">][</span>-v<span style="color:#ce5c00;font-weight:bold">][</span>-u user<span style="color:#ce5c00;font-weight:bold">]</span> &lt;pgbouncer.ini&gt;
</span></span><span style="display:flex;"><span>pgbouncer -V<span style="color:#000;font-weight:bold">|</span>-h
</span></span></code></pre></div><h3 id="描述">描述</h3>
<p><strong>pgbouncer</strong> 是一个PostgreSQL连接池。 任何目标应用程序都可以连接到 <strong>pgbouncer</strong>， 就像它是PostgreSQL服务器一样，<strong>pgbouncer</strong> 将创建到实际服务器的连接， 或者它将重用其中一个现有的连接。</p>
<p><strong>pgbouncer</strong> 的目的是为了降低打开PostgreSQL新连接时的性能影响。</p>
<p>为了不影响连接池的事务语义，<strong>pgbouncer</strong> 在切换连接时，支持多种类型的池化：</p>
<ul>
<li>
<p><strong>会话连接池（Session pooling）</strong></p>
<p>最礼貌的方法。当客户端连接时，将在客户端保持连接的整个持续时间内分配一个服务器连接。 当客户端断开连接时，服务器连接将放回到连接池中。这是默认的方法。</p>
</li>
<li>
<p><strong>事务连接池（Transaction pooling）</strong></p>
<p>服务器连接只有在一个事务的期间内才指派给客户端。 当PgBouncer发觉事务结束的时候，服务器连接将会放回连接池中。</p>
</li>
<li>
<p><strong>语句连接池（Statement pooling）</strong></p>
<p>最激进的模式。在查询完成后，服务器连接将立即被放回连接池中。 该模式中不允许多语句事务，因为它们会中断。</p>
</li>
</ul>
<p><strong>pgbouncer</strong> 的管理界面由连接到特殊&rsquo;虚拟&rsquo;数据库 <strong>pgbouncer</strong> 时可用的一些新的 <code>SHOW</code> 命令组成。</p>
<h3 id="上手">上手</h3>
<p>基本设置和用法如下。</p>
<ol>
<li>
<p>创建一个pgbouncer.ini文件。<strong>pgbouncer(5)</strong> 的详细信息。简单例子</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[databases]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">template1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">host=127.0.0.1 port=5432 dbname=template1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[pgbouncer]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">listen_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">6543</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">listen_addr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">127.0.0.1</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">auth_type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">md5</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">auth_file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">users.txt</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">logfile</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">pgbouncer.log</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">pidfile</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">pgbouncer.pid</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">admin_users</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">someuser</span>
</span></span></code></pre></div></li>
<li>
<p>创建包含许可用户的 <code>users.txt</code> 文件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#4e9a06">&#34;someuser&#34;</span> <span style="color:#4e9a06">&#34;same_password_as_in_server&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>加载 <strong>pgbouncer</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pgbouncer -d pgbouncer.ini
</span></span></code></pre></div></li>
<li>
<p>你的应用程序（或 <strong>客户端psql</strong>）已经连接到 <strong>pgbouncer</strong> ，而不是直接连接到PostgreSQL服务器了吗：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> psql -p <span style="color:#0000cf;font-weight:bold">6543</span> -U someuser template1
</span></span></code></pre></div></li>
<li>
<p>通过连接到特殊管理数据库 <strong>pgbouncer</strong> 来管理 <strong>pgbouncer</strong>， 发出 <code>show help;</code> 开始</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ psql -p <span style="color:#0000cf;font-weight:bold">6543</span> -U someuser pgbouncer
</span></span><span style="display:flex;"><span><span style="color:#000">pgbouncer</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># show help;</span>
</span></span><span style="display:flex;"><span>NOTICE:  Console usage
</span></span><span style="display:flex;"><span>DETAIL:
</span></span><span style="display:flex;"><span>  SHOW <span style="color:#ce5c00;font-weight:bold">[</span>HELP<span style="color:#000;font-weight:bold">|</span>CONFIG<span style="color:#000;font-weight:bold">|</span>DATABASES<span style="color:#000;font-weight:bold">|</span>FDS<span style="color:#000;font-weight:bold">|</span>POOLS<span style="color:#000;font-weight:bold">|</span>CLIENTS<span style="color:#000;font-weight:bold">|</span>SERVERS<span style="color:#000;font-weight:bold">|</span>SOCKETS<span style="color:#000;font-weight:bold">|</span>LISTS<span style="color:#000;font-weight:bold">|</span>VERSION<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  SET <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> arg
</span></span><span style="display:flex;"><span>  RELOAD
</span></span><span style="display:flex;"><span>  PAUSE
</span></span><span style="display:flex;"><span>  SUSPEND
</span></span><span style="display:flex;"><span>  RESUME
</span></span><span style="display:flex;"><span>  SHUTDOWN
</span></span></code></pre></div></li>
<li>
<p>如果你修改了pgbouncer.ini文件，可以用下列命令重新加载：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">pgbouncer</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># RELOAD;</span>
</span></span></code></pre></div></li>
</ol>
<h3 id="命令行开关">命令行开关</h3>
<table>
<thead>
<tr>
<th>-d</th>
<th>在后台运行。没有它，进程将在前台运行。 注意：在Windows上不起作用，<strong>pgbouncer</strong> 需要作为服务运行。</th>
</tr>
</thead>
<tbody>
<tr>
<td>-R</td>
<td>进行在线重启。这意味着连接到正在运行的进程，从中加载打开的套接字， 然后使用它们。如果没有活动进程，请正常启动。 注意：只有在操作系统支持Unix套接字且 <code>unix_socket_dir</code> 在配置中未被禁用时才可用。在Windows机器上不起作用。 不使用TLS连接，它们被删除了。</td>
</tr>
<tr>
<td>-u user</td>
<td>启动时切换到给定的用户。</td>
</tr>
<tr>
<td>-v</td>
<td>增加详细度。可多次使用。</td>
</tr>
<tr>
<td>-q</td>
<td>安静 - 不要登出到stdout。请注意， 这不影响日志详细程度，只有该stdout不被使用。用于init.d脚本。</td>
</tr>
<tr>
<td>-V</td>
<td>显示版本。</td>
</tr>
<tr>
<td>-h</td>
<td>显示简短的帮助。</td>
</tr>
<tr>
<td>&ndash;regservice</td>
<td>Win32：注册pgbouncer作为Windows服务运行。 <strong>service_name</strong> 配置参数值用作要注册的名称。</td>
</tr>
<tr>
<td>&ndash;unregservice</td>
<td>Win32: 注销Windows服务。</td>
</tr>
</tbody>
</table>
<h3 id="管理控制台">管理控制台</h3>
<p>通过正常连接到数据库 <strong>pgbouncer</strong> 可以使用控制台</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ psql -p 6543 pgbouncer
</span></span></code></pre></div><p>只有在配置参数 <strong>admin_users</strong> 或 <strong>stats_users</strong> 中列出的用户才允许登录到控制台。 （除了 auth_mode=any 时，任何用户都可以作为stats_user登录。）</p>
<p>另外，如果通过Unix套接字登录，并且客户端具有与运行进程相同的Unix用户uid， 允许用户名 <strong>pgbouncer</strong> 不使用密码登录。</p>
<h3 id="show命令">SHOW命令</h3>
<h4 id="show-stats"><code>SHOW STATS;</code></h4>
<p>显示统计信息。</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>database</code></td>
<td>统计信息按数据库组织</td>
</tr>
<tr>
<td><code>total_xact_count</code></td>
<td>SQL事务总数</td>
</tr>
<tr>
<td><code>total_query_count</code></td>
<td>SQL查询总数</td>
</tr>
<tr>
<td><code>total_received</code></td>
<td>收到的网络流量(字节)</td>
</tr>
<tr>
<td><code>total_sent</code></td>
<td>发送的网络流量(字节)</td>
</tr>
<tr>
<td><code>total_xact_time</code></td>
<td>在事务中的总时长</td>
</tr>
<tr>
<td><code>total_query_time</code></td>
<td>在查询中的总时长</td>
</tr>
<tr>
<td><code>total_wait_time</code></td>
<td>在等待中的总时长</td>
</tr>
<tr>
<td><code>avg_xact_count</code></td>
<td>（当前）平均事务数</td>
</tr>
<tr>
<td><code>avg_query_count</code></td>
<td>（当前）平均查询数</td>
</tr>
<tr>
<td><code>avg_recv</code></td>
<td>（当前）平均每秒收到字节数</td>
</tr>
<tr>
<td><code>avg_sent</code></td>
<td>（当前）平均每秒发送字节数</td>
</tr>
<tr>
<td><code>avg_xact_time</code></td>
<td>平均事务时长（以毫秒计）</td>
</tr>
<tr>
<td><code>avg_query_time</code></td>
<td>平均查询时长（以毫秒计）</td>
</tr>
<tr>
<td><code>avg_wait_time</code></td>
<td>平均等待时长（以毫秒计）</td>
</tr>
</tbody>
</table>
<p>两个变体：<code>SHOW STATS_TOTALS</code>与<code>SHOW STATS_AVERAGES</code>，分别显示整体与平均的统计。</p>
<p>TOTAL实际上是Counter，而AVG通常是Guage。监控时建议采集TOTAL，查看时建议查看AVG。</p>
<h4 id="show-servers"><code>SHOW SERVERS</code></h4>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>type</code></td>
<td>Server的类型固定为S</td>
</tr>
<tr>
<td><code>user</code></td>
<td>Pgbouncer用于连接数据库的用户名</td>
</tr>
<tr>
<td><code>state</code></td>
<td>pgbouncer服务器连接的状态，<strong>active</strong>、<strong>used</strong> 或 <strong>idle</strong> 之一。</td>
</tr>
<tr>
<td><code>addr</code></td>
<td>PostgreSQL server服务器的IP地址。</td>
</tr>
<tr>
<td><code>port</code></td>
<td>PostgreSQL服务器的端口。</td>
</tr>
<tr>
<td><code>local_addr</code></td>
<td>本机连接启动的地址。</td>
</tr>
<tr>
<td><code>local_port</code></td>
<td>本机上的连接启动端口。</td>
</tr>
<tr>
<td><code>connect_time</code></td>
<td>建立连接的时间。</td>
</tr>
<tr>
<td><code>request_time</code></td>
<td>最后一个请求发出的时间。</td>
</tr>
<tr>
<td><code>ptr</code></td>
<td>该连接内部对象的地址，用作唯一标识符</td>
</tr>
<tr>
<td><code>link</code></td>
<td>服务器配对的客户端连接地址。</td>
</tr>
<tr>
<td><code>remote_pid</code></td>
<td>后端服务器进程的pid。如果通过unix套接字进行连接， 并且OS支持获取进程ID信息，则为OS pid。 否则它将从服务器发送的取消数据包中提取出来，如果服务器是Postgres， 则应该是PID，但是如果服务器是另一个PgBouncer，则它是一个随机数。</td>
</tr>
</tbody>
</table>
<h4 id="show-clients"><code>SHOW CLIENTS</code></h4>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>type</code></td>
<td>Client的类型固定为C</td>
</tr>
<tr>
<td><code>user</code></td>
<td>客户端用于连接的用户</td>
</tr>
<tr>
<td><code>state</code></td>
<td>pgbouncer客户端连接的状态，<strong>active</strong>、<strong>used</strong> 、<strong>waiting</strong>或 <strong>idle</strong> 之一。</td>
</tr>
<tr>
<td><code>addr</code></td>
<td>客户端的IP地址。</td>
</tr>
<tr>
<td><code>port</code></td>
<td>客户端的端口</td>
</tr>
<tr>
<td><code>local_addr</code></td>
<td>本机地址</td>
</tr>
<tr>
<td><code>local_port</code></td>
<td>本机端口</td>
</tr>
<tr>
<td><code>connect_time</code></td>
<td>建立连接的时间。</td>
</tr>
<tr>
<td><code>request_time</code></td>
<td>最后一个请求发出的时间。</td>
</tr>
<tr>
<td><code>ptr</code></td>
<td>该连接内部对象的地址，用作唯一标识符</td>
</tr>
<tr>
<td><code>link</code></td>
<td>配对的服务器端连接地址。</td>
</tr>
<tr>
<td><code>remote_pid</code></td>
<td>如果通过unix套接字进行连接， 并且OS支持获取进程ID信息，则为OS pid。</td>
</tr>
</tbody>
</table>
<h4 id="show-clients-1"><code>SHOW CLIENTS</code></h4>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>type</code></td>
<td>Client的类型固定为C</td>
</tr>
<tr>
<td><code>user</code></td>
<td>客户端用于连接的用户</td>
</tr>
<tr>
<td><code>state</code></td>
<td>pgbouncer客户端连接的状态，<strong>active</strong>、<strong>used</strong> 、<strong>waiting</strong>或 <strong>idle</strong> 之一。</td>
</tr>
<tr>
<td><code>addr</code></td>
<td>客户端的IP地址。</td>
</tr>
<tr>
<td><code>port</code></td>
<td>客户端的端口</td>
</tr>
<tr>
<td><code>local_addr</code></td>
<td>本机地址</td>
</tr>
<tr>
<td><code>local_port</code></td>
<td>本机端口</td>
</tr>
<tr>
<td><code>connect_time</code></td>
<td>建立连接的时间。</td>
</tr>
<tr>
<td><code>request_time</code></td>
<td>最后一个请求发出的时间。</td>
</tr>
<tr>
<td><code>ptr</code></td>
<td>该连接内部对象的地址，用作唯一标识符</td>
</tr>
<tr>
<td><code>link</code></td>
<td>配对的服务器端连接地址。</td>
</tr>
<tr>
<td><code>remote_pid</code></td>
<td>如果通过unix套接字进行连接， 并且OS支持获取进程ID信息，则为OS pid。</td>
</tr>
</tbody>
</table>
<h4 id="show-pools">SHOW POOLS;</h4>
<p>为每对(database, user)创建一个新的连接池选项。</p>
<ul>
<li>
<p>database</p>
<p>数据库名称。</p>
</li>
<li>
<p>user</p>
<p>用户名。</p>
</li>
<li>
<p>cl_active</p>
<p>链接到服务器连接并可以处理查询的客户端连接。</p>
</li>
<li>
<p>cl_waiting</p>
<p>已发送查询但尚未获得服务器连接的客户端连接。</p>
</li>
<li>
<p>sv_active</p>
<p>链接到客户端的服务器连接。</p>
</li>
<li>
<p>sv_idle</p>
<p>未使用且可立即用于客户机查询的服务器连接。</p>
</li>
<li>
<p>sv_used</p>
<p>已经闲置超过 server_check_delay 时长的服务器连接， 所以在它可以使用之前，需要运行 server_check_query。</p>
</li>
<li>
<p>sv_tested</p>
<p>当前正在运行 server_reset_query 或 server_check_query 的服务器连接。</p>
</li>
<li>
<p>sv_login</p>
<p>当前正在登录过程中的服务器连接。</p>
</li>
<li>
<p>maxwait</p>
<p>队列中第一个（最老的）客户端已经等待了多长时间，以秒计。 如果它开始增加，那么服务器当前的连接池处理请求的速度不够快。 原因可能是服务器负载过重或 <strong>pool_size</strong> 设置过小。</p>
</li>
<li>
<p>pool_mode</p>
<p>正在使用的连接池模式。</p>
</li>
</ul>
<h4 id="show-lists">SHOW LISTS;</h4>
<p>在列（不是行）中显示以下内部信息：</p>
<ul>
<li>
<p>databases</p>
<p>数据库计数。</p>
</li>
<li>
<p>users</p>
<p>用户计数。</p>
</li>
<li>
<p>pools</p>
<p>连接池计数。</p>
</li>
<li>
<p>free_clients</p>
<p>空闲客户端计数。</p>
</li>
<li>
<p>used_clients</p>
<p>使用了的客户端计数。</p>
</li>
<li>
<p>login_clients</p>
<p>在 <strong>login</strong> 状态中的客户端计数。</p>
</li>
<li>
<p>free_servers</p>
<p>空闲服务器计数。</p>
</li>
<li>
<p>used_servers</p>
<p>使用了的服务器计数。</p>
</li>
</ul>
<h4 id="show-users">SHOW USERS;</h4>
<ul>
<li>
<p>name</p>
<p>用户名</p>
</li>
<li>
<p>pool_mode</p>
<p>用户重写的pool_mode，如果使用默认值，则返回NULL。</p>
</li>
</ul>
<h4 id="show-databases">SHOW DATABASES;</h4>
<ul>
<li>
<p>name</p>
<p>配置的数据库项的名称。</p>
</li>
<li>
<p>host</p>
<p>pgbouncer连接到的主机。</p>
</li>
<li>
<p>port</p>
<p>pgbouncer连接到的端口。</p>
</li>
<li>
<p>database</p>
<p>pgbouncer连接到的实际数据库名称。</p>
</li>
<li>
<p>force_user</p>
<p>当用户是连接字符串的一部分时，pgbouncer和PostgreSQL 之间的连接被强制给给定的用户，不管客户端用户是谁。</p>
</li>
<li>
<p>pool_size</p>
<p>服务器连接的最大数量。</p>
</li>
<li>
<p>pool_mode</p>
<p>数据库的重写pool_mode，如果使用默认值则返回NULL。</p>
</li>
</ul>
<h4 id="show-fds">SHOW FDS;</h4>
<p>内部命令 - 显示与附带的内部状态一起使用的fds列表。</p>
<p>当连接的用户使用用户名&quot;pgbouncer&quot;时， 通过Unix套接字连接并具有与运行过程相同的UID，实际的fds通过连接传递。 该机制用于进行在线重启。 注意：这不适用于Windows机器。</p>
<p>此命令还会阻止内部事件循环，因此在使用PgBouncer时不应该使用它。</p>
<ul>
<li>
<p>fd</p>
<p>文件描述符数值。</p>
</li>
<li>
<p>task</p>
<p><strong>pooler</strong>、<strong>client</strong> 或 <strong>server</strong> 之一。</p>
</li>
<li>
<p>user</p>
<p>使用该FD的连接的用户。</p>
</li>
<li>
<p>database</p>
<p>使用该FD的连接的数据库。</p>
</li>
<li>
<p>addr</p>
<p>使用FD的连接的IP地址，如果使用unix套接字则是 <strong>unix</strong>。</p>
</li>
<li>
<p>port</p>
<p>使用FD的连接的端口。</p>
</li>
<li>
<p>cancel</p>
<p>取消此连接的键。</p>
</li>
<li>
<p>link</p>
<p>对应服务器/客户端的fd。如果空闲则为NULL。</p>
</li>
</ul>
<h4 id="show-config">SHOW CONFIG;</h4>
<p>显示当前的配置设置，一行一个，带有下列字段：</p>
<ul>
<li>
<p>key</p>
<p>配置变量名</p>
</li>
<li>
<p>value</p>
<p>配置值</p>
</li>
<li>
<p>changeable</p>
<p><strong>yes</strong> 或者 <strong>no</strong>，显示运行时变量是否可更改。 如果是 <strong>no</strong>，则该变量只能在启动时改变。</p>
</li>
</ul>
<h4 id="show-dns_hosts">SHOW DNS_HOSTS;</h4>
<p>显示DNS缓存中的主机名。</p>
<ul>
<li>
<p>hostname</p>
<p>主机名。</p>
</li>
<li>
<p>ttl</p>
<p>直到下一次查找经过了多少秒。</p>
</li>
<li>
<p>addrs</p>
<p>地址的逗号分隔的列表。</p>
</li>
</ul>
<h4 id="show-dns_zones">SHOW DNS_ZONES</h4>
<p>显示缓存中的DNS区域。</p>
<ul>
<li>
<p>zonename</p>
<p>区域名称。</p>
</li>
<li>
<p>serial</p>
<p>当前序列号。</p>
</li>
<li>
<p>count</p>
<p>属于此区域的主机名。</p>
</li>
</ul>
<h3 id="过程控制命令">过程控制命令</h3>
<h4 id="pause-db"><code>PAUSE [db];</code></h4>
<p>PgBouncer尝试断开所有服务器的连接，首先等待所有查询完成。 所有查询完成之前，命令不会返回。在数据库重新启动时使用。如果提供了数据库名称，那么只有该数据库将被暂停。</p>
<h4 id="disable-db"><code>DISABLE db;</code></h4>
<p>拒绝给定数据库上的所有新客户端连接。</p>
<h4 id="enable-db"><code>ENABLE db;</code></h4>
<p>在上一个的 <strong>DISABLE</strong> 命令之后允许新的客户端连接。</p>
<h4 id="kill-db"><code>KILL db;</code></h4>
<p>立即删除给定数据库上的所有客户端和服务器连接。</p>
<h4 id="suspend"><code>SUSPEND;</code></h4>
<p>所有套接字缓冲区被刷新，PgBouncer停止监听它们上的数据。 在所有缓冲区为空之前，命令不会返回。在PgBouncer在线重新启动时使用。</p>
<h4 id="resume-db"><code>RESUME [db];</code></h4>
<p>从之前的 <strong>PAUSE</strong> 或 <strong>SUSPEND</strong> 命令中恢复工作。</p>
<h4 id="shutdown"><code>SHUTDOWN;</code></h4>
<p>PgBouncer进程将会退出。</p>
<h4 id="reload"><code>RELOAD;</code></h4>
<p>PgBouncer进程将重新加载它的配置文件并更新可改变的设置。</p>
<h3 id="信号">信号</h3>
<ul>
<li>
<p>SIGHUP</p>
<p>重新加载配置。与在控制台上发出命令 <strong>RELOAD;</strong> 相同。</p>
</li>
<li>
<p>SIGINT</p>
<p>安全关闭。与在控制台上发出 <strong>PAUSE;</strong> 和 <strong>SHUTDOWN;</strong> 相同。</p>
</li>
<li>
<p>SIGTERM</p>
<p>立即关闭。与在控制台上发出 <strong>SHUTDOWN;</strong> 相同。</p>
</li>
</ul>
<h3 id="libevent设置">Libevent设置</h3>
<p>来自libevent的文档:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>可以通过分别设置环境变量EVENT_NOEPOLL、EVENT_NOKQUEUE、
</span></span><span style="display:flex;"><span>VENT_NODEVPOLL、EVENT_NOPOLL或EVENT_NOSELECT来禁用对
</span></span><span style="display:flex;"><span>epoll、kqueue、devpoll、poll或select的支持。
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>通过设置环境变量EVENT_SHOW_METHOD，libevent显示它使用的内核通知方法。 
</span></span></code></pre></div><h1 id="pgbouncer参数配置">Pgbouncer参数配置</h1>
<h2 id="heading"></h2>
<h2 id="默认配置">默认配置</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; 数据库名 = 连接串</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; 连接串包括这些参数:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;   dbname= host= port= user= password=</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;   client_encoding= datestyle= timezone=</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;   pool_size= connect_query=</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;   auth_user=</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[databases]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">instanceA</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">host=10.1.1.1 dbname=core</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">instanceB</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">host=102.2.2.2 dbname=payment</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 通过Unix套接字的 foodb</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;foodb =</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 将bardb在localhost上重定向为bazdb </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;bardb = host=localhost dbname=bazdb</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 使用单个用户访问目标数据库</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;forcedb = host=127.0.0.1 port=300 user=baz password=foo client_encoding=UNICODE datestyle=ISO connect_query=&#39;SELECT 1&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 使用定制的连接池大小</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;nondefaultdb = pool_size=50 reserve_pool=10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 如果用户不在认证文件中，替换使用的auth_user; auth_user必须在认证文件中</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; foodb = auth_user=bar</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 保底的通配连接串</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;* = host=testserver</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Pgbouncer配置区域</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[pgbouncer]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;; 管理设置</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">logfile</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">/var/log/pgbouncer/pgbouncer.log</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">pidfile</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">/var/run/pgbouncer/pgbouncer.pid</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;; 监听哪里的客户端</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 监听IP地址，* 代表所有IP</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">listen_addr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">*</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">listen_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">6432</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; -R选项也会处理Unix Socket.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 在Debian上是 /var/run/postgresql</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;unix_socket_dir = /tmp</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;unix_socket_mode = 0777</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;unix_socket_group =</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;; TLS配置</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; 选项：disable, allow, require, verify-ca, verify-full</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;client_tls_sslmode = disable</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; 信任CA证书的路径</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;client_tls_ca_file = &lt;system default&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; 代表客户端的私钥与证书路径</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; 从客户端接受TLS连接时，这是必须参数</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;client_tls_key_file =</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;client_tls_cert_file =</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; fast, normal, secure, legacy, &lt;ciphersuite string&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;client_tls_ciphers = fast</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; all, secure, tlsv1.0, tlsv1.1, tlsv1.2</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;client_tls_protocols = all</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; none, auto, legacy</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;client_tls_dheparams = auto</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; none, auto, &lt;curve name&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;client_tls_ecdhcurve = auto</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;; 连接到后端数据库时的TLS设置</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; disable, allow, require, verify-ca, verify-full</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;server_tls_sslmode = disable</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; 信任CA证书的路径</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;server_tls_ca_file = &lt;system default&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; 代表后端的私钥与证书</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; 只有当后端服务器需要客户端证书时需要</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;server_tls_key_file =</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;server_tls_cert_file =</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; all, secure, tlsv1.0, tlsv1.1, tlsv1.2</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;server_tls_protocols = all</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; fast, normal, secure, legacy, &lt;ciphersuite string&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;server_tls_ciphers = fast</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;; 认证设置</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; any, trust, plain, crypt, md5, cert, hba, pam</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">auth_type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">trust</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">auth_file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">/etc/pgbouncer/userlist.txt</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; HBA风格的认证配置文件</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># auth_hba_file = /pg/data/pg_hba.conf</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; 从数据库获取密码的查询，结果必须包含两列： 用户名 与 密码哈希值.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;; 允许访问虚拟数据库&#39;pgbouncer&#39;的用户</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 允许修改设置，逗号分隔的用户名列表。</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">admin_users</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">postgres</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 允许使用SHOW命令，逗号分隔的用户名列表。</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">stats_users</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">stats, postgres</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;; 连接池设置</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 什么时候服务端连接会被放回到池中？(默认为session)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;   session      - 会话模式，当客户端断开连接时</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;   transaction  - 事务模式，当事务结束时</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;   statement    - 语句模式，当语句结束时</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">pool_mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">session</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 客户端释放连接后，用于立刻清理连接的查询。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 不用把ROLLBACK放在这儿，当事务还没结束时，Pgbouncer是不会重用连接的。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 8.3及更高版本的查询:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;   DISCARD ALL;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 更老的版本:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;   RESET ALL; SET SESSION AUTHORIZATION DEFAULT</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 如果启用事务级别的连接池，则为空。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">server_reset_query</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">DISCARD ALL</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; server_reset_query 是否需要在任何情况下执行。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 如果关闭(默认)，server_reset_query 只会在会话级连接池中使用。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;server_reset_query_always = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; Comma-separated list of parameters to ignore when given</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; in startup packet.  Newer JDBC versions require the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; extra_float_digits here.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;ignore_startup_parameters = extra_float_digits</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; When taking idle server into use, this query is ran first.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;   SELECT 1</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;server_check_query = select 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; If server was used more recently that this many seconds ago,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; skip the check query.  Value 0 may or may not run in immediately.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;server_check_delay = 30</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; Close servers in session pooling mode after a RECONNECT, RELOAD,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; etc. when they are idle instead of at the end of the session.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;server_fast_close = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Use &lt;appname - host&gt; as application_name on server.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;application_name_add_host = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;; 连接限制</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 最大允许的连接数</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">max_client_conn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 默认的连接池尺寸，当使用事务连接池时，20是一个合适的值。对于会话级连接池而言</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 该值是你想在同一时刻处理的最大连接数。</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">default_pool_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">20</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; 连接池中最少的保留连接数</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;min_pool_size = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 出现问题时，最多允许多少条额外连接</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;reserve_pool_size = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 如果客户端等待超过这么多秒，使用备用连接池</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;reserve_pool_timeout = 5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; 单个数据库/用户最多允许多少条连接</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;max_db_connections = 0</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;max_user_connections = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; If off, then server connections are reused in LIFO manner</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;server_round_robin = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;; Logging</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Syslog settings</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;syslog = 0</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;syslog_facility = daemon</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;syslog_ident = pgbouncer</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; log if client connects or server connection is made</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;log_connections = 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; log if and why connection was closed</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;log_disconnections = 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; log error messages pooler sends to clients</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;log_pooler_errors = 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Period for writing aggregated stats into log.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;stats_period = 60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Logging verbosity.  Same as -v switch on command line.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;verbose = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;; Timeouts</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Close server connection if its been connected longer.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;server_lifetime = 3600</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Close server connection if its not been used in this time.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Allows to clean unnecessary connections from pool after peak.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;server_idle_timeout = 600</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Cancel connection attempt if server does not answer takes longer.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;server_connect_timeout = 15</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; If server login failed (server_connect_timeout or auth failure)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; then wait this many second.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;server_login_retry = 15</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Dangerous.  Server connection is closed if query does not return</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; in this time.  Should be used to survive network problems,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; _not_ as statement_timeout. (default: 0)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;query_timeout = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Dangerous.  Client connection is closed if the query is not assigned</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; to a server in this time.  Should be used to limit the number of queued</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; queries in case of a database or network failure. (default: 120)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;query_wait_timeout = 120</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Dangerous.  Client connection is closed if no activity in this time.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Should be used to survive network problems. (default: 0)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;client_idle_timeout = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Disconnect clients who have not managed to log in after connecting</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; in this many seconds.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;client_login_timeout = 60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Clean automatically created database entries (via &#34;*&#34;) if they</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; stay unused in this many seconds.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">; autodb_idle_timeout = 3600</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; How long SUSPEND/-R waits for buffer flush before closing connection.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;suspend_timeout = 10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Close connections which are in &#34;IDLE in transaction&#34; state longer than</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; this many seconds.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;idle_transaction_timeout = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;; Low-level tuning options</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; buffer for streaming packets</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;pkt_buf = 4096</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; man 2 listen</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;listen_backlog = 128</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Max number pkt_buf to process in one event loop.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;sbuf_loopcnt = 5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Maximum PostgreSQL protocol packet size.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;max_packet_size = 2147483647</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; networking options, for info: man 7 tcp</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Linux: notify program about new connection only if there</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; is also data received.  (Seconds to wait.)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; On Linux the default is 45, on other OS&#39;es 0.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;tcp_defer_accept = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; In-kernel buffer size (Linux default: 4096)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;tcp_socket_buffer = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; whether tcp keepalive should be turned on (0/1)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;tcp_keepalive = 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; The following options are Linux-specific.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; They also require tcp_keepalive=1.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; count of keepalive packets</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;tcp_keepcnt = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; how long the connection can be idle,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; before sending keepalive packets</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;tcp_keepidle = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; The time between individual keepalive probes.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;tcp_keepintvl = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; DNS lookup caching time</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;dns_max_ttl = 15</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; DNS zone SOA lookup period</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;dns_zone_check_period = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; DNS negative result caching time</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;dns_nxdomain_ttl = 15</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;; Random stuff</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Hackish security feature.  Helps against SQL-injection - when PQexec is disabled,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; multi-statement cannot be made.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;disable_pqexec = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Config file to use for next RELOAD/SIGHUP.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; By default contains config file from command line.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;conffile</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Win32 service name to register as.  job_name is alias for service_name,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; used by some Skytools scripts.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;service_name = pgbouncer</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;job_name = pgbouncer</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;; Read additional config from the /etc/pgbouncer/pgbouncer-other.ini file</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;%include /etc/pgbouncer/pgbouncer-other.ini</span>
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-a7a6b0d44cfe3a5444b59d6bd20d9679">PG服务器日志常规配置</h1>
	<div class="lead">建议配置PostgreSQL的日志格式为CSV，方便分析，而且可以直接导入PostgreSQL数据表中。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-02-06" class="text-muted">2018年02月06日</time>
        
	</div>
	<p>建议配置PostgreSQL的日志格式为CSV，方便分析，而且可以直接导入PostgreSQL数据表中。</p>
<h2 id="日志相关配置项">日志相关配置项</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">log_destination</span> <span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;csvlog&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">logging_collector</span> <span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">on</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">log_directory</span> <span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;log&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">log_filename</span> <span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;postgresql-%a.log&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">log_min_duration_statement</span> <span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">1000</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">log_checkpoints</span> <span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">on</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">log_lock_waits</span> <span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">on</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">log_statement</span> <span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;ddl&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">log_replication_commands</span> <span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">on</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">log_timezone</span> <span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;UTC&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">log_autovacuum_min_duration</span> <span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">track_io_timing</span> <span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">on</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">track_functions</span> <span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">all</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">track_activity_query_size</span> <span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">16384</span>
</span></span></code></pre></div><h2 id="日志收集">日志收集</h2>
<p>如果需要从外部收集日志，可以考虑使用filebeat。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">filebeat.prospectors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">## input</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">log</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">paths</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">/var/lib/postgresql/data/pg_log/postgresql-*.csv</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">document_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">db-trace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">tail_files</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">multiline.pattern</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;^20\d\d-\d\d-\d\d&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">multiline.negate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">multiline.match</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">after</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">multiline.max_lines</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">max_cpus</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">## modules</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">filebeat.config.modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${path.config}/modules.d/*.yml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">reload.enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">## queue</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">queue.mem</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">events</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">flush.min_events</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">flush.timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">## output</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">output.kafka</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;10.10.10.10:9092&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;x.x.x.x:9092&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">topics</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">topic</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;log.db&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="csv日志格式">CSV日志格式</h2>
<p>很有趣的想法，将CSV日志弄成PostgreSQL表，对于分析而言非常方便。</p>
<p>原始的csv日志格式定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#a40000">日志表的结构定义</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgresql_log</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">log_time</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#204a87;font-weight:bold">timestamp</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">user_name</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">database_name</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">process_id</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">connection_from</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">session_id</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87">text</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">session_line_num</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87">bigint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">command_tag</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">session_start_time</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:bold">timestamp</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">with</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">time</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">zone</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">virtual_transaction_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">transaction_id</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">error_severity</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">sql_state_code</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">message</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">detail</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">hint</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">internal_query</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">internal_query_pos</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">context</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">query</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">query_pos</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">location</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">application_name</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">session_line_num</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="导入日志">导入日志</h2>
<p>日志是结构良好的CSV，（CSV允许跨行记录），直接使用COPY命令导入即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">COPY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgresql_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/var/lib/pgsql/data/pg_log/postgresql.log&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CSV</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DELIMITER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;,&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="映射日志">映射日志</h2>
<p>当然，除了把日志直接拷贝到数据表里分析，还有一种办法，可以让PostgreSQL直接将自己的本地CSVLOG映射为一张外部表。以SQL的方式直接进行访问。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SCHEMA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- search path for su
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">search_path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">search_path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- extension
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">file_fdw</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SCHEMA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- log parent table: empty
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_log</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">log_time</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#204a87;font-weight:bold">timestamp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">with</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">time</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">zone</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">user_name</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">database_name</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">process_id</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">connection_from</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">session_id</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">session_line_num</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">command_tag</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">session_start_time</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:bold">timestamp</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">with</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">time</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">zone</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">virtual_transaction_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">transaction_id</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">error_severity</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">sql_state_code</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">message</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">detail</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">hint</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">internal_query</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">internal_query_pos</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">context</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">query</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">query_pos</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">location</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">application_name</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">session_line_num</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;PostgreSQL csv log schema&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- local file server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SERVER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOREIGN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DATA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">WRAPPER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">file_fdw</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Change filename to actual path
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOREIGN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_log_mon</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INHERITS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_log</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SERVER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OPTIONS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/pg/data/log/postgresql-Mon.csv&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">format</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;csv&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOREIGN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_log_tue</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INHERITS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_log</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SERVER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OPTIONS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/pg/data/log/postgresql-Tue.csv&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">format</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;csv&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOREIGN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_log_wed</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INHERITS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_log</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SERVER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OPTIONS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/pg/data/log/postgresql-Wed.csv&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">format</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;csv&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOREIGN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_log_thu</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INHERITS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_log</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SERVER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OPTIONS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/pg/data/log/postgresql-Thu.csv&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">format</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;csv&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOREIGN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_log_fri</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INHERITS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_log</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SERVER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OPTIONS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/pg/data/log/postgresql-Fri.csv&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">format</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;csv&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOREIGN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_log_sat</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INHERITS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_log</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SERVER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OPTIONS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/pg/data/log/postgresql-Sat.csv&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">format</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;csv&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOREIGN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_log_sun</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INHERITS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_log</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SERVER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OPTIONS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/pg/data/log/postgresql-Sun.csv&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">format</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;csv&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="加工日志">加工日志</h2>
<p>可以使用以下存储过程从日志消息中进一步提取语句的执行时间</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">extract_duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">found_duration</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BOOLEAN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">position</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;duration&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">found_duration</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">found_duration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">regexp_matches</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">regexp_matches</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;duration: (.*) ms&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">plpgsql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">IMMUTABLE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">extract_statement</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">found_statement</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BOOLEAN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">position</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;statement&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">found_statement</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">found_statement</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">regexp_matches</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">regexp_matches</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;statement: (.*)&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">plpgsql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">IMMUTABLE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">extract_ip</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">app_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">ip</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">regexp_matches</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ip</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">regexp_matches</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">app_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;(\d+\.\d+\.\d+\.\d+)&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ip</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">plpgsql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">IMMUTABLE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-658e59408d0a1041bc6bc51e59b3cf4a">空中换引擎 —— PostgreSQL不停机迁移数据</h1>
	<div class="lead">通常涉及到数据迁移，常规操作都是停服务更新。不停机迁移数据是相对比较高级的操作。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-02-06" class="text-muted">2018年02月06日</time>
        
	</div>
	<p>通常涉及到数据迁移，常规操作都是停服务更新。不停机迁移数据是相对比较高级的操作。</p>
<p>不停机数据迁移在本质上，可以视作由三个操作组成：</p>
<ul>
<li>复制：将目标表从源库<strong>逻辑复制</strong>到宿库。</li>
<li>改读：将应用<strong>读取路径</strong>由源库迁移到宿库上。</li>
<li>改写：将应用<strong>写入路径</strong>由源库迁移到宿库上。</li>
</ul>
<p>但在实际执行中，这三个步骤可能会有不一样的表现形式。</p>
<h2 id="逻辑复制">逻辑复制</h2>
<p>使用逻辑复制是比较稳妥的做法，也有几种不同的做法：应用层逻辑复制，数据库自带的逻辑复制（PostgreSQL 10 之后的逻辑订阅），使用第三方逻辑复制插件（例如pglogical）。</p>
<p>几种逻辑复制的方法各有优劣，我们采用了应用层逻辑复制的方式。具体包括四个步骤：</p>
<h4 id="一复制">一、复制</h4>
<ul>
<li>在新库中fork老库目标表的模式，以及所有依赖的函数、序列、权限、属主等对象。</li>
<li>应用添加双写逻辑，同时向新库与老库中写入同样数据。
<ul>
<li>同时向新库与老库写入</li>
</ul>
</li>
<li>保证增量数据正确写入两个一样的库中。</li>
<li>应用需要正确处理全量数据不存在下的删改逻辑。例如改<code>UPDATE</code>为<code>UPSERT</code>，忽略<code>DELETE</code>。</li>
<li>应用读取仍然走老库。</li>
<li>出现问题时，回滚应用至原来的单写版本。</li>
</ul>
<p>二、同步</p>
<ul>
<li>老表加上表级排它锁 <code>LOCK TABLE &lt;xxx&gt; IN EXCLUSIVE MODE</code>，阻塞所有写入。</li>
<li>执行全量同步 <code>pg_dump | psql</code></li>
<li>校验数据一致性，判断迁移是否成功。</li>
<li>出现问题时，简单清空新库中的对应表。</li>
</ul>
<ol>
<li>改读
<ul>
<li>应用修改为从新库中读取数据。</li>
<li>出现问题时，回滚至从老库中读取的版本。</li>
</ul>
</li>
<li>单写
<ul>
<li>观察一段时间无误后，应用修改为仅写入新库。</li>
<li>出现问题时，回滚至双写版本。</li>
</ul>
</li>
</ol>
<h3 id="说明">说明</h3>
<p>关键在<strong>于阻塞全量同步期间对老表的写入</strong>。这可以通过表级排它锁实现。</p>
<p>在对表进行了分片的情况下，锁表对业务造成的影响非常小。</p>
<p>一张逻辑表拆分成8192个分区，实际上一次只需要处理一个分区。</p>
<p>阻塞对八千分之一的数据写入约几秒到十几秒，业务上通常是可以接受的。</p>
<p>但如果是单张非常大的表，也许就需要特殊处理了。</p>
<h2 id="etl函数">ETL函数</h2>
<p>以下Bash函数接受三个参数，源库URL，宿库URL，以及待迁移的表名。</p>
<p>假设是源宿库都可连接，且目标表都存在。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> etl<span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">local</span> <span style="color:#000">src_url</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">1</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">local</span> <span style="color:#000">dst_url</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">2</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">local</span> <span style="color:#000">table_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">3</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    rm -rf <span style="color:#4e9a06">&#34;/tmp/etl-</span><span style="color:#4e9a06">${</span><span style="color:#000">table_name</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">.done&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    psql <span style="color:#4e9a06">${</span><span style="color:#000">src_url</span><span style="color:#4e9a06">}</span> -1qAtc <span style="color:#4e9a06">&#34;LOCK TABLE </span><span style="color:#4e9a06">${</span><span style="color:#000">table_name</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> IN EXCLUSIVE MODE;COPY </span><span style="color:#4e9a06">${</span><span style="color:#000">table_name</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> TO STDOUT;&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    <span style="color:#000;font-weight:bold">|</span> psql <span style="color:#4e9a06">${</span><span style="color:#000">dst_url</span><span style="color:#4e9a06">}</span> -1qAtc <span style="color:#4e9a06">&#34;LOCK TABLE </span><span style="color:#4e9a06">${</span><span style="color:#000">table_name</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> IN EXCLUSIVE MODE; TRUNCATE </span><span style="color:#4e9a06">${</span><span style="color:#000">table_name</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">; COPY </span><span style="color:#4e9a06">${</span><span style="color:#000">table_name</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> FROM STDIN;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    touch <span style="color:#4e9a06">&#34;/tmp/etl-</span><span style="color:#4e9a06">${</span><span style="color:#000">table_name</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">.done&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>实际上虽然锁定了源表与宿表，但在实际测试中，管道退出时前后两个psql进程退出的timing并不是完全同步的。管道前面的进程比后面一个进程早了0.1秒退出。在负载很大的情况下，可能会产生数据不一致。</p>
<p>另一种更科学的做法是按照某一唯一约束列进行切分，锁定相应的行，更新后释放</p>
<h2 id="物理复制">物理复制</h2>
<p>物理复制是通过回放WAL日志实现的复制，是数据库集簇层面的复制。</p>
<p>基于物理复制的迁移粒度很粗，仅适用于垂直分裂库时使用，会有极短暂的服务不可用。</p>
<p>使用物理复制进行数据迁移的流程如下：</p>
<ul>
<li>复制，从主库拖出一台从库，保持流式复制。</li>
<li>改读：将应用读取路径从主库改为从库，但写入仍然写入主库。
<ul>
<li>如果有问题，将应用回滚至读主库版本。</li>
</ul>
</li>
<li>改写：将从库提升为主库，阻塞老库的写入，并立即重启应用，切换写入路径至新主库上。
<ul>
<li>将不需要的表和库删除。</li>
<li>这一步无法回滚（回滚会损失写入新库的数据）</li>
</ul>
</li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-285a7bdf0f6caca3e5d7f97af974ac6e">使用FIO测试磁盘性能</h1>
	<div class="lead">FIO可以很方便地测试磁盘IO性能</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-02-06" class="text-muted">2018年02月06日</time>
        
	</div>
	<p>Fio是一个很好用的磁盘性能测试工具，可以通过以下命令测试磁盘的读写性能。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>fio --filename<span style="color:#ce5c00;font-weight:bold">=</span>/tmp/fio.data <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -direct<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -iodepth<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">32</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -rw<span style="color:#ce5c00;font-weight:bold">=</span>randrw <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --rwmixread<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">80</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -bs<span style="color:#ce5c00;font-weight:bold">=</span>4k <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -size<span style="color:#ce5c00;font-weight:bold">=</span>1G <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -numjobs<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">16</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -runtime<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -group_reporting <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    -name<span style="color:#ce5c00;font-weight:bold">=</span>randrw <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --output<span style="color:#ce5c00;font-weight:bold">=</span>/tmp/fio_randomrw.txt <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> unlink /tmp/fio.data
</span></span></code></pre></div><p>下面是常用的测试组合，确保 <code>/data/</code> 挂载了数据盘</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>--8k  随机写
</span></span><span style="display:flex;"><span>fio -name<span style="color:#ce5c00;font-weight:bold">=</span>8krandw  -runtime<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">120</span>  -filename<span style="color:#ce5c00;font-weight:bold">=</span>/data/rand.txt -ioengine<span style="color:#ce5c00;font-weight:bold">=</span>libaio -direct<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>  -bs<span style="color:#ce5c00;font-weight:bold">=</span>8K  -size<span style="color:#ce5c00;font-weight:bold">=</span>10g  -iodepth<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">128</span>  -numjobs<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>  -rw<span style="color:#ce5c00;font-weight:bold">=</span>randwrite -group_reporting -time_based
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>--8K  随机读
</span></span><span style="display:flex;"><span>fio -name<span style="color:#ce5c00;font-weight:bold">=</span>8krandr  -runtime<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">120</span>  -filename<span style="color:#ce5c00;font-weight:bold">=</span>/data/rand.txt -ioengine<span style="color:#ce5c00;font-weight:bold">=</span>libaio -direct<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>  -bs<span style="color:#ce5c00;font-weight:bold">=</span>8K  -size<span style="color:#ce5c00;font-weight:bold">=</span>10g  -iodepth<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">128</span>  -numjobs<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>  -rw<span style="color:#ce5c00;font-weight:bold">=</span>randread -group_reporting -time_based
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>--8k  混合读写
</span></span><span style="display:flex;"><span>fio -name<span style="color:#ce5c00;font-weight:bold">=</span>8krandrw  -runtime<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">120</span>  -filename<span style="color:#ce5c00;font-weight:bold">=</span>/data/rand.txt -ioengine<span style="color:#ce5c00;font-weight:bold">=</span>libaio -direct<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>  -bs<span style="color:#ce5c00;font-weight:bold">=</span>8k  -size<span style="color:#ce5c00;font-weight:bold">=</span>10g  -iodepth<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">128</span>  -numjobs<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>  -rw<span style="color:#ce5c00;font-weight:bold">=</span>randrw -rwmixwrite<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">30</span>  -group_reporting -time_based
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>--1Mb  顺序写
</span></span><span style="display:flex;"><span>fio -name<span style="color:#ce5c00;font-weight:bold">=</span>1mseqw  -runtime<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">120</span>  -filename<span style="color:#ce5c00;font-weight:bold">=</span>/data/seq.txt -ioengine<span style="color:#ce5c00;font-weight:bold">=</span>libaio -direct<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>  -bs<span style="color:#ce5c00;font-weight:bold">=</span>1024k  -size<span style="color:#ce5c00;font-weight:bold">=</span>20g  -iodepth<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">128</span>  -numjobs<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>  -rw<span style="color:#ce5c00;font-weight:bold">=</span>write -group_reporting -time_based
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>--1Mb  顺序读
</span></span><span style="display:flex;"><span>fio -name<span style="color:#ce5c00;font-weight:bold">=</span>1mseqr  -runtime<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">120</span>  -filename<span style="color:#ce5c00;font-weight:bold">=</span>/data/seq.txt -ioengine<span style="color:#ce5c00;font-weight:bold">=</span>libaio -direct<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>  -bs<span style="color:#ce5c00;font-weight:bold">=</span>1024k  -size<span style="color:#ce5c00;font-weight:bold">=</span>20g  -iodepth<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">128</span>  -numjobs<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>  -rw<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">read</span> -group_reporting -time_based
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>--1Mb  顺序读写
</span></span><span style="display:flex;"><span>fio -name<span style="color:#ce5c00;font-weight:bold">=</span>1mseqrw  -runtime<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">120</span>  -filename<span style="color:#ce5c00;font-weight:bold">=</span>/data/seq.txt -ioengine<span style="color:#ce5c00;font-weight:bold">=</span>libaio -direct<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>  -bs<span style="color:#ce5c00;font-weight:bold">=</span>1024k  -size<span style="color:#ce5c00;font-weight:bold">=</span>20g  -iodepth<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">128</span>  -numjobs<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>  -rw<span style="color:#ce5c00;font-weight:bold">=</span>rw -rwmixwrite<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">30</span>  -group_reporting -time_based
</span></span></code></pre></div><p>测试 PostgreSQL 相关的 IO 性能表现时，应当主要以 8KB 随机IO为主，可以考虑以下参数组合。</p>
<p>3个维度：RW Ratio, Block Size, N Jobs 进行排列组合</p>
<ul>
<li>RW Ratio:  Pure Read, Pure Write, rwmixwrite=80, rwmixwrite=20</li>
<li>Block Size = 4KB (OS granular), 8KB (DB granular)</li>
<li>N jobs: 1 , 4 , 8 , 16 ,32</li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c7d8616451a6fb6791bf0707b1e9f97e">使用sysbench测试PostgreSQL性能</h1>
	<div class="lead">尽管PostgreSQL提供了pgbench，但有时候为了吊打一下MySQL，还是需要用到sysbench的。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-02-06" class="text-muted">2018年02月06日</time>
        
	</div>
	<p>sysbench首页：https://github.com/akopytov/sysbench</p>
<hr>
<h2 id="安装">安装</h2>
<p>二进制安装，在Mac上，使用brew安装sysbench。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>brew install sysbench --with-postgresql
</span></span></code></pre></div><p>源代码编译（CentOS）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum -y install make automake libtool pkgconfig libaio-devel
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For MySQL support, replace with mysql-devel on RHEL/CentOS 5</span>
</span></span><span style="display:flex;"><span>yum -y install mariadb-devel openssl-devel
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For PostgreSQL support</span>
</span></span><span style="display:flex;"><span>yum -y install postgresql-devel
</span></span></code></pre></div><p>源代码编译</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>brew install automake libtool openssl pkg-config
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For MySQL support</span>
</span></span><span style="display:flex;"><span>brew install mysql
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For PostgreSQL support</span>
</span></span><span style="display:flex;"><span>brew install postgresql
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># openssl is not linked by Homebrew, this is to avoid &#34;ld: library not found for -lssl&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">LDFLAGS</span><span style="color:#ce5c00;font-weight:bold">=</span>-L/usr/local/opt/openssl/lib 
</span></span></code></pre></div><p>编译：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./autogen.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># --with-pgsql --with-pgsql-libs --with-pgsql-includes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -- without-mysql</span>
</span></span><span style="display:flex;"><span>./configure 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>make -j
</span></span><span style="display:flex;"><span>make install
</span></span></code></pre></div><hr>
<h2 id="准备">准备</h2>
<p>创建一个压测用PostgreSQL数据库：<code>bench</code>，初始化测试用数据库：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sysbench /usr/local/share/sysbench/oltp_read_write.lua <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--db-driver<span style="color:#ce5c00;font-weight:bold">=</span>pgsql <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--pgsql-host<span style="color:#ce5c00;font-weight:bold">=</span>127.0.0.1 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--pgsql-port<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">5432</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--pgsql-user<span style="color:#ce5c00;font-weight:bold">=</span>vonng <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--pgsql-db<span style="color:#ce5c00;font-weight:bold">=</span>bench <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--table_size<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">100000</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--tables<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	prepare
</span></span></code></pre></div><p>输出：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Creating table &#39;sbtest1&#39;...
</span></span><span style="display:flex;"><span>Inserting 100000 records into &#39;sbtest1&#39;
</span></span><span style="display:flex;"><span>Creating a secondary index on &#39;sbtest1&#39;...
</span></span><span style="display:flex;"><span>Creating table &#39;sbtest2&#39;...
</span></span><span style="display:flex;"><span>Inserting 100000 records into &#39;sbtest2&#39;
</span></span><span style="display:flex;"><span>Creating a secondary index on &#39;sbtest2&#39;...
</span></span><span style="display:flex;"><span>Creating table &#39;sbtest3&#39;...
</span></span><span style="display:flex;"><span>Inserting 100000 records into &#39;sbtest3&#39;
</span></span><span style="display:flex;"><span>Creating a secondary index on &#39;sbtest3&#39;...
</span></span></code></pre></div><hr>
<h2 id="压测">压测</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sysbench /usr/local/share/sysbench/oltp_read_write.lua <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--db-driver<span style="color:#ce5c00;font-weight:bold">=</span>pgsql <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--pgsql-host<span style="color:#ce5c00;font-weight:bold">=</span>127.0.0.1 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--pgsql-port<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">5432</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--pgsql-user<span style="color:#ce5c00;font-weight:bold">=</span>vonng <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--pgsql-db<span style="color:#ce5c00;font-weight:bold">=</span>bench <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--table_size<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">100000</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --tables<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --threads<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --time<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">12</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    run
</span></span></code></pre></div><p>输出</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sysbench 1.1.0-e6e6a02 (using bundled LuaJIT 2.1.0-beta3)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Running the test with following options:
</span></span><span style="display:flex;"><span>Number of threads: 4
</span></span><span style="display:flex;"><span>Initializing random number generator from current time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Initializing worker threads...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Threads started!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SQL statistics:
</span></span><span style="display:flex;"><span>    queries performed:
</span></span><span style="display:flex;"><span>        read:                            127862
</span></span><span style="display:flex;"><span>        write:                           36526
</span></span><span style="display:flex;"><span>        other:                           18268
</span></span><span style="display:flex;"><span>        total:                           182656
</span></span><span style="display:flex;"><span>    transactions:                        9131   (760.56 per sec.)
</span></span><span style="display:flex;"><span>    queries:                             182656 (15214.20 per sec.)
</span></span><span style="display:flex;"><span>    ignored errors:                      2      (0.17 per sec.)
</span></span><span style="display:flex;"><span>    reconnects:                          0      (0.00 per sec.)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Throughput:
</span></span><span style="display:flex;"><span>    events/s (eps):                      760.5600
</span></span><span style="display:flex;"><span>    time elapsed:                        12.0056s
</span></span><span style="display:flex;"><span>    total number of events:              9131
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Latency (ms):
</span></span><span style="display:flex;"><span>         min:                                    4.30
</span></span><span style="display:flex;"><span>         avg:                                    5.26
</span></span><span style="display:flex;"><span>         max:                                   15.20
</span></span><span style="display:flex;"><span>         95th percentile:                        5.99
</span></span><span style="display:flex;"><span>         sum:                                47995.39
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Threads fairness:
</span></span><span style="display:flex;"><span>    events (avg/stddev):           2282.7500/4.02
</span></span><span style="display:flex;"><span>    execution time (avg/stddev):   11.9988/0.00
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-791abe3b50df5a93fb86b9af6c65497b">找出没用过的索引</h1>
	<div class="lead">索引很有用， 但不是免费的。没用到的索引是一种浪费，使用这里的方法找出未使用的索引</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-02-04" class="text-muted">2018年02月04日</time>
        
	</div>
	<p>索引很有用， 但不是免费的。没用到的索引是一种浪费，使用以下SQL找出未使用的索引：</p>
<ul>
<li>首先要排除用于实现约束的索引（删不得）</li>
<li>表达式索引（<code>pg_index.indkey</code>中含有0号字段）</li>
<li>然后找出走索引扫描的次数为0的索引（也可以换个更宽松的条件，比如扫描小于1000次的）</li>
</ul>
<hr>
<h2 id="找出没有使用的索引">找出没有使用的索引</h2>
<ul>
<li>视图名称：<code>monitor.v_bloat_indexes</code></li>
<li>计算时长：1秒，适合每天检查/手工检查，不适合频繁拉取。</li>
<li>验证版本：9.3 ~ 10</li>
<li>功能：显示当前数据库索引膨胀情况。</li>
</ul>
<p>在版本9.3与10.4上工作良好。视图形式</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- CREATE SCHEMA IF NOT EXISTS monitor;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- DROP VIEW IF EXISTS monitor.pg_stat_dummy_indexes;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_stat_dummy_indexes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schemaname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indexname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_size</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_stat_user_indexes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">idx_scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">-- has never been scanned
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span><span style="color:#204a87;font-weight:bold">ALL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indkey</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- no index column is an expression
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic">-- does not enforce a constraint
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_constraint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">conindid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_stat_dummy_indexes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor unused indexes&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 人类可读的手工查询
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schemaname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indexname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_size</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_stat_user_indexes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">idx_scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">-- has never been scanned
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span><span style="color:#204a87;font-weight:bold">ALL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indkey</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- no index column is an expression
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic">-- does not enforce a constraint
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_constraint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">conindid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h3 id="批量生成删除索引的命令">批量生成删除索引的命令</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;DROP INDEX CONCURRENTLY IF EXISTS &#34;&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schemaname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#34;.&#34;&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#34;;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_stat_user_indexes</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">idx_scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">-- has never been scanned
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span><span style="color:#204a87;font-weight:bold">ALL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indkey</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- no index column is an expression
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic">-- does not enforce a constraint
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_constraint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">conindid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_relation_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="找出重复的索引">找出重复的索引</h2>
<p>检查是否有索引工作在相同的表的相同列上，但要注意条件索引。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">indrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">regclass</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">array_agg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">regclass</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indexes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_index</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">indrelid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">indkey</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">HAVING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COUNT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-7ed8fc70d90ab400d2077b51b8877f91">批量配置SSH免密登录</h1>
	<div class="lead">快速配置所有机器的免密登陆</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-01-07" class="text-muted">2018年01月07日</time>
        
	</div>
	<p>配置SSH是运维工作的基础，有时候还是要老生常谈一下。</p>
<hr>
<h2 id="生成公私钥对">生成公私钥对</h2>
<p>理想的情况是全部通过公私钥认证，从本地免密码直接连接所有数据库机器。最好不要使用密码认证。</p>
<p>首先，使用<code>ssh-keygen</code>生成公私钥对</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh-keygen -t rsa
</span></span></code></pre></div><p>注意权限问题，ssh内文件的权限应当设置为<code>0600</code>，<code>.ssh</code>目录的权限应当设置为<code>0700</code>，设置失当会导致免密登录无法使用。</p>
<hr>
<h2 id="配置ssh-config穿透跳板机">配置ssh config穿透跳板机</h2>
<p>把<code>User</code>换成自己的名字。放入<code>.ssh/config</code>，这里给出了有跳板机环境下配置生产网数据库免密直连的方式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Vonng&#39;s ssh config</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># SpringBoard IP</span>
</span></span><span style="display:flex;"><span>Host &lt;BastionIP&gt;
</span></span><span style="display:flex;"><span>	Hostname &lt;your_ip_address&gt;
</span></span><span style="display:flex;"><span>	IdentityFile ~/.ssh/id_rsa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Target Machine Wildcard (Proxy via Bastion)</span>
</span></span><span style="display:flex;"><span>Host 10.xxx.xxx.*
</span></span><span style="display:flex;"><span>	ProxyCommand ssh &lt;BastionIP&gt; <span style="color:#204a87">exec</span> nc %h %p 2&gt;/dev/null
</span></span><span style="display:flex;"><span>	IdentityFile ~/.ssh/id_rsa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Common Settings</span>
</span></span><span style="display:flex;"><span>Host *
</span></span><span style="display:flex;"><span>	User xxxxxxxxxxxxxx
</span></span><span style="display:flex;"><span>	PreferredAuthentications publickey,password
</span></span><span style="display:flex;"><span>	Compression yes
</span></span><span style="display:flex;"><span>	ServerAliveInterval <span style="color:#0000cf;font-weight:bold">30</span>
</span></span><span style="display:flex;"><span>	ControlMaster auto
</span></span><span style="display:flex;"><span>	ControlPath ~/.ssh/ssh-%r@%h:%p
</span></span><span style="display:flex;"><span>	ControlPersist yes
</span></span><span style="display:flex;"><span>	StrictHostKeyChecking no
</span></span></code></pre></div><hr>
<h2 id="将公钥拷贝到目标机器上">将公钥拷贝到目标机器上</h2>
<p>然后将公钥拷贝到跳板机，DBA工作机，所有数据库机器上。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh-copy-id &lt;target_ip&gt;
</span></span></code></pre></div><p>每次执行此命令都会要求输入密码，非常繁琐无聊，可以通过expect 脚本进行自动化，或者使用<code>sshpass</code></p>
<hr>
<h2 id="使用expect自动化">使用expect自动化</h2>
<p>将下列脚本中的<code>&lt;your password&gt;</code>替换为你自己的密码。如果服务器IP列表有变化，修改列表即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/expect
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>foreach id <span style="color:#ce5c00;font-weight:bold">{</span> 
</span></span><span style="display:flex;"><span>     10.xxx.xxx.xxx
</span></span><span style="display:flex;"><span>     10.xxx.xxx.xxx
</span></span><span style="display:flex;"><span>     10.xxx.xxx.xxx
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    spawn ssh-copy-id <span style="color:#000">$id</span>
</span></span><span style="display:flex;"><span>    expect <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    	<span style="color:#4e9a06">&#34;*(yes/no)?*&#34;</span>
</span></span><span style="display:flex;"><span>    	<span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            send <span style="color:#4e9a06">&#34;yes\n&#34;</span>
</span></span><span style="display:flex;"><span>            expect <span style="color:#4e9a06">&#34;*assword:&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span> send <span style="color:#4e9a06">&#34;&lt;your password&gt;\n&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    	<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>     	<span style="color:#4e9a06">&#34;*assword*&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span> send <span style="color:#4e9a06">&#34;&lt;your password&gt;\n&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">exit</span>
</span></span></code></pre></div><hr>
<h2 id="更优雅的解决方案-sshpass">更优雅的解决方案: <code>sshpass</code></h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sshpass -i &lt;your password&gt; ssh-copy-id &lt;target address&gt;
</span></span></code></pre></div><p>当然缺点是，密码很有可能出现在bash历史记录中，执行完请及时清理痕迹。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-73b1e01472e6d2d977cbd40600e2f91b">Wireshark抓包分析协议</h1>
	<div class="lead">Wireshark是一个很有用的工具，特别适合用来分析网络协议，这里简单介绍使用Wireshark抓包分析PostgreSQL协议的方法。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-01-05" class="text-muted">2018年01月05日</time>
        
	</div>
	<p>Wireshark是一个很有用的工具，特别适合用来分析网络协议。</p>
<p>这里简单介绍使用Wireshark抓包分析PostgreSQL协议的方法。</p>
<p>假设调试本地PostgreSQL实例：127.0.0.1:5432</p>
<h2 id="快速开始">快速开始</h2>
<ol>
<li>下载并安装Wireshark：<a href="https://www.wireshark.org/download.html">下载地址</a></li>
<li>选择要抓包的网卡，如果是本地测试选择<code>lo0</code>即可。</li>
<li>添加抓包过滤器，如果PostgreSQL使用默认设置，使用<code>port 5432</code>即可。</li>
<li>开始抓包</li>
<li>添加显示过滤器<code>pgsql</code>，这样就可以滤除无关的TCP协议报文。</li>
<li>然后就可以执行一些操作，观察并分析协议了</li>
</ol>
<p><img src="/img/blog/pg/wireshark-capture.png"></p>
<hr>
<h2 id="抓包样例">抓包样例</h2>
<p>我们先从最简单的case开始，不使用认证，也不使用SSL，执行以下命令建立一条到PostgreSQL的连接。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres://localhost:5432/postgres?sslmode<span style="color:#ce5c00;font-weight:bold">=</span>disable -c <span style="color:#4e9a06">&#39;SELECT 1 AS a, 2 AS b;&#39;</span>
</span></span></code></pre></div><p>注意这里<code>sslmode=disable</code>是不能省略的，不然客户端会默认尝试发送SSL请求。<code>localhost</code>也是不能省略的，不然客户端会默认尝试使用unix socket。</p>
<p>这条Bash命令实际上在PostgreSQL对应着三个协议阶段与5组协议报文</p>
<ul>
<li>启动阶段：客户端建立一条到PostgreSQL服务器的连接。</li>
<li>简单查询协议：客户端发送查询命令，服务器回送查询结果。</li>
<li>终止：客户端中断连接。</li>
</ul>
<p><img src="/img/blog/pg/wireshark-capture-sample.png"></p>
<p>Wireshark内建了对PGSQL的解码，允许我们方便地查看PostgreSQL协议报文的内容。</p>
<p>启动阶段，客户端向服务端发送了一条<code>StartupMessage (F)</code>，而服务端回送了一系列消息，包括<code>AuthenticationOK(R)</code>， <code>ParameterStatus(S)</code>, <code>BackendKeyData(K)</code> , <code>ReadyForQuery(Z)</code>。这里这几条消息都打包在同一个TCP报文中发送给客户端。</p>
<p>简单查询阶段，客户端发送了一条<code>Query (F)</code>消息，将SQL语句<code>SELECT 1 AS a, 2 AS b;</code>直接作为内容发送给服务器。服务器依次返回了<code>RowDescription(T)</code>,<code>DataRow(D)</code>,<code>CommandComplete(C)</code>,<code>ReadyForQuery(Z)</code>.</p>
<p>终止阶段，客户端发送了一条<code>Terminate(X)</code>消息，终止连接。</p>
<hr>
<h2 id="题外话使用mac进行无线网络嗅探">题外话：使用Mac进行无线网络嗅探</h2>
<p>结论： Mac: airport, tcpdump Windows: Omnipeek Linux: tcpdump, airmon-ng</p>
<p>以太网里抓包很简单，各种软件一大把，什么Wireshark，Ethereal，Sniffer Pro 一抓一大把。不过如果是无线数据包，就要稍微麻烦一点了。网上找了一堆罗里吧嗦的文章，绕来绕去的,其实抓无线包一条命令就好了。</p>
<p>Windows下因为无线网卡驱动会拒绝进入混杂模式，所以比较蛋疼，一般是用Omnipeek去弄，不细说了。</p>
<p>Linux和Mac就很方便了。只要用tcpdump就可以，一般系统都自带了。最后-i选项的参数填想抓的网络设备名就行。Mac默认的WiFi网卡是en0。 <code>tcpdump -Ine -i en0</code></p>
<p>主要就是指定-I参数，进入监控模式。 <code>-I :Put the interface in &quot;monitor mode&quot;; this is supported only on IEEE 802.11 Wi-Fi interfaces, and supported only on some operating systems.</code> 进入监控模式之后计算机用于监控的无线网卡就上不了网了，所以可以考虑买个外置无线网卡来抓包，上网抓包两不误。</p>
<p>抓了包能干很多坏事，比如WEP网络抓几个IV包就可以用aircrack破密码，WPA网络抓到一个握手包就能跑字典破无线密码了。如果在同一个网络内，还可以看到各种未加密的流量……什么小黄图啊，隐私照啊之类的……。</p>
<p>假如我已经知道某个手机的MAC地址，那么只要 <code>tcpdump -Ine -i en0 | grep $MAC_ADDRESS </code>就过滤出该手机相关的WiFi流量。</p>
<p>具体帧的类型详情参看802.11协议，《802.11无线网络权威指南》等。</p>
<p>顺便解释以下混杂模式与监控模式的区别： 混杂(promiscuous)模式是指：接收同一个网络中的所有数据包，无论是不是发给自己的。 监控(monitor)模式是指：接收某个物理信道中所有传输着的数据包。</p>
<blockquote>
<p>RFMON RFMON is short for radio frequency monitoring mode and is sometimes also described as monitor mode or raw monitoring mode. In this mode an 802.11 wireless card is in listening mode (“sniffer” mode).</p>
<p>The wireless card does not have to associate to an access point or ad-hoc network but can passively listen to all traffic on the channel it is monitoring. Also, the wireless card does not require the frames to pass CRC checks and forwards all frames (corrupted or not with 802.11 headers) to upper level protocols for processing. This can come in handy when troubleshooting protocol issues and bad hardware.</p>
<p>RFMON/Monitor Mode vs. Promiscuous Mode Promiscuous mode in wired and wireless networks instructs a wired or wireless card to process any traffic regardless of the destination mac address. In wireless networks promiscuous mode requires that the wireless card be associated to an access point or ad-hoc network. While in promiscuous mode a wireless card can transmit and receive but will only captures traffic for the network (SSID) to which it is associated.</p>
<p>RFMON mode is only possible for wireless cards and does not require the wireless card to be associated to a wireless network. While in monitor mode the wireless card can passively monitor traffic of all networks and devices within listening range (SSIDs, stations, access points). In most cases the wireless card is not able to transmit and does not follow the typical 802.11 protocol when receiving traffic (i.e. transmit an 802.11 ACK for received packet).</p>
<p>Both modes have to be supported by the driver of the wired or wireless card.</p>
</blockquote>
<p>另外在研究抓包工具时，发现了Mac下有一个很好用的命令行工具airport，可以用来抓包，以及摆弄Macbook的WiFi。 位置在 <code>/System/Library/PrivateFrameworks/Apple80211.framework/Versions/Current/Resources/airport</code></p>
<p>可以创建一个符号链接方便使用： <code>sudo ln -s /System/Library/PrivateFrameworks/Apple80211.framework/Versions/Current/Resources/airport /usr/sbin/airport</code></p>
<p>常用的命令有： 显示当前网络信息：<code>airport -I</code> 扫描周围无线网络：<code>airport -s</code> 断开当前无线网络：<code>airport -z</code> 强制指定无线信道：<code>airport -c=$CHANNEL</code></p>
<p>抓无线包，可以指定信道： <code>airport en0 sniff [$CHANNEL]</code> 抓到的包放在/tmp/airportSniffXXXXX.cap，可以用tcpdump, tshark, wireshark等软件来读。</p>
<p>最实用的功能还是扫描周围无线网络。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-952ac87bedcf6370ba38c07b37016b21">file_fdw妙用无穷——从数据库读取系统信息</h1>
	<div class="lead">通过<code>file_fdw</code>，轻松查看操作系统信息，拉取网络数据，把各种各样的数据源轻松喂进数据库里统一查看管理。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2017-12-01" class="text-muted">2017年12月01日</time>
        
	</div>
	<p>PostgreSQL是最先进的开源数据库，其中一个非常给力的特性就是FDW：外部数据包装器（Foreign Data Wrapper）。通过FDW，用户可以用统一的方式从Pg中访问各类外部数据源。<code>file_fdw</code>就是其中随数据库附赠的两个fdw之一。随着pg10的更新，<code>file_fdw</code>也添加了一颗赛艇的功能：从程序输出读取。</p>
<p>小霸王妙用无穷，我们能通过<code>file_fdw</code>，轻松查看操作系统信息，拉取网络数据，把各种各样的数据源轻松喂进数据库里统一查看管理。</p>
<hr>
<h2 id="安装与配置">安装与配置</h2>
<p><code>file_fdw</code>是Pg自带的组件，不需要奇怪的配置，在数据库中执行以下命令即可启用<code>file_fdw</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>CREATE EXTENSION file_fdw;
</span></span></code></pre></div><p>启用FDW插件之后，需要创建一个实例，也是一行SQL搞定，创建一个名为<code>fs</code>的FDW Server实例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>CREATE SERVER fs FOREIGN DATA WRAPPER file_fdw;
</span></span></code></pre></div><hr>
<h2 id="创建外部表">创建外部表</h2>
<p>举个栗子，如果我想从数据库中读取操作系统中正在运行的进程信息，该怎么做呢？</p>
<p>最典型，也是最常用的外部数据格式就是CSV啦。不过系统命令输出的结果并不是很规整：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt;&gt;&gt; ps ux
</span></span><span style="display:flex;"><span>USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</span></span><span style="display:flex;"><span>vonng     <span style="color:#0000cf;font-weight:bold">2658</span>  0.0  0.2 <span style="color:#0000cf;font-weight:bold">148428</span>  <span style="color:#0000cf;font-weight:bold">2620</span> ?        S    11:51   0:00 sshd: vonng@pts/0,pts/2
</span></span><span style="display:flex;"><span>vonng     <span style="color:#0000cf;font-weight:bold">2659</span>  0.0  0.2 <span style="color:#0000cf;font-weight:bold">115648</span>  <span style="color:#0000cf;font-weight:bold">2312</span> pts/0    Ss+  11:51   0:00 -bash
</span></span><span style="display:flex;"><span>vonng     <span style="color:#0000cf;font-weight:bold">4854</span>  0.0  0.2 <span style="color:#0000cf;font-weight:bold">115648</span>  <span style="color:#0000cf;font-weight:bold">2272</span> pts/2    Ss   15:46   0:00 -bash
</span></span><span style="display:flex;"><span>vonng     <span style="color:#0000cf;font-weight:bold">5176</span>  0.0  0.1 <span style="color:#0000cf;font-weight:bold">150940</span>  <span style="color:#0000cf;font-weight:bold">1828</span> pts/2    R+   16:06   0:00 ps -ux
</span></span><span style="display:flex;"><span>vonng    <span style="color:#0000cf;font-weight:bold">26460</span>  0.0  1.2 <span style="color:#0000cf;font-weight:bold">271808</span> <span style="color:#0000cf;font-weight:bold">13060</span> ?        S    10月26   0:22 /usr/local/pgsql/bin/postgres
</span></span><span style="display:flex;"><span>vonng    <span style="color:#0000cf;font-weight:bold">26462</span>  0.0  0.2 <span style="color:#0000cf;font-weight:bold">271960</span>  <span style="color:#0000cf;font-weight:bold">2640</span> ?        Ss   10月26   0:00 postgres: checkpointer process
</span></span><span style="display:flex;"><span>vonng    <span style="color:#0000cf;font-weight:bold">26463</span>  0.0  0.2 <span style="color:#0000cf;font-weight:bold">271808</span>  <span style="color:#0000cf;font-weight:bold">2148</span> ?        Ss   10月26   0:25 postgres: writer process
</span></span><span style="display:flex;"><span>vonng    <span style="color:#0000cf;font-weight:bold">26464</span>  0.0  0.5 <span style="color:#0000cf;font-weight:bold">271808</span>  <span style="color:#0000cf;font-weight:bold">5300</span> ?        Ss   10月26   0:27 postgres: wal writer process
</span></span><span style="display:flex;"><span>vonng    <span style="color:#0000cf;font-weight:bold">26465</span>  0.0  0.2 <span style="color:#0000cf;font-weight:bold">272216</span>  <span style="color:#0000cf;font-weight:bold">2096</span> ?        Ss   10月26   0:31 postgres: autovacuum launcher process
</span></span><span style="display:flex;"><span>vonng    <span style="color:#0000cf;font-weight:bold">26466</span>  0.0  0.1 <span style="color:#0000cf;font-weight:bold">126896</span>  <span style="color:#0000cf;font-weight:bold">1104</span> ?        Ss   10月26   0:54 postgres: stats collector process
</span></span><span style="display:flex;"><span>vonng    <span style="color:#0000cf;font-weight:bold">26467</span>  0.0  0.1 <span style="color:#0000cf;font-weight:bold">272100</span>  <span style="color:#0000cf;font-weight:bold">1588</span> ?        Ss   10月26   0:01 postgres: bgworker: logical replication launcher
</span></span></code></pre></div><p>可以通过<code>awk</code>，将<code>ps</code>的命令输出规整为分隔符为<code>\x1F</code>的csv格式。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ps aux | awk &#39;{print $1,$2,$3,$4,$5,$6,$7,$8,$9,$10,substr($0,index($0,$11))}&#39; OFS=&#39;\037&#39;
</span></span></code></pre></div><p>正戏来啦！通过以下DDL创建一张外表定义</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>CREATE FOREIGN TABLE process_status (
</span></span><span style="display:flex;"><span>  username TEXT,
</span></span><span style="display:flex;"><span>  pid      INTEGER,
</span></span><span style="display:flex;"><span>  cpu      NUMERIC,
</span></span><span style="display:flex;"><span>  mem      NUMERIC,
</span></span><span style="display:flex;"><span>  vsz      BIGINT,
</span></span><span style="display:flex;"><span>  rss      BIGINT,
</span></span><span style="display:flex;"><span>  tty      TEXT,
</span></span><span style="display:flex;"><span>  stat     TEXT,
</span></span><span style="display:flex;"><span>  start    TEXT,
</span></span><span style="display:flex;"><span>  time     TEXT,
</span></span><span style="display:flex;"><span>  command  TEXT
</span></span><span style="display:flex;"><span>) SERVER fs OPTIONS (
</span></span><span style="display:flex;"><span>PROGRAM $$ps aux | awk &#39;{print $1,$2,$3,$4,$5,$6,$7,$8,$9,$10,substr($0,index($0,$11))}&#39; OFS=&#39;\037&#39;$$,
</span></span><span style="display:flex;"><span>FORMAT &#39;csv&#39;, DELIMITER E&#39;\037&#39;, HEADER &#39;TRUE&#39;);
</span></span></code></pre></div><p>这里，关键是通过<code>CREATE FOREIGN TABLE OPTIONS (xxxx)</code>中的<code>OPTIONS</code>提供相应的参数，在<code>PROGRAM</code>参数中填入上面的命令，pg就会在查询这张表的时候自动执行此命令，并读取其输出。<code>FORMAT</code>参数可以指定为<code>CSV</code>，<code>DELIMITER</code>参数指定为之前使用的<code>\x1F</code>，并通过<code>HEADER 'TRUE'</code>忽略CSV的第一行</p>
<p>那么结果如何呢？</p>
<p><img src="/img/blog/pg/file_fdw.png"></p>
<hr>
<h2 id="有什么用">有什么用</h2>
<p>最简单的场景，原本系统指标监控需要编写各种监测脚本，部署在奇奇怪怪的地方。然后定期执行拉取metric，再存进数据库。现在通过file_fdw的方式，可以将感兴趣的指标直接录入数据库表，一步到位，而且维护方便，部署简单，更加可靠。在外表上加上视图，定期拉取聚合，将原本一个监控系统完成的事情，在数据库中一条龙解决了。</p>
<p>因为可以从程序输出读取结果，因此file_fdw可以与linux生态里各类强大的命令行工具配合使用，发挥出强大的威力。</p>
<hr>
<h2 id="其他栗子">其他栗子</h2>
<p>诸如此类，实际上后来我发现Facebook貌似有一个类似的产品，叫OSQuery，也是干了差不多的事。通过SQL查询操作系统的指标。但明显PostgreSQL这种方法最简单粗暴高效啦，只要定义表结构，和命令数据源就能轻松对接指标数据，用不了一天就能做出一个功能差不多的东西来。</p>
<p>用于读取系统用户列表的DDL：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>CREATE FOREIGN TABLE etc_password (
</span></span><span style="display:flex;"><span>  username  TEXT,
</span></span><span style="display:flex;"><span>  password  TEXT,
</span></span><span style="display:flex;"><span>  user_id   INTEGER,
</span></span><span style="display:flex;"><span>  group_id  INTEGER,
</span></span><span style="display:flex;"><span>  user_info TEXT,
</span></span><span style="display:flex;"><span>  home_dir  TEXT,
</span></span><span style="display:flex;"><span>  shell     TEXT
</span></span><span style="display:flex;"><span>) SERVER fs OPTIONS (
</span></span><span style="display:flex;"><span>  PROGRAM $$awk -F: &#39;NF &amp;&amp; !/^[:space:]*#/ {print $1,$2,$3,$4,$5,$6,$7}&#39; OFS=&#39;\037&#39; /etc/passwd$$, 
</span></span><span style="display:flex;"><span>  FORMAT &#39;csv&#39;, DELIMITER E&#39;\037&#39;
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>用于读取磁盘用量的DDL：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>CREATE FOREIGN TABLE disk_free (
</span></span><span style="display:flex;"><span>  file_system TEXT,
</span></span><span style="display:flex;"><span>  blocks_1m   BIGINT,
</span></span><span style="display:flex;"><span>  used_1m     BIGINT,
</span></span><span style="display:flex;"><span>  avail_1m    BIGINT,
</span></span><span style="display:flex;"><span>  capacity    TEXT,
</span></span><span style="display:flex;"><span>  iused       BIGINT,
</span></span><span style="display:flex;"><span>  ifree       BIGINT,
</span></span><span style="display:flex;"><span>  iused_pct   TEXT,
</span></span><span style="display:flex;"><span>  mounted_on  TEXT
</span></span><span style="display:flex;"><span>) SERVER fs OPTIONS (PROGRAM $$df -ml| awk &#39;{print $1,$2,$3,$4,$5,$6,$7,$8,$9}&#39; OFS=&#39;\037&#39;$$, FORMAT &#39;csv&#39;, HEADER &#39;TRUE&#39;, DELIMITER E&#39;\037&#39;
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>当然，用file_fdw只是一个很Naive的FDW，譬如这里就只能读，不能改。</p>
<p>自己编写FDW实现增删改查逻辑也非常简单，例如Multicorn就是使用Python编写FDW的项目。</p>
<p>SQL over everything，让世界变的更简单~</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c38d4e3664b5a6788de15893db6a0058">Linux 常用统计 CLI 工具</h1>
	<div class="lead">top, free, vmstat, iostat：四大常用 CLI 工具命令速查</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2017-09-07" class="text-muted">2017年09月07日</time>
        
	</div>
	<ul>
<li><a href="/zh/blog/admin/unix-tool/#top"><code>top</code></a></li>
<li><a href="/zh/blog/admin/unix-tool/#free"><code>free</code></a></li>
<li><a href="/zh/blog/admin/unix-tool/#vmstat"><code>vmstat</code></a></li>
<li><a href="/zh/blog/admin/unix-tool/#iostat"><code>iostat</code></a></li>
</ul>
<hr>
<h2 id="top"><code>top</code></h2>
<p>显示Linux任务</p>
<h3 id="摘要">摘要</h3>
<ul>
<li>按下空格或回车强制刷新</li>
<li>使用<code>h</code>打开帮助</li>
<li>使用<code>l,t,m</code>收起摘要部分。</li>
<li>使用<code>d</code>修改刷新周期</li>
<li>使用<code>z</code>开启颜色高亮</li>
<li>使用<code>u</code>列出指定用户的进程</li>
<li>使用<code>&lt;&gt;</code>来改变排序列</li>
<li>使用<code>P</code>按CPU使用率排序</li>
<li>使用<code>M</code>按驻留内存大小排序</li>
<li>使用<code>T</code>按累计时间排序</li>
</ul>
<h3 id="批处理模式">批处理模式</h3>
<p><code>-b</code>参数可以用于批处理模式，配合<code>-n</code>参数指定批次数目。同时<code>-d</code>参数可以指定批次的间隔时间</p>
<p>例如获取机器当前的负载使用情况，以0.1秒为间隔获取三次，获取最后一次的CPU摘要。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ top -bn3 -d0.1 <span style="color:#000;font-weight:bold">|</span> grep Cpu <span style="color:#000;font-weight:bold">|</span> tail -n1
</span></span><span style="display:flex;"><span>Cpu<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span>:  4.1%us,  1.0%sy,  0.0%ni, 94.8%id,  0.0%wa,  0.0%hi,  0.1%si,  0.0%st
</span></span></code></pre></div><h3 id="输出格式">输出格式</h3>
<p><code>top</code>的输出分为两部分，上面几行是系统摘要，下面是进程列表，两者通过一个空行分割。下面是<code>top</code>命令的输出样例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#000">top</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">01</span> <span style="color:#000">up</span> <span style="color:#0000cf;font-weight:bold">401</span> <span style="color:#000">days</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000">users</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#204a87">load</span> <span style="color:#000">average</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1.12</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1.26</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1.40</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Tasks</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1178</span> <span style="color:#000">total</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000">running</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1175</span> <span style="color:#000">sleeping</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000">stopped</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000">zombie</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Cpu</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">):</span>  <span style="color:#0000cf;font-weight:bold">5.4</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">us</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#0000cf;font-weight:bold">1.7</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">sy</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">ni</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">92.5</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#0000cf;font-weight:bold">0.1</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">wa</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">hi</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#0000cf;font-weight:bold">0.4</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">si</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">st</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Mem</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#0000cf;font-weight:bold">396791756</span><span style="color:#000">k</span> <span style="color:#000">total</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">389547376</span><span style="color:#000">k</span> <span style="color:#000">used</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#0000cf;font-weight:bold">7244380</span><span style="color:#000">k</span> <span style="color:#000">free</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#0000cf;font-weight:bold">263828</span><span style="color:#000">k</span> <span style="color:#000">buffers</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Swap</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">67108860</span><span style="color:#000">k</span> <span style="color:#000">total</span><span style="color:#000;font-weight:bold">,</span>        <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000">k</span> <span style="color:#000">used</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">67108860</span><span style="color:#000">k</span> <span style="color:#000">free</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">366252364</span><span style="color:#000">k</span> <span style="color:#000">cached</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">PID</span> <span style="color:#000">USER</span>      <span style="color:#000">PR</span>  <span style="color:#000">NI</span>  <span style="color:#000">VIRT</span>  <span style="color:#000">RES</span>  <span style="color:#000">SHR</span> <span style="color:#000">S</span> <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">CPU</span> <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">MEM</span>    <span style="color:#000">TIME</span><span style="color:#ce5c00;font-weight:bold">+</span>  <span style="color:#000">COMMAND</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">5094</span> <span style="color:#000">postgres</span>  <span style="color:#0000cf;font-weight:bold">20</span>   <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">37.2</span><span style="color:#000">g</span> <span style="color:#0000cf;font-weight:bold">829</span><span style="color:#000">m</span> <span style="color:#0000cf;font-weight:bold">795</span><span style="color:#000">m</span> <span style="color:#000">S</span> <span style="color:#0000cf;font-weight:bold">14.2</span>  <span style="color:#0000cf;font-weight:bold">0.2</span>   <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">04.11</span> <span style="color:#000">postmaster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">5093</span> <span style="color:#000">postgres</span>  <span style="color:#0000cf;font-weight:bold">20</span>   <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">37.2</span><span style="color:#000">g</span> <span style="color:#0000cf;font-weight:bold">926</span><span style="color:#000">m</span> <span style="color:#0000cf;font-weight:bold">891</span><span style="color:#000">m</span> <span style="color:#000">S</span> <span style="color:#0000cf;font-weight:bold">13.2</span>  <span style="color:#0000cf;font-weight:bold">0.2</span>   <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">04.96</span> <span style="color:#000">postmaster</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">165359</span> <span style="color:#000">postgres</span>  <span style="color:#0000cf;font-weight:bold">20</span>   <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">37.2</span><span style="color:#000">g</span> <span style="color:#0000cf;font-weight:bold">4.0</span><span style="color:#000">g</span> <span style="color:#0000cf;font-weight:bold">4.0</span><span style="color:#000">g</span> <span style="color:#000">S</span> <span style="color:#0000cf;font-weight:bold">12.6</span>  <span style="color:#0000cf;font-weight:bold">1.1</span>   <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">44.93</span> <span style="color:#000">postmaster</span>
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">93426</span> <span style="color:#000">postgres</span>  <span style="color:#0000cf;font-weight:bold">20</span>   <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">37.2</span><span style="color:#000">g</span> <span style="color:#0000cf;font-weight:bold">6.8</span><span style="color:#000">g</span> <span style="color:#0000cf;font-weight:bold">6.7</span><span style="color:#000">g</span> <span style="color:#000">S</span> <span style="color:#0000cf;font-weight:bold">12.2</span>  <span style="color:#0000cf;font-weight:bold">1.8</span>   <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">32.94</span> <span style="color:#000">postmaster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">5092</span> <span style="color:#000">postgres</span>  <span style="color:#0000cf;font-weight:bold">20</span>   <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">37.2</span><span style="color:#000">g</span> <span style="color:#0000cf;font-weight:bold">856</span><span style="color:#000">m</span> <span style="color:#0000cf;font-weight:bold">818</span><span style="color:#000">m</span> <span style="color:#000">R</span> <span style="color:#0000cf;font-weight:bold">11.2</span>  <span style="color:#0000cf;font-weight:bold">0.2</span>   <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">04.21</span> <span style="color:#000">postmaster</span>
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">67634</span> <span style="color:#000">root</span>      <span style="color:#0000cf;font-weight:bold">20</span>   <span style="color:#0000cf;font-weight:bold">0</span>  <span style="color:#0000cf;font-weight:bold">569</span><span style="color:#000">m</span> <span style="color:#0000cf;font-weight:bold">520</span><span style="color:#000">m</span>  <span style="color:#0000cf;font-weight:bold">328</span> <span style="color:#000">S</span> <span style="color:#0000cf;font-weight:bold">11.2</span>  <span style="color:#0000cf;font-weight:bold">0.1</span> <span style="color:#0000cf;font-weight:bold">140720</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15</span> <span style="color:#000">haproxy</span>
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">93429</span> <span style="color:#000">postgres</span>  <span style="color:#0000cf;font-weight:bold">20</span>   <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">37.2</span><span style="color:#000">g</span> <span style="color:#0000cf;font-weight:bold">8.7</span><span style="color:#000">g</span> <span style="color:#0000cf;font-weight:bold">8.7</span><span style="color:#000">g</span> <span style="color:#000">S</span> <span style="color:#0000cf;font-weight:bold">11.2</span>  <span style="color:#0000cf;font-weight:bold">2.3</span>   <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">12.23</span> <span style="color:#000">postmaster</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">129653</span> <span style="color:#000">postgres</span>  <span style="color:#0000cf;font-weight:bold">20</span>   <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">37.2</span><span style="color:#000">g</span> <span style="color:#0000cf;font-weight:bold">6.8</span><span style="color:#000">g</span> <span style="color:#0000cf;font-weight:bold">6.7</span><span style="color:#000">g</span> <span style="color:#000">S</span> <span style="color:#0000cf;font-weight:bold">11.2</span>  <span style="color:#0000cf;font-weight:bold">1.8</span>   <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">27.92</span> <span style="color:#000">postmaster</span>
</span></span></code></pre></div><h3 id="摘要部分">摘要部分</h3>
<p>摘要默认由三个部分，共计五行组成：</p>
<ul>
<li>系统运行时间，平均负载，共计一行（<code>l</code>切换内容）</li>
<li>任务、CPU状态，各一行（<code>t</code>切换内容）</li>
<li>内存使用，Swap使用，各一行（<code>m</code>切换内容）</li>
</ul>
<p><strong>系统运行时间和平均负载</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#000">top</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">01</span> <span style="color:#000">up</span> <span style="color:#0000cf;font-weight:bold">401</span> <span style="color:#000">days</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000">users</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#204a87">load</span> <span style="color:#000">average</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1.12</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1.26</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1.40</span>
</span></span></code></pre></div><ul>
<li>当前时间：<code>12:11:01</code></li>
<li>系统已运行的时间：<code>up 401 days</code></li>
<li>当前登录用户的数量：<code>2 users</code></li>
<li>相应最近5、10和15分钟内的平均负载：<code>load average: 1.12, 1.26, 1.40</code>。</li>
</ul>
<blockquote>
<p>Load表示操作系统的负载，即，当前运行的任务数目。而load average表示一段时间内平均的load，也就是过去一段时间内平均有多少个任务在运行。注意Load与CPU利用率并不是一回事。</p>
</blockquote>
<p><strong>任务</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Tasks: 1178 total,   3 running, 1175 sleeping,   0 stopped,   0 zombie
</span></span></code></pre></div><p>第二行显示的是任务或者进程的总结。进程可以处于不同的状态。这里显示了全部进程的数量。除此之外，还有正在运行、睡眠、停止、僵尸进程的数量（僵尸是一种进程的状态）。</p>
<p><strong>CPU状态</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Cpu<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span>:  5.4%us,  1.7%sy,  0.0%ni, 92.5%id,  0.1%wa,  0.0%hi,  0.4%si,  0.0%st
</span></span></code></pre></div><p>下一行显示的是CPU状态。 这里显示了不同模式下的所占CPU时间的百分比。这些不同的CPU时间表示:</p>
<ul>
<li>us, user： 运行(未调整优先级的) 用户进程的CPU时间</li>
<li>sy，system: 运行内核进程的CPU时间</li>
<li>ni，niced：运行已调整优先级的用户进程的CPU时间</li>
<li>id，idle：空闲CPU时间</li>
<li>wa，IO wait: 用于等待IO完成的CPU时间</li>
<li>hi：处理硬件中断的CPU时间</li>
<li>si: 处理软件中断的CPU时间</li>
<li>st：虚拟机被hypervisor偷去的CPU时间（如果当前处于一个虚拟机内，宿主机消耗的CPU处理时间）。</li>
</ul>
<p><strong>内存使用</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Mem:  396791756k total, 389547376k used,  7244380k free,   263828k buffers
</span></span><span style="display:flex;"><span>Swap: 67108860k total,        0k used, 67108860k free, 366252364k cached
</span></span></code></pre></div><ul>
<li>内存部分：全部可用内存、已使用内存、空闲内存、缓冲内存。</li>
<li>SWAP部分：全部、已使用、空闲和缓冲交换空间。</li>
</ul>
<h3 id="进程部分">进程部分</h3>
<p>进程部分默认会显示一些关键信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>   PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
</span></span><span style="display:flex;"><span>  5094 postgres  20   0 37.2g 829m 795m S 14.2  0.2   0:04.11 postmaster
</span></span><span style="display:flex;"><span>  5093 postgres  20   0 37.2g 926m 891m S 13.2  0.2   0:04.96 postmaster
</span></span><span style="display:flex;"><span>165359 postgres  20   0 37.2g 4.0g 4.0g S 12.6  1.1   0:44.93 postmaster
</span></span><span style="display:flex;"><span> 93426 postgres  20   0 37.2g 6.8g 6.7g S 12.2  1.8   1:32.94 postmaster
</span></span><span style="display:flex;"><span>  5092 postgres  20   0 37.2g 856m 818m R 11.2  0.2   0:04.21 postmaster
</span></span><span style="display:flex;"><span> 67634 root      20   0  569m 520m  328 S 11.2  0.1 140720:15 haproxy
</span></span><span style="display:flex;"><span> 93429 postgres  20   0 37.2g 8.7g 8.7g S 11.2  2.3   2:12.23 postmaster
</span></span><span style="display:flex;"><span>129653 postgres  20   0 37.2g 6.8g 6.7g S 11.2  1.8   1:27.92 postmaster
</span></span></code></pre></div><ul>
<li>
<p><strong>PID</strong>：进程ID，进程的唯一标识符</p>
</li>
<li>
<p><strong>USER</strong>：进程所有者的实际用户名。</p>
</li>
<li>
<p><strong>PR</strong>：进程的调度优先级。这个字段的一些值是&rsquo;rt&rsquo;。这意味这这些进程运行在实时态。</p>
</li>
<li>
<p><strong>NI</strong>：进程的nice值（优先级）。越小的值意味着越高的优先级。</p>
</li>
<li>
<p><strong>VIRT</strong>：进程使用的虚拟内存。</p>
</li>
<li>
<p><strong>RES</strong>：驻留内存大小。驻留内存是任务使用的非交换物理内存大小。</p>
</li>
<li>
<p><strong>SHR</strong>：SHR是进程使用的共享内存。</p>
</li>
<li>
<p><strong>S</strong>这个是进程的状态。它有以下不同的值:</p>
</li>
<li>
<p>D - 不可中断的睡眠态。</p>
</li>
<li>
<p>R – 运行态</p>
</li>
<li>
<p>S – 睡眠态</p>
</li>
<li>
<p>T – Trace或Stop</p>
</li>
<li>
<p>Z – 僵尸态</p>
</li>
<li>
<p><strong>%CPU</strong>：自从上一次更新时到现在任务所使用的CPU时间百分比。</p>
</li>
<li>
<p><strong>%MEM</strong>：进程使用的可用物理内存百分比。</p>
</li>
<li>
<p><strong>TIME+</strong>：任务启动后到现在所使用的全部CPU时间，单位为百分之一秒。</p>
</li>
<li>
<p><strong>COMMAND</strong>：运行进程所使用的命令。</p>
</li>
</ul>
<h3 id="linux进程的状态">Linux进程的状态</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">task_state_array</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;R (running)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">/* 0 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;S (sleeping)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">/* 1 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;D (disk sleep)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">/* 2 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;T (stopped)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">/* 4 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;t (tracing stop)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">/* 8 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;X (dead)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">/* 16 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;Z (zombie)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">/* 32 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><ul>
<li><code>R (TASK_RUNNING)</code>，可执行状态。实际运行与<code>Ready</code>在Linux都算做Running状态</li>
<li><code>S (TASK_INTERRUPTIBLE)</code>，可中断的睡眠态，进程等待事件，位于等待队列中。</li>
<li><code>D (TASK_UNINTERRUPTIBLE)</code>，不可中断的睡眠态，无法响应异步信号，例如硬件操作，内核线程</li>
<li><code>T (TASK_STOPPED | TASK_TRACED)</code>，暂停状态或跟踪状态，由SIGSTOP或断点触发</li>
<li><code>Z (TASK_DEAD)</code>，子进程退出后，父进程还没有来收尸，留下<code>task_structure</code>的进程就处于这种状态。</li>
</ul>
<hr>
<h2 id="free"><code>free</code></h2>
<p>显示系统的内存使用情况</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>free -b <span style="color:#000;font-weight:bold">|</span> -k <span style="color:#000;font-weight:bold">|</span> -m <span style="color:#000;font-weight:bold">|</span> -g <span style="color:#000;font-weight:bold">|</span> -h -s delay  -a -l
</span></span></code></pre></div><ul>
<li>其中<code>-b | -k | -m | -g | -h </code>可用于控制显示大小时的单位（字节，KB,MB,GB，自动适配）</li>
<li><code>-s</code>可以指定轮询周期，<code>-c</code>指定轮询次数。</li>
</ul>
<h3 id="输出样例">输出样例</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ free -m
</span></span><span style="display:flex;"><span>             total       used       free     shared    buffers     cached
</span></span><span style="display:flex;"><span>Mem:        <span style="color:#0000cf;font-weight:bold">387491</span>     <span style="color:#0000cf;font-weight:bold">379383</span>       <span style="color:#0000cf;font-weight:bold">8107</span>      <span style="color:#0000cf;font-weight:bold">37762</span>        <span style="color:#0000cf;font-weight:bold">182</span>     <span style="color:#0000cf;font-weight:bold">348862</span>
</span></span><span style="display:flex;"><span>-/+ buffers/cache:      <span style="color:#0000cf;font-weight:bold">30338</span>     <span style="color:#0000cf;font-weight:bold">357153</span>
</span></span><span style="display:flex;"><span>Swap:        <span style="color:#0000cf;font-weight:bold">65535</span>          <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">65535</span>
</span></span></code></pre></div><ul>
<li>这里，总内存有378GB，使用370GB，空闲8GB。三者存在<code>total=used+free</code>的关系。共享内存占36GB。</li>
<li>buffers与cache由操作系统分配管理，用于提高I/O性能，其中Buffer是写入缓冲，而Cache是读取缓存。这一行表示，应用程序<strong>已使用</strong>的<code>buffers/cached</code>，以及理论上<strong>可使用</strong>的<code>buffers/cache</code>。
<code>-/+ buffers/cache:      30338     357153</code></li>
<li>最后一行显示了SWAP信息，总的SWAP空间，实际使用的SWAP空间，以及可用的SWAP空间。只要没有用到SWAP（used = 0），就说明内存空间仍然够用。</li>
</ul>
<h3 id="数据来源">数据来源</h3>
<p>free实际上是通过<code>cat /proc/meminfo</code>获取信息的。</p>
<p>详细信息：https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/deployment_guide/s2-proc-meminfo</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cat /proc/meminfo
</span></span><span style="display:flex;"><span>MemTotal:       <span style="color:#0000cf;font-weight:bold">396791752</span> kB	<span style="color:#8f5902;font-style:italic"># 总可用RAM, 物理内存减去内核二进制与保留位</span>
</span></span><span style="display:flex;"><span>MemFree:         <span style="color:#0000cf;font-weight:bold">7447460</span> kB		<span style="color:#8f5902;font-style:italic"># 系统可用物理内存</span>
</span></span><span style="display:flex;"><span>Buffers:          <span style="color:#0000cf;font-weight:bold">186540</span> kB		<span style="color:#8f5902;font-style:italic"># 磁盘快的临时存储大小</span>
</span></span><span style="display:flex;"><span>Cached:         <span style="color:#0000cf;font-weight:bold">357066928</span> kB	<span style="color:#8f5902;font-style:italic"># 缓存</span>
</span></span><span style="display:flex;"><span>SwapCached:            <span style="color:#0000cf;font-weight:bold">0</span> kB		<span style="color:#8f5902;font-style:italic"># 曾移入SWAP又移回内存的大小</span>
</span></span><span style="display:flex;"><span>Active:         <span style="color:#0000cf;font-weight:bold">260698732</span> kB	<span style="color:#8f5902;font-style:italic"># 最近使用过，如非强制不会回收的内存。</span>
</span></span><span style="display:flex;"><span>Inactive:       <span style="color:#0000cf;font-weight:bold">112228764</span> kB	<span style="color:#8f5902;font-style:italic"># 最近没怎么用过的内存，可能会回收</span>
</span></span><span style="display:flex;"><span>Active<span style="color:#ce5c00;font-weight:bold">(</span>anon<span style="color:#ce5c00;font-weight:bold">)</span>:   <span style="color:#0000cf;font-weight:bold">53811184</span> kB		<span style="color:#8f5902;font-style:italic"># 活跃的匿名内存(不与具体文件关联)</span>
</span></span><span style="display:flex;"><span>Inactive<span style="color:#ce5c00;font-weight:bold">(</span>anon<span style="color:#ce5c00;font-weight:bold">)</span>:   <span style="color:#0000cf;font-weight:bold">532504</span> kB		<span style="color:#8f5902;font-style:italic"># 不活跃的匿名内存</span>
</span></span><span style="display:flex;"><span>Active<span style="color:#ce5c00;font-weight:bold">(</span>file<span style="color:#ce5c00;font-weight:bold">)</span>:   <span style="color:#0000cf;font-weight:bold">206887548</span> kB	<span style="color:#8f5902;font-style:italic"># 活跃的文件缓存</span>
</span></span><span style="display:flex;"><span>Inactive<span style="color:#ce5c00;font-weight:bold">(</span>file<span style="color:#ce5c00;font-weight:bold">)</span>: <span style="color:#0000cf;font-weight:bold">111696260</span> kB	<span style="color:#8f5902;font-style:italic"># 不活跃的文件缓存</span>
</span></span><span style="display:flex;"><span>Unevictable:           <span style="color:#0000cf;font-weight:bold">0</span> kB		<span style="color:#8f5902;font-style:italic"># 不可淘汰的内存</span>
</span></span><span style="display:flex;"><span>Mlocked:               <span style="color:#0000cf;font-weight:bold">0</span> kB		<span style="color:#8f5902;font-style:italic"># 被钉在内存中</span>
</span></span><span style="display:flex;"><span>SwapTotal:      <span style="color:#0000cf;font-weight:bold">67108860</span> kB		<span style="color:#8f5902;font-style:italic"># 总SWAP</span>
</span></span><span style="display:flex;"><span>SwapFree:       <span style="color:#0000cf;font-weight:bold">67108860</span> kB		<span style="color:#8f5902;font-style:italic"># 可用SWAP</span>
</span></span><span style="display:flex;"><span>Dirty:            <span style="color:#0000cf;font-weight:bold">115852</span> kB		<span style="color:#8f5902;font-style:italic"># 被写脏的内存</span>
</span></span><span style="display:flex;"><span>Writeback:             <span style="color:#0000cf;font-weight:bold">0</span> kB		<span style="color:#8f5902;font-style:italic"># 回写磁盘的内存</span>
</span></span><span style="display:flex;"><span>AnonPages:      <span style="color:#0000cf;font-weight:bold">15676608</span> kB		<span style="color:#8f5902;font-style:italic"># 匿名页面</span>
</span></span><span style="display:flex;"><span>Mapped:         <span style="color:#0000cf;font-weight:bold">38698484</span> kB		<span style="color:#8f5902;font-style:italic"># 用于mmap的内存，例如共享库</span>
</span></span><span style="display:flex;"><span>Shmem:          <span style="color:#0000cf;font-weight:bold">38668836</span> kB		<span style="color:#8f5902;font-style:italic"># 共享内存</span>
</span></span><span style="display:flex;"><span>Slab:            <span style="color:#0000cf;font-weight:bold">6072524</span> kB		<span style="color:#8f5902;font-style:italic"># 内核数据结构使用内存</span>
</span></span><span style="display:flex;"><span>SReclaimable:    <span style="color:#0000cf;font-weight:bold">5900704</span> kB		<span style="color:#8f5902;font-style:italic"># 可回收的slab</span>
</span></span><span style="display:flex;"><span>SUnreclaim:       <span style="color:#0000cf;font-weight:bold">171820</span> kB		<span style="color:#8f5902;font-style:italic"># 不可回收的slab</span>
</span></span><span style="display:flex;"><span>KernelStack:       <span style="color:#0000cf;font-weight:bold">25840</span> kB		<span style="color:#8f5902;font-style:italic"># 内核栈使用的内存</span>
</span></span><span style="display:flex;"><span>PageTables:      <span style="color:#0000cf;font-weight:bold">2480532</span> kB		<span style="color:#8f5902;font-style:italic"># 页表大小</span>
</span></span><span style="display:flex;"><span>NFS_Unstable:          <span style="color:#0000cf;font-weight:bold">0</span> kB		<span style="color:#8f5902;font-style:italic"># 发送但尚未提交的NFS页面</span>
</span></span><span style="display:flex;"><span>Bounce:                <span style="color:#0000cf;font-weight:bold">0</span> kB		<span style="color:#8f5902;font-style:italic"># bounce buffers</span>
</span></span><span style="display:flex;"><span>WritebackTmp:          <span style="color:#0000cf;font-weight:bold">0</span> kB
</span></span><span style="display:flex;"><span>CommitLimit:    <span style="color:#0000cf;font-weight:bold">396446012</span> kB
</span></span><span style="display:flex;"><span>Committed_AS:   <span style="color:#0000cf;font-weight:bold">57195364</span> kB
</span></span><span style="display:flex;"><span>VmallocTotal:   <span style="color:#0000cf;font-weight:bold">34359738367</span> kB
</span></span><span style="display:flex;"><span>VmallocUsed:     <span style="color:#0000cf;font-weight:bold">6214036</span> kB
</span></span><span style="display:flex;"><span>VmallocChunk:   <span style="color:#0000cf;font-weight:bold">34353427992</span> kB
</span></span><span style="display:flex;"><span>HardwareCorrupted:     <span style="color:#0000cf;font-weight:bold">0</span> kB
</span></span><span style="display:flex;"><span>AnonHugePages:         <span style="color:#0000cf;font-weight:bold">0</span> kB
</span></span><span style="display:flex;"><span>HugePages_Total:       <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>HugePages_Free:        <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>HugePages_Rsvd:        <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>HugePages_Surp:        <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>Hugepagesize:       <span style="color:#0000cf;font-weight:bold">2048</span> kB
</span></span><span style="display:flex;"><span>DirectMap4k:        <span style="color:#0000cf;font-weight:bold">5120</span> kB
</span></span><span style="display:flex;"><span>DirectMap2M:     <span style="color:#0000cf;font-weight:bold">2021376</span> kB
</span></span><span style="display:flex;"><span>DirectMap1G:    <span style="color:#0000cf;font-weight:bold">400556032</span> kB
</span></span></code></pre></div><p>其中，free与<code>/proc/meminfo</code>中指标的对应关系为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>total	= (MemTotal + SwapTotal)
</span></span><span style="display:flex;"><span>used	= (total - free - buffers - cache)
</span></span><span style="display:flex;"><span>free	= (MemFree + SwapFree)
</span></span><span style="display:flex;"><span>shared	= Shmem
</span></span><span style="display:flex;"><span>buffers	= Buffers
</span></span><span style="display:flex;"><span>cache	= Cached
</span></span><span style="display:flex;"><span>buffer/cached = Buffers + Cached
</span></span></code></pre></div><h3 id="清理缓存">清理缓存</h3>
<p>可以通过以下命令强制清理缓存：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sync <span style="color:#8f5902;font-style:italic"># flush fs buffers</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#204a87">echo</span> <span style="color:#0000cf;font-weight:bold">1</span> &gt; /proc/sys/vm/drop_caches	<span style="color:#8f5902;font-style:italic"># drop page cache</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#204a87">echo</span> <span style="color:#0000cf;font-weight:bold">2</span> &gt; /proc/sys/vm/drop_caches	<span style="color:#8f5902;font-style:italic"># drop dentries &amp; inode</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#204a87">echo</span> <span style="color:#0000cf;font-weight:bold">3</span> &gt; /proc/sys/vm/drop_caches	<span style="color:#8f5902;font-style:italic"># drop all</span>
</span></span></code></pre></div><hr>
<h2 id="vmstat"><code>vmstat</code></h2>
<p>汇报虚拟内存统计信息</p>
<h3 id="摘要-1">摘要</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vmstat <span style="color:#ce5c00;font-weight:bold">[</span>-a<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>-n<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>-t<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>-S unit<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>delay <span style="color:#ce5c00;font-weight:bold">[</span> count<span style="color:#ce5c00;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>vmstat <span style="color:#ce5c00;font-weight:bold">[</span>-s<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>-n<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>-S unit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>vmstat <span style="color:#ce5c00;font-weight:bold">[</span>-m<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>-n<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>delay <span style="color:#ce5c00;font-weight:bold">[</span> count<span style="color:#ce5c00;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>vmstat <span style="color:#ce5c00;font-weight:bold">[</span>-d<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>-n<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>delay <span style="color:#ce5c00;font-weight:bold">[</span> count<span style="color:#ce5c00;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>vmstat <span style="color:#ce5c00;font-weight:bold">[</span>-p disk partition<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>-n<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>delay <span style="color:#ce5c00;font-weight:bold">[</span> count<span style="color:#ce5c00;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>vmstat <span style="color:#ce5c00;font-weight:bold">[</span>-f<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>vmstat <span style="color:#ce5c00;font-weight:bold">[</span>-V<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>最常用的用法是：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vmstat &lt;delay&gt; &lt;count&gt;
</span></span></code></pre></div><p>例如<code>vmstat 1 10</code>就是以1秒为间隔，采样10次内存统计信息。</p>
<h3 id="样例输出">样例输出</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ vmstat <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">4</span> -S M
</span></span><span style="display:flex;"><span>procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu-----
</span></span><span style="display:flex;"><span> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">3</span>  <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>   <span style="color:#0000cf;font-weight:bold">7288</span>    <span style="color:#0000cf;font-weight:bold">170</span> <span style="color:#0000cf;font-weight:bold">344210</span>    <span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#0000cf;font-weight:bold">0</span>   <span style="color:#0000cf;font-weight:bold">158</span>   <span style="color:#0000cf;font-weight:bold">158</span>    <span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#0000cf;font-weight:bold">0</span>  <span style="color:#0000cf;font-weight:bold">2</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">97</span>  <span style="color:#0000cf;font-weight:bold">0</span>  <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">5</span>  <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>   <span style="color:#0000cf;font-weight:bold">7259</span>    <span style="color:#0000cf;font-weight:bold">170</span> <span style="color:#0000cf;font-weight:bold">344228</span>    <span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#0000cf;font-weight:bold">0</span>  <span style="color:#0000cf;font-weight:bold">7680</span> <span style="color:#0000cf;font-weight:bold">13292</span> <span style="color:#0000cf;font-weight:bold">38783</span> <span style="color:#0000cf;font-weight:bold">36814</span>  <span style="color:#0000cf;font-weight:bold">6</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">93</span>  <span style="color:#0000cf;font-weight:bold">0</span>  <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">3</span>  <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>   <span style="color:#0000cf;font-weight:bold">7247</span>    <span style="color:#0000cf;font-weight:bold">170</span> <span style="color:#0000cf;font-weight:bold">344246</span>    <span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#0000cf;font-weight:bold">0</span>  <span style="color:#0000cf;font-weight:bold">8720</span> <span style="color:#0000cf;font-weight:bold">21024</span> <span style="color:#0000cf;font-weight:bold">40584</span> <span style="color:#0000cf;font-weight:bold">39686</span>  <span style="color:#0000cf;font-weight:bold">6</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">93</span>  <span style="color:#0000cf;font-weight:bold">0</span>  <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">1</span>  <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>   <span style="color:#0000cf;font-weight:bold">7233</span>    <span style="color:#0000cf;font-weight:bold">170</span> <span style="color:#0000cf;font-weight:bold">344255</span>    <span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#0000cf;font-weight:bold">0</span>  <span style="color:#0000cf;font-weight:bold">6800</span> <span style="color:#0000cf;font-weight:bold">24404</span> <span style="color:#0000cf;font-weight:bold">39461</span> <span style="color:#0000cf;font-weight:bold">36984</span>  <span style="color:#0000cf;font-weight:bold">6</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">93</span>  <span style="color:#0000cf;font-weight:bold">0</span>  <span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Procs
</span></span><span style="display:flex;"><span>    r: 等待运行的进程数目
</span></span><span style="display:flex;"><span>    b: 处于不可中断睡眠状态的进程数(Block)
</span></span><span style="display:flex;"><span>Memory
</span></span><span style="display:flex;"><span>    swpd: 使用的交换区大小，大于0则说明内存过小
</span></span><span style="display:flex;"><span>    free: 空闲内存
</span></span><span style="display:flex;"><span>    buff: 缓冲区内存
</span></span><span style="display:flex;"><span>    cache: 页面缓存
</span></span><span style="display:flex;"><span>    inact: 不活跃内存 (-a 选项)
</span></span><span style="display:flex;"><span>    active: 活跃内存 (-a 选项)
</span></span><span style="display:flex;"><span>Swap
</span></span><span style="display:flex;"><span>    si: 每秒从磁盘中换入的内存 (/s).
</span></span><span style="display:flex;"><span>    so: 每秒从换出到磁盘的内存 (/s).
</span></span><span style="display:flex;"><span>IO
</span></span><span style="display:flex;"><span>    bi: 从块设备每秒收到的块数目 (blocks/s).
</span></span><span style="display:flex;"><span>    bo: 向块设备每秒发送的快数目 (blocks/s).
</span></span><span style="display:flex;"><span>System
</span></span><span style="display:flex;"><span>    in: 每秒中断数，包括时钟中断
</span></span><span style="display:flex;"><span>    cs: 每秒上下文切换数目
</span></span><span style="display:flex;"><span>CPU
</span></span><span style="display:flex;"><span>    总CPU时间的百分比
</span></span><span style="display:flex;"><span>    us: 用户态时间 (包括nice的时间)
</span></span><span style="display:flex;"><span>    sy: 内核态时间
</span></span><span style="display:flex;"><span>    id: 空闲时间（在2.5.41前包括等待IO的时间）
</span></span><span style="display:flex;"><span>    wa: 等待IO的时间（在2.5.41前包括在id里）
</span></span><span style="display:flex;"><span>    st: 空闲时间（在2.6.11前没有）
</span></span></code></pre></div><h3 id="数据来源-1">数据来源</h3>
<p>从下面三个文件中提取信息：</p>
<ul>
<li><code>/proc/meminfo</code></li>
<li><code>/proc/stat</code></li>
<li><code>/proc/*/stat</code></li>
</ul>
<hr>
<h2 id="iostat"><code>iostat</code></h2>
<p>汇报IO相关统计信息</p>
<h3 id="摘要-2">摘要</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>iostat <span style="color:#ce5c00;font-weight:bold">[</span> -c <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span> -d <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span> -N <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span> -n <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span> -h <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span> -k <span style="color:#000;font-weight:bold">|</span> -m <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span> -t <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span> -V <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span> -x <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span> -y <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span> -z <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span> -j <span style="color:#ce5c00;font-weight:bold">{</span> ID <span style="color:#000;font-weight:bold">|</span> LABEL <span style="color:#000;font-weight:bold">|</span> PATH <span style="color:#000;font-weight:bold">|</span> UUID <span style="color:#000;font-weight:bold">|</span> ... <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">[</span> device <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">|</span> ALL <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span> device <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">|</span> ALL <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span> -p <span style="color:#ce5c00;font-weight:bold">[</span> device <span style="color:#ce5c00;font-weight:bold">[</span>,...<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">|</span> ALL <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>interval <span style="color:#ce5c00;font-weight:bold">[</span> count <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>默认情况下iostat会打印cpu信息和磁盘io信息，使用<code>-d</code>参数只显示IO部分，使用<code>-x</code>打印更多信息。样例输出：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>avg-cpu:  %user   %nice %system %iowait  %steal   %idle
</span></span><span style="display:flex;"><span>           5.77    0.00    1.31    0.07    0.00   92.85
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn
</span></span><span style="display:flex;"><span>sdb               0.00         0.00         0.00          0          0
</span></span><span style="display:flex;"><span>sda               0.00         0.00         0.00          0          0
</span></span><span style="display:flex;"><span>dfa            5020.00     15856.00     35632.00      15856      35632
</span></span><span style="display:flex;"><span>dm-0              0.00         0.00         0.00          0          0
</span></span></code></pre></div><h3 id="常用选项">常用选项</h3>
<ul>
<li>使用<code>-d</code>参数只显示IO部分的信息，而<code>-c</code>参数则只显示CPU部分的信息。</li>
<li>使用<code>-x</code>会打印更详细的扩展信息</li>
<li>使用<code>-k</code>会使用KB替代块数目作为部分数值的单位，<code>-m</code>则使用MB。</li>
</ul>
<h3 id="输出说明">输出说明</h3>
<p>不带<code>-x</code>选项默认会为每个设备打印5列：</p>
<ul>
<li>tps：该设备每秒的传输次数。（多个逻辑请求可能会合并为一个IO请求，传输量未知）
-kB_read/s：每秒从设备读取的数据量；kB_wrtn/s：每秒向设备写入的数据量；kB_read：读取的总数据量；kB_wrtn：写入的总数量数据量；这些单位都为Kilobytes，这是使用<code>-k</code>参数的情况。默认则以块数为单位。</li>
</ul>
<p>带有<code>-x</code>选项后，会打印更多信息：</p>
<ul>
<li>rrqm/s：每秒这个设备相关的读取请求有多少被Merge了（当系统调用需要读取数据的时候，VFS将请求发到各个FS，如果FS发现不同的读取请求读取的是相同Block的数据，FS会将这个请求合并Merge）；</li>
<li>wrqm/s：每秒这个设备相关的写入请求有多少被Merge了。</li>
<li>r/s 与 w/s：（合并后）每秒读取/写入请求次数</li>
<li>rsec/s 与 wsec/s：每秒读取/写入扇区的数目</li>
<li>avgrq-sz：请求的平均大小（以扇区计）</li>
<li>avgqu-sz：平均请求队列长度</li>
<li>await：每一个IO请求的处理的平均时间（单位是毫秒）</li>
<li>r_await/w_await：读/写的平均响应时间。</li>
<li>%util：设备的带宽利用率，IO时间占比。在统计时间内所有处理IO时间。一般该参数是100%表示设备已经接近满负荷运行了。</li>
</ul>
<h3 id="常用方法">常用方法</h3>
<p>收集 <code>/dev/dfa</code> 的IO信息，按kB计算，每秒一次，连续 10 次。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>iostat -dxk /dev/dfa <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span></code></pre></div><h3 id="数据来源-2">数据来源</h3>
<p>其实是从下面几个文件中提取信息的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/proc/stat contains system statistics.
</span></span><span style="display:flex;"><span>/proc/uptime contains system uptime.
</span></span><span style="display:flex;"><span>/proc/partitions contains disk statistics (for pre 2.5 kernels that have been patched).
</span></span><span style="display:flex;"><span>/proc/diskstats contains disks statistics (for post 2.5 kernels).
</span></span><span style="display:flex;"><span>/sys contains statistics for block devices (post 2.5 kernels).
</span></span><span style="display:flex;"><span>/proc/self/mountstats contains statistics for network filesystems.
</span></span><span style="display:flex;"><span>/dev/disk contains persistent device names.
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-569b13a844f150eabaf244a714138e15">源码编译安装 PostGIS</h1>
	<div class="lead">PostGIS是PG的杀手锏插件，但编译安装可不容易。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2017-09-07" class="text-muted">2017年09月07日</time>
        
	</div>
	<hr>
<p>强烈建议使用使用 yum / apt 命令从 PostgreSQL 官方二进制仓库安装 PostGIS。</p>
<blockquote>
<p>参考<a href="http://www.postgresonline.com/journal/archives/362-An-almost-idiots-guide-to-install-PostgreSQL-9.5,-PostGIS-2.2-and-pgRouting-2.1.0-with-Yum.html">http://www.postgresonline.com/journal/archives/362-An-almost-idiots-guide-to-install-PostgreSQL-9.5,-PostGIS-2.2-and-pgRouting-2.1.0-with-Yum.html</a></p>
</blockquote>
<hr>
<h3 id="1-安装环境">1. 安装环境</h3>
<ul>
<li>CentOS 7</li>
<li>PostgreSQL10</li>
<li>PostGIS2.4</li>
<li>PGROUTING2.5.2</li>
</ul>
<hr>
<h3 id="2-postgresql10安装">2. PostgreSQL10安装</h3>
<h5 id="21-确定系统环境">2.1 确定系统环境</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ uname -a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Linux localhost.localdomain 3.10.0-693.el7.x86_64 <span style="color:#8f5902;font-style:italic">#1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span>
</span></span></code></pre></div><h5 id="22-安装正确的rpm包">2.2 安装正确的rpm包</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>  <span style="color:#000">rpm</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">ivh</span> <span style="color:#000">https</span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">//</span><span style="color:#000">download</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">postgresql</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">org</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pub</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">repos</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">yum</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">redhat</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">rhel</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">x86_64</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgdg</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">centos10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2.</span><span style="color:#000">noarch</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">rpm</span>
</span></span></code></pre></div><p>不同的系统使用不同的rpm源，你可以从 <a href="http://yum.postgresql.org/repopackages.php">http://yum.postgresql.org/repopackages.php</a> 获取相应的平台链接。</p>
<h5 id="23-查看rpm包是否正确安装">2.3 查看rpm包是否正确安装</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>yum list | grep pgdg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pgdg-centos10.noarch                        10-2                       installed
</span></span><span style="display:flex;"><span>CGAL.x86_64                                 4.7-1.rhel7                pgdg10
</span></span><span style="display:flex;"><span>CGAL-debuginfo.x86_64                       4.7-1.rhel7                pgdg10
</span></span><span style="display:flex;"><span>CGAL-demos-source.x86_64                    4.7-1.rhel7                pgdg10
</span></span><span style="display:flex;"><span>CGAL-devel.x86_64                           4.7-1.rhel7                pgdg10
</span></span><span style="display:flex;"><span>MigrationWizard.noarch                      1.1-3.rhel7                pgdg10
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h5 id="24-安装pg">2.4 安装PG</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>yum install -y postgresql10 postgresql10-server postgresql10-libs postgresql10-contrib postgresql10-devel
</span></span></code></pre></div><p>你可以根据需要选择安装相应的rpm包。</p>
<h5 id="25-启动服务">2.5 启动服务</h5>
<p>默认情况下，PG安装目录为<code>/usr/pgsql-10/</code>，data目录为<code>/var/lib/pgsql/</code>,系统默认创建用户<code>postgres</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#000">passwd</span> <span style="color:#000">postgres</span> <span style="color:#8f5902;font-style:italic"># 为系统postgres设置密码</span>
</span></span><span style="display:flex;"><span><span style="color:#000">su</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">postgres</span> 	<span style="color:#8f5902;font-style:italic"># 切换到用户postgres</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">usr</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">bin</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">initdb</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">D</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span>	<span style="color:#8f5902;font-style:italic"># 初始化数据库</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">usr</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">bin</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pg_ctl</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">D</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">lib</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">l</span> <span style="color:#000">logfile</span> <span style="color:#000">start</span>	<span style="color:#8f5902;font-style:italic"># 启动数据库</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">usr</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">bin</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">psql</span> <span style="color:#000">postgres</span> <span style="color:#000">postgres</span>	<span style="color:#8f5902;font-style:italic"># 登录</span>
</span></span></code></pre></div><h3 id="3-postgis安装">3. PostGIS安装</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>yum install postgis24_10-client postgis24_10
</span></span></code></pre></div><blockquote>
<p>如果遇到错误如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>--&gt; 解决依赖关系完成
</span></span><span style="display:flex;"><span>错误：软件包：postgis24_10-client-2.4.2-1.rhel7.x86_64 (pgdg10)
</span></span><span style="display:flex;"><span>          需要：libproj.so.0()(64bit)
</span></span><span style="display:flex;"><span>错误：软件包：postgis24_10-2.4.2-1.rhel7.x86_64 (pgdg10)
</span></span><span style="display:flex;"><span>          需要：gdal-libs &gt;= 1.9.0
</span></span></code></pre></div><p>你可以尝试通过以下命令解决:<code>yum -y install epel-release</code></p>
</blockquote>
<h3 id="4-fdw安装">4. fdw安装</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>yum install ogr_fdw10
</span></span></code></pre></div><h3 id="5-pgrouting安装">5. pgrouting安装</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>yum install pgrouting_10
</span></span></code></pre></div><h3 id="6-验证测试">6. 验证测试</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># 登录pg后执行以下命令，无报错则证明成功
</span></span><span style="display:flex;"><span>CREATE EXTENSION postgis;
</span></span><span style="display:flex;"><span>CREATE EXTENSION postgis_topology;
</span></span><span style="display:flex;"><span>CREATE EXTENSION ogr_fdw;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SELECT postgis_full_version();
</span></span></code></pre></div><hr>
<h2 id="编译工具">编译工具</h2>
<p>此类工具一般系统都自带。</p>
<ul>
<li>GCC与G++，版本至少为<code>4.x</code>。</li>
<li>GNU Make，CMake， Autotools</li>
<li>Git</li>
</ul>
<p>CentOS下直接通过<code>sudo yum install gcc gcc-c++ git autoconf automake libtool m4 </code>安装。</p>
<hr>
<h2 id="必选依赖">必选依赖</h2>
<h3 id="postgresql">PostgreSQL</h3>
<p>PostgreSQL是PostGIS的宿主平台。这里以10.1为例。</p>
<h3 id="geos">GEOS</h3>
<p>GEOS是Geometry Engine, Open Source的缩写，是一个C++版本的几何库。是PostGIS的核心依赖。</p>
<p>PostGIS 2.4用到了GEOS 3.7的一些新特性。不过截止到现在，GEOS官方发布的最新版本是3.6.2，3.7版本的GEOS可以通过<a href="http://geos.osgeo.org/snapshots/">Nightly snapshot</a> 获取。所以目前如果希望用到所有新特性，需要从源码编译安装GEOS 3.7。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 滚动的每日更新，此URL有可能过期，检查这里http://geos.osgeo.org/snapshots/</span>
</span></span><span style="display:flex;"><span>wget -P ./ http://geos.osgeo.org/snapshots/geos-20171211.tar.bz2
</span></span><span style="display:flex;"><span>tar -jxf geos-20171211.tar.bz2
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> geos-20171211
</span></span><span style="display:flex;"><span>./configure
</span></span><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span>sudo make install
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> ..
</span></span></code></pre></div><h3 id="proj">Proj</h3>
<p>为PostGIS提供坐标投影支持，目前最新版本为4.9.3 ：<a href="http://proj4.org/download.html">下载</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 此URL有可能过期，检查这里http://proj4.org/download.html</span>
</span></span><span style="display:flex;"><span>wget -P . http://download.osgeo.org/proj/proj-4.9.3.tar.gz
</span></span><span style="display:flex;"><span>tar -zxf proj-4.9.3.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> proj-4.9.3
</span></span><span style="display:flex;"><span>make 
</span></span><span style="display:flex;"><span>sudo make install
</span></span></code></pre></div><h3 id="json-c">JSON-C</h3>
<p>目前用于导入GeoJSON格式的数据，函数<code>ST_GeomFromGeoJson</code>用到了这个库。</p>
<p>编译<code>json-c</code>需要用到<code>autoconf, automake, libtool</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/json-c/json-c
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> json-c
</span></span><span style="display:flex;"><span>sh autogen.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>./configure  <span style="color:#8f5902;font-style:italic"># --enable-threading</span>
</span></span><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span>make install
</span></span></code></pre></div><h3 id="libxml2">LibXML2</h3>
<p>目前用于导入GML与KML格式的数据，函数<code>ST_GeomFromGML</code>和<code>ST_GeomFromKML</code>依赖这个库。</p>
<p>目前可以在这个<a href="ftp://xmlsoft.org/libxml2/">FTP</a>服务器上搞到，目前使用的版本是<code>2.9.7</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tar -zxf libxml2-sources-2.9.7.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> libxml2-sources-2.9.7
</span></span><span style="display:flex;"><span>./configure
</span></span><span style="display:flex;"><span>make 
</span></span><span style="display:flex;"><span>sudo make install
</span></span></code></pre></div><h3 id="gadl">GADL</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget -P . http://download.osgeo.org/gdal/2.2.3/gdal-2.2.3.tar.gz
</span></span></code></pre></div><h3 id="sfcgal">SFCGAL</h3>
<p>SFCGAL是CGAL的扩展包装，虽说是可选项，但是很多函数都会经常用到，因此这里也需要安装。<a href="http://oslandia.github.io/SFCGAL/installation.html">下载页面</a></p>
<p>SFCGAL依赖的东西比较多。包括<code>CMake, CGAL, Boost, MPFR, GMP</code>等，其中，<code>CGAL</code>在上面手动安装过了。这里还需要手动安装BOOST</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget -P . https://github.com/Oslandia/SFCGAL/archive/v1.3.0.tar.gz
</span></span></code></pre></div><h3 id="boost">Boost</h3>
<p>Boost是C++的常用库，SFCGAL依赖BOOST，<a href="http://www.boost.org">下载页面</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget -P . https://dl.bintray.com/boostorg/release/1.65.1/source/boost_1_65_1.tar.gz
</span></span><span style="display:flex;"><span>tar -zxf boost_1_65_1.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> boost_1_65_1
</span></span><span style="display:flex;"><span>./bootstrap.sh
</span></span><span style="display:flex;"><span>./b2
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-a119d2b10267d52b4af6df40d6c9ab02">PostgreSQL MongoFDW安装部署</h1>
	<div class="lead">最近有业务要求通过PostgreSQL FDW去访问MongoDB。开始我觉得这是个很轻松的任务。但接下来的事真是让人恶心的吐了。MongoDB FDW编译起来真是要人命：混乱的依赖，临时下载和Hotpatch，错误的编译参数，以及最过分的是错误的文档。总算，我在生产环境(Linux RHEL7u2)和开发环境(Mac OS X 10.11.5)都编译成功了。赶紧记录下来，省的下次蛋疼。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2016-05-28" class="text-muted">2016年05月28日</time>
        
	</div>
	<blockquote>
<p>更新：最近MongoFDW已经由Cybertech接手维护，也许没有这么不堪了。</p>
</blockquote>
<p>最近有业务要求通过PostgreSQL FDW去访问MongoDB。开始我觉得这是个很轻松的任务。但接下来的事真是让人恶心的吐了。MongoDB FDW编译起来真是要人命：混乱的依赖，临时下载和Hotpatch，错误的编译参数，以及最过分的是错误的文档。总算，我在生产环境(Linux RHEL7u2)和开发环境(Mac OS X 10.11.5)都编译成功了。赶紧记录下来，省的下次蛋疼。</p>
<hr>
<h2 id="环境概述">环境概述</h2>
<p>理论上编译这套东西，GCC版本至少为4.1。
生产环境 (RHEL7.2 + PostgreSQL9.5.3 + GCC 4.8.5)
本地环境 (Mac OS X 10.11.5 + PostgreSQL9.5.3 + clang-703.0.31)</p>
<hr>
<h2 id="mongo_fdw的依赖"><code>mongo_fdw</code>的依赖</h2>
<p>总的来说，能用包管理解决的问题，尽量用包管理解决。
<a href="https://github.com/EnterpriseDB/mongo_fdw" title="mongo_fdw">mongo_fdw</a>是我们最终要安装的包
它的直接依赖有三个：</p>
<ul>
<li><a href="https://github.com/json-c/json-c/tree/json-c-0.12" title="json-c 0.12">json-c 0.12</a></li>
<li><a href="https://github.com/mongodb/mongo-c-driver/tree/r1.3" title="libmongoc-1.3.1">libmongoc-1.3.1</a></li>
<li><a href="https://github.com/mongodb/libbson/tree/r1.3" title="libbson-1.3.1">libbson-1.3.1</a></li>
</ul>
<p>总的来说，mongo_fdw是使用mongo提供的C驱动程序完成功能的。所以我们需要安装libbson与libmongoc。其中libmongoc就是MongoDB的C语言驱动库，它依赖于libbson。
所以最后的安装顺序是：
<code>libbson</code> → <code>libmongoc</code> → <code>json-c</code>→ <code>mongo_fdw</code></p>
<hr>
<h2 id="间接依赖">间接依赖</h2>
<p>默认依赖的GNU Build全家桶，文档是不会告诉你的。下面列出一些比较简单的，可以通过包管理解决的依赖。请一定按照以下顺序安装<code>GNU Autotools</code></p>
<p><code>m4-1.4.17</code> → <code>autoconf-2.69</code> → <code>automake-1.15</code> → <code>libtool-2.4.6</code> → <code>pkg-config-0.29.1</code>。</p>
<p>总之，用yum也好，apt也好，homebrew也好，都是一行命令能搞定的事。 还有一个依赖是libmongoc的依赖：<code>openssl-devel</code>，不要忘记装。</p>
<hr>
<h3 id="安装-libbson-131">安装 <code>libbson-1.3.1</code></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone -b r1.3 https://github.com/mongodb/libbson<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> libbson<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>git checkout 1.3.1<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>./autogen.sh<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>make <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo make install<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>make test<span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><hr>
<h3 id="安装-libmongoc-131">安装 <code>libmongoc-1.3.1</code></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone -b r1.3 https://github.com/mongodb/mongo-c-driver
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> mongo-c-driver<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>git checkout 1.3.1<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>./autogen.sh<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下一步很重要，一定要使用刚才安装好的系统中的libbson。</span>
</span></span><span style="display:flex;"><span>./configure --with-libbson<span style="color:#ce5c00;font-weight:bold">=</span>system<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>make <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo make install<span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>这里为什么要使用1.3.1的版本？这也是有讲究的。因为mongo_fdw中默认使用的是1.3.1的mongo-c-driver。但是它在文档里说只要1.0.0+就可以，其实是在放狗屁。mongo-c-driver与libbson版本是一一对应的。1.0.0版本的libbson脑子被驴踢了，使用了超出C99的特性，比如复数类型。要是用了默认版本就傻逼了。</p>
<hr>
<h4 id="安装json-c">安装<code>json-c</code></h4>
<p>首先，我们来解决json-c的问题</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/json-c/json-c<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> json-c
</span></span><span style="display:flex;"><span>git checkout json-c-0.12
</span></span></code></pre></div><ul>
<li><code>./configure</code>完了可不要急着Make，这个版本的json-c编译参数有问题。</li>
<li>打开Makefile，找到<code>CFLAGS</code>,在编译参数后面添加<code>-fPIC</code></li>
<li>这样GCC会生成位置无关代码，不这样做的话mongo_fdw链接会报错。</li>
</ul>
<hr>
<h3 id="安装-mongo_fdw">安装 <code>mongo_fdw</code></h3>
<p>真正恶心的地方来咯。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/EnterpriseDB/mongo_fdw<span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>好了，如果这时候想当然的运行<code>./autogen.sh --with-master</code>，它就会去重新下一遍上面几个包了……，而且都是从墙外亚马逊的云主机去下。靠谱的方法就是手动一条条的执行autogen里面的命令。</p>
<p>首先把上面的json-c目录复制到mongo_fdw的根目录内。 然后添加libbson和libmongoc的include路径。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">C_INCLUDE_PATH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/usr/local/include/libbson-1.0/:/usr/local/include/libmongoc-1.0:</span><span style="color:#000">$C_INCLUDE_PATH</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div><p>查看<code>autogen.sh</code>，发现里面根据<code>--with-legacy</code>和<code>--with-master</code>的不同选项，会有不同的操作。具体来说，当指定<code>--with-master</code>选项时，它会创建一个config.h,里面定义了一个META_DRIVER的宏变量。当有这个宏变量时，mongo_fdw会使用mongoc.h头文件，也就是所谓的“master”，新版的mongo驱动。当没有时，则会使用&quot;mongo.h&quot;头文件，也就是老版的mongo驱动。这里，我们直接<code>vi config.h</code>，添加一行</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define META_DRIVER</span>
</span></span></code></pre></div><p>这时候，基本上才能算万事大吉。 在最终build之前，别忘了执行：<code>ldconfig</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo ldconfig
</span></span></code></pre></div><p>回到mongo_fdw根目录<code>make</code>，不出意外，这个<code>mongo_fdw.so</code>就出来了。</p>
<hr>
<h3 id="试一试吧">试一试吧？</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo make install<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>psql
</span></span><span style="display:flex;"><span><span style="color:#000">admin</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># CREATE EXTENSION mongo_fdw;</span>
</span></span></code></pre></div><p>如果提示找不到 <code>libmongoc.so</code> 和 <code>libbson.so</code>，直接把它们丢进pgsql的lib目录即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo cp /usr/local/lib/libbson* /usr/local/pgsql/lib/
</span></span><span style="display:flex;"><span>sudo cp /usr/local/lib/libmongoc* /usr/local/pgsql/lib/
</span></span></code></pre></div>
</div>





    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Mail" aria-label="Mail">
    <a target="_blank" rel="noopener" href="mailto:rh@vonng.com" aria-label="Mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Vonng/pigsty" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://twitter.com/GobeUncleWang" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="WeChat" aria-label="WeChat">
    <a target="_blank" rel="noopener" href="/img/pigsty/pigsty-cc.jpg" aria-label="WeChat">
      <i class="fa fa-comment"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Discord" aria-label="Discord">
    <a target="_blank" rel="noopener" href="https://discord.gg/wDzt5VyWEz" aria-label="Discord">
      <i class="fab fa-discord"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Telegram" aria-label="Telegram">
    <a target="_blank" rel="noopener" href="https://t.me/joinchat/gV9zfZraNPM3YjFh" aria-label="Telegram">
      <i class="fab fa-telegram"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2018&ndash;2024
    <span class="td-footer__authors">Ruohang Feng</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span></span><span class="ms-2"><a href="https://vonng.com/en/" target="_blank" rel="noopener">@Vonng</a></span>
<br><span>Pigsty® distributed under <a href="/docs/about/license" target="_blank" rel="noopener">AGPLv3</a></span>
<br><span class="ms-2"><a href="/docs/about/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
<span><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">浙ICP备15016890号</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.248655eb216150e39da254c2f7aa5357805d0ec66bdb741b591cd35fb5f629ab.js" integrity="sha256-JIZV6yFhUOOdolTC96pTV4BdDsZr23QbWRzTX7X2Kas=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
