<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="/zh/blog/dev/">
<link rel="alternate" type="application/rss&#43;xml" href="/zh/blog/dev/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>PG 开发 | Pigsty</title>
<meta name="description" content="使用 PostgreSQL 进行开发的经验
">
<meta property="og:title" content="PG 开发" />
<meta property="og:description" content="使用 PostgreSQL 进行开发的经验
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/zh/blog/dev/" />

<meta itemprop="name" content="PG 开发">
<meta itemprop="description" content="使用 PostgreSQL 进行开发的经验
"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="PG 开发"/>
<meta name="twitter:description" content="使用 PostgreSQL 进行开发的经验
"/>




<link rel="preload" href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" as="style">
<link href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="/js/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LG1V9WTKGE');
}
</script>
  </head>
  <body class="td-section td-blog">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/zh/"><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class="navbar-brand__name">Pigsty</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/zh/docs/"><i class='fa-solid fa-book'></i><span>文档</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="/zh/blog/"><i class="fas fa-blog"></i><span>博客</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/Vonng/pigsty/" target="_blank" rel="noopener"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-language"></i>中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/">English</a></li>
    </ul>
</div>
</li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.011e02030147fde734a4f267f81bb5be.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/zh/blog/dev/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">PG 开发</h1>
<div class="lead">使用 PostgreSQL 进行开发的经验</div>




    <ul>
    
  
  
  
  

  
    
    
	

    <li><a href="#pg-f4c27180e5738b29e02b7307c1b016f6">AI大模型与向量库 PGVector</a></li>



    
  
    
    
	

    <li><a href="#pg-8d4491a0bd13c54cde6e64007c9ef59e">高级模糊查询的实现</a></li>



    
  
    
    
	

    <li><a href="#pg-fdb1c15b0c04ebe045dd75e87370761a">前后端通信线缆协议</a></li>



    
  
    
    
	

    <li><a href="#pg-459077b7c73927d841574630d5fb1203">事务隔离等级注意事项</a></li>



    
  
    
    
	

    <li><a href="#pg-12d8dcfa24f5ab1593a638e88358ce04">CDC 变更数据捕获机理</a></li>



    
  
    
    
	

    <li><a href="#pg-15d5b18d2862f9fbfdff194078c65cf9">PostgreSQL中的锁</a></li>



    
  
    
    
	

    <li><a href="#pg-fe20fb7726e2595e3268f850de55df30">GIN搜索的O(n2)负载度</a></li>



    
  
    
    
	

    <li><a href="#pg-ebb4721027589fb8a3f47ae4caff080f">GeoIP 地理逆查询优化</a></li>



    
  
    
    
	

    <li><a href="#pg-80c8b198e057fa55db537cdeda973043">PostgreSQL的触发器使用注意事项</a></li>



    
  
    
    
	

    <li><a href="#pg-3c4b38169b51bfb4104cc9af240429b9">PostgreSQL开发规约（2018版）</a></li>



    
  
    
    
	

    <li><a href="#pg-ee6b9008dea2b9404e580577dbbf6c1c">KNN极致优化：从RDS到PostGIS</a></li>



    
  
    
    
	

    <li><a href="#pg-e5e998a993afb8408dd753d1b977cbd7">PostGIS高效解决行政区划归属查询</a></li>



    
  
    
    
	

    <li><a href="#pg-659c08c6c874927030074eb057103d46">Distinct On 去除重复数据</a></li>



    
  
    
    
	

    <li><a href="#pg-a16ee378342d35474dbed535e852f3ea">函数易变性等级分类</a></li>



    
  
    
    
	

    <li><a href="#pg-a586e1f27bf6289d48a1f51adcf91003">用 Exclude 实现互斥约束</a></li>



    
  
    
    
	

    <li><a href="#pg-2cb08544888a300f2e54d97bbb6b50ce">GO与PG实现缓存同步</a></li>



    
  
    
    
	

    <li><a href="#pg-aabc7bc725071559d5d7f1427e2a2a1f">用触发器审计数据变化</a></li>



    
  
    
    
	

    <li><a href="#pg-6b7c38ff19f28b80c8a27b522ff4ecea">SQL实现ItemCF推荐系统</a></li>



    
  
    
    
	

    <li><a href="#pg-553b99cdb5eb8e33ac93dd13977c3840">UUID性质原理与应用</a></li>



    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-f4c27180e5738b29e02b7307c1b016f6">AI大模型与向量库 PGVector</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>） | <a href="https://mp.weixin.qq.com/s/R4jp1uTCiLOLGsiADZ9jxQ">微信公众号</a></b> |
        
		<time datetime="2023-05-10" class="text-muted">2023年05月10日</time>
        
	</div>
	<p>新 AI 应用在过去一年中出现了指数爆炸的增长态势，而这些应用面临的一个共同挑战是如何大规模地<strong>存储</strong>与<strong>查询</strong>以向量表示的 AI Embedding。本文聚焦被 AI 炒火了的<strong>向量数据库</strong>，介绍了AI嵌入与向量存储检索的基本原理，并用一个具体的知识库检索案例来串联介绍向量数据库插件 <strong>PGVECTOR</strong> 的功能、性能、获取与应用。</p>
<hr>
<h2 id="ai是怎么工作的">AI是怎么工作的</h2>
<p>GPT 展现出来了强大的智能水平，它的成功有很多因素，但在工程上关键的一步是：<strong>神经网络与大语言模型将一个语言问题转化为数学问题，并使用工程手段高效解决了这个数学问题</strong>。</p>
<p>对于AI来说，各种各样的知识与概念在内部都使用数学向量来存储表示输入输出。将词汇/文本/语句/段落/图片/音频各种对象转换为数学向量的这个过程被叫做<strong>嵌入</strong>（<strong>Embedding</strong>）。</p>
<p>例如 OpenAI 就使用 <strong>1536</strong> 维的浮点数向量空间。当你问 ChatGPT 一个问题时，输入的文本首先被编码转换成为一个<strong>数学向量</strong>，才能作为神经网络的输入。而神经网络的直接输出结果，也是一个向量，向量被重新解码为人类的自然语言或其他形式，再呈现到人类眼前。</p>
<p><img alt="llm-pgvector-1.jpeg" src="/zh/blog/dev/llm-and-pgvector/llm-pgvector-1.jpeg"></p>
<p>人工智能大模型的“思考过程”，在数学上就是一系列向量与矩阵之间的加乘正逆运算。这种向量对于人类来说过于抽象，无法理解。但这种形式很适合使用 GPU/FPGA/ASIC 这样的专用硬件来高效实现 —— AI 有了一个硅基的仿生大脑，带有更多的神经元，更快的处理速度，以及更强大的学习算法，惊人的智能水平，高速自我复制与永生的能力。</p>
<p>语言大模型解决的是 <strong>编码</strong> - <strong>运算</strong> - <strong>输出</strong> 的问题，但是只有计算是不够的，还有一个重要的部分是<strong>记忆</strong>。大模型本身可以视作人类公开数据集的一个压缩存储，这些知识通过训练被编码到了模型中，内化到了模型的权重参数里。<strong>而精确性的，长期性的，过程性的，大容量的外部记忆存储，就需要用到向量数据库了。</strong></p>
<p><img alt="llm-pgvector-2.png" src="/zh/blog/dev/llm-and-pgvector/llm-pgvector-2.png"></p>
<p>所有的概念都可以用向量来表示，而向量空间有一些很好的数学性质，比如可以计算两个向量的“<strong>距离</strong>”。<strong>这意味着任意两个抽象概念之间的“相关性”，都可以用对应编码向量的距离来衡量</strong>。</p>
<p>这个看上去简单的功能却有着非常强大的效果，例如最经典的应用场景就是搜索。比如，您可以预处理你的知识库，将每个文档都是用模型转换成抽象向量存储在向量数据库中，当你想要检索时，只需要将您的问题也用模型编码成为一个一次性的查询向量，并在数据库中找到与此查询向量“**距离最近“**的文档作为回答返回给用户即可。</p>
<p><img alt="llm-pgvector-3.jpeg" src="/zh/blog/dev/llm-and-pgvector/llm-pgvector-3.jpeg"></p>
<p>通过这种方式，一个模糊而困难的自然语言处理问题，转换成为了一个简单清晰的数学问题。而向量数据库，就可以用来高效地解决这个数学问题。</p>
<hr>
<h2 id="向量数据库能干什么">向量数据库能干什么？</h2>
<p>数据库有事务处理（OLTP）与数据分析（OLAP）两大核心场景，向量数据库自然也不例外。典型的事务处理场景包括：知识库，问答，推荐系统，人脸识别，图片搜索，等等等等。知识问答：给出一个自然语言描述的问题，返回与这些输入最为接近的结果；以图搜图：给定一张图片，找出与这张图片在逻辑上最接近的其他相关图片。</p>
<p>这些功能说到底都是一个共同的数学问题：**向量最近邻检索（KNN）：**给定一个向量，找到距离此向量最近的其他向量。</p>
<p>典型的分析场景是<strong>聚类</strong>：将一系列向量按照距离亲疏远近分门别类，找出内在的关联结构，并对比急簇之间的差异。</p>
<p><img alt="llm-pgvector-4.jpeg" src="/zh/blog/dev/llm-and-pgvector/llm-pgvector-4.jpeg"></p>
<hr>
<h2 id="pg向量插件-pgvector">PG向量插件 PGVECTOR</h2>
<p>市面上有许多向量数据库产品，商业的有 Pinecone，Zilliz，开源的有 Milvus，Qdrant 等，基于已有流行数据库以插件形式提供的则有 <code>pgvector</code> 与 Redis Stack。</p>
<p>在所有现有向量数据库中，<strong>pgvector</strong> 是一个独特的存在 —— 它选择了在现有的世界上最强大的开源关系型数据库 PostgreSQL 上以插件的形式添砖加瓦，而不是另起炉灶做成另一个专用的“数据库” [1]。<strong>pgvector</strong> 有着优雅简单易用的接口，不俗的性能表现，更是继承了PG生态的超能力集合。</p>
<p><img alt="llm-pgvector-5.png" src="/zh/blog/dev/llm-and-pgvector/llm-pgvector-5.png"></p>
<p><strong>一个合格的向量数据库，首先得是一个合格的数据库，而从零开始做到这一点并不容易</strong>。<strong>比起使用一种全新的独立数据库品类，为现有数据库加装向量搜索的能力显然是一个更为务实，简单，经济的选择</strong>。</p>
<hr>
<h2 id="pgvector-知识检索案例">PGVECTOR 知识检索案例</h2>
<p>下面我们通过一个具体的例子演示 PGVECTOR 这样的向量数据库是如何工作的。</p>
<h3 id="模型">模型</h3>
<p>OpenAI 提供了将自然语言文本转换为数学向量的 API ：例如 <code>text-embedding-ada-002</code> ，便可以将最长2048～8192个字符的句子/文档转换为一个 1536 维的向量。但是这里我们选择使用 HuggingFace 上的 <code>shibing624/text2vec-base-chinese</code> 模型替代 OpenAI 的 API 完成文本到向量的转换。</p>
<p>这个模型针对中文语句进行了优化，尽管没有 OpenAI 模型有那样深入的语义理解能力，但它是开箱即用的，使用 <code>pip install torch text2vec</code> 即可完成安装，而且可以在本地CPU上运行，完全开源免费。您可以随时换用其他模型：基本用法是类似的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">text2vec</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">SentenceModel</span> 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 自动下载并加载模型</span>
</span></span><span style="display:flex;"><span><span style="color:#000">model</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SentenceModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;shibing624/text2vec-base-chinese&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">sentence</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;这里是你想编码的文本输入&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">vec</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">model</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sentence</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>使用以上代码片段即可将任意长度在512内的中文语句编码为 768 维的向量。拆分后只需要调用模型的编码（encode）方法，即可将文本转换为数学向量。对于很长的大文档，您需要合理地将文档与知识库拆分成一系列长度得当的段落。</p>
<h3 id="存储">存储</h3>
<p>编码后的结果，在 PostgreSQL 中使用形如 <code>ARRAY[1.1,2.2,...]</code> 这样的浮点数组形式表示。这里我们跳过数据清洗灌入的琐碎细节，总之在一番操作后有了一张语料数据表 <code>sentences</code>，一个 <code>txt</code> 字段来存储原始文本表示，并使用一个额外的 <code>vec</code> 字段存储文本编码后的 768 维向量。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vector</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sentences</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">BIGINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- 标识    txt   TEXT NOT NULL,       -- 文本    vec   VECTOR(768) NOT NULL -- 向量);
</span></span></span></code></pre></div><p>这张表和普通的数据库表并没有任何区别，你可以用一模一样的增删改查语句。特殊的地方在于 <code>pgvector</code> 扩展提供了一种新的数据类型 <code>VECTOR</code> ，以及相应的几种距离函数、运算符与对应的索引类型，允许您高效地完成向量最近邻搜索。</p>
<h3 id="查询">查询</h3>
<p>这里我们只需要用一个简易的 Python 小脚本，就可以制作一个全文模糊检索的命令行小工具：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># !/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">text2vec</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">SentenceModel</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">psycopg2</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">connect</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">model</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SentenceModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;shibing624/text2vec-base-chinese&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">query</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">question</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limit</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vec</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">model</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">question</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic"># 生成一个一次性的编码向量，默认查找最接近的64条记录</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">item</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;ARRAY[&#39;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#39;,&#39;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">join</span><span style="color:#000;font-weight:bold">([</span><span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">f</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">vec</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">tolist</span><span style="color:#000;font-weight:bold">()])</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#39;]::VECTOR(768)&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cursor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">connect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;postgres:///&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cursor</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cursor</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">execute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;&#34;SELECT id, txt, vec &lt;-&gt; </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06"> AS d FROM sentences ORDER BY 3 LIMIT </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">;&#34;&#34;&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">item</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limit</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">txt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">distance</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">cursor</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">fetchall</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">%-6d</span><span style="color:#4e9a06"> [</span><span style="color:#4e9a06">%.3f</span><span style="color:#4e9a06">]</span><span style="color:#4e9a06">\t</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">distance</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">txt</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><p><img alt="llm-pgvector-6.png" src="/zh/blog/dev/llm-and-pgvector/llm-pgvector-6.png"></p>
<hr>
<h2 id="pgvector-的性能">PGVECTOR 的性能</h2>
<p>当功能、正确性、安全性满足需求后，用户的目光就会转向<strong>性能</strong>。PGVECTOR 有着不错的性能表现，尽管比起专用的高性能向量计算Library来说有些差距，但性能对于生产环境中使用已经是绰绰有余了。</p>
<p>对于向量数据库来说，最近邻查询的延迟是一个重要的性能指标，<strong>ANN-Benchmark</strong> 则是一个相对权威的最近邻性能评测基准[2]。pgvector 的索引算法是 ivfflat ，在几个常见的基准测试中表现如下图所示：</p>
<p><img alt="llm-pgvector-7.png" src="/zh/blog/dev/llm-and-pgvector/llm-pgvector-7.png"></p>
<p>为了对 <code>pgvector</code> 的性能表现在直觉上有一个把握，在 M1 Max 芯片 Macbook 下单核运行一些简单的测试：从1百万条随机 1536 维向量（正好是 OpenAI 的输出向量维度）中找出余弦距离最近的TOP 1 ～ 50 条向量，每次耗时大约 8ms 。从 1 亿条随机 128 维向量 （SIFT图像数据集的维度）中找出 L2 欧几里得距离 TOP 1 向量耗时 5ms，TOP 100 耗时也只要 21ms 。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 1M 个 1536 维向量，随机取 TOP1～50，余弦距离， 单核：插入与索引耗时均为5～6分钟，大小8GB左右。随机向量最近邻 Top1 召回：8ms
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vtest</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vtest</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">VECTOR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1536</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">TRUNCATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vtest</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vtest</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">random_array</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1536</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#000">vector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1536</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">generate_series</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vtest</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ivfflat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vector_cosine_ops</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lists</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">probe</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">random_array</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1536</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#000">VECTOR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1536</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vtest</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;=&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">probe</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">limit</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 简易SIFT ，1亿个128维向量，测试L2距离，召回1个最近向量， 5 ms， 召回最近100个向量：21ms
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vtest</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vtest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">VECTOR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">TRUNCATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vtest</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vtest</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">random_array</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#000">vector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">generate_series</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100000000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vtest</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ivfflat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vector_l2_ops</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lists</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">probe</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">random_array</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#000">VECTOR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vtest</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;-&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">probe</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">limit</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- LIMIT 100
</span></span></span></code></pre></div><p>使用真实的 SIFT 1M 数据集来测试，找出测试集中1万条向量在1百万条基础向量集中的最近邻单核总共只需18秒，单次查询的延迟在 1.8 ms ，折合单核500 QPS，可以说是相当不错了。当然对于 PostgreSQL 这样的成熟数据库来说，你总可以简单地通过加核数与拖从库来近乎无限地扩容其QPS吞吐量。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- SIFT 1M 数据集，128维embedding，使用ivfflat索引, L2距离，10K测试向量集。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sift_base</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sift_base</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIGINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">VECTOR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sift_query</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sift_query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIGINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">VECTOR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sift_base</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ivfflat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vector_l2_ops</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lists</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 一次性寻找 sift_query 表中 10000 条向量在 sift_base 表中的最近邻 Top1: 单进程 18553ms / 10000 Q = 1.8ms
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">explain</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">analyze</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">q</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sift_query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">q</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">LATERAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sift_base</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;-&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">q</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">limit</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 单次随机查询耗时在 个位数毫秒
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">probe</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sift_query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">random</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">999</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">BIGINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sift_base</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;-&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">probe</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="如何获取-pgvector">如何获取 PGVECTOR？</h2>
<p>最后，我们来聊一聊，如何快速获取一个可用的 PGVECTOR ？</p>
<p>在以前，PGVECTOR 需要自行下载编译安装，所以我提了一个 Issue 把它加入到 PostgreSQL 全球开发组的官方仓库中[5]。你只需要正常使用 PGDG 源即可直接 <code>yum install pgvector_15</code> 完成安装。在安装了 <code>pgvector</code> 的数据库实例中使用 <code>CREATE EXTENSION vector</code> 即可启用此扩展。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>CREATE EXTENSION vector;
</span></span><span style="display:flex;"><span>CREATE TABLE items (vec vector(2));
</span></span><span style="display:flex;"><span>INSERT INTO items (vec) VALUES (&#39;[1,1]&#39;), (&#39;[-2,-2]&#39;), (&#39;[-3,4]&#39;);
</span></span><span style="display:flex;"><span>SELECT *, vec &lt;=&gt; &#39;[0,1]&#39; AS d FROM items ORDER BY 2 LIMIT 3;
</span></span></code></pre></div><p>更简单的选择是本地优先的开源 RDS PostgreSQL 替代 —— Pigsty ，在三月底发布的v2.0.2 中， <code>pgvector</code> 已经默认启用，开箱即用。您可以在一台全新虚拟机上一键完成安装，自带时序地理空间向量插件，监控备份高可用齐全。分文不收，立等可取。</p>
<p><img alt="llm-pgvector-8.png" src="/zh/blog/dev/llm-and-pgvector/llm-pgvector-8.png"></p>
<p>Supabase，Neon 也提供了带有 <code>pgvector</code> 插件的付费托管 PostgreSQL 服务，AWS RDS for PostgreSQL 也已经在五月初刚刚支持了此扩展 。提供托管服务的完整供应商列表可以参考 <code>pgvector</code> 的 Github Issue [6]。</p>
<hr>
<h2 id="参考">参考</h2>
<p>[1] <a href="https://github.com/pgvector/pgvector">PGVECTOR GitHub仓库</a></p>
<p>[2] <a href="https://ann-benchmarks.com/">ANN性能评测基准</a></p>
<p>[3] <a href="https://supabase.com/blog/openai-embeddings-postgres-vector">使用 PGVECTOR 存储 OpenAI 嵌入</a></p>
<p>[4] <a href="https://openai.com/blog/introducing-text-and-code-embeddings">文本与代码嵌入</a></p>
<p>[5] <a href="https://github.com/pgvector/pgvector/issues/76">Add official RPM package and inclusion in PGDG YUM repository</a></p>
<p>[6] <a href="https://github.com/pgvector/pgvector/issues/54">PGVector Hosted Providers</a></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-8d4491a0bd13c54cde6e64007c9ef59e">高级模糊查询的实现</h1>
	<div class="lead">如何在PostgreSQL中实现比较复杂的模糊查询逻辑？</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2021-03-05" class="text-muted">2021年03月05日</time>
        
	</div>
	<p>日常开发中，经常见到有模糊查询的需求。今天就简单聊一聊如何用PostgreSQL实现一些高级一点的模糊查询。</p>
<p>当然这里说的模糊查询，不是<code>LIKE</code>表达式前模糊后模糊两侧模糊，这种老掉牙的东西。让我们直接用一个具体的例子开始吧。</p>
<h2 id="问题">问题</h2>
<p>现在，假设我们做了个应用商店，想给用户提供<strong>搜索功能</strong>。用户随便输入点什么，找出所有与输入内容匹配的应用，排个序返回给用户。</p>
<p>严格来说，这种需求其实是需要一个搜索引擎，最好还是用专用软件，例如ElasticSearch来搞。但实际上只要不是特别复杂的逻辑，也可以很好的用PostgreSQL实现。</p>
<h3 id="数据">数据</h3>
<p>样例数据如下所示，一张应用表。抽除了所有无关字段，就留下一个应用名称<code>name</code>作为主键。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- COPY app FROM &#39;/tmp/app.csv&#39;;
</span></span></span></code></pre></div><p>里面的数据差不多长这样，中英混杂，共计150万条。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">Rome travel guide, rome italy map rome tourist attractions directions to colosseum, vatican museum, offline ATAC city rome bus tram underground train maps, 罗马地图,罗马地铁,罗马火车,罗马旅行指南&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">Urban Pics - 游戏俚语词典</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">世界经典童话故事大全(6到12岁少年儿童睡前故事英语亲子软件) 2 - 高级版</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">星征服者</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">客房控制系统</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">Santa ME! - 易圣诞老人,小精灵快乐的脸效果！</span>
</span></span></code></pre></div><h3 id="输入">输入</h3>
<p>用户在搜索框可能输入的东西，差不多就跟你自己在应用商店搜索框里会键入的东西差不多。“天气”，“外卖”，“交友”……</p>
<p>而我们想做到的效果，跟你对应用商店查询返回结果的期待也差不多。当然是越准确越好，最好还能按相关度排个序。</p>
<p>当然，作为一个生产级的应用，还必须能及时响应。不可以全表扫描，得用到索引。</p>
<p>那么，这类问题怎么解呢？</p>
<h2 id="解题思路">解题思路</h2>
<p>针对这一问题，有三种解题思路。</p>
<ul>
<li>基于<code>LIKE</code>的模式匹配。</li>
<li>基于<code>pg_trgm</code>的字符串相似度的匹配</li>
<li>基于自定义分词与倒排索引的模糊查询</li>
</ul>
<h2 id="like模式匹配">LIKE模式匹配</h2>
<p>最简单粗暴的方式就是使用 <code>LIKE '%'</code> 模式匹配查询。</p>
<p>老生常谈，没啥技术含量。把用户输入的关键词前后加一个百分号，然后执行这种查询：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SELECT * FROM app WHERE name LIKE &#39;%支付宝%&#39;;
</span></span></code></pre></div><p>前后模糊的查询可以通过常规的Btree索引进行加速，注意在PostgreSQL中使用 <code>LIKE</code>查询时不要掉到LC_COLLATE的坑里去了，详情参考这篇文章：<a href="/zh/blog/admin/collate/"><strong>PG中的本地化排序规则</strong></a>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLLATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic">-- 后模糊
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reverse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLLATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 前模糊
</span></span></span></code></pre></div><p>如果用户的输入非常<strong>精准清晰</strong>，这样的方式也不是不可以。响应速度也不错。但有两个问题：</p>
<ul>
<li>
<p>太机械死板，假设应用厂商发了个名字，在原来的关键词里面加了个空格或者什么符号，这种查询立刻就失效了。</p>
</li>
<li>
<p>没有距离度量，我们没有一个合适的度量，来排序返回的结果。说如果返回几百个结果没有排序，那很难让用户满意的。</p>
</li>
<li>
<p>有时候准确度还是不行，比如一些应用做SEO，把各种头部应用的名字都嵌到自己的名字中来提高搜索排名。</p>
</li>
</ul>
<h2 id="pg-trgm">PG TRGM</h2>
<p>PostgreSQL自带了一个名为<a href="http://www.postgres.cn/docs/13/pgtrgm.html"><code>pg_trgm</code></a>的扩展，提供的基于三字符语素的模糊查询。</p>
<p><code>pg_trgm</code>模块提供用于决定基于 trigram 匹配的字母数字文本相似度的函数和操作符，以及支持快速搜索相似字符串的索引操作符类。</p>
<h3 id="使用方式">使用方式</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 使用trgm操作符提取关键词素，并建立gist索引
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gist</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gist_trgm_ops</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>查询方式也很直观，直接使用<code>%</code> 运算符即可，比如从应用表中查到与支付宝相关的应用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">similarity</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;支付宝&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sim</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;支付宝&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000">sim</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------------------+------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">支付宝</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">让生活更简单</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">36363637</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">支付搜</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">33333334</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">支付社</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">33333334</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">支付啦</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">33333334</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">231</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">872</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">177</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">177</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">57</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">151</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">actual</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">251</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">969</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">251</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">970</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">loops</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#4e9a06">&#34;  Sort Key: (similarity(name, &#39;支付宝&#39;::text)) DESC&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Method</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">quicksort</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000">kB</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app_name_idx1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">41</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">171</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">73</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">151</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">actual</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">145</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">414</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">251</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">956</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">loops</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;支付宝&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Planning</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">331</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Execution</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">252</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">011</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>该方式的优点是</strong>：</p>
<ul>
<li>提供了字符串的距离函数<code>similarity</code>，可以给出两个字符串之间相似程度的定性度量。因此可以排序。</li>
<li>提供了基于3字符组合的分词函数<code>show_trgm</code>。</li>
<li>可以利用索引加速查询。</li>
<li>SQL查询语句非常简单清晰，索引定义也很简单明了，维护简单</li>
</ul>
<p><strong>该方式的缺点</strong>是：</p>
<ul>
<li>关键词很短的情况（1-2汉字）的情况下召回率很差，<strong>特别是只有一个字时，是无法查询出结果的</strong></li>
<li>执行效率较低，例如上面这个查询使用了200ms</li>
<li>定制性太差，只能使<strong>用它自己定义的逻辑来定义字符串的相似度</strong>，而且这个度量对于中文的效果相当存疑（中文三字词频率很低）</li>
<li>对<code>LC_CTYPE</code>有特殊的要求，默认<code>LC_CTYPE = C</code> 无法正确对中文进行分词。</li>
</ul>
<h3 id="特殊问题">特殊问题</h3>
<p>是<code>pg_trgm</code>的最大问题是，无法在<code>LC_CTYPE = C</code>的实例上针对中文使用。因为 <code>LC_CTYPE=C</code> 缺少一些字符的分类定义。不幸的是<code>LC_CTYPE</code>一旦设置，<strong>基本除了重新建库是没法更改的</strong>。</p>
<p>通常来说，PostgreSQL的Locale应当设置为<code>C</code>，或者至少将本地化规则中的排序规则<code>LC_COLLATE</code> 设置为C，以避免巨大的性能损失与功能缺失。但是因为<code>pg_trgm</code>的这个“问题”，您需要在创建库时，即指定<code>LC_CTYPE = &lt;non-C-locale&gt;</code>。这里基于<code>i18n</code>的LOCALE从原理上应该都可以使用。常见的<code>en_US</code>与<code>zh_CN</code>都是可以的。但注意特别注意，macOS上对Locale的支持存在问题。过于依赖LOCALE的行为会降低代码的可移植性。</p>
<h2 id="高级模糊查询">高级模糊查询</h2>
<p>实现一个高级的模糊查询，需要两样东西：<strong>分词</strong>，<strong>倒排索引</strong>。</p>
<p>高级模糊查询，或者说全文检索基于以下思路实现：</p>
<ul>
<li>分词：在维护阶段，每一个被模糊搜索的字段（例如应用名称），都会被<strong>分词</strong>逻辑加工处理成一系列关键词。</li>
<li>索引：在数据库中建立关键词到表记录的倒排索引</li>
<li>查询：将查询同样拆解为关键词，然后利用查询关键词通过倒排索引找出相关的记录来。</li>
</ul>
<p>PostgreSQL内建了很多语言的分词程序，可以自动将文档拆分为一系列的关键词，是为全文检索功能。可惜中文还是比较复杂，PG并没有内建的中文分词逻辑，虽然有一些第三方扩展，诸如 pg_jieba, zhparser等，但也年久失修，在新版本的PG上能不能用还是一个问题。</p>
<p>但是这并不影响我们利用PostgreSQL提供的基础设施实现高级模糊查询。实际上上面说的分词逻辑是为了从一个很大的文本（例如网页）中抽取摘要信息（关键字）。而我们的需求恰恰相反，不仅不是抽取摘要进行概括精简，而且需要将关键词扩充，以实现特定的模糊需求。例如，我们完全可以在抽取应用名称关键词的过程中，把这些关键词的汉语拼音，首音缩写，英文缩写一起放进关键词列表中，甚至把作者，公司，分类，等一系列用户可能感兴趣的东西放进去。这样搜索的时候就可以使用丰富的输入了。</p>
<h3 id="基本框架">基本框架</h3>
<p>我们先来构建整个问题解决的框架。</p>
<ol>
<li>编写一个自定义的分词函数，从名称中抽取关键词（每个字，每个二字短语，拼音，英文缩写，放什么都可以）</li>
<li>在目标表上创建一个使用分词函数的函数表达式GIN索引。</li>
<li>通过数组操作或 <code>tsquery</code> 等方式定制你的模糊查询</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 创建一个分词函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tokens12</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">returns</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#000;font-weight:bold">....</span><span style="color:#a40000">$$</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 基于该分词函数创建表达式索引
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">GIN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tokens12</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 使用关键词进行复杂的定制查询（关键词数组操作）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">split_to_chars</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">ARRAY</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;天气&#39;</span><span style="color:#000;font-weight:bold">];</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 使用关键词进行复杂的定制查询（tsquery操作）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">to_tsvector123</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">@@</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;BTC &amp;! 钱包 &amp; ! 交易 &#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">tsquery</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>PostgreSQL 提供了GIN索引，可以很好的支持<strong>倒排索引</strong>的功能，比较麻烦的是寻找一种比较合适的<strong>中文分词插件</strong>。将应用名称分解为一系列关键词。好在对于此类模糊查询的需求，也用不着像搞搜索引擎，自然语言处理那么精细的语义解析。只要参考<code>pg_trgm</code>的思路把中文也给手动一锅烩了就行。除此之外，通过自定义的分词逻辑，还可以实现很多有趣的功能。比如使用<strong>拼音模糊查询，使用拼音首字母缩写模糊查询</strong>。</p>
<p>让我们从最简单的分词开始。</p>
<h3 id="快速开始">快速开始</h3>
<p>首先来定义一个非常简单粗暴的分词函数，它只是把输入拆分成2字词语的组合。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>-- 创建分词函数，将字符串拆为单字，双字组成的词素数组
</span></span><span style="display:flex;"><span>CREATE OR REPLACE FUNCTION tokens12(text) returns text[] AS $$
</span></span><span style="display:flex;"><span>DECLARE
</span></span><span style="display:flex;"><span>    res TEXT[];
</span></span><span style="display:flex;"><span>BEGIN
</span></span><span style="display:flex;"><span>    SELECT regexp_split_to_array($1, &#39;&#39;) INTO res;
</span></span><span style="display:flex;"><span>    FOR i in 1..length($1) - 1 LOOP
</span></span><span style="display:flex;"><span>            res := array_append(res, substring($1, i, 2));
</span></span><span style="display:flex;"><span>    END LOOP;
</span></span><span style="display:flex;"><span>    RETURN res;
</span></span><span style="display:flex;"><span>END;
</span></span><span style="display:flex;"><span>$$ LANGUAGE plpgsql STRICT PARALLEL SAFE IMMUTABLE;
</span></span></code></pre></div><p>使用这个分词函数，可以将一个应用名称肢解为一系列的语素</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SELECT tokens2(&#39;艾米莉的埃及历险记&#39;);
</span></span><span style="display:flex;"><span>-- {艾米,米莉,莉的,的埃,埃及,及历,历险,险记}
</span></span></code></pre></div><p>现在假设用户搜索关键词“艾米利”，这个关键词被拆分为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SELECT tokens2(&#39;艾米莉&#39;);
</span></span><span style="display:flex;"><span>-- {艾米,米莉}
</span></span></code></pre></div><p>然后，我们可以通过以下查询非常迅速地，找到所有包含这两个关键词素的记录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tokens2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">@&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tokens2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;艾米莉&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">美味餐厅</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">艾米莉的圣诞颂歌</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">美味餐厅</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">艾米莉的瓶中信笺</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">小清新艾米莉</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">艾米莉的埃及历险记</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">艾米莉的极地大冒险</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">艾米莉的万圣节历险记</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">38</span><span style="color:#000">ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这里通过关键词数组的倒排索引，可以快速实现前后模糊的效果。</p>
<p>这里的条件比较严格，应用需要完整的包含两个关键词才会匹配。</p>
<p>如果我们改用更宽松的条件来执行<strong>模糊查询</strong>，例如，只要包含任意一个语素：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tokens2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tokens2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;艾米莉&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AR艾米互动故事</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#a40000">智慧妈妈必备</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Amy</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">train</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">艾米和小火车</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">米莉·马洛塔的涂色探索</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">给利伴</span><span style="color:#000">_艾米罗公司旗下专业购物返利网</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">艾米团购</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">记忆游戏</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">米莉和泰迪</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">56</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>那么可供近一步筛选的应用候选集就更宽泛了。同时执行时间也并没有发生巨大的变化。</p>
<p>更近一步，我们并不需要在查询中使用完全一致的分词逻辑，完全可以手工进行精密的查询控制。</p>
<p>我们完全可以通过数组的布尔运算，控制哪些关键词是我们想要的，哪些是不想要的，哪些可选，哪些必须。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 包含关键词 微信、红包，但不包含 ‘支付’ (1ms | 11 rows)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tokens2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">@&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">ARRAY</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;微信&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;红包&#39;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tokens2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">@&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">ARRAY</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;支付&#39;</span><span style="color:#000;font-weight:bold">];</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>当然，也可以对返回的结果进行相似度排序。一种常用的字符串似度衡量是L式编辑距离，即一个字符串最少需要多少次单字编辑才能变为另一个字符串。这个距离函数<code>levenshtein</code> 在PG的官方扩展包<code>fuzzystrmatch</code>中提供。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 包含关键词 微信 的应用，按照L式编辑距离排序 ( 1.1 ms | 10 rows)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- create extension fuzzystrmatch;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">levenshtein</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;微信&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tokens12</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">@&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">ARRAY</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;微信&#39;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">微信</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">微信读书</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">微信趣图</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">微信加密</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">企业微信</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">微信通助手</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">微信彩色消息</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">艺术微信平台网</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">涂鸦画板</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">微信</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">手写板</span><span style="color:#000">for微信</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="改进全文检索方式">改进全文检索方式</h3>
<p>接下来，我们可以对分词的方式进行一些改进：</p>
<ul>
<li>缩小关键词范围：将标点符号从关键词中移除，将语气助词（的得地，啊唔之乎者也）之类排除掉。（可选）</li>
<li>扩大关键词列表：将已有关键词的汉语拼音，首字母缩写一并加入关键词列表。</li>
<li>优化关键词大小：针对单字，3字短语，4字成语进行提取与优化。中文不同于英文，英文拆分为3字符的小串效果很好，中文信息密度更大，单字或双字就有很大的区分度了。</li>
<li>去除重复关键词：例如前后重复出现，或者通假字，同义词之类的。</li>
<li>跨语言分词处理，例如中西夹杂的名称，我们可以分别对中英文进行处理，中日韩字符采用中式分词处理逻辑，英文字母使用常规的<code>pg_trgm</code>处理逻辑。</li>
</ul>
<p>实际上也不一定用得着这些逻辑，而这些逻辑也不一定非要在数据库里用存储过程实现。比较好的方式当然是在外部读取数据库然后使用专用的分词库和自定义业务逻辑来进行分词，分完之后再回写到数据表的另一列上。</p>
<p>当然这里出于演示目的，我们就直接用存储过程直接上了，实现一个比较简单的改进版分词逻辑。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cjk_to_tsvector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_src</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tsvector</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">res</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">[]:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">show_trgm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_src</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">cjk</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 中日韩连续文本段
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cjk</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">unnest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">regexp_matches</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_src</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;[\u4E00-\u9FCC\u3400-\u4DBF\u20000-\u2A6D6\u2A700-\u2B81F\u2E80-\u2FDF\uF900-\uFA6D\u2F800-\u2FA1B]+&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;g&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">regex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LOOP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">..</span><span style="color:#204a87;font-weight:bold">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cjk</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LOOP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">res</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">array_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cjk</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LOOP</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 将每个中日韩连续文本段两字词语加入列表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LOOP</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">return</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">array_to_tsvector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">end</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PlPgSQL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARALLEL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SAFE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">COST</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">STRICT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IMMUTABLE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 如果需要使用标签数组的方式，可以使用此函数。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cjk_to_array</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_src</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tsvector_to_array</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cjk_to_tsvector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_src</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PlPgSQL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARALLEL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SAFE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">COST</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">STRICT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IMMUTABLE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 创建分词专用函数索引
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">GIN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cjk_to_array</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="基于-tsvector">基于 tsvector</h3>
<p>除了基于数组的运算之外，PostgreSQL还提供了<code>tsvector</code>与<code>tsquery</code>类型，用于全文检索。</p>
<p>我们可以使用这两种类型的运算取代数组之间的运算，写出更灵活的查询来：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">to_tsvector123</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">src</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tsvector</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">res</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">[];</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">n</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">regexp_split_to_array</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">..</span><span style="color:#000">n</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LOOP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">res</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">array_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">));</span><span style="color:#000">res</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">array_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LOOP</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">res</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">array_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">array_agg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">distinct</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">res</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">unnest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXCEPT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39; &#39;</span><span style="color:#000;font-weight:bold">),(</span><span style="color:#4e9a06">&#39;，&#39;</span><span style="color:#000;font-weight:bold">),(</span><span style="color:#4e9a06">&#39;的&#39;</span><span style="color:#000;font-weight:bold">),(</span><span style="color:#4e9a06">&#39;。&#39;</span><span style="color:#000;font-weight:bold">),(</span><span style="color:#4e9a06">&#39;-&#39;</span><span style="color:#000;font-weight:bold">),(</span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- optional (normalize)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">array_to_tsvector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">end</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PlPgSQL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PARALLEL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SAFE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">COST</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">STRICT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IMMUTABLE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 使用自定义分词函数，创建函数表达式索引
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">GIN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">to_tsvector123</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>使用tsvector进行查询的方式也相当直观</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 包含 &#39;学英语&#39; 和 &#39;雅思&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">to_tsvector123</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">@@</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;学英语 &amp; 雅思&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">tsquery</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 所有关于 &#39;BTC&#39; 但不含&#39;钱包&#39; &#39;交易&#39;字样的应用
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">to_tsvector123</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">@@</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;BTC &amp;! 钱包 &amp; ! 交易 &#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">tsquery</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="参考文章">参考文章：</h2>
<p>PostgreSQL 模糊查询最佳实践 - (含单字、双字、多字模糊查询方法)</p>
<p><a href="https://developer.aliyun.com/article/672293">https://developer.aliyun.com/article/672293</a></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-fdb1c15b0c04ebe045dd75e87370761a">前后端通信线缆协议</h1>
	<div class="lead">了解PostgreSQL服务器与客户端通信使用的TCP协议，并使用Go语言打印消息</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2019-11-12" class="text-muted">2019年11月12日</time>
        
	</div>
	<p>了解PostgreSQL服务器与客户端通信使用的TCP协议</p>
<hr>
<h2 id="启动阶段">启动阶段</h2>
<p>启动阶段的基本流程如下所示：</p>
<ul>
<li>
<p>客户端发送一条<code>StartupMessage (F)</code>向服务端发起连接请求</p>
<p>载荷包括<code>0x30000</code>的Int32版本号魔数，以及一系列kv结构的运行时参数（NULL0分割，必须参数为<code>user</code>），</p>
</li>
<li>
<p>客户端等待服务端响应，主要是等待服务端发送的<code>ReadyForQuery (Z)</code>事件，该事件代表服务端已经准备好接收请求。</p>
</li>
</ul>
<p>上面是连接建立过程中最主要的两个事件，其他事件包括包括认证消息 <code>AuthenticationXXX (R)</code> ，后端密钥消息 <code>BackendKeyData (K)</code>，错误消息<code>ErrorResponse (E)</code>，一系列上下文无关消息（<code>NoticeResponse (N)</code>，<code>NotificationResponse (A)</code>，<code>ParameterStatus(S)</code>）</p>
<p>我们可以编写一个go程序模拟这一过程：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/jackc/pgx/pgproto3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">GetFrontend</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">address</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pgproto3</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Frontend</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">conn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dialer</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">KeepAlive</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Minute</span><span style="color:#000;font-weight:bold">}).</span><span style="color:#000">Dial</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tcp4&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">address</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">frontend</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pgproto3</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewFrontend</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">frontend</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">frontend</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">GetFrontend</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;127.0.0.1:5432&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 建立连接
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">startupMsg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pgproto3</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartupMessage</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ProtocolVersion</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">pgproto3</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProtocolVersionNumber</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;vonng&#34;</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">frontend</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startupMsg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 启动过程，收到ReadyForQuery消息代表启动过程结束
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">frontend</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Receive</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%T %v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pgproto3</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadyForQuery</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[STARTUP] connection established&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 简单查询协议
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">simpleQueryMsg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pgproto3</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Query</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">`SELECT 1 as a;`</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">frontend</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">simpleQueryMsg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 收到CommandComplete消息代表查询结束
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">frontend</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Receive</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%T %v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pgproto3</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommandComplete</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[QUERY] query complete&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>输出结果为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>*pgproto3.Authentication <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span> 0<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">[]}</span>
</span></span><span style="display:flex;"><span>*pgproto3.ParameterStatus <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{</span>application_name <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>*pgproto3.ParameterStatus <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{</span>client_encoding UTF8<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>*pgproto3.ParameterStatus <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{</span>DateStyle ISO, MDY<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>*pgproto3.ParameterStatus <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{</span>integer_datetimes on<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>*pgproto3.ParameterStatus <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{</span>IntervalStyle postgres<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>*pgproto3.ParameterStatus <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{</span>is_superuser on<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>*pgproto3.ParameterStatus <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{</span>server_encoding UTF8<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>*pgproto3.ParameterStatus <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{</span>server_version 11.3<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>*pgproto3.ParameterStatus <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{</span>session_authorization vonng<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>*pgproto3.ParameterStatus <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{</span>standard_conforming_strings on<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>*pgproto3.ParameterStatus <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{</span>TimeZone PRC<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>*pgproto3.BackendKeyData <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">35703</span> 345830596<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>*pgproto3.ReadyForQuery <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{</span>73<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>STARTUP<span style="color:#ce5c00;font-weight:bold">]</span> connection established
</span></span><span style="display:flex;"><span>*pgproto3.RowDescription <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{[{</span>a <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">23</span> <span style="color:#0000cf;font-weight:bold">4</span> -1 0<span style="color:#ce5c00;font-weight:bold">}]}</span>
</span></span><span style="display:flex;"><span>*pgproto3.DataRow <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{[[</span>49<span style="color:#ce5c00;font-weight:bold">]]}</span>
</span></span><span style="display:flex;"><span>*pgproto3.CommandComplete <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#ce5c00;font-weight:bold">{</span>SELECT 1<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>QUERY<span style="color:#ce5c00;font-weight:bold">]</span> query <span style="color:#204a87">complete</span>
</span></span></code></pre></div><hr>
<h2 id="连接代理">连接代理</h2>
<p>可以在<code>jackc/pgx/pgproto3</code>的基础上，很轻松地编写一些中间件。例如下面的代码就是一个非常简单的“连接代理”：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">package</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">main</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">import</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#4e9a06">&#34;io&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#4e9a06">&#34;net&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#4e9a06">&#34;strings&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#4e9a06">&#34;time&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#4e9a06">&#34;github.com/jackc/pgx/pgproto3&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ProxyServer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">struct</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">UpstreamAddr</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ListenAddr</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">Listener</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Listener</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">Dialer</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dialer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">func</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NewProxyServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">listenAddr</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">upstreamAddr</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ProxyServer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ln</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">_</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">Listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">tcp4</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">listenAddr</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#204a87;font-weight:bold">return</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ProxyServer</span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">ListenAddr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">listenAddr</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">UpstreamAddr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">upstreamAddr</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">Listener</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000">ln</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">Dialer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dialer</span><span style="color:#a40000">{</span><span style="color:#000">KeepAlive</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">Minute</span><span style="color:#a40000">}</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">func</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ps</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ProxyServer</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Serve</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">error</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">conn</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">err</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Listener</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Accept</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">err</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nil</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">			</span><span style="color:#000">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#204a87;font-weight:bold">go</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServeOne</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conn</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">func</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ps</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ProxyServer</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServeOne</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientConn</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">error</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">backend</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">_</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgproto3</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBackend</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientConn</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clientConn</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">startupMsg</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">err</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">backend</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReceiveStartupMessage</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">err</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nil</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">Contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ssl&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">err</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clientConn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#000">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">N</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">err</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nil</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">			</span><span style="color:#000">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#ce5c00;font-weight:bold">//</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ssl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">is</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">welcome</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">now</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">receive</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">real</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">startup</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">msg</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">startupMsg</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">err</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">backend</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReceiveStartupMessage</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">err</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nil</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">			</span><span style="color:#000">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">serverConn</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">_</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dialer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dial</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">tcp4</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpstreamAddr</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">frontend</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">_</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgproto3</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewFrontend</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">serverConn</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">serverConn</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">frontend</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startupMsg</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">errChan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">chan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#204a87;font-weight:bold">go</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">func</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">err</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">Copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientConn</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">serverConn</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">errChan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">err</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#a40000">}</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#204a87;font-weight:bold">go</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">func</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">err</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">Copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">serverConn</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clientConn</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">errChan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">err</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#a40000">}</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#204a87;font-weight:bold">return</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">errChan</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">func</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">proxy</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NewProxyServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;127.0.0.1:5433&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:5432&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">proxy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Serve</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这里代理监听5433端口，并将消息解析并转发至在5432端口的真实的数据库服务器。在另一个Session中执行以下命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ psql postgres://127.0.0.1:5433/data?sslmode<span style="color:#ce5c00;font-weight:bold">=</span>disable -c <span style="color:#4e9a06">&#39;SELECT * FROM pg_stat_activity LIMIT 1;&#39;</span>
</span></span></code></pre></div><p>可以观察到这一过程中的消息往来：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[B2F] *pgproto3.ParameterStatus &amp;{application_name psql}
</span></span><span style="display:flex;"><span>[B2F] *pgproto3.ParameterStatus &amp;{client_encoding UTF8}
</span></span><span style="display:flex;"><span>[B2F] *pgproto3.ParameterStatus &amp;{DateStyle ISO, MDY}
</span></span><span style="display:flex;"><span>[B2F] *pgproto3.ParameterStatus &amp;{integer_datetimes on}
</span></span><span style="display:flex;"><span>[B2F] *pgproto3.ParameterStatus &amp;{IntervalStyle postgres}
</span></span><span style="display:flex;"><span>[B2F] *pgproto3.ParameterStatus &amp;{is_superuser on}
</span></span><span style="display:flex;"><span>[B2F] *pgproto3.ParameterStatus &amp;{server_encoding UTF8}
</span></span><span style="display:flex;"><span>[B2F] *pgproto3.ParameterStatus &amp;{server_version 11.3}
</span></span><span style="display:flex;"><span>[B2F] *pgproto3.ParameterStatus &amp;{session_authorization vonng}
</span></span><span style="display:flex;"><span>[B2F] *pgproto3.ParameterStatus &amp;{standard_conforming_strings on}
</span></span><span style="display:flex;"><span>[B2F] *pgproto3.ParameterStatus &amp;{TimeZone PRC}
</span></span><span style="display:flex;"><span>[B2F] *pgproto3.BackendKeyData &amp;{41588 1354047533}
</span></span><span style="display:flex;"><span>[B2F] *pgproto3.ReadyForQuery &amp;{73}
</span></span><span style="display:flex;"><span>[F2B] *pgproto3.Query &amp;{SELECT * FROM pg_stat_activity LIMIT 1;}
</span></span><span style="display:flex;"><span>[B2F] *pgproto3.RowDescription &amp;{[{datid 11750 1 26 4 -1 0} {datname 11750 2 19 64 -1 0} {pid 11750 3 23 4 -1 0} {usesysid 11750 4 26 4 -1 0} {usename 11750 5 19 64 -1 0} {application_name 11750 6 25 -1 -1 0} {client_addr 11750 7 869 -1 -1 0} {client_hostname 11750 8 25 -1 -1 0} {client_port 11750 9 23 4 -1 0} {backend_start 11750 10 1184 8 -1 0} {xact_start 11750 11 1184 8 -1 0} {query_start 11750 12 1184 8 -1 0} {state_change 11750 13 1184 8 -1 0} {wait_event_type 11750 14 25 -1 -1 0} {wait_event 11750 15 25 -1 -1 0} {state 11750 16 25 -1 -1 0} {backend_xid 11750 17 28 4 -1 0} {backend_xmin 11750 18 28 4 -1 0} {query 11750 19 25 -1 -1 0} {backend_type 11750 20 25 -1 -1 0}]}
</span></span><span style="display:flex;"><span>[B2F] *pgproto3.DataRow &amp;{[[] [] [52 56 55 52] [] [] [] [] [] [] [50 48 49 57 45 48 53 45 49 56 32 50 48 58 52 56 58 49 57 46 51 50 55 50 54 55 43 48 56] [] [] [] [65 99 116 105 118 105 116 121] [65 117 116 111 86 97 99 117 117 109 77 97 105 110] [] [] [] [] [97 117 116 111 118 97 99 117 117 109 32 108 97 117 110 99 104 101 114]]}
</span></span><span style="display:flex;"><span>[B2F] *pgproto3.CommandComplete &amp;{SELECT 1}
</span></span><span style="display:flex;"><span>[B2F] *pgproto3.ReadyForQuery &amp;{73}
</span></span><span style="display:flex;"><span>[F2B] *pgproto3.Terminate &amp;{}
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-459077b7c73927d841574630d5fb1203">事务隔离等级注意事项</h1>
	<div class="lead">PostgreSQL实际上只有两种事务隔离等级：<strong>读已提交（Read Commited）<strong>与</strong>可序列化（Serializable）</strong></div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2019-11-12" class="text-muted">2019年11月12日</time>
        
	</div>
	<p>PostgreSQL实际上只有两种事务隔离等级：<strong>读已提交（Read Commited）<strong>与</strong>可序列化（Serializable）</strong></p>
<hr>
<h2 id="基础">基础</h2>
<p>SQL标准定义了四种隔离级别，但PostgreSQL实际上只有两种事务隔离等级：<strong>读已提交（Read Commited）<strong>与</strong>可序列化（Serializable）</strong></p>
<p>SQL标准定义了四种隔离级别，但实际上这也是很粗鄙的一种划分。详情请参考<a href="/zh/blog/db/concurrent-control/">并发异常那些事</a>。</p>
<h2 id="查看设置事务隔离等级">查看/设置事务隔离等级</h2>
<p>通过执行：<code>SELECT current_setting('transaction_isolation');</code> 可以查看当前事务隔离等级。</p>
<p>通过在事务块顶部执行 <code>SET TRANSACTION ISOLATION LEVEL { SERIALIZABLE | REPEATABLE READ | READ COMMITTED | READ UNCOMMITTED } </code>来设定事务的隔离等级。</p>
<p>或者为当前会话生命周期设置事务隔离等级：</p>
<p><code>SET SESSION CHARACTERISTICS AS TRANSACTION transaction_mode</code></p>
<table>
<thead>
<tr>
<th>Actual isolation level</th>
<th>P4</th>
<th>G-single</th>
<th>G2-item</th>
<th>G2</th>
</tr>
</thead>
<tbody>
<tr>
<td>RC（monotonic atomic views）</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>RR（snapshot isolation）</td>
<td>✓</td>
<td>✓</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>Serializable</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
</tbody>
</table>
<h2 id="隔离等级与并发问题">隔离等级与并发问题</h2>
<p>创建测试表 <code>t</code> ，并插入两行测试数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">TRUNCATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="更新丢失p4">更新丢失（P4）</h2>
<p>PostgreSQL的 <strong>读已提交RC</strong> 隔离等级无法阻止丢失更新的问题，但可重复读隔离等级则可以。</p>
<p>丢失更新，顾名思义，就是一个事务的写入覆盖了另一个事务的写入结果。</p>
<p>在读已提交隔离等级下，无法阻止丢失更新的问题，考虑一个计数器并发更新的例子，两个事务同时从计数器中读取出值，加1后写回原表。</p>
<table>
<thead>
<tr>
<th style="text-align:center">T1</th>
<th style="text-align:center">T2</th>
<th style="text-align:center">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>begin;</code></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code> begin;</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"><code>SELECT v FROM t WHERE k = 1</code></td>
<td style="text-align:center"></td>
<td style="text-align:center">T1读</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code>SELECT v FROM t WHERE k = 1</code></td>
<td style="text-align:center">T2读</td>
</tr>
<tr>
<td style="text-align:center"><code>update t set v = 11 where k = 1; </code></td>
<td style="text-align:center"></td>
<td style="text-align:center">T1写</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code> update t set v = 11 where k = 1;</code></td>
<td style="text-align:center">T2因T1阻塞</td>
</tr>
<tr>
<td style="text-align:center"><code>COMMIT</code></td>
<td style="text-align:center"></td>
<td style="text-align:center">T2恢复，写入</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code>COMMIT</code></td>
<td style="text-align:center">T2写入覆盖T1</td>
</tr>
</tbody>
</table>
<p>解决这个问题有两种方式，使用原子操作，或者在可重复读的隔离等级执行事务。</p>
<p>使用原子操作的方式为：</p>
<table>
<thead>
<tr>
<th style="text-align:center">T1</th>
<th style="text-align:center">T2</th>
<th style="text-align:center">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>begin;</code></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code> begin;</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"><code>update t set v = v+1 where k = 1; </code></td>
<td style="text-align:center"></td>
<td style="text-align:center">T1写</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code> update t set v = v + 1 where k = 1;</code></td>
<td style="text-align:center">T2因T1阻塞</td>
</tr>
<tr>
<td style="text-align:center"><code>COMMIT</code></td>
<td style="text-align:center"></td>
<td style="text-align:center">T2恢复，写入</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code>COMMIT</code></td>
<td style="text-align:center">T2写入覆盖T1</td>
</tr>
</tbody>
</table>
<p>解决这个问题有两种方式，使用原子操作，或者在可重复读的隔离等级执行事务。</p>
<p>在可重复读的隔离等级</p>
<h2 id="读已提交rc">读已提交（RC）</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">transaction</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">isolation</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">level</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">read</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">committed</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- T1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">transaction</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">isolation</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">level</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">read</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">committed</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- T2
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- T1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- T2, BLOCKS
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">21</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- T1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">commit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- T1. This unblocks T2
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- T1. Shows 1 =&gt; 11, 2 =&gt; 21
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- T2
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">commit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- T2
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- either. Shows 1 =&gt; 12, 2 =&gt; 22
</span></span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:center">T1</th>
<th style="text-align:center">T2</th>
<th style="text-align:center">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code> begin; set transaction isolation level read committed;</code></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code> begin; set transaction isolation level read committed;</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"><code>update t set v = 11 where k = 1; </code></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code> update t set v = 12 where k = 1;</code></td>
<td style="text-align:center">T2会等待T1持有的锁</td>
</tr>
<tr>
<td style="text-align:center"><code>SELECT * FROM t</code></td>
<td style="text-align:center"></td>
<td style="text-align:center">2:20, 1:11</td>
</tr>
<tr>
<td style="text-align:center"><code> update pair set v = 21 where k = 2;</code></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"><code> commit;</code></td>
<td style="text-align:center"></td>
<td style="text-align:center">T2解锁</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code> select * from pair;</code></td>
<td style="text-align:center">T2看见T1的结果和自己的修改</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code> update t set v = 22 where k = 2</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code>commit</code></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<p>提交后的结果</p>
<p>1</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> relname <span style="color:#000;font-weight:bold">|</span> locktype <span style="color:#000;font-weight:bold">|</span> virtualtransaction <span style="color:#000;font-weight:bold">|</span>  pid  <span style="color:#000;font-weight:bold">|</span>       mode       <span style="color:#000;font-weight:bold">|</span> granted <span style="color:#000;font-weight:bold">|</span> fastpath
</span></span><span style="display:flex;"><span>---------+----------+--------------------+-------+------------------+---------+----------
</span></span><span style="display:flex;"><span> t_pkey  <span style="color:#000;font-weight:bold">|</span> relation <span style="color:#000;font-weight:bold">|</span> 4/578              <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">37670</span> <span style="color:#000;font-weight:bold">|</span> RowExclusiveLock <span style="color:#000;font-weight:bold">|</span> t       <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span> t       <span style="color:#000;font-weight:bold">|</span> relation <span style="color:#000;font-weight:bold">|</span> 4/578              <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">37670</span> <span style="color:#000;font-weight:bold">|</span> RowExclusiveLock <span style="color:#000;font-weight:bold">|</span> t       <span style="color:#000;font-weight:bold">|</span> t
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> relname <span style="color:#000;font-weight:bold">|</span> locktype <span style="color:#000;font-weight:bold">|</span> virtualtransaction <span style="color:#000;font-weight:bold">|</span>  pid  <span style="color:#000;font-weight:bold">|</span>       mode       <span style="color:#000;font-weight:bold">|</span> granted <span style="color:#000;font-weight:bold">|</span> fastpath
</span></span><span style="display:flex;"><span>---------+----------+--------------------+-------+------------------+---------+----------
</span></span><span style="display:flex;"><span> t_pkey  <span style="color:#000;font-weight:bold">|</span> relation <span style="color:#000;font-weight:bold">|</span> 4/578              <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">37670</span> <span style="color:#000;font-weight:bold">|</span> RowExclusiveLock <span style="color:#000;font-weight:bold">|</span> t       <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span> t       <span style="color:#000;font-weight:bold">|</span> relation <span style="color:#000;font-weight:bold">|</span> 4/578              <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">37670</span> <span style="color:#000;font-weight:bold">|</span> RowExclusiveLock <span style="color:#000;font-weight:bold">|</span> t       <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span> t_pkey  <span style="color:#000;font-weight:bold">|</span> relation <span style="color:#000;font-weight:bold">|</span> 6/494              <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">37672</span> <span style="color:#000;font-weight:bold">|</span> RowExclusiveLock <span style="color:#000;font-weight:bold">|</span> t       <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span> t       <span style="color:#000;font-weight:bold">|</span> relation <span style="color:#000;font-weight:bold">|</span> 6/494              <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">37672</span> <span style="color:#000;font-weight:bold">|</span> RowExclusiveLock <span style="color:#000;font-weight:bold">|</span> t       <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span> t       <span style="color:#000;font-weight:bold">|</span> tuple    <span style="color:#000;font-weight:bold">|</span> 6/494              <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">37672</span> <span style="color:#000;font-weight:bold">|</span> ExclusiveLock    <span style="color:#000;font-weight:bold">|</span> t       <span style="color:#000;font-weight:bold">|</span> f
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> relname <span style="color:#000;font-weight:bold">|</span> locktype <span style="color:#000;font-weight:bold">|</span> virtualtransaction <span style="color:#000;font-weight:bold">|</span>  pid  <span style="color:#000;font-weight:bold">|</span>       mode       <span style="color:#000;font-weight:bold">|</span> granted <span style="color:#000;font-weight:bold">|</span> fastpath
</span></span><span style="display:flex;"><span>---------+----------+--------------------+-------+------------------+---------+----------
</span></span><span style="display:flex;"><span> t_pkey  <span style="color:#000;font-weight:bold">|</span> relation <span style="color:#000;font-weight:bold">|</span> 4/578              <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">37670</span> <span style="color:#000;font-weight:bold">|</span> RowExclusiveLock <span style="color:#000;font-weight:bold">|</span> t       <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span> t       <span style="color:#000;font-weight:bold">|</span> relation <span style="color:#000;font-weight:bold">|</span> 4/578              <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">37670</span> <span style="color:#000;font-weight:bold">|</span> RowExclusiveLock <span style="color:#000;font-weight:bold">|</span> t       <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span> t_pkey  <span style="color:#000;font-weight:bold">|</span> relation <span style="color:#000;font-weight:bold">|</span> 6/494              <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">37672</span> <span style="color:#000;font-weight:bold">|</span> RowExclusiveLock <span style="color:#000;font-weight:bold">|</span> t       <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span> t       <span style="color:#000;font-weight:bold">|</span> relation <span style="color:#000;font-weight:bold">|</span> 6/494              <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">37672</span> <span style="color:#000;font-weight:bold">|</span> RowExclusiveLock <span style="color:#000;font-weight:bold">|</span> t       <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span> t       <span style="color:#000;font-weight:bold">|</span> tuple    <span style="color:#000;font-weight:bold">|</span> 6/494              <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">37672</span> <span style="color:#000;font-weight:bold">|</span> ExclusiveLock    <span style="color:#000;font-weight:bold">|</span> t       <span style="color:#000;font-weight:bold">|</span> f
</span></span></code></pre></div><h1 id="testing-postgresql-transaction-isolation-levels">Testing PostgreSQL transaction isolation levels</h1>
<p>These tests were run with Postgres 9.3.5.</p>
<p>Setup (before every test case):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>create table test (id int primary key, value int);
</span></span><span style="display:flex;"><span>insert into test (id, value) values (1, 10), (2, 20);
</span></span></code></pre></div><p>To see the current isolation level:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>select current_setting(&#39;transaction_isolation&#39;);
</span></span></code></pre></div><h2 id="read-committed-basic-requirements-g0-g1a-g1b-g1c">Read Committed basic requirements (G0, G1a, G1b, G1c)</h2>
<p>Postgres &ldquo;read committed&rdquo; prevents Write Cycles (G0) by locking updated rows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T2
</span></span><span style="display:flex;"><span>update test set value = 11 where id = 1; -- T1
</span></span><span style="display:flex;"><span>update test set value = 12 where id = 1; -- T2, BLOCKS
</span></span><span style="display:flex;"><span>update test set value = 21 where id = 2; -- T1
</span></span><span style="display:flex;"><span>commit; -- T1. This unblocks T2
</span></span><span style="display:flex;"><span>select * from test; -- T1. Shows 1 =&gt; 11, 2 =&gt; 21
</span></span><span style="display:flex;"><span>update test set value = 22 where id = 2; -- T2
</span></span><span style="display:flex;"><span>commit; -- T2
</span></span><span style="display:flex;"><span>select * from test; -- either. Shows 1 =&gt; 12, 2 =&gt; 22
</span></span></code></pre></div><p>Postgres &ldquo;read committed&rdquo; prevents Aborted Reads (G1a):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T2
</span></span><span style="display:flex;"><span>update test set value = 101 where id = 1; -- T1
</span></span><span style="display:flex;"><span>select * from test; -- T2. Still shows 1 =&gt; 10
</span></span><span style="display:flex;"><span>abort;  -- T1
</span></span><span style="display:flex;"><span>select * from test; -- T2. Still shows 1 =&gt; 10
</span></span><span style="display:flex;"><span>commit; -- T2
</span></span></code></pre></div><p>Postgres &ldquo;read committed&rdquo; prevents Intermediate Reads (G1b):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T2
</span></span><span style="display:flex;"><span>update test set value = 101 where id = 1; -- T1
</span></span><span style="display:flex;"><span>select * from test; -- T2. Still shows 1 =&gt; 10
</span></span><span style="display:flex;"><span>update test set value = 11 where id = 1; -- T1
</span></span><span style="display:flex;"><span>commit; -- T1
</span></span><span style="display:flex;"><span>select * from test; -- T2. Now shows 1 =&gt; 11
</span></span><span style="display:flex;"><span>commit; -- T2
</span></span></code></pre></div><p>Postgres &ldquo;read committed&rdquo; prevents Circular Information Flow (G1c):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T2
</span></span><span style="display:flex;"><span>update test set value = 11 where id = 1; -- T1
</span></span><span style="display:flex;"><span>update test set value = 22 where id = 2; -- T2
</span></span><span style="display:flex;"><span>select * from test where id = 2; -- T1. Still shows 2 =&gt; 20
</span></span><span style="display:flex;"><span>select * from test where id = 1; -- T2. Still shows 1 =&gt; 10
</span></span><span style="display:flex;"><span>commit; -- T1
</span></span><span style="display:flex;"><span>commit; -- T2
</span></span></code></pre></div><h2 id="observed-transaction-vanishes-otv">Observed Transaction Vanishes (OTV)</h2>
<p>Postgres &ldquo;read committed&rdquo; prevents Observed Transaction Vanishes (OTV):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T2
</span></span><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T3
</span></span><span style="display:flex;"><span>update test set value = 11 where id = 1; -- T1
</span></span><span style="display:flex;"><span>update test set value = 19 where id = 2; -- T1
</span></span><span style="display:flex;"><span>update test set value = 12 where id = 1; -- T2. BLOCKS
</span></span><span style="display:flex;"><span>commit; -- T1. This unblocks T2
</span></span><span style="display:flex;"><span>select * from test where id = 1; -- T3. Shows 1 =&gt; 11
</span></span><span style="display:flex;"><span>update test set value = 18 where id = 2; -- T2
</span></span><span style="display:flex;"><span>select * from test where id = 2; -- T3. Shows 2 =&gt; 19
</span></span><span style="display:flex;"><span>commit; -- T2
</span></span><span style="display:flex;"><span>select * from test where id = 2; -- T3. Shows 2 =&gt; 18
</span></span><span style="display:flex;"><span>select * from test where id = 1; -- T3. Shows 1 =&gt; 12
</span></span><span style="display:flex;"><span>commit; -- T3
</span></span></code></pre></div><h2 id="predicate-many-preceders-pmp">Predicate-Many-Preceders (PMP)</h2>
<p>Postgres &ldquo;read committed&rdquo; does not prevent Predicate-Many-Preceders (PMP):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T2
</span></span><span style="display:flex;"><span>select * from test where value = 30; -- T1. Returns nothing
</span></span><span style="display:flex;"><span>insert into test (id, value) values(3, 30); -- T2
</span></span><span style="display:flex;"><span>commit; -- T2
</span></span><span style="display:flex;"><span>select * from test where value % 3 = 0; -- T1. Returns the newly inserted row
</span></span><span style="display:flex;"><span>commit; -- T1
</span></span></code></pre></div><p>Postgres &ldquo;repeatable read&rdquo; prevents Predicate-Many-Preceders (PMP):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level repeatable read; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level repeatable read; -- T2
</span></span><span style="display:flex;"><span>select * from test where value = 30; -- T1. Returns nothing
</span></span><span style="display:flex;"><span>insert into test (id, value) values(3, 30); -- T2
</span></span><span style="display:flex;"><span>commit; -- T2
</span></span><span style="display:flex;"><span>select * from test where value % 3 = 0; -- T1. Still returns nothing
</span></span><span style="display:flex;"><span>commit; -- T1
</span></span></code></pre></div><p>Postgres &ldquo;read committed&rdquo; does not prevent Predicate-Many-Preceders (PMP) for write predicates &ndash; example from Postgres documentation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T2
</span></span><span style="display:flex;"><span>update test set value = value + 10; -- T1
</span></span><span style="display:flex;"><span>delete from test where value = 20;  -- T2, BLOCKS
</span></span><span style="display:flex;"><span>commit; -- T1. This unblocks T2
</span></span><span style="display:flex;"><span>select * from test where value = 20; -- T2, returns 1 =&gt; 20 (despite ostensibly having been deleted)
</span></span><span style="display:flex;"><span>commit; -- T2
</span></span></code></pre></div><p>Postgres &ldquo;repeatable read&rdquo; prevents Predicate-Many-Preceders (PMP) for write predicates &ndash; example from Postgres documentation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level repeatable read; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level repeatable read; -- T2
</span></span><span style="display:flex;"><span>update test set value = value + 10; -- T1
</span></span><span style="display:flex;"><span>delete from test where value = 20;  -- T2, BLOCKS
</span></span><span style="display:flex;"><span>commit; -- T1. T2 now prints out &#34;ERROR: could not serialize access due to concurrent update&#34;
</span></span><span style="display:flex;"><span>abort;  -- T2. There&#39;s nothing else we can do, this transaction has failed
</span></span></code></pre></div><h2 id="lost-update-p4">Lost Update (P4)</h2>
<p>Postgres &ldquo;read committed&rdquo; does not prevent Lost Update (P4):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T2
</span></span><span style="display:flex;"><span>select * from test where id = 1; -- T1
</span></span><span style="display:flex;"><span>select * from test where id = 1; -- T2
</span></span><span style="display:flex;"><span>update test set value = 11 where id = 1; -- T1
</span></span><span style="display:flex;"><span>update test set value = 11 where id = 1; -- T2, BLOCKS
</span></span><span style="display:flex;"><span>commit; -- T1. This unblocks T2, so T1&#39;s update is overwritten
</span></span><span style="display:flex;"><span>commit; -- T2
</span></span></code></pre></div><p>Postgres &ldquo;repeatable read&rdquo; prevents Lost Update (P4):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level repeatable read; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level repeatable read; -- T2
</span></span><span style="display:flex;"><span>select * from test where id = 1; -- T1
</span></span><span style="display:flex;"><span>select * from test where id = 1; -- T2
</span></span><span style="display:flex;"><span>update test set value = 11 where id = 1; -- T1
</span></span><span style="display:flex;"><span>update test set value = 11 where id = 1; -- T2, BLOCKS
</span></span><span style="display:flex;"><span>commit; -- T1. T2 now prints out &#34;ERROR: could not serialize access due to concurrent update&#34;
</span></span><span style="display:flex;"><span>abort;  -- T2. There&#39;s nothing else we can do, this transaction has failed
</span></span></code></pre></div><h2 id="read-skew-g-single">Read Skew (G-single)</h2>
<p>Postgres &ldquo;read committed&rdquo; does not prevent Read Skew (G-single):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level read committed; -- T2
</span></span><span style="display:flex;"><span>select * from test where id = 1; -- T1. Shows 1 =&gt; 10
</span></span><span style="display:flex;"><span>select * from test where id = 1; -- T2
</span></span><span style="display:flex;"><span>select * from test where id = 2; -- T2
</span></span><span style="display:flex;"><span>update test set value = 12 where id = 1; -- T2
</span></span><span style="display:flex;"><span>update test set value = 18 where id = 2; -- T2
</span></span><span style="display:flex;"><span>commit; -- T2
</span></span><span style="display:flex;"><span>select * from test where id = 2; -- T1. Shows 2 =&gt; 18
</span></span><span style="display:flex;"><span>commit; -- T1
</span></span></code></pre></div><p>Postgres &ldquo;repeatable read&rdquo; prevents Read Skew (G-single):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level repeatable read; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level repeatable read; -- T2
</span></span><span style="display:flex;"><span>select * from test where id = 1; -- T1. Shows 1 =&gt; 10
</span></span><span style="display:flex;"><span>select * from test where id = 1; -- T2
</span></span><span style="display:flex;"><span>select * from test where id = 2; -- T2
</span></span><span style="display:flex;"><span>update test set value = 12 where id = 1; -- T2
</span></span><span style="display:flex;"><span>update test set value = 18 where id = 2; -- T2
</span></span><span style="display:flex;"><span>commit; -- T2
</span></span><span style="display:flex;"><span>select * from test where id = 2; -- T1. Shows 2 =&gt; 20
</span></span><span style="display:flex;"><span>commit; -- T1
</span></span></code></pre></div><p>Postgres &ldquo;repeatable read&rdquo; prevents Read Skew (G-single) &ndash; test using predicate dependencies:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level repeatable read; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level repeatable read; -- T2
</span></span><span style="display:flex;"><span>select * from test where value % 5 = 0; -- T1
</span></span><span style="display:flex;"><span>update test set value = 12 where value = 10; -- T2
</span></span><span style="display:flex;"><span>commit; -- T2
</span></span><span style="display:flex;"><span>select * from test where value % 3 = 0; -- T1. Returns nothing
</span></span><span style="display:flex;"><span>commit; -- T1
</span></span></code></pre></div><p>Postgres &ldquo;repeatable read&rdquo; prevents Read Skew (G-single) &ndash; test using write predicate:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level repeatable read; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level repeatable read; -- T2
</span></span><span style="display:flex;"><span>select * from test where id = 1; -- T1. Shows 1 =&gt; 10
</span></span><span style="display:flex;"><span>select * from test; -- T2
</span></span><span style="display:flex;"><span>update test set value = 12 where id = 1; -- T2
</span></span><span style="display:flex;"><span>update test set value = 18 where id = 2; -- T2
</span></span><span style="display:flex;"><span>commit; -- T2
</span></span><span style="display:flex;"><span>delete from test where value = 20; -- T1. Prints &#34;ERROR: could not serialize access due to concurrent update&#34;
</span></span><span style="display:flex;"><span>abort; -- T1. There&#39;s nothing else we can do, this transaction has failed
</span></span></code></pre></div><h2 id="write-skew-g2-item">Write Skew (G2-item)</h2>
<p>Postgres &ldquo;repeatable read&rdquo; does not prevent Write Skew (G2-item):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level repeatable read; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level repeatable read; -- T2
</span></span><span style="display:flex;"><span>select * from test where id in (1,2); -- T1
</span></span><span style="display:flex;"><span>select * from test where id in (1,2); -- T2
</span></span><span style="display:flex;"><span>update test set value = 11 where id = 1; -- T1
</span></span><span style="display:flex;"><span>update test set value = 21 where id = 2; -- T2
</span></span><span style="display:flex;"><span>commit; -- T1
</span></span><span style="display:flex;"><span>commit; -- T2
</span></span></code></pre></div><p>Postgres &ldquo;serializable&rdquo; prevents Write Skew (G2-item):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level serializable; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level serializable; -- T2
</span></span><span style="display:flex;"><span>select * from test where id in (1,2); -- T1
</span></span><span style="display:flex;"><span>select * from test where id in (1,2); -- T2
</span></span><span style="display:flex;"><span>update test set value = 11 where id = 1; -- T1
</span></span><span style="display:flex;"><span>update test set value = 21 where id = 2; -- T2
</span></span><span style="display:flex;"><span>commit; -- T1
</span></span><span style="display:flex;"><span>commit; -- T2. Prints out &#34;ERROR: could not serialize access due to read/write dependencies among transactions&#34;
</span></span></code></pre></div><h2 id="anti-dependency-cycles-g2">Anti-Dependency Cycles (G2)</h2>
<p>Postgres &ldquo;repeatable read&rdquo; does not prevent Anti-Dependency Cycles (G2):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level repeatable read; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level repeatable read; -- T2
</span></span><span style="display:flex;"><span>select * from test where value % 3 = 0; -- T1
</span></span><span style="display:flex;"><span>select * from test where value % 3 = 0; -- T2
</span></span><span style="display:flex;"><span>insert into test (id, value) values(3, 30); -- T1
</span></span><span style="display:flex;"><span>insert into test (id, value) values(4, 42); -- T2
</span></span><span style="display:flex;"><span>commit; -- T1
</span></span><span style="display:flex;"><span>commit; -- T2
</span></span><span style="display:flex;"><span>select * from test where value % 3 = 0; -- Either. Returns 3 =&gt; 30, 4 =&gt; 42
</span></span></code></pre></div><p>Postgres &ldquo;serializable&rdquo; prevents Anti-Dependency Cycles (G2):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level serializable; -- T1
</span></span><span style="display:flex;"><span>begin; set transaction isolation level serializable; -- T2
</span></span><span style="display:flex;"><span>select * from test where value % 3 = 0; -- T1
</span></span><span style="display:flex;"><span>select * from test where value % 3 = 0; -- T2
</span></span><span style="display:flex;"><span>insert into test (id, value) values(3, 30); -- T1
</span></span><span style="display:flex;"><span>insert into test (id, value) values(4, 42); -- T2
</span></span><span style="display:flex;"><span>commit; -- T1
</span></span><span style="display:flex;"><span>commit; -- T2. Prints out &#34;ERROR: could not serialize access due to read/write dependencies among transactions&#34;
</span></span></code></pre></div><p>Postgres &ldquo;serializable&rdquo; prevents Anti-Dependency Cycles (G2) &ndash; Fekete et al&rsquo;s example with two anti-dependency edges:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>begin; set transaction isolation level serializable; -- T1
</span></span><span style="display:flex;"><span>select * from test; -- T1. Shows 1 =&gt; 10, 2 =&gt; 20
</span></span><span style="display:flex;"><span>begin; set transaction isolation level serializable; -- T2
</span></span><span style="display:flex;"><span>update test set value = value + 5 where id = 2; -- T2
</span></span><span style="display:flex;"><span>commit; -- T2
</span></span><span style="display:flex;"><span>begin; set transaction isolation level serializable; -- T3
</span></span><span style="display:flex;"><span>select * from test; -- T3. Shows 1 =&gt; 10, 2 =&gt; 25
</span></span><span style="display:flex;"><span>commit; -- T3
</span></span><span style="display:flex;"><span>update test set value = 0 where id = 1; -- T1. Prints out &#34;ERROR: could not serialize access due to read/write dependencies among transactions&#34;
</span></span><span style="display:flex;"><span>abort; -- T1. There&#39;s nothing else we can do, this transaction has failed
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-12d8dcfa24f5ab1593a638e88358ce04">CDC 变更数据捕获机理</h1>
	<div class="lead">数据变更捕获是一种很有趣的ETL替代方案。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2019-06-12" class="text-muted">2019年06月12日</time>
        
	</div>
	<p>在实际生产中，我们经常需要把数据库的状态同步到其他地方去，例如同步到数据仓库进行分析，同步到消息队列供下游消费，同步到缓存以加速查询。总的来说，搬运状态有两大类方法：ETL与CDC。</p>
<hr>
<h2 id="前驱知识">前驱知识</h2>
<h3 id="cdc与etl">CDC与ETL</h3>
<p>数据库在本质上是一个<strong>状态集合</strong>，任何对数据库的<strong>变更</strong>（增删改）本质上都是对状态的修改。</p>
<p>在实际生产中，我们经常需要把数据库的状态同步到其他地方去，例如同步到数据仓库进行分析，同步到消息队列供下游消费，同步到缓存以加速查询。总的来说，搬运状态有两大类方法：ETL与CDC。</p>
<ul>
<li>
<p>ETL（ExtractTransformLoad）着眼于状态本身，用定时批量轮询的方式拉取状态本身。</p>
</li>
<li>
<p>CDC（ChangeDataCapture）则着眼于变更，以流式的方式持续收集状态变化事件（变更）。</p>
</li>
</ul>
<p>ETL大家都耳熟能详，每天批量跑ETL任务，从生产OLTP数据库 <strong>拉取（E）</strong> ， <strong>转换（T）</strong> 格式， <strong>导入（L）</strong> 数仓，在此不赘述。相比ETL而言，CDC算是个新鲜玩意，随着流计算的崛起也越来越多地进入人们的视线。</p>
<p><strong>变更数据捕获（change data capture, CDC）<strong>是一种观察写入数据库的所有数据变更，并将其提取并转换为可以复制到其他系统中的形式的过程。 CDC很有意思，特别是当</strong>变更</strong>能在被写入数据库后立刻用于后续的<strong>流处理</strong>时。</p>
<p>例如用户可以捕获数据库中的变更，并不断将相同的变更应用至<strong>搜索索引</strong>（e.g elasticsearch）。如果变更日志以相同的顺序应用，则可以预期的是，搜索索引中的数据与数据库中的数据是匹配的。同理，这些变更也可以应用于后台刷新<strong>缓存</strong>（redis），送往<strong>消息队列（Kafka）</strong>，导入<strong>数据仓库</strong>（EventSourcing，存储不可变的事实事件记录而不是每天取快照），<strong>收集统计数据与监控（Prometheus）</strong>，等等等等。在这种意义下，外部索引，缓存，数仓都成为了<strong>PostgreSQL在逻辑上的从库</strong>，这些衍生数据系统都成为了变更流的消费者，而PostgreSQL成为了整个<strong>数据系统</strong>的主库。在这种架构下，应用只需要操心怎样把数据写入数据库，剩下的事情交给CDC即可。系统设计可以得到极大地简化：所有的数据组件都能够自动与主库在逻辑上保证（最终）一致。用户不用再为如何保证多个异构数据系统之间数据同步而焦头烂额了。</p>
<p><img src="/img/blog/pg/cdc-system.png"></p>
<p>实际上PostgreSQL自10.0版本以来提供的<strong>逻辑复制（logical replication）<strong>功能，实质上就是一个</strong>CDC应用</strong>：从主库上提取变更事件流：<code>INSERT, UPDATE, DELETE, TRUNCATE</code>，并在另一个PostgreSQL<strong>主库</strong>实例上重放。如果这些增删改事件能够被解析出来，它们就可以用于任何感兴趣的消费者，而不仅仅局限于另一个PostgreSQL实例。</p>
<h3 id="逻辑复制">逻辑复制</h3>
<p>想在传统关系型数据库上实施CDC并不容易，关系型数据库本身的<strong>预写式日志WAL</strong> 实际上就是数据库中变更事件的记录。因此从数据库中捕获变更，基本上可以认为等价于消费数据库产生的WAL日志/复制日志。（当然也有其他的变更捕获方式，例如在表上建立触发器，当变更发生时将变更记录写入另一张变更日志表，客户端不断tail这张日志表，当然也有一定的局限性）。</p>
<p>大多数数据库的复制日志的问题在于，它们一直被当做数据库的内部实现细节，而不是公开的API。客户端应该通过其数据模型和查询语言来查询数据库，而不是解析复制日志并尝试从中提取数据。许多数据库根本没有记录在案的获取变更日志的方式。因此捕获数据库中所有的变更然后将其复制到其他状态存储（搜索索引，缓存，数据仓库）中是相当困难的。</p>
<p>此外，<strong>仅有</strong> 数据库变更日志仍然是不够的。如果你拥有 <strong>全量</strong> 变更日志，当然可以通过重放日志来重建数据库的完整状态。但是在许多情况下保留全量历史WAL日志并不是可行的选择（例如磁盘空间与重放耗时的限制）。	例如，构建新的全文索引需要整个数据库的完整副本 —— 仅仅应用最新的变更日志是不够的，因为这样会丢失最近没有更新过的项目。因此如果你不能保留完整的历史日志，那么你至少需要包留一个一致的数据库快照，并保留从该快照开始的变更日志。</p>
<p>因此实施CDC，数据库至少需要提供以下功能：</p>
<ol>
<li>
<p>获取数据库的<strong>变更日志（WAL）</strong>，并解码成逻辑上的事件（对表的增删改而不是数据库的内部表示）</p>
</li>
<li>
<p>获取数据库的&quot;<strong>一致性快照</strong>&quot;，从而订阅者可以从任意一个一致性状态开始订阅而不是数据库创建伊始。</p>
</li>
<li>
<p>保存<strong>消费者偏移量</strong>，以便跟踪订阅者的消费进度，及时清理回收不用的变更日志以免撑爆磁盘。</p>
</li>
</ol>
<p>我们会发现，PostgreSQL在实现逻辑复制的同时，已经提供了一切CDC所需要的基础设施。</p>
<ul>
<li><strong>逻辑解码（Logical Decoding）</strong>，用于从WAL日志中解析逻辑变更事件</li>
<li><strong>复制协议（Replication Protocol）</strong>：提供了消费者实时订阅（甚至同步订阅）数据库变更的机制</li>
<li><strong>快照导出（export snapshot）</strong>：允许导出数据库的一致性快照（<code>pg_export_snapshot</code>）</li>
<li><strong>复制槽（Replication Slot）</strong>，用于保存消费者偏移量，跟踪订阅者进度。</li>
</ul>
<p>因此，在PostgreSQL上实施CDC最为直观优雅的方式，<strong>就是按照PostgreSQL的复制协议编写一个&quot;逻辑从库&quot;</strong> ，从数据库中实时地，流式地接受逻辑解码后的变更事件，完成自己定义的处理逻辑，并及时向数据库汇报自己的消息消费进度。就像使用Kafka一样。在这里CDC客户端可以将自己伪装成一个PostgreSQL的从库，从而不断地实时从PostgreSQL主库中接收逻辑解码后的变更内容。同时CDC客户端还可以通过PostgreSQL提供的<strong>复制槽（Replication Slot）<strong>机制来保存自己的</strong>消费者偏移量</strong>，即消费进度，实现类似消息队列<strong>一至少次</strong>的保证，保证不错过变更数据。(客户端自己记录消费者偏移量跳过重复记录，即可实现&quot;<strong>恰好一次</strong> &ldquo;的保证 )</p>
<h3 id="逻辑解码">逻辑解码</h3>
<p>在开始进一步的讨论之前，让我们先来看一看期待的输出结果到底是什么样子。</p>
<p>PostgreSQL的变更事件以<strong>二进制内部表示</strong>形式保存在预写式日志（WAL）中，使用其自带的<code>pg_waldump</code>工具可以解析出来一些人类可读的信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>rmgr: Btree       len (rec/tot):     64/    64, tx:       1342, lsn: 2D/AAFFC9F0, prev 2D/AAFFC810, desc: INSERT_LEAF off 126, blkref #0: rel 1663/3101882/3105398 blk 4
</span></span><span style="display:flex;"><span>rmgr: Heap        len (rec/tot):    485/   485, tx:       1342, lsn: 2D/AAFFCA30, prev 2D/AAFFC9F0, desc: INSERT off 10, blkref #0: rel 1663/3101882/3105391 blk 139
</span></span></code></pre></div><p>WAL日志里包含了完整权威的变更事件记录，但这种记录格式过于底层。用户并不会对磁盘上某个数据页里的二进制变更（文件A页面B偏移量C追加写入二进制数据D）感兴趣，他们感兴趣的是某张表中增删改了哪些行哪些字段。<strong>逻辑解码</strong>就是将物理变更记录翻译为用户期望的逻辑变更事件的机制（例如表A上的增删改事件）。</p>
<p>例如用户可能期望的是，能够解码出等价的SQL语句</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>INSERT INTO public.test (id, data) VALUES (14, &#39;hoho&#39;);
</span></span></code></pre></div><p>或者最为通用的JSON结构（这里以JSON格式记录了一条UPDATE事件）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;change&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;kind&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;schema&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;public&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;table&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;test&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;columnnames&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;data&#34;</span> <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;columntypes&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span> <span style="color:#4e9a06">&#34;integer&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;text&#34;</span> <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;columnvalues&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hoho&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;oldkeys&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">&#34;keynames&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span> <span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;keytypes&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;integer&#34;</span> <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;keyvalues&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>当然也可以是更为紧凑高效严格的Protobuf格式，更为灵活的Avro格式，抑或是任何用户感兴趣的格式。</p>
<p><strong>逻辑解码</strong> 所要解决的问题，就是将数据库内部二进制表示的变更事件，<strong>解码（Decoding）<strong>成为用户感兴趣的格式。之所以需要这样一个过程，是因为数据库内部表示是非常紧凑的，想要解读原始的二进制WAL日志，不仅仅需要WAL结构相关的知识，还需要</strong>系统目录（System Catalog）</strong>，即元数据。没有元数据就无从得知用户可能感兴趣的模式名，表名，列名，只能解析出来的一系列数据库自己才能看懂的oid。</p>
<p>关于流复制协议，复制槽，事务快照等概念与功能，这里就不展开了，让我们进入动手环节。</p>
<hr>
<h2 id="快速开始">快速开始</h2>
<p>假设我们有一张用户表，我们希望捕获任何发生在它上面的变更，假设数据库发生了如下变更操作</p>
<p>下面会重复用到这几条命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">SERIAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">users</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;Vonng&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">users</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">101</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;Xiao Wang&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DELETE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">users</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">users</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;Lao Wang&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">101</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>最终数据库的状态是：只有一条<code>(101, 'Lao Wang')</code>的记录。无论是曾经有一个名为<code>Vonng</code>的用户存在过的痕迹，抑或是隔壁老王也曾年轻过的事实，都随着对数据库的删改而烟消云散。我们希望这些事实不应随风而逝，需要被记录下来。</p>
<h3 id="操作流程">操作流程</h3>
<p>通常来说，订阅变更需要以下几步操作：</p>
<ul>
<li>选择一个一致性的数据库快照，作为订阅变更的起点。(创建一个复制槽)</li>
<li>(数据库发生了一些变更)</li>
<li>读取这些变更，更新自己的的消费进度。</li>
</ul>
<p>那么， 让我们先从最简单的办法开始，从PostgreSQL自带的的SQL接口开始</p>
<h3 id="sql接口">SQL接口</h3>
<p>逻辑复制槽的增删查API：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_replication_slots</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 查
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pg_create_logical_replication_slot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">slot_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">plugin</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 增
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pg_drop_replication_slot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">slot_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 删
</span></span></span></code></pre></div><p>从逻辑复制槽中获取最新的变更数据：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">pg_logical_slot_get_changes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">slot_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...)</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- 消费掉
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pg_logical_slot_peek_changes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">slot_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 只查看不消费
</span></span></span></code></pre></div><p>在正式开始前，还需要对数据库参数做一些修改，修改<code>wal_level = logical</code>，这样在WAL日志中的信息才能足够用于逻辑解码。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 创建一个复制槽test_slot，使用系统自带的测试解码插件test_decoding，解码插件会在后面介绍
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_create_logical_replication_slot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;test_slot&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;test_decoding&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 重放上面的建表与增删改操作
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- DROP TABLE | CREATE TABLE | INSERT 1 | INSERT 1 | DELETE 1 | UPDATE 1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 读取复制槽test_slot中未消费的最新的变更事件流
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">pg_logical_slot_get_changes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;test_slot&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">lsn</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">xid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                                </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------+-----+--------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">167</span><span style="color:#000">C7E8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">569</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">569</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">169</span><span style="color:#000">F6F8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">569</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">569</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">169</span><span style="color:#000">F6F8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">570</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">570</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">169</span><span style="color:#000">F6F8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">570</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">]:</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">]:</span><span style="color:#4e9a06">&#39;Vonng&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">169</span><span style="color:#000">F810</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">570</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">570</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">169</span><span style="color:#000">F810</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">571</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">571</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">169</span><span style="color:#000">F810</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">571</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">]:</span><span style="color:#0000cf;font-weight:bold">101</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">]:</span><span style="color:#4e9a06">&#39;Xiao Wang&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">169</span><span style="color:#000">F8C8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">571</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">571</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">169</span><span style="color:#000">F8C8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">572</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">572</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">169</span><span style="color:#000">F8C8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">572</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DELETE</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">]:</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">169</span><span style="color:#000">F938</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">572</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">572</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">169</span><span style="color:#000">F970</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">573</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">573</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">169</span><span style="color:#000">F970</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">573</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">]:</span><span style="color:#0000cf;font-weight:bold">101</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">]:</span><span style="color:#4e9a06">&#39;Lao Wang&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">169</span><span style="color:#000">F9F0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">573</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">573</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 清理掉创建的复制槽
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_drop_replication_slot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;test_slot&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这里，我们可以看到一系列被触发的事件，其中每个事务的开始与提交都会触发一个事件。因为目前逻辑解码机制不支持DDL变更，因此<code>CREATE TABLE</code>与<code>DROP TABLE</code>并没有出现在事件流中，只能看到空荡荡的<code>BEGIN+COMMIT</code>。另一点需要注意的是，只有<strong>成功提交的事务才会产生逻辑解码变更事件</strong>。也就是说用户不用担心收到并处理了很多行变更消息之后，最后发现事务回滚了，还需要担心怎么通知消费者去会跟变更。</p>
<p>通过SQL接口，用户已经能够拉取最新的变更了。这也就意味着任何有着PostgreSQL驱动的语言都可以通过这种方式从数据库中捕获最新的变更。当然这种方式实话说还是略过于土鳖。更好的方式是利用PostgreSQL的复制协议直接从数据库中订阅变更数据流。当然相比使用SQL接口，这也需要更多的工作。</p>
<h3 id="使用客户端接收变更">使用客户端接收变更</h3>
<p>在编写自己的CDC客户端之前，让我们先来试用一下官方自带的CDC客户端样例——<code>pg_recvlogical</code>。与<code>pg_receivewal</code>类似，不过它接收的是逻辑解码后的变更，下面是一个具体的例子：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启动一个CDC客户端，连接数据库postgres，创建名为test_slot的槽，使用test_decoding解码插件，标准输出</span>
</span></span><span style="display:flex;"><span>pg_recvlogical <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	-d postgres <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--create-slot --if-not-exists --slot<span style="color:#ce5c00;font-weight:bold">=</span>test_slot <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--plugin<span style="color:#ce5c00;font-weight:bold">=</span>test_decoding <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--start -f -
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 开启另一个会话，重放上面的建表与增删改操作</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># DROP TABLE | CREATE TABLE | INSERT 1 | INSERT 1 | DELETE 1 | UPDATE 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pg_recvlogical输出结果</span>
</span></span><span style="display:flex;"><span>BEGIN <span style="color:#0000cf;font-weight:bold">585</span>
</span></span><span style="display:flex;"><span>COMMIT <span style="color:#0000cf;font-weight:bold">585</span>
</span></span><span style="display:flex;"><span>BEGIN <span style="color:#0000cf;font-weight:bold">586</span>
</span></span><span style="display:flex;"><span>table public.users: INSERT: id<span style="color:#ce5c00;font-weight:bold">[</span>integer<span style="color:#ce5c00;font-weight:bold">]</span>:100 name<span style="color:#ce5c00;font-weight:bold">[</span>text<span style="color:#ce5c00;font-weight:bold">]</span>:<span style="color:#4e9a06">&#39;Vonng&#39;</span>
</span></span><span style="display:flex;"><span>COMMIT <span style="color:#0000cf;font-weight:bold">586</span>
</span></span><span style="display:flex;"><span>BEGIN <span style="color:#0000cf;font-weight:bold">587</span>
</span></span><span style="display:flex;"><span>table public.users: INSERT: id<span style="color:#ce5c00;font-weight:bold">[</span>integer<span style="color:#ce5c00;font-weight:bold">]</span>:101 name<span style="color:#ce5c00;font-weight:bold">[</span>text<span style="color:#ce5c00;font-weight:bold">]</span>:<span style="color:#4e9a06">&#39;Xiao Wang&#39;</span>
</span></span><span style="display:flex;"><span>COMMIT <span style="color:#0000cf;font-weight:bold">587</span>
</span></span><span style="display:flex;"><span>BEGIN <span style="color:#0000cf;font-weight:bold">588</span>
</span></span><span style="display:flex;"><span>table public.users: DELETE: id<span style="color:#ce5c00;font-weight:bold">[</span>integer<span style="color:#ce5c00;font-weight:bold">]</span>:100
</span></span><span style="display:flex;"><span>COMMIT <span style="color:#0000cf;font-weight:bold">588</span>
</span></span><span style="display:flex;"><span>BEGIN <span style="color:#0000cf;font-weight:bold">589</span>
</span></span><span style="display:flex;"><span>table public.users: UPDATE: id<span style="color:#ce5c00;font-weight:bold">[</span>integer<span style="color:#ce5c00;font-weight:bold">]</span>:101 name<span style="color:#ce5c00;font-weight:bold">[</span>text<span style="color:#ce5c00;font-weight:bold">]</span>:<span style="color:#4e9a06">&#39;Lao Wang&#39;</span>
</span></span><span style="display:flex;"><span>COMMIT <span style="color:#0000cf;font-weight:bold">589</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 清理：删除创建的复制槽</span>
</span></span><span style="display:flex;"><span>pg_recvlogical -d postgres --drop-slot --slot<span style="color:#ce5c00;font-weight:bold">=</span>test_slot
</span></span></code></pre></div><p>上面的例子中，主要的变更事件包括事务的<strong>开始</strong>与<strong>结束</strong>，以及<strong>数据行的增删改</strong>。这里默认的<code>test_decoding</code>插件的输出格式为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{事务标识}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{模式名}</span><span style="color:#000;font-weight:bold">.</span><span style="color:#a40000">{表名}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{命令</span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#204a87;font-weight:bold">DELETE</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">{列名}</span><span style="color:#000;font-weight:bold">[</span><span style="color:#a40000">{类型}</span><span style="color:#000;font-weight:bold">]:</span><span style="color:#a40000">{取值}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{事务标识}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>实际上，PostgreSQL的逻辑解码是这样工作的，每当特定的事件发生（表的Truncate，行级别的增删改，事务开始与提交），PostgreSQL都会调用一系列的钩子函数。所谓的<strong>逻辑解码输出插件（Logical Decoding Output Plugin）</strong>，就是这样一组回调函数的集合。它们接受二进制内部表示的变更事件作为输入，查阅一些系统目录，将二进制数据翻译成为用户感兴趣的结果。</p>
<h3 id="逻辑解码输出插件">逻辑解码输出插件</h3>
<p>除了PostgreSQL自带的&quot;用于测试&quot;的逻辑解码插件：<a href="https://github.com/postgres/postgres/blob/master/contrib/test_decoding/test_decoding.c"><code>test_decoding</code></a> 之外，还有很多现成的输出插件，例如：</p>
<ul>
<li>JSON格式输出插件：<a href="https://github.com/eulerto/wal2json"><code>wal2json</code></a></li>
<li>SQL格式输出插件：<a href="https://github.com/michaelpq/pg_plugins/tree/master/decoder_raw"><code>decoder_raw</code></a></li>
<li>Protobuf输出插件：<a href="https://github.com/debezium/postgres-decoderbufs"><code>decoderbufs</code></a></li>
</ul>
<p>当然还有PostgreSQL自带逻辑复制所使用的解码插件：<code>pgoutput</code>，其消息格式<a href="https://www.postgresql.org/docs/11/protocol-logicalrep-message-formats.html">文档地址</a>。</p>
<p>安装这些插件非常简单，有一些插件（例如<code>wal2json</code>）可以直接从官方二进制源轻松安装。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install wal2json11
</span></span><span style="display:flex;"><span>apt install postgresql-11-wal2json
</span></span></code></pre></div><p>或者如果没有二进制包，也可以自己下载编译。只需要确保<code>pg_config</code>已经在你的<code>PATH</code>中，然后执行<code>make &amp; sudo make install</code>两板斧即可。以输出SQL格式的<code>decoder_raw</code>插件为例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/michaelpq/pg_plugins <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87">cd</span> pg_plugins/decoder_raw
</span></span><span style="display:flex;"><span>make <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo make install
</span></span></code></pre></div><p>使用<code>wal2json</code>接收同样的变更</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg_recvlogical -d postgres --drop-slot --slot<span style="color:#ce5c00;font-weight:bold">=</span>test_slot
</span></span><span style="display:flex;"><span>pg_recvlogical -d postgres --create-slot --if-not-exists --slot<span style="color:#ce5c00;font-weight:bold">=</span>test_slot <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--plugin<span style="color:#ce5c00;font-weight:bold">=</span>wal2json --start -f -
</span></span></code></pre></div><p>结果为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;change&#34;</span><span style="color:#000;font-weight:bold">:[]}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;change&#34;</span><span style="color:#000;font-weight:bold">:[{</span><span style="color:#204a87;font-weight:bold">&#34;kind&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">&#34;insert&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">&#34;schema&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">&#34;public&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">&#34;table&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">&#34;columnnames&#34;</span><span style="color:#000;font-weight:bold">:[</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">],</span><span style="color:#204a87;font-weight:bold">&#34;columntypes&#34;</span><span style="color:#000;font-weight:bold">:[</span><span style="color:#4e9a06">&#34;integer&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;text&#34;</span><span style="color:#000;font-weight:bold">],</span><span style="color:#204a87;font-weight:bold">&#34;columnvalues&#34;</span><span style="color:#000;font-weight:bold">:[</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;Vonng&#34;</span><span style="color:#000;font-weight:bold">]}]}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;change&#34;</span><span style="color:#000;font-weight:bold">:[{</span><span style="color:#204a87;font-weight:bold">&#34;kind&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">&#34;insert&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">&#34;schema&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">&#34;public&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">&#34;table&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">&#34;columnnames&#34;</span><span style="color:#000;font-weight:bold">:[</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">],</span><span style="color:#204a87;font-weight:bold">&#34;columntypes&#34;</span><span style="color:#000;font-weight:bold">:[</span><span style="color:#4e9a06">&#34;integer&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;text&#34;</span><span style="color:#000;font-weight:bold">],</span><span style="color:#204a87;font-weight:bold">&#34;columnvalues&#34;</span><span style="color:#000;font-weight:bold">:[</span><span style="color:#0000cf;font-weight:bold">101</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;Xiao Wang&#34;</span><span style="color:#000;font-weight:bold">]}]}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;change&#34;</span><span style="color:#000;font-weight:bold">:[{</span><span style="color:#204a87;font-weight:bold">&#34;kind&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">&#34;schema&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">&#34;public&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">&#34;table&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">&#34;oldkeys&#34;</span><span style="color:#000;font-weight:bold">:{</span><span style="color:#204a87;font-weight:bold">&#34;keynames&#34;</span><span style="color:#000;font-weight:bold">:[</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">],</span><span style="color:#204a87;font-weight:bold">&#34;keytypes&#34;</span><span style="color:#000;font-weight:bold">:[</span><span style="color:#4e9a06">&#34;integer&#34;</span><span style="color:#000;font-weight:bold">],</span><span style="color:#204a87;font-weight:bold">&#34;keyvalues&#34;</span><span style="color:#000;font-weight:bold">:[</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">]}}]}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;change&#34;</span><span style="color:#000;font-weight:bold">:[{</span><span style="color:#204a87;font-weight:bold">&#34;kind&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">&#34;schema&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">&#34;public&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">&#34;table&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">&#34;columnnames&#34;</span><span style="color:#000;font-weight:bold">:[</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">],</span><span style="color:#204a87;font-weight:bold">&#34;columntypes&#34;</span><span style="color:#000;font-weight:bold">:[</span><span style="color:#4e9a06">&#34;integer&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;text&#34;</span><span style="color:#000;font-weight:bold">],</span><span style="color:#204a87;font-weight:bold">&#34;columnvalues&#34;</span><span style="color:#000;font-weight:bold">:[</span><span style="color:#0000cf;font-weight:bold">101</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;Lao Wang&#34;</span><span style="color:#000;font-weight:bold">],</span><span style="color:#204a87;font-weight:bold">&#34;oldkeys&#34;</span><span style="color:#000;font-weight:bold">:{</span><span style="color:#204a87;font-weight:bold">&#34;keynames&#34;</span><span style="color:#000;font-weight:bold">:[</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">],</span><span style="color:#204a87;font-weight:bold">&#34;keytypes&#34;</span><span style="color:#000;font-weight:bold">:[</span><span style="color:#4e9a06">&#34;integer&#34;</span><span style="color:#000;font-weight:bold">],</span><span style="color:#204a87;font-weight:bold">&#34;keyvalues&#34;</span><span style="color:#000;font-weight:bold">:[</span><span style="color:#0000cf;font-weight:bold">101</span><span style="color:#000;font-weight:bold">]}}]}</span>
</span></span></code></pre></div><p>而使用<code>decoder_raw</code>获取SQL格式的输出</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg_recvlogical -d postgres --drop-slot --slot<span style="color:#ce5c00;font-weight:bold">=</span>test_slot
</span></span><span style="display:flex;"><span>pg_recvlogical -d postgres --create-slot --if-not-exists --slot<span style="color:#ce5c00;font-weight:bold">=</span>test_slot <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	--plugin<span style="color:#ce5c00;font-weight:bold">=</span>decoder_raw --start -f -
</span></span></code></pre></div><p>结果为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">users</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;Vonng&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">users</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">101</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;Xiao Wang&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DELETE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">users</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">users</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">101</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;Lao Wang&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">101</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><code>decoder_raw</code>可以用于抽取SQL形式表示的状态变更，将这些抽取得到的SQL语句在同样的基础状态上重放，即可得到相同的结果。PostgreSQL就是使用这样的机制实现逻辑复制的。</p>
<p>一个典型的应用场景就是数据库不停机迁移。在传统不停机迁移模式（双写，改读，改写）中，第三步改写完成后是无法快速回滚的，因为写入流量在切换至新主库后如果发现有问题想立刻回滚，老主库上会丢失一些数据。这时候就可以使用<code>decoder_raw</code>提取主库上的最新变更，并通过一行简单的Bash命令，将新主库上的变更实时同步到旧主库。保证迁移过程中任何时刻都可以快速回滚至老主库。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg_recvlogical -d &lt;new_master_url&gt; --slot<span style="color:#ce5c00;font-weight:bold">=</span>test_slot --plugin<span style="color:#ce5c00;font-weight:bold">=</span>decoder_raw --start -f - <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>psql &lt;old_master_url&gt;
</span></span></code></pre></div><p>另一个有趣的场景是UNDO LOG。PostgreSQL的故障恢复是基于REDO LOG的，通过重放WAL会到历史上的任意时间点。在数据库模式不发生变化的情况下，如果只是单纯的表内容增删改出现了失误，完全可以利用类似<code>decoder_raw</code>的方式反向生成UNDO日志。提高此类故障恢复的速度。</p>
<p>最后，输出插件可以将变更事件格式化为各种各样的形式。解码输出为Redis的kv操作，或者仅仅抽取一些关键字段用于更新统计数据或者构建外部索引，有着很大的想象空间。</p>
<p>编写自定义的逻辑解码输出插件并不复杂，可以参阅<a href="https://www.postgresql.org/docs/11/logicaldecoding-output-plugin.html">这篇</a>官方文档。毕竟逻辑解码输出插件本质上只是一个拼字符串的回调函数集合。在<a href="https://github.com/postgres/postgres/blob/master/contrib/test_decoding/test_decoding.c">官方样例</a>的基础上稍作修改，即可轻松实现一个你自己的逻辑解码输出插件。</p>
<hr>
<h2 id="cdc客户端">CDC客户端</h2>
<p>PostgreSQL自带了一个名为<code>pg_recvlogical</code>的客户端应用，可以将逻辑变更的事件流写至标准输出。但并不是所有的消费者都可以或者愿意使用Unix Pipe来完成所有工作的。此外，根据端到端原则，使用<code>pg_recvlogical</code>将变更数据流落盘并不意味着消费者已经拿到并确认了该消息，只有消费者自己亲自向数据库确认才可以做到这一点。</p>
<p>编写PostgreSQL的CDC客户端程序，本质上是实现了一个&quot;猴版”数据库从库。客户端向数据库建立一条<strong>复制连接（Replication Connection）</strong> ，将自己伪装成一个从库：从主库获取解码后的变更消息流，并周期性地向主库汇报自己的消费进度（落盘进度，刷盘进度，应用进度）。</p>
<h3 id="复制连接">复制连接</h3>
<p>复制连接，顾名思义就是用于<strong>复制（Replication）</strong> 的特殊连接。当与PostgreSQL服务器建立连接时，如果连接参数中提供了<code>replication=database|on|yes|1</code>，就会建立一条复制连接，而不是普通连接。复制连接可以执行一些特殊的命令，例如<code>IDENTIFY_SYSTEM</code>, <code>TIMELINE_HISTORY</code>, <code>CREATE_REPLICATION_SLOT</code>, <code>START_REPLICATION</code>, <code>BASE_BACKUP</code>, 在逻辑复制的情况下，还可以执行一些简单的SQL查询。具体细节可以参考PostgreSQL官方文档中前后端协议一章：https://www.postgresql.org/docs/current/protocol-replication.html</p>
<p>譬如，下面这条命令就会建立一条复制连接：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ psql <span style="color:#4e9a06">&#39;postgres://localhost:5432/postgres?replication=on&amp;application_name=mocker&#39;</span>
</span></span></code></pre></div><p>从系统视图<code>pg_stat_replication</code>可以看到主库识别到了一个新的&quot;从库&rdquo;</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>vonng=# table pg_stat_replication ;
</span></span><span style="display:flex;"><span>-[ RECORD 1 ]----+-----------------------------
</span></span><span style="display:flex;"><span>pid              | 7218
</span></span><span style="display:flex;"><span>usesysid         | 10
</span></span><span style="display:flex;"><span>usename          | vonng
</span></span><span style="display:flex;"><span>application_name | mocker
</span></span><span style="display:flex;"><span>client_addr      | ::1
</span></span><span style="display:flex;"><span>client_hostname  |
</span></span><span style="display:flex;"><span>client_port      | 53420
</span></span></code></pre></div><h3 id="编写自定义逻辑">编写自定义逻辑</h3>
<p>无论是JDBC还是Go语言的PostgreSQL驱动，都提供了相应的基础设施，用于处理复制连接。</p>
<p>这里让我们用Go语言编写一个简单的CDC客户端，样例使用了<a href="https://github.com/jackx/pgx"><code>jackc/pgx</code></a>，一个很不错的Go语言编写的PostgreSQL驱动。这里的代码只是作为概念演示，因此忽略掉了错误处理，非常Naive。将下面的代码保存为<code>main.go</code>，执行<code>go run main.go</code>即可执行。</p>
<p>默认的三个参数分别为数据库连接串，逻辑解码输出插件的名称，以及复制槽的名称。默认值为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">dsn</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;postgres://localhost:5432/postgres?application_name=cdc&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">plugin</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;test_decoding&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">slot</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;test_slot&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>go run main.go postgres:///postgres?application_name=cdc test_decoding test_slot
</span></span></code></pre></div><p>代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/jackc/pgx&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Subscriber</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">URL</span>    <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Slot</span>   <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Plugin</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Conn</span>   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pgx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicationConn</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">LSN</span>    <span style="color:#204a87;font-weight:bold">uint64</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Connect 会建立到服务器的复制连接，区别在于自动添加了replication=on|1|yes|dbname参数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">connConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pgx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseURI</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">pgx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicationConnect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">connConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ReportProgress 会向主库汇报写盘，刷盘，应用的进度坐标（消费者偏移量）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ReportProgress</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pgx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewStandbyStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LSN</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SendStandbyStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// CreateReplicationSlot 会创建逻辑复制槽，并使用给定的解码插件
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">CreateReplicationSlot</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">consistPoint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">snapshotName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateReplicationSlotEx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Slot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Plugin</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fail to create replication slot: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;create replication slot %s with plugin %s : consist snapshot: %s, snapshot name: %s&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Slot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Plugin</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">consistPoint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">snapshotName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LSN</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">pgx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseLSN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">consistPoint</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// StartReplication 会启动逻辑复制（服务器会开始发送事件消息）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">StartReplication</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartReplication</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Slot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fail to start replication on slot %s : %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Slot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// DropReplicationSlot 会使用临时普通连接删除复制槽（如果存在）,注意如果复制连接正在使用这个槽是没法删的。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">DropReplicationSlot</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">connConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pgx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseURI</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">conn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pgx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">connConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">slotExists</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">QueryRow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`SELECT EXISTS(SELECT 1 FROM pg_replication_slots WHERE slot_name = $1)`</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Slot</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Scan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">slotExists</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">slotExists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SELECT pg_drop_replication_slot($1)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Slot</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;drop replication slot %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Slot</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Subscribe 开始订阅变更事件，主消息循环
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Subscribe</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">message</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pgx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicationMessage</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 等待一条消息, 消息有可能是真的消息，也可能只是心跳包
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForReplicationMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WalMessage</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">DoSomething</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WalMessage</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 如果是真的消息就消费它
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WalMessage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WalStart</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LSN</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// 消费完后更新消费进度，并向主库汇报
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LSN</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WalMessage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WalStart</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87">uint64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WalMessage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WalData</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReportProgress</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 如果是心跳包消息，按照协议，需要检查服务器是否要求回送进度。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServerHeartbeat</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServerHeartbeat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplyRequested</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReportProgress</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// 如果服务器心跳包要求回送进度，则汇报进度
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 实际消费消息的函数，这里只是把消息打印出来，也可以写入Redis，写入Kafka，更新统计信息，发送邮件等
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">DoSomething</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pgx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WalMessage</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[LSN] %s [Payload] %s&#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>             <span style="color:#000">pgx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FormatLSN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WalStart</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WalData</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 如果使用JSON解码插件，这里是用于Decode的Schema
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Payload</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Change</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Kind</span>         <span style="color:#204a87;font-weight:bold">string</span>        <span style="color:#4e9a06">`json:&#34;kind&#34;`</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Schema</span>       <span style="color:#204a87;font-weight:bold">string</span>        <span style="color:#4e9a06">`json:&#34;schema&#34;`</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Table</span>        <span style="color:#204a87;font-weight:bold">string</span>        <span style="color:#4e9a06">`json:&#34;table&#34;`</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ColumnNames</span>  <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span>      <span style="color:#4e9a06">`json:&#34;columnnames&#34;`</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ColumnTypes</span>  <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span>      <span style="color:#4e9a06">`json:&#34;columntypes&#34;`</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ColumnValues</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}</span> <span style="color:#4e9a06">`json:&#34;columnvalues&#34;`</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">OldKeys</span>      <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">KeyNames</span>  <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span>      <span style="color:#4e9a06">`json:&#34;keynames&#34;`</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">KeyTypes</span>  <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span>      <span style="color:#4e9a06">`json:&#34;keytypes&#34;`</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">KeyValues</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}</span> <span style="color:#4e9a06">`json:&#34;keyvalues&#34;`</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#4e9a06">`json:&#34;oldkeys&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#4e9a06">`json:&#34;change&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsn</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;postgres://localhost:5432/postgres?application_name=cdc&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">plugin</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;test_decoding&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">slot</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;test_slot&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">dsn</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">plugin</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">slot</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">subscriber</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">URL</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">dsn</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Slot</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">slot</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Plugin</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">plugin</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>                                <span style="color:#8f5902;font-style:italic">// 创建新的CDC客户端
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DropReplicationSlot</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// 如果存在，清理掉遗留的Slot
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">()</span>                   <span style="color:#8f5902;font-style:italic">// 建立复制连接
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DropReplicationSlot</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// 程序中止前清理掉复制槽
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateReplicationSlot</span><span style="color:#000;font-weight:bold">()</span>     <span style="color:#8f5902;font-style:italic">// 创建复制槽
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartReplication</span><span style="color:#000;font-weight:bold">()</span>          <span style="color:#8f5902;font-style:italic">// 开始接收变更流
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReportProgress</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>                                    <span style="color:#8f5902;font-style:italic">// 协程2每5秒地向主库汇报进度
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Subscribe</span><span style="color:#000;font-weight:bold">()</span>                 <span style="color:#8f5902;font-style:italic">// 主消息循环
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在另一个数据库会话中再次执行上面的变更，可以看到客户端及时地接收到了变更的内容。这里客户端只是简单地将其打印了出来，实际生产中，客户端可以完成<strong>任何工作</strong>，比如写入Kafka，写入Redis，写入磁盘日志，或者只是更新内存中的统计数据并暴露给监控系统。甚至，还可以通过配置<strong>同步提交</strong>，确保所有系统中的变更能够时刻保证严格同步（当然相比默认的异步模式比较影响性能就是了）。</p>
<p>对于PostgreSQL主库而言，这看起来就像是另一个从库。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">postgres</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stat_replication</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 查看当前从库
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RECORD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic">----+------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pid</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">14082</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">usesysid</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">usename</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vonng</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">application_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cdc</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">client_addr</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">95</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">client_hostname</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">client_port</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">56609</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">backend_start</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">606014</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">08</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">backend_xmin</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">state</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">streaming</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">sent_lsn</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">D</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">AB269AB8</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic">-- 服务端已经发送的消息坐标
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">write_lsn</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">D</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">AB269AB8</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic">-- 客户端已经执行完写入的消息坐标
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">flush_lsn</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">D</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">AB269AB8</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic">-- 客户端已经刷盘的消息坐标（不会丢失）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">replay_lsn</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">D</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">AB269AB8</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic">-- 客户端已经应用的消息坐标（已经生效）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">write_lag</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">flush_lag</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">replay_lag</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">sync_priority</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">sync_state</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">async</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">postgres</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_replication_slots</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- 查看当前复制槽
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RECORD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic">-------+------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">slot_name</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">plugin</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">decoder_raw</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">slot_type</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">logical</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">datoid</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13382</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">temporary</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">f</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">active</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">active_pid</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">14082</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">xmin</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">catalog_xmin</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1371</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">restart_lsn</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">D</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">AB269A80</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic">-- 下次客户端重连时将从这里开始重放
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">confirmed_flush_lsn</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">D</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">AB269AB8</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic">-- 客户端确认完成的消息进度
</span></span></span></code></pre></div><hr>
<h2 id="局限性">局限性</h2>
<p>想要在生产环境中使用CDC，还需要考虑一些其他的问题。略有遗憾的是，在PostgreSQL CDC的天空上，还飘着两朵小乌云。</p>
<h3 id="完备性">完备性</h3>
<p>就目前而言，PostgreSQL的逻辑解码只提供了以下几个钩子：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>LogicalDecodeStartupCB startup_cb;
</span></span><span style="display:flex;"><span>LogicalDecodeBeginCB begin_cb;
</span></span><span style="display:flex;"><span>LogicalDecodeChangeCB change_cb;
</span></span><span style="display:flex;"><span>LogicalDecodeTruncateCB truncate_cb;
</span></span><span style="display:flex;"><span>LogicalDecodeCommitCB commit_cb;
</span></span><span style="display:flex;"><span>LogicalDecodeMessageCB message_cb;
</span></span><span style="display:flex;"><span>LogicalDecodeFilterByOriginCB filter_by_origin_cb;
</span></span><span style="display:flex;"><span>LogicalDecodeShutdownCB shutdown_cb;
</span></span></code></pre></div><p>其中比较重要，也是必须提供的是三个回调函数：begin：事务开始，change：行级别增删改事件，commit：事务提交 。遗憾的是，并不是所有的事件都有相应的钩子，例如数据库的模式变更，Sequence的取值变化，以及特殊的大对象操作。</p>
<p>通常来说，这并不是一个大问题，因为用户感兴趣的往往只是表记录而不是表结构的增删改。而且，如果使用诸如JSON，Avro等灵活格式作为解码目标格式，即使表结构发生变化，也不会有什么大问题。</p>
<p>但是尝试从目前的变更事件流生成完备的UNDO Log是不可能的，因为目前模式的变更DDL并不会记录在逻辑解码的输出中。好消息是未来会有越来越多的钩子与支持，因此这个问题是可解的。</p>
<h3 id="同步提交">同步提交</h3>
<p>需要注意的一点是，<strong>有一些输出插件会无视<code>Begin</code>与<code>Commit</code>消息</strong>。这两条消息本身也是数据库变更日志的一部分，如果输出插件忽略了这些消息，那么CDC客户端在汇报消费进度时就可能会出现偏差（落后一条消息的偏移量）。在一些边界条件下可能会触发一些问题：例如写入极少的数据库启用同步提交时，主库迟迟等不到从库确认最后的<code>Commit</code>消息而卡住)</p>
<h3 id="故障切换">故障切换</h3>
<p>理想很美好，现实很骨感。当一切正常时，CDC工作流工作的很好。但当数据库出现故障，或者出现故障转移时，事情就变得比较棘手了。</p>
<p><strong>恰好一次保证</strong></p>
<p>另外一个使用PostgreSQL CDC的问题是消息队列中经典的<strong>恰好一次</strong>问题。</p>
<p>PostgreSQL的逻辑复制实际上提供的是<strong>至少一次</strong>保证，因为消费者偏移量的值会在检查点的时候保存。如果PostgreSQL主库宕机，那么重新发送变更事件的起点，不一定恰好等于上次订阅者已经消费的位置。因此有可能会发送重复的消息。</p>
<p>解决方法是：逻辑复制的消费者也需要记录自己的消费者偏移量，以便跳过重复的消息，实现真正的<strong>恰好一次</strong> 消息传达保证。这并不是一个真正的问题，只是任何试图自行实现CDC客户端的人都应当注意这一点。</p>
<p><strong>Failover Slot</strong></p>
<p>对目前PostgreSQL的CDC来说，Failover Slot是最大的难点与痛点。逻辑复制依赖复制槽，因为复制槽持有着消费者的状态，记录着消费者的消费进度，因而数据库不会将消费者还没处理的消息清理掉。</p>
<p>但以目前的实现而言，复制槽只能用在<strong>主库</strong>上，且<strong>复制槽本身并不会被复制到从库</strong>上。因此当主库进行Failover时，消费者偏移量就会丢失。如果在新的主库承接任何写入之前没有重新建好逻辑复制槽，就有可能会丢失一些数据。对于非常严格的场景，使用这个功能时仍然需要谨慎。</p>
<p>这个问题计划将于下一个大版本（13）解决，Failover Slot的<a href="https://commitfest.postgresql.org/23/1961/">Patch</a>计划于版本13（2020）年合入主线版本。</p>
<p>在那之前，如果希望在生产中使用CDC，那么务必要针对故障切换进行充分地测试。例如使用CDC的情况下，Failover的操作就需要有所变更：核心思想是运维与DBA必须手工完成复制槽的复制工作。在Failover前可以在原主库上启用同步提交，暂停写入流量并在新主库上使用脚本复制复制原主库的槽，并在新主库上创建同样的复制槽，从而手工完成复制槽的Failover。对于紧急故障切换，即原主库无法访问，需要立即切换的情况，也可以在事后使用PITR重新将缺失的变更恢复出来。</p>
<p>小结一下：CDC的功能机制已经达到了生产应用的要求，但可靠性的机制还略有欠缺，这个问题可以等待下一个主线版本，或通过审慎地手工操作解决，当然激进的用户也可以自行拉取该补丁提前尝鲜。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-15d5b18d2862f9fbfdff194078c65cf9">PostgreSQL中的锁</h1>
	<div class="lead">详细介绍PostgreSQL中的各种锁</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>） ｜ <a href="https://mp.weixin.qq.com/s/JCKKM8vDkBlq0-PlPqfh7Q">微信公众号</a></b> |
        
		<time datetime="2019-06-11" class="text-muted">2019年06月11日</time>
        
	</div>
	<p>PostgreSQL的并发控制以 <strong>快照隔离（SI）</strong> 为主，以 <strong>两阶段锁定（2PL）</strong> 机制为辅。PostgreSQL对DML（<code>SELECT, UPDATE, INSERT, DELETE</code>等命令）使用SSI，对DDL（<code>CREATE TABLE</code>等命令）使用2PL。</p>
<p>PostgreSQL有好几类锁，其中最主要的是 <strong>表级锁</strong> 与 <strong>行级锁</strong>，此外还有页级锁，咨询锁等，<strong>表级锁</strong> 通常是各种命令执行时自动获取的，或者通过事务中的<code>LOCK</code>语句显式获取；而行级锁则是由<code>SELECT FOR UPDATE|SHARE</code>语句显式获取的。执行数据库命令时，都是先获取表级锁，再获取行级锁。本文主要介绍PostgreSQL中的表锁。</p>
<hr>
<h2 id="表级锁">表级锁</h2>
<ul>
<li><strong>表级锁</strong>通常会在执行各种命令执行时自动获取，或者通过在事务中使用<code>LOCK</code>语句显式获取。</li>
<li>每种锁都有自己的<strong>冲突集合</strong>，在同一时刻的同一张表上，两个事务可以持有不冲突的锁，不能持有冲突的锁。</li>
<li>有些锁是 <strong>自斥(self-conflict)</strong> 的，即最多只能被一个事务所持有。</li>
<li>表级锁总共有八种模式，有着并不严格的强度递增关系（例外是<code>Share</code>锁不自斥）</li>
<li>表级锁存在于PG的共享内存中，可以通过<code>pg_locks</code>系统视图查阅。</li>
</ul>
<h3 id="表级锁的模式">表级锁的模式</h3>
<p><img src="/img/blog/pg/pg-lock-table-lock"></p>
<p>如何记忆这么多类型的锁呢？让我们从演化的视角来看这些锁。</p>
<h3 id="表级锁的演化">表级锁的演化</h3>
<p><img src="/img/blog/pg/pg-lock-envolve.png"></p>
<p>最开始只有两种锁：<code>Share</code>与<code>Exclusive</code>，共享锁与排它锁，即所谓<strong>读锁</strong>与<strong>写锁</strong>。读锁的目的是阻止表数据的变更，而写锁的目的是阻止一切并发访问。这很好理解。</p>
<h4 id="多版本并发控制">多版本并发控制</h4>
<p>后来随着多版本并发控制技术的出现（PostgreSQL使用快照隔离实现MVCC），读不阻塞写，写不阻塞读（针对表的增删改查而言）。因而原有的锁模型就需要升级了：这里的共享锁与排他锁都有了一个升级版本，即前面多加一个<code>ACCESS</code>。<code>ACCESS SHARE</code>是改良版共享锁，即允许<code>ACCESS</code>（多版本并发访问）的<code>SHARE</code>锁，这种锁意味着即使其他进程正在并发修改数据也不会阻塞本进程读取数据。当然有了多版本读锁也就会有对应的多版本写锁来阻止一切访问，即连<code>ACCESS</code>（多版本并发访问）都要<code>EXCLUSIVE</code>的锁，这种锁会阻止一切访问，是最强的写锁。</p>
<p>引入MVCC后，<code>INSERT|UPDATE|DELETE</code>仍然使用原来的<code>Exclusive</code>锁，而普通的只读<code>SELECT</code>则使用多版本的<code>AccessShare</code>锁。因为<code>AccessShare</code>锁与原来的<code>Exclusive</code>锁不冲突，所以读写之间就不会阻塞了。原来的<code>Share</code>锁现在主要的应用场景为创建索引（非并发创建模式下，创建索引会阻止任何对底层数据的变更），而升级的多版本<code>AccessExclusive</code>锁主要用于除了增删改之外的排他性变更（<code>DROP|TRUNCATE|REINDEX|VACUUM FULL</code>等），这个模型如图（a）所示。</p>
<p>当然，这样还是有问题的。虽然在MVCC中读写之间相互不阻塞了，但写-写之间还是会产生冲突。上面的模型中，并发写入是通过表级别的<code>Exclusive</code>锁解决的。表级锁虽然可以解决并发写入冲突问题，但这个粒度太大了，会影响并发度：因为同一时刻一张表上只能有一个进程持有<code>Exclusive</code>锁并执行写入，而典型的OLTP场景是以单行写入为主。所以常见的DBMS解决写-写冲突通常都是采用<strong>行级锁</strong>来实现（下面会讲到）。</p>
<p>行级锁和表级锁不是一回事，但这两种锁之间仍然存在着联系，协调这两种锁之间的关系，就需要引入<strong>意向锁</strong>。</p>
<h4 id="意向锁">意向锁</h4>
<p>意向锁用于协调表锁与行锁之间的关系：它用于保护较低资源级别上的锁，即说明下层节点已经被加了锁。当进程想要锁定或修改某表上的某一行时，它会在这一行上加上行级锁。但在加行级锁之前，它还需要在这张表上加上一把意向锁，表示自己将会在表中的若干行上加锁。</p>
<p>举个例子，假设不存在意向锁。假设进程A获取了表上某行的行锁，持有行上的排他锁意味着进程A可以对这一行执行写入；同时因为不存在意向锁，进程B很顺利地获取了该表上的表级排他锁，这意味着进程B可以对整个表，包括A锁定对那一行进行修改，这就违背了常识逻辑。因此A需要在获取行锁前先获取表上的意向锁，这样后来的B就意识到自己无法获取整个表上的排他锁了（但B依然可以加一个意向锁，获取其他行上的行锁）。</p>
<p>因此，这里<code>RowShare</code>就是行级共享锁对应的表级意向锁（<code>SELECT FOR SHARE|UPDATE</code>命令获取），而<code>RowExclusive</code>（<code>INSERT|UPDATE|DELETE</code>获取）则是行级排他锁对应的表级意向锁。注意因为MVCC的存在，只读查询并不会在行上加锁。引入意向锁后的模型如图（c）所示。而合并MVCC与意向锁模型之后的锁模型如图（d）所示。</p>
<h4 id="自斥锁">自斥锁</h4>
<p>上面这个模型已经相当不错，但仍然存在一些问题，譬如自斥：这里<code>RowExclusive</code>与<code>Share</code>锁都不是自斥的。</p>
<p>举个例子，并发VACUUM不应阻塞数据写入，而且一个表上不应该允许多个VACUUM进程同时工作。因为不能阻塞写入，因此VACUUM所需的锁强度必须要比Share锁弱，弱于Share的最强锁为<code>RowExclusive</code>，不幸的是，该锁并不自斥。如果VACUUM使用该锁，就无法阻止单表上出现多个VACUUM进程。因此需要引入一个自斥版本的<code>RowExclusive</code>锁，即<code>ShareUpdateExclusive</code>锁。</p>
<p>同理，再比如执行触发器管理操作（创建，删除，启用）时，该操作不应阻塞读取和锁定，但必须禁止一切实际的数据写入，否则就难以判断某条元组的变更是否应该触发触发器。Share锁满足不阻塞读取和锁定的条件，但并不自斥，因此可能出现多个进程在同一个表上并发修改触发器。并发修改触发器会带来很多问题（譬如丢失更新，A将其配置为Replica Trigger，B将其配置为Always Trigger，都反回成功了，以谁为准？）。因此这里也需要一个自斥版本的<code>Share</code>锁，即<code>ShareRowExclusive</code>锁。</p>
<p>因此，引入两种自斥版本的锁后，就是PostgreSQL中的最终表级锁模型，如图（e）所示。</p>
<h3 id="表级锁的命名与记忆">表级锁的命名与记忆</h3>
<p>PostgreSQL的表级锁的命名有些诘屈聱牙，这是因为一些历史因素，但也可以总结出一些规律便于记忆。</p>
<ul>
<li>最初只有两种锁：共享锁（<code>Share</code>）与排他锁（<code>Exclusive</code>）。
<ul>
<li>特征是只有一个单词，表示这是两种最基本的锁：读锁与写锁。</li>
</ul>
</li>
<li>多版本并发控制的出现，引入了多版本的共享锁与排他锁（<code>AccessShare</code>与<code>AccessExclusive</code>）。
<ul>
<li>特征是<code>Access</code>前缀，表示这是用于&quot;多版本并发控制&quot;的改良锁。</li>
</ul>
</li>
<li>为了处理并发写入之间的冲突，又引入了两种意向锁（<code>RowShare</code>与<code>RowExclusive</code>）
<ul>
<li>特征是<code>Row</code>前缀，表示这是行级别共享/排他锁对应的表级意向锁。</li>
</ul>
</li>
<li>最后，为了处理意向排他锁与共享锁不自斥的问题，引入了这两种锁的自斥版本（<code>ShareUpdateExclusive</code>, <code>ShareRowExclusive</code>）。这两种锁的名称比较难记：
<ul>
<li>都是以<code>Share</code>打头，以<code>Exclusive</code>结尾。表示这两种锁都是某种共享锁的自斥版本。</li>
<li>两种锁强度围绕在<code>Share</code>前后，<code>Update</code>弱于<code>Share</code>，<code>Row</code>强于<code>Share</code>。</li>
<li><code>ShareRowExclusive</code>可以理解为<code>Share</code> + <code>Row Exclusive</code>，因为<code>Share</code>不排斥其他<code>Share</code>，但<code>RowExclusive</code>排斥<code>Share</code>，因此同时加这两种锁的结果等效于<code>ShareRowExclusive</code>，即SIX。</li>
<li><code>ShareUpdateExclusive</code>可以理解为<code>ShareUpdate</code> + <code>Exclusive</code>：<code>UPDATE</code>操作持有<code>RowExclusive</code>锁，而<code>ShareUpdate</code>指的是本锁与普通的增删改（持<code>RowExclusive</code>锁）相容，而<code>Exclusive</code>则表示自己和自己不相容。</li>
</ul>
</li>
<li><code>Share</code>, <code>ShareRowUpdate</code>, <code>Exclusive</code> 这三种锁极少出现，基本可以无视。所以实际上主要用到的锁是：
<ul>
<li>多版本两种：<code>AccessShare</code>, <code>AccessExclusive</code></li>
<li>意向锁两种：<code>RowShare</code>,<code>RowExclusive</code></li>
<li>自斥意向锁一种：<code>ShareUpdateExclusive</code></li>
</ul>
</li>
</ul>
<hr>
<h2 id="显式加锁">显式加锁</h2>
<p>通常表级锁会在相应命令执行中自动获取，但也可以手动显式获取。使用LOCK命令加锁的方式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">LOCK</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ONLY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lockmode</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">MODE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NOWAIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>显式锁表必须在事务中进行，在事务外锁表会报错。</li>
<li>锁定视图时，视图定义中所有出现的表都会被锁定。</li>
<li>使用表继承时，默认父表和所有后代表都会加锁，指定<code>ONLY</code>选项则继承于该表的子表不会自动加锁。</li>
<li>锁表或者锁视图需要对应的权限，例如<code>AccessShare</code>锁需要<code>SELECT</code>权限。</li>
<li>默认获取的锁模式为<code>AccessExclusive</code>，即最强的锁。</li>
<li><code>LOCK TABLE</code>只能获取表锁，默认会等待冲突的锁被释放，指定<code>NOWAIT</code>选项时，如果命令不能立刻获得锁就会中止并报错。</li>
<li>命令一旦获取到锁， 会被在当前事务中一直持有。没有<code>UNLOCK TABLE</code>命令，锁总是在事务结束时释放。</li>
</ul>
<h3 id="例子数据迁移">例子：数据迁移</h3>
<p>举个例子，以迁移数据为例，假设希望将某张表的数据迁移到另一个实例中。并保证在此期间旧表上的数据在迁移期间不发生变化，那么我们可以做的就是在复制数据前在表上显式加锁，并在复制结束，应用开始写入新表后释放。应用仍然可以从旧表上读取数据，但不允许写入。那么根据锁冲突矩阵，允许只读查询的锁要弱于<code>AccessExclusive</code>，阻止写入的锁不能弱于<code>ShareRowExclusive</code>，因此可以选择<code>ShareRowExclusive</code>或<code>Exclusive锁</code>。因为拒绝写入意味着锁定没有任何意义，所以这里选择更强的<code>Exclusive</code>锁。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LOCK</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXCLUSIVE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">MODE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- DO Something
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="锁的查询">锁的查询</h2>
<p>PostgreSQL提供了一个系统视图<a href="http://www.postgres.cn/docs/11/view-pg-locks.html"><code>pg_locks</code></a>，包含了当前活动进程持锁的信息。可以锁定的对象包括：关系，页面，元组，事务标识（虚拟的或真实的），其他数据库对象（带有OID）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_locks</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">-- 锁针对的客体对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">locktype</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 锁类型：关系，页面，元组，事务ID，对象等
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- 数据库OID
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">relation</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- 关系OID
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">page</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 关系内页号
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">tuple</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87">smallint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 页内元组号
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">virtualxid</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic">-- 虚拟事务ID
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">transactionid</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">xid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">-- 事务ID
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">classid</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">-- 锁对象所属系统目录表本身的OID
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">objid</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">-- 系统目录内的对象的OID
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">objsubid</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#204a87">smallint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 列号
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">-- 持有|等待锁的主体
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">virtualtransaction</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic">-- 持锁|等待锁的虚拟事务ID
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">pid</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- 持锁|等待锁的进程PID
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">mode</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic">-- 锁模式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">granted</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87">boolean</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- t已获取，f等待中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">fastpath</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#204a87">boolean</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- t通过fastpath获取
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><table>
<thead>
<tr>
<th>名称</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>locktype</code></td>
<td><code>text</code></td>
<td>可锁对象的类型： <code>relation</code>， <code>extend</code>， <code>page</code>， <code>tuple</code>， <code>transactionid</code>， <code>virtualxid</code>， <code>object</code>， <code>userlock</code>或<code>advisory</code></td>
</tr>
<tr>
<td><code>database</code></td>
<td><code>oid</code></td>
<td>若锁目标为数据库（或下层对象），则为数据库OID，并引用<code>pg_database.oid</code>，共享对象为0，否则为空</td>
</tr>
<tr>
<td><code>relation</code></td>
<td><code>oid</code></td>
<td>若锁目标为关系（或下层对象），则为关系OID，并引用<code>pg_class.oid</code>，否则为空</td>
</tr>
<tr>
<td><code>page</code></td>
<td><code>integer</code></td>
<td>若锁目标为页面（或下层对象），则为页面号，否则为空</td>
</tr>
<tr>
<td><code>tuple</code></td>
<td><code>smallint</code></td>
<td>若锁目标为元组，则为页内元组号，否则为空</td>
</tr>
<tr>
<td><code>virtualxid</code></td>
<td><code>text</code></td>
<td>若锁目标为虚拟事务，则为虚拟事务ID，否则为空</td>
</tr>
<tr>
<td><code>transactionid</code></td>
<td><code>xid</code></td>
<td>若锁目标为事务，则为事务ID，否则为空</td>
</tr>
<tr>
<td><code>classid</code></td>
<td><code>oid</code></td>
<td>若目标为数据库对象，则为该对象相应<strong>系统目录</strong>的OID，并引用<code>pg_class.oid</code>，否则为空。</td>
</tr>
<tr>
<td><code>objid</code></td>
<td><code>oid</code></td>
<td>锁目标在其系统目录中的OID，如目标不是普通数据库对象则为空</td>
</tr>
<tr>
<td><code>objsubid</code></td>
<td><code>smallint</code></td>
<td>锁的目标列号（<code>classid</code>和<code>objid</code>指向表本身），若目标是某种其他普通数据库对象则此列为0，如果目标不是一个普通数据库对象则此列为空。</td>
</tr>
<tr>
<td><code>virtualtransaction</code></td>
<td><code>text</code></td>
<td>持有或等待这个锁的虚拟ID</td>
</tr>
<tr>
<td><code>pid</code></td>
<td><code>integer</code></td>
<td>持有或等待这个锁的服务器进程ID，如果此锁被一个预备事务所持有则为空</td>
</tr>
<tr>
<td><code>mode</code></td>
<td><code>text</code></td>
<td>持有或者等待锁的模式</td>
</tr>
<tr>
<td><code>granted</code></td>
<td><code>boolean</code></td>
<td>为真表示已经获得的锁，为假表示还在等待的锁</td>
</tr>
<tr>
<td><code>fastpath</code></td>
<td><code>boolean</code></td>
<td>为真表示锁是通过fastpath获取的</td>
</tr>
</tbody>
</table>
<h4 id="样例数据">样例数据</h4>
<p><img src="/img/blog/pg/pg-lock-sample.png"></p>
<p>这个视图需要一些额外的知识才能解读。</p>
<ul>
<li>该视图是<strong>数据库集簇</strong>范围的视图，而非仅限于单个数据库，即可以看见其他数据库中的锁。</li>
<li>一个进程在一个时间点只能等待至多一个锁，等待锁用<code>granted=f</code>表示，等待进程会休眠至其他锁被释放，或者系统检测到死锁。</li>
<li>每个事务都有一个虚拟事务标识<code>virtualtransaction</code>（以下简称<code>vxid</code>），修改数据库状态（或者显式调用<code>txid_current</code>获取）的事务才会被分配一个真实的事务标识<code>transactionid</code>（简称<code>txid</code>），<strong><code>vxid|txid</code>本身也是可以锁定的对象</strong>。</li>
<li>每个事务都会持有自己<code>vxid</code>上的<code>Exclusive</code>锁，如果有<code>txid</code>，也会<strong>同时</strong>持有其上的<code>Exclusive</code>锁（即同时持有<code>txid</code>和<code>vxid</code>上的排它锁）。因此当一个事务需要等待另一个事务时，它会尝试获取另一个事务<code>txid|vxid</code>上的共享锁，因而只有当目标事务结束（自动释放自己事务标识上的<code>Exclusive</code>锁）时，等待事务才会被唤醒。</li>
<li><code>pg_locks</code>视图通常并不会直接显示<strong>行级锁</strong>信息，因为这些信息存储在磁盘磁盘上（），如果真的有进程在等待行锁，显示的形式通常是一个事务等待另一个事务，而不是等待某个具体的行锁。</li>
<li>咨询锁本质上的锁对象客体是一个数据库范畴内的BIGINT，<code>classid</code>里包含了该整数的高32bit，<code>objid</code>里包含有低32bit，<code>objsubid</code>里则说明了咨询锁的类型，单一Bigint则取值为<code>1</code>，两个int32则取值为<code>2</code>。</li>
<li>本视图并不一定能保证提供一个一致的快照，因为所有<code>fastpath=true</code>的锁信息是从每个后端进程收集而来的，而<code>fastpath=false</code>的锁是从常规锁管理器中获取的，同时谓词锁管理器中的数据也是单独获取的，因此这几种来源的数据之间可能并不一致。</li>
<li>频繁访问本视图会对数据库系统性能产生影响，因为要对锁管理器加锁获取一致性快照。</li>
</ul>
<blockquote>
<p><strong>虚拟事务</strong></p>
<p>一个后端进程在整个生命周期中的每一个事务都会有一个自己的<strong>虚拟事务ID</strong>。</p>
<p>PG中事务号是有限的（32-bit整型），会循环使用。为了节约事务号，PG只会为<strong>实际修改数据库状态的事务</strong>分配真实事务ID，而只读事务就不分配了，用虚拟事务ID凑合一下。<code>txid</code>是事务标识，全局共享，而<code>vxid</code>是虚拟事务标识，在<strong>短期</strong>内可以保证全局唯一性。因为<code>vxid</code>由两部分组成：<code>BackendID</code>与<code>LocalTransactionId</code>，前者是后端进程的标识符（本进程在内存中进程数组中的序号），后者是一个递增的事务计数器。因此两者组合即可获得一个暂时唯一的虚拟事务标识（之所以是暂时是因为这里的后端ID是有可能重复的）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BackendId</span>	<span style="color:#000">backendId</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 后端ID，初始化时确定，其实是后端进程数组内索引号 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">LocalTransactionId</span> <span style="color:#000">localTransactionId</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 后端内本地使用的命令标ID，类似自增计数器 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">VirtualTransactionId</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div></blockquote>
<hr>
<h2 id="应用">应用</h2>
<h3 id="常见操作的冲突关系">常见操作的冲突关系</h3>
<ul>
<li><code>SELECT</code>与<code>UPDATE|DELETE|INSERT</code>不会相互阻塞，即使访问的是同一行。</li>
<li><code>I|U|D</code>写入操作与<code>I|U|D</code>写入操作在表层面不会互斥，会在具体的行上通过<code>RowExclusive</code>锁实现。</li>
<li><code>SELECT FOR UPDATE</code>锁定操作与<code>I|U|D</code>写入在表层级也不会互斥，仍然是通过具体元组上的行锁实现。</li>
<li>并发<code>VACUUM</code>，并发创建索引等操作不会阻塞读写，但它们是自斥的，即同一时刻只会有一个（所以同时在一个表上执行两个<code>CREATE INDEX CONCURRENTLY</code>是没有意义的，不要被名字骗了）</li>
<li>普通的索引创建<code>CREATE INDEX</code>，不带<code>CONCURRENTLY</code>会阻塞增删改，但不会阻塞查，很少用到。</li>
<li>任何对于触发器的操作，或者约束类的操作，都会阻止增删改，但不会阻塞只读查询以及锁定。</li>
<li>冷门的命令<code>REFRESH MATERIALIZED VIEW CONCURRENTLY</code>允许<code>SELECT</code>和锁定。</li>
<li>大多数很硬的变更：<code>VACUUM FULL</code>, <code>DROP TABLE</code>, <code>TRUNCATE</code>, <code>ALTER TABLE</code>的大多数形式都会阻塞一切读取。</li>
</ul>
<p>注意，锁虽有强弱之分，但冲突关系是对等的。一个持有<code>AccessShare</code>锁的<code>SELECT</code>会阻止后续的<code>DROP TABLE</code>获得<code>AccessExclusive</code>锁。后面的命令会进入锁队列中。</p>
<h3 id="锁队列">锁队列</h3>
<p>PG中每个锁上都会有一个锁队列。如果事务A占有一个排他锁，那么事务B在尝试获取其上的锁时就会在其锁队列中等待。如果这时候事务C同样要获取该锁，那么它不仅要和事务A进行冲突检测，也要和B进行冲突检测，以及队列中其他的事务。这意味着当用户尝试获取一个很强的锁而未得等待时，已经会阻止后续新锁的获取。一个具体的例子是加列：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ADD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mtime</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TIMESTAMP</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>即使这是一个不带默认值的加列操作（不会重写整个表，因而很快），但本命令需要表上的<code>AccessExclusive</code>锁，如果这张表上面已经有不少查询，那么这个命令可能会等待相当一段时间。因为它需要等待其他查询结束并释放掉锁后才能执行。相应地，因为这条命令已经在等待队列中，后续的查询都会被它所阻塞。因此，当执行此类命令时的一个最佳实践是在此类命令前修改<code>lock_timeout</code>，从而避免雪崩。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lock_timeout</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;1s&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ADD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mtime</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TIMESTAMP</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这个设计的好处是，命令不会饿死：不会出现源源不断的短小只读查询无限阻塞住一个排他操作。</p>
<h3 id="加锁原则">加锁原则</h3>
<ul>
<li>够用即可：使用满足条件的锁中最弱的锁模式</li>
<li>越快越好：如果可能，可以用（长时间的弱锁+短时间的强锁）替换长时间的强锁</li>
<li>递增获取：遵循2PL原则申请锁；越晚使用激进锁策略越好；在真正需要时再获取。</li>
<li>相同顺序：获取锁尽量以一致的顺序获取，从而减小死锁的几率</li>
</ul>
<h3 id="最小化锁阻塞时长">最小化锁阻塞时长</h3>
<p>除了手工锁定之外，很多常见的操作都会&quot;锁表&quot;，最常见的莫过于添加新字段与添加新约束。这两种操作都会获取表上的<code>AccessExclusive</code>锁以阻止一切并发访问。当DBA需要在线维护数据库时应当最小化持锁的时间。</p>
<p>例如，为表添加新字段的<code>ALTER TABLE ADD COLUMN</code>子句，根据新列是否提供易变默认值，会重写整个表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ADD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mtime</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TIMESTAMP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CURRENT_TIMESTAMP</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>如果只是个小表，业务负载也不大，那么也许可以直接这么干。但如果是很大的表，以及很高的负载，那么阻塞的时间就会很可观。在这段时间里，命令都会持有表上的<code>AccessExclusive</code>锁阻塞一切访问。</p>
<p>可以通过先加一个空列，再慢慢更新的方式来最小化锁等待时间：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ADD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mtime</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TIMESTAMP</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mtime</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CURRENT_TIMESTAMP</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 可以分批进行
</span></span></span></code></pre></div><p>这样，第一条加列操作的锁阻塞时间就会非常短，而后面的更新（重写）操作就可以以不阻塞读写的形式慢慢进行，最小化锁阻塞。</p>
<p>同理，当想要为表添加新的约束时（例如新的主键），也可以采用这种方式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UNIQUE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CONCURRENTLY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_pk</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 很慢，但不阻塞读写
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ADD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CONSTRAINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_pk</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_pk</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- 阻塞读写，但很快
</span></span></span></code></pre></div><p>替代单纯的</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ADD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-fe20fb7726e2595e3268f850de55df30">GIN搜索的O(n2)负载度</h1>
	<div class="lead">GIN索引如果使用很长的关键词列表进行搜索，会导致性能显著下降。本文解释了为什么GIN索引关键词搜索的时间复杂度为O(n^2)</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2019-04-12" class="text-muted">2019年04月12日</time>
        
	</div>
	<p>GIN索引如果使用很长的关键词列表进行搜索，会导致性能显著下降。本文解释了为什么GIN索引关键词搜索的时间复杂度为O(n^2)</p>
<p>Here is the detail of why that query have O(N^2) inside GIN implementation.</p>
<hr>
<h2 id="details">Details</h2>
<p>Inspect the index <code>example_keys_idx</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">postgres</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># select oid,* from pg_class where relname = &#39;example_keys_idx&#39;;</span>
</span></span><span style="display:flex;"><span>-<span style="color:#ce5c00;font-weight:bold">[</span> RECORD <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">]</span>-------+-----------------
</span></span><span style="display:flex;"><span>oid                 <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">20699</span>
</span></span><span style="display:flex;"><span>relname             <span style="color:#000;font-weight:bold">|</span> example_keys_idx
</span></span><span style="display:flex;"><span>relnamespace        <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">20692</span>
</span></span><span style="display:flex;"><span>reltype             <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>reloftype           <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>relowner            <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>relam               <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">2742</span>
</span></span><span style="display:flex;"><span>relfilenode         <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">20699</span>
</span></span><span style="display:flex;"><span>reltablespace       <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>relpages            <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">2051</span>
</span></span><span style="display:flex;"><span>reltuples           <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">300000</span>
</span></span><span style="display:flex;"><span>relallvisible       <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>reltoastrelid       <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>relhasindex         <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>relisshared         <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>relpersistence      <span style="color:#000;font-weight:bold">|</span> p
</span></span><span style="display:flex;"><span>relkind             <span style="color:#000;font-weight:bold">|</span> i
</span></span><span style="display:flex;"><span>relnatts            <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>relchecks           <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>relhasoids          <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>relhasrules         <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>relhastriggers      <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>relhassubclass      <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>relrowsecurity      <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>relforcerowsecurity <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>relispopulated      <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span>relreplident        <span style="color:#000;font-weight:bold">|</span> n
</span></span><span style="display:flex;"><span>relispartition      <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>relrewrite          <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>relfrozenxid        <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>relminmxid          <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>relacl              <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>reloptions          <span style="color:#000;font-weight:bold">|</span> <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fastupdate</span><span style="color:#ce5c00;font-weight:bold">=</span>off<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>relpartbound        <span style="color:#000;font-weight:bold">|</span>
</span></span></code></pre></div><p>Find index information via index&rsquo;s oid</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">postgres</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># select * from pg_index where indexrelid = 20699;</span>
</span></span><span style="display:flex;"><span>-<span style="color:#ce5c00;font-weight:bold">[</span> RECORD <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">]</span>--+------
</span></span><span style="display:flex;"><span>indexrelid     <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">20699</span>
</span></span><span style="display:flex;"><span>indrelid       <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">20693</span>
</span></span><span style="display:flex;"><span>indnatts       <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>indnkeyatts    <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>indisunique    <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>indisprimary   <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>indisexclusion <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>indimmediate   <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span>indisclustered <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>indisvalid     <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span>indcheckxmin   <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>indisready     <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span>indislive      <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span>indisreplident <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>indkey         <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>indcollation   <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>indclass       <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">10075</span>
</span></span><span style="display:flex;"><span>indoption      <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>indexprs       <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>indpred        <span style="color:#000;font-weight:bold">|</span>
</span></span></code></pre></div><p>Find corresponding operator class for that index via <code>indclass</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">postgres</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># select * from pg_opclass where oid = 10075;</span>
</span></span><span style="display:flex;"><span>-<span style="color:#ce5c00;font-weight:bold">[</span> RECORD <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">]</span>+----------
</span></span><span style="display:flex;"><span>opcmethod    <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">2742</span>
</span></span><span style="display:flex;"><span>opcname      <span style="color:#000;font-weight:bold">|</span> array_ops
</span></span><span style="display:flex;"><span>opcnamespace <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">11</span>
</span></span><span style="display:flex;"><span>opcowner     <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>opcfamily    <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">2745</span>
</span></span><span style="display:flex;"><span>opcintype    <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">2277</span>
</span></span><span style="display:flex;"><span>opcdefault   <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span>opckeytype   <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">2283</span>
</span></span></code></pre></div><p>Find four operator corresponding to operator faimily <code>array_ops</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>postgres=# select * from pg_amop where amopfamily =2745;
</span></span><span style="display:flex;"><span>-[ RECORD 1 ]--+-----
</span></span><span style="display:flex;"><span>amopfamily     | 2745
</span></span><span style="display:flex;"><span>amoplefttype   | 2277
</span></span><span style="display:flex;"><span>amoprighttype  | 2277
</span></span><span style="display:flex;"><span>amopstrategy   | 1
</span></span><span style="display:flex;"><span>amoppurpose    | s
</span></span><span style="display:flex;"><span>amopopr        | 2750
</span></span><span style="display:flex;"><span>amopmethod     | 2742
</span></span><span style="display:flex;"><span>amopsortfamily | 0
</span></span><span style="display:flex;"><span>-[ RECORD 2 ]--+-----
</span></span><span style="display:flex;"><span>amopfamily     | 2745
</span></span><span style="display:flex;"><span>amoplefttype   | 2277
</span></span><span style="display:flex;"><span>amoprighttype  | 2277
</span></span><span style="display:flex;"><span>amopstrategy   | 2
</span></span><span style="display:flex;"><span>amoppurpose    | s
</span></span><span style="display:flex;"><span>amopopr        | 2751
</span></span><span style="display:flex;"><span>amopmethod     | 2742
</span></span><span style="display:flex;"><span>amopsortfamily | 0
</span></span><span style="display:flex;"><span>-[ RECORD 3 ]--+-----
</span></span><span style="display:flex;"><span>amopfamily     | 2745
</span></span><span style="display:flex;"><span>amoplefttype   | 2277
</span></span><span style="display:flex;"><span>amoprighttype  | 2277
</span></span><span style="display:flex;"><span>amopstrategy   | 3
</span></span><span style="display:flex;"><span>amoppurpose    | s
</span></span><span style="display:flex;"><span>amopopr        | 2752
</span></span><span style="display:flex;"><span>amopmethod     | 2742
</span></span><span style="display:flex;"><span>amopsortfamily | 0
</span></span><span style="display:flex;"><span>-[ RECORD 4 ]--+-----
</span></span><span style="display:flex;"><span>amopfamily     | 2745
</span></span><span style="display:flex;"><span>amoplefttype   | 2277
</span></span><span style="display:flex;"><span>amoprighttype  | 2277
</span></span><span style="display:flex;"><span>amopstrategy   | 4
</span></span><span style="display:flex;"><span>amoppurpose    | s
</span></span><span style="display:flex;"><span>amopopr        | 1070
</span></span><span style="display:flex;"><span>amopmethod     | 2742
</span></span><span style="display:flex;"><span>amopsortfamily | 0
</span></span></code></pre></div><p><a href="https://www.postgresql.org/docs/10/xindex.html">https://www.postgresql.org/docs/10/xindex.html</a></p>
<p><strong>Table 37.6. GIN Array Strategies</strong></p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Strategy Number</th>
</tr>
</thead>
<tbody>
<tr>
<td>overlap</td>
<td>1</td>
</tr>
<tr>
<td>contains</td>
<td>2</td>
</tr>
<tr>
<td>is contained by</td>
<td>3</td>
</tr>
<tr>
<td>equal</td>
<td>4</td>
</tr>
</tbody>
</table>
<p>When we access that index with <code>&amp;&amp;</code> operator, we are using stragety 1 <code>overlap</code>, which corresponding operator oid is <code>2750</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">postgres</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># select * from pg_operator where oid = 2750;</span>
</span></span><span style="display:flex;"><span>-<span style="color:#ce5c00;font-weight:bold">[</span> RECORD <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">]</span>+-----------------
</span></span><span style="display:flex;"><span>oprname      <span style="color:#000;font-weight:bold">|</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>oprnamespace <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">11</span>
</span></span><span style="display:flex;"><span>oprowner     <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>oprkind      <span style="color:#000;font-weight:bold">|</span> b
</span></span><span style="display:flex;"><span>oprcanmerge  <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>oprcanhash   <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>oprleft      <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">2277</span>
</span></span><span style="display:flex;"><span>oprright     <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">2277</span>
</span></span><span style="display:flex;"><span>oprresult    <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>oprcom       <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">2750</span>
</span></span><span style="display:flex;"><span>oprnegate    <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>oprcode      <span style="color:#000;font-weight:bold">|</span> arrayoverlap
</span></span><span style="display:flex;"><span>oprrest      <span style="color:#000;font-weight:bold">|</span> arraycontsel
</span></span><span style="display:flex;"><span>oprjoin      <span style="color:#000;font-weight:bold">|</span> arraycontjoinsel
</span></span></code></pre></div><p>The underlying C function to judge arrayoverlap is <code>arrayoverlap</code> in <a href="https://github.com/postgres/postgres/blob/master/src/backend/utils/adt/arrayfuncs.c">here</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">Datum</span>
</span></span><span style="display:flex;"><span><span style="color:#000">arrayoverlap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PG_FUNCTION_ARGS</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AnyArrayType</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">array1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PG_GETARG_ANY_ARRAY_P</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AnyArrayType</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">array2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PG_GETARG_ANY_ARRAY_P</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Oid</span>			<span style="color:#000">collation</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PG_GET_COLLATION</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">result</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">array_contain_compare</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">array1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">array2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">collation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>								   <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">fcinfo</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">flinfo</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">fn_extra</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* Avoid leaking memory when handed toasted input. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AARR_FREE_IF_COPY</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">array1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AARR_FREE_IF_COPY</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">array2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PG_RETURN_BOOL</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>It actually use <code>array_contain_compare</code> to test whether two array are overlap</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000">array_contain_compare</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AnyArrayType</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">array1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AnyArrayType</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">array2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Oid</span> <span style="color:#000">collation</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>					  <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">matchall</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">fn_extra</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>Line 4177, we see a nested loop to iterate two array, which makes it O(N^2)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">nelems1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Datum</span>		<span style="color:#000">elt1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">isnull1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">/* Get element, checking for NULL */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">elt1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">array_iter_next</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">it1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">isnull1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">typlen</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">typbyval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">typalign</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">		 * We assume that the comparison operator is strict, so a NULL can&#39;t
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">		 * match anything.  XXX this diverges from the &#34;NULL=NULL&#34; behavior of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">		 * array_eq, should we act like that?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">		 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">isnull1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">matchall</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">nelems2</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-ebb4721027589fb8a3f47ae4caff080f">GeoIP 地理逆查询优化</h1>
	<div class="lead">在应用开发中，一个‘很常见’的需求就是GeoIP转换。将请求的来源IP转换为相应的地理坐标，或者行政区划（国家-省-市-县-乡-镇）</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-07-07" class="text-muted">2018年07月07日</time>
        
	</div>
	<blockquote>
<p>IP归属地查询的高效实现</p>
</blockquote>
<p>在应用开发中，一个‘很常见’的需求就是GeoIP转换。将请求的来源IP转换为相应的地理坐标，或者行政区划（国家-省-市-县-乡-镇）。这种功能有很多用途，譬如分析网站流量的地理来源，或者干一些坏事。使用PostgreSQL可以多快好省，优雅高效地实现这一需求。</p>
<hr>
<h2 id="0x01-思路方法">0x01 思路方法</h2>
<p>通常网上的IP地理数据库的形式都是：<code>start_ip, stop_ip , longitude, latitude</code>，再缀上一些国家代码，城市代码，邮编之类的属性字段。大概长这样：</p>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>start_ip</td>
<td>text</td>
</tr>
<tr>
<td>end_ip</td>
<td>text</td>
</tr>
<tr>
<td>longitude</td>
<td>text</td>
</tr>
<tr>
<td>latitude</td>
<td>text</td>
</tr>
<tr>
<td>country_code</td>
<td>text</td>
</tr>
<tr>
<td>……</td>
<td>text</td>
</tr>
</tbody>
</table>
<p>说到底，其核心是从<strong>IP地址段</strong>到<strong>地理坐标点</strong>的映射。</p>
<p>典型查询实际上是给出一个IP地址，返回该地址对应的地理范围。其逻辑用SQL来表示差不多长这样：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">longitude</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">latitude</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">geoip</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">start_ip</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">target_ip</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">target_ip</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">stop_ip</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>不过，想直接提供服务，还有几个问题需要解决：</p>
<ul>
<li>第一个问题：虽然IPv4实际上是一个<code>uint32</code>，但我们已经完全习惯了<code>123.123.123.123</code>这种文本表示形式。而这种文本表示形式是无法比较大小的。</li>
<li>第二个问题：这里的IP范围是用两个IP边界字段表示的范围，那么这个范围是开区间还是闭区间呢？是不是还需要一个额外字段来表示？</li>
<li>第三个问题：想要高效地查询，那么在两个字段上的索引又该如何建立？</li>
<li>第四个问题：我们希望所有的IP段相互之间不会出现重叠，但简单的建立在<code>(start_ip, stop_ip)</code>上的唯一约束并无法保证这一点，那又如何是好？</li>
</ul>
<p>令人高兴的是，对于PostgreSQL而言，这些都不是问题。上面四个问题，可以轻松使用PostgreSQL的特性解决。</p>
<ul>
<li>网络数据类型：高性能，紧凑，灵活的网络地址表示。</li>
<li>范围类型：对区间的良好抽象，对区间查询与操作的良好支持。</li>
<li>GiST索引：既能作用于IP地址段，也可以用于地理位置点。</li>
<li>Exclude约束：泛化的高级UNIQUE约束，从根本上确保数据完整性。</li>
</ul>
<hr>
<h2 id="0x01-网络地址类型">0x01 网络地址类型</h2>
<p>PostgreSQL提供用于存储 IPv4、IPv6 和 MAC 地址的数据类型。包括<code>cidr</code>，<code>inet</code>以及<code>macaddr</code>，并且提供了很多常见的操作函数，不需要再在程序中去实现一些繁琐重复的功能。</p>
<p>最常见的网络地址就是IPv4地址，对应着PostgreSQL内建的<code>inet</code>类型，inet类型可以用来存储IPv4，IPv6地址，或者带上一个可选的子网。当然这些细节操作都可以<a href="http://www.postgres.cn/docs/9.6/datatype-net-types.html">参阅文档</a>，在此不详细展开。</p>
<p>一个需要注意的点就是，虽然我们知道IPv4实质上是一个<code>Unsigned Integer</code>，但在数据库中实际存储成<code>INTEGER</code>其实是不行的，因为SQL标准并不支持<code>Unsigned</code>这种用法，所以有一半的IP地址的表示就会被解释为负数，在比大小的时候产生令人惊异的结果，真要这么存请使用<code>BIGINT</code>。此外，直接面对一堆长长的整数也是相当令人头大的问题，<code>inet</code>是最佳的选择。</p>
<p>如果需要将IP地址（<code>inet</code>类型）与对应的整数相互转换，只要与<code>0.0.0.0</code>做加减运算即可；当然也可以使用以下函数，并创建一个类型转换，然后就能直接在<code>inet</code>与<code>bigint</code>之间来回转换：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- inet to bigint
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inet2int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inet</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">bigint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inet</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;0.0.0.0&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SQL</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">IMMUTABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INPUT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- bigint to inet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">int2inet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inet</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inet</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;0.0.0.0&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SQL</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">IMMUTABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INPUT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- create type conversion
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CAST</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inet</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inet2int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inet</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CAST</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">bigint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inet</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">int2inet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- test
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">123456</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">INET</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;1.2.3.4&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">INET</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 生成随机的IP地址
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">random</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4294967295</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">INET</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><code>inet</code>之间的大小比较也相当直接，直接使用大小比较运算符就可以了。实际比较的是底下的整数值。这就解决了第一个问题。</p>
<hr>
<h2 id="0x02-范围类型">0x02 范围类型</h2>
<p>PostgreSQL的Range类型是一种很实用的功能，它与数组类似，属于一种<strong>泛型</strong>。只要是能被B树索引（可以比大小）的数据类型，都可以作为范围类型的基础类型。它特别适合用来表示区间：整数区间，时间区间，IP地址段等等。而且对于开区间，闭区间，区间索引这类问题有比较细致的考虑。</p>
<p>PostgreSQL内置了预定义的<code>int4range, int8range, numrange, tsrange, tstzrange, daterange</code>，开箱即用。但没有提供网络地址对应的范围类型，好在自己造一个非常简单：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TYPE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inetrange</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RANGE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SUBTYPE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inet</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>当然为了高效地支持GiST索引查询，还需要实现一个距离度量，告诉索引两个<code>inet</code>之间的距离应该如何计算：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 定义基本类型间的距离度量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inet_diff</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">INET</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">y</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">INET</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SQL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IMMUTABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">STRICT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 重新创建inetrange类型，使用新定义的距离度量。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TYPE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inetrange</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RANGE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">SUBTYPE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inet</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">SUBTYPE_DIFF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inet_diff</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>幸运的是，俩网络地址之间的距离定义天然就有一个很简单的计算方法，减一下就好了。</p>
<p>这个新定义的类型使用起来也很简单，构造函数会自动生成：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">geo</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># select misc.inetrange(&#39;64.60.116.156&#39;,&#39;64.60.116.161&#39;,&#39;[)&#39;);</span>
</span></span><span style="display:flex;"><span>inetrange <span style="color:#000;font-weight:bold">|</span> <span style="color:#ce5c00;font-weight:bold">[</span>64.60.116.156,64.60.116.161<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">geo</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># select &#39;[64.60.116.156,64.60.116.161]&#39;::inetrange;</span>
</span></span><span style="display:flex;"><span>inetrange <span style="color:#000;font-weight:bold">|</span> <span style="color:#ce5c00;font-weight:bold">[</span>64.60.116.156,64.60.116.161<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>方括号和圆括号分别表示闭区间和开区间，与数学中的表示方法一致。</p>
<p>同时，检测一个IP地址是否落在给定的IP范围内也是很直接的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">geo</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># select &#39;[64.60.116.156,64.60.116.161]&#39;::inetrange @&gt; &#39;64.60.116.160&#39;::inet as res;</span>
</span></span><span style="display:flex;"><span>res <span style="color:#000;font-weight:bold">|</span> t
</span></span></code></pre></div><p>有了范围类型，就可以着手构建我们的数据表了。</p>
<hr>
<h2 id="0x03-范围索引">0x03 范围索引</h2>
<p>实际上，找一份IP地理对应数据花了我一个多小时，但完成这个需求只用了几分钟。</p>
<p>假设已经有了这样一份数据：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">geoips</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">ips</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">inetrange</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">geo</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">geometry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Point</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">country_code</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">region_code</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">city_name</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">ad_code</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">postal_code</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">text</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>里面的数据大概长这样：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SELECT ips,ST_AsText<span style="color:#ce5c00;font-weight:bold">(</span>geo<span style="color:#ce5c00;font-weight:bold">)</span> as geo,country_code FROM geoips
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">[</span>64.60.116.156,64.60.116.161<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">|</span> POINT<span style="color:#ce5c00;font-weight:bold">(</span>-117.853 33.7878<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">|</span> US
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">[</span>64.60.116.139,64.60.116.154<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">|</span> POINT<span style="color:#ce5c00;font-weight:bold">(</span>-117.853 33.7878<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">|</span> US
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">[</span>64.60.116.138,64.60.116.138<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">|</span> POINT<span style="color:#ce5c00;font-weight:bold">(</span>-117.76 33.7081<span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#000;font-weight:bold">|</span> US
</span></span></code></pre></div><p>那么查询包含某个IP地址的记录就可以写作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ip</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ips</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">@&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inet</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;67.185.41.77&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>对于600万条记录，约600M的表，在笔者的机器上暴力扫表的平均用时是900ms，差不多单核QPS是1.1，48核生产机器也就差不多三四十的样子。肯定是没法用的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">geoips</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">GiST</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ips</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>查询用时从1秒变为340微秒，差不多3000倍的提升。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>-- pgbench
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">\s</span>et ip random<span style="color:#ce5c00;font-weight:bold">(</span>0,4294967295<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>SELECT * FROM geoips WHERE ips @&gt; :ip::BIGINT::INET<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-- result
</span></span><span style="display:flex;"><span>latency <span style="color:#000">average</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0.342 ms
</span></span><span style="display:flex;"><span><span style="color:#000">tps</span> <span style="color:#ce5c00;font-weight:bold">=</span> 2925.100036 <span style="color:#ce5c00;font-weight:bold">(</span>including connections establishing<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">tps</span> <span style="color:#ce5c00;font-weight:bold">=</span> 2926.151762 <span style="color:#ce5c00;font-weight:bold">(</span>excluding connections establishing<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>折算成生产QPS差不多是十万QPS，啧啧啧，美滋滋。</p>
<p>如果需要把地理坐标转换为行政区划，可以参考上一篇文章：使用PostGIS高效解决行政区划归属地理编码问题。</p>
<p>一次地理编码也就是100微秒，从IP转换为省市区县整个的QPS，单机几万基本问题不大（全天满载相当于七八十亿次调用，根本用不满）。</p>
<hr>
<h2 id="0x04-exclude约束">0x04 EXCLUDE约束</h2>
<p>问题至此已经基本解决了，不过还有一个问题。如何避免一个IP查出两条记录的尴尬情况？</p>
<p>数据完整性是极其重要的，但由应用保证的数据完整性并不总是那么靠谱：人会犯傻，程序会出错。如果能通过数据库约束来Enforce数据完整性，那是再好不过了。</p>
<p>然而，有一些约束是相当复杂的，例如确保表中的IP范围不发生重叠，类似的，确保地理区划表中各个城市的边界不会重叠。传统上要实现这种保证是相当困难的：譬如<code>UNIQUE</code>约束就无法表达这种语义，<code>CHECK</code>与存储过程或者触发器虽然可以实现这种检查，但也相当tricky。PostgreSQL提供的<code>EXCLUDE</code>约束可以优雅地解决这个问题。修改我们的<code>geoips</code>表：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">geoips</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">ips</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">inetrange</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">geo</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">geometry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Point</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">country_code</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">region_code</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">city_name</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">ad_code</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">postal_code</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">EXCLUDE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gist</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ips</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFERRABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INITIALLY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFERRED</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这里<code>EXCLUDE USING gist (ips WITH &amp;&amp;)  </code> 的意思就是<code>ips</code>字段上不允许出现范围重叠，即新插入的字段不能与任何现存范围重叠（<code>&amp;&amp;</code>为真）。而<code>DEFERRABLE INITIALLY IMMEDIATE </code>表示在语句结束时再检查所有行上的约束。创建该约束会自动在<code>ips</code>字段上创建GIST索引，因此无需手工创建了。</p>
<hr>
<h2 id="0x05-小结">0x05 小结</h2>
<p>本文介绍了如何使用PostgreSQL特性高效而优雅地解决IP归属地查询的问题。性能表现优异，600w记录0.3ms定位；复杂度低到发指：只要一张表DDL，连索引都不用显式创建就解决了这一问题；数据完整性有充分的保证：百行代码才能解决的问题现在只要添加约束即可，从根本上保证数据完整性。</p>
<p>PostgreSQL这么棒棒，快快学起来用起来吧~。 什么？你问我数据哪里找？搜索MaxMind有真相，在隐秘的小角落能够找到不要钱的GeoIP数据。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-80c8b198e057fa55db537cdeda973043">PostgreSQL的触发器使用注意事项</h1>
	<div class="lead">详细了解PostgreSQL中触发器的管理与使用</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-07-07" class="text-muted">2018年07月07日</time>
        
	</div>
	<h2 id="概览">概览</h2>
<ul>
<li>触发器行为概述</li>
<li>触发器的分类</li>
<li>触发器的功能</li>
<li>触发器的种类</li>
<li>触发器的触发</li>
<li>触发器的创建</li>
<li>触发器的修改</li>
<li>触发器的查询</li>
<li>触发器的性能</li>
</ul>
<h2 id="触发器概述">触发器概述</h2>
<p>触发器行为概述：<a href="https://www.postgresql.org/docs/11/trigger-definition.html">英文</a>，<a href="http://www.postgres.cn/docs/11/trigger-definition.html">中文</a></p>
<h2 id="触发器分类">触发器分类</h2>
<p>触发时机：<code>BEFORE</code>, <code>AFTER</code>, <code>INSTEAD</code></p>
<p>触发事件：<code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>,<code>TRUNCATE</code></p>
<p>触发范围：语句级，行级</p>
<p>内部创建：用于约束的触发器，用户定义的触发器</p>
<p>触发模式：<code>origin|local(O)</code>, <code>replica(R)</code>,<code>disable(D)</code></p>
<h2 id="触发器操作">触发器操作</h2>
<p>触发器的操作通过SQL DDL语句进行，包括<code>CREATE|ALTER|DROP TRIGGER</code>，以及<code>ALTER TABLE ENABLE|DISABLE TRIGGER</code>进行。注意PostgreSQL内部的约束是通过触发器实现的。</p>
<h4 id="创建">创建</h4>
<p><a href="https://www.postgresql.org/docs/current/sql-createtrigger.html"><code>CREATE TRIGGER</code></a> 可以用于创建触发器。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CONSTRAINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BEFORE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AFTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSTEAD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">event</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">referenced_table_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFERRABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFERRABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INITIALLY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IMMEDIATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INITIALLY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFERRED</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REFERENCING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OLD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">transition_relation_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">STATEMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">condition</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">EXECUTE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PROCEDURE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">function_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">arguments</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">event包括</span><span style="color:#a40000">：</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">column_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">DELETE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">TRUNCATE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h4 id="删除">删除</h4>
<p><a href="https://www.postgresql.org/docs/current/sql-droptrigger.html"><code>DROP TRIGGER</code></a> 用于移除触发器。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RESTRICT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h4 id="修改">修改</h4>
<p><a href="https://www.postgresql.org/docs/current/sql-altertrigger.html"><code>ALTER TRIGGER</code></a> 用于修改触发器定义，注意这里只能修改触发器名，以及其依赖的扩展。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RENAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DEPENDS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">extension_name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>启用禁用触发器，修改触发模式是通过<a href="https://www.postgresql.org/docs/11/sql-altertable.html"><code>ALTER TABLE</code></a>的子句实现的。</p>
<p><a href="https://www.postgresql.org/docs/11/sql-altertable.html"><code>ALTER TABLE</code></a>  包含了一系列触发器修改的子句：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tgname</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 设置触发模式为O (本地连接写入触发，默认)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tgname</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 设置触发模式为R (复制连接写入触发)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ALWAYS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tgname</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 设置触发模式为A (总是触发)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DISABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tgname</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 设置触发模式为D (禁用)
</span></span></span></code></pre></div><p>注意这里在<code>ENABLE</code>与<code>DISABLE</code>触发器时，可以指定用<code>USER</code>替换具体的触发器名称，这样可以只禁用用户显式创建的触发器，不会把系统用于维持约束的触发器也禁用了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DISABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USER</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 禁用所有用户定义的触发器，系统触发器不变  
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DISABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- 禁用所有触发器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USER</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- 启用所有用户定义的触发器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- 启用所有触发器
</span></span></span></code></pre></div><h4 id="查询">查询</h4>
<p><strong>获取表上的触发器</strong></p>
<p>最简单的方式当然是psql的<code>\d+ tablename</code>。但这种方式只会列出用户创建的触发器，不会列出与表上约束相关联的触发器。直接查询系统目录<code>pg_trigger</code>，并通过<code>tgrelid</code>用表名过滤</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_trigger</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tgrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;tbl_name&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">RegClass</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>获取触发器定义</strong></p>
<p><code>pg_get_triggerdef(trigger_oid oid)</code>函数可以给出触发器的定义。</p>
<p>该函数输入参数为触发器OID，返回创建触发器的SQL DDL语句。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_get_triggerdef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_trigger</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- WHERE xxx
</span></span></span></code></pre></div><h2 id="触发器视图">触发器视图</h2>
<p><a href="https://www.postgresql.org/docs/current/catalog-pg-trigger.html"><code>pg_trigger</code></a> (<a href="http://www.postgres.cn/docs/11/catalog-pg-trigger.html">中文</a>) 提供了系统中触发器的目录</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>类型</th>
<th>引用</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>oid</code></td>
<td><code>oid</code></td>
<td></td>
<td>触发器对象标识，系统隐藏列</td>
</tr>
<tr>
<td><code>tgrelid</code></td>
<td><code>oid</code></td>
<td><code>pg_class.oid</code></td>
<td>触发器所在的表 oid</td>
</tr>
<tr>
<td><code>tgname</code></td>
<td><code>name</code></td>
<td></td>
<td>触发器名，表级命名空间内不重名</td>
</tr>
<tr>
<td><code>tgfoid</code></td>
<td><code>oid</code></td>
<td><code>pg_proc.oid</code></td>
<td>触发器所调用的函数</td>
</tr>
<tr>
<td><code>tgtype</code></td>
<td><code>int2</code></td>
<td></td>
<td>触发器类型，触发条件，详见注释</td>
</tr>
<tr>
<td><code>tgenabled</code></td>
<td><code>char</code></td>
<td></td>
<td>触发模式，详见下。`O</td>
</tr>
<tr>
<td><code>tgisinternal</code></td>
<td><code>bool</code></td>
<td></td>
<td>如果是内部用于约束的触发器则为真</td>
</tr>
<tr>
<td><code>tgconstrrelid</code></td>
<td><code>oid</code></td>
<td><code>pg_class.oid</code></td>
<td>参照完整性约束中被引用的表，无则为0</td>
</tr>
<tr>
<td><code>tgconstrindid</code></td>
<td><code>oid</code></td>
<td><code>pg_class.oid</code></td>
<td>支持约束的相关索引，没有则为0</td>
</tr>
<tr>
<td><code>tgconstraint</code></td>
<td><code>oid</code></td>
<td><code>pg_constraint.oid</code></td>
<td>与触发器相关的<strong>约束</strong>对象</td>
</tr>
<tr>
<td><code>tgdeferrable</code></td>
<td><code>bool</code></td>
<td></td>
<td><code>DEFERRED</code>则为真</td>
</tr>
<tr>
<td><code>tginitdeferred</code></td>
<td><code>bool</code></td>
<td></td>
<td><code>INITIALLY DEFERRED</code>则为真</td>
</tr>
<tr>
<td><code>tgnargs</code></td>
<td><code>int2</code></td>
<td></td>
<td>传入触发器函数的字符串参数个数</td>
</tr>
<tr>
<td><code>tgattr</code></td>
<td><code>int2vector</code></td>
<td><code>pg_attribute.attnum</code></td>
<td>如果是列级更新触发器，这里存储列号，否则为空数组。</td>
</tr>
<tr>
<td><code>tgargs</code></td>
<td><code>bytea</code></td>
<td></td>
<td>传递给触发器的参数字符串，C风格零结尾字符串</td>
</tr>
<tr>
<td><code>tgqual</code></td>
<td><code>pg_node_tree</code></td>
<td></td>
<td>触发器<code>WHEN</code>条件的内部表示</td>
</tr>
<tr>
<td><code>tgoldtable</code></td>
<td><code>name</code></td>
<td></td>
<td><code>OLD TABLE</code>的<code>REFERENCING</code>列名称，无则为空</td>
</tr>
<tr>
<td><code>tgnewtable</code></td>
<td><code>name</code></td>
<td></td>
<td><code>NEW TABLE</code>的<code>REFERENCING</code>列名称，无则为空</td>
</tr>
</tbody>
</table>
<h2 id="触发器类型">触发器类型</h2>
<p>触发器类型<code>tgtype</code>包含了触发器触发条件相关信息：<code>BEFORE|AFTER|INSTEAD OF</code>, <code>INSERT|UPDATE|DELETE|TRUNCATE</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">TRIGGER_TYPE_ROW</span>         <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">// [0] 0:语句级 	1:行级
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">TRIGGER_TYPE_BEFORE</span>      <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">// [1] 0:AFTER 	1:BEFORE
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">TRIGGER_TYPE_INSERT</span>      <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">// [2] 1: INSERT
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">TRIGGER_TYPE_DELETE</span>      <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">// [3] 1: DELETE
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">TRIGGER_TYPE_UPDATE</span>      <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">// [4] 1: UPDATE
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">TRIGGER_TYPE_TRUNCATE</span>    <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">// [5] 1: TRUNCATE
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">TRIGGER_TYPE_INSTEAD</span>     <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">// [6] 1: INSTEAD OF 
</span></span></span></code></pre></div><h2 id="触发器模式">触发器模式</h2>
<p>触发器<code>tgenabled</code>字段控制触发器的工作模式，参数<a href="http://www.postgres.cn/docs/11/runtime-config-client.html#GUC-SESSION-REPLICATION-ROLE"><code>session_replication_role</code></a> 可以用于配置触发器的触发模式。该参数可以在会话层级更改，可能的取值包括：<code>origin(default)</code>,<code>replica</code>,<code>local</code>。</p>
<p><code>(D)isable</code>触发器永远不会被触发，<code>(A)lways</code>触发器在任何情况下触发， <code>(O)rigin</code>触发器会在<code>origin|local</code>模式触发（默认），而 <code>(R)eplica</code>触发器<code>replica</code>模式触发。R触发器主要用于逻辑复制，例如<code>pglogical</code>的复制连接就会将会话参数<code>session_replication_role</code>设置为<code>replica</code>，而R触发器只会在该连接进行的变更上触发。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tgname</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 设置触发模式为O (本地连接写入触发，默认)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tgname</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 设置触发模式为R (复制连接写入触发)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ALWAYS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tgname</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 设置触发模式为A (始终触发)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DISABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tgname</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 设置触发模式为D (禁用)
</span></span></span></code></pre></div><p>在<code>information_schema</code>中还有两个触发器相关的视图：<code>information_schema.triggers</code>, <code>information_schema.triggered_update_columns</code>，表过不提。</p>
<h2 id="触发器faq">触发器FAQ</h2>
<h3 id="触发器可以建在哪些类型的表上">触发器可以建在哪些类型的表上？</h3>
<p>普通表（分区表主表，分区表分区表，继承表父表，继承表子表），视图，外部表。</p>
<h3 id="触发器的类型限制">触发器的类型限制</h3>
<ul>
<li>视图上不允许建立<code>BEFORE</code>与<code>AFTER</code>触发器（不论是行级还是语句级）</li>
<li>视图上只能建立<code>INSTEAD OF</code>触发器，<code>INSERTEAD OF</code>触发器也只能建立在视图上，且只有行级，不存在语句级<code>INSTEAD OF</code>触发器。</li>
<li>INSTEAD OF` 触发器只能定义在视图上，并且只能使用行级触发器，不能使用语句级触发器。</li>
</ul>
<h3 id="触发器与锁">触发器与锁</h3>
<p>在表上创建触发器会先尝试获取表级的<code>Share Row Exclusive Lock</code>。这种锁会阻止底层表的数据变更，且自斥。因此创建触发器会阻塞对表的写入。</p>
<h3 id="触发器与copy的关系">触发器与COPY的关系</h3>
<p>COPY只是消除了数据解析打包的开销，实际写入表中时仍然会触发触发器，就像INSERT一样。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-3c4b38169b51bfb4104cc9af240429b9">PostgreSQL开发规约（2018版）</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-06-20" class="text-muted">2018年06月20日</time>
        
	</div>
	<blockquote>
<p><a href="https://mp.weixin.qq.com/s/W1hwbl3qmjC4Dcmadc8uSg">微信公众号原文</a></p>
</blockquote>
<h2 id="0x00背景">0x00背景</h2>
<blockquote>
<p>没有规矩，不成方圆。</p>
</blockquote>
<p>PostgreSQL的功能非常强大，但是要把PostgreSQL用好，需要后端、运维、DBA的协力配合。</p>
<p>本文针对PostgreSQL数据库原理与特性，整理了一份开发规范，希望可以减少大家在使用PostgreSQL数据库过程中遇到的困惑。你好我也好，大家都好。</p>
<h2 id="0x01-命名规范">0x01 命名规范</h2>
<blockquote>
<p>无名，万物之始，有名，万物之母。</p>
</blockquote>
<p>【强制】 <strong>通用命名规则</strong></p>
<ul>
<li>本规则适用于所有对象名，包括：库名、表名、表名、列名、函数名、视图名、序列号名、别名等。</li>
<li>对象名务必只使用小写字母，下划线，数字，但首字母必须为小写字母，常规表禁止以<code>_</code>打头。</li>
<li>对象名长度不超过63个字符，命名统一采用<code>snake_case</code>。</li>
<li>禁止使用SQL保留字，使用<code>select pg_get_keywords();</code> 获取保留关键字列表。</li>
<li>禁止出现美元符号，禁止使用中文，不要以<code>pg</code>开头。</li>
<li>提高用词品味，做到信达雅；不要使用拼音，不要使用生僻冷词，不要使用小众缩写。</li>
</ul>
<p>【强制】 <strong>库命名规则</strong></p>
<ul>
<li>库名最好与应用或服务保持一致，必须为具有高区分度的英文单词。</li>
<li>命名必须以<code>&lt;biz&gt;-</code>开头，<code>&lt;biz&gt;</code>为具体业务线名称，如果是分片库必须以<code>-shard</code>结尾。</li>
<li>多个部分使用<code>-</code>连接。例如：<code>&lt;biz&gt;-chat-shard</code>，<code>&lt;biz&gt;-payment</code>等，总共不超过三段。</li>
</ul>
<p>【强制】 <strong>角色命名规范</strong></p>
<ul>
<li>数据库<code>su</code>有且仅有一个：<code>postgres</code>，用于流复制的用户命名为<code>replication</code>。</li>
<li>生产用户命名使用<code>&lt;biz&gt;-</code>作为前缀，具体功能作为后缀。</li>
<li>所有数据库默认有三个基础角色： <code>&lt;biz&gt;-read</code>，<code>&lt;biz&gt;-write</code>，<code>&lt;biz&gt;-usage</code>，分别拥有所有表的只读，只写，函数的执行权限。</li>
<li>生产用户，ETL用户，个人用户通过继承相应的基础角色获取权限。</li>
<li>更为精细的权限控制使用独立的角色与用户，依业务而异。</li>
</ul>
<p>【强制】 <strong>模式命名规则</strong></p>
<ul>
<li>业务统一使用<code>&lt;*&gt;</code>作为模式名，<code>&lt;*&gt;</code>为业务定义的名称，必须设置为<code>search_path</code>首位元素。</li>
<li><code>dba</code>，<code>monitor</code>，<code>trash</code>为保留模式名。</li>
<li>分片模式命名规则采用：<code>rel_&lt;partition_total_num&gt;_&lt;partition_index&gt;</code>。</li>
<li>无特殊理由不应在其他模式中创建对象。</li>
</ul>
<p>【推荐】 <strong>关系命名规则</strong></p>
<ul>
<li>关系命名以表意清晰为第一要义，不要使用含混的缩写，也不应过分冗长，遵循通用命名规则。</li>
<li>表名应当使用复数名词，与历史惯例保持一致，但应尽量避免带有不规则复数形式的单词。</li>
<li>视图以<code>v_</code>作为命名前缀，物化视图使用<code>mv_</code>作为命名前缀，临时表以<code>tmp_</code>作为命名前缀。</li>
<li>继承或分区表应当以父表表名作为前缀，并以子表特性（规则，分片范围等）作为后缀。</li>
</ul>
<p>【推荐】 <strong>索引命名规则</strong></p>
<ul>
<li>创建索引时如<strong>有条件</strong>应当指定索引名称，并与PostgreSQL默认命名规则保持一致，避免重复执行时建立重复索引。</li>
<li>用于主键的索引以<code>_pkey</code>结尾，唯一索引以<code>_key</code>结尾，用于<code>EXCLUDED</code>约束的索引以<code>_excl</code>结尾，普通索引以<code>_idx</code>结尾。</li>
</ul>
<p>【推荐】 <strong>函数命名规则</strong></p>
<ul>
<li>以<code>select</code>,<code>insert</code>,<code>delete</code>,<code>update</code>,<code>upsert</code>打头，表示动作类型。</li>
<li>重要参数可以通过<code>_by_ids</code>, <code>_by_user_ids</code>的后缀在函数名中体现。</li>
<li>避免函数重载，同名函数尽量只保留一个。</li>
<li>禁止通过<code>BIGINT/INTEGER/SMALLINT</code>等整型进行重载，调用时可能产生歧义。</li>
</ul>
<p>【推荐】 <strong>字段命名规则</strong></p>
<ul>
<li>不得使用系统列保留字段名：<code>oid</code>, <code>xmin</code>, <code>xmax</code>,<code>cmin</code>, <code>cmax</code>, <code>ctid</code>等。</li>
<li>主键列通常命名为<code>id</code>，或以<code>id</code>作为后缀。</li>
<li>创建时间通常命名为<code>created_time</code>，修改时间通常命名为<code>updated_time</code></li>
<li>布尔型字段建议使用<code>is_</code>，<code>has_</code>等作为前缀。</li>
<li>其余各字段名需与已有表命名惯例保持一致。</li>
</ul>
<p>【推荐】 <strong>变量命名规则</strong></p>
<ul>
<li>存储过程与函数中的变量使用命名参数，而非位置参数。</li>
<li>如果参数名与对象名出现冲突，在参数后添加<code>_</code>，例如<code>user_id_</code>。</li>
</ul>
<p>【推荐】 <strong>注释规范</strong></p>
<ul>
<li>尽量为对象提供注释（<code>COMMENT</code>），注释使用英文，言简意赅，一行为宜。</li>
<li>对象的模式或内容语义发生变更时，务必一并更新注释，与实际情况保持同步。</li>
</ul>
<h2 id="0x02-设计规范">0x02 设计规范</h2>
<blockquote>
<p>Suum cuique</p>
</blockquote>
<p>【强制】 <strong>字符编码必须为UTF8</strong></p>
<ul>
<li>禁止使用其他任何字符编码。</li>
</ul>
<p>【强制】 <strong>容量规划</strong></p>
<ul>
<li>单表记录过亿，或超过10GB的量级，可以考虑开始进行分表。</li>
<li>单表容量超过1T，单库容量超过2T。需要考虑分片。</li>
</ul>
<p>【强制】 <strong>不要滥用存储过程</strong></p>
<ul>
<li>存储过程适用于封装事务，减少并发冲突，减少网络往返，减少返回数据量，执行<strong>少量</strong>自定义逻辑。</li>
<li>存储过程<strong>不适合</strong>进行复杂计算，不适合进行平凡/频繁的类型转换与包装。</li>
</ul>
<p>【强制】 <strong>存储计算分离</strong></p>
<ul>
<li>移除数据库中<strong>不必要</strong>的计算密集型逻辑，例如在数据库中使用SQL进行WGS84到其他坐标系的换算。</li>
<li>例外：与数据获取、筛选密切关联的计算逻辑允许在数据库中进行，如PostGIS中的几何关系判断。</li>
</ul>
<p>【强制】 <strong>主键与身份列</strong></p>
<ul>
<li>每个表都必须有<strong>身份列</strong>，原则上必须有主键，最低要求为拥有<strong>非空唯一约束</strong>。</li>
<li>身份列用于唯一标识表中的任一元组，逻辑复制与诸多三方工具有赖于此。</li>
</ul>
<p>【强制】 <strong>外键</strong></p>
<ul>
<li>不建议使用外键，建议在应用层解决。使用外键时，引用必须设置相应的动作：<code>SET NULL</code>, <code>SET DEFAULT</code>, <code>CASCADE</code>，慎用级联操作。</li>
</ul>
<p>【强制】 <strong>慎用宽表</strong></p>
<ul>
<li>字段数目超过15个的表视作宽表，宽表应当考虑进行纵向拆分，通过相同的主键与主表相互引用。</li>
<li>因为MVCC机制，宽表的写放大现象比较明显，尽量减少对宽表的频繁更新。</li>
</ul>
<p>【强制】 <strong>配置合适的默认值</strong></p>
<ul>
<li>有默认值的列必须添加<code>DEFAULT</code>子句指定默认值。</li>
<li>可以在默认值中使用函数，动态生成默认值（例如主键发号器）。</li>
</ul>
<p>【强制】 <strong>合理应对空值</strong></p>
<ul>
<li>字段语义上没有零值与空值区分的，不允许空值存在，须为列配置<code>NOT NULL</code>约束。</li>
</ul>
<p>【强制】 <strong>唯一约束通过数据库强制</strong>。</p>
<ul>
<li>唯一约束须由数据库保证，任何唯一列须有唯一约束。</li>
<li><code>EXCLUDE</code>约束是泛化的唯一约束，可以在低频更新场景下用于保证数据完整性。</li>
</ul>
<p>【强制】 <strong>注意整数溢出风险</strong></p>
<ul>
<li>注意SQL标准不提供无符号整型，超过<code>INTMAX</code>但没超过<code>UINTMAX</code>的值需要升格存储。</li>
<li>不要存储超过<code>INT64MAX</code>的值到<code>BIGINT</code>列中，会溢出为负数。</li>
</ul>
<p>【强制】 <strong>统一时区</strong></p>
<ul>
<li>使用<code>TIMESTAMP</code>存储时间，采用<code>utc</code>时区。</li>
<li>统一使用ISO-8601格式输入输出时间类型：<code>2006-01-02 15:04:05</code>，避免DMY与MDY问题。</li>
<li>使用<code>TIMESTAMPTZ</code>时，采用GMT/UTC时间，0时区标准时。</li>
</ul>
<p>【强制】 <strong>及时清理过时函数</strong></p>
<ul>
<li>不再使用的，被替换的函数应当及时下线，避免与未来的函数发生冲突。</li>
</ul>
<p>【推荐】 <strong>主键类型</strong></p>
<ul>
<li>主键通常使用整型，建议使用<code>BIGINT</code>，允许使用不超过64字节的字符串。</li>
<li>主键允许使用<code>Serial</code>自动生成，建议使用<code>Default next_id()</code>发号器函数。</li>
</ul>
<p>【推荐】 <strong>选择合适的类型</strong></p>
<ul>
<li>能使用专有类型的，不使用字符串。（数值，枚举，网络地址，货币，JSON，UUID等）</li>
<li>使用正确的数据类型，能显著提高数据存储，查询，索引，计算的效率，并提高可维护性。</li>
</ul>
<p>【推荐】 <strong>使用枚举类型</strong></p>
<ul>
<li>较稳定的，取值空间较小（十几个内）的字段应当使用枚举类型，不要使用整型与字符串表示。</li>
<li>使用枚举类型有性能、存储、可维护性上的优势。</li>
</ul>
<p>【推荐】 <strong>选择合适的文本类型</strong></p>
<ul>
<li>PostgreSQL的文本类型包括 <code>char(n)</code>, <code>varchar(n)</code>, <code>text</code>。</li>
<li>通常建议使用<code>varchar</code>或<code>text</code>，带有<code>(n)</code>修饰符的类型会检查字符串长度，会导致微小的额外开销，对字符串长度有限制时应当使用<code>varchar(n)</code>，避免插入过长的脏数据。</li>
<li>避免使用<code>char(n)</code>，为了与SQL标准兼容，该类型存在不合直觉的行为表现（补齐空格与截断），且并没有存储和性能优势。</li>
</ul>
<p>【推荐】 <strong>选择合适的数值类型</strong></p>
<ul>
<li>常规数值字段使用<code>INTEGER</code>。主键、容量拿不准的数值列使用<code>BIGINT</code>。</li>
<li>无特殊理由不要用<code>SMALLINT</code>，性能与存储提升很小，会有很多额外的问题。</li>
<li><code>REAL</code>表示4字节浮点数，<code>FLOAT</code>表示8字节浮点数</li>
<li>浮点数仅可用于末尾精度无所谓的场景，例如地理坐标，不要对浮点数使用等值判断。</li>
<li>精确数值类型使用<code>NUMERIC</code>，注意精度和小数位数设置。</li>
<li>货币数值类型使用<code>MONEY</code>。</li>
</ul>
<p>【推荐】 <strong>使用统一的函数创建语法</strong></p>
<ul>
<li>签名单独占用一行（函数名与参数），返回值单启一行，语言为第一个标签。</li>
<li>一定要标注函数易变性等级：<code>IMMUTABLE</code>, <code>STABLE</code>, <code>VOLATILE</code>。</li>
<li>添加确定的属性标签，如：<code>RETURNS NULL ON NULL INPUT</code>,<code>PARALLEL SAFE</code>,<code>ROWS 1</code>，注意版本兼容性。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">myfunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">arg1_</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">arg2_</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">VOID</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SQL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">STABLE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">PARALLEL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SAFE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ROWS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INPUT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#204a87;font-weight:bold">function</span><span style="color:#a40000">$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$</span><span style="color:#204a87;font-weight:bold">function</span><span style="color:#a40000">$</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>【推荐】 <strong>针对可演化性而设计</strong></p>
<ul>
<li>在设计表时，应当充分考虑未来的扩展需求，可以在建表时适当添加1~3个保留字段。</li>
<li>对于多变的非关键字段可以使用JSON类型。</li>
</ul>
<p>【推荐】 <strong>选择合理的规范化等级</strong></p>
<ul>
<li>允许适当降低规范化等级，减少多表连接以提高性能。</li>
</ul>
<p>【推荐】 <strong>使用新版本</strong></p>
<ul>
<li>新版本有无成本的性能提升，稳定性提升，有更多新功能。</li>
<li>充分利用新特性，降低设计复杂度。</li>
</ul>
<p>【推荐】 <strong>慎用触发器</strong></p>
<ul>
<li>触发器会提高系统的复杂度与维护成本，不鼓励使用。</li>
</ul>
<h2 id="0x03-索引规范">0x03 索引规范</h2>
<blockquote>
<p>Wer Ordnung hält, ist nur zu faul zum Suchen.</p>
</blockquote>
<p>【强制】 <strong>在线查询必须有配套索引</strong></p>
<ul>
<li>所有在线查询必须针对其访问模式设计相应索引，除极个别小表外不允许全表扫描。</li>
<li>索引有代价，不允许创建不使用的索引。</li>
</ul>
<p>【强制】 <strong>禁止在大字段上建立索引</strong></p>
<ul>
<li>被索引字段大小无法超过2KB（1/3的页容量），原则上禁止超过64个字符。</li>
<li>如有大字段索引需求，可以考虑对大字段取哈希，并建立函数索引。或使用其他类型的索引（GIN）。</li>
</ul>
<p>【强制】 <strong>明确空值排序规则</strong></p>
<ul>
<li>如在可空列上有排序需求，需要在查询与索引中明确指定<code>NULLS FIRST</code>还是<code>NULLS LAST</code>。</li>
<li>注意，<code>DESC</code>排序的默认规则是<code>NULLS FIRST</code>，即空值会出现在排序的最前面，通常这不是期望行为。</li>
<li>索引的排序条件必须与查询匹配，如：<code>create index on tbl (id desc nulls last);</code></li>
</ul>
<p>【强制】 <strong>利用GiST索引应对近邻查询问题</strong></p>
<ul>
<li>传统B树索引无法提供对KNN问题的良好支持，应当使用GiST索引。</li>
</ul>
<p>【推荐】 <strong>利用函数索引</strong></p>
<ul>
<li>任何可以由同一行其他字段推断得出的冗余字段，可以使用函数索引替代。</li>
<li>对于经常使用表达式作为查询条件的语句，可以使用表达式或函数索引加速查询。</li>
<li>典型场景：建立大字段上的哈希函数索引，为需要左模糊查询的文本列建立reverse函数索引。</li>
</ul>
<p>【推荐】 <strong>利用部分索引</strong></p>
<ul>
<li>查询中查询条件固定的部分，可以使用部分索引，减小索引大小并提升查询效率。</li>
<li>查询中某待索引字段若只有有限几种取值，也可以建立几个相应的部分索引。</li>
</ul>
<p>【推荐】 <strong>利用范围索引</strong></p>
<ul>
<li>对于值与堆表的存储顺序线性相关的数据，如果通常的查询为范围查询，建议使用BRIN索引。</li>
<li>最典型场景如仅追加写入的时序数据，BRIN索引更为高效。</li>
</ul>
<p>【推荐】 <strong>关注联合索引的区分度</strong></p>
<ul>
<li>区分度高的列放在前面</li>
</ul>
<h2 id="0x04-查询规范">0x04 查询规范</h2>
<blockquote>
<p>The limits of my language mean the limits of my world.</p>
<p>—Ludwig Wittgenstein</p>
</blockquote>
<p>【强制】 <strong>读写分离</strong></p>
<ul>
<li>原则上写请求走主库，读请求走从库。</li>
<li>例外：需要读己之写的一致性保证，且检测到显著的复制延迟。</li>
</ul>
<p>【强制】 <strong>快慢分离</strong></p>
<ul>
<li>生产中1毫秒以内的查询称为快查询，生产中超过1秒的查询称为慢查询。</li>
<li>慢查询必须走离线从库，必须设置相应的超时。</li>
<li>生产中的在线普通查询执行时长，原则上应当控制在1ms内。</li>
<li>生产中的在线普通查询执行时长，超过10ms需修改技术方案，优化达标后再上线。</li>
<li>在线查询应当配置10ms数量级或更快的超时，避免堆积造成雪崩。</li>
<li>Master与Slave角色不允许大批量拉取数据，数仓ETL程序应当从Offline从库拉取数据</li>
</ul>
<p>【强制】 <strong>主动超时</strong></p>
<ul>
<li>为所有的语句配置主动超时，超时后主动取消请求，避免雪崩。</li>
<li>周期性执行的语句，必须配置小于执行周期的超时。</li>
</ul>
<p>【强制】 <strong>关注复制延迟</strong></p>
<ul>
<li>应用必须意识到主从之间的同步延迟，并妥善处理好复制延迟超出合理范围的情况</li>
<li>平时在0.1ms的延迟，在极端情况下可能达到十几分钟甚至小时量级。应用可以选择从主库读取，稍后再度，或报错。</li>
</ul>
<p>【强制】 <strong>使用连接池</strong></p>
<ul>
<li>应用必须通过连接池访问数据库，连接6432端口的pgbouncer而不是5432的postgres。</li>
<li>注意使用连接池与直连数据库的区别，一些功能可能无法使用（比如Notify/Listen），也可能存在连接污染的问题。</li>
</ul>
<p>【强制】 <strong>禁止修改连接状态</strong></p>
<ul>
<li>使用公共连接池时禁止修改连接状态，包括修改连接参数，修改搜索路径，更换角色，更换数据库。</li>
<li>万不得已修改后必须彻底销毁连接，将状态变更后的连接放回连接池会导致污染扩散。</li>
</ul>
<p>【强制】 <strong>重试失败的事务</strong></p>
<ul>
<li><strong>查询</strong>可能因为并发争用，管理员命令等原因被杀死，应用需要意识到这一点并在必要时重试。</li>
<li>应用在数据库大量报错时可以触发断路器熔断，避免雪崩。但要注意区分错误的类型与性质。</li>
</ul>
<p>【强制】 <strong>掉线重连</strong></p>
<ul>
<li><strong>连接</strong>可能因为各种原因被中止，应用<strong>必须</strong>有掉线重连机制。</li>
<li>可以使用<code>SELECT 1</code>作为心跳包查询，检测连接的有消息，并定期保活。</li>
</ul>
<p>【强制】 <strong>在线服务应用代码禁止执行DDL</strong></p>
<ul>
<li>不要在应用代码里搞大新闻。</li>
</ul>
<p>【强制】 <strong>显式指定列名</strong></p>
<ul>
<li>避免使用<code>SELECT *</code>，或在<code>RETURNING</code>子句中使用<code>*</code>。请使用具体的字段列表，不要返回用不到的字段。当表结构发生变动时（例如，新值列），使用列通配符的查询很可能会发生列数不匹配的错误。</li>
<li>例外：当存储过程返回具体的表行类型时，允许使用通配符。</li>
</ul>
<p>【强制】 <strong>禁止在线查询全表扫描</strong></p>
<ul>
<li>例外情况：常量极小表，极低频操作，表/返回结果集很小（百条记录/百KB内）。</li>
<li>在首层过滤条件上使用诸如<code>!=</code>, <code>&lt;&gt;</code>的否定式操作符会导致全表扫描，必须避免。</li>
</ul>
<p>【强制】 <strong>禁止在事务中长时间等待</strong></p>
<ul>
<li>开启事务后必须尽快提交或回滚，超过10分钟的<code>IDEL IN Transaction</code>将被强制杀死。</li>
<li>应用应当开启AutoCommit，避免<code>BEGIN</code>之后没有配对的<code>ROLLBACK</code>或<code>COMMIT</code>。</li>
<li>尽量使用标准库提供的事务基础设施，不到万不得已不要手动控制事务。</li>
</ul>
<p>【强制】 <strong>使用游标后必须及时关闭</strong></p>
<p>【强制】 <strong>科学计数</strong></p>
<ul>
<li><code>count(*)</code>是<strong>统计行数</strong>的标准语法，与空值无关。</li>
<li><code>count(col)</code>统计的是<code>col</code>列中的<strong>非空记录数</strong>。该列中的NULL值不会被计入。</li>
<li><code>count(distinct col)</code> 对<code>col</code>列除重计数，同样忽视空值，即只统计非空不同值的个数。</li>
<li><code>count((col1, col2))</code>对多列计数，即使待计数的列全为空也会被计数，<code>(NULL,NULL)</code>有效。</li>
<li><code>a(distinct (col1, col2))</code>对多列除重计数，即使待计数列全为空也会被计数，<code>(NULL,NULL)</code>有效。</li>
</ul>
<p>【强制】 <strong>注意聚合函数的空值问题</strong></p>
<ul>
<li>除了<code>count</code>之外的所有聚合函数都会忽略空值输入，因此当输入值全部为空时，结果是<code>NULL</code>。但<code>count(col)</code>在这种情况下会返回0，是一个例外。</li>
<li>如果聚集函数返回空并不是期望的结果，使用<code>coalesce</code>来设置缺省值。</li>
</ul>
<p>【强制】<strong>谨慎处理空值</strong></p>
<ul>
<li>明确区分零值与空值，空值使用<code>IS NULL</code>进行等值判断，零值使用常规的<code>=</code>运算符进行等值判断。</li>
<li>空值作为函数输入参数时应当带有类型修饰符，否则对于有重载的函数将无法识别使用何者。</li>
<li>注意空值比较逻辑：任何涉及到空值比较运算结果都是<code>unknown</code>，需要注意<code>unknown</code>参与布尔运算的逻辑：
<ul>
<li><code>and</code>：<code>TRUE or UNKNOWN</code>会因为逻辑短路返回<code>TRUE</code>。</li>
<li><code>or</code>：<code>FALSE and UNKNOWN</code>会因为逻辑短路返回<code>FALSE</code></li>
<li>其他情况只要运算对象出现<code>UNKNOWN</code>，结果都是<code>UNKNOWN</code></li>
</ul>
</li>
<li>空值与<strong>任何值</strong>的逻辑判断，其结果都为空值，例如<code>NULL=NULL</code>返回结果是<code>NULL</code>而不是<code>TRUE/FALSE</code>。</li>
<li>涉及空值与非空值的等值比较，请使用``IS DISTINCT FROM<code> </code>进行比较，保证比较结果非空。</li>
<li>空值与聚合函数：聚合函数当输入值<strong>全部</strong>为NULL时，返回结果为NULL。</li>
</ul>
<p>【强制】 <strong>注意序列号空缺</strong></p>
<ul>
<li>当使用<code>Serial</code>类型时，<code>INSERT</code>，<code>UPSERT</code>等操作都会消耗序列号，该消耗不会随事务失败而回滚。</li>
<li>当使用整型作为主键，且表存在频繁插入冲突时，需要关注整型溢出的问题。</li>
</ul>
<p>【推荐】  <strong>重复查询使用准备语句</strong></p>
<ul>
<li>重复的查询应当使用<strong>准备语句（Prepared Statement）</strong>，消除数据库硬解析的CPU开销。</li>
<li>准备语句会修改连接状态，请注意连接池对于准备语句的影响。</li>
</ul>
<p>【推荐】 <strong>选择合适的事务隔离等级</strong></p>
<ul>
<li>默认隔离等级为<strong>读已提交</strong>，适合大多数简单读写事务，普通事务选择满足需求的最低隔离等级。</li>
<li>需要事务级一致性快照的写事务，请使用<strong>可重复读</strong>隔离等级。</li>
<li>对正确性有严格要求的写入事务请使用<strong>可序列化</strong>隔离等级。</li>
<li>在RR与SR隔离等级出现并发冲突时，应当视错误类型进行积极的重试。</li>
</ul>
<p>【推荐】 <strong>判断结果存在性不要使用count</strong></p>
<ul>
<li>使用<code>SELECT 1 FROM tbl WHERE xxx LIMIT 1</code>判断是否存满足条件的列，要比Count快。</li>
<li>可以使用<code>select exists(select * FROM app.sjqq where xxx limit 1)</code>将存在性结果转换为布尔值。</li>
</ul>
<p>【推荐】 <strong>使用RETURNING子句</strong></p>
<ul>
<li>如果用户需要在插入数据和，删除数据前，或者修改数据后马上拿到插入或被删除或修改后的数据，建议使用<code>RETURNING</code>子句，减少数据库交互次数。</li>
</ul>
<p>【推荐】 <strong>使用UPSERT简化逻辑</strong></p>
<ul>
<li>当业务出现插入-失败-更新的操作序列时，考虑使用<code>UPSERT</code>替代。</li>
</ul>
<p>【推荐】 <strong>利用咨询锁应对热点并发</strong>。</p>
<ul>
<li>针对单行记录的极高频并发写入（秒杀），应当使用咨询锁对记录ID进行锁定。</li>
<li>如果能在应用层次解决高并发争用，就不要放在数据库层面进行。</li>
</ul>
<p>【推荐】<strong>优化IN操作符</strong></p>
<ul>
<li>使用<code>EXISTS</code>子句代替<code>IN</code>操作符，效果更佳。</li>
<li>使用<code>=ANY(ARRAY[1,2,3,4])</code>代替<code>IN (1,2,3,4)</code>，效果更佳。</li>
</ul>
<p>【推荐】 <strong>不建议使用左模糊搜索</strong></p>
<ul>
<li>左模糊搜索<code>WHERE col LIKE '%xxx'</code>无法充分利用B树索引，如有需要，可用<code>reverse</code>表达式函数索引。</li>
</ul>
<p>【推荐】 <strong>使用数组代替临时表</strong></p>
<ul>
<li>考虑使用数组替代临时表，例如在获取一系列ID的对应记录时。<code>=ANY(ARRAY[1,2,3])</code>要比临时表JOIN好。</li>
</ul>
<h2 id="0x05-发布规范">0x05 发布规范</h2>
<p>【强制】 <strong>发布形式</strong></p>
<ul>
<li>目前以邮件形式提交发布，发送邮件至dba@p1.com 归档并安排提交。</li>
<li>标题清晰：xx项目需在xx库执行xx动作。</li>
<li>目标明确：每个步骤需要在哪些实例上执行哪些操作，结果如何校验。</li>
<li>回滚方案：任何变更都需要提供回滚方案，新建也需要提供清理脚本。</li>
</ul>
<p>【强制】<strong>发布评估</strong></p>
<ul>
<li>线上数据库发布需要经过研发自测，主管审核，（可选QA审核），DBA审核几个评估阶段。</li>
<li>自测阶段应当确保变更在开发、预发环境执行正确无误。
<ul>
<li>如果是新建表，应当给出记录数量级，数据日增量预估值，读写量级预估。</li>
<li>如果是新建函数，应当给出压测报告，至少需要给出平均执行时间。</li>
<li>如果是模式迁移，必须梳理清楚所有上下游依赖。</li>
</ul>
</li>
<li>Team Leader需要对变更进行评估与审核，对变更内容负责。</li>
<li>DBA对发布的形式与影响进行评估与审核。</li>
</ul>
<p>【强制】 <strong>发布窗口</strong></p>
<ul>
<li>19:00 后不允许数据库发布，紧急发布请TL做特殊说明，抄送CTO。</li>
<li>16:00点后确认的需求将顺延至第二天执行。（以TL确认时间为准）</li>
</ul>
<h2 id="0x06-管理规范">0x06 管理规范</h2>
<p>【强制】 <strong>关注备份</strong></p>
<ul>
<li>每日全量备份，段文件持续归档</li>
</ul>
<p>【强制】 <strong>关注年龄</strong></p>
<ul>
<li>关注数据库与表的年龄，避免事物ID回卷。</li>
</ul>
<p>【强制】 <strong>关注老化与膨胀</strong></p>
<ul>
<li>关注表与索引的膨胀率，避免性能劣化。</li>
</ul>
<p>【强制】 <strong>关注复制延迟</strong></p>
<ul>
<li>监控复制延迟，使用复制槽时更必须十分留意。</li>
</ul>
<p>【强制】 <strong>遵循最小权限原则</strong></p>
<p>【强制】<strong>并发地创建与删除索引</strong></p>
<ul>
<li>对于生产表，必须使用<code>CREATE INDEX CONCURRENTLY</code>并发创建索引。</li>
</ul>
<p>【强制】 <strong>新从库数据预热</strong></p>
<ul>
<li>使用<code>pg_prewarm</code>，或逐渐接入流量。</li>
</ul>
<p>【强制】 <strong>审慎地进行模式变更</strong></p>
<ul>
<li>添加新列时必须使用不带默认值的语法，避免全表重写</li>
<li>变更类型时，必要时应当重建所有依赖该类型的函数。</li>
</ul>
<p>【推荐】 <strong>切分大批量操作</strong></p>
<ul>
<li>大批量写入操作应当切分为小批量进行，避免一次产生大量WAL。</li>
</ul>
<p>【推荐】 <strong>加速数据加载</strong></p>
<ul>
<li>关闭<code>autovacuum</code>，使用<code>COPY</code>加载数据。</li>
<li>事后建立约束与索引。</li>
<li>调大<code>maintenance_work_mem</code>，增大<code>max_wal_size</code>。</li>
<li>完成后执行<code>vacuum verbose analyze table</code>。</li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-ee6b9008dea2b9404e580577dbbf6c1c">KNN极致优化：从RDS到PostGIS</h1>
	<div class="lead">KNN问题极致优化，从传统关系型设计到PostGIS</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-06-06" class="text-muted">2018年06月06日</time>
        
	</div>
	<p>灵活应用数据库的功能，可以轻松实现 GIS 圈选场景下三万倍的性能提升。</p>
<table>
<thead>
<tr>
<th style="text-align:center">Level</th>
<th style="text-align:center">方法</th>
<th style="text-align:center">性能/耗时(ms)</th>
<th style="text-align:center">可维护性/可靠性</th>
<th style="text-align:center">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">暴力扫表</td>
<td style="text-align:center">30,000</td>
<td style="text-align:center">-</td>
<td style="text-align:center">形式简单</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">经纬索引</td>
<td style="text-align:center">35</td>
<td style="text-align:center">复杂度/魔数问题</td>
<td style="text-align:center">额外复杂度</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">联合索引</td>
<td style="text-align:center">10</td>
<td style="text-align:center">复杂度/魔数问题</td>
<td style="text-align:center">额外复杂度</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">GIST</td>
<td style="text-align:center">4</td>
<td style="text-align:center">最简表达，完全精确</td>
<td style="text-align:center">形式简单，距离更精确，PostgreSQL限定</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center"><code>btree_gist</code>联合索引</td>
<td style="text-align:center">1</td>
<td style="text-align:center">最简表达，完全精确</td>
<td style="text-align:center">形式简单，距离更精确，PostgreSQL限定</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="场景">场景</h2>
<p>互联网中的很多业务都涉及到地理相关的功能需求，最为普遍的需求莫过于最近邻查询了。</p>
<p>例如：</p>
<ul>
<li>为用户推荐附近的POI（餐厅、加油站、公交站）</li>
<li>为用户推荐附近的用户（聊天匹配）</li>
<li>找到距离用户所处的地址（地理逆编码）</li>
<li>找到用户所处的商圈、省、市、区、县 (以点找面)</li>
</ul>
<p>这些问题实质上都属于最近邻搜索或其变体。</p>
<p>有一些功能，它看上去和最近邻搜索无关，实际上剥了皮，也是最近邻搜索，典型的例如地理逆编码：</p>
<p>打车选择上车地点的时，点外卖选择送达位置时，都会将用户当前的经纬度坐标转换为文本地理位置，诸如：“某某小区几号楼”。实际上这也是最近邻搜索的问题：找到距离用户当前位置<strong>最近的一个</strong>坐标点。</p>
<p><strong>最近邻（knn，k nearest neighiboor）</strong>，顾名思义，就是找出距离某个中心点最近的K个对象。其问题满足这样一种形式：</p>
<blockquote>
<p>找出满足<strong>某一条件</strong>的最近的K个对象（及其属性）。</p>
</blockquote>
<p>最近邻搜索是如此常用的功能，优化的效益非常显著。</p>
<p>下面我们从一个具体问题出发，讲述这一功能实现方式的演化——如何实现超过三万倍的性能提升。</p>
<hr>
<h2 id="问题">问题</h2>
<p>我们选择推荐最近的餐厅，作为此类问题的代表。</p>
<p>问题很简单：给定包含中国所有POI点的表<code>pois</code>，及一个经纬度坐标点。在<strong>足够快</strong>的时间内找出<strong>距离</strong>该坐标点最近的10家餐馆。并返回这十家餐馆的名称和<strong>距离</strong>。</p>
<p>细节说明：</p>
<ul>
<li>
<p><code>pois</code>表包括一亿条记录，其中类型为餐馆的POI约占一千万。</p>
</li>
<li>
<p>给定的示例中心店：北京师范大学，116.3660 E, 39.9615 N。</p>
</li>
<li>
<p>足够快意味着在1毫秒内完成</p>
</li>
<li>
<p>距离意味着，以米计算的地球表面距离</p>
</li>
<li>
<p><code>pois</code>表模式定义：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pois</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87">CHAR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87">VARCHAR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">position</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">GEOMETRY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- PostGIS ST_Point
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">longitude</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">-- Float64
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">latitude</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">-- Float64
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">category</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- type of POI
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>餐馆的特征是<code>WHERE category BETWEEN 50000 AND 51000</code></p>
</li>
</ul>
<h3 id="同类问题">同类问题</h3>
<p>这个模式适用于许多的例子，例如对探探而言，其实就可以是：找出离用户所在位置最近的，且年龄位于某个范围，加上一些其他筛选条件的100个人。</p>
<p>对于美团点评而言，就是找出离用户最近的10个，类型为餐馆的POI。</p>
<p>对于逆地理编码而言，实质上就是找出离用户最近的POI（加上可选的类型限制，类型十字路口，地标建筑等）</p>
<blockquote>
<p><strong>题外话-坐标系：WGS84与GCJ02</strong></p>
<p>这是另外一个很多人都会搞混的地方。</p>
<ul>
<li>滴滴打车的魔幻偏移。</li>
<li>港澳台边界，碎屑多边形。</li>
</ul>
</blockquote>
<p>绝大多数互联网中与地理相关的功能，都涉及到最近邻查询的需求。</p>
<p>比如对于谈朋友的场景，把这里的  <code>WHERE category BETWEEN 50000 AND 51000</code></p>
<p>换成 <code>WHERE age BETWEEN 18 AND 27</code>就好。</p>
<p>很多打ACM的同学，熟练使用各种数据结构与算法。可能已经跃跃欲试了，R树，就决定是你了。</p>
<p>不过在真实项目中，数据表就是数据结构，而索引与查询方式就是算法。</p>
<h3 id="距离如何定义">距离如何定义？</h3>
<p>欲解此题，需明定义。距离的定义并没有看上去那样简单。</p>
<p>例如，对于导航软件而言，距离可能意味着<strong>路径长度</strong>而非直线距离。</p>
<p>在二维平面坐标系中，通常距离指的是欧氏距离：$d=\sqrt{(x_2-x_1)^2+(y_2-y_1)^2}$</p>
<p>但在GIS中，通常使用的坐标系是球面坐标系，即通过经纬度来标识一个点。</p>
<p>在球面上，两点之间的距离等于所在球面大圆上的弧长，也就是其球面角 x 半径。</p>
<p>这就引入了一个问题，每一纬度对应的距离是基本恒定的，差不多都是111公里。</p>
<p>然而，每一经度对应的距离，随着纬度不同而变化，在赤道上和一纬度差不多，也是111公里，然而随着纬度升高，到了北纬40°时，一经度对应的弧长只有85公里了，而到了北极点，一经度对应的弧长距离为0。</p>
<p>事实上，还会有其他更棘手的问题。例如，地球实际上是一个椭球体，而非正球体。</p>
<p>地球非球，乃不规则椭球。在最开始的时候，为了省事，我们可以设其为球计算距离。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sphere_distance</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lon_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lat_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lon_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lat_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">asin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#000">sqrt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#000">sin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">radians</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lat_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lat_a</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">^</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#000">sin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">radians</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lon_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lon_a</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">^</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cos</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">radians</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lat_a</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cos</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">radians</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lat_b</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">127561999</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">961088</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">distance</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SQL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IMMUTABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">COST</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>将经纬度坐标当成平面坐标使用并不是不可以，但对于需要精准排序的场景，这样的近似可能会产生很大的问题：</p>
<p>每一经度对应的距离，随着纬度不同而变化，在赤道上一经度和一纬度代表的距离差不多都是111公里，然而随着纬度升高，到了北纬40°时，一经度对应的弧长只有85公里了，而到了极点，一经度对应的弧长距离为0。</p>
<p>因此，平面坐标系上的圆，在球面坐标系上可能只是一个瘦长的椭圆。计算距离时，纬度与经度方向上的距离权重不同会导致严重的正确性问题：一个正北100米处的商店可能比正东70m处的商店距离排序更靠前。对于高纬度地区，这一类问题会变得非常严重。</p>
<p>因此，暴力扫表之后，通常需要使用精确的距离计算公式再次计算并排序。</p>
<p>注意，这里的距离，量纲单位并不是米，而是°的平方，考虑到1经度和1纬度对应的实际距离在不同的地方存在巨大差异，这一结果并没有精确的实际意义。</p>
<p>经纬度是球面坐标系，而不是二维平面坐标系中的坐标。然而对于快速粗略圈选，这种方式是可以接受的。</p>
<p>对于需要精确排序的场景，必须使用地球表面球面距离的计算公式，而不是简单地求欧氏距离。</p>
<h3 id="足够快又是多快">足够快又是多快？</h3>
<p>天下武功，唯快不破，互联网强调的就是一个快，跑的也快，写的也快。</p>
<p>足够快又是多快呢？一毫秒，足够快了。这也是我们的优化目标</p>
<p>好了，开始进入干货环节。在PostGIS展现真正的实力之前，让我们来先看一看传统的关系型数据库，对解决这一问题，能走到多远。</p>
<hr>
<h2 id="0x02-方案">0x02 方案</h2>
<p>让我们从传统关系型数据库开始</p>
<h3 id="level-1-暴力扫表">LEVEL-1 暴力扫表</h3>
<p>使用传统关系型数据库，此题有何解法？</p>
<p>暴力算法写起来是非常简单的，我们来看一下。</p>
<p>从POIS表中，首先找出所有的餐馆，拿出餐馆的名字，算出餐馆到我们这儿的距离，然后呢？再按距离排序，取距离最短的，也就是最近的10条记录。</p>
<p>新手拍拍脑袋，也可以很快写出这样Naive的SQL：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">sphere_distance</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">longitude</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">latitude</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#0000cf;font-weight:bold">116</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">3660</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">39</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">9615</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pois</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">category</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BETWEEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">51000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>为了简化问题，让我们暂时忽略经纬度其实是球面坐标，地球又是个椭球体的事实。</p>
<p><strong>在这一前提下，这个SQL确实能正确完成工作</strong>。不过，谁要敢在生产环境这么用，DBA肯定得打死他。</p>
<p>让我们先考察其执行计划：</p>
<p><img src="/img/blog/pg/knn-explain-l1.png"></p>
<blockquote>
<h3 id="题外话sql内联">题外话：SQL内联</h3>
<p>SQL内联有助于正确使用索引。</p>
</blockquote>
<p>在真实环境执行，缓存充分预热，实际耗时30秒；开启PostgreSQL并行查询（2 worker）后实际执行时间16秒。</p>
<p>用时30秒，实际执行时间17秒。</p>
<p>用户对于响应时间是很敏感的，响应时间一上去，用户满意度立马就会掉下来。打王者荣耀的时候，100毫秒的延迟都已经很让人抓狂了。如果是一个实时性</p>
<p>对于几千条记录的表也许可以凑合工作，但对于1亿量级的表，暴力扫表不可取。</p>
<p>用户无法接受十几秒的等待时间，更罔论这样的设计能有任何扩展性可言。</p>
<h3 id="存在的问题">存在的问题</h3>
<h4 id="开销离谱">开销离谱</h4>
<p>这个查询每次都要计算<strong>目标点</strong>和<strong>所有记录点</strong>之间的距离，然后再按距离排序取TOP。</p>
<p>对于几千条记录的表也许可以凑合工作，但对于1亿量级的表，暴力扫表不可取。用户无法接受十几秒的等待时间，更罔论这样的设计能有任何扩展性可言。</p>
<h4 id="正确性堪忧">正确性堪忧</h4>
<p>将经纬度坐标当成平面坐标使用并不是不可以，但对于需要精准排序的场景，这样的近似可能会产生很大的问题：</p>
<p>每一经度对应的距离，随着纬度不同而变化，在赤道上一经度和一纬度代表的距离差不多都是111公里，然而随着纬度升高，到了北纬40°时，一经度对应的弧长只有85公里了，而到了极点，一经度对应的弧长距离为0。</p>
<p>因此，平面坐标系上的圆，在球面坐标系上可能只是一个瘦长的椭圆。计算距离时，纬度与经度方向上的距离权重不同会导致严重的正确性问题：一个正北100米处的商店可能比正东70m处的商店距离排序更靠前。对于高纬度地区，这一类问题会变得非常严重。</p>
<p>因此，暴力扫表之后，通常需要使用精确的距离计算公式再次计算并排序。</p>
<h3 id="题外话错误的索引效果适得其反">题外话：错误的索引效果适得其反</h3>
<p>有同学会说，这里POI类型字段，category出现在了查询的where条件中，可以通过索引来提高性能</p>
<p>这次他不直接扫表了，它先去扫描category上的索引，把属于餐厅的记录都过滤出来。</p>
<p>然后再按照索引，一个页面接一个页面地扫描。</p>
<p>结果顺序IO变成了随机IO。</p>
<p>那么索引的正确使用方式又是怎么样的呢？</p>
<h2 id="level-2-经纬索引">LEVEL-2 经纬索引</h2>
<p>索引是关系型数据库的吃饭家伙，既然顺序扫表不可取，我们自然会想到利用索引来加速查询。</p>
<p>朴素的思路是这样的，通过索引筛选出目标点周围一定范围内的候选点，再进一步计算距离并排序。</p>
<p>索引是关系型数据库的吃饭家伙，既然顺序扫表不可取，我们自然会想到利用索引来加速查询。</p>
<p>使用经纬度上的索引是基于这样一种思路：</p>
<p>北师在帝都繁华之地宇宙中心，如果我们用一个边长一公里的正方形（直径一公里的圆）</p>
<p>去地图上画个圈，那么别说十家餐厅了，一百家都有可能。</p>
<p>反过来说呢，既然最近的10家餐厅一定落在这么大的一个圆里，</p>
<p>这个表里的POI点包括了全中国的POI点，</p>
<p>筛选出目标点周围一定范围内的候选点，再进一步计算距离并排序。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pois1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">longitude</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pois1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">latitude</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>同时，为了解决正确性的问题，假设我们已经有了一个从经纬度计算球面距离的SQL函数<code>sphere_distance</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>CREATE FUNCTION sphere_distance(lon_a FLOAT, lat_a FLOAT, lon_b FLOAT, lat_b FLOAT) RETURNS FLOAT
</span></span><span style="display:flex;"><span>IMMUTABLE LANGUAGE SQL COST 100 AS $$
</span></span><span style="display:flex;"><span>SELECT asin(
</span></span><span style="display:flex;"><span>           sqrt(
</span></span><span style="display:flex;"><span>               sin(0.5 * radians(lat_b - lat_a)) ^ 2 +
</span></span><span style="display:flex;"><span>               sin(0.5 * radians(lon_b - lon_a)) ^ 2 * cos(radians(lat_a)) *
</span></span><span style="display:flex;"><span>               cos(radians(lat_b))
</span></span><span style="display:flex;"><span>           )
</span></span><span style="display:flex;"><span>       ) * 127561999.961088 AS distance;
</span></span><span style="display:flex;"><span>$$;
</span></span></code></pre></div><p>$$
\Delta\sigma=\arccos\bigl(\sin\phi_1\cdot\sin\phi_2+\cos\phi_1\cdot\cos\phi_2\cdot\cos(\Delta\lambda)\bigr).
$$</p>
<p>于是，如果使用以目标点为中心的边长为1公里的正方形来做初筛，这个查询可以写作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">sphere_distance</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">longitude</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">latitude</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">116</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">365798</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">39</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">966956</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pois1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">longitude</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BETWEEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">116</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">365798</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">85</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">116</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">365798</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">85</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">latitude</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BETWEEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">39</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">966956</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">111</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">39</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">966956</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">111</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">category</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">60000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>预热后，实际执行平均耗时35毫秒，相比暴力扫表有了近千倍的性能提高，一个巨大的进步。</p>
<p><img src="/img/blog/pg/knn-explain-l2.png"></p>
<p>对于比较简单粗糙的产品，这种方法已经达到了‘可用’的级别。但这一方法仍然存在许多问题。</p>
<h3 id="存在的问题-1">存在的问题</h3>
<p>这种方法最大的问题在于额外复杂度。它使用了一个（多个）魔数，来确定候选点的大致范围。</p>
<p>而这个魔数的选取，是有赖我们的先验知识的。我们清楚地知道，以繁华的宇宙中心五道口的商铺密度，一公里见方内，商铺个数绝对超过10个了。但对于极端的场景（实际可能很常见），比如在塔克拉玛干大沙漠或者羌塘无人区，最近的商铺，逻辑上是必定存在的，不过其距离可能超过几百公里。</p>
<p>这种方法的性能表现对魔数的选取极其敏感：距离选择的太大，性能会急剧恶化，距离选择的太小，对于乡下偏僻的地方又可能无法返回结果。让程序员头大的事情又多了一个。</p>
<p>用时35毫秒</p>
<p>千倍提升，不错哦，但不能高兴的太早</p>
<p>这么多奇怪的常数又是几个意思？</p>
<p>一千倍的性能提升，让我们来看一下查询执行计划，看看它是怎么做到的。</p>
<p>首先呢，经度上，走了一个索引扫描，生成了一个位图。</p>
<p>然后呢，纬度上，也走了一个索引扫描，又生成了一个位图。</p>
<p>接下来，两个位图做了一个位运算，生成了一个新位图，筛选出了满足经纬度条件的记录。</p>
<p>然后，才去扫描这些满足条件的候选点，计算距离，并排序。</p>
<p>我们这个边界值选的比较巧，所以实际参与距离计算和排序的记录，可能只有三十多条。</p>
<p>比起先前一千多万次的距离计算与排序，显然是要高明的多了。</p>
<h3 id="题外话超参数与额外复杂度">题外话：超参数与额外复杂度</h3>
<p>因为这个边界魔数凑的很好，所以性能比较理想。</p>
<p>这种方法最大的问题在于额外复杂度。它使用了一个（多个）魔数，来确定候选点的大致范围。</p>
<p>而这个魔数的选取，是有赖我们的先验知识的。我们清楚地知道，以繁华的宇宙中心五道口的商铺密度，一公里见方内，商铺个数绝对超过10个了。但对于极端的场景（实际可能很常见），比如在塔克拉玛干大沙漠或者羌塘无人区，最近的商铺，逻辑上是必定存在的，不过其距离可能超过几百公里。</p>
<p>这种方法的性能表现对魔数的选取极其敏感：距离选择的太大，性能会急剧恶化，距离选择的太小，对于乡下偏僻的地方又可能无法返回结果。让程序员头大的事情又多了一个。</p>
<p>让我们先忽略这恼人的问题，看看传统关系型数据库还能不能再压榨压榨。</p>
<h3 id="bad-case">Bad Case</h3>
<p>因为这个边界魔数凑的很好，所以性能比较理想。</p>
<p>这种方法最大的问题在于额外复杂度。它使用了一个（多个）魔数，来确定候选点的大致范围。</p>
<p>而这个魔数的选取，是有赖我们的先验知识的。我们清楚地知道，以繁华的宇宙中心五道口的商铺密度，一公里见方内，商铺个数绝对超过10个了。但对于极端的场景（实际可能很常见），比如在塔克拉玛干大沙漠或者羌塘无人区，最近的商铺，逻辑上是必定存在的，不过其距离可能超过几百公里。</p>
<p>这种方法的性能表现对魔数的选取极其敏感：距离选择的太大，性能会急剧恶化，距离选择的太小，对于乡下偏僻的地方又可能无法返回结果。让程序员头大的事情又多了一个。</p>
<p>让我们先忽略这恼人的问题，看看传统关系型数据库还能不能再压榨压榨。</p>
<table>
<thead>
<tr>
<th style="text-align:center">半径大了性能差</th>
<th style="text-align:center">半径小了圈不着</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><img src="/img/blog/pg/knn-badcase-1.png"></td>
<td style="text-align:center"><img alt="mage-20180321221805" src="/img/blog/pg/knn-badcase-2.png"></td>
</tr>
<tr>
<td style="text-align:center">繁荣的五道口，一公里圈10家小意思。</td>
<td style="text-align:center">300公里外才有一家，新疆人民哭晕在厕所</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="level-3-联合索引与聚簇">LEVEL-3 联合索引与聚簇</h2>
<p>抛开魔数带来的烦恼，我们来研究传统关系型数据库能在解决这个问题上走得有多远。</p>
<p>通过多列索引替换每一列上独自的索引，并将表按该索引聚簇。</p>
<p>仍然是一模一样的查询语句</p>
<p>从30毫秒提升到10毫秒，三倍的性能提升</p>
<p>对于传统关系型数据库，这差不多就是极限了</p>
<p>有没有优雅、正确、快速的解决方案呢？</p>
<p><img alt="mage-20180321221928" src="/img/blog/pg/knn-cluster.png"></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pois4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">longitude</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">latitude</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">category</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CLUSTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pois4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pois4_longitude_latitude_category_idx</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>相应的查询保持不变</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">sphere_distance</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">longitude</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">latitude</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">116</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">365798</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">39</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">966956</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pois4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">longitude</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BETWEEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">116</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">365798</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">85</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">116</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">365798</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">85</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">latitude</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">BETWEEN</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:bold">39</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">966956</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">111</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">39</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">966956</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">111</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">category</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">60000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sphere_distance</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">longitude</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">latitude</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">116</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">365798</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">39</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">966956</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>联合索引查询的执行计划，实际执行时间可以压缩至7毫秒。</p>
<p><img alt="mage-20180321221945" src="/img/blog/pg/knn-l3.png"></p>
<p>这差不多就是传统关系数据模型的极限了，对于大部分业务，这都是一个可以接受水平了。</p>
<p>因为这个边界魔数凑的很好，所以性能比较理想。</p>
<blockquote>
<h3 id="扩展变体geohash">扩展变体：GeoHash</h3>
<p>GeoHash是此类方式的变体，通过将二维经纬度编码为一维字符串，可以使用传统的字符串前缀匹配操作来对地理位置进行过滤。然而固定的粒度使得其灵活度有显著下降，采用联合索引还是特殊编码的冗余字段需要针对具体场景进行分析。</p>
</blockquote>
<p>仍然是一模一样的查询语句</p>
<p>从30毫秒提升到10毫秒，三倍的性能提升</p>
<p>对于传统关系型数据库，这差不多就是极限了</p>
<p>有没有优雅、正确、快速的解决方案呢？</p>
<hr>
<h2 id="level-4-gist">LEVEL-4 GIST</h2>
<p>有没有一种办法，能够优雅，高效，简洁的完成这项工作呢？</p>
<p>PostGIS提出了非常优秀的解决方案，改用Geometry类型，并创建GIST索引。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pois5</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87">CHAR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87">VARCHAR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">position</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">GEOGRAPHY</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Point</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- PostGIS ST_Point
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">category</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- type of POI
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pois5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">GIST</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">position</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pois6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">category</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">60000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">position</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;-&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ST_GeogFromText</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;SRID=4326;POINT(116.365798 39.961576)&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="r树">R树</h3>
<p>R树的核心思想是，聚合<strong>距离相近</strong>的节点，并在树结构的上一层，将其表示为这些节点的<strong>最小外接矩形</strong>，这个最小外接矩形就成为上一层的一个节点。因为所有节点都在它们的最小外接矩形中，所以跟某个矩形不相交的查询就一定跟这个矩形中的所有节点都不相交。</p>
<p><img alt="mage-20180321220143" src="/img/blog/pg/knn-r-tree.png"></p>
<p>实际查询中，该查询能在1.6毫秒完成，这是相当惊人的一个结果了。但要注意，这里<code>position</code>的类型是<code>GEOMETRY</code>，意味着它使用的是二维平面坐标，正确的计算距离需要使用Geography类型。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">position</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;-&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">ST_Point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">116</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">3660</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">39</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">9615</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#000">GEOGRAPHY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pois5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">category</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BETWEEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">50000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">51000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>因为球面距离的计算开销比平面距离要大很多，使用Geography替换Geometry产开销，约4.5ms。</p>
<p>一倍的性能损失相当可观，因此日常应用中需要仔细权衡精确性与性能之间的关系。</p>
<p>通常拓扑类的查询、粗略的圈人都适合用Geometry类型，而精确的计算与判断则必须使用Geography类型。这里，按照距离排序需要精确的距离，因此使用Geography。</p>
<table>
<thead>
<tr>
<th style="text-align:center">Geometry: 1.6 ms</th>
<th style="text-align:center">Geography: 3.4 ms</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><img src="/img/blog/pg/knn-explain-l4-geom.png"></td>
<td style="text-align:center"><img alt="mage-20180321222024" src="/img/blog/pg/knn-l4-geog.png"></td>
</tr>
</tbody>
</table>
<p>现在，我们来看看PostGIS交出的答卷。</p>
<p>PostGIS，使用了不一样的数据类型、索引、与查询方法。</p>
<p>首先，这里数据类型不再是两个浮点数，而变成一个Geography字段。里面存就是一对经纬度坐标。</p>
<p>然后，我们使用的索引，也不再是常见的Btree索引，而是GIST索引。</p>
<p>Generalized Search Tree. 通用搜索树，平衡树结构。对于空间几何类型而言，实现通常使用的是R树。</p>
<p>通常拓扑类的查询、粗略的圈人都适合用Geometry类型，而精确的计算与判断则必须使用Geography类型。这里，按照距离排序需要精确的距离，因此使用Geography。</p>
<blockquote>
<h3 id="题外话geometry还是geography">题外话：Geometry还是Geography？</h3>
<p>因为球面距离的计算开销比平面距离要大很多，使用Geography替换Geometry产开销</p>
<p>拓扑关系，粗略估计使用Geometry，精确计算使用Geography</p>
<p>计算开销约为一倍，需要仔细权衡正确性/精确性与性能之间的关系。</p>
</blockquote>
<p>现在，我们来看看PostGIS交出的答卷。</p>
<p>PostGIS，使用了不一样的数据类型、索引、与查询方法。</p>
<p>首先，这里数据类型不再是两个浮点数，而变成一个Geography字段。里面存就是一对经纬度坐标。</p>
<p>然后，我们使用的索引，也不再是常见的Btree索引，而是GIST索引。</p>
<p>Generalized Search Tree. 通用搜索树，平衡树结构。对于空间几何类型而言，实现通常使用的是R树。</p>
<p>通常拓扑类的查询、粗略的圈人都适合用Geometry类型，而精确的计算与判断则必须使用Geography类型。这里，按照距离排序需要精确的距离，因此使用Geography。</p>
<hr>
<h2 id="level-5-btree_gist">LEVEL-5 btree_gist</h2>
<p>还能更进一步否？</p>
<p>观察Leve-4中的执行计划，我们发现category上的条件并没有用到索引。</p>
<p>可不可以像Level-3中的优化方式一样，创建一个 position 与 category 的联合索引呢？</p>
<p>不幸的是，B树与R树是两种完全不同的数据结构，甚至连使用方式都不一样</p>
<p>于是我们有这样一个想法，能不能把category当成 position的第三维坐标，让R树直接在三维空间里面进行索引呢？</p>
<p>这个思路是正确的， 但是完全不需要这么麻烦</p>
<p>GIST索引的一个问题在于，它的工作原理与B树不同，无法在不支持GIST索引方法的数据类型上创建GIST索引。</p>
<p>通常，几何类型，范围（range）类型支持GIST索引，但字符串，数值类型等都不支持GIST。这就导致了无法创建形如<code>GIST(position, category)</code>的多列索引。</p>
<p>PostgreSQL内置的<code>btree_gist</code>扩展解决了这一问题。</p>
<p>PostgreSQL内置的扩展 btree_gist，允许创建常规类型与几何类型的联合索引。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree_gist</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pois6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">GIST</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">position</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">category</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CLUSTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VERBOSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pois6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_pois6_position_category_gist</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>同样的查询，可以简写为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">position</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;-&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ST_Point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lon</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lat</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">GEOGRAPHY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">distance</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pois6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">category</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">60000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:center">Geometry: 0.85ms / Geography: 1.2ms</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><img src="/img/blog/pg/knn-explain-l5.png"></td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>CREATE OR REPLACE FUNCTION get_random_nearby_store() RETURNS TEXT
</span></span><span style="display:flex;"><span>AS $$
</span></span><span style="display:flex;"><span>DECLARE
</span></span><span style="display:flex;"><span>  lon FLOAT := 110 + (random() - 0.5) * 10;
</span></span><span style="display:flex;"><span>  lat FLOAT := 30 + (random() - 0.5) * 10;
</span></span><span style="display:flex;"><span>BEGIN
</span></span><span style="display:flex;"><span>  RETURN (
</span></span><span style="display:flex;"><span>    SELECT jsonb_pretty(jsonb_build_object(&#39;list&#39;, a.list, &#39;lon&#39;, lon, &#39;lat&#39;, lat)) :: TEXT
</span></span><span style="display:flex;"><span>    FROM (
</span></span><span style="display:flex;"><span>           SELECT json_agg(row_to_json(top10)) AS list
</span></span><span style="display:flex;"><span>           FROM (
</span></span><span style="display:flex;"><span>             SELECT id, name, position &lt;-&gt; ST_Point(lon, lat) :: GEOGRAPHY AS distance
</span></span><span style="display:flex;"><span>             FROM pois6 WHERE category = 60000 ORDER BY 3 LIMIT 10 ) top10
</span></span><span style="display:flex;"><span>         ) a);
</span></span><span style="display:flex;"><span>END;
</span></span><span style="display:flex;"><span>$$ LANGUAGE PlPgSQL;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">http</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">http.server</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">psycopg2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">GetHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">server</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">BaseHTTPRequestHandler</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">psycopg2</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">connect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;postgres://localhost:5432/geo&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">do_GET</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">send_response</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">HTTPStatus</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">OK</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">send_header</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Content-type&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;application/json&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#000">GetHandler</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">conn</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cursor</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">cursor</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">cursor</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">execute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;SELECT get_random_nearby_store() as res;&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cursor</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">fetchone</span><span style="color:#000;font-weight:bold">()[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">wfile</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;utf-8&#39;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">with</span> <span style="color:#000">http</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">server</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">HTTPServer</span><span style="color:#000;font-weight:bold">((</span><span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3001</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">GetHandler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">httpd</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">httpd</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">serve_forever</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><hr>
<h2 id="案例小结">案例小结</h2>
<table>
<thead>
<tr>
<th style="text-align:center">Level</th>
<th style="text-align:center">方法</th>
<th style="text-align:center">性能/耗时(ms)</th>
<th style="text-align:center">可维护性/可靠性</th>
<th style="text-align:center">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">暴力扫表</td>
<td style="text-align:center">30,000</td>
<td style="text-align:center">-</td>
<td style="text-align:center">形式简单</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">经纬索引</td>
<td style="text-align:center">35</td>
<td style="text-align:center">复杂度/魔数问题</td>
<td style="text-align:center">额外复杂度</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">联合索引</td>
<td style="text-align:center">10</td>
<td style="text-align:center">复杂度/魔数问题</td>
<td style="text-align:center">额外复杂度</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">GIST</td>
<td style="text-align:center">4</td>
<td style="text-align:center">最简表达，完全精确</td>
<td style="text-align:center">形式简单，距离更精确，PostgreSQL限定</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center"><code>btree_gist</code>联合索引</td>
<td style="text-align:center">1</td>
<td style="text-align:center">最简表达，完全精确</td>
<td style="text-align:center">形式简单，距离更精确，PostgreSQL限定</td>
</tr>
</tbody>
</table>
<p>那么好的，经过这么漫长的旅途，通过PostGIS与PostgreSQL，将原本需要3万毫秒的查询加速至1毫秒，三万倍的提升。相比传统关系型数据库，除了超过十倍以上的性能提升，还有很多优点：</p>
<p>SQL的形式非常简单，就是暴力扫表的SQL，不需要奇奇怪怪的额外复杂度。而且计算距离使用的是更精确的WGS84椭球球面距离。</p>
<p>那么从这个例子中我们可以得出什么结论呢？ PostGIS的性能表现是非常优秀的，那么它在实际生产环境里的表现又如何呢？</p>
<p>我们把这里的position，从餐厅的位置换为用户的位置，把poi的种类范围，换成候选人的年龄范围。这就是探探匹配功能所面临的场景。</p>
<h3 id="实际场景中的表现">实际场景中的表现</h3>
<p>性能很重要。天下武功，唯快不破。</p>
<p>目前数据库总共用了220台机器，业务QPS近10万。数据库TPS峰值的时候差不多接近250W。其中核心数据库是1主19从的配置。</p>
<p>我厂对于数据库的SLA是：99.99%的普通数据库请求需要在1毫秒内完成，而单个数据库节点的QPS峰值在3万上下。这两者之间其实有着紧密的联系，如果一个请求能在1毫秒内完成，那么对于单个线程而言，每秒钟就可以处理1000个请求。我们使用的数据库物理机CPU为24核48线程，不过超线程的机器CPU利用率在60%~70%左右。可以近似折算为30个可用核。那么，所有核能够承载的QPS量就是30*1000=30000。以极限水位80% CPU算，QPS上限在38k 左右，也与现实压测结果吻合。</p>
<blockquote>
<p>整理自本人在2018象形中国北京PostGIS专场所做分享，转载请保留出处。</p>
</blockquote>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-e5e998a993afb8408dd753d1b977cbd7">PostGIS高效解决行政区划归属查询</h1>
	<div class="lead">如何高效解决典型地理逆编码问题：根据用户的经纬度坐标，定位用户的行政区划。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-06-06" class="text-muted">2018年06月06日</time>
        
	</div>
	<blockquote>
<p><a href="https://mp.weixin.qq.com/s/5d681qolNZpqj5ZuHUGBow">微信公众号原文</a></p>
</blockquote>
<p>在应用开发中，很多时候我们需要解决这样一个问题：<strong>根据用户的经纬度坐标，定位用户的行政区划。</strong></p>
<p>我们收集到的是诸如<code>28°00'00&quot;N 100°00'00.000&quot;E</code>这样的经纬度坐标，但实际感兴趣的是这个点所属的行政区划：（中华人民共和国，云南省，迪庆藏族自治州，香格里拉市）。这种将地理坐标映射到某条记录的操作就称为<strong>地理编码（GeoEncode）</strong>。高效实现地理编码是一个很有趣的问题。</p>
<p>本文介绍了该问题的解决与优化方案：能在确保正确性的前提下，能用几兆的空间，110μs的执行时间完成一次地理编码。</p>
<hr>
<h2 id="0x01-正确至上">0x01 正确至上</h2>
<p>正确性是第一位的。我们不希望出现用户明明身处A地，却被划分到B地的尴尬情况。然而一个尴尬的现实是，很多地理编码服务的实现粗糙到令人无法直视，Vornoi方法就是一个典型的例子。</p>
<p>假设我们有一系列的坐标点，那么这些坐标点之间两两连线的中垂线就对整个坐标平面做了一个Vornoi划分。每一个细胞的中心点就是细胞核，而元胞内的任意一点到该细胞核的距离是最近的（与其他细胞核相比）。</p>
<p>当我们没有行政区划的边界数据，但有行政区划中心点的数据时，这也是一种能凑合管用办法。找到距离用户最近的某级行政区域中心，然后认为用户就位于该行政区域中心。这个功能实现起来非常简单。</p>
<p>不过，这种方法对于边界情况的处理很差：</p>
<p><strong>最近邻搜索—Vornoi方法</strong></p>
<p><img alt="vornoi" src="/img/blog/pg/adcode-vornoi.png"></p>
<p>现实总是与理想情况相距甚远。也许对于国内而言，这种错误影响也许并不大。但涉及到国际主权边界时，这种粗糙的实现很可能会给自己带来不必要的麻烦：</p>
<p><img src="/img/blog/pg/adcode-south-china-seas.png"></p>
<p>还有一种思路，和编程中的“查表法”类似，预先计算好所有经纬度到行政区划的映射，使用时只要用经纬度坐标查表就好了。当然无论经度还是维度，都是一个连续的标量，理论上精度必然是有限的。</p>
<p>GeoHash就是这样一种方案：它将经度与维度交叉编码为单一字符串，字符串越长精度越高，每一个字符串都对应一个经纬度围成的“矩形”，只要精度足够，理论上是可以这么做的。当然，这种方案难以做到真正意义上的正确，存储开销也极为浪费。好处是实现很简单。只要有数据，一个KV服务就可以轻松搞定。</p>
<p><img alt="geohash" src="/img/blog/pg/adcode-geohash.png"></p>
<p>相比之下，基于地理边界多边形的解决方案在保证绝对正确的前提下，能在一毫秒内完成这种地理编码功能，而且可能只需要几兆的空间。唯一的难点可能在于如何获取数据上。</p>
<hr>
<h2 id="0x02-数据为王">0x02 数据为王</h2>
<p>地理编码属于典型的数据密集型应用，数据的质量直接决定了最终服务的效果。要想真正做好服务，优质数据必不可少。好在行政区划与地理边界数据也不算什么保密信息，有一些地方提供了公开获取的方式：</p>
<p>民政部信息查询平台与高德地图两者都提供了精确到县级区划的地理边界数据：</p>
<ul>
<li>
<p><a href="http://lbs.amap.com/api/webservice/guide/api/district">高德地图行政区域查询API</a></p>
<p>高德的数据更新更及时，形式简单，边界精度较高（点数多），但不够权威，有不少<strong>错漏之处</strong>。</p>
<p><img alt="geohash" src="/img/blog/pg/adcode-gaode-q.png"></p>
</li>
<li>
<p><a href="http://xzqh.mca.gov.cn/map">民政部全国行政区划信息查询平台</a></p>
<p>民政部平台数据相对更加权威，而且采用的是拓扑编码，严格避免了边界重叠的问题，使用无偏的WGS84坐标，但边界精度较低（点数目较少）。</p>
</li>
</ul>
<p><img alt="geohash" src="/img/blog/pg/adcode-mca-q.png"></p>
<p>除了地理围栏数据之外，另一份重要的数据是行政区划代码数据。国家统计局使用的12位城乡统计用行政区划代码编制还是很科学的，具有层次包含关系，尤其适合作为行政区划的唯一标示。但问题是稍显过时，最新的版本是2016年8月发布的，2018年7月后可能会发布一份更新的数据。</p>
<blockquote>
<p>笔者整理了一份连接国际统计局行政区划与高德区划边界的数据：https://github.com/Vonng/adcode</p>
<p>民政部的数据可以直接在该网站中打开浏览器的调试工具，从接口返回数据中直接获取。</p>
</blockquote>
<hr>
<h2 id="0x03-牛刀小试">0x03 牛刀小试</h2>
<p>假设我们已经有一张表了，全国行政区划与地理围栏表：<code>adcode_fences</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">adcode_fences</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">code</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">parent</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">level</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">rank</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">adcode</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">post_code</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">area_code</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">ur_code</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">municipality</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">boolean</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">virtual</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87">boolean</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">dummy</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87">boolean</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">longitude</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">double</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">precision</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">latitude</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000">double</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">precision</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">center</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">geometry</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">province</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">city</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">county</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">town</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">village</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">fence</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">geometry</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><img alt="geohash" src="../img/adcode-data-sample.png"></p>
<h4 id="索引">索引</h4>
<p>为了高效执行空间查询，首先需要在表示地理边界的<code>fence</code>列上创建GIST索引。</p>
<p>中国县级行政区划的记录数据并不多（约3000条），但使用索引仍然能带来几十倍的性能提升。因为这个优化太基础太Trivial了，就不单独拎出来说了。（一百多毫秒到几毫秒）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">adcode_fences</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">GIST</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fence</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h4 id="查询">查询</h4>
<p>PostGIS提供了<code>ST_Contains</code>与<code>ST_Within</code>两个函数，用于判断多边形与点之间的包含关系，例如以下SQL就会找出表中所有包含该点<code>(116,40)</code>的行政区划：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">code</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">adcode_fences</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ST_Contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fence</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ST_Point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">116</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">40</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rank</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>结果是：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>100000000000	中华人民共和国
</span></span><span style="display:flex;"><span>110000000000	北京市
</span></span><span style="display:flex;"><span>110100000000	市辖区
</span></span><span style="display:flex;"><span>110109000000	门头沟区
</span></span></code></pre></div><p>再比如<code>(100,28)</code>的坐标点：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">json_object_agg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">level</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">adcode_fences</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ST_Contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fence</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ST_Point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">28</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;country&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;中华人民共和国&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;city&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;迪庆藏族自治州&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;county&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;香格里拉市&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;province&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;云南省&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>相当不可思议，数据就位之后，借力于PostgreSQL与PostGIS，实现这一功能所需的代码少的惊人：一行SQL。</p>
<p>在笔者的笔记本上，该查询执行用时6毫秒。6ms的平均查询时间，换算为48核机器上的QPS差不多就是6400。在我们以前的生产环境代码中基本上就是这么做的，但因为还有其他国家的数据，以及单核主频没有我的机器高，因此一次查询的平均执行时间可能在12毫秒左右。</p>
<p>看上去几毫秒似乎已经很快了，但还是没有达到我们生产环境的性能要求（1毫秒）。对于真实世界的生产业务而言，性能很重要，十倍的性能提升意味着省十倍的机器。还能不能再给力点？实际上通过简单的优化就可以达到百倍的性能提升。</p>
<hr>
<h2 id="0x04-性能优化">0x04 性能优化</h2>
<h4 id="针对数据特性优化">针对数据特性优化</h4>
<p>导致上述查询慢的一个重要原因是不必要的相交判断。行政区划是有层级关系的，如果一个用户位于县级行政区划中，那么他一定位于该县级区划所处的省级区划中。因此，知道了最低级的行政区划，其高级区划归属已经自然而然地确定了；那么与省界，国界做相交判断就是没有必要的。	实际上这可能是效果最明显的优化，单是中国地理边界与点做相交判断可能就需要几毫秒。</p>
<h4 id="区域切分">区域切分</h4>
<p>R树索引的原理，能为我们带来优化的启发。R树是基于**AABB（Axis Aligned Bounding Box）**的索引。因此越是饱满的凸多边形，索引的效果就越好。而对于拥有遥远飞地的行政区划，效果则可能恶化的很厉害。因此，将区域切分为均匀饱满的小块，能有效提高查询的性能。</p>
<pre><code>最基本的优化，就是将所有的`ST_MultiPolygon`拆分为`ST_Polygon`，并指向同一个行政区划。更进一步，可以将长得比较畸形的行政区划切分为形状饱满的小块（典型的比如甘肃这种）。当然，这样的代价就是让所有行政区划与地理围栏从一对一变成了一对多的关系。需要拆出一张单独的表。
</code></pre>
<p>实际操作中，如果已经有了县级行政区划的数据，通常只要将带有飞地的MultiPolygon拆为单独的几个Polygon，就已经能有很好的表现了。而县一级的行政区划通常边界也比较饱满，进一步拆分效果相当有限。</p>
<h4 id="精确度">精确度</h4>
<p>正确性是第一位的，然而有的时候我们宁愿牺牲一些准确性，换来性能的大幅提升。例如高德与民政部的数据对比，显然民政部要粗糙的多，但对于糙猛快的互联网场景，低精度的数据反而可能是更合适的。</p>
<table>
<thead>
<tr>
<th style="text-align:center">高德</th>
<th style="text-align:center">民政部</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><img alt="geohash" src="/img/blog/pg//adcode-gaode-hk.png"></td>
<td style="text-align:center"><img alt="geohash" src="/img/blog/pg//adcode-mca-hk.png"></td>
</tr>
</tbody>
</table>
<p>高德的全国行政区划数据约100M左右，而民政部的数据约为10M（以原始拓扑数据表示则为4M）。但实际使用中效果差别不大，因此推荐使用民政部的数据。</p>
<h4 id="主键设计">主键设计</h4>
<p>行政区划有内在的层次关系，国家包含省，省包含城市，城市包含区县，区县包含乡镇，乡镇包含村庄街道。我国的<a href="https://vonng.com/blog/admin-division/">行政区划代码</a>就很好的体现了这种层次关系，十二位的城乡区划代码包含了很丰富的信息：</p>
<ul>
<li>第1～2位，为省级代码；</li>
<li>第3～4 位，为地级代码；</li>
<li>第5～6位，为县级代码；</li>
<li>第7～9位，为乡级代码；</li>
<li>第10～12位，为村级代码。</li>
</ul>
<p>因此这种12位的行政区划代码是很适合作为行政区划表的主键的。此外，当需要国际化支持时，这套区划代码体系还可以通过在前面添加国家代码来扩展（相应地中国行政区划对应地就是高位国家代码为0的特殊情况）。</p>
<p>另一方面，地理围栏表与行政区划表由一对一变为多对一，那么地理围栏表就不再适合用行政区划代码作为主键了。可能自增列是一个更合适的选择。</p>
<h4 id="规范化与反规范化">规范化与反规范化</h4>
<p>数据模型设计的一个重要权衡就是规范化与反规范化。将地理围栏表从行政区划表中拆出来是一种规范化，而反规范化也可以用于优化：既然行政区划存在层次关系，那么在子行政区划中保留所有的祖先行政区划信息（或仅仅是代码与名称）是很合理的反规范化操作。这样，通过区划代码主键一次查询就可以取出所有的层次信息。</p>
<h4 id="回溯支持">回溯支持</h4>
<p>有时候我们想回溯到历史上某个特定时刻，查询该时刻的行政区划状态。</p>
<p>举个例子，行政区划变更并不会影响该区划内现有公民的身份证号码，只会影响新出生公民的身份证号。因此有时候用公民身份证号前6位去查现在的行政区划表可能一无所获，需要回溯到该公民出生的历史时间才能查询到正确的结果。可以参考PostgreSQL MVCC的实现方式，为行政区划表添加一对PostgreSQL提供的<code>tstzrange</code>类型字段，标识行政区划记录版本的有效时间段，并在查询时指明时间点作为筛选条件。PostgreSQL可以支持在范围类型与空间类型上建立联合GIST索引，提供高效查询支持。</p>
<p>不过，时序数据获取难度是很大的。而且一般这个需求也并不常见。所以这里就不展开了。</p>
<hr>
<h2 id="0x05-设计实现">0x05 设计实现</h2>
<p>既然已经将地理编码的功能从区划代码表拆分出来，本题对<code>adcode</code>中的结构就不甚关注了。我们只需要知道凭借<code>code</code>字段能从该表中快速查出我们感兴趣的东西，比如一连串的行政区划层次，行政区划的人口，面积，等级，行政中心等等。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">adcode</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">code</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">bigint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">parent</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87">bigint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">references</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">adcode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">code</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">rank</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">path</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">[],</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">……</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">other</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">attrs</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>相比之下，<code>fences</code>表才是我们需要关注的对象，因为这是性能损耗的关键路径。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fences</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">BIGSERIAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">fence</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">geometry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">POLYGON</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">code</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">BIGINT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fences</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">GiST</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fence</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fences</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Btree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">code</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CLUSTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fences</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fences_fence_idx</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>不使用行政区划代码<code>code</code>作为主键，给予了我们更多的灵活性与优化空间。任何时候需要修正地理编码的逻辑时，只修改<code>fences</code>中的数据即可。你甚至可以添加冗余字段与条件索引，将不同来源的数据，不同等级的行政区划，相互重叠的地理围栏放在同一张表中，灵活地执行自定义的编码逻辑。</p>
<p>说句题外话：如果您能确保自己的数据不会重叠，则可以考虑使用PostgreSQL提供的Exclude约束确保数据完整性：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fences</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">BIGSERIAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">fence</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">geometry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">POLYGON</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">code</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">EXCLUDE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fence</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic">-- no need to create gist index for fence anymore
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h4 id="性能测试">性能测试</h4>
<p>那么优化完之后的性能表现又如何？让我们随机生成一些坐标点，检验一下性能。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#a40000">\</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">x</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">random</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">75</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">125</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">\</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">y</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">random</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">code</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fences2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ST_Contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fence</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">ST_Point</span><span style="color:#000;font-weight:bold">(:</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,:</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在笔者的机器上，现在一次查询只要0.1ms了，单进程9k TPS，折算为48核机器约为350kTPS</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pgbench adcode -T <span style="color:#0000cf;font-weight:bold">5</span> -f run.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>number of clients: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>number of threads: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>duration: <span style="color:#0000cf;font-weight:bold">5</span> s
</span></span><span style="display:flex;"><span>number of transactions actually processed: <span style="color:#0000cf;font-weight:bold">45710</span>
</span></span><span style="display:flex;"><span>latency <span style="color:#000">average</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0.109 ms
</span></span><span style="display:flex;"><span><span style="color:#000">tps</span> <span style="color:#ce5c00;font-weight:bold">=</span> 9135.632484 <span style="color:#ce5c00;font-weight:bold">(</span>including connections establishing<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">tps</span> <span style="color:#ce5c00;font-weight:bold">=</span> 9143.947723 <span style="color:#ce5c00;font-weight:bold">(</span>excluding connections establishing<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>当然拿到<code>code</code>之后还是需要去行政区划表里查一次，但一次索引扫描的开销是很小的。</p>
<p>总的来说，与优化之前的实现相比，性能提升了60倍。落实在生产环境中，可能就意味着省了百来万的成本。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-659c08c6c874927030074eb057103d46">Distinct On 去除重复数据</h1>
	<div class="lead">使用Distinct On扩展字句快速找出分组内具有最大最小值的记录</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-04-06" class="text-muted">2018年04月06日</time>
        
	</div>
	<p>Distinct On是PostgreSQL提供的特有语法，可以高效解决一些典型查询问题，例如，快速找出分组内具有最大最小值的记录。</p>
<h2 id="前言">前言</h2>
<p>找出分组内具有最大最小值的记录，这是一个非常常见的需求。用传统SQL当然有办法解决，但是都不够优雅，PostgreSQL的SQL扩展语法Distinct ON能一步到位解决这一类问题。</p>
<h2 id="distinct-on-语法">DISTINCT ON 语法</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DISTINCT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">expression</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">expression</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...])</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">select_list</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Here <em>expression</em> is an arbitrary value expression that is evaluated for all rows. A set of rows for which all the expressions are equal are considered duplicates, and only the first row of the set is kept in the output. Note that the “first row” of a set is unpredictable unless the query is sorted on enough columns to guarantee a unique ordering of the rows arriving at the <code>DISTINCT</code> filter. (<code>DISTINCT ON</code> processing occurs after <code>ORDER BY</code> sorting.)</p>
<h2 id="distinct-on应用案例">Distinct On应用案例</h2>
<p>例如，找出每台机器的最新日志在日志表中，取出按照机器node_id分组，时间戳<code>ts</code>最大的的日志记录。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">node_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TIMESTAMP</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_data</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">random</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">generate_series</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;2019-01-01&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87;font-weight:bold">TIMESTAMP</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;2019-05-01&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87;font-weight:bold">TIMESTAMP</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;1h&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">INTERVAL</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这里可以制造一些随机数据</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>5	2019-01-01 00:00:00.000000
</span></span><span style="display:flex;"><span>0	2019-01-01 01:00:00.000000
</span></span><span style="display:flex;"><span>9	2019-01-01 02:00:00.000000
</span></span><span style="display:flex;"><span>1	2019-01-01 03:00:00.000000
</span></span><span style="display:flex;"><span>7	2019-01-01 04:00:00.000000
</span></span><span style="display:flex;"><span>2	2019-01-01 05:00:00.000000
</span></span><span style="display:flex;"><span>8	2019-01-01 06:00:00.000000
</span></span><span style="display:flex;"><span>3	2019-01-01 07:00:00.000000
</span></span><span style="display:flex;"><span>1	2019-01-01 08:00:00.000000
</span></span><span style="display:flex;"><span>4	2019-01-01 09:00:00.000000
</span></span><span style="display:flex;"><span>9	2019-01-01 10:00:00.000000
</span></span><span style="display:flex;"><span>0	2019-01-01 11:00:00.000000
</span></span><span style="display:flex;"><span>3	2019-01-01 12:00:00.000000
</span></span><span style="display:flex;"><span>6	2019-01-01 13:00:00.000000
</span></span><span style="display:flex;"><span>9	2019-01-01 14:00:00.000000
</span></span><span style="display:flex;"><span>1	2019-01-01 15:00:00.000000
</span></span><span style="display:flex;"><span>7	2019-01-01 16:00:00.000000
</span></span><span style="display:flex;"><span>8	2019-01-01 17:00:00.000000
</span></span><span style="display:flex;"><span>9	2019-01-01 18:00:00.000000
</span></span><span style="display:flex;"><span>10	2019-01-01 19:00:00.000000
</span></span><span style="display:flex;"><span>5	2019-01-01 20:00:00.000000
</span></span><span style="display:flex;"><span>4	2019-01-01 21:00:00.000000
</span></span></code></pre></div><p>现在使用DistinctON，这里Distinct On后面的括号里代表了记录需要按哪一个键进行除重，在括号内的表达式列表上有着相同取值的记录会只保留一条记录。（当然保留哪一条是随机的，因为分组内哪一条记录先返回是不确定的）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DISTINCT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">node_id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_data</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">21</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>DistinctON有一个配套的ORDER BY子句，用于指明分组内哪一条记录将被保留，排序第一条记录会留下，因此如果我们想要每台机器上的最新日志，可以这样写。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DISTINCT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">node_id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NULLS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LAST</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">21</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#0000cf;font-weight:bold">2019</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">04</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="使用索引加速distinct-on查询">使用索引加速Distinct On查询</h2>
<p>Distinct On查询当然可以被索引加速，例如以下索引就可以让上面的查询用上索引</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">node_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NULLS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LAST</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">enable_seqscan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">off</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">explain</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DISTINCT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">node_id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NULLS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LAST</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">Unique</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">28</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">170</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">43</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Only</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_data_node_id_ts_idx</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_data</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">28</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">163</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">23</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2881</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>注意，排序的时候一定要确保NULLS FIRST|LAST与查询时实际使用的规则匹配。否则可能用不上索引。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-a16ee378342d35474dbed535e852f3ea">函数易变性等级分类</h1>
	<div class="lead">PgSQL中的函数默认有三种易变性等级，合理使用可以显著改善性能。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-04-06" class="text-muted">2018年04月06日</time>
        
	</div>
	<p>PgSQL中的函数默认有三种易变性等级，合理使用可以显著改善性能。</p>
<h2 id="核心种差">核心种差</h2>
<ul>
<li><code>VOLATILE</code> : 有副作用，不可被优化。</li>
<li><code>STABLE</code>： 执行了数据库查询。</li>
<li><code>IMMUTABLE </code>: 纯函数，执行结果可能会在规划时被预求值并缓存。</li>
</ul>
<h2 id="什么时候用">什么时候用？</h2>
<ul>
<li><code>VOLATILE</code> : 有任何写入，有任何副作用，需要看到外部命令所做的变更，或者调用了任何<code>VOLATILE</code>的函数</li>
<li><code>STABLE</code>： 有数据库查询，但没有写入，或者函数的结果依赖于配置参数（例如时区）</li>
<li><code>IMMUTABLE </code>: 纯函数。</li>
</ul>
<h2 id="具体解释">具体解释</h2>
<p>每个函数都带有一个<strong>易变性（Volatility）</strong> 等级。可能的取值包括 <code>VOLATILE</code>、<code>STABLE</code>，以及<code>IMMUTABLE</code>。创建函数时如果没有指定易变性等级，则默认为 <code>VOLATILE</code>。易变性是函数对优化器的承诺：</p>
<ul>
<li><code>VOLATILE</code>函数可以做任何事情，包括修改数据库状态。在连续调用时即使使用相同的参数，也可能会返回不同的结果。优化器不会优化掉此类函数，每次调用都会重新求值。</li>
<li><code>STABLE</code>函数不能修改数据库状态，且在<strong>单条语句</strong>中保证给定同样的参数一定能返回同样的结果，因而优化器可以将相同参数的多次调用优化成一次调用。在索引扫描条件中允许使用<code>STABLE</code>函数，但<code>VOLATILE</code>函数就不行。（一次索引扫描中只会对参与比较的值求值一次，而不是每行求值一次，因而在一个索引扫描条件中不能使用 <code>VOLATILE</code>函数）。</li>
<li><code>IMMUTABLE</code>函数不能修改数据库状态，并且保证任何时候给定输入永远返回相同的结果。这种分类允许优化器在一个查询用常量参数调用该函数 时提前计算该函数。例如，一个 <code>SELECT ... WHERE x = 2 + 2</code>这样的查询可以被简化为<code>SELECT ... WHERE x = 4</code>，因为整数加法操作符底层的函数被 标记为<code>IMMUTABLE</code>。</li>
</ul>
<h2 id="stable与immutable的区别">STABLE与IMMUTABLE的区别</h2>
<h3 id="调用次数优化">调用次数优化</h3>
<p>以下面这个函数为例，它只是简单的返回常数2</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">return2</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">RAISE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NOTICE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;INVOKED&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLPGSQL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">STABLE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>当使用<code>STABLE</code>标签时，它会真的调用10次，而当使用<code>IMMUTABLE</code>标签时，它会被优化为一次调用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>vonng=# select return2() from generate_series(1,10);
</span></span><span style="display:flex;"><span>NOTICE:  INVOKED
</span></span><span style="display:flex;"><span>NOTICE:  INVOKED
</span></span><span style="display:flex;"><span>NOTICE:  INVOKED
</span></span><span style="display:flex;"><span>NOTICE:  INVOKED
</span></span><span style="display:flex;"><span>NOTICE:  INVOKED
</span></span><span style="display:flex;"><span>NOTICE:  INVOKED
</span></span><span style="display:flex;"><span>NOTICE:  INVOKED
</span></span><span style="display:flex;"><span>NOTICE:  INVOKED
</span></span><span style="display:flex;"><span>NOTICE:  INVOKED
</span></span><span style="display:flex;"><span>NOTICE:  INVOKED
</span></span><span style="display:flex;"><span> return2
</span></span><span style="display:flex;"><span>---------
</span></span><span style="display:flex;"><span>       2
</span></span><span style="display:flex;"><span>       2
</span></span><span style="display:flex;"><span>       2
</span></span><span style="display:flex;"><span>       2
</span></span><span style="display:flex;"><span>       2
</span></span><span style="display:flex;"><span>       2
</span></span><span style="display:flex;"><span>       2
</span></span><span style="display:flex;"><span>       2
</span></span><span style="display:flex;"><span>       2
</span></span><span style="display:flex;"><span>       2
</span></span><span style="display:flex;"><span>(10 rows)
</span></span></code></pre></div><p>这里将函数的标签改为<code>IMMUTABLE</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">return2</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">RAISE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NOTICE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;INVOKED&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLPGSQL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IMMUTABLE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>再执行同样的查询，这次函数只被调用了一次</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">return2</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">generate_series</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">NOTICE</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">INVOKED</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">return2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="执行计划缓存">执行计划缓存</h3>
<p>第二个例子是有关索引条件中的函数调用，假设我们有这么一张表，包含从1到1000的整数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">generate_series</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>现在创建一个<code>IMMUTABLE</code>的函数<code>mymax</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mymax</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;plpgsql&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IMMUTABLE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>我们会发现，当我们在索引条件中直接使用该函数时，执行计划中的索引条件被直接求值缓存并固化为了<code>id=2</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mymax</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Only</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">28</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>而如果将其改为<code>STABLE</code>函数，则结果变为运行时求值：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">vonng</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mymax</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Only</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">53</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">54</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mymax</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-a586e1f27bf6289d48a1f51adcf91003">用 Exclude 实现互斥约束</h1>
	<div class="lead">Exclude约束是一个PostgreSQL扩展，它可以实现一些更高级，更巧妙的的数据库约束。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-04-06" class="text-muted">2018年04月06日</time>
        
	</div>
	<p>Exclude约束是一个PostgreSQL扩展，它可以实现一些更高级，更巧妙的的数据库约束。</p>
<hr>
<h2 id="前言">前言</h2>
<p>数据完整性是极其重要的，但由应用保证的数据完整性并不总是那么靠谱：人会犯傻，程序会出错。如果能通过数据库约束来强制数据完整性那是再好不过了：后端程序员不用再担心竞态条件导致的微妙错误，数据分析师也可以对数据质量充满信心，不需要验证与清洗。</p>
<p>关系型数据库通常会提供<code>PRIMARY KEY</code>, <code>FOREIGN KEY</code>, <code>UNIQUE</code>, <code>CHECK</code>约束，然而并不是所有的业务约束都可以用这几种约束表达。一些约束会稍微复杂一些，例如确保IP网段表中的IP范围不发生重叠，确保同一个会议室不会出现预定时间重叠，确保地理区划表中各个城市的边界不会重叠。传统上要实现这种保证是相当困难的：譬如<code>UNIQUE</code>约束就无法表达这种语义，<code>CHECK</code>与存储过程或者触发器虽然可以实现这种检查，但也相当tricky。PostgreSQL提供的<code>EXCLUDE</code>约束可以优雅地解决这一类问题。</p>
<hr>
<h2 id="eclude约束的语法">Eclude约束的语法</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXCLUDE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_method</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">exclude_element</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_parameters</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">predicate</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">exclude_element</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">an</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXCLUDE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">constraint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">is</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">column_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">expression</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">opclass</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ASC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NULLS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FIRST</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LAST</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><code>EXCLUDE</code>子句定一个排除约束，它保证如果任意两行在指定列或表达式上使用指定操作符进行比较，不是所有的比较都将会返回<code>TRUE</code>。如果所有指定的操作符都测试相等，这就等价于一个<code>UNIQUE</code>约束，尽管一个普通的唯一约束将更快。不过，排除约束能够指定比简单相等更通用的约束。例如，你可以使用<code>&amp;&amp;</code>操作符指定一个约束，要求表中没有两行包含相互覆盖的圆（见 <a href="http://www.postgres.cn/docs/11/datatype-geometric.html">Section 8.8</a>）。</p>
<p>排除约束使用一个索引实现，这样每一个指定的操作符必须与用于索引访问方法<em>index_method</em>的一个适当的操作符类（见<a href="http://www.postgres.cn/docs/11/indexes-opclass.html">Section 11.9</a>）相关联。操作符被要求是交换的。每一个<em>exclude_element</em>可以选择性地指定一个操作符类或者顺序选项，这些在<a href="http://www.postgres.cn/docs/11/SQL-CREATETABLE.html">???</a>中有完整描述。</p>
<p>访问方法必须支持<code>amgettuple</code>（见<a href="http://www.postgres.cn/docs/11/indexam.html">Chapter 61</a>），目前这意味着GIN无法使用。尽管允许，但是在一个排除约束中使用 B-树或哈希索引没有意义，因为它无法做得比一个普通唯一索引更出色。因此在实践中访问方法将总是GiST或SP-GiST。</p>
<p><em>predicate</em>允许你在该表的一个子集上指定一个排除约束。在内部这会创建一个部分索引。注意在为此周围的圆括号是必须的。</p>
<hr>
<h2 id="应用案例会议室预定">应用案例：会议室预定</h2>
<p>假设我们想要设计一个会议室预定系统，并希望在数据库层面确保不会有冲突的会议室预定出现：即，对于同一个会议室，不允许同时存在两条预定时间范围上存在重叠的记录。那么数据库表可以这样设计：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- PostgreSQL自带扩展，为普通类型添加GIST索引运算符支持
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree_gist</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 会议室预定表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meeting_room</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87">SERIAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">user_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">room_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">range</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">tsrange</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">EXCLUDE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">GIST</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">room_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">range</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这里<code>EXCLUDE USING GIST(room_id WITH = , range WITH &amp;&amp;)</code>指明了一个排它约束：不允许存在<code>room_id</code>相等，且<code>range</code>相互重叠的多条记录。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 用户1预定了101号房间，从早上10点到下午6点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meeting_room</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">room_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">range</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">101</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tsrange</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;2019-01-01 10:00&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;2019-01-01 18:00&#39;</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 用户2也尝试预定101号房间，下午4点到下午6点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meeting_room</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">room_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">range</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">101</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tsrange</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;2019-01-01 16:00&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;2019-01-01 18:00&#39;</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 用户2的预定报错，违背了排它约束
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ERROR</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">conflicting</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">value</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">violates</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">exclusion</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">constraint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;meeting_room_room_id_range_excl&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">DETAIL</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">room_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">range</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">101</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;2019-01-01 16:00:00&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;2019-01-01 18:00:00&#34;</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">conflicts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">with</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">existing</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">room_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">range</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">101</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;2019-01-01 10:00:00&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;2019-01-01 18:00:00&#34;</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这里的<code>EXCLUDE</code>约束会自动创建一个相应的GIST索引：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#4e9a06">&#34;meeting_room_room_id_range_excl&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXCLUDE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gist</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">room_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">range</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="应用案例确保ip网段不重复">应用案例：确保IP网段不重复</h2>
<p>有一些约束是相当复杂的，例如确保表中的IP范围不发生重叠，类似的，确保地理区划表中各个城市的边界不会重叠。传统上要实现这种保证是相当困难的：譬如<code>UNIQUE</code>约束就无法表达这种语义，<code>CHECK</code>与存储过程或者触发器虽然可以实现这种检查，但也相当tricky。PostgreSQL提供的<code>EXCLUDE</code>约束可以优雅地解决这个问题。修改我们的<code>geoips</code>表：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">geoips</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">ips</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">inetrange</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">geo</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">geometry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Point</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">country_code</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">region_code</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">city_name</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">ad_code</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">postal_code</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">EXCLUDE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gist</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ips</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFERRABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INITIALLY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFERRED</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>​	这里<code>EXCLUDE USING gist (ips WITH &amp;&amp;)  </code> 的意思就是<code>ips</code>字段上不允许出现范围重叠，即新插入的字段不能与任何现存范围重叠（<code>&amp;&amp;</code>为真）。而<code>DEFERRABLE INITIALLY IMMEDIATE </code>表示在语句结束时再检查所有行上的约束。创建该约束会自动在<code>ips</code>字段上创建GIST索引，因此无需手工创建了。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-2cb08544888a300f2e54d97bbb6b50ce">GO与PG实现缓存同步</h1>
	<div class="lead">巧妙运用Pg的Notify功能，可以方便地通知应用元数据变更，实现基于触发器的逻辑复制。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2017-08-03" class="text-muted">2017年08月03日</time>
        
	</div>
	<p>Parallel与Hierarchy是架构设计的两大法宝，<strong>缓存</strong>是Hierarchy在IO领域的体现。单线程场景下缓存机制的实现可以简单到不可思议，但很难想象成熟的应用会只有一个实例。在使用缓存的同时引入并发，就不得不考虑一个问题：如何保证每个实例的缓存与底层数据副本的数据一致性（和实时性）。</p>
<p>PostgreSQL在版本9引入了流式复制，在版本10引入了逻辑复制，但这些都是针对PostgreSQL数据库而言的。如果希望PostgreSQL中某张表的部分数据与应用内存中的状态保持一致，我们还是需要自己实现一种逻辑复制的机制。对于关键的少量元数据而言，使用触发器与Notify-Listen就是一个不错的选择。</p>
<hr>
<h2 id="传统方法">传统方法</h2>
<p>最简单粗暴的办法就是定时重新拉取，例如每个整点，所有应用一起去数据库拉取一次最新版本的数据。很多应用都是这么做的。当然问题也很多：拉的间隔长了，变更不能及时应用，用户体验差；拉的频繁了，IO压力大。而且实例数目和数据大小一旦膨胀起来，对于宝贵的IO资源是很大的浪费。</p>
<p>异步通知是一种更好的办法，尤其是在读请求远多于写请求的情况下。接受到写请求的实例，通过发送广播的方式通知其他实例。<code>Redis</code>的<code>PubSub</code>就可以很好地实现这个功能。如果原本下层存储就是<code>Redis</code>自然是再方便不过，但如果下层存储是关系型数据库的话，为这样一个功能引入一个新的组件似乎有些得不偿失。况且考虑到后台管理程序或者其他应用如果在修改了数据库后也要去redis发布通知，实在太麻烦了。一种可行的办法是通过数据库中间件来监听<code>RDS</code>变动并广播通知，淘宝不少东西就是这么做的。但如果DB本身就能搞定的事情，为什么需要额外的组件呢？通过PostgreSQL的Notfiy-Listen机制，可以方便地实现这种功能。</p>
<hr>
<h2 id="目标">目标</h2>
<p>无论从任何渠道产生的数据库记录变更（增删改）都能被所有相关应用实时感知，用于维护自身缓存与数据库内容的一致性。</p>
<hr>
<h2 id="原理">原理</h2>
<p>PostgreSQL行级触发器 + Notify机制 + 自定义协议 + Smart Client</p>
<ul>
<li>行级触发器：通过为我们感兴趣的表建立一个行级别的写触发器，对数据表中的每一行记录的Update,Delete,Insert都会出发自定义函数的执行。</li>
<li>Notify：通过PostgreSQL内建的异步通知机制向指定的Channel发送通知</li>
<li>自定义协议：协商消息格式，传递操作的类型与变更记录的标识</li>
<li>Smart Client：客户端监听消息变更，根据消息对缓存执行相应的操作。</li>
</ul>
<p>实际上这样一套东西就是一个超简易的WAL（Write <em>After</em> Log）实现，从而使应用内部的缓存状态能与数据库保持<em>实时</em>一致（compare to poll）。</p>
<hr>
<h2 id="ddl">DDL</h2>
<p>这里以一个最简单的表作为示例，一张以主键标识的<code>users</code>表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 用户表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">users</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="触发器">触发器</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 通知触发器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">notify_change</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_OP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;INSERT&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">PERFORM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_notify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_RELNAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;_chan&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;I&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ELSIF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_OP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;UPDATE&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">PERFORM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_notify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_RELNAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;_chan&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;U&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ELSIF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_OP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;DELETE&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">PERFORM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_notify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_RELNAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;_chan&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;D&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OLD</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OLD</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">plpgsql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SECURITY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFINER</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这里创建了一个触发器函数，通过内置变量<code>TG_OP</code>获取操作的名称，<code>TG_RELNAME</code>获取表名。每当触发器执行时，它会向名为<code>&lt;table_name&gt;_chan</code>的通道发送指定格式的消息：<code>[I|U|D]&lt;id&gt;</code></p>
<p>题外话：通过行级触发器，还可以实现一些很实用的功能，例如In-DB Audit，自动更新字段值，统计信息，自定义备份策略与回滚逻辑等。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 为用户表创建行级触发器，监听INSERT UPDATE DELETE 操作。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_user_notify</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AFTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DELETE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">users</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EACH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXECUTE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PROCEDURE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">notify_change</span><span style="color:#000;font-weight:bold">();</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>创建触发器也很简单，表级触发器对每次表变更执行一次，而行级触发器对每条记录都会执行一次。这样，数据库的里的工作就算全部完成了。</p>
<hr>
<h2 id="消息格式">消息格式</h2>
<p>通知需要传达出两个信息：变更的操作类型，变更的实体标记。</p>
<ul>
<li>变更的操作类型就是增删改：INSERT,DELETE,UPDATE。通过一个打头的字符&rsquo;[I|U|D]&lsquo;就可以标识。</li>
<li>变更的对象可以通过实体主键来标识。如果不是字符串类型，还需要确定一种无歧义的序列化方式。</li>
</ul>
<p>这里为了省事直接使用字符串类型作为ID，那么插入一条<code>id=1</code>的记录，对应的消息就是<code>I1</code>，更新一条<code>id=5</code>的记录消息就是<code>U5</code>，删除<code>id=3</code>的记录消息就是<code>D3</code>。</p>
<p>完全可以通过更复杂的消息协议实现更强大的功能。</p>
<hr>
<h2 id="智能客户端">智能客户端</h2>
<p>数据库的机制需要客户端的配合才能生效，客户端需要监听数据库的变更通知，才能将变更实时应用到自己的缓存副本中。对于插入和更新，客户端需要根据ID重新拉取相应实体，对于删除，客户端需要删除自己缓存副本的相应实体。以Go语言为例，编写了一个简单的客户端模块。</p>
<p>本例中使用一个以<code>User.ID</code>作为键，<code>User</code>对象作为值的并发安全字典<code>Users sync.Map</code>作为缓存。</p>
<p>作为演示，启动了另一个goroutine对数据库写入了一些变更。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;github.com/go-pg/pg&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#4e9a06">&#34;github.com/Vonng/gopher/db/pg&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">log</span> <span style="color:#4e9a06">&#34;github.com/Sirupsen/logrus&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ID</span>   <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`sql:&#34;,pk&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">Users</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Map</span> <span style="color:#8f5902;font-style:italic">// Users 内部数据缓存
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">LoadAllUser</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">users</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">User</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Pg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Query</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">`SELECT ID,name FROM users;`</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">users</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Users</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">LoadUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Pg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Users</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">PrintUsers</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">buf</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Users</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">buf</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;,&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ListenUserChange 会监听PostgreSQL users数据表中的变动通知
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ListenUserChange</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Notification</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">notify</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">c</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">action</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">notify</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Payload</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">notify</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Payload</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:]</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">action</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#39;I&#39;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">fallthrough</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#39;U&#39;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">LoadUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#39;D&#39;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Users</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[NOTIFY] Action:%c ID:%s Users: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">action</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PrintUsers</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">Pg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users_chan&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Channel</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// MakeSomeChange 会向数据库写入一些变更
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">MakeSomeChange</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Pg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;001&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;张三&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Pg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;002&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;李四&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Pg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;003&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;王五&#34;</span><span style="color:#000;font-weight:bold">})</span>  <span style="color:#8f5902;font-style:italic">// 插入
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">Pg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;003&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;王麻子&#34;</span><span style="color:#000;font-weight:bold">})</span> <span style="color:#8f5902;font-style:italic">// 改名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">Pg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;002&#34;</span><span style="color:#000;font-weight:bold">})</span>    <span style="color:#8f5902;font-style:italic">// 删除
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Pg</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">NewPg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;postgres://localhost:5432/postgres&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Pg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`TRUNCATE TABLE users;`</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">LoadAllUser</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ListenUserChange</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">MakeSomeChange</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>运行结果如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[NOTIFY] Action:I ID:001 Users: 001          
</span></span><span style="display:flex;"><span>[NOTIFY] Action:I ID:002 Users: 001,002      
</span></span><span style="display:flex;"><span>[NOTIFY] Action:I ID:003 Users: 002,003,001  
</span></span><span style="display:flex;"><span>[NOTIFY] Action:U ID:003 Users: 001,002,003  
</span></span><span style="display:flex;"><span>[NOTIFY] Action:D ID:002 Users: 001,003      
</span></span></code></pre></div><p>可以看出，缓存确是与数据库保持了同样的状态。</p>
<hr>
<h2 id="应用场景">应用场景</h2>
<p>小数据量下这种做法是相当可靠的，大数据量下尚未进行充分的测试。</p>
<p>其实，对于上例中缓存同步的场景，完全不需要自定义消息格式，只要发送发生变更的记录ID，由应用直接拉取，然后覆盖或删除缓存中的记录即可。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-aabc7bc725071559d5d7f1427e2a2a1f">用触发器审计数据变化</h1>
	<div class="lead">有时候，我们希望记录一些重要的元数据变更，以便事后审计之用。PostgreSQL的触发器就可以很方便地自动解决这一需求。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2017-06-09" class="text-muted">2017年06月09日</time>
        
	</div>
	<p>有时候，我们希望记录一些重要的元数据变更，以便事后审计之用。</p>
<p>PostgreSQL的触发器就可以很方便地自动解决这一需求。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 创建一个审计专用schema，并废除所有非superuser的权限。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SCHEMA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SCHEMA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">REVOKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SCHEMA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PUBLIC</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 审计表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">action_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">schema_name</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87">TEXT</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">TEXT</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">user_name</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">time</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">TIMESTAMP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TIME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ZONE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CURRENT_TIMESTAMP</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">action</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87">TEXT</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CHECK</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">action</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;I&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;D&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;U&#39;</span><span style="color:#000;font-weight:bold">)),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">original_data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">new_data</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">query</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87">TEXT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">FILLFACTOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 审计表权限
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">REVOKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">action_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PUBLIC</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">action_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PUBLIC</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 索引
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">logged_actions_schema_table_idx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">action_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(((</span><span style="color:#204a87;font-weight:bold">schema_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">logged_actions_time_idx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">action_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">logged_actions_action_idx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">action_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">action</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 创建审计触发器函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">---------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#000">body$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">v_old_data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">v_new_data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_OP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;UPDATE&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">v_old_data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">OLD</span><span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">v_new_data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">action_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">schema_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">user_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">action</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">original_data</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_data</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">query</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_TABLE_SCHEMA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TG_TABLE_NAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">session_user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_OP</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v_old_data</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#000">v_new_data</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">current_query</span><span style="color:#000;font-weight:bold">());</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ELSIF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_OP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;DELETE&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">v_old_data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">OLD</span><span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">action_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">schema_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">user_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">action</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">original_data</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">query</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_TABLE_SCHEMA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TG_TABLE_NAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">session_user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_OP</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v_old_data</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">current_query</span><span style="color:#000;font-weight:bold">());</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OLD</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ELSIF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_OP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;INSERT&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">v_new_data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">action_log</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">schema_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">user_name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">action</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_data</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">query</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_TABLE_SCHEMA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TG_TABLE_NAME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">session_user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TG_OP</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v_new_data</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">current_query</span><span style="color:#000;font-weight:bold">());</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">RAISE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">WARNING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;[AUDIT.IF_MODIFIED_FUNC] - Other action occurred: %, at %&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TG_OP</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">();</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">EXCEPTION</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">data_exception</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">RAISE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">WARNING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;[AUDIT.IF_MODIFIED_FUNC] - UDF ERROR [DATA EXCEPTION] - SQLSTATE: %, SQLERRM: %&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SQLSTATE</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SQLERRM</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">unique_violation</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">RAISE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">WARNING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;[AUDIT.IF_MODIFIED_FUNC] - UDF ERROR [UNIQUE] - SQLSTATE: %, SQLERRM: %&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SQLSTATE</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SQLERRM</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OTHERS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">RAISE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">WARNING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;[AUDIT.IF_MODIFIED_FUNC] - UDF ERROR [OTHER] - SQLSTATE: %, SQLERRM: %&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SQLSTATE</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SQLERRM</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$</span><span style="color:#000">body$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">plpgsql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SECURITY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFINER</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">search_path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;记录特定表上的插入、修改、删除行为&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 最后修改时间审计触发器函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">---------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 当记录发生变更前，记录修改时间。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update_mtime</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mtime</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">();</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NEW</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;plpgsql&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update_mtime</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;更新记录mtime&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 元数据变动事件触发器函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 向&#39;change&#39;信道发送数据变动的表名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">---------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">notify_change</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRIGGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">PERFORM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_notify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;change&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TG_RELNAME</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;plpgsql&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">audit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">notify_change</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;数据变动事件触发器函数，向`change`信道发送数据变动的表名&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------------------------------------------------------
</span></span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-6b7c38ff19f28b80c8a27b522ff4ecea">SQL实现ItemCF推荐系统</h1>
	<div class="lead">用PostgreSQL 5分钟实现一个最简单ItemCF推荐系统</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2017-04-05" class="text-muted">2017年04月05日</time>
        
	</div>
	<p>推荐系统大家都熟悉，猜你喜欢，淘宝个性化什么的，前年双十一搞了个大新闻，还拿了CEO特别贡献奖。</p>
<p>今天就来说说怎么用PostgreSQL 5分钟实现一个最简单ItemCF推荐系统，以推荐系统最喜闻乐见的<a href="https://grouplens.org/datasets/movielens/">movielens数据集</a>为例。</p>
<hr>
<h2 id="原理">原理</h2>
<p>ItemCF的原理可以看项亮的《推荐系统实战》，不过还是稍微提一下吧，了解的直接跳过就好。</p>
<p>Item CF，全称Item Collaboration Filter，即基于物品的协同过滤，是目前业界应用最多的推荐算法。ItemCF不需要物品与用户的标签、属性，只要有用户对物品的行为日志就可以了，同时具有很好的可解释性。所以无论是亚马逊，Hulu，YouTube，balabala用的都是该算法。</p>
<p>ItemCF算法的核心思想是：给用户推荐那些和他们之前<strong>喜欢</strong>的物品<strong>相似</strong>的物品。</p>
<p>这里有两个要点：</p>
<ul>
<li>用户喜欢物品怎么表示？</li>
<li>物品的相似度怎样表示？</li>
</ul>
<h3 id="用户评分表">用户评分表</h3>
<p>可以通过用户评分表来判断用户对物品的喜爱程度，例如电影数据的5分制：5分表示非常喜欢，1分表示不喜欢。</p>
<p>用户评分表有三个核心字段：<code>user_id, movie_id, rating</code>，分别是用户ID，物品ID，用户对物品的评分。</p>
<p>怎样得到这个表呢？如果本来就是评论打分网站在做推荐系统，直接有用户对电影，音乐，小说的评分记录那是最好不过。其他的场景，比如电商，社交网络，则可以通过<strong>用户对物品的行为日志</strong>生成这张评分表。例如可以为“浏览”，“点击”，“收藏”，“购买”，点击“我不喜欢”按钮这些行为分别设一个喜好权重：<code>0.1, 0.2, 0.3, 0.4, -100</code>。将所有行为评分加权求和，最终得到这张用户对物品的评分表来，事就成了一半了。</p>
<h3 id="物品相似度">物品相似度</h3>
<p>还需要解决的一个问题是物品相似度的<strong>计算</strong>与<strong>表示</strong>。</p>
<p>假设一共有$N$个物品，则物品相似度数据可以表示为一个$N \times N$的矩阵，第$i$行$j$列的值表示物品$i$与物品$j$之间的相似度。这样相似度<strong>表示</strong>的问题就解决了。</p>
<p>第二个问题是物品相似度矩阵的计算。</p>
<p>但在计算前，首先必须定义，什么是物品的相似度？</p>
<p>两个物品之间的相似度有很多种定义与计算方式，如果我们有物品的各种属性数据(类型，大小，价格，风格，标签)的话，就可以在属性空间定义各式各样的“距离”，来定义相似度。但ItemCF的亮点就在于，不需要物品的属性标签数据也可以计算其相似度来。其核心思想是：如果一对物品被很多人同时喜欢，则认为这一对物品更为相似。</p>
<p>令$N(i)$为喜欢物品$i$的用户集合，$|N(i)|$为喜欢物品$i$的人数，$|N(i) \cap N(j)|$为同时喜欢物品$i,j$的人数，则物品$i,j$之间的相似度$_{ij}$可w以表示为：</p>
<p>$$
w_{ij} = \frac{|N(i) \cap N(j)|}{ \sqrt{ |N(i)| * |N(j)|}}
$$</p>
<p>即：同时喜欢物品$i,j$的人数，除以喜爱物品$i$人数和喜爱物品$j$人数的几何平均数。</p>
<p>这样，就可以通过用户对物品的行为日志，导出一份物品之间的相似矩阵数据来。</p>
<h3 id="推荐物品">推荐物品</h3>
<p>现在有一个用户$u$，他对物品$j$的评分可以通过以下公式计算：</p>
<p>$$
\displaystyle
p_{uj} = \sum_{i \in N(u) \cap S(i, K)} w_{ji}r_{ui}
$$</p>
<p>其中，用户$i$对物品$i_1,i_2,\cdots,i_n$的评分分别为$r_1,r_2,…,r_n$，而物品$i_1,i_2,\cdots,i_n$与目标物品$j$的相似度分别为$w_1,w_2,\cdots,w_n$。以用户$u$评分过的物品集合作为纽带，按照评分以相似度加权求和，就可以得到用户$u$对物品$j$的评分了。</p>
<p>对这个预测评分$p$排序取TopN，就得到了用户$u$的推荐物品列表</p>
<hr>
<h2 id="实践">实践</h2>
<p>说了这么多废话，赶紧燥起来。</p>
<h3 id="第一步准备数据">第一步：准备数据</h3>
<p>下载<a href="https://grouplens.org/datasets/movielens/">Movielens数据集</a>，开发测试的话选小规模的(100k)就可以。对于ItemCF来说，有用的数据就是用户行为日志，即文件<code>ratings.csv</code>：<a href="http://files.grouplens.org/datasets/movielens/ml-latest-small.zip">地址</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- movielens 用户评分数据集
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mls_ratings</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">user_id</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">movie_id</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">rating</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">timestamp</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">movie_id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 从CSV导入数据，并将评分乘以2变为2~10的整数便于处理，将Unix时间戳转换为日期类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">COPY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mls_ratings</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/Users/vonng/Dev/recsys/ml-latest-small/ratings.csv&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DELIMITER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;,&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CSV</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">HEADER</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mls_ratings</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rating</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DATA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TYPE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rating</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">DECIMAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mls_ratings</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COLUMN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">timestamp</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DATA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TYPE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TIMESTAMPTZ</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">to_timestamp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">timestamp</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DOUBLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRECISION</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>得到的数据长这样：第一列用户ID列表，第二列电影ID列表，第三列是评分，最后是时间戳。一共十万条</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>movielens=# select * from mls_ratings limit 10;
</span></span><span style="display:flex;"><span> user_id | movie_id | rating |       timestamp
</span></span><span style="display:flex;"><span>---------+----------+--------+------------------------
</span></span><span style="display:flex;"><span>       1 |       31 |      5 | 2009-12-14 10:52:24+08
</span></span><span style="display:flex;"><span>       1 |     1029 |      6 | 2009-12-14 10:52:59+08
</span></span><span style="display:flex;"><span>       1 |     1061 |      6 | 2009-12-14 10:53:02+08
</span></span><span style="display:flex;"><span>       1 |     1129 |      4 | 2009-12-14 10:53:05+08
</span></span></code></pre></div><hr>
<h3 id="第二步计算物品相似度">第二步：计算物品相似度</h3>
<h4 id="物品相似度的ddl">物品相似度的DDL</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 物品相似度表，这是把矩阵用&lt;i,j,M_ij&gt;的方式在数据库中表示。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mls_similarity</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">i</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">j</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">p</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">FLOAT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>物品相似度是一个矩阵，虽说PostgreSQL里提供了数组，多维数组，自定义数据结构，不过这里为了方便起见还是使用了最传统的矩阵表示方法：坐标索引法$(i,j,m_{ij})$。其中前两个元素为矩阵下标，各自表示物品的ID。最后一个元素存储了这一对物品的相似度。</p>
<h4 id="物品相似度的计算">物品相似度的计算</h4>
<p>计算物品相似度，要计算两个中间数据：</p>
<ul>
<li>每个物品被用户喜欢的次数：$|N(i)|$</li>
<li>每对物品共同被同一个用户喜欢的次数 $|N(i) \cap N(j)|$</li>
</ul>
<p>如果是用编程语言，那自然可以一趟(One-Pass)解决两个问题。不过SQL就要稍微麻烦点了，好处是不用操心撑爆内存的问题。</p>
<p>这里可以使用PostgreSQL的With子句功能，计算两个临时结果供后续使用，一条SQL就搞定相似矩阵计算：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 计算物品相似度矩阵: 3m 53s
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mls_occur</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 中间表：计算每个电影被用户看过的次数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">movie_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic">-- 电影ID: i
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 看过电影i的人数: |N(i)|
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mls_ratings</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">movie_id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">mls_common</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 中间表：计算每对电影被用户同时看过的次数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">movie_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 电影ID: i
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">movie_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 电影ID: j
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- 同时看过电影i和j的人数: |N(i) ∩ N(j)|
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mls_ratings</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INNER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mls_ratings</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user_id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">j</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mls_similarity</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">n</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sqrt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">p</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- 距离公式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">mls_common</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">LATERAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mls_occur</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">movie_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">LATERAL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mls_occur</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">movie_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n2</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>物品相似度表大概长这样：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>movielens=# SELECT * FROM mls_similarity LIMIT 10;
</span></span><span style="display:flex;"><span>   i    | j |         p
</span></span><span style="display:flex;"><span>--------+---+--------------------
</span></span><span style="display:flex;"><span> 140267 | 1 |  0.110207753755597
</span></span><span style="display:flex;"><span>   2707 | 1 |  0.180280682843137
</span></span><span style="display:flex;"><span> 140174 | 1 |  0.113822078644894
</span></span><span style="display:flex;"><span>   7482 | 1 | 0.0636284762975778
</span></span></code></pre></div><p>实际上还可以修剪修剪，比如计算时非常小的相似度干脆可以直接删掉。也可以用整个表中相似度的最大值作为单位1，进行归一化。这里都不弄了。</p>
<hr>
<h3 id="第三步进行推荐">第三步：进行推荐！</h3>
<p>现在假设我们为ID为10的用户推荐10部他没看过的电影，该怎么做呢？</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">seed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">-- 10号用户评分过的影片作为种子集合
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">movie_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">rating</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mls_ratings</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">user_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">j</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">movie_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">-- 所有待预测评分的电影ID
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">seed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rating</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">score</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 预测加权分，按此字段降序排序取TopN
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">seed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LEFT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mls_similarity</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">seed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">movie_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">i</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">j</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DISTINCT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">movie_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">seed</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 去除已经看过的电影(可选)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">j</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">score</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 聚合，排序，取TOP
</span></span></span></code></pre></div><p>推荐结果如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span> movie_id |      score
</span></span><span style="display:flex;"><span>----------+------------------
</span></span><span style="display:flex;"><span>     1270 | 121.487735902517
</span></span><span style="display:flex;"><span>     1214 | 116.146138947698
</span></span><span style="display:flex;"><span>     1580 | 116.015331936539
</span></span><span style="display:flex;"><span>     2797 | 115.144083402858
</span></span><span style="display:flex;"><span>     1265 | 114.959033115913
</span></span><span style="display:flex;"><span>      260 | 114.313571128143
</span></span><span style="display:flex;"><span>     2716 | 113.087151014987
</span></span><span style="display:flex;"><span>     1097 |  113.07771922959
</span></span><span style="display:flex;"><span>     1387 | 112.869891345883
</span></span><span style="display:flex;"><span>     2916 |  112.84326997566
</span></span></code></pre></div><p>可以进一步包装一下，把它变成一个存储过程<code>get_recommendation</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">get_recommendation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">JSONB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">jsonb_agg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">movie_id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">seed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">movie_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">rating</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mls_ratings</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">user_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">userid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#000">j</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">movie_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">seed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rating</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">score</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#000">seed</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LEFT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mls_similarity</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">seed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">movie_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">i</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">j</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DISTINCT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">movie_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">seed</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">j</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">score</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">plpgsql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">STABLE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这样用起来更方便啦，同时也可以在这里加入一些其他的处理逻辑：比如过滤掉禁片黄片，去除用户明确表示过不喜欢的电影，加入一些热门电影，引入一些随机惊喜，打点小广告之类的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>movielens=# SELECT get_recommendation(11) as res;
</span></span><span style="display:flex;"><span>                                  res
</span></span><span style="display:flex;"><span>-----------------------------------------------------------------------
</span></span><span style="display:flex;"><span> [80489, 96079, 79132, 59315, 91529, 69122, 58559, 59369, 1682, 71535]
</span></span></code></pre></div><p>最后写个应用把这个存储过程作为OpenAPI开放出去，事就这样成了。</p>
<p>关于这一步可以参考前一篇：<a href="https://www.atatech.org/articles/70532">当PostgreSQL遇上GraphQL：Postgraphql</a>中的做法，直接由存储过程生成GraphQL API，啥都不用操心了。</p>
<hr>
<h3 id="whats-more">What&rsquo;s more</h3>
<p>几行SQL一条龙执行下来，加上下载数据的时间，总共也就五分钟吧。一个简单的推荐系统就这样搭建起来了。</p>
<p>但一个真正的生产系统还需要考虑许许多多其他问题，例如，性能。</p>
<p>这里比如说计算相似度矩阵的时候，才100k条记录花了三四分钟，不太给力。而且这么多SQL写起来，管理起来也麻烦，有没有更好的方案？</p>
<p>这儿有个基于PostgreSQL源码魔改的推荐数据库：<a href="http://www-users.cs.umn.edu/~sarwat/RecDB/">RecDB</a>，直接用C实现了推荐系统相关的功能扩展，性能看起来杠杠地；同时还包装了SQL语法糖，一行SQL建立推荐系统！再一行SQL就开始使用啦。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 计算推荐所需的信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RECOMMENDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MovieRec</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ml_ratings</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">USERS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">userid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ITEMS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">itemid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">EVENTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ratingval</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ItemCosCF</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 进行推荐！
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ml_ratings</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">R</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">RECOMMEND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">R</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">itemid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">R</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">R</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratingval</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USING</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ItemCosCF</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">R</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">R</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratingval</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">LIMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>PostgreSQL能干的事情太多了，最先进的开源关系数据库确实不是吹的，其实真的可以试一试。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-553b99cdb5eb8e33ac93dd13977c3840">UUID性质原理与应用</h1>
	<div class="lead">UUID性质原理与应用，以及如何利用PostgreSQL的存储过程操作UUID。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2016-11-06" class="text-muted">2016年11月06日</time>
        
	</div>
	<p>最近一个项目需要生成业务流水号，需求如下：</p>
<ul>
<li>ID必须是分布式生成的，不能依赖中心节点分配并保证全局唯一。</li>
<li>ID必须包含时间戳并尽量依时序递增。（方便阅读，提高索引效率）</li>
<li>ID尽量散列。（分片，与HBase日志存储需要）</li>
</ul>
<p>在造轮子之前，首先要看一下有没有现成的解决方案。</p>
<h3 id="serial">Serial</h3>
<p>传统实践上业务流水号经常通过数据库自增序列或者发码服务来实现。
<code>MySQL</code>的<code>Auto Increment</code>,<code>Postgres</code>的<code>Serial</code>,或者<code>Redis+lua</code>写个小发码服务都是方便快捷的解决方案。这种方案可以保证全局唯一，但会出现中心节点依赖：每个节点需要访问一次数据库才能拿到序列号。这就产生了可用性问题：如果能在本地生成流水号并直接返回响应，那为什么非要用一次网络访问拿ID呢？如果数据库挂了，节点也GG了。所以这并不是一个理想的方案。</p>
<h3 id="snowflakeid">SnowflakeID</h3>
<p>然后就是twitter的<a href="http://www.lanindex.com/twitter-snowflake%EF%BC%8C64%E4%BD%8D%E8%87%AA%E5%A2%9Eid%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3/">SnowflakeID</a>了，SnowflakeID是一个BIGINT，第一位不用，41bit的时间戳，10bit的节点ID，12bit的毫秒内序列号。时间戳，工作机器ID，序列号占用的位域长度是可以根据业务需求不同而变化的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>    0                   1                   2                   3
</span></span><span style="display:flex;"><span>    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
</span></span><span style="display:flex;"><span>   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</span></span><span style="display:flex;"><span>   |x|                    41-bit timestamp                         |
</span></span><span style="display:flex;"><span>   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</span></span><span style="display:flex;"><span>   |       timestamp   |10-bit machine node|    12-bit serial      |
</span></span><span style="display:flex;"><span>   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</span></span></code></pre></div><p>SnowflakeID可以说基本满足了这四个需求，首先，通过不同的时间戳(精确到毫秒)，节点ID(工作机器ID)，以及毫秒内的序列号，某种意义上确实可以做到唯一。一个比较讨喜的特性是所有ID是依时序递增的，所以索引起来或者拉取数据会非常方便，长整形的索引和存储效率也很高，生成效率也没得说。</p>
<p>但我认为SnowflakeId存在两个致命问题：</p>
<ul>
<li>虽然ID生成不需要中心节点分配，但工作机器ID还是需要手工分配或者提供中心节点协调的，本质上是改善而不是解决问题。</li>
<li>无法解决时间回溯的问题，一旦服务器时间发生调整，几乎一定会生成出重复ID。</li>
</ul>
<h3 id="uuid--universally-unique-identifier">UUID  (Universally Unique IDentifier)</h3>
<p>其实这种问题早就有经典的解决方案了，譬如：<a href="https://tools.ietf.org/html/rfc4122">UUID by RFC 4122</a>  。著名的IDFA就是一种UUID</p>
<p>UUID是一种格式，共有5个版本，最后我选择了v1作为最终方案。下面详细简单介绍一下UUID v1的性质。</p>
<ul>
<li>可以分布式本地生成。</li>
<li>保证全局唯一，且可以应对时间回溯或网卡变化导致ID重复生成的问题。</li>
<li>时间戳(60bit)，精确至0.1微秒(1e-7 s)。蕴含在ID中。</li>
<li>在一个连续的时间片段(2^32/1e7 s约7min)内，ID单调递增。</li>
<li>连续生成的ID会被均匀散列，（所以分片起来不要太方便，放在HBase里也可以直接当Rowkey）</li>
<li>有现成的标准，不需要任何事先配置与参数输入，各个语言均有实现，开箱即用。</li>
<li>可以直接通过UUID字面值得知大概的业务时间戳。</li>
<li>PostgreSQL直接内建UUID支持(ver&gt;9.0)。</li>
</ul>
<p>综合考虑，这确实是我能找到的最完美的解决方案了。</p>
<h3 id="uuid概览">UUID概览</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Shell中生成一个随机UUID的简单方式</span>
</span></span><span style="display:flex;"><span>$ python -c <span style="color:#4e9a06">&#39;import uuid;print(uuid.uuid4())&#39;</span>
</span></span><span style="display:flex;"><span>8d6d1986-5ab8-41eb-8e9f-3ae007836a71
</span></span></code></pre></div><p>我们通常见到的UUID如上所示，通常用<code>'-'</code>分隔的五组十六进制数字表示。但这个字符串只不过是UUID的字符串表示，即所谓的<code>UUID Literal</code>。实际上UUID是一个128bit的整数。也就是16个字节，两个长整形的宽度。</p>
<p>因为每个字节用2个<code>hex</code>字符表示，所以UUID通常可以表示为32个十六进制数字，按照<code>8-4-4-4-12</code>的形式进行分组。为什么采用这种分组形式？因为最原始版本的UUID v1采用了这种位域划分方式，后面其他版本的UUID虽然可能位域划分跟这个结构已经不同了，依然采用此种字面值表示方法。UUID1是最经典的UUID，所以我着重介绍UUID1。</p>
<p>下面是UUID版本1的位域划分：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#0000cf;font-weight:bold">0</span>                   <span style="color:#0000cf;font-weight:bold">1</span>                   <span style="color:#0000cf;font-weight:bold">2</span>                   <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">9</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">9</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">9</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">|</span>                          <span style="color:#000">time_low</span>                             <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">|</span>       <span style="color:#000">time_mid</span>                <span style="color:#ce5c00;font-weight:bold">|</span>         <span style="color:#000">time_hi_and_version</span>   <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">clk_seq_hi_res</span> <span style="color:#ce5c00;font-weight:bold">|</span>  <span style="color:#000">clk_seq_low</span>  <span style="color:#ce5c00;font-weight:bold">|</span>         <span style="color:#000">node</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>            <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">|</span>                         <span style="color:#000">node</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>                            <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">unsigned32</span>  <span style="color:#000">time_low</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">unsigned16</span>  <span style="color:#000">time_mid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">unsigned16</span>  <span style="color:#000">time_hi_and_version</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">unsigned8</span>   <span style="color:#000">clock_seq_hi_and_reserved</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">unsigned8</span>   <span style="color:#000">clock_seq_low</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">byte</span>        <span style="color:#000">node</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">uuid_t</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>但位域划分是按照C结构体的表示方便来划分的，从逻辑上UUID1包括五个部分：</p>
<ul>
<li>时间戳 :<code>time_low(32)</code>,<code> time_mid(16)</code>,<code>time_high(12)</code>，共60bit。</li>
<li>UUID版本:<code>version(4)</code></li>
<li>UUID类型: <code>variant(2)</code></li>
<li>时钟序列:<code>clock_seq(14)</code></li>
<li>节点: <code>node(48)</code>，UUID1中为MAC地址。</li>
</ul>
<p>这五个部分实际占用的位域如下图所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>    <span style="color:#0000cf;font-weight:bold">0</span>                   <span style="color:#0000cf;font-weight:bold">1</span>                   <span style="color:#0000cf;font-weight:bold">2</span>                   <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">9</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">9</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">9</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">|</span>                          <span style="color:#000">time_low</span>                             <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">|</span>       <span style="color:#000">time_mid</span>                <span style="color:#ce5c00;font-weight:bold">|</span>  <span style="color:#000">ver</span>  <span style="color:#ce5c00;font-weight:bold">|</span>      <span style="color:#000">time_high</span>        <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#204a87;font-weight:bold">var</span><span style="color:#ce5c00;font-weight:bold">|</span>       <span style="color:#000">clock_seq</span>           <span style="color:#ce5c00;font-weight:bold">|</span>         <span style="color:#000">node</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>            <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">|</span>                         <span style="color:#000">node</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>                            <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span></code></pre></div><p>在UUID中：</p>
<ul>
<li>
<p><code>version</code>固定等于<code>0b0001</code>,即版本号固定为<code>1</code>。</p>
<p>反应在字面值上就是：一个合法的UUID v1第三个分组的第一个<code>hex</code>一定是<code>1</code>:</p>
<ul>
<li><em>6b54058a-a413-<em><strong>1</strong></em>1e6-b501-a0999b048337</em></li>
</ul>
<p>当然，如果这个值是<code>2,3,4,5</code>，也代表着这就是一个版本<code>2,3,4,5</code>的UUID。</p>
</li>
<li>
<p><code>varient</code>是用来和其他类型UUID(如GUID)进行区分的字段，指明了UUID的位域解释方法。这里固定为<code>0b10</code>。</p>
<p>反应在字面值上，一个合法的UUID v1第四个分组的第一个<code>hex</code>一定是<code>8,9,A,B</code>之一：</p>
<ul>
<li><em>6b54058a-a413-11e6-<em><strong>b</strong></em>501-a0999b048337</em></li>
</ul>
</li>
<li>
<p><code>timestamp</code>由系统时钟获得，形式为60bit的整数，内容是：<em>Coordinated Universal Time (UTC) as a count of 100-   nanosecond intervals since 00:00:00.00, 15 October 1582 (the date of   Gregorian reform to the Christian calendar).</em></p>
<p>即从1582/10/15 00:00:00至今经过的百纳秒数（100 ns= 1e-7 s）。这么蛋疼的设计是为了让产生良好的散列，让输出ID分布的熵最大化。</p>
<p>将<code>unix timestamp</code>换算为所需时间戳的公式为:<code>ts * 10000000 + 122192928000000000</code></p>
<p><code>time_low = (long long)timestamp [32:64)</code> ，将时间戳的最低位的<code>32bit</code>按照同样的顺序填入UUID前32bit</p>
<p><code>time_mid = (long long)timestamp [16:32)</code> ，将时间戳中间的<code>16bit</code>按照同样的顺序填入UUID的<code>time_mid</code></p>
<p><code>time_high = (long long)timestamp [4:16)</code> ，将时间戳的最高的<code>12bit</code>按照同样的顺序生成<code>time_hi</code>。</p>
<p>不过<code>time_hi</code>和<code>version</code>是共享一个<code>short int</code>的，所以其生成方法为：</p>
<p><code>time_hi_and_version = (long long)timestamp[0:16) &amp; 0x0111 | 0x1000</code></p>
</li>
<li>
<p><code>clock_seq</code>是为了防止网卡变更与时间回溯导致的ID重复问题，当系统时间回溯或网卡状态变更时，<code>clock_seq</code>会自动重置，从而避免ID重复问题。其形式为14个bit，换算成整数即<code>0</code>~<code>16383</code>，一般的UUID库都会自动处理，不在乎的话也可以随机生成或者设为固定值提高性能。</p>
</li>
<li>
<p><code>node</code>字段在UUID1中的涵义等同于机器网卡MAC。48bit正好与MAC地址等长。一般UUID库会自动获取，但因为MAC地址泄露出去可能会有一些安全隐患，所以也有一些库是按照IP地址生成的，或者因为拿不到MAC就用一些系统指纹来生成，总之也不用操心。</p>
</li>
</ul>
<p>所以，其实UUIDv1的所有字段都可以自动获取，压根不用人操心。其实是很方便的。</p>
<p>阅读UUID v1时也有一些经验和技巧。</p>
<p>UUID的第一个分组位域宽度为32bit，以百纳秒表示时间的话，也就是<code>(2 ^ 32 / 1e7 s = 429.5 s = 7.1 min)</code>。即每7分钟，第一个分组经历一次重置循环。所以对于随机到达的请求，生成的ID哈希分布应该是很均匀的。</p>
<p>UUID的第二个分组位域宽度为16bit，也就是<code>2^48 / 1e7 s = 326 Day</code>，也就是说，第二个分组基本上每年循环一次。可以近似的看做年内的业务日期。</p>
<p>当然，最靠谱的方法还是用程序直接从UUID v1中提取出时间戳来。这也是非常方便的。</p>
<h2 id="一些问题">一些问题</h2>
<p>前几天需要合并老的业务日志，老的系统里面日志压根没有流水号这个概念，这就让人蛋疼了。新老日志合并需要为老日志补充生成业务流水ID。</p>
<p>UUID v1生成起来是非常方便的，但要手工构造一个UUID去补数据就比较蛋疼了。我在中英文互联网,<code>StackOverflow</code>找了很久都没发现现成的<code>python</code>,<code>Node</code>,<code>Go</code>,<code>pl/pgsql</code>库或者函数能完成这个功能，这些包大抵就是提供一个<code>uuid.v1()</code>给外面用，压根没想到还会有回溯生成ID这种功能吧……</p>
<p>所以我自己写了一个<code>pl/pgsql</code>的存储过程，可以根据业务时间戳和当初工作机器的MAC重新生成UUID1。编写这个函数让我对UUID的实现细节与原理有了更深的了解，还是不错的。</p>
<p>根据时间戳，时钟序列(非必须)，MAC生成UUID的存储过程，其他语言同理：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- Build UUIDv1 via RFC 4122. 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- clock_seq is a random 14bit unsigned int with range [0,16384)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">form_uuid_v1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TIMESTAMPTZ</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clock_seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mac</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MACADDR</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UUID</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">t</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87">BIT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">extract</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EPOCH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ts</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10000000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">122192928000000000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIGINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">uuid_hi</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#4e9a06">&#39;0001&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#204a87;font-weight:bold">substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lpad</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">to_hex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uuid_hi</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;0&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">to_hex</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">b</span><span style="color:#4e9a06">&#39;10&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clock_seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">replace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mac</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;:&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">plpgsql</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Usage: SELECT form_uuid_v1(time, 666, &#39;44:88:99:36:57:32&#39;);
</span></span></span></code></pre></div><p>从UUID1中提取时间戳的存储过程</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uuid_v1_timestamp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_uuid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UUID</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TIMESTAMP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TIME</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ZONE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">to_timestamp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;x&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lpad</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">h</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;0&#39;</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">BIGINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DOUBLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRECISION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#0000cf;font-weight:bold">122192928000000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">h</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_uuid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SQL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IMMUTABLE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>





    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Mail" aria-label="Mail">
    <a target="_blank" rel="noopener" href="mailto:rh@vonng.com" aria-label="Mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Vonng/pigsty" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://twitter.com/GobeUncleWang" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="WeChat" aria-label="WeChat">
    <a target="_blank" rel="noopener" href="/img/pigsty/pigsty-cc.jpg" aria-label="WeChat">
      <i class="fa fa-comment"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Discord" aria-label="Discord">
    <a target="_blank" rel="noopener" href="https://discord.gg/wDzt5VyWEz" aria-label="Discord">
      <i class="fab fa-discord"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Telegram" aria-label="Telegram">
    <a target="_blank" rel="noopener" href="https://t.me/joinchat/gV9zfZraNPM3YjFh" aria-label="Telegram">
      <i class="fab fa-telegram"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2018&ndash;2025
    <span class="td-footer__authors">Ruohang Feng</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span></span><span class="ms-2"><a href="https://vonng.com/en/" target="_blank" rel="noopener">@Vonng</a></span>
<br><span>Pigsty® distributed under <a href="/docs/about/license" target="_blank" rel="noopener">AGPLv3</a></span>
<br><span class="ms-2"><a href="/docs/about/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
<span><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">浙ICP备15016890号</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.248655eb216150e39da254c2f7aa5357805d0ec66bdb741b591cd35fb5f629ab.js" integrity="sha256-JIZV6yFhUOOdolTC96pTV4BdDsZr23QbWRzTX7X2Kas=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
