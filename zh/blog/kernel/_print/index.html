<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="/zh/blog/kernel/">
<link rel="alternate" type="application/rss&#43;xml" href="/zh/blog/kernel/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>PG 内核 | Pigsty</title>
<meta name="description" content="关于 PostgreSQL 内核原理与体系架构的文章
">
<meta property="og:title" content="PG 内核" />
<meta property="og:description" content="关于 PostgreSQL 内核原理与体系架构的文章
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/zh/blog/kernel/" />

<meta itemprop="name" content="PG 内核">
<meta itemprop="description" content="关于 PostgreSQL 内核原理与体系架构的文章
"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="PG 内核"/>
<meta name="twitter:description" content="关于 PostgreSQL 内核原理与体系架构的文章
"/>




<link rel="preload" href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" as="style">
<link href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="/js/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LG1V9WTKGE');
}
</script>
  </head>
  <body class="td-section td-blog">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/zh/"><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class="navbar-brand__name">Pigsty</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/zh/docs/"><i class='fa-solid fa-book'></i><span>文档</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="/zh/blog/"><i class="fas fa-blog"></i><span>博客</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/Vonng/pigsty/" target="_blank" rel="noopener"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-language"></i>中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/">English</a></li>
    </ul>
</div>
</li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.b696ec90cb9c07b2c457007bd806beb7.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/zh/blog/kernel/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">PG 内核</h1>
<div class="lead">关于 PostgreSQL 内核原理与体系架构的文章</div>




    <ul>
    
  
  
  
  

  
    
    
	

    <li><a href="#pg-92a459cc74bea527711460cc0167cd07">PG先写脏页还是先写WAL？</a></li>



    
  
    
    
	

    <li><a href="#pg-f6eaf5921bd3dfe2f779402ea0a878a7">第一章 数据库的物理/逻辑结构</a></li>



    
  
    
    
	

    <li><a href="#pg-00326e1d5c8a39c4e36400d8a9eacedd">第二章 进程和内存架构</a></li>



    
  
    
    
	

    <li><a href="#pg-e9d439ddf2f4b1db93e9eab65718aa1d">第三章 查询处理</a></li>



    
  
    
    
	

    <li><a href="#pg-d2910fe4d643465a0c1e033313ed87b0">第四章 外部数据包装器</a></li>



    
  
    
    
	

    <li><a href="#pg-0b65ca84d8bbbf7fe45a2acc95693e7e">第五章 并发控制</a></li>



    
  
    
    
	

    <li><a href="#pg-1371330787723aaa6945d377225794f0">第六章 垃圾清理过程</a></li>



    
  
    
    
	

    <li><a href="#pg-3ca993226c6ab42d101318229d3dcbb8">第七章 堆内元组与仅索引扫描</a></li>



    
  
    
    
	

    <li><a href="#pg-e086b4187addb45eb09f4a7211c9ea61">第八章 缓冲区管理器</a></li>



    
  
    
    
	

    <li><a href="#pg-d51b3c996033eb4e91b4c059656c305c">第九章 预写式日志</a></li>



    
  
    
    
	

    <li><a href="#pg-982c12de27d971f4bf42fb2127f9aa9f">第十章 基础备份与时间点恢复</a></li>



    
  
    
    
	

    <li><a href="#pg-285d7f9e5ab8ec8cef0c0d43401c9bf1">第十一章 流复制</a></li>



    
  
    
    
	

    <li><a href="#pg-cff78653f62240bfcb66183486df6554">WAL与检查点概述</a></li>



    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-92a459cc74bea527711460cc0167cd07">PG先写脏页还是先写WAL？</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2023-09-10" class="text-muted">2023年09月10日</time>
        
	</div>
	<blockquote>
<p><a href="https://mp.weixin.qq.com/s/ynwCz24bRoluVC6ILs_a8g">微信公众号原文</a></p>
</blockquote>
<p><a href="https://mp.weixin.qq.com/s/ynwCz24bRoluVC6ILs_a8g"><img src="/img/blog/hero/pg-wal-page-seq.jpg"></a></p>
<p>昨天在群里遇到一个有趣的关于 PostgreSQL 的问题：</p>
<p><em>”写脏数据页和写入WAL缓冲区的先后顺序是什么？“</em></p>
<p>我们都知道， WAL 就是 <strong>Write Ahead Log</strong> / <strong>预写式日志</strong> 的缩写，那从逻辑上说，好像是先写 WAL 再写数据页才对。</p>
<p>但其实这个问题有趣在，写入其实是发生在两个地方的：<strong>内存与磁盘</strong>。而这对这两者的写入顺序是不一样的：<strong>在内存中，先写脏数据页，再写 WAL记录。在刷盘时，先刷 WAL 记录，再刷脏数据页。</strong></p>
<p>我们可以用一个简单的例子来说明，当你执行一条 <code>INSERT</code> 时到底发生了什么？以及，数据库是如何确保这条插入的数据被正确持久化的。</p>
<hr>
<h2 id="insert的内存修改">INSERT的内存修改</h2>
<p>当你执行 INSERT 语句时（不包括前后隐含的 BEGIN / COMMIT），修改首先在内存中发生：</p>
<p>1.首先排它锁定并钉住目标数据页面，准备修改。2.进入临界区，不允许打断，出错就 PANIC。3.修改<strong>内存</strong>中的数据页面。4.将修改的内存数据页面标记为<strong>脏页</strong>。5.生成一条包含修改内容的 WAL记录 ，写入内存中的 WAL 缓冲区。6.从临界区出来，以上3个操作都是内存中的高速操作7.解锁解钉数据页面。</p>
<p>完成这些任务之后，内存中的缓冲池数据页包含了 INSERT 后的结果，WAL缓冲区中则包含了 INSERT 的 XLogRecord 操作记录。这里我们可以看出，在内存中是先写数据页，再写 WAL 的。原因其实很简单，PostgreSQL默认使用物理复制，记录的是页面内的二进制数据变化，所以只有先把数据写入页面里，才会知道具体的页面变化到底是什么。</p>
<p>内存中的操作非常快，而且这里 3 和 6 中间使用了临界区（Critical Zone），确保数据页/WAL的修改整体是原子性的。不过，内存中的修改要落到磁盘上，才算真正持久化了。所以，还会涉及到 WAL 记录与 脏数据页刷盘的问题。</p>
<p>而这里，才是 Write-Ahead 真正约束的地方：脏数据页刷盘应当晚于WAL缓冲区刷盘。</p>
<p><strong>下面是一个具体的例子，一条由单一 INSERT 语句构成的事务：</strong></p>
<blockquote>
<p>参考阅读《<a href="/zh/blog/kernel/ch9/#95-wal%E8%AE%B0%E5%BD%95%E7%9A%84%E5%86%99%E5%85%A5">PostgreSQL指南：内幕探索</a>》 9.5</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;A&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>执行上述语句时，内部函数<code>exec_simple_query()</code>会被调用，其伪代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">exec_simple_query</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#a40000">@</span><span style="color:#000">postgres</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ExtendCLOG</span><span style="color:#000;font-weight:bold">()</span>    <span style="color:#a40000">@</span><span style="color:#000">clog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>     <span style="color:#8f5902;font-style:italic">/* 将当前事务的状态&#34;IN_PROGRESS&#34;写入CLOG */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">heap_insert</span><span style="color:#000;font-weight:bold">()</span>    <span style="color:#a40000">@</span><span style="color:#000">heapam</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>    <span style="color:#8f5902;font-style:italic">/* 插入元组，创建一条XLOG记录并调用函XLogInsert. */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#000">XLogInsert</span><span style="color:#000;font-weight:bold">()</span>    <span style="color:#a40000">@</span><span style="color:#000">xlog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>     <span style="color:#8f5902;font-style:italic">/* (9.5 以及后续的版本为 xloginsert.c) */</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#8f5902;font-style:italic">/* 将插入元组的XLOG记录写入WAL缓冲区，更新页面的 pd_lsn */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">finish_xact_command</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#a40000">@</span><span style="color:#000">postgres</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>    <span style="color:#8f5902;font-style:italic">/* 执行提交 */</span>   
</span></span><span style="display:flex;"><span>      <span style="color:#000">XLogInsert</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#a40000">@</span><span style="color:#000">xlog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>              <span style="color:#8f5902;font-style:italic">/* (9.5 以及后续的版本为 xloginsert.c) */</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#8f5902;font-style:italic">/* 将该提交行为的XLOG记录写入WAL缓冲区 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#000">XLogWrite</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#a40000">@</span><span style="color:#000">xlog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>                <span style="color:#8f5902;font-style:italic">/* 将WAL缓冲区中所有的XLOG刷写入WAL段中 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">TransactionIdCommitTree</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#a40000">@</span><span style="color:#000">transam</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>    
</span></span><span style="display:flex;"><span>                            <span style="color:#8f5902;font-style:italic">/* 在CLOG中将当前事务的状态由&#34;IN_PROGRESS&#34;修改为&#34;COMMITTED&#34; /*
</span></span></span></code></pre></div><p><img alt="exec_simple_query.png" src="/zh/blog/kernel/pg-wal-page-seq/exec_simple_query.png"></p>
<ol>
<li>函数<code>ExtendCLOG()</code>将当前事务的状态<code>IN_PROGRESS</code>写入内存中的CLOG。</li>
<li>函数<code>heap_insert()</code>向共享缓冲池的目标页面中插入堆元组，创建当前页面的XLOG记录，并执行函数<code>XLogInsert()</code>。</li>
<li>函数<code>XLogInsert()</code>会将<code>heap_insert()</code>创建的XLOG记录写入WAL缓冲区<code>LSN_1</code>处，并将被修改页面的<code>pd_lsn</code>从<code>LSN_0</code>更新为<code>LSN_1</code>。</li>
<li>函数<code>finish_xact_command()</code>会在该事务被提交时被调用，用于创建该提交动作的XLOG记录，而这里的<code>XLogInsert()</code>函数会将该记录写入WAL缓冲区<code>LSN_2</code>处。</li>
<li>函数<code>XLogWrite()</code>会冲刷WAL缓冲区，并将所有内容写入WAL段文件中。如果<code>wal_sync_method</code>参数被配置为<code>open_sync</code>或<code>open_datasync</code>，记录会被同步写入（译者注：而不是提交才会刷新WAL缓冲区），因为函数会使用带有<code>O_SYNC</code>或<code>O_DSYNC</code>标记的<code>open()</code>系统调用。如果该参数被配置为<code>fsync</code>，<code>fsync_writethrough</code>，<code>fdatasync</code>，相应的系统调用就是<code>fsync()</code>，带有<code>F_FULLSYNC</code>选项的<code>fcntl()</code>，以及<code>fdatasync()</code>。无论哪一种情况，所有的XLOG记录都会被确保写入存储之中。</li>
<li>函数<code>TransactionIdCommitTree()</code>将提交日志clog中当前事务的状态从<code>IN_PROGRESS</code>更改为<code>COMMITTED</code>。</li>
</ol>
<h2 id="如何强制wal先于脏页刷盘">如何强制WAL先于脏页刷盘？</h2>
<p>那么，先刷WAL，再刷磁盘这条规则具体是怎么确保的呢？</p>
<p>每一个内存中的数据页上都保存了一个状态：最后一次对本数据页进行修改的 WAL 记录 LSN：<code>pd_lsn</code>，因此如果要把内存中的脏页刷入磁盘中，首先需要确保最后一次对这个页面进行修改的 WAL 已经被刷入磁盘中了。</p>
<p>所以我们可以在在 <code>backend/storage/buffer/bufmgr.c#FlushBuffer</code> （L3350）中看到，刷脏页的过程中会调用 <code>XLogFlush</code> 函数来确保这一点，<code>XLogFlush</code> 函数会检查当前的 WAL 刷盘位置是不是已经大于页面的 LSN，如果不是，则会推动 WAL 刷盘。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">recptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BufferGetLSN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">XLogFlush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">recptr</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>谁会刷脏页呢？主要是BGWriter与Checkpointer，但普通的后端进程也可以刷脏页。一个脏页具体是被哪个进程刷盘比较随机，大家都有机会出力，但通常来说刷脏页的主力是，后台刷盘进程 BGWriter。不管是哪个进程刷脏页，都会确保最后修改数据页的WAL已经落盘，从而满足 Write Ahead 的约束条件。</p>
<p>脏页会在什么时间被刷盘呢？首先，数据页不能被锁定，其次，数据页不能被钉住。也就是说在上面 INSERT 的例子中，只有完成步骤 7 解锁解钉数据页 后，数据页才有可能被刷盘。而这一行为是异步的，具体时间是不确定的：PostgreSQL 能提供的保证是：在下次 Checkpoint（存盘点/检查点）之前，这个脏页肯定会被刷盘。（<code>bufmgr.c</code>）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * FlushBuffer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		Physically write out a shared buffer.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * NOTE: this actually just passes the buffer contents to the kernel; the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * real write to disk won&#39;t happen until the kernel feels like it.  This
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * is okay from our point of view since we can redo the changes from WAL.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * However, we will need to force the changes to disk via fsync before
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * we can checkpoint WAL.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * The caller must hold a pin on the buffer and have share-locked the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * buffer contents.  (Note: a share-lock does not prevent updates of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * hint bits in the buffer, so the page could change while the write
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * is in progress, but we assume that that will not invalidate the data
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * written.)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * If the caller has an smgr reference for the buffer&#39;s relation, pass it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * as the second parameter.  If not, pass NULL.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FlushBuffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BufferDesc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SMgrRelation</span> <span style="color:#000">reln</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IOObject</span> <span style="color:#000">io_object</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">IOContext</span> <span style="color:#000">io_context</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">XLogRecPtr</span>	<span style="color:#000">recptr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ErrorContextCallback</span> <span style="color:#000">errcallback</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">instr_time</span>	<span style="color:#000">io_start</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Block</span>		<span style="color:#000">bufBlock</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">char</span>	   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bufToWrite</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint32</span>		<span style="color:#000">buf_state</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* ... */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">recptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BufferGetLSN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* To check if block content changes while flushing. - vadim 01/17/97 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">buf_state</span> <span style="color:#ce5c00;font-weight:bold">&amp;=</span> <span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#000">BM_JUST_DIRTIED</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UnlockBufHdr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buf_state</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * Force XLOG flush up to buffer&#39;s LSN.  This implements the basic WAL
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * rule that log updates must hit disk before any of the data-file changes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * they describe do.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * However, this rule does not apply to unlogged relations, which will be
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * lost after a crash anyway.  Most unlogged relation pages do not bear
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * LSNs since we never emit WAL records for them, and therefore flushing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * up through the buffer LSN would be useless, but harmless.  However,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * GiST indexes use LSNs internally to track page-splits, and therefore
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * unlogged GiST pages bear &#34;fake&#34; LSNs generated by
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * GetFakeLSNForUnloggedRel.  It is unlikely but possible that the fake
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * LSN counter could advance past the WAL insertion point; and if it did
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * happen, attempting to flush WAL through that location would fail, with
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * disastrous system-wide consequences.  To make sure that can&#39;t happen,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * skip the flush if the buffer isn&#39;t permanent.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf_state</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">BM_PERMANENT</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">XLogFlush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">recptr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* ... */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="wal是如何刷盘的">WAL是如何刷盘的？</h2>
<p>我们已经知道了，刷脏数据页这件事通常是异步进行的，且肯定晚于对应的 WAL 记录刷盘。那么新的问题就是，WAL 是由谁在什么时间点来刷盘的呢：从内存中的 WAL 缓冲区刷入磁盘中？</p>
<p>要回答这个问题，首先要理解 WAL 的模型。WAL 在逻辑上是一个长度无限的文件，任何一个<strong>改变数据库系统状态的操作</strong>，都会生成相应的 XLogRecord，即 WAL记录。每一条 WAL 记录都会使用其起始位置的文件偏移量作为自己的唯一标识符，即 LSN（逻辑日志位点）。</p>
<p><img src="/img/blog/kernel/fig-9-09.png"></p>
<p>各种各样修改系统状态的行为都会产生 WAL记录：例如 BEGIN 有一条 WAL记录，INSERT 有一条 WAL记录，COMMIT 也有一条WAL记录，而WAL记录会首先被写入内存中的 WAL缓冲区（最大16MB）。</p>
<p>PostgreSQL 支持多个客户端并发修改，所以同一时刻会有各种进程往内存中的 WAL缓冲区（最大16MB）写东西。所以不同进程、不同事务产生的 XLogRecord 会在同一个逻辑文件中相互交织。每次写入都是原子性的，一条记录一条记录的写。</p>
<p>内存里的WAL缓冲区中的内容，会被各种进程写入/刷入持久化磁盘上的WAL文件里。当前写入内存WAL缓冲区的逻辑日志位置点称作 INSERT LSN。写入操作系统缓冲区的日志位点叫 WRITE LSN，已经使用 FSYNC 之类的 API 确保已经成功持久化的日志位点叫 FLUSH LSN。这里面的关系是 INSERT_LSN &gt;= WRITE_LSN &gt;= FLUSH_LSN。原理很简单：内存中的东西最新，写入可能稍微滞后些，刷盘则可能比写入更滞后一些。</p>
<p>刷盘的主力是 WAL Writer 进程，但其实各种进程都可以刷写。刷盘靠 <code>XLogFlush</code> 函数 （backend/access/transam/xlog.c#XLogFlush），这里的逻辑很简单，就是指定一个位置点，把这个位置点及之前的 WAL 从缓冲区全刷至磁盘。具体的实现逻辑是死循环抢自旋锁，如果目标 LSN 已经被别的进程刷盘了就退出循环，否则就亲自上阵把 WAL 日志刷盘到指定位点。（<code>xlog.c</code>）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * Ensure that all XLOG data through the given position is flushed to disk.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * NOTE: this differs from XLogWrite mainly in that the WALWriteLock is not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * already held, and we try to avoid acquiring it if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span>
</span></span><span style="display:flex;"><span><span style="color:#000">XLogFlush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">XLogRecPtr</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">XLogRecPtr</span>	<span style="color:#000">WriteRqstPtr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">XLogwrtRqst</span> <span style="color:#000">WriteRqst</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TimeLineID</span>	<span style="color:#000">insertTLI</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">XLogCtl</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">InsertTimeLineID</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * During REDO, we are reading not writing WAL.  Therefore, instead of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * trying to flush the WAL, we should update minRecoveryPoint instead. We
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * test XLogInsertAllowed(), not InRecovery, because we need checkpointer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * to act this way too, and because when it tries to write the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * end-of-recovery checkpoint, it should indeed flush.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">XLogInsertAllowed</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">UpdateMinRecoveryPoint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">record</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">false</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* Quick exit if already known flushed */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">record</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">LogwrtResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flush</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">START_CRIT_SECTION</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * Since fsync is usually a horribly expensive operation, we try to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * piggyback as much data as we can on each fsync: if we see any more data
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * entered into the xlog buffer, we&#39;ll write and fsync that too, so that
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * the final value of LogwrtResult.Flush is as large as possible. This
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * gives us some chance of avoiding another fsync immediately after.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* initialize to given target; may increase below */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">WriteRqstPtr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * Now wait until we get the write lock, or someone else does the flush
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * for us.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;;)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">/* ... */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">END_CRIT_SECTION</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* wake up walsenders now that we&#39;ve released heavily contended locks */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">WalSndWakeupProcessRequests</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">RecoveryInProgress</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * If we still haven&#39;t flushed to the request point then we have a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * problem; most likely, the requested flush point is past end of XLOG.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * This has been seen to occur when a disk page has a corrupted LSN.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * Formerly we treated this as a PANIC condition, but that hurts the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * system&#39;s robustness rather than helping it: we do not want to take down
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * the whole system due to corruption on one data page.  In particular, if
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * the bad page is encountered again during recovery then we would be
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * unable to restart the database at all!  (This scenario actually
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * happened in the field several times with 7.1 releases.)	As of 8.4, bad
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * LSNs encountered during recovery are UpdateMinRecoveryPoint&#39;s problem;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * the only time we can reach here during recovery is while flushing the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * end-of-recovery checkpoint record, and we don&#39;t expect that to have a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * bad LSN.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * Note that for calls from xact.c, the ERROR will be promoted to PANIC
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * since xact.c calls this routine inside a critical section.  However,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * calls from bufmgr.c are not within critical sections and so we will not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * force a restart for a bad LSN on a data page.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">LogwrtResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flush</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">elog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ERROR</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			 <span style="color:#4e9a06">&#34;xlog flush request %X/%X is not satisfied --- flushed only to %X/%X&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			 <span style="color:#000">LSN_FORMAT_ARGS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">record</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>			 <span style="color:#000">LSN_FORMAT_ARGS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">LogwrtResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flush</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="关于内核原理">关于内核原理</h2>
<p>关于 PostgreSQL 的内核原理，我认为有几个学习材料非常值得参考。</p>
<p>第一本是《PG Internal》，鈴木啓修写的，基于 PostgreSQL 9.6 与 11 的代码，讲解PG内核原理。我之前翻译了中文版《PostgreSQL指南：内部探索》。第二本是 《PostgreSQL 14 Internal》，是俄罗斯 Postgres Pro 公司 Egor Rogov 写的，基于 PostgreSQL 14 进行架构讲解。</p>
<p>当然我认为最有学习价值的还是 PostgreSQL 源代码，特别是源代码中的 README，比如本文中的这个问题，就在事务管理器源码 README 中详细介绍了。PostgreSQL 的源代码是自我解释的，你只需要懂英文大致就能理解这里面的逻辑。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">The</span> <span style="color:#000">general</span> <span style="color:#000">schema</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">executing</span> <span style="color:#000">a</span> <span style="color:#000">WAL</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">logged</span> <span style="color:#000">action</span> <span style="color:#000">is</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1.</span> <span style="color:#000">Pin</span> <span style="color:#000">and</span> <span style="color:#000">exclusive</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">lock</span> <span style="color:#000">the</span> <span style="color:#000">shared</span> <span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">containing</span> <span style="color:#000">the</span> <span style="color:#000">data</span> <span style="color:#000">page</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">to</span> <span style="color:#000">be</span> <span style="color:#000">modified</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">2.</span> <span style="color:#000">START_CRIT_SECTION</span><span style="color:#000;font-weight:bold">()</span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">Any</span> <span style="color:#000">error</span> <span style="color:#000">during</span> <span style="color:#000">the</span> <span style="color:#000">next</span> <span style="color:#000">three</span> <span style="color:#000">steps</span> <span style="color:#000">must</span> <span style="color:#000">cause</span> <span style="color:#000">a</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PANIC</span> <span style="color:#000">because</span> <span style="color:#000">the</span> <span style="color:#000">shared</span> <span style="color:#000">buffers</span> <span style="color:#000">will</span> <span style="color:#000">contain</span> <span style="color:#000">unlogged</span> <span style="color:#000">changes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">which</span> <span style="color:#000">we</span>
</span></span><span style="display:flex;"><span><span style="color:#000">have</span> <span style="color:#000">to</span> <span style="color:#000">ensure</span> <span style="color:#000">don</span><span style="color:#a40000">&#39;</span><span style="color:#000">t</span> <span style="color:#000">get</span> <span style="color:#000">to</span> <span style="color:#000">disk</span><span style="color:#000;font-weight:bold">.</span>  <span style="color:#000">Obviously</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">you</span> <span style="color:#000">should</span> <span style="color:#000">check</span> <span style="color:#000">conditions</span>
</span></span><span style="display:flex;"><span><span style="color:#000">such</span> <span style="color:#000">as</span> <span style="color:#000">whether</span> <span style="color:#000">there</span><span style="color:#a40000">&#39;</span><span style="color:#000">s</span> <span style="color:#000">enough</span> <span style="color:#000">free</span> <span style="color:#000">space</span> <span style="color:#000">on</span> <span style="color:#000">the</span> <span style="color:#000">page</span> <span style="color:#000">before</span> <span style="color:#000">you</span> <span style="color:#000">start</span> <span style="color:#000">the</span>
</span></span><span style="display:flex;"><span><span style="color:#000">critical</span> <span style="color:#000">section</span><span style="color:#000;font-weight:bold">.)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">3.</span> <span style="color:#000">Apply</span> <span style="color:#000">the</span> <span style="color:#000">required</span> <span style="color:#000">changes</span> <span style="color:#000">to</span> <span style="color:#000">the</span> <span style="color:#000">shared</span> <span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">4.</span> <span style="color:#000">Mark</span> <span style="color:#000">the</span> <span style="color:#000">shared</span> <span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">as</span> <span style="color:#000">dirty</span> <span style="color:#000">with</span> <span style="color:#000">MarkBufferDirty</span><span style="color:#000;font-weight:bold">().</span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">This</span> <span style="color:#000">must</span>
</span></span><span style="display:flex;"><span><span style="color:#000">happen</span> <span style="color:#000">before</span> <span style="color:#000">the</span> <span style="color:#000">WAL</span> <span style="color:#000">record</span> <span style="color:#000">is</span> <span style="color:#000">inserted</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">see</span> <span style="color:#000">notes</span> <span style="color:#000">in</span> <span style="color:#000">SyncOneBuffer</span><span style="color:#000;font-weight:bold">().)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Note</span> <span style="color:#000">that</span> <span style="color:#000">marking</span> <span style="color:#000">a</span> <span style="color:#000">buffer</span> <span style="color:#000">dirty</span> <span style="color:#000">with</span> <span style="color:#000">MarkBufferDirty</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">should</span> <span style="color:#000">only</span>
</span></span><span style="display:flex;"><span><span style="color:#000">happen</span> <span style="color:#000">iff</span> <span style="color:#000">you</span> <span style="color:#000">write</span> <span style="color:#000">a</span> <span style="color:#000">WAL</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">see</span> <span style="color:#000">Writing</span> <span style="color:#000">Hints</span> <span style="color:#000">below</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">5.</span> <span style="color:#000">If</span> <span style="color:#000">the</span> <span style="color:#000">relation</span> <span style="color:#000">requires</span> <span style="color:#000">WAL</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">logging</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000">a</span> <span style="color:#000">WAL</span> <span style="color:#000">record</span> <span style="color:#000">using</span>
</span></span><span style="display:flex;"><span><span style="color:#000">XLogBeginInsert</span> <span style="color:#000">and</span> <span style="color:#000">XLogRegister</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">functions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">and</span> <span style="color:#000">insert</span> <span style="color:#000">it</span><span style="color:#000;font-weight:bold">.</span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">See</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;Constructing a WAL record&#34;</span> <span style="color:#000">below</span><span style="color:#000;font-weight:bold">).</span>  <span style="color:#000">Then</span> <span style="color:#000">update</span> <span style="color:#000">the</span> <span style="color:#000">page</span><span style="color:#a40000">&#39;</span><span style="color:#000">s</span> <span style="color:#000">LSN</span> <span style="color:#000">using</span> <span style="color:#000">the</span>
</span></span><span style="display:flex;"><span><span style="color:#000">returned</span> <span style="color:#000">XLOG</span> <span style="color:#000">location</span><span style="color:#000;font-weight:bold">.</span>  <span style="color:#000">For</span> <span style="color:#000">instance</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">XLogBeginInsert</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">XLogRegisterBuffer</span><span style="color:#000;font-weight:bold">(...)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">XLogRegisterData</span><span style="color:#000;font-weight:bold">(...)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">recptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">XLogInsert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rmgr_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">info</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">PageSetLSN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">recptr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">6.</span> <span style="color:#000">END_CRIT_SECTION</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">7.</span> <span style="color:#000">Unlock</span> <span style="color:#000">and</span> <span style="color:#000">unpin</span> <span style="color:#000">the</span> <span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">Complex</span> <span style="color:#000">changes</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">such</span> <span style="color:#000">as</span> <span style="color:#000">a</span> <span style="color:#000">multilevel</span> <span style="color:#000">index</span> <span style="color:#000">insertion</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">normally</span> <span style="color:#000">need</span> <span style="color:#000">to</span> <span style="color:#000">be</span>
</span></span><span style="display:flex;"><span><span style="color:#000">described</span> <span style="color:#000">by</span> <span style="color:#000">a</span> <span style="color:#000">series</span> <span style="color:#000">of</span> <span style="color:#000">atomic</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">action</span> <span style="color:#000">WAL</span> <span style="color:#000">records</span><span style="color:#000;font-weight:bold">.</span>  <span style="color:#000">The</span> <span style="color:#000">intermediate</span> <span style="color:#000">states</span>
</span></span><span style="display:flex;"><span><span style="color:#000">must</span> <span style="color:#000">be</span> <span style="color:#000">self</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">consistent</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">so</span> <span style="color:#000">that</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">the</span> <span style="color:#000">replay</span> <span style="color:#000">is</span> <span style="color:#000">interrupted</span> <span style="color:#000">between</span> <span style="color:#000">any</span>
</span></span><span style="display:flex;"><span><span style="color:#000">two</span> <span style="color:#000">actions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">the</span> <span style="color:#000">system</span> <span style="color:#000">is</span> <span style="color:#000">fully</span> <span style="color:#000">functional</span><span style="color:#000;font-weight:bold">.</span>  <span style="color:#000">In</span> <span style="color:#000">btree</span> <span style="color:#000">indexes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">example</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000">a</span> <span style="color:#000">page</span> <span style="color:#000">split</span> <span style="color:#000">requires</span> <span style="color:#000">a</span> <span style="color:#000">new</span> <span style="color:#000">page</span> <span style="color:#000">to</span> <span style="color:#000">be</span> <span style="color:#000">allocated</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">and</span> <span style="color:#000">an</span> <span style="color:#000">insertion</span> <span style="color:#000">of</span> <span style="color:#000">a</span> <span style="color:#000">new</span>
</span></span><span style="display:flex;"><span><span style="color:#000">key</span> <span style="color:#000">in</span> <span style="color:#000">the</span> <span style="color:#000">parent</span> <span style="color:#000">btree</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">but</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">locking</span> <span style="color:#000">reasons</span> <span style="color:#000">this</span> <span style="color:#000">has</span> <span style="color:#000">to</span> <span style="color:#000">be</span>
</span></span><span style="display:flex;"><span><span style="color:#000">reflected</span> <span style="color:#000">by</span> <span style="color:#000">two</span> <span style="color:#000">separate</span> <span style="color:#000">WAL</span> <span style="color:#000">records</span><span style="color:#000;font-weight:bold">.</span>  <span style="color:#000">Replaying</span> <span style="color:#000">the</span> <span style="color:#000">first</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">to</span>
</span></span><span style="display:flex;"><span><span style="color:#000">allocate</span> <span style="color:#000">the</span> <span style="color:#000">new</span> <span style="color:#000">page</span> <span style="color:#000">and</span> <span style="color:#000">move</span> <span style="color:#000">tuples</span> <span style="color:#000">to</span> <span style="color:#000">it</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sets</span> <span style="color:#000">a</span> <span style="color:#000">flag</span> <span style="color:#000">on</span> <span style="color:#000">the</span> <span style="color:#000">page</span> <span style="color:#000">to</span>
</span></span><span style="display:flex;"><span><span style="color:#000">indicate</span> <span style="color:#000">that</span> <span style="color:#000">the</span> <span style="color:#000">key</span> <span style="color:#000">has</span> <span style="color:#000">not</span> <span style="color:#000">been</span> <span style="color:#000">inserted</span> <span style="color:#000">to</span> <span style="color:#000">the</span> <span style="color:#000">parent</span> <span style="color:#000">yet</span><span style="color:#000;font-weight:bold">.</span>  <span style="color:#000">Replaying</span> <span style="color:#000">the</span>
</span></span><span style="display:flex;"><span><span style="color:#000">second</span> <span style="color:#000">record</span> <span style="color:#000">clears</span> <span style="color:#000">the</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span>  <span style="color:#000">This</span> <span style="color:#000">intermediate</span> <span style="color:#000">state</span> <span style="color:#000">is</span> <span style="color:#000">never</span> <span style="color:#000">seen</span> <span style="color:#000">by</span>
</span></span><span style="display:flex;"><span><span style="color:#000">other</span> <span style="color:#000">backends</span> <span style="color:#000">during</span> <span style="color:#000">normal</span> <span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">because</span> <span style="color:#000">the</span> <span style="color:#000">lock</span> <span style="color:#000">on</span> <span style="color:#000">the</span> <span style="color:#000">child</span> <span style="color:#000">page</span>
</span></span><span style="display:flex;"><span><span style="color:#000">is</span> <span style="color:#000">held</span> <span style="color:#000">across</span> <span style="color:#000">the</span> <span style="color:#000">two</span> <span style="color:#000">actions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">but</span> <span style="color:#000">will</span> <span style="color:#000">be</span> <span style="color:#000">seen</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">the</span> <span style="color:#000">operation</span> <span style="color:#000">is</span>
</span></span><span style="display:flex;"><span><span style="color:#000">interrupted</span> <span style="color:#000">before</span> <span style="color:#000">writing</span> <span style="color:#000">the</span> <span style="color:#000">second</span> <span style="color:#000">WAL</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">.</span>  <span style="color:#000">The</span> <span style="color:#000">search</span> <span style="color:#000">algorithm</span> <span style="color:#000">works</span>
</span></span><span style="display:flex;"><span><span style="color:#000">with</span> <span style="color:#000">the</span> <span style="color:#000">intermediate</span> <span style="color:#000">state</span> <span style="color:#000">as</span> <span style="color:#000">normal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">but</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">an</span> <span style="color:#000">insertion</span> <span style="color:#000">encounters</span> <span style="color:#000">a</span> <span style="color:#000">page</span>
</span></span><span style="display:flex;"><span><span style="color:#000">with</span> <span style="color:#000">the</span> <span style="color:#000">incomplete</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">split</span> <span style="color:#000">flag</span> <span style="color:#000">set</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">it</span> <span style="color:#000">will</span> <span style="color:#000">finish</span> <span style="color:#000">the</span> <span style="color:#000">interrupted</span> <span style="color:#000">split</span> <span style="color:#000">by</span>
</span></span><span style="display:flex;"><span><span style="color:#000">inserting</span> <span style="color:#000">the</span> <span style="color:#000">key</span> <span style="color:#000">to</span> <span style="color:#000">the</span> <span style="color:#000">parent</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">before</span> <span style="color:#000">proceeding</span><span style="color:#000;font-weight:bold">.</span>
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-f6eaf5921bd3dfe2f779402ea0a878a7">第一章 数据库的物理/逻辑结构</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://www.interdb.jp/pg/">Hironobu SUZUKI</a> ，译者：<a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-01-11" class="text-muted">2018年01月11日</time>
        
	</div>
	<p>第一章和第二章简单介绍了一些PostgreSQL的基础知识，有助于读者理解后续章节的内容。本章包括以下几个主题：</p>
<ul>
<li><strong>数据库集簇（database cluster）</strong> 的逻辑结构</li>
<li>数据库集簇的物理结构</li>
<li><strong>堆表（heap table）</strong> 文件的内部布局</li>
<li>从表中读写数据的方式</li>
</ul>
<p>如果你已经熟悉这些内容，可以跳过本章。</p>
<h2 id="11-数据库集簇的逻辑结构">1.1 数据库集簇的逻辑结构</h2>
<p><strong>数据库集簇（database cluster）</strong> 是一组 <strong>数据库（database）</strong> 的集合，由一个PostgreSQL服务器管理。第一次听到这个定义也许会令人疑惑，PostgreSQL中的术语“数据库集簇”，<strong>并非</strong> 意味着“一组数据库服务器”。 一个PostgreSQL服务器只会在单机上运行并管理单个数据库集簇。</p>
<p>图1.1展示了一个数据库集簇的逻辑结构。 <strong>数据库（database）</strong> 是 <strong>数据库对象（database objects）</strong> 的集合。 在关系型数据库理论中，数据库对象是用于存储或引用数据的数据结构。 （堆）表是一个典型的例子，还有更多种对象，例如索引，序列，视图，函数等。 在PostgreSQL中数据库本身也是数据库对象，并在逻辑上彼此分离。 所有其他的数据库对象（例如表，索引等）归属于各自相应的数据库。</p>
<p><strong>图1.1 数据库集簇的逻辑结构</strong></p>
<p><img src="/img/blog/kernel/fig-1-01.png"></p>
<p>在PostgreSQL内部，所有的数据库对象都通过相应的 <strong>对象标识符（Object Identifiers, OID）</strong> 进行管理，这些标识符是无符号的4字节整型。数据库对象与相应OID之间的关系存储在相应的<a href="https://www.postgresql.org/docs/current/static/catalogs.html"><strong>系统目录</strong></a>中，依具体的对象类型而异。 例如数据库和堆表对象的OID分别存储在<code>pg_database</code>和<code>pg_class</code>中，因此当你希望找出OID时，可以执行以下查询：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">sampledb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_database</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;sampledb&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">  
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------+-------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sampledb</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">sampledb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;sampletbl&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">  
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------+-------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sampletbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">18740</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="12-数据库集簇的物理结构">1.2 数据库集簇的物理结构</h2>
<p>数据库集簇在本质上就是一个文件目录，名曰 <strong>基础目录（base directory）</strong> ，包含着一系列子目录与文件。 执行 <a href="https://www.postgresql.org/docs/current/static/app-initdb.html"><code>initdb</code></a> 命令会在指定目录下创建基础目录从而初始化一个新的数据库集簇。 通常会将基础目录的路径配置到环境变量<code>PGDATA</code>中，但这并不是必须的。</p>
<p>图1.2 展示了一个PostgreSQL数据库集簇的例子。 <code>base</code>子目录中的每一个子目录都对应一个数据库，数据库中每个表和索引都会在相应子目录下存储为（至少）一个文件；还有几个包含特定数据的子目录，以及配置文件。 虽然PostgreSQL支持<strong>表空间（Tablespace）</strong>，但该术语的含义与其他RDBMS不同。 PostgreSQL中的表空间对应一个包含基础目录之外数据的目录。</p>
<p><strong>图1.2 数据库集簇示例</strong></p>
<p><img src="/img/blog/kernel/fig-1-02.png"></p>
<p>后续小节将描述数据库集簇的布局，数据库的布局，表和索引对应的文件布局，以及PostgreSQL中表空间的布局。</p>
<h3 id="121-数据库集簇的布局">1.2.1 数据库集簇的布局</h3>
<p><a href="https://www.postgresql.org/docs/current/static/storage-file-layout.html">官方文档</a>中描述了数据库集簇的布局。 表1.1中列出了主要的文件与子目录：</p>
<p><strong>表 1.1 基本目录下的数据库文件和子目录的布局（参考官方文档）</strong></p>
<table>
<thead>
<tr>
<th>文件</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PG_VERSION</code></td>
<td>包含PostgreSQL主版本号</td>
</tr>
<tr>
<td><code>pg_hba.conf</code></td>
<td>控制PosgreSQL客户端认证</td>
</tr>
<tr>
<td><code>pg_ident.conf</code></td>
<td>控制PostgreSQL用户名映射</td>
</tr>
<tr>
<td><code>postgresql.conf</code></td>
<td>配置参数</td>
</tr>
<tr>
<td><code>postgresql.auto.conf</code></td>
<td>存储使用<code>ALTER SYSTEM</code>修改的配置参数（9.4或更新版本）</td>
</tr>
<tr>
<td><code>postmaster.opts</code></td>
<td>记录服务器上次启动的命令行选项</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>子目录</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>base/</code></td>
<td>每个数据库对应的子目录存储于此</td>
</tr>
<tr>
<td><code>global/</code></td>
<td>数据库集簇范畴的表（例如<code>pg_database</code>），以及<code>pg_control</code>文件。</td>
</tr>
<tr>
<td><code>pg_commit_ts/</code></td>
<td>事务提交的时间戳数据（9.5及更新版本）。</td>
</tr>
<tr>
<td><code>pg_clog/ (9.6-)</code></td>
<td>事务提交状态数据（9.6及更老版本），在版本10中被重命名为<code>pg_xact</code>。CLOG将在<a href="/zh/blog/kernel/ch5/">5.4节</a>中描述</td>
</tr>
<tr>
<td><code>pg_dynshmem/</code></td>
<td>动态共享内存子系统中使用的文件（9.4或更新版本）。</td>
</tr>
<tr>
<td><code>pg_logical/</code></td>
<td>逻辑解码的状态数据（9.4或更新版本）。</td>
</tr>
<tr>
<td><code>pg_multixact/</code></td>
<td>多事务状态数据</td>
</tr>
<tr>
<td><code>pg_notify/</code></td>
<td><code>LISTEN</code>/<code>NOTIFY</code>状态数据</td>
</tr>
<tr>
<td><code>pg_repslot/</code></td>
<td>复制槽数据（9.4或更新版本）。</td>
</tr>
<tr>
<td><code>pg_serial/</code></td>
<td>已提交的可串行化事务相关信息（9.1或更新版本）</td>
</tr>
<tr>
<td><code>pg_snapshots/</code></td>
<td>导出快照（9.2或更新版本）。 PostgreSQL函数<code>pg_export_snapshot</code>在此子目录中创建快照信息文件。</td>
</tr>
<tr>
<td><code>pg_stat/</code></td>
<td>统计子系统的永久文件</td>
</tr>
<tr>
<td><code>pg_stat_tmp/</code></td>
<td>统计子系统的临时文件</td>
</tr>
<tr>
<td><code>pg_subtrans/</code></td>
<td>子事务状态数据</td>
</tr>
<tr>
<td><code>pg_tblspc/</code></td>
<td>指向表空间的符号链接</td>
</tr>
<tr>
<td><code>pg_twophase/</code></td>
<td>两阶段事务（prepared transactions）的状态文件</td>
</tr>
<tr>
<td><code>pg_wal/ (10+)</code></td>
<td>WAL（ Write Ahead Logging）段文件（10或更新版本），从<code>pg_xlog</code>重命名而来。</td>
</tr>
<tr>
<td><code>pg_xact/ (10+)</code></td>
<td>事务提交状态数据，（10或更新版本），从<code>pg_clog</code>重命名而来。CLOG将在<a href="/zh/blog/kernel/ch5/">5.4节</a>中描述。</td>
</tr>
<tr>
<td>pg_xlog/ (9.6-)</td>
<td><strong>WAL（Write Ahead Logging）</strong> 段文件（9.6及更老版本），它在版本10中被重命名为<code>pg_wal</code>。</td>
</tr>
</tbody>
</table>
<h3 id="122-数据库布局">1.2.2 数据库布局</h3>
<p>一个数据库与<code>base</code>子目录下的一个子目录对应；且该子目录的名称与相应数据库的OID相同。 例如当数据库<code>sampledb</code>的OID为16384时，它对应的子目录名称即为16384。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#204a87">cd</span> <span style="color:#000">$PGDATA</span>
</span></span><span style="display:flex;"><span>$ ls -ld base/16384
</span></span><span style="display:flex;"><span>drwx------  <span style="color:#0000cf;font-weight:bold">213</span> postgres postgres  <span style="color:#0000cf;font-weight:bold">7242</span>  <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">26</span> 16:33 <span style="color:#0000cf;font-weight:bold">16384</span>
</span></span></code></pre></div><h3 id="123-表与索引相关文件的布局">1.2.3 表与索引相关文件的布局</h3>
<p>每个小于1GB的表或索引都在相应的数据库目录中存储为单个文件。在数据库内部，表和索引作为数据库对象是通过OID来管理的，而这些数据文件则由变量<code>relfilenode</code>管理。 表和索引的<code>relfilenode</code>值通常与其OID一致，但也有例外，下面将详细展开。</p>
<p>让我们看一看表<code>sampletbl</code>的<code>oid</code>和<code>relfilenode</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">sampledb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relfilenode</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;sampletbl&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relfilenode</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------+-------+-------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sampletbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">18740</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">18740</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>从上面的结果可以看出<code>oid</code>和<code>relfilenode</code>值相等。还可以看到表<code>sampletbl</code>的数据文件路径是<code>base/16384/18740</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#204a87">cd</span> <span style="color:#000">$PGDATA</span>
</span></span><span style="display:flex;"><span>$ ls -la base/16384/18740
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#0000cf;font-weight:bold">1</span> postgres postgres <span style="color:#0000cf;font-weight:bold">8192</span> Apr <span style="color:#0000cf;font-weight:bold">21</span> 10:21 base/16384/18740
</span></span></code></pre></div><p>表和索引的<code>relfilenode</code>值会被一些命令（例如<code>TRUNCATE</code>，<code>REINDEX</code>，<code>CLUSTER</code>）所改变。 例如对表 <code>sampletbl</code>执行<code>TRUNCATE</code>，PostgreSQL会为表分配一个新的<code>relfilenode</code>（18812），删除旧的数据文件（18740），并创建一个新的数据文件（18812）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">sampledb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRUNCATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sampletbl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">TRUNCATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">sampledb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relfilenode</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;sampletbl&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relfilenode</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------+-------+-------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sampletbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">18740</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">18812</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><blockquote>
<p>在9.0或更高版本中，内建函数<code>pg_relation_filepath</code>能够根据OID或名称返回关系对应的文件路径，非常实用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">sampledb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_relation_filepath</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;sampletbl&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">pg_relation_filepath</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">18812</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></blockquote>
<p>当表和索引的文件大小超过1GB时，PostgreSQL会创建并使用一个名为<code>relfilenode.1</code>的新文件。如果新文件也填满了，则会创建下一个名为<code>relfilenode.2</code>的新文件，依此类推。</p>
<blockquote>
<p>译者注：数据库系统中的 <strong>表（Table）</strong> 与关系代数中的 <strong>关系（Relation）</strong> 关系紧密但又不尽相同。在PostgreSQL中，表，索引，TOAST表都归类为关系。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#a40000">$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cd</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#000">PGDATA</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ls</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">la</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">h</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">base</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">19427</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">rw</span><span style="color:#8f5902;font-style:italic">------- 1 postgres postgres 1.0G  Apr  21 11:16 data/base/16384/19427
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">rw</span><span style="color:#8f5902;font-style:italic">------- 1 postgres postgres  45M  Apr  21 11:20 data/base/16384/19427.1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><blockquote>
<p>在构建PostgreSQL时，可以使用配置选项<code>--with-segsize</code>更改表和索引的最大文件大小。</p>
</blockquote>
<p>仔细观察数据库子目录就会发现，每个表都有两个与之相关联的文件，后缀分别为<code>_fsm</code>和<code>_vm</code>。这些实际上是<strong>空闲空间映射（free space map）<strong>和</strong>可见性映射（visibility map）</strong> 文件，分别存储了表文件每个页面上的空闲空间信息与可见性信息（更多细节见<a href="/zh/blog/kernel/ch5/">第5.3.4节</a>和<a href="/zh/blog/kernel/ch6/">第6.2节</a>）。索引没有可见性映射文件，只有空闲空间映射文件。</p>
<p>一个具体的示例如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#204a87">cd</span> <span style="color:#000">$PGDATA</span>
</span></span><span style="display:flex;"><span>$ ls -la base/16384/18751*
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#0000cf;font-weight:bold">1</span> postgres postgres  <span style="color:#0000cf;font-weight:bold">8192</span> Apr <span style="color:#0000cf;font-weight:bold">21</span> 10:21 base/16384/18751
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#0000cf;font-weight:bold">1</span> postgres postgres <span style="color:#0000cf;font-weight:bold">24576</span> Apr <span style="color:#0000cf;font-weight:bold">21</span> 10:18 base/16384/18751_fsm
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#0000cf;font-weight:bold">1</span> postgres postgres  <span style="color:#0000cf;font-weight:bold">8192</span> Apr <span style="color:#0000cf;font-weight:bold">21</span> 10:18 base/16384/18751_vm
</span></span></code></pre></div><p>在数据库系统内部，这些文件（主体数据文件，空闲空间映射文件，可见性映射文件等）也被称为相应关系的 <strong>分支（fork）</strong> ；空闲空间映射是表/索引数据文件的第一个分支（分支编号为1），可见性映射表是数据文件的第二个分支（分支编号为2），数据文件的分支编号为0。</p>
<blockquote>
<p>译者注：每个 <strong>关系（relation）</strong> 可能会有四种分支，分支编号分别为0，1，2，3，0号分支<code>main</code>为关系数据文件本体，1号分支<code>fsm</code>保存了<code>main</code>分支中空闲空间的信息，2号分支<code>vm</code>保存了<code>main</code>分支中可见性的信息，3号分支<code>init</code>是很少见的特殊分支，通常用于不被日志记录（unlogged）的表与索引。</p>
<p>每个分支都会被存储为磁盘上的一到多个文件：PostgreSQL会将过大的分支文件切分为若干个段，以免文件的尺寸超过某些特定文件系统允许的大小，也便于一些归档工具进行并发复制，默认的段大小为1GB。</p>
</blockquote>
<h3 id="124-表空间">1.2.4 表空间</h3>
<p>PostgreSQL中的 <strong>表空间（Tablespace）</strong> 是基础目录之外的附加数据区域。 在8.0版本中引入了该功能。</p>
<p>图1.3展示了表空间的内部布局，以及表空间与主数据区域的关系。</p>
<p><strong>图 1.3 数据库集簇的表空间</strong></p>
<p><img src="/img/blog/kernel/fig-1-03.png"></p>
<p>执行<a href="https://www.postgresql.org/docs/current/static/sql-createtablespace.html"><code>CREATE TABLESPACE</code></a>语句会在指定的目录下创建表空间。而在该目录下还会创建版本特定的子目录（例如<code>PG_9.4_201409291</code>）。版本特定的命名方式为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>PG_主版本号_目录版本号
</span></span></code></pre></div><p>举个例子，如果在<code>/home/postgres/tblspc</code>中创建一个表空间<code>new_tblspc</code>，其oid为16386，则会在表空间下创建一个名如<code>PG_9.4_201409291</code>的子目录。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls -l /home/postgres/tblspc/
</span></span><span style="display:flex;"><span>total <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>drwx------ <span style="color:#0000cf;font-weight:bold">2</span> postgres postgres <span style="color:#0000cf;font-weight:bold">4096</span> Apr <span style="color:#0000cf;font-weight:bold">21</span> 10:08 PG_9.4_201409291
</span></span></code></pre></div><p>表空间目录通过<code>pg_tblspc</code>子目录中的符号链接寻址，链接名称与表空间的OID值相同。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ ls -l $PGDATA/pg_tblspc/
</span></span><span style="display:flex;"><span>total 0
</span></span><span style="display:flex;"><span>lrwxrwxrwx 1 postgres postgres 21 Apr 21 10:08 16386 -&gt; /home/postgres/tblspc
</span></span></code></pre></div><p>如果在该表空间下创建新的数据库（OID为16387），则会在版本特定的子目录下创建相应目录。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls -l /home/postgres/tblspc/PG_9.4_201409291/
</span></span><span style="display:flex;"><span>total <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>drwx------ <span style="color:#0000cf;font-weight:bold">2</span> postgres postgres <span style="color:#0000cf;font-weight:bold">4096</span> Apr <span style="color:#0000cf;font-weight:bold">21</span> 10:10 <span style="color:#0000cf;font-weight:bold">16387</span>
</span></span></code></pre></div><p>如果在该表空间内创建一个新表，但新表所属的数据库却创建在基础目录下，那么PG会首先在版本特定的子目录下创建名称与现有数据库OID相同的新目录，然后将新表文件放置在刚创建的目录下。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">sampledb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">newtbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(.....)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TABLESPACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new_tblspc</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">sampledb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_relation_filepath</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;newtbl&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">pg_relation_filepath</span><span style="color:#f8f8f8;text-decoration:underline">             
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_tblspc</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16386</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">PG_9</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000">_201409291</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">18894</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="13-堆表文件的内部布局">1.3 堆表文件的内部布局</h2>
<p>在数据文件（堆表，索引，也包括空闲空间映射和可见性映射）内部，它被划分为固定长度的<strong>页（pages）</strong>，或曰 <strong>区块（blocks）</strong>，大小默认为8192字节（8KB）。 每个文件中的页从0开始按顺序编号，这些数字称为<strong>区块号（block numbers）</strong>。 如果文件已填满，PostgreSQL通过在文件末尾追加一个新的空页来增长文件。</p>
<p>页面内部的布局取决于数据文件的类型。本节会描述表的页面布局，因为理解接下来的几章需要这些知识。</p>
<p><strong>图 1.4. 堆表文件的页面布局</strong></p>
<p><img src="/img/blog/kernel/fig-1-04.png"></p>
<p>表的页面包含了三种类型的数据：</p>
<ol>
<li>
<p><strong>堆元组（heap tuples）</strong> —— 堆元组就是数据记录本身。它们从页面底部开始依序堆叠。<a href="/zh/blog/kernel/ch5/">第5.2节</a>与<a href="/zh/blog/kernel/ch9/">第9章</a>会描述元组的内部结构，这一知识对于理解PostgreSQL并发控制与WAL机制是必须的。</p>
</li>
<li>
<p><strong>行指针（line pointer）</strong> —— 每个行指针占4个字节，保存着指向堆元组的指针。它们也被称为<strong>项目指针（item pointer）</strong>。行指针简单地组织为一个数组，扮演了元组索引的角色。每个索引项从1开始依次编号，称为<strong>偏移号（offset number）</strong>。当向页面中添加新元组时，一个相应的新行指针也会被放入数组中，并指向新添加的元组。</p>
</li>
<li>
<p><strong>首部数据（header data）</strong>  —— 页面的起始位置分配了由结构<code>PageHeaderData</code>定义的首部数据。它的大小为24个字节，包含关于页面的元数据。该结构的主要成员变量为：</p>
<ul>
<li><code>pd_lsn</code> —— 本页面最近一次变更所写入XLOG记录对应的LSN。它是一个8字节无符号整数，与WAL机制相关，<a href="/zh/blog/kernel/ch9/">第9章</a>将详细展开。</li>
<li><code>pd_checksum</code> —— 本页面的校验和值。（注意只有在9.3或更高版本才有此变量，早期版中该字段用于存储页面的时间线标识）</li>
<li><code>pd_lower</code>，<code>pd_upper</code> —— <code>pd_lower</code>指向行指针的末尾，<code>pd_upper</code>指向最新堆元组的起始位置。</li>
<li><code>pd_special</code> —— 在索引页中会用到该字段。在堆表页中它指向页尾。（在索引页中它指向特殊空间的起始位置，特殊空间是仅由索引使用的特殊数据区域，包含特定的数据，具体内容依索引的类型而定，如B树，GiST，GiN等。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* @src/include/storage/bufpage.h */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 磁盘页面布局
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 对任何页面都适用的通用空间管理信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		pd_lsn		- 本页面最近变更对应xlog记录的标识。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		pd_checksum - 页面校验和
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		pd_flags	- 标记位
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		pd_lower	- 空闲空间开始位置
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		pd_upper	- 空闲空间结束位置
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		pd_special	- 特殊空间开始位置
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		pd_pagesize_version - 页面的大小，以及页面布局的版本号
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		pd_prune_xid - 本页面中可以修剪的最老的元组中的XID.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 缓冲管理器使用LSN来强制实施WAL的基本规则：&#34;WAL需先于数据写入&#34;。直到xlog刷盘位置超过
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 本页面的LSN之前，不允许将缓冲区的脏页刷入磁盘。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * pd_checksum 存储着页面的校验和，如果本页面配置了校验。0是一个合法的校验和值。如果页面
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 没有使用校验和，我们就不会设置这个字段的值；通常这意味着该字段值为0，但如果数据库是从早于
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 9.3版本从 pg_upgrade升级而来，也可能会出现非零的值。因为那时候这块地方用于存储页面最后
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 更新时的时间线标识。 注意，并没有标识告诉你页面的标识符到底是有效还是无效的，也没有与之关
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 联的标记为。这是特意设计成这样的，从而避免了需要依赖页面的具体内容来决定是否校验页面本身。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * pd_prune_xid是一个提示字段，用于帮助确认剪枝是否有用。目前对于索引页没用。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 页面版本编号与页面尺寸被打包成了单个uint16字段，这是有历史原因的：在PostgreSQL7.3之前
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 并没有页面版本编号这个概念，这样做能让我们假装7.3之前的版本的页面版本编号为0。我们约束页面
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 的尺寸必须为256的倍数，留下低8位用于页面版本编号。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 最小的可行页面大小可能是64字节，能放下页的首部，空闲空间，以及一个最小的元组。当然在实践中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 肯定要大得多(默认为8192字节)，所以页面大小必需是256的倍数并不是一个重要限制。而在另一端，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 我们最大只能支持32KB的页面，因为 lp_off/lp_len字段都是15bit。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">PageHeaderData</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PageXLogRecPtr</span> 	<span style="color:#000">pd_lsn</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 最近应用至本页面XLog记录的LSN */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint16</span>			<span style="color:#000">pd_checksum</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 校验和 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint16</span>		  	<span style="color:#000">pd_flags</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 标记位，详情见下 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">LocationIndex</span> 	<span style="color:#000">pd_lower</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 空闲空间起始位置 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">LocationIndex</span> 	<span style="color:#000">pd_upper</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 空闲空间终止位置 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">LocationIndex</span> 	<span style="color:#000">pd_special</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 特殊用途空间的开始位置 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint16</span>		  	<span style="color:#000">pd_pagesize_version</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TransactionId</span> 	<span style="color:#000">pd_prune_xid</span><span style="color:#000;font-weight:bold">;</span> 	<span style="color:#8f5902;font-style:italic">/* 最老的可修剪XID, 如果没有设置为0 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ItemIdData</span>		<span style="color:#000">pd_linp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">FLEXIBLE_ARRAY_MEMBER</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#8f5902;font-style:italic">/* 行指针的数组 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">PageHeaderData</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 缓冲区页中的项目指针(item pointer)，也被称为行指针(line pointer)。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 在某些情况下，项目指针处于 “使用中”的状态，但在本页中没有任何相关联的存储区域。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 按照惯例，lp_len == 0 表示该行指针没有关联存储。独立于其lp_flags的状态. 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ItemIdData</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span>	<span style="color:#f57900">lp_off</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">,</span>		<span style="color:#8f5902;font-style:italic">/* 元组偏移量 (相对页面起始处) */</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f57900">lp_flags</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>		<span style="color:#8f5902;font-style:italic">/* 行指针的状态，见下 */</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f57900">lp_len</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 元组的长度，以字节计 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">ItemIdData</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* lp_flags有下列可能的状态，LP_UNUSED的行指针可以立即重用，而其他状态的不行。 */</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define LP_UNUSED		0		</span><span style="color:#8f5902;font-style:italic">/* unused (lp_len必需始终为0) */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define LP_NORMAL		1		</span><span style="color:#8f5902;font-style:italic">/* used (lp_len必需始终&gt;0) */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define LP_REDIRECT		2		</span><span style="color:#8f5902;font-style:italic">/* HOT 重定向 (lp_len必需为0) */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define LP_DEAD			3		</span><span style="color:#8f5902;font-style:italic">/* 死元组，有没有对应的存储尚未可知 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span></code></pre></div></li>
</ol>
<p>行指针的末尾与最新元组起始位置之间的空余空间称为<strong>空闲空间（free space）<strong>或</strong>空洞（hole）</strong>。</p>
<p>为了识别表中的元组，数据库内部会使用<strong>元组标识符（tuple identifier, TID）</strong>。TID由一对值组成：元组所属页面的<strong>区块号</strong>，及指向元组的行指针的<strong>偏移号</strong>。TID的一种典型用途是索引，更多细节参见<a href="/zh/blog/kernel/ch1/">第1.4.2节</a>。</p>
<blockquote>
<p>结构体<code>PageHeaderData</code>定义于<a href="https://github.com/postgres/postgres/blob/master/src/include/storage/bufpage.h"><code>src/include/storage/bufpage.h</code></a>中。</p>
</blockquote>
<p>此外，大小超过约2KB（8KB的四分之一）的堆元组会使用一种称为 <strong>TOAST（The Oversized-Attribute Storage Technique，超大属性存储技术）</strong> 的方法来存储与管理。详情请参阅<a href="https://www.postgresql.org/docs/current/static/storage-toast.html">PostgreSQL文档</a>。</p>
<h2 id="14-读写元组的方式">1.4 读写元组的方式</h2>
<p>本章的最后将描述读取与写入堆元组的方式。</p>
<h3 id="141-写入堆元组">1.4.1 写入堆元组</h3>
<p>让我们假设有一个表，仅由一个页面组成，且该页面只包含一个堆元组。 此页面的<code>pd_lower</code>指向第一个行指针，而该行指针和<code>pd_upper</code>都指向第一个堆元组。 如图1.5(a)所示。</p>
<p>当第二个元组被插入时，它会被放在第一个元组之后。第二个行指针被插入到第一个行指针的后面，并指向第二个元组。 <code>pd_lower</code>更改为指向第二个行指针，<code>pd_upper</code>更改为指向第二个堆元组，如图1.5(b)。 页面内的首部数据（例如<code>pd_lsn</code>，<code>pg_checksum</code>，<code>pg_flag</code>）也会被改写为适当的值，细节在<a href="/zh/blog/kernel/ch5/">第5.3节</a>和<a href="/zh/blog/kernel/ch9/">第9章</a>中描述。</p>
<p><strong>图1.5 堆元组的写入</strong></p>
<p><img src="/img/blog/kernel/fig-1-05.png"></p>
<h3 id="142-读取堆元组">1.4.2 读取堆元组</h3>
<p>这里简述两种典型的访问方式：顺序扫描与B树索引扫描：</p>
<ul>
<li><strong>顺序扫描</strong> —— 通过扫描每一页中的行指针，依序读取所有页面中的所有元组，如图1.6(a)。</li>
<li><strong>B树索引扫描</strong> —— 索引文件包含着索引元组，索引元组由一个键值对组成，键为被索引的列值，值为目标堆元组的TID。进行索引查询时，首先使用键进行查找，如果找到了对应的索引元组，PostgreSQL就会根据相应值中的TID来读取对应的堆元组 （使用B树索引找到索引元组的方法请参考相关资料，这一部分属于数据库系统的通用知识，限于篇幅这里不再详细展开）。例如在图1.6(b)中，所获索引元组中TID的值为（区块号 = 7，偏移号 = 2）， 这意味着目标堆元组是表中第7页的第2个元组，因而PostgreSQL可以直接读取所需的堆元组，而避免对页面做不必要的扫描。</li>
</ul>
<p><strong>图 1.6 顺序扫描和索引扫描</strong></p>
<p><img src="/img/blog/kernel/fig-1-06.png"></p>
<blockquote>
<p>PostgreSQL还支持<strong>TID扫描</strong>，<strong>位图扫描（<a href="https://wiki.postgresql.org/wiki/Bitmap_Indexes">Bitmap-Scan</a>）<strong>和</strong>仅索引扫描（Index-Only-Scan）</strong>。</p>
<p>TID扫描是一种通过使用所需元组的TID直接访问元组的方法。 例如要在表中找到第0个页面中的第1个元组，可以执行以下查询：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">sampledb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sampletbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;(0,1)&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctid</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------+-----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AAAAAAAAA</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">sampledb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sampletbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ctid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;(0,1)&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Tid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sampletbl</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">38</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">TID</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;(0,1)&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">tid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>仅索引扫描将在<a href="/zh/blog/kernel/ch7/">第7章</a>中详细介绍。</p>
</blockquote>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-00326e1d5c8a39c4e36400d8a9eacedd">第二章 进程和内存架构</h1>
	<div class="lead"><a href="https://www.interdb.jp/pg/pgsql2.html">The Internals of PostgreSQL, Chapter 2</a></div>
	<div class="td-byline mb-4">
		By <b><a href="https://www.interdb.jp/pg/">Hironobu SUZUKI</a> ，译者：<a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-01-10" class="text-muted">2018年01月10日</time>
        
	</div>
	<p>本章总结了PostgreSQL中进程与内存的架构，有助于读者理解后续章节。 如果读者已经熟悉这些内容，可以直接跳过本章。</p>
<h2 id="21-进程架构">2.1 进程架构</h2>
<p>PostgreSQL是一个客户端/服务器风格的关系型数据库管理系统，采用多进程架构，运行在单台主机上。</p>
<p>我们通常所谓的“<strong>PostgreSQL服务器（PostgreSQL Server）</strong>” 实际上是一系列协同工作的进程集合，包含着下列进程：</p>
<ul>
<li>
<p><strong>Postgres服务器进程（Postgres Server Process）</strong> 是所有数据库集簇管理进程的父进程。</p>
</li>
<li>
<p>每个<strong>后端进程（Backend Process）</strong> 负责处理客户端发出的查询和语句。</p>
</li>
<li>
<p>各种<strong>后台进程（Background Process）</strong> 负责执行各种数据库管理任务（例如清理过程与检查点过程）。</p>
</li>
<li>
<p>各种<strong>复制相关（Replication Associated Process）</strong> 的进程负责流复制，流复制的细节会在<a href="/zh/blog/kernel/ch11/">第11章</a>中介绍。</p>
</li>
<li>
<p><strong>后台工作进程（Background Worker Process）</strong> 在9.3版被引入，它能执行任意由用户实现的处理逻辑。这里不详述，请参阅<a href="https://www.postgresql.org/docs/current/static/bgworker.html">官方文档</a>。</p>
</li>
</ul>
<p>以下几小节将详细描述前三种进程。</p>
<p><strong>图2.1 PostgreSQL的进程架构示例</strong></p>
<p><img src="/img/blog/kernel/fig-2-01.png"></p>
<blockquote>
<p>本图展示了PostgreSQL服务器包含的进程：postgres服务器进程，两个后端进程，七个后台进程，以及两个客户端进程。 也画出了数据库集簇，共享内存，以及两个客户端。</p>
</blockquote>
<h3 id="211-postgres服务器进程">2.1.1 Postgres服务器进程</h3>
<p>如上所述，<strong>Postgres服务器进程（postgres server process）</strong> 是PostgreSQL服务器中所有进程的父进程，在早期版本中它被称为*“postmaster“*。</p>
<p>带<code>start</code>参数执行<a href="https://www.postgresql.org/docs/current/static/app-pg-ctl.html"><code>pg_ctl</code></a>实用程序会启动一个postgres服务器进程。它会在内存中分配共享内存区域，启动各种后台进程，如有必要还会启动复制相关进程与后台工作进程，并等待来自客户端的连接请求。 每当接收到来自客户端的连接请求时，它都会启动一个后端进程 （然后由启动的后端进程处理该客户端发出的所有查询）。</p>
<p>一个postgres服务器进程只会监听一个网络端口，默认端口为5432。如果要在同一台主机上运行多个PostgreSQL服务器，则应为每个服务器配置不同的监听端口，如5432，5433等。</p>
<h3 id="212-后端进程">2.1.2 后端进程</h3>
<p>每个后端进程（也称为*”postgres“*）由postgres服务器进程启动，并处理连接另一侧的客户端发出的所有查询。它通过单条TCP连接与客户端通信，并在客户端断开连接时终止。</p>
<p>因为一条连接只允许操作一个数据库，因此必须在连接到PostgreSQL服务器时显式指定要连接的数据库。</p>
<p>PostgreSQL允许多个客户端同时连接；配置参数<a href="https://www.postgresql.org/docs/current/static/runtime-config-connection.html#GUC-MAX-CONNECTIONS"><code>max_connections</code></a>用于控制最大客户端连接数（默认为100）。</p>
<p>因为PostgreSQL没有原生的连接池功能，因此如果许多客户端频繁地重复与PostgreSQL服务器建立断开连接（譬如WEB应用），则会导致建立连接与创建后端进程的开销变大。这种情况对数据库服务器的性能有负面影响，通常可以使用池化中间件（<a href="https://pgbouncer.github.io">pgbouncer</a>或<a href="http://www.pgpool.net/mediawiki/index.php/Main_Page">pgpool-II</a>）来避免该问题。</p>
<h3 id="213-后台进程">2.1.3 后台进程</h3>
<p>表2.1是后台进程的列表。比起postgres服务器和后端进程，后台进程的种类要多很多。想要简单地解释每种后台进程的具体功能是不现实的，因为这些功能有赖PostgreSQL的内部机制与特定的独立特性。依赖于各个特定的特性以及PostgreSQL的内部机制。 因此在本章中仅做简要介绍。 细节将在后续章节中描述。</p>
<p><strong>表2.1 后台进程</strong></p>
<table>
<thead>
<tr>
<th>进程</th>
<th>概述</th>
<th>参考</th>
</tr>
</thead>
<tbody>
<tr>
<td>background writer</td>
<td>本进程负责将共享缓冲池中的脏页逐渐刷入持久化存储中（例如，HDD，SSD）（在9.1及更旧版本中，它还负责处理<strong>检查点（checkpoint）</strong>）</td>
<td><a href="/zh/blog/kernel/ch8/">8.6</a></td>
</tr>
<tr>
<td>checkpointer</td>
<td>在9.2及更新版本中，该进程负责处理检查点。</td>
<td><a href="/zh/blog/kernel/ch8/">8.6</a>, <a href="/zh/blog/kernel/ch9/">9.7</a></td>
</tr>
<tr>
<td>autovacuum launcher</td>
<td>周期性地启动自动清理工作进程（更准确地说，它向Postgres服务器请求创建自动清理工作进程）</td>
<td><a href="/zh/blog/kernel/ch6/">6.5</a></td>
</tr>
<tr>
<td>WAL writer</td>
<td>本进程周期性地将WAL缓冲区中的WAL数据刷入持久存储中。</td>
<td><a href="/zh/blog/kernel/ch9/">9.9</a></td>
</tr>
<tr>
<td>statistics collector</td>
<td>本进程负责收集统计信息，用于诸如<code>pg_stat_activity</code>，<code>pg_stat_database</code>等系统视图。</td>
<td></td>
</tr>
<tr>
<td>logging collector (logger)</td>
<td>本进程负责将错误消息写入日志文件。</td>
<td></td>
</tr>
<tr>
<td>archiver</td>
<td>本进程负责将日志归档。</td>
<td><a href="/zh/blog/kernel/ch9/">9.10</a></td>
</tr>
</tbody>
</table>
<blockquote>
<p>这里展示了PostgreSQL服务器包含的实际进程。 在以下示例中有一个postgres服务器进程（pid为9687），两个后端进程（pid为9697和9717），以及表2.1中列出的几个后台进程正在运行，亦见图2.1。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>postgres&gt; pstree -p 9687
</span></span><span style="display:flex;"><span>-+= 00001 root /sbin/launchd
</span></span><span style="display:flex;"><span> \-+- 09687 postgres /usr/local/pgsql/bin/postgres -D /usr/local/pgsql/data
</span></span><span style="display:flex;"><span>   |--= 09688 postgres postgres: logger process     
</span></span><span style="display:flex;"><span>   |--= 09690 postgres postgres: checkpointer process     
</span></span><span style="display:flex;"><span>   |--= 09691 postgres postgres: writer process     
</span></span><span style="display:flex;"><span>   |--= 09692 postgres postgres: wal writer process     
</span></span><span style="display:flex;"><span>   |--= 09693 postgres postgres: autovacuum launcher process     
</span></span><span style="display:flex;"><span>   |--= 09694 postgres postgres: archiver process     
</span></span><span style="display:flex;"><span>   |--= 09695 postgres postgres: stats collector process     
</span></span><span style="display:flex;"><span>   |--= 09697 postgres postgres: postgres sampledb 192.168.1.100(54924) idle  
</span></span><span style="display:flex;"><span>   \--= 09717 postgres postgres: postgres sampledb 192.168.1.100(54964) idle in transaction  
</span></span></code></pre></div></blockquote>
<h2 id="22-内存架构">2.2 内存架构</h2>
<p>PostgreSQL的内存架构可以分为两部分：</p>
<ul>
<li>本地内存区域 —— 由每个后端进程分配，供自己使用。</li>
<li>共享内存区域 —— 供PostgreSQL服务器的所有进程使用。</li>
</ul>
<p>下面一小节简要介绍了这两部分架构。</p>
<p><strong>图2.2 PostgreSQL的内存架构</strong></p>
<p><img src="/img/blog/kernel/fig-2-02.png"></p>
<h3 id="221-本地内存区域">2.2.1 本地内存区域</h3>
<p>每个后端进程都会分配一块本地内存区域用于查询处理。该区域会分为几个子区域 —— 子区域的大小有的固定，有的可变。 表2.2列出了主要的子区域。 详细信息将在后续章节中介绍。</p>
<p><strong>表2.2 本地内存区域</strong></p>
<table>
<thead>
<tr>
<th>子区域</th>
<th>描述</th>
<th>参考</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>work_mem</code></td>
<td>执行器在执行<code>ORDER BY</code>和<code>DISTINCT</code>时使用该区域对元组做排序，以及存储归并连接和散列连接中的连接表。</td>
<td><a href="/zh/blog/kernel/ch3/">第3章</a></td>
</tr>
<tr>
<td><code>maintenance_work_mem</code></td>
<td>某些类型的维护操作使用该区域（例如<code>VACUUM</code>，<code>REINDEX</code>）。</td>
<td><a href="/zh/blog/kernel/ch6/">6.1</a></td>
</tr>
<tr>
<td><code>temp_buffers</code></td>
<td>执行器使用此区域存储临时表。</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="222-共享内存区域">2.2.2 共享内存区域</h3>
<p>PostgreSQL服务器启动时会分配共享内存区域。该区域分为几个固定大小的子区域。 表2.3列出了主要的子区域。 详细信息将在后续章节中介绍。</p>
<p><strong>表2.3 共享内存区域</strong></p>
<table>
<thead>
<tr>
<th>子区域</th>
<th>描述</th>
<th>参考</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>shared buffer pool</code></td>
<td>PostgreSQL将表和索引中的页面从持久存储加载至此，并直接操作它们。</td>
<td><a href="/zh/blog/kernel/ch8/">第8章</a></td>
</tr>
<tr>
<td><code>WAL buffer</code></td>
<td>为确保服务故障不会导致任何数据丢失，PostgreSQL实现了WAL机制。 WAL数据（也称为XLOG记录）是PostgreSQL中的事务日志；WAL缓冲区是WAL数据在写入持久存储之前的缓冲区。</td>
<td><a href="/zh/blog/kernel/ch9/">第9章</a></td>
</tr>
<tr>
<td><code>commit log</code></td>
<td><strong>提交日志（Commit Log, CLOG）</strong> 为并发控制（CC）机制保存了所需的所有事务状态（例如进行中，已提交，已中止等）。</td>
<td><a href="/zh/blog/kernel/ch5/">5.4</a></td>
</tr>
</tbody>
</table>
<p>除了上面这些，PostgreSQL还分配了这几个区域：</p>
<ul>
<li>用于访问控制机制的子区域（例如信号量，轻量级锁，共享和排他锁等）。</li>
<li>各种后台进程使用的子区域，例如<code>checkpointer</code>和<code>autovacuum</code>。</li>
<li>用于事务处理的子区域，例如<strong>保存点（save-point）</strong> 与 <strong>两阶段提交（2PC）</strong>。</li>
</ul>
<p>诸如此类。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-e9d439ddf2f4b1db93e9eab65718aa1d">第三章 查询处理</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://www.interdb.jp/pg/">Hironobu SUZUKI</a> ，译者：<a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-01-09" class="text-muted">2018年01月09日</time>
        
	</div>
	<p>查询处理是PostgreSQL中最为复杂的子系统。如PostgreSQL<a href="https://www.postgresql.org/docs/current/static/features.html">官方文档</a>所述，PostgreSQL支持SQL2011标准中的大多数特性，查询处理子系统能够高效地处理这些SQL。本章概述了查询处理的流程，特别关注了查询优化的部分。</p>
<p>本章包括下列三个部分：</p>
<ul>
<li>
<p>第一部分：3.1节</p>
<p>这一节会简单介绍PostgreSQL中查询处理的流程。</p>
</li>
<li>
<p>第二部分：3.2~3.4节</p>
<p>这一部分会描述获取单表查询上最优执行计划的步骤。3.2节讨论代价估计的过程，3.3节描述创建计划树的过程，3.4节将简要介绍执行器的工作过程。</p>
</li>
<li>
<p>第三部分：3.5~3.6节</p>
<p>这一部分会描述获取多表查询上最优执行计划的步骤。3.5节介绍了三种连接算法：<strong>嵌套循环连接（Nested Loop Join）</strong>，<strong>归并连接（Merge Join）</strong> ，<strong>散列连接（Hash Join）</strong>。3.6节将介绍为多表查询创建计划树的过程。</p>
</li>
</ul>
<p>PostgreSQL支持三种技术上很有趣，而且也很实用的功能：<a href="https://www.postgresql.org/docs/current/static/fdwhandler.html"><strong>外部数据包装（Foreign Data Wrapper, FDW）</strong></a>，<a href="https://www.postgresql.org/docs/current/static/parallel-query.html"><strong>并行查询</strong></a>，以及版本11即将支持的<a href="https://www.postgresql.org/docs/11/static/jit-reason.html">JIT编译</a>。前两者将在<a href="/zh/blog/kernel/ch4/">第4章</a>中描述，JIT编译超出范围本书的范围，详见<a href="https://www.postgresql.org/docs/11/static/jit-reason.html">官方文档</a>。</p>
<h2 id="31-概览">3.1 概览</h2>
<p>尽管PostgreSQL在9.6版本后有了基于多个后台工作进程的并行查询，但大体上来讲，还是每个连接对应一个后端进程。后端进程由五个子系统组成，如下所示：</p>
<ol>
<li>
<p><strong>解析器（Parser）</strong></p>
<p>解析器根据SQL语句生成一颗<strong>语法解析树（parse tree）</strong> 。</p>
</li>
<li>
<p><strong>分析器（Analyzer）</strong></p>
<p>分析器对语法解析树进行语义分析，生成一颗<strong>查询树（query tree）</strong>。</p>
</li>
<li>
<p><strong>重写器（Rewriter）</strong></p>
<p>重写器按照<a href="https://www.postgresql.org/docs/current/static/rules.html">规则系统</a>中存在的规则，对查询树进行改写。</p>
</li>
<li>
<p><strong>计划器（Planner）</strong></p>
<p>计划器基于查询树，生成一颗执行效率最高的<strong>计划树（plan tree）</strong>。</p>
</li>
<li>
<p><strong>执行器（Executor）</strong></p>
<p>执行器按照计划树中的顺序访问表和索引，执行相应查询。</p>
</li>
</ol>
<p><strong>图3.1 查询处理</strong></p>
<p><img alt="QueryProcessing" src="/img/blog/kernel/fig-3-01.png"></p>
<p>本节将概述这些子系统。计划器和执行器很复杂，后面的章节会对这些函数的细节进行描述。</p>
<blockquote>
<p>PostgreSQL的查询处理在<a href="http://www.postgresql.org/docs/current/static/overview.html">官方文档</a>中有详细的描述</p>
</blockquote>
<h3 id="311-解析器parser">3.1.1 解析器（Parser）</h3>
<p>解析器基于SQL语句的文本，生成一颗后续子系统可以理解的语法解析树。下面是一个具体的例子。</p>
<p>考虑以下查询：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">300</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>语法解析树的根节点是一个定义在<a href="https://github.com/postgres/postgres/blob/master/src/include/nodes/parsenodes.h"><code>parsenodes.h</code></a>中的<code>SelectStmt</code>数据结构。图3.2(a)展示了一个查询，而图3.2(b)则是该查询对应的语法解析树。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">SelectStmt</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">NodeTag</span>         <span style="color:#000">type</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* 这些字段只会在SelectStmts“叶节点”中使用 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">List</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">distinctClause</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">/* NULL, DISTINCT ON表达式列表, 或
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                                       对所有的(SELECT DISTINCT)为lcons(NIL,NIL) */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">IntoClause</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">intoClause</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* SELECT INTO 的目标 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">List</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">targetList</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* 结果目标列表 (ResTarget) */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">List</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">fromClause</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* FROM 子句 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Node</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">whereClause</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* WHERE 限定条件 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">List</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">groupClause</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* GROUP BY 子句 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Node</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">havingClause</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* HAVING 条件表达式 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">List</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">windowClause</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* WINDOW window_name AS (...), ... */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/*  在一个表示值列表的叶节点中，上面的字段全都为空，而这个字段会被设置。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">         * 注意这个子列表中的元素仅仅是表达式，没有ResTarget的修饰，还需要注意列表元素可能为
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">         * DEFAULT (表示一个 SetToDefault 节点)，而无论值列表的上下文。 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">         * 由分析阶段决定否合法并拒绝。      */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">List</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">valuesLists</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 未转换的表达式列表 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* 这些字段会同时在SelectStmts叶节点与SelectStmts上层节点中使用 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">List</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sortClause</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* 排序子句 (排序依据的列表) */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Node</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">limitOffset</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 需要跳过的元组数目 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Node</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">limitCount</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* 需要返回的元组数目 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">List</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lockingClause</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* FOR UPDATE (锁子句的列表) */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">WithClause</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">withClause</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* WITH 子句 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* 这些字段只会在上层的 SelectStmts 中出现 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">SetOperation</span> <span style="color:#000">op</span><span style="color:#000;font-weight:bold">;</span>                <span style="color:#8f5902;font-style:italic">/* set 操作的类型 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">bool</span>            <span style="color:#000">all</span><span style="color:#000;font-weight:bold">;</span>            <span style="color:#8f5902;font-style:italic">/* 是否指明了 ALL 选项? */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">SelectStmt</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">larg</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 左子节点 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">SelectStmt</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rarg</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 右子节点 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">SelectStmt</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p><strong>图3.2. 语法解析树的例子</strong></p>
<p><img alt="ParseTree" src="/img/blog/kernel/fig-3-02.png"></p>
<p><code>SELECT</code>查询中的元素和语法解析树中的元素有着对应关系。比如，(1)是目标列表中的一个元素，与目标表的<code>'id'</code>列相对应，(4)是一个<code>WHERE</code>子句，诸如此类。</p>
<p>当解析器生成语法分析树时只会检查语法，只有当查询中出现语法错误时才会返回错误。解析器并不会检查输入查询的语义，举个例子，如果查询中包含一个不存在的表名，解析器并不会报错，语义检查由分析器负责。</p>
<h3 id="312-分析器analyzer">3.1.2 分析器（Analyzer）</h3>
<p>分析器对解析器产出的<strong>语法解析树（parse tree）<strong>进行语义分析，并产出一颗</strong>查询树（query tree）</strong>。</p>
<p>查询树的根节点是<a href="https://github.com/postgres/postgres/blob/master/src/include/nodes/parsenodes.h"><code>parsenode.h</code></a>中定义的<code>Query</code>数据结构，这个结构包含着对应查询的元数据，比如命令的类型（<code>SELECT/INSERT</code>等），还包括了一些叶子节点，叶子节点由列表或树组成，包含了特定子句相应的数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * Query -
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *	  解析与分析过程会将所有的语句转换为一颗查询树，供重写器与计划器用于进一步的处理。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *    功能语句（即不可优化的语句）会设置utilityStmt字段，而Query结构本身基本上是空的。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *	  DECLARE CURSOR 是一个特例：它的形式与SELECT类似，但原始的DeclareCursorStmt会
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *    被放在 utilityStmt 字段中。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *    计划过程会将查询树转换为一颗计划树，计划树的根节点是一个PlannedStmt结构
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *    执行器不会用到查询树结构
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">Query</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">NodeTag</span>		<span style="color:#000">type</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">CmdType</span>		<span style="color:#000">commandType</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* select|insert|update|delete|utility */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">QuerySource</span> <span style="color:#000">querySource</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 我来自哪里? */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint32</span>		<span style="color:#000">queryId</span><span style="color:#000;font-weight:bold">;</span>		    <span style="color:#8f5902;font-style:italic">/* 查询标识符 (可由插件配置) */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">canSetTag</span><span style="color:#000;font-weight:bold">;</span>		    <span style="color:#8f5902;font-style:italic">/* 我设置了命令结果标签吗? */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Node</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">utilityStmt</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 如果这是一条DECLARE CURSOR或不可优化的语句 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span>		<span style="color:#000">resultRelation</span><span style="color:#000;font-weight:bold">;</span> 	    <span style="color:#8f5902;font-style:italic">/* 对增删改语句而言是目标关系的索引; SELECT为0 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">hasAggs</span><span style="color:#000;font-weight:bold">;</span>		    <span style="color:#8f5902;font-style:italic">/* 是否在目标列表或having表达式中指定了聚合函数 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">hasWindowFuncs</span><span style="color:#000;font-weight:bold">;</span> 	<span style="color:#8f5902;font-style:italic">/* tlist是否包含窗口函数 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">hasSubLinks</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 是否包含子查询SubLink */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">hasDistinctOn</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 是否包含来自DISTINCT ON的distinct子句 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">hasRecursive</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 是否制定了WITH RECURSIVE */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">hasModifyingCTE</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 是否在WITH子句中包含了INSERT/UPDATE/DELETE */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">hasForUpdate</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 是否指定了FOR [KEY] UPDATE/SHARE*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">hasRowSecurity</span><span style="color:#000;font-weight:bold">;</span> 	<span style="color:#8f5902;font-style:italic">/* 是否应用了行安全策略 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cteList</span><span style="color:#000;font-weight:bold">;</span>		    <span style="color:#8f5902;font-style:italic">/* CTE列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rtable</span><span style="color:#000;font-weight:bold">;</span>		    <span style="color:#8f5902;font-style:italic">/* 范围表项目列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">FromExpr</span>   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">jointree</span><span style="color:#000;font-weight:bold">;</span>		    <span style="color:#8f5902;font-style:italic">/* 表连接树 (FROM 与 WHERE 子句) */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">targetList</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 目标列表 (TargetEntry的列表) */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">withCheckOptions</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* WithCheckOption的列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">OnConflictExpr</span> 	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">onConflict</span><span style="color:#000;font-weight:bold">;</span> 	<span style="color:#8f5902;font-style:italic">/* ON CONFLICT DO [NOTHING | UPDATE] */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">returningList</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 返回值列表(TargetEntry的列表) */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">groupClause</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* SortGroupClause的列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">groupingSets</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 如果有，GroupingSet的列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Node</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">havingQual</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 分组的Having条件列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">windowClause</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 窗口子句列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">distinctClause</span><span style="color:#000;font-weight:bold">;</span> 	<span style="color:#8f5902;font-style:italic">/* SortGroupClause列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sortClause</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* SortGroupClause列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Node</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">limitOffset</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* Offset跳过元组数目 (int8 表达式) */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Node</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">limitCount</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* Limit返回元组数目 (int8 表达式) */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rowMarks</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">/* RowMarkClause列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Node</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">setOperations</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 如果是UNION/INTERSECT/EXCEPT的顶层查询，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	                                   则为集合操作列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">constraintDeps</span><span style="color:#000;font-weight:bold">;</span> 	<span style="color:#8f5902;font-style:italic">/* 确认查询语义是否合法时，所依赖约束对象的OID列表 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">Query</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p><strong>图3.3 查询树一例</strong></p>
<p><img alt="QueyTree" src="/img/blog/kernel/fig-3-03.png"></p>
<p>简要介绍一下上图中的查询树：</p>
<ul>
<li><code>targetlist</code> 是查询结果中**列（Column）**的列表。在本例中该列表包含两列：<code>id</code> 和<code>data</code>。如果在输入的查询树中使用了<code>*</code>（星号），那么分析器会将其显式替换为所有具体的列。</li>
<li>范围表<code>rtable</code>是该查询所用到关系的列表。本例中该变量包含了表<code>tbl_a</code>的信息，如该表的表名与<code>oid</code>。</li>
<li>连接树<code>jointree</code>存储着<code>FROM</code>和<code>WHERE</code>子句的相关信息。</li>
<li>排序子句<code>sortClause</code>是<code>SortGroupClause</code>结构体的列表。</li>
</ul>
<p><a href="http://www.postgresql.org/docs/current/static/querytree.html">官方文档</a>描述了查询树的细节。</p>
<h3 id="313-重写器rewriter">3.1.3 重写器（Rewriter）</h3>
<p>PostgreSQL的<a href="https://www.postgresql.org/docs/current/static/rules.html">规则系统</a>正是基于重写器实现的；当需要时，重写器会根据存储在<code>pg_rules</code>中的规则对查询树进行转换。规则系统本身也是一个很有趣的系统，不过本章略去了关于规则系统和重写器的描述，以免内容过于冗长。</p>
<blockquote>
<h4 id="视图">视图</h4>
<p>在PostgreSQL中，<a href="https://www.postgresql.org/docs/current/static/rules-views.html">视图</a>是基于规则系统实现的。当使用<a href="https://www.postgresql.org/docs/current/static/sql-createview.html"><code>CREATE VIEW</code></a>命令定义一个视图时，PostgreSQL就会创建相应的规则，并存储到系统目录中。</p>
<p>假设下面的视图已经被定义，而<code>pg_rule</code>中也存储了相应的规则。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">sampledb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">employees_list</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">sampledb</span><span style="color:#ce5c00;font-weight:bold">-#</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">department</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">sampledb</span><span style="color:#ce5c00;font-weight:bold">-#</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">employees</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">departments</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">department_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>当执行一个包含该视图的查询，解析器会创建一颗如图3.4(a)所示的语法解析树。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">sampledb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">employees_list</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在该阶段，重写器会基于<code>pg_rules</code>中存储的视图规则将<code>rangetable</code>节点重写为一颗查询子树，与子查询相对应。</p>
<p><strong>图3.4 重写阶段一例</strong></p>
<p><img alt="rewriter" src="/img/blog/kernel/fig-3-04.png"></p>
<p>因为PostgreSQL使用这种机制实现视图，直到9.2版本，视图都是不能更新的。虽然9.3版本后可以对视图进行更新，但对视图的更新仍然存在很多限制，具体细节请参考<a href="https://www.postgresql.org/docs/current/static/sql-createview.html#SQL-CREATEVIEW-UPDATABLE-VIEWS">官方文档</a>。</p>
</blockquote>
<h3 id="314-计划器与执行器">3.1.4 计划器与执行器</h3>
<p>计划器从重写器获取一颗<strong>查询树（query tree）</strong>，基于查询树生成一颗能被执行器高效执行的（查询）<strong>计划树（plan tree）</strong>。</p>
<p>在PostgreSQL中，计划器是完全<strong>基于代价估计（cost-based）<strong>的；它不支持基于规则的优化与</strong>提示（hint）</strong>。计划器是RDBMS中最为复杂的部分，因此本章的后续内容会对计划器做一个概述。</p>
<blockquote>
<h4 id="pg_hint_plan"><code>pg_hint_plan</code></h4>
<p>PostgreSQL不支持SQL中的<strong>提示（hint）</strong>，并且永远也不会去支持。如果你想在查询中使用提示，可以考虑使用<code>pg_hint_plan</code>扩展，细节请参考<a href="http://pghintplan.osdn.jp/pg_hint_plan.html">官方站点</a>。</p>
</blockquote>
<p>与其他RDBMS类似，PostgreSQL中的<a href="https://www.postgresql.org/docs/current/static/sql-explain.html"><code>EXPLAIN</code></a>命令会显示命令的计划树。下面给出了一个具体的例子。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">300</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                           
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">182</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">183</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">300</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">170</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">300</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">Filter</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">300</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>图3.5展示了结果相应的计划树。</p>
<p><strong>图3.5 一个简单的计划树以及其与EXPLAIN命令的关系</strong></p>
<p><img alt="planTree" src="/img/blog/kernel/fig-3-05.png"></p>
<p>计划树由许多称为**计划节点（plan node）**的元素组成，这些节点挂在<code>PlannedStmt</code>结构对应的计划树上。这些元素的定义在<a href="https://github.com/postgres/postgres/blob/master/src/include/nodes/plannodes.h%E4%B8%AD"><code>plannodes.h</code></a>中，第3.3.3节与第3.5.4.2会解释相关细节。</p>
<p>每个计划节点都包含着执行器进行处理所必需的信息，在单表查询的场景中，执行器会按照从终端节点往根节点的顺序依次处理这些节点。</p>
<p>比如图3.5中的计划树就是一个列表，包含一个排序节点和一个顺序扫描节点；因而执行器会首先对表<code>tbl_a</code>执行顺序扫描，并对获取的结果进行排序。</p>
<p>执行器会通过<a href="/zh/blog/kernel/ch8/">第8章</a>将介绍的缓冲区管理器来访问数据库集簇的表和索引。当处理一个查询时，执行器会使用预先分配的内存空间，比如<code>temp_buffers</code>和<code>work_mem</code>，必要时还会创建临时文件。</p>
<p><strong>图3.6 执行器，缓冲管理器，临时文件之间的关系</strong></p>
<p><img alt="dd" src="/img/blog/kernel/fig-3-06.png"></p>
<p>除此之外，当访问元组的时候，PostgreSQL还会使用并发控制机制来维护运行中事务的一致性和隔离性。<a href="/zh/blog/kernel/ch5/">第五章</a>介绍了并发控制机制。</p>
<h2 id="32-单表查询的代价估计">3.2 单表查询的代价估计</h2>
<p>PostgreSQL的查询优化是基于**代价（Cost）**的。代价是一个无量纲的值，它并不是一种绝对的性能指标，但可以作为比较各种操作代价时的相对性能指标。</p>
<p><a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/path/costsize.c"><code>costsize.c</code></a>中的函数用于估算各种操作的代价。所有被执行器执行的操作都有着相应的代价函数。例如，函数<code>cost_seqscan()</code> 和 <code>cost_index()</code>分别用于估算顺序扫描和索引扫描的代价。</p>
<p>在PostgreSQL中有三种代价：<strong>启动（start-up）</strong> ， <strong>运行（run）<strong>和</strong>总和（total）</strong>。<strong>总代价</strong>是<strong>启动代价</strong>和<strong>运行代价</strong>的和；因此只有启动代价和运行代价是单独估计的。</p>
<ol>
<li><strong>启动代价（start-up）</strong>：在读取到第一条元组前花费的代价，比如索引扫描节点的<strong>启动代价</strong>就是读取目标表的索引页，取到第一个元组的代价</li>
<li><strong>运行代价（run）</strong>： 获取全部元组的代价</li>
<li><strong>总代价（total）</strong>：前两者之和</li>
</ol>
<p><a href="https://www.postgresql.org/docs/current/static/sql-explain.html"><code>EXPLAIN</code></a>命令显示了每个操作的启动代价和总代价，下面是一个简单的例子：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                        
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">145</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在第4行显示了顺序扫描的相关信息。代价部分包含了两个值：0.00和145.00。在本例中，启动代价和总代价分别为0.00和145.00。</p>
<p>在本节中，我们将详细介绍顺序扫描，索引扫描和排序操作的代价是如何估算的。</p>
<p>在接下来的内容中，我们使用下面这个表及其索引作为例子。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INDEX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_data_idx</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">generate_series</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">),</span><span style="color:#000">generate_series</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ANALYZE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">\</span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;public.tbl&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Type</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Modifiers</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------+---------+-----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Indexes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;tbl_pkey&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;tbl_data_idx&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="321-顺序扫描">3.2.1 顺序扫描</h3>
<p>顺序扫描的代价是通过函数<code>cost_seqscan()</code>估计的。本节将研究顺序扫描代价是如何估计的，以下面的查询为例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在顺序扫描中，启动代价等于0，而运行代价由以下公式定义：
$$
\begin{align}
\verb|run_cost|
&amp;= \verb|cpu_run_cost| + \verb|disk_run_cost | \
&amp;= (\verb|cpu_tuple_cost| + \verb|cpu_operator_cost|) × N_{\verb|tuple|} + \verb|seq_page_cost| × N_{\verb|page|},
\end{align}
$$
其中<a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-SEQ-PAGE-COST"><code>seq_page_cost</code></a>，<a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-CPU-TUPLE-COST"><code>cpu_tuple_cost</code></a>和<a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-CPU-OPERATOR-COST"><code>cpu_operator_cost</code></a>是在<em>postgresql.conf</em> 中配置的参数，默认值分别为1.0，0.01和0.0025。$N_{\verb|tuple|}$ 和$N_{\verb|page|}$ 分别是表中的元组总数与页面总数，这两个值可以使用以下查询获取。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">reltuples</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;tbl&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">reltuples</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------+-----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">45</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>$$
\begin{equation}\tag{1}
N_{\verb|tuple|}=10000
\end{equation}
$$</p>
<p>$$
\begin{equation}\tag{2}
N_{\verb|page|}=45
\end{equation}
$$</p>
<p>因此：
$$
\begin{align}
\verb|run_cost|
&amp;= (0.01 + 0.0025) × 10000 + 1.0 × 45 = 170.0.
\end{align}
$$</p>
<p>最终：
$$
\verb|total_cost| = 0.0 + 170.0 = 170.0
$$</p>
<p>作为验证，下面是该查询的<code>EXPLAIN</code>结果：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                       
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">170</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">Filter</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在第4行中可以看到，启动代价和总代价分别是0.00和170.0，且预计全表扫描返回行数为8000条（元组）。</p>
<p>在第5行显示了一个顺序扫描的过滤器<code>Filter:(id &lt; 8000)</code>。更精确地说，它是一个<strong>表级过滤谓词（table level filter predicate）</strong>。注意这种类型的过滤器只会在读取所有元组的时候使用，它并不会减少需要扫描的表页面数量。</p>
<blockquote>
<p>从优化运行代价的角度来看，PostgreSQL假设所有的物理页都是从存储介质中获取的；即，PostgreSQL不会考虑扫 描的页面是否来自共享缓冲区。</p>
</blockquote>
<h3 id="322-索引扫描">3.2.2 索引扫描</h3>
<p>尽管PostgreSQL支持很多<a href="https://www.postgresql.org/docs/current/static/indexes-types.html">索引方法</a>，比如B树，<a href="https://www.postgresql.org/docs/current/static/gist.html">GiST</a>，<a href="https://www.postgresql.org/docs/current/static/gin.html">GIN</a>和<a href="https://www.postgresql.org/docs/current/static/brin.html">BRIN</a>，不过索引扫描的代价估计都使用一个共用的代价函数：<code>cost_index()</code>。</p>
<p>本节将研究索引扫描的代价是如何估计的，以下列查询为例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">240</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在估计该查询的代价之前，下面的查询能获取$N_{\verb|index|,\verb|page|}$和$N_{\verb|index|,\verb|tuple|}$的值：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">reltuples</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;tbl_data_idx&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">reltuples</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------+-----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>$$
\begin{equation}\tag{3}
N_{\verb|index|,\verb|tuple|} = 10000
\end{equation}
$$</p>
<p>$$
\begin{equation}\tag{4}
N_{\verb|index|,\verb|page|} = 30
\end{equation}
$$</p>
<h4 id="3221-启动代价">3.2.2.1 启动代价</h4>
<p>索引扫描的启动代价就是读取索引页以访问目标表的第一条元组的代价，由下面的公式定义：
$$
\begin{equation}
\verb| start-up_cost| = {\mathrm{ceil}(\log_2 (N_{\verb|index|,\verb|tuple|}))
+ (H_{\verb|index|} + 1) × 50} × \verb|cpu_operator_cost|
\end{equation}
$$
其中$H_{\verb|index|}$是索引树的高度。</p>
<p>在本例中，套用公式(3)，$N_{\verb|index,tuple|}$是10000；$H_{\verb|index|}$是1；$\verb|cpu_operator_cost|$是0.0025（默认值）。因此
$$
\begin{equation}\tag{5}
\verb|start-up_cost| = {\mathrm{ceil}(\log_2(10000)) + (1 + 1) × 50} × 0.0025 = 0.285
\end{equation}
$$</p>
<h4 id="3222-运行代价">3.2.2.2 运行代价</h4>
<p>索引扫描的运行代价是表和索引的CPU代价与IO代价之和。
$$
\begin{align}
\verb|run_cost| &amp;= (\verb|index_cpu_cost| + \verb|table_cpu_cost|)
+ (\verb|index_io_cost| + \verb|table_io_cost|).
\end{align}
$$</p>
<blockquote>
<p>如果使用<a href="https://www.postgresql.org/docs/10/static/indexes-index-only-scans.html">仅索引扫描</a>，则不会估计<code>table_cpu_cost</code>与<code>table_io_cost</code>，仅索引扫描将在<a href="/zh/blog/kernel/ch7/">第七章</a>中介绍。</p>
</blockquote>
<p>前三个代价（即<code>index_cpu_cost</code>，<code>table_cpu_cost</code>和<code>index_io_cost</code>）如下所示：</p>
<p>$$
\begin{align}
\verb|index_cpu_cost| &amp;= \verb|Selectivity| × N_{\verb|index|,\verb|tuple|} × (\verb|cpu_index_tuple_cost| + \verb|qual_op_cost|) \
\verb|table_cpu_cost| &amp;= \verb|Selectivity| × N_{\verb|tuple|}× \verb|cpu_tuple_cost| \
\verb|index_io_cost|   &amp;= \mathrm{ceil}(\verb|Selectivity| × N_{\verb|index|,\verb|page|}) ×\verb|random_page_cost|
\end{align}
$$</p>
<p>以上公式中的<a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-CPU-INDEX-TUPLE-COST"><code>cpu_index_tuple_cost</code></a>和<a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-RANDOM-PAGE-COST"><code>random_page_cost</code></a>在<em>postgresql.conf</em>中配置（默认值分别为0.005和4.0）。$\verb|qual_op_cost|$粗略来说就是索引求值的代价，默认值是0.0025，这里不再展开。**选择率（Selectivity）**是一个0到1之间的浮点数，代表查询指定的<code>WHERE</code>子句在索引中搜索范围的比例。举个例子，$(\verb|Selectivity| × N_{\verb|tuple|})$就是需要读取的表元组数量，$(\verb|Selectivity| × N_{\verb|index|,\verb|tuple|})$就是需要读取的索引元组数量，诸如此类。</p>
<blockquote>
<h4 id="选择率selectivity">选择率（Selectivity）</h4>
<p>查询谓词的选择率是通过**直方图界值（histogram_bounds）<strong>与</strong>高频值（Most Common Value, MCV）**估计的，这些信息都存储在系统目录<code>pg_statistics</code>中，并可通过<code>pg_stats</code>视图查询。这里通过一个具体的例子来简要介绍选择率的计算方法，细节可以参考<a href="https://www.postgresql.org/docs/10/static/row-estimation-examples.html">官方文档</a>。</p>
<p>表中每一列的高频值都在<code>pg_stats</code>视图的<code>most_common_vals</code>和<code>most_common_freqs</code>中成对存储。</p>
<ul>
<li><strong>高频值（most_common_vals）</strong>：该列上最常出现的取值列表</li>
<li><strong>高频值频率（most_common_freqs）</strong>：高频值相应出现频率的列表</li>
</ul>
<p>下面是一个简单的例子。表<code>countries</code>有两列：一列<code>country</code>存储国家名，一列<code>continent</code>存储该国所属大洲。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">\</span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">countries</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;public.countries&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Column</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Type</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Modifiers</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------+------+-----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">country</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">continent</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Indexes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;continent_idx&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">continent</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">continent</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;number of countries&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">-#</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">countries</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">real</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;number of countries / all countries&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">-#</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">countries</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">continent</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;number of countries&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">continent</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">countries</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">countries</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">all</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">countries</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------+---------------------+-------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Africa</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#0000cf;font-weight:bold">53</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">274611398963731</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Europe</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#0000cf;font-weight:bold">47</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">243523316062176</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Asia</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#0000cf;font-weight:bold">44</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">227979274611399</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">North</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">America</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#0000cf;font-weight:bold">23</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">119170984455959</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Oceania</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0725388601036269</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">South</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">America</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0621761658031088</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>考虑下面的查询，该查询带有<code>WHERE</code>条件<code>continent = 'Asia'</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">countries</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">continent</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;Asia&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这时候，计划器使用<code>continent</code>列上的高频值来估计索引扫描的代价，列上的<code>most_common_vals</code>与 <code>most_common_freqs</code>如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">\</span><span style="color:#000">x</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Expanded</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">display</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">is</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">most_common_vals</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">most_common_freqs</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">-#</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;countries&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">attname</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;continent&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RECORD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic">-----+-----------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">most_common_vals</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#000">Africa</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">Europe</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">Asia</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;North America&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">Oceania</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;South America&#34;</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">most_common_freqs</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">274611</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">243523</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">227979</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">119171</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0725389</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0621762</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>与<code>most_common_vals</code>中<code>Asia</code>值对应的<code>most_common_freqs</code>为0.227979。因此0.227979会在估算中被用作选择率。</p>
<p>如果高频值不可用，就会使用目标列上的直方图界值来估计代价。</p>
<ul>
<li>**直方图值（histogram_bounds）**是一系列值，这些值将列上的取值划分为数量大致相同的若干个组。</li>
</ul>
<p>下面是一个具体的例子。这是表<code>tbl</code>中<code>data</code>列上的直方图界值；</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">histogram_bounds</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;tbl&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">attname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;data&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        			     	      </span><span style="color:#000">histogram_bounds</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">300</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">400</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">600</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">700</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">800</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">900</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1200</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1300</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1400</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1500</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1600</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1700</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1800</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1900</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">2200</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2300</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2400</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2500</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2600</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2700</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2800</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2900</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3200</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3300</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3400</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3500</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3600</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3700</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3800</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3900</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4000</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">4200</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4300</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4400</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4500</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4600</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4700</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4800</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4900</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5200</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5300</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5400</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5500</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5600</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5700</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5800</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5900</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">6000</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">6100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">6200</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">6300</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">6400</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">6500</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">6600</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">6700</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">6800</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">6900</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">7000</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">7100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">7200</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">7300</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">7400</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">7500</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">7600</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">7700</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">7800</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">7900</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">8000</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">8100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">8200</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">8300</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">8400</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">8500</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">8600</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">8700</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">8800</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">8900</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">9000</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">9100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">9200</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">9300</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">9400</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">9500</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">9600</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">9700</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">9800</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">9900</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>默认情况下，直方图界值会将列上的取值划分入100个桶。图3.7展示了这些桶及其对应的直方图界值。桶从0开始编号，每个桶保存了（大致）相同数量的元组。直方图界值就是相应桶的边界。比如，直方图界值的第0个值是1，意即这是<code>bucket_0</code>中的最小值。第1个值是100，意即<code>bucket_1</code>中的最小值是100，等等。</p>
<p><strong>图3.7 桶和直方图界值</strong></p>
<p><img src="/img/blog/kernel/fig-3-07.png"></p>
<p>然后本节例子中选择率计算如下所示。假设查询带有<code>WHERE</code>子句<code>data &lt; 240</code>，而值240落在第二个桶中。在本例中可以通过线性插值推算出相应的选择率。因此查询中<code>data</code>列的选择率可以套用下面的公式计算：
$$
\verb|Selectivity| = \frac{2+(240-hb[2])/(hb[3]-hb[2])}{100}=\frac{2+(240-200)/(300-200)}{100}=\frac{2+40/100}{100}=0.024    \ (6)
$$</p>
</blockquote>
<p>因此，根据公式(1)，(3)，(4)和(6)，有
$$
\begin{equation}\tag{7}
\verb|index_cpu_cost| = 0.024× 10000 × (0.005+0.0025)=1.8
\end{equation}
$$
$$
\begin{equation}\tag{8}
\verb|table_cpu_cost| = 0.024 × 10000 × 0.01 = 2.4
\end{equation}
$$</p>
<p>$$
\begin{equation}\tag{9}
\verb|index_io_cost| = \mathrm{ceil}(0.024 × 30) × 4.0 = 4.0
\end{equation}
$$</p>
<p>$\verb|table_io_cost|$ 由下面的公式定义：
$$
\begin{equation}
\verb|table_io_cost| = \verb|max_io_cost| + \verb|indexCorerelation|^2 × (\verb|min_io_cost|-\verb|max_io_cost|)
\end{equation}
$$</p>
<p>$\verb|max_io_cost_io_cost|$ 是最差情况下的I/O代价，即，随机扫描所有数据页的代价；这个代价由以下公式定义：
$$
\begin{equation}
\verb|max_io_cost| = N_{\verb|page|} × \verb|random_page_cost|
\end{equation}
$$</p>
<p>在本例中，由(2)，$N_{\verb|page|}=45$，得
$$
\begin{equation}\tag{10}
\verb|max_io_cost| = 45 × 4.0 = 180.0
\end{equation}
$$</p>
<p>$\verb|min_io_cost|$是最优情况下的I/O代价，即，顺序扫描选定的数据页；这个代价由以下公式定义：
$$
\begin{equation}
\verb|min_io_cost| = 1 × \verb|random_page_cost| + (\mathrm{ceil}(\verb|Selectivity| × N_{\verb|page|})-1) × \verb|seq_page_cost|
\end{equation}
$$
在本例中，
$$
\begin{equation} \tag{11}
\verb|min_io_cost| \ = 1 × 4.0 + (\mathrm{ceil}(0.024 × 45)-1) × 1.0
\end{equation}
$$</p>
<p>下文详细介绍$\verb|indexCorrelation|$，在本例中，
$$
\begin{equation} \tag{12}
\verb|indexCorrelation| = 1.0
\end{equation}
$$</p>
<p>由(10)，(11)和(12)，得
$$
\begin{equation} \tag{13}
\verb|table_io_cost| = 180.0+1.0^2 × (5.0-180.0)=5.0
\end{equation}
$$</p>
<p>综上，由(7)，(8)，(9)和(13)得
$$
\begin{equation}\tag{14}
\verb|run_cost| = (1.8+2.4)+(4.0+5.0)=13.2
\end{equation}
$$</p>
<blockquote>
<h5 id="索引相关性index-correlation">索引相关性（index correlation）</h5>
<p>索引相关性是列值在物理上的顺序和逻辑上的顺序的统计相关性（引自官方文档）。索引相关性的取值范围从$-1$到$+1$。下面的例子有助于理解索引扫描和索引相关性的关系。</p>
<p>表<code>tbl_corr</code>有5个列：两个列为文本类型，三个列为整数类型。这三个整数列保存着从1到12的数字。在物理上表<code>tbl_corr</code>包含三个页，每页有4条元组。每个数字列有一个名如<code>index_col_asc</code>的索引。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">\</span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_corr</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;public.tbl_corr&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Column</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Type</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Modifiers</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------+---------+-----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">col</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">col_asc</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">col_desc</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">col_rand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Indexes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;tbl_corr_asc_idx&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">col_asc</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;tbl_corr_desc_idx&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">col_desc</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;tbl_corr_rand_idx&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">col_rand</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">col</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">col_asc</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">col_desc</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">col_rand</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">-#</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_corr</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">col</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">col_asc</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">col_desc</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">col_rand</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------+---------+----------+----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Tuple_1</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Tuple_2</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Tuple_3</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Tuple_4</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Tuple_5</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Tuple_6</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Tuple_7</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Tuple_8</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Tuple_9</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Tuple_10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Tuple_11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Tuple_12</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这些列的索引相关性如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">attname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">correlation</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;tbl_corr&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">attname</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">correlation</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------+----------+-------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_corr</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">col_asc</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_corr</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">col_desc</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_corr</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">col_rand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">125874</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>当执行下列查询时，由于所有的目标元组都在第一页中，PostgreSQL只会读取第一页，如图3.8(a)所示。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_corr</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">col_asc</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BETWEEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>而执行下列查询时则不然，PostgreSQL需要读所有的页，如图3.8(b)所示。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_corr</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">col_rand</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BETWEEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>如此可知，索引相关性是一种统计上的相关性。在索引扫描代价估计中，索引相关性体现了索引顺序和物理元组顺序扭曲程度给随机访问性能造成的影响大小。</p>
<p><strong>图3.8 索引相关性</strong></p>
<p><img alt="indexcor" src="/img/blog/kernel/fig-3-08.png"></p>
</blockquote>
<h4 id="3223-整体代价">3.2.2.3 整体代价</h4>
<p>由(3)和(14)可得
$$
\begin{equation}\tag{15}
\verb|total_cost| = 0.285 + 13.2 = 13.485
\end{equation}
$$</p>
<p>作为确认，上述<code>SELECT</code>查询的<code>EXPLAIN</code>结果如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">240</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                                 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_data_idx</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">49</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">240</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">240</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在第4行可以看到启动代价和总代价分别是0.29和13.49，预估有240条元组被扫描。</p>
<p>在第5行显示了一个索引条件<code>Index Cond:(data &lt; 240)</code>。更准确地说，这个条件叫做<strong>访问谓词（access predicate）</strong>，它表达了索引扫描的开始条件与结束条件。</p>
<blockquote>
<p>根据<a href="https://use-the-index-luke.com/sql/explain-plan/postgresql/filter-predicates">这篇文章</a>，PostgreSQL中的<code>EXPLAIN</code>命令不会区分<strong>访问谓词（access predicate）<strong>和</strong>索引过滤谓词（index filter predicate）</strong>。因此当分析<code>EXPLAIN</code>的输出时，即使看到了“IndexCond”，也应当注意一下预估返回行数。</p>
</blockquote>
<blockquote>
<h5 id="seq_page_cost和random_page_cost"><code>seq_page_cost</code>和<code>random_page_cost</code></h5>
<p><a href="https://www.postgresql.org/docs/10/static/runtime-config-query.html#GUC-SEQ-PAGE-COST"><code>seq_page_cost</code></a>和<a href="https://www.postgresql.org/docs/10/static/runtime-config-query.html#GUC-RANDOM-PAGE-COST"><code>random_page_cost</code></a>的默认值分别为1.0和4.0。这意味着PostgreSQL假设随机扫描比顺序扫描慢4倍；显然，PostgreSQL的默认值是基于HDD（普通硬盘）设置的。</p>
<p>另一方面，近年来SSD得到了广泛的应用，<code>random_page_cost</code>的默认值就显得太大了。使用SSD时如果仍然采用<code>random_page_cost</code>的默认值，则计划器有可能会选择低效的计划。因此当使用SSD时最好将<code>random_page_cost</code>的值设为1.0。</p>
<p><a href="https://amplitude.engineering/how-a-single-postgresql-config-change-improved-slow-query-performance-by-50x-85593b8991b0">这篇文章</a>报告了使用<code>random_page_cost</code>默认值导致的问题。</p>
</blockquote>
<h3 id="323-排序">3.2.3 排序</h3>
<p><strong>排序路径（sort path）</strong> 会在排序操作中被使用。排序操作包括<code>ORDER BY</code>，归并连接的预处理操作，以及其他函数。函数<code>cost_sort()</code>用于估计排序操作的代价。</p>
<p>如果能在工作内存中放下所有元组，那么排序操作会选用快速排序算法。否则的话则会创建临时文件，使用文件归并排序算法。</p>
<p>排序路径的启动代价就是对目标表的排序代价，因此代价就是$O(N_{\verb|sort|}× \log_2(N_{\verb|sort|})$，这里$N_{\verb|sort|}$就是待排序的元组数。排序路径的运行代价就是读取已经排好序的元组的代价，因而代价就是$O(N_{sort})$。</p>
<p>本节将研究以下查询排序代价的估计过程。假设该查询只使用工作内存，不使用临时文件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">240</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在本例中，启动代价由以下公式定义：
$$
\begin{equation}
\verb|start-up_cost| = \verb|C|+ \verb|comparison_cost| × N_{\verb|sort|} × \log_2(N_{\verb|sort|})
\end{equation}
$$</p>
<p>这里$C$就是上一次扫描的总代价，即上次索引扫描的总代价；由(15)可得C等于13.485；$N_{\verb|sort|}=240$；$\verb|comparison_cost|$ 定义为$2 × \verb|cpu_operator_cost|$。因此有</p>
<p>$$
\begin{equation}
\verb|start-up_cost| = 13.485+(2×0.0025)×240.0×\log_2(240.0)=22.973
\end{equation}
$$</p>
<p>运行代价是在内存中读取排好序的元组的代价，即：
$$
\begin{equation}
\verb|run_cost| = \verb|cpu_operator_cost| × N_{\verb|sort|} = 0.0025 × 240 = 0.6
\end{equation}
$$
综上：
$$
\begin{equation}
\verb|total_cost|=22.973+0.6=23.573
\end{equation}
$$
作为确认，以上<code>SELECT</code>查询的<code>EXPLAIN</code>命令结果如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">240</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                   </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                                    
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">97</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">57</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">240</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_data_idx</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">49</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">240</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">240</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在第4行可以看到启动代价和运行代价分别为22.97和23.57。</p>
<h2 id="33-创建单表查询的计划树">3.3 创建单表查询的计划树</h2>
<p>计划器非常复杂，故本节仅描述最简单的情况，即单表查询的计划树创建过程。更复杂的查询，换而言之即多表查询，其计划树创建过程将在第3.6节中阐述。</p>
<p>PostgreSQL中的计划器会执行三个处理步骤：</p>
<ol>
<li>执行预处理</li>
<li>在所有可能的访问路径中，找出代价最小的访问路径</li>
<li>按照代价最小的路径，创建计划树</li>
</ol>
<p><strong>访问路径（access path）<strong>是估算代价时的处理单元；比如，顺序扫描，索引扫描，排序以及各种连接操作都有其对应的</strong>路径</strong>。访问路径只在计划器创建查询计划树的时候使用。最基本的访问路径数据结构就是<a href="https://github.com/postgres/postgres/blob/master/src/include/nodes/relation.h"><code>relation.h</code></a>中定义的<code>Path</code>结构体。它就相当于是顺序扫描。所有其他的访问路径都基于该结构，下面会介绍细节。</p>
<p>计划器为了处理上述步骤，会在内部创建一个<code>PlannerInfo</code>数据结构。在该数据结构中包含着查询树，查询所涉及关系信息，访问路径等等。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">PathKey</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">NodeTag</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">EquivalenceClass</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pk_eclass</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 值是否有序 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Oid</span> <span style="color:#000">pk_opfamily</span><span style="color:#000;font-weight:bold">;</span>             <span style="color:#8f5902;font-style:italic">/* 用于定义顺序的B树操作符族 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">pk_strategy</span><span style="color:#000;font-weight:bold">;</span>             <span style="color:#8f5902;font-style:italic">/* 排序方向(ASC or DESC) */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">pk_nulls_first</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* NULL是否排序在常规值之前？ */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">PathKey</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">Path</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">NodeTag</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">NodeTag</span> <span style="color:#000">pathtype</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">/* 标识 scan/join 方法的标签 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">RelOptInfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">parent</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 路径所基于的关系 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PathTarget</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pathtarget</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* Vars/Exprs的列表, 代价, 宽度 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ParamPathInfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">param_info</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 参数化信息, 如果没有则为NULL */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">parallel_aware</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* 涉及到并行相关的逻辑？ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">parallel_safe</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 是否能作为并行执行计划的一部分? */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">parallel_workers</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* 期待的并行工作进程数量； 0表示没有并行 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* 估计路径的尺寸或代价 (更多详情参考costsize.c) */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">rows</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* 预估结果元组数目 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Cost</span> <span style="color:#000">startup_cost</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 获取任何元组前需要花费的代价 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Cost</span> <span style="color:#000">total_cost</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* 总代价 (假设获取所有元组所需代价) */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pathkeys</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* 路径输出的排序顺序 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* pathkeys 是PathKey节点的列表，PathKey定义见上面 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">Path</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">PlannerInfo</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">NodeTag</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Query</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">parse</span><span style="color:#000;font-weight:bold">;</span>                    <span style="color:#8f5902;font-style:italic">/* 被计划的查询 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PlannerGlobal</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">glob</span><span style="color:#000;font-weight:bold">;</span>             <span style="color:#8f5902;font-style:italic">/* 当前计划器运行时的全局信息 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Index</span> <span style="color:#000">query_level</span><span style="color:#000;font-weight:bold">;</span>               <span style="color:#8f5902;font-style:italic">/* 最外层查询为1 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">PlannerInfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">parent_root</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 最外层查询为NULL */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* plan_params包含着当前计划中的查询层次需要对低层查询暴露的表达式。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * outer_params包含着PARAM_EXEC参数中的paramId列表，这些参数是外
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 部查询层次对当前查询层次所暴露的。*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">plan_params</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* PlannerParamItems的列表, 见下 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Bitmapset</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">outer_params</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* simple_rel_array 持有着指向“基础关系”与“其他关系”的指针 (详情参考
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * RelOptInfo的注释)。它由rangetable index所索引（因此第0项总是废值）。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 当RTE并不与基础关系相对应，譬如连接的RTE，或未引用的视图RTE，或该
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * RelOptInfo还没有产生时，里面的项目可能为NULL。*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">RelOptInfo</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">simple_rel_array</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 所有单个关系的RelOptInfos */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">simple_rel_array_size</span><span style="color:#000;font-weight:bold">;</span>            <span style="color:#8f5902;font-style:italic">/* 数组分配的大小 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* simple_rte_array 与simple_rel_array 长度相同，且持有指向关联范围表项的指针。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 这使得我们能避免执行rt_fetch(), 当需要展开很大的继承集时会很慢。 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">RangeTblEntry</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">simple_rte_array</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* rangetable的数组 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* all_baserels是所有查询所涉及基本关系的关系ID列表（但不含“其他关系”的ID）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 也就是说，最终连接时，所需构建的关系标识符。该字段是由make_one_rel计算的。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 计算发生于计算Paths之前。*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Relids</span> <span style="color:#000">all_baserels</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* nullable_baserels 是在进行外连接的jointree中那些可空的基础关系的ID集合。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 这些关系可能在WHERE子句，SELECT目标列表或其他地方产生空值。该字段由函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * deconstruct_jointree负责计算。*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Relids</span> <span style="color:#000">nullable_baserels</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* join_rel_list是一个列表，在计划过程中连接关系的RelOptInfos都放在这里。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 对于比较小的问题，我们只是简单的扫过这个列表来完成查找。但当连接很多关系时，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 我们会使用散列表来加速查询。散列表当且仅当join_rel_hash不为空时存在且
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 有效。注意即使用散列表查找时，我们依然会维护列表，这会简化GEQO的相关问题。*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">join_rel_list</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 连接关系的RelOptInfos */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">HTAB</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">join_rel_hash</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 连接关系的散列表，可选 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* 当使用动态规划进行连接搜索时，join_rel_level[k]是第k层的连接关系RelOptInfos列表。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 新的连接关系RelOptInfos会自动添加到join_rel_level[join_cur_level]中，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 而join_cur_level为当前层级。如果没用到动态规划，join_rel_level则为空。*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">join_rel_level</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* 连接关系RelOptInfo的列表 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">join_cur_level</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* 待追加列表的序号 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">init_plans</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* 查询的初始SubPlans */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cte_plan_ids</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* 子计划的ID列表，每个CTE对应一个 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">multiexpr_params</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* MULTIEXPR子查询输出用到的双层嵌套参数列表 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eq_classes</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* 活跃的EquivalenceClasses列表 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">canon_pathkeys</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">/* &#34;标准&#34; PathKeys 的列表 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">left_join_clauses</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">/* RestrictInfos列表，用于左连接子句 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">right_join_clauses</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* RestrictInfos列表，用于右连接子句 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">full_join_clauses</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">/* RestrictInfos列表，用于完全连接子句 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">join_info_list</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">/* SpecialJoinInfos 的列表 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">append_rel_list</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* AppendRelInfos 的列表 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rowMarks</span><span style="color:#000;font-weight:bold">;</span>           <span style="color:#8f5902;font-style:italic">/* PlanRowMarks 的列表 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">placeholder_list</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* PlaceHolderInfos 的列表 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">fkey_list</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">/* ForeignKeyOptInfos 的列表 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">query_pathkeys</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">/* query_planner()期望的pathkeys */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">group_pathkeys</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">/* groupClause的pathkeys, 如果有的话 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">window_pathkeys</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* 底部窗口的pathkeys, 如果有的话 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">distinct_pathkeys</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">/* distinctClause的pathkeys, 如果有的话 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sort_pathkeys</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* sortClause的pathkeys, 如果有的话 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">initial_rels</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* 我们现在正在尝试连接的RelOptInfos */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* 使用fetch_upper_rel()来获取任意特定的上层关系 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">upper_rels</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">UPPERREL_FINAL</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#8f5902;font-style:italic">/* upper-rel RelOptInfos */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* grouping_planner针对上层处理过程选择的目标列表 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">PathTarget</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">upper_targets</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">UPPERREL_FINAL</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* grouping_planner会将最终处理过后的targetlist回传至此。在最终计划最顶层的目标列表中会用到 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">processed_tlist</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* create_plan()期间填充的字段，定义于setrefs.c */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">AttrNumber</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">grouping_map</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* 针对GroupingFunc的修补 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">minmax_aggs</span><span style="color:#000;font-weight:bold">;</span>           <span style="color:#8f5902;font-style:italic">/* MinMaxAggInfos列表 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">MemoryContext</span> <span style="color:#000">planner_cxt</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* 持有PlannerInfo的上下文 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">total_table_pages</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* 查询涉及到所有表的页面总数 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">tuple_fraction</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* 传递给查询计划器的tuple_fraction */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">limit_tuples</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* 传递给查询计划器的limit_tuples */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">hasInheritedTarget</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">/* 若parse-&gt;resultRelation为继承的子关系则为真 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">hasJoinRTEs</span><span style="color:#000;font-weight:bold">;</span>            <span style="color:#8f5902;font-style:italic">/* 如果任意RTEs为RTE_JOIN类别则为真 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">hasLateralRTEs</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* 如果任意RTEs被标记为LATERAL则为真 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">hasDeletedRTEs</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* 如果任意RTEs从连接树中被删除则为真 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">hasHavingQual</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">/* 如果havingQual非空则为真 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">hasPseudoConstantQuals</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 如果任意RestrictInfo包含
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    								pseudoconstant = true则为真 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">hasRecursion</span><span style="color:#000;font-weight:bold">;</span>           <span style="color:#8f5902;font-style:italic">/* 如果计划中包含递归WITH项则为真 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* 当hasRecursion为真时，会使用以下字段： */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">wt_param_id</span><span style="color:#000;font-weight:bold">;</span>                 <span style="color:#8f5902;font-style:italic">/* 工作表上PARAM_EXEC的ID */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">Path</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">non_recursive_path</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 非递归项的路径 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* 这些字段是createplan.c的工作变量 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Relids</span> <span style="color:#000">curOuterRels</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">/* 当前节点外部的关系 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">curOuterParams</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 尚未赋值的NestLoopParams */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* 可选的join_search_hook私有数据, 例如, GEQO */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">join_search_private</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">PlannerInfo</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>本节会通过一个具体的例子，来描述如何基于查询树创建计划树。</p>
<h3 id="331-预处理">3.3.1 预处理</h3>
<p>在创建计划树之前，计划器对先<code>PlannerInfo</code>中的查询树进行一些预处理。</p>
<p>预处理有很多步骤，本节只讨论和单表查询处理相关的主要步骤。其他预处理操作将在3.6节中描述。</p>
<ol>
<li>
<p>简化<strong>目标列表（target list）</strong>，<code>LIMIT</code>子句等；</p>
<p>例如，表达式<code>2+2</code>会被重写为<code>4</code>，这是由<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/util/clauses.c"><code>clauses.c</code></a>中<code>eval_const_expressions()</code>函数负责的。</p>
</li>
<li>
<p>布尔表达式的规范化</p>
<p>例如，<code>NOT(NOT a)</code>会被重写为<code>a</code></p>
</li>
<li>
<p>压平与/或表达式</p>
<p>SQL标准中的AND/OR是二元操作符；但在PostgreSQL内部它们是多元操作符。而计划器总是会假设所有的嵌套AND/OR都应当被压平。</p>
<p>这里有一个具体的例子。考虑这样一个布尔表达式<code>(id = 1) OR (id = 2) OR (id = 3)</code>，图3.9(a) 展示了使用二元表达式时的查询树，预处理会将这些二元算子简化压平为一个三元算子，如图3.9(b)所示。</p>
<p><strong>图3.9. 压平布尔表达式的例子</strong></p>
<p><img alt="扁平化" src="/img/blog/kernel/fig-3-09.png"></p>
</li>
</ol>
<h3 id="332-找出代价最小的访问路径">3.3.2 找出代价最小的访问路径</h3>
<p>计划器对所有可能的访问路径进行代价估计，然后选择代价最小的那个。具体来说，计划器会执行以下几个步骤：</p>
<ol>
<li>
<p>创建一个<code>RelOptInfo</code>数据结构，存储访问路径及其代价。</p>
<p><code>RelOptInfo</code>结构体是通过<code>make_one_rel()</code>函数创建的，并存储于<code>PlannerInfo</code>结构体的<code>simple_rel_array</code>字段中，如图3.10所示。在初始状态时<code>RelOptInfo</code>持有着<code>baserestrictinfo</code>变量，如果存在相应索引，还会持有<code>indexlist</code>变量。<code>baserestrictinfo</code>存储着查询的<code>WHERE子</code>句，而<code>indexlist</code>存储着目标表上相关的索引。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">RelOptKind</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RELOPT_BASEREL</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RELOPT_JOINREL</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RELOPT_OTHER_MEMBER_REL</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RELOPT_UPPER_REL</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RELOPT_DEADREL</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">RelOptKind</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">RelOptInfo</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">NodeTag</span>		<span style="color:#000">type</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RelOptKind</span>	<span style="color:#000">reloptkind</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 本RelOptInfo包含的所有关系 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Relids</span>		<span style="color:#000">relids</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 基本关系的ID集合 (范围表索引) */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 由计划器生成的预估尺寸 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">double</span>		<span style="color:#000">rows</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 预估结果元组数目 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 计划器标记位，每个关系一份 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">consider_startup</span><span style="color:#000;font-weight:bold">;</span>	    <span style="color:#8f5902;font-style:italic">/* 保留启动代价最低的路径？ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">consider_param_startup</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 同上, 针对参数化路径？ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">consider_parallel</span><span style="color:#000;font-weight:bold">;</span>	    <span style="color:#8f5902;font-style:italic">/* 考虑并行路径？ */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 扫描当前关系的默认结果目标列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">PathTarget</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">reltarget</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* Vars/Exprs, 代价, 宽度的列表 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 物化相关信息 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pathlist</span><span style="color:#000;font-weight:bold">;</span>			    <span style="color:#8f5902;font-style:italic">/* Path 结构体列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ppilist</span><span style="color:#000;font-weight:bold">;</span>			    <span style="color:#8f5902;font-style:italic">/* pathlist中使用的ParamPathInfos */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">partial_pathlist</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 部分路径 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">Path</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cheapest_startup_path</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">Path</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cheapest_total_path</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">Path</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cheapest_unique_path</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cheapest_parameterized_paths</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 基础关系与连接关系都需要的 参数化信息 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* (参见 lateral_vars 与 lateral_referencers) */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Relids</span>		<span style="color:#000">direct_lateral_relids</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 直接以LATERAL方式引用的关系 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Relids</span>		<span style="color:#000">lateral_relids</span><span style="color:#000;font-weight:bold">;</span> 	    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 关于基础关系的信息 (连接关系不会设置这些字段！) */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Index</span>		<span style="color:#000">relid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Oid</span>		    <span style="color:#000">reltablespace</span><span style="color:#000;font-weight:bold">;</span>	    <span style="color:#8f5902;font-style:italic">/* 表空间 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RTEKind</span>		<span style="color:#000">rtekind</span><span style="color:#000;font-weight:bold">;</span>		    <span style="color:#8f5902;font-style:italic">/* RELATION, SUBQUERY, 或 FUNCTION */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AttrNumber</span>	<span style="color:#000">min_attr</span><span style="color:#000;font-weight:bold">;</span>		    <span style="color:#8f5902;font-style:italic">/* 关系属性的最小值 (通常&lt;0) */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AttrNumber</span>	<span style="color:#000">max_attr</span><span style="color:#000;font-weight:bold">;</span>		    <span style="color:#8f5902;font-style:italic">/* 关系属性的最大值 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Relids</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">attr_needed</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 被索引的数组 [min_attr .. max_attr] */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">int32</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">attr_widths</span><span style="color:#000;font-weight:bold">;</span>	   	<span style="color:#8f5902;font-style:italic">/* 被索引的数组 [min_attr .. max_attr] */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lateral_vars</span><span style="color:#000;font-weight:bold">;</span>	   	<span style="color:#8f5902;font-style:italic">/* 关系所引用的LATERAL Vars 与 PHVs */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Relids</span>		<span style="color:#000">lateral_referencers</span><span style="color:#000;font-weight:bold">;</span><span style="color:#8f5902;font-style:italic">/* 侧面引用本表的关系 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indexlist</span><span style="color:#000;font-weight:bold">;</span>		    <span style="color:#8f5902;font-style:italic">/* IndexOptInfo列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BlockNumber</span> <span style="color:#000">pages</span><span style="color:#000;font-weight:bold">;</span>			    <span style="color:#8f5902;font-style:italic">/* 来自pg_class的页面数估计值 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">double</span>		<span style="color:#000">tuples</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">double</span>		<span style="color:#000">allvisfrac</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PlannerInfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">subroot</span><span style="color:#000;font-weight:bold">;</span>		    <span style="color:#8f5902;font-style:italic">/* 如有子查询 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">subplan_params</span><span style="color:#000;font-weight:bold">;</span> 	<span style="color:#8f5902;font-style:italic">/* 如有子查询 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span>		    <span style="color:#000">rel_parallel_workers</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 期望的并行工作进程数量 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 有关外部表与外部表连接的相关信息 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Oid</span>			<span style="color:#000">serverid</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 外部表与外部表连接相应的服务器ID */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Oid</span>			<span style="color:#000">userid</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 用于检查访问权限的用户标识 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">useridiscurrent</span><span style="color:#000;font-weight:bold">;</span><span style="color:#8f5902;font-style:italic">/* 当前用户是否能合法进行JOIN */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">FdwRoutine</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">fdwroutine</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">void</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">fdw_private</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 被各种扫描与连接所使用 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">baserestrictinfo</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* RestrictInfo结构体列表 (如果存在基础关系) */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">QualCost</span>	<span style="color:#000">baserestrictcost</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 求值上述限制条件的代价 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">joininfo</span><span style="color:#000;font-weight:bold">;</span>		    <span style="color:#8f5902;font-style:italic">/* RestrictInfo 结构体列表，涉及到本表的连接会用到 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">has_eclass_joins</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* T 意味着joininfo不完整 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">RelOptInfo</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div></li>
<li>
<p>估计所有可能访问路径的代价，并将访问路径添加至<code>RelOptInfo</code>结构中。</p>
<p>这一处理过程的细节如下：</p>
<ol>
<li>创建一条路径，估计该路径中顺序扫描的代价，并将其写入路径中。将该路径添加到<code>RelOptInfo</code>结构的<code>pathlist</code>变量中。</li>
<li>如果目标表上存在相关的索引，则为每个索引创建相应的索引访问路径。估计所有索引扫描的代价，并将代价写入相应路径中。然后将索引访问路径添加到<code>pathlist</code>变量中。</li>
<li>如果可以进行<a href="https://wiki.postgresql.org/wiki/Bitmap_Indexes">位图扫描</a>，则创建一条位图扫描访问路径。估计所有的位图扫描的代价，并将代价写入到路径中。然后将位图扫描路径添加到<code>pathlist</code>变量中。</li>
</ol>
</li>
<li>
<p>从<code>RelOptInfo</code>的<code>pathlist</code>中，找出代价最小的访问路径。</p>
</li>
<li>
<p>如有必要，估计<code>LIMIT</code>，<code>ORDER BY</code>和<code>AGGREGATE</code>操作的代价。</p>
</li>
</ol>
<p>为了更加清晰的理解计划器的执行过程，下面给出了两个具体的例子。</p>
<h4 id="3321-例1">3.3.2.1 例1</h4>
<p>首先来研究一个不带索引的简单单表查询；该查询同时包含<code>WHERE</code>和<code>ORDER BY</code>子句。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">\</span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;public.tbl_1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Type</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Modifiers</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------+---------+-----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">300</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>图3.10和图3.11展示了本例中计划器的处理过程。</p>
<p><strong>图3.10 如何得到例1中代价最小的路径</strong></p>
<p><img src="/img/blog/kernel/fig-3-10.png"></p>
<ol>
<li>
<p>创建一个<code>RelOptInfo</code>结构，将其保存在<code>PlannerInfo</code>结构的<code>simple_rel_array</code>字段中。</p>
</li>
<li>
<p>在<code>RelOptInfo</code>结构的<code>baserestrictinfo</code>字段中，添加一条<code>WHERE</code>子句。</p>
<p><code>WHERE</code>子句<code>id&lt;300</code>会经由<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/plan/initsplan.c"><code>initsplan.c</code></a>中定义的<code>distribute_restrictinfo_to_rels()</code>函数，添加至列表变量<code>baserestrictinfo</code>中。另外由于目标表上没有相关索引，<code>RelOptInfo</code>的<code>indexlist</code>字段为空。</p>
</li>
<li>
<p>为了满足排序要求，<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/plan/planner.c"><code>planner.c</code></a>中的<code>standard_qp_callback()</code>函数会在<code>PlannerInfo</code>的<code>sor_pathkeys</code>字段中添加一个<code>pathkey</code>。</p>
<p><code>Pathkey</code>是表示路径排序顺序的数据结构。本例因为查询包含一条<code>ORDER BY</code>子句，且该子句中的列为<code>data</code>，故<code>data</code>会被包装为<code>pathkey</code>，放入列表变量<code>sort_pathkeys</code>中。</p>
</li>
<li>
<p>创建一个<code>Path</code>结构，并使用<code>cost_seqscan</code>函数估计顺序扫描的代价，并将代价写入<code>Path</code>中。然后使用<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/util/pathnode.c"><code>pathnode.c</code></a>中定义的<code>add_path()</code>函数，将该路径添加至<code>RelOptInfo</code>中。</p>
<p>如之前所提到过的，<code>Path</code>中同时包含启动代价和总代价，都是由<code>cost_seqscan</code>函数所估计的。</p>
</li>
</ol>
<p>在本例中，因为目标表上没有索引，计划器只估计了顺序扫描的代价，因此最小代价是自动确定的。</p>
<p><strong>图3.11 如何得到例1中代价最小的路径（接图3.10）</strong></p>
<p><img src="/img/blog/kernel/fig-3-11.png"></p>
<ol start="5">
<li>
<p>创建一个新的<code>RelOptInfo</code>结构，用于处理<code>ORDER BY</code>子句。</p>
<p>注意新的<code>RelOptInfo</code>没有<code>baserestrictinfo</code>字段，该信息已经被<code>WHERE</code>子句所持有。</p>
</li>
<li>
<p>创建一个排序路径，并添加到新的<code>RelOptInfo</code>中；然后让<code>SortPath</code>的<code>subpath</code>字段指向顺序扫描的路径。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">SortPath</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Path</span>	<span style="color:#000">path</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Path</span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">subpath</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 代表输入来源的子路径 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">SortPath</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p><code>SortPath</code>结构包含两个<code>Path</code>结构：<code>path</code>与<code>subpath</code>；<code>path</code>中存储了排序算子本身的相关信息，而<code>subpath</code>则指向之前得到的代价最小的路径。</p>
<p>注意顺序扫描路径中<code>parent</code>字段，该字段指向之前的<code>RelOptInfo</code>结构体（也就是在<code>baserestrictinfo</code>中存储着<code>WHERE</code>子句的那个<code>RelOptInfo</code>）。因此在下一步创建计划树的过程中，尽管新的<code>RelOptInfo</code>结构并未包含<code>baserestrictinfo</code>，但计划器可以创建一个包含<code>Filter</code>的顺序扫描节点，将<code>WHERE</code>子句作为过滤条件。</p>
</li>
</ol>
<p>这里已经获得了代价最小的访问路径，然后就可以基于此生成一颗计划树。3.3.3节描述了相关的细节。</p>
<h4 id="3322-例2">3.3.2.2 例2</h4>
<p>下面我们将研究另一个单表查询的例子，这一次表上有两个索引，而查询带有一个<code>WHERE</code>子句。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">\</span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;public.tbl_2&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Type</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Modifiers</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------+---------+-----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Indexes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;tbl_2_pkey&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;tbl_2_data_idx&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">240</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>图3.12到3.14展示了本例中计划器的处理过程。</p>
<ol>
<li>
<p>创建一个<code>RelOptInfo</code>结构体</p>
</li>
<li>
<p>在<code>baserestrictinfo</code>中添加一个<code>WHERE</code>子句；并将目标表上的索引（们）添加到<code>indexlist</code>中。</p>
<p>在本例中，<code>WHERE</code>子句<code>'id &lt;240'</code>会被添加至<code>baserestrictinfo</code>中，而两个索引：<code>tbl_2_pkey</code>和<code>tbl_2_data_idx</code>会被添加至<code>RelOptInfo</code>的列表变量<code>indexlist</code>中。</p>
</li>
<li>
<p>创建一条路径，估计其顺序扫描代价，并添加到<code>RelOptInfo</code>的<code>pathlist</code>中。</p>
</li>
</ol>
<p><strong>图3.12 如何得到例2中代价最小的路径</strong></p>
<p><img src="/img/blog/kernel/fig-3-12.png"></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">IndexPath</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Path</span>			<span style="color:#000">path</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">IndexOptInfo</span> 	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indexinfo</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indexclauses</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indexquals</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indexqualcols</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indexorderbys</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indexorderbycols</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ScanDirection</span> 	<span style="color:#000">indexscandir</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Cost</span>			<span style="color:#000">indextotalcost</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Selectivity</span> 	<span style="color:#000">indexselectivity</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">IndexPath</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * IndexOptInfo
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *      用于计划/优化的信息，每个索引对应一个。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		indexkeys[], indexcollations[], opfamily[], 以及 opcintype[]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		每个字段都有 ncolumns 个项.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		sortopfamily[], reverse_sort[], 以及 nulls_first[] 类似，也都有
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		ncolumns 个项, 当且仅当该索引是有序的，否则这些指针都为空。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		indexkeys[] 数组中的零值表示该索引列是一个表达式，而每个这种列在indexprs
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *      中都会有一个对应的元素。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *      对于有序索引，reverse_sort[] 以及 nulls_first[] 描述了正向索引扫描时
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *      索引的排序顺序。当进行反向索引扫描时，就会产生相反的顺序。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		indexprs 与 indpred 会通过prepqual.c 中的 eval_const_expressions() 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *      用于简单地与WHERE子句匹配，indpred使用简单的合取范式。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		indextlist 是 TargetEntry的列表，标识着索引建在哪些列上。对于简单的列，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *      它会提供基本关系中与之对应的Var，对于表达式列，它还会指向indexprs对应元素。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *      相对应的Var。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		当IndexOptInfo创建时，这里大多数字段都会被填充 (plancat.c)，但indrestrictinfo 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *      与predOK会在稍后通过check_index_predicates()设置。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">IndexOptInfo</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">NodeTag</span>		<span style="color:#000">type</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Oid</span>		    <span style="color:#000">indexoid</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 索引关系的OID */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Oid</span>		    <span style="color:#000">reltablespace</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 索引所属的表空间 (不是表) */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RelOptInfo</span> 	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rel</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 索引对应的表，反向链接 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 索引尺寸的统计 (来自pg_class和其他地方) */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BlockNumber</span> <span style="color:#000">pages</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 索引中的磁盘页面数 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">double</span>		<span style="color:#000">tuples</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 索引中的元组数量 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span>		    <span style="color:#000">tree_height</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 索引树的高度，未知则为 -1  */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 索引描述符信息 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span>		    <span style="color:#000">ncolumns</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 索引中列的数量 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span>		    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indexkeys</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 索引中列的序号，或者0 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Oid</span>		    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indexcollations</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 索引列上排序规则的OID */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Oid</span>		    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">opfamily</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 列上运算符族的OID */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Oid</span>		    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">opcintype</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 运算符族输入数据类型的OID */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Oid</span>		    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sortopfamily</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 如果这些列有序，B树算子族的OID */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">reverse_sort</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 排序顺序是反向降序的吗？ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">nulls_first</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 排序顺序中，空值是排在最前面的吗？ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">canreturn</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 在仅索引扫描中，哪些索引列可以被返回？ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Oid</span>		    <span style="color:#000">relam</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 访问方法的OID (在 pg_am 中) */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indexprs</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 非平凡的索引列，即表达式 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indpred</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 如果是部分索引，则为谓词，否则为空 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indextlist</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 表示索引列的目标列表 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indrestrictinfo</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 父关系的baserestrictinfo列表 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">predOK</span><span style="color:#000;font-weight:bold">;</span>			    <span style="color:#8f5902;font-style:italic">/* 如果查询与索引谓词匹配则为真 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">unique</span><span style="color:#000;font-weight:bold">;</span>			    <span style="color:#8f5902;font-style:italic">/* 唯一索引则为真 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">immediate</span><span style="color:#000;font-weight:bold">;</span>		    <span style="color:#8f5902;font-style:italic">/* 唯一约束是否是立即强制实施的？ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">hypothetical</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 如果索引并非真实存在则为真。 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 剩下这些字段是从索引访问方法的API结构里复制过来的 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">amcanorderbyop</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">/* 访问方法是否支持按算子结果排序？ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">amoptionalkey</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 查询是否可以忽略第一列中的键？ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">amsearcharray</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 访问方法是否能处理ScalarArrayOpExpr限定条件? */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">amsearchnulls</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 访问方法是否能搜索空项或非空项？ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">amhasgettuple</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 访问方法是否有amgettuple接口？ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">amhasgetbitmap</span><span style="color:#000;font-weight:bold">;</span> 	<span style="color:#8f5902;font-style:italic">/* 访问方法是否有amgetbitmap接口？ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 相比include amapi.h，我们直接在这里用这种方式声明 amcostestimate  */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">void</span>		<span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">amcostestimate</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">();</span>	<span style="color:#8f5902;font-style:italic">/* 访问方法的代价估计器 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">IndexOptInfo</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><ol start="4">
<li>
<p>创建一个<code>IndexPath</code>，估计索引扫描的代价，并通过<code>add_path()</code>函数将<code>IndexPath</code>添加到<code>RelOptInfo</code>的<code>pathlist</code>中。</p>
<p>在本例中有两个索引：<code>tbl_2_pkey</code>与<code>tbl_2_data_index</code>，这些索引会按先后顺序依次处理。</p>
<p>一条针对<code>tbl_2_pkey</code>的<code>IndexPath</code>会先被创建出来，并进行启动代价与总代价的评估。在本例中，<code>tbl_2_pkey</code>是<code>id</code>列上的索引，而<code>WHERE</code>子句也包含该<code>id</code>列；因此<code>WHERE</code>子句会被存储在<code>IndexPath</code>的<code>indexclauses</code>字段中。</p>
</li>
<li>
<p>创建另一个<code>IndexPath</code>，估计另一种索引扫描的代价，并将该<code>IndexPath</code>添加到<code>RelOptInfo</code>的<code>pathlist</code>中。</p>
<p>接下来，与<code>tbl_2_data_idx</code>相应的<code>IndexPath</code>会被创建出来，并进行代价估计。本例中<code>tbl_2_data_idx</code>并没有相关的<code>WHERE</code>子句；因此其<code>indexclauses</code>为空。</p>
</li>
</ol>
<blockquote>
<p>注意<code>add_path()</code>函数并不总是真的会将路径添加到路径列表中。这一操作相当复杂，故这里就省去了具体描述。详细细节可以参考<code>add_path()</code>函数的注释。</p>
</blockquote>
<p><strong>图3.13 如何得到例2中代价最小的路径（接图3.12）</strong></p>
<p><img src="/img/blog/kernel/fig-3-13.png"></p>
<ol start="6">
<li>
<p>创建一个新的<code>RelOptInfo</code>结构</p>
</li>
<li>
<p>将代价最小的路径，添加到新<code>RelOptInfo</code>的<code>pathlist</code>中。</p>
<p>本例中代价最小的路径是使用<code>tbl_2_pkey</code>的索引路径；故将该路径添加到新的<code>RelOptInfo</code>中。</p>
</li>
</ol>
<p><strong>图3.14 如何得到例2中代价最小的路径（接图3.13）</strong></p>
<p><img src="/img/blog/kernel/fig-3-14.png"></p>
<h3 id="333-创建计划树">3.3.3 创建计划树</h3>
<p>在最后一步中，计划器按照代价最小的路径生成一颗计划树。 </p>
<p>计划树的根节点是定义在<a href="https://github.com/postgres/postgres/blob/master/src/include/nodes/plannodes.h"><code>plannodes.h</code></a>中的<code>PlannedStmt</code>结构，包含19个字段，其中有4个代表性字段：</p>
<ul>
<li>**<code>commandType</code>**存储操作的类型，诸如<code>SELECT</code>，<code>UPDATE</code>和<code>INSERT</code>。</li>
<li>**<code>rtable</code>**存储范围表的列表（<code>RangeTblEntry</code>的列表）。</li>
<li>**<code>relationOids</code>**存储与查询相关表的<code>oid</code>。</li>
<li>**<code>plantree</code>**存储着一颗由计划节点组成的计划树，每个计划节点对应着一种特定操作，诸如顺序扫描，排序和索引扫描。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* ----------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *		PlannedStmt 节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 计划器的输出是一颗计划树，PlannedStmt是计划树的根节点。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * PlannedStmt存储着执行器所需的“一次性”信息。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * ----------------*/</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">PlannedStmt</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">NodeTag</span>		<span style="color:#000">type</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">CmdType</span>		<span style="color:#000">commandType</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 增|删|改|查 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint32</span>		<span style="color:#000">queryId</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 查询标识符 (复制自Query) */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">hasReturning</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 增|删|改是否带有RETURNING? */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">hasModifyingCTE</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* WITH子句中是否出现了增|删|改？ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">canSetTag</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 我是否设置了命令结果标记？ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">transientPlan</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 当TransactionXmin变化时重新进行计划? */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">dependsOnRole</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 执行计划是否特定于当前的角色？ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">parallelModeNeeded</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 需要并行模式才能执行？ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">Plan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">planTree</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 计划节点树 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rtable</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* RangeTblEntry节点的列表 */</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* 目标关系上用于增|删|改的范围表索引 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">resultRelations</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* RT索引的整数列表, 或NIL */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Node</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">utilityStmt</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 如为DECLARE CURSOR则非空 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">subplans</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* SubPlan表达式的计划树 expressions */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Bitmapset</span>  	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rewindPlanIDs</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 需要REWIND的子计划的索引序号 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rowMarks</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* PlanRowMark列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">relationOids</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 计划所依赖的关系OID列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">invalItems</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 其他依赖，诸如PlanInvalItems */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span>			<span style="color:#000">nParamExec</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 使用的PARAM_EXEC参数数量 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">PlannedStmt</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p> 如上所述，计划树包含各式各样的计划节点。<code>PlanNode</code>是所有计划节点的基类，其他计划节点都会包含<code>PlanNode</code>结构。比如顺序扫描节点<code>SeqScanNode</code>，包含一个<code>PlanNode</code>和一个整型变量<code>scanrelid</code>。<code>PlanNode</code>包含14个字段。下面是7个代表性字段：</p>
<ul>
<li><code>startup_cost</code>和<code>total_cost</code>是该节点对应操作的预估代价。</li>
<li><code>rows</code>是计划器预计扫描的行数。</li>
<li><code>targetlist</code>保存了该查询树中目标项的列表。</li>
<li><code>qual</code>储存了限定条件的列表。</li>
<li><code>lefttree</code>和<code>righttree</code>用于添加子节点。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* ----------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 计划节点(Plan Node)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 所有的计划节点都&#34;派生&#34;自Plan结构，将其作为自己的第一个字段。这样确保了当其强制转换为Plan
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 结构时所有东西都能正常工作。(当作为通用参数传入执行器时，节点指针会很频繁地转换为Plan*)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 我们从来不会真的去实例化任何Plan节点，它只是所有Plan类型节点的公共抽象父类。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * ----------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">Plan</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">NodeTag</span>		<span style="color:#000">type</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 计划的预估执行开销 ( 详情见 costsize.c )	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Cost</span>		<span style="color:#000">startup_cost</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 获取第一条元组前的代价 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Cost</span>		<span style="color:#000">total_cost</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 获取所有元组的代价 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 计划器对该计划步骤返回结果大小的估计 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">double</span>		<span style="color:#000">plan_rows</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 计划预期产出的行数 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span>			<span style="color:#000">plan_width</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 以字节计的行宽 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 并行查询所需的信息 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>		<span style="color:#000">parallel_aware</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 是否涉及到并行逻辑？ */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 所有计划类型的公有结构化数据 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span>			<span style="color:#000">plan_node_id</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 在整个计划树范围内唯一的标识 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">targetlist</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 该节点需要计算的目标列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">qual</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 隐式合取化处理的 限制条件 列表 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">Plan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lefttree</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 输入的查询树 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">Plan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">righttree</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">initPlan</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* Init Plan 节点 (无关子查询表达式) */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* “参数变化驱动”的重扫描 相关的管理信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * extParam包含着所有外部PARAM_EXEC参数的参数ID列表，这些参数会影响当前计划节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 及其子节点。这里不包括该节点initPlans时setParam的相关参数，但会包括其extParams
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * allParam包含了所有extParam的参数ID列表，以及影响当前节点的参数ID。（即，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 在initPlans中setParams的参数）。注意这里包含了*所有*会影响本节点的PARAM_EXEC参数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Bitmapset</span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">extParam</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Bitmapset</span>  	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">allParam</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">Plan</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* ------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 扫描节点(Scan nodes)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * ----------- */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">Index</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">Scan</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Plan</span>		<span style="color:#000">plan</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Index</span>		<span style="color:#000">scanrelid</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* relid 是访问范围表的索引 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">Scan</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* ----------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *	顺序扫描节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * ---------------- */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#000">Scan</span> <span style="color:#000">SeqScan</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>下面是两颗计划树，分别与前一小节中的两个例子对应。</p>
<h4 id="3331-例1">3.3.3.1 例1</h4>
<p>第一个例子是3.3.2.1节例1对应的计划树。图3.11所示的代价最小的路径，是由一个排序路径和一个顺序扫描路径组合而成。根路径是排序路径，而其子路径为顺序扫描路径。尽管这里忽略了大量细节，但是从代价最小的路径中生成计划树的过程是显而易见的。在本例中，一个 <code>SortNode</code>被添加到<code>PlannedStmt</code>结构中，而<code>SortNode</code>的左子树上则挂载了一个<code>SeqScanNode</code>，如图3.15(a)所示。</p>
<p>在<code>SortNode</code>中，左子树<code>lefttree</code>指向<code>SeqScanNode</code>。</p>
<p>在<code>SeqScanNode</code>中，<code>qual</code>保存了<code>WHERE</code>子句：<code>'id&lt;300'</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">Sort</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Plan</span>		<span style="color:#000">plan</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span>			<span style="color:#000">numCols</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 排序键 列的数目 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AttrNumber</span> 	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sortColIdx</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 它们在目标列表中的位置序号 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Oid</span>			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sortOperators</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 排序所赖运算符的OID  */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Oid</span>			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">collations</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* collation的OID  */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>	   	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">nullsFirst</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* NULLS FIRST/LAST 方向 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">Sort</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p><strong>图3.15. 计划树的例子</strong></p>
<p><img src="/img/blog/kernel/fig-3-15.png"></p>
<h4 id="3332-例2">3.3.3.2 例2</h4>
<p>第二个例子是3.3.2.2节例2对应的计划树。其代价最小的路径为索引扫描路径，如图3.14所示。因此计划树由单个<code>IndexScanNode</code>独立组成，如图3.15(b)所示。</p>
<p>在本例中，<code>WHERE</code>子句<code>id &lt; 240</code>是一个访问谓词，它储存在<code>IndexScanNode</code>的<code>indexqual</code>字段中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 索引扫描节点 */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">Scan</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Plan</span>          <span style="color:#000">plan</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Index</span>         <span style="color:#000">scanrelid</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* relid 是范围表上的索引ID */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">Scan</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">IndexScan</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Scan</span>          <span style="color:#000">scan</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Oid</span>           <span style="color:#000">indexid</span><span style="color:#000;font-weight:bold">;</span>            <span style="color:#8f5902;font-style:italic">/* 待扫描的索引OID */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span>          <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indexqual</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* 索引限定条件的列表 (通常是OpExprs) */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span>          <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indexqualorig</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">/* 同上，但使用原始形式 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span>          <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indexorderby</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* 索引的ORDER BY表达式 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span>          <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indexorderbyorig</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">/* 同上，但使用原始形式 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span>          <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">indexorderbyops</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* ORDER BY表达式用到的排序运算符的OID */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ScanDirection</span> <span style="color:#000">indexorderdir</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* 正序扫描还是逆序扫描，或者根本不在乎 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">IndexScan</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h2 id="34-执行器如何工作">3.4 执行器如何工作</h2>
<p>在单表查询的例子中，执行器从计划树中取出计划节点，按照自底向上的顺序进行处理，并调用节点相应的处理函数。</p>
<p>每个计划节点都有相应的函数，用于执行节点对应的操作。这些函数在<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/"><code>src/backend/executor</code></a>目录中。例如，执行顺序扫描的的函数（<code>SeqScan</code>）定义于<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeIndexscan.c"><code>nodeSeqscan.c</code></a>中；执行索引扫描的函数（<code>IndexScanNode</code>）定义在<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeIndexscan.c"><code>nodeIndexScan.c</code></a>中；<code>SortNode</code>节点对应的排序函数定义在<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeSort.c"><code>nodeSort.c</code></a>中，诸如此类。</p>
<p>当然，理解执行器如何工作的最好方式，就是阅读<code>EXPLAIN</code>命令的输出。因为PostgreSQL的<code>EXPLAIN</code>命令几乎就是照着计划树输出的。下面以3.3.3节的例1为例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#a40000">#</span> <span style="color:#000">EXPLAIN</span> <span style="color:#000">SELECT</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">FROM</span> <span style="color:#000">tbl_1</span> <span style="color:#000">WHERE</span> <span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">300</span> <span style="color:#000">ORDER</span> <span style="color:#000">BY</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#000">QUERY</span> <span style="color:#000">PLAN</span>                           
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">---------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span> <span style="color:#000">Sort</span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">182.34</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">.183.09</span> <span style="color:#000">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">300</span> <span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">Sort</span> <span style="color:#f57900">Key</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">data</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">-&gt;</span>  <span style="color:#000">Seq</span> <span style="color:#000">Scan</span> <span style="color:#000">on</span> <span style="color:#000">tbl_1</span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0.00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">.170.00</span> <span style="color:#000">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">300</span> <span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f57900">Filter</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">300</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#000">rows</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>我们可以自底向上阅读<code>EXPLAIN</code>的结果，来看一看执行器是如何工作的。</p>
<p><strong>第6行</strong>：首先，执行器通过<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeSeqscan.c"><code>nodeSeqscan.c</code></a>中定义的函数执行顺序扫描操作。</p>
<p><strong>第4行</strong>：然后，执行器通过<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeSort.c"><code>nodeSort.c</code></a>中定义的函数，对顺序扫描的结果进行排序。</p>
<blockquote>
<h3 id="临时文件">临时文件</h3>
<p>执行器在处理查询时会使用工作内存（<code>work_mem</code>）和临时缓冲区（<code>temp_buffers</code>），两者都于内存中分配。如果查询无法在内存中完成，就会用到临时文件。</p>
<p>使用带有<code>Analyze</code>选项的<code>EXPLAIN</code>，待解释的命令会真正执行，并显示实际结果行数，实际执行时间和实际内存用量。下面是一个具体的例子：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#a40000">#</span> <span style="color:#000">EXPLAIN</span> <span style="color:#000">ANALYZE</span> <span style="color:#000">SELECT</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span> <span style="color:#000">FROM</span> <span style="color:#000">tbl_25m</span> <span style="color:#000">ORDER</span> <span style="color:#000">BY</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#000">QUERY</span> <span style="color:#000">PLAN</span>                                                        
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">----------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span> <span style="color:#000">Sort</span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3944070.01</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">.3945895.01</span> <span style="color:#000">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">730000</span> <span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4104</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">actual</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">885.648</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">.1033.746</span> <span style="color:#000">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">730000</span> <span style="color:#000">loops</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">Sort</span> <span style="color:#f57900">Key</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">id</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">Sort</span> <span style="color:#f57900">Method</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">external</span> <span style="color:#000">sort</span>  <span style="color:#f57900">Disk</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000">kB</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">-&gt;</span>  <span style="color:#000">Seq</span> <span style="color:#000">Scan</span> <span style="color:#000">on</span> <span style="color:#000">tbl_25m</span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0.00</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">.10531.00</span> <span style="color:#000">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">730000</span> <span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4104</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">actual</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0.024</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">.102.548</span> <span style="color:#000">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">730000</span> <span style="color:#000">loops</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span> <span style="color:#000">Planning</span> <span style="color:#f57900">time</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1.548</span> <span style="color:#000">ms</span>
</span></span><span style="display:flex;"><span> <span style="color:#000">Execution</span> <span style="color:#f57900">time</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1109.571</span> <span style="color:#000">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#000">rows</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>在第6行，<code>EXPLAIN</code>命令显示出执行器使用了10000KB的临时文件。</p>
<p>临时文件会被临时创建于<code>base/pg_tmp</code>子目录中，并遵循如下命名规则</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;pgsql_tmp&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span> + <span style="color:#ce5c00;font-weight:bold">{</span>创建本文件的Postgres进程PID<span style="color:#ce5c00;font-weight:bold">}</span> . <span style="color:#ce5c00;font-weight:bold">{</span>从0开始的序列号<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>比如，临时文件<code>pgsql_tmp8903.5</code>是<code>pid</code>为<code>8903</code>的<code>postgres</code>进程创建的第6个临时文件</p>
</blockquote>
<h2 id="35-连接">3.5 连接</h2>
<p>PostgreSQL 中支持三种**连接（JOIN）**操作：<strong>嵌套循环连接（Nested Loop Join）</strong>，<strong>归并连接（Merge Join）</strong> ，<strong>散列连接（Hash Join）</strong>。在PostgreSQL中，嵌套循环连接与归并连接有几种变体。</p>
<p>在下文中，我们会假设读者已经对这三种操作的基本行为有了解。如果读者对这些概念不熟悉，可以参阅[<a href="https://www.amazon.com/dp/0073523321">1</a>, <a href="https://www.amazon.com/dp/0321523067">2</a>]。PostgreSQL支持一种针对数据倾斜的<strong>混合散列连接（hybrid hash join）</strong>，关于这方面的资料不多，因此这里会详细描述该操作。</p>
<p>需要注意的是，这三种**连接方法（join method）**都支持PostgreSQL中所有的连接操作，诸如<code>INNER JOIN</code>，<code>LEFT/RIGHT OUTER JOIN</code>，<code>FULL OUTER JOIN</code>等；但是为了简单起见，这里只关注<code>NATURAL INNER JOIN</code>。</p>
<h3 id="351-嵌套循环连接nested-loop-join">3.5.1 嵌套循环连接（Nested Loop Join）</h3>
<p><strong>嵌套循环连接</strong>是最为基础的连接操作，任何**连接条件（join condition）**都可以使用这种连接方式。PostgreSQL支持嵌套循环连接及其五种变体。</p>
<h4 id="3511-嵌套循环连接">3.5.1.1 嵌套循环连接</h4>
<p>嵌套循环连接无需任何启动代价，因此：
$$
\verb|start-up_cost| = 0
$$
运行代价与内外表尺寸的乘积成比例；即$\verb|runcost|$是$O(N_{\verb|outer|}× N_{\verb|inner|})$，这里$N_{\verb|outer|}$和$N_{\verb|inner|}$分别是外表和内表的元组条数。更准确的说，$\verb|run_cost|$的定义如下：
$$
\begin{equation}
\verb|run_cost|=(\verb|cpu_operator_cost|+ \verb|cpu_tuple_cost|)× N_{\verb|outer|}× N_{\verb|inner|} + C_{\verb|inner|}× N_{\verb|outer|}+C_{\verb|outer|}
\end{equation}
$$
这里$C_{\verb|outer|}$和$C_{\verb|inner|}$分别是内表和外表顺序扫描的代价；</p>
<p><strong>图3.16 嵌套循环连接</strong></p>
<p><img src="/img/blog/kernel/fig-3-16.png"></p>
<p>嵌套循环连接的代价总是会被估计，但实际中很少会使用这种连接操作，因为它有几种更高效的变体，下面将会讲到。</p>
<h4 id="3512-物化嵌套循环连接">3.5.1.2 物化嵌套循环连接</h4>
<p>在上面描述的嵌套循环连接中，每当读取一条外表中的元组时，都需要扫描内表中的所有元组。为每条外表元组对内表做全表扫描，这一过程代价高昂，PostgreSQL支持一种<strong>物化嵌套循环连接（materialized nested loop join）</strong> ，可以减少内表全表扫描的代价。</p>
<p>在运行嵌套循环连接之前，执行器会使用**临时元组存储（temporary tuple storage）**模块对内表进行一次扫描，将内表元组加载到工作内存或临时文件中。在处理内表元组时，临时元组存储比缓冲区管理器更为高效，特别是当所有的元组都能放入工作内存中时。</p>
<p>图 3.17说明了物化嵌套循环连接的处理过程。扫描物化元组在内部被称为<strong>重扫描（rescan）</strong>。</p>
<p><strong>图3.17 物化嵌套循环连接</strong></p>
<p><img src="/img/blog/kernel/fig-3-17.png"></p>
<blockquote>
<h4 id="临时元组存储">临时元组存储</h4>
<p>PostgreSQL内部提供了临时元组存储的模块，可用于各种操作：物化表，创建混合散列连接的批次，等等。该模块包含一系列函数，都在<a href="https://github.com/postgres/postgres/blob/master/src/backend/utils/sort/tuplestore.c"><code>tuplestore.c</code></a>中。这些函数用于从工作内存或临时文件读写元组。使用工作内存还是临时文件取决于待存储元组的总数。</p>
</blockquote>
<p>下面给出一个具体的例子，并研究一下执行器是如何处理物化嵌套循环连接的计划树并估计其代价的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                              </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                               
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Nested</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Loop</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">750230</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">Join</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Filter</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">145</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Materialize</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">98</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">73</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>上面显示了执行器要进行的操作，执行器对这些计划节点的处理过程如下：</p>
<p>第7行：执行器使用顺序扫描，物化内部表<code>tbl_b</code>。</p>
<p>第4行：执行器执行嵌套循环连接操作，外表是<code>tbl_a</code>，内表是物化的<code>tbl_b</code>。</p>
<p>下面来估算“物化”操作（第7行）与“嵌套循环”（第4行）的代价。假设物化的内部表元组都在工作内存中。</p>
<p><strong>物化（Materialize）</strong>:</p>
<p>物化操作没有启动代价；因此，
$$
\begin{equation}
\verb|start-up_cost| = 0
\end{equation}
$$
其运行代价定义如下：
$$
\verb|run_cost| = 2 × \verb|cpu_operator_cost| × N_{\verb|inner|};
$$
因此：
$$
\verb|run_cost|=2× 0.0025× 5000=25.0
$$
此外，
$$
\verb|total_cost| = (\verb|start-up_cost|+ \verb|total_cost_of_seq_scan|)+ \verb|run_cost|
$$
因此，
$$
\verb|total_cost| = (0.0+73.0)+25.0=98.0
$$
<strong>(物化)嵌套循环</strong>:</p>
<p>嵌套循环没有启动代价，因此：
$$
\verb|start-up_cost|=0
$$
在估计运行代价之前，先来看一下重扫描的代价，重扫描的代价定义如下：
$$
\verb|rescan_cost| = \verb|cpu_operator_cost| × N_{\verb|inner|}
$$
这本例中：
$$
\verb|rescan_cost| = (0.0025)× 5000=12.5
$$
运行代价由以下公式定义：
$$
\verb|run_cost| =(\verb|cpu_operator_cost| + \verb|cpu_tuple_cost|)× N_{\verb|inner|}× N_{\verb|outer|} \</p>
<ul>
<li>\verb|recan_cost|× (N_{\verb|outer|}-1) + C^{\verb|total|}<em>{\verb|outer|,\verb|seqscan|} + C^{\verb|total|}</em>{\verb|materialize|}，
$$
这里 $C^{\verb|total|}<em>{\verb|outer|,\verb|seqscan|}$代表外部表的全部扫描代价，$C^{\verb|total|}</em>{\verb|materialize|}$代表物化代价；因此
$$
\verb|run_cost| = ( 0.0025 + 0.01 ) × 5000 × 10000 + 12.5 ×(10000−1)+145.0+98.0=750230.5
$$</li>
</ul>
<h4 id="3513-索引嵌套循环连接">3.5.1.3 索引嵌套循环连接</h4>
<p>如果内表上有索引，且该索引能用于搜索满足连接条件的元组。那么计划器在为外表的每条元组搜索内表中的匹配元组时，会考虑使用索引进行直接搜索，以替代顺序扫描。这种变体叫做<strong>索引嵌套循环连接（indexed nested loop join）</strong>，如图3.18所示。尽管这种变体叫做索引&quot;嵌套循环连接&quot;，但该算法基本上只需要在在外表上循环一次，因此连接操作执行起来相当高效。</p>
<p><strong>图3.18 索引嵌套循环连接</strong></p>
<p><img src="/img/blog/kernel/fig-3-18.png"></p>
<p>下面是索引嵌套循环连接的一个具体例子。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                   </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                                   
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Nested</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Loop</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">1935</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">73</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c_pkey</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">36</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>第6行展示了访问内表中元组的代价。即在内表中查找满足第七行连接条件<code>(id = b.id)</code>的元组的代价。</p>
<p>在第7行的索引条件<code>(id = b.id)</code>中，<code>b.id</code>是连接条件中的外表属性的值。每当顺序扫描外表取回一条元组时，就会依第6行所示的索引搜索路径，查找内表中需要与之连接的元组。换而言之，外表元组的值作为参数传入内表的索引扫描中，索引扫描路径会查找满足连接条件的内表元组。这种索引路径被称为<strong>参数化（索引）路径（parameterized (index) path）</strong>，细节见PostgreSQ源码：<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/README"><code>backend/optimizer/README</code></a>。</p>
<p>该嵌套循环连接的启动代价，等于第6行中索引扫描的代价，因此：
$$
\verb|start-up_cost| = 0.285
$$
索引嵌套循环扫描的总代价由下列公式所定义：
$$
\verb|total_cost|= (\verb|cpu_tuple_cost| + C^{\verb|total|}<em>{\verb|inner,parameterized|} )× N</em>{\verb|outer|}+C^{\verb|run|}<em>{\verb|outer,seqscan|}
$$
这里$C^{\verb|total|}</em>{\verb|inner,parameterized|}$是参数化内表索引扫描的整体代价，</p>
<p>在本例中：
$$
\verb|total_cost|=(0.01+0.3625)× 5000 + 73.0 = 1935.5
$$
而运行代价为：
$$
\verb|run_cost| = 1935.5-0.285=1935.215
$$
如上所示，索引嵌套扫描的整体代价是$O(N_{\verb|outer|})$。</p>
<h4 id="3514-其他变体">3.5.1.4 其他变体</h4>
<p>如果在外表上存在一个与连接条件相关的索引，那么在外表上也可以以索引扫描替代顺序扫描。特别是，当<code>WHERE</code>子句中的访问谓词可以使用该索引时，能缩小外表上的搜索范围，嵌套循环连接的代价可能会急剧减少。</p>
<p>当使用外表索引扫描时，PostgreSQL支持三种嵌套循环连接的变体，如图3.19所示。</p>
<p><strong>图3.19 嵌套循环连接的三种变体，使用外表索引扫描</strong></p>
<p><img alt="out" src="/img/blog/kernel/fig-3-19.png"></p>
<p>这些连接的<code>EXPLAIN</code>结果如下：</p>
<ol>
<li>
<p>使用外表索引扫描的嵌套循环连接</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">enable_hashjoin</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">off</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">enable_mergejoin</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">off</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                   </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                                   
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Nested</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Loop</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">93</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">81</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c_pkey</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">85</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">Filter</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>使用外表索引扫描的物化嵌套循环连接</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">enable_hashjoin</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">off</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">enable_mergejoin</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">off</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">40</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                   </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                                    
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Nested</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Loop</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">99</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">76</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">Join</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Filter</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c_pkey</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">97</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">39</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">40</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Materialize</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">85</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">55</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">85</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#000">Filter</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>使用外表索引扫描的索引嵌套循环连接</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">enable_hashjoin</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">off</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">enable_mergejoin</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">off</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:bold">40</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                   </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                                    
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Nested</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Loop</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">57</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">173</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">06</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a_pkey</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">97</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">39</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">40</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_d_pkey</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">28</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ol>
<h3 id="352-归并连接merge-join">3.5.2 归并连接（Merge Join）</h3>
<p>与嵌套循环连接不同的是，**归并连接（Merge Join）**只能用于自然连接与等值连接。</p>
<p>函数<code>initial_cost_mergejoin()</code>和<code>final_cost_mergejoin()</code>用于估计归并连接的代价。</p>
<p>因为精确估计归并连接的代价非常复杂，因此这里略过不提，只会说明归并连接算法的工作流程。归并连接的启动成本是内表与外表排序成本之和，因此其启动成本为：
$$
O(N_{\verb|outer|} \log_2(N_{\verb|outer|}) + N_{\verb|inner|} \log_2(N_{\verb|inner|}))
$$
这里$N_{\verb|outer|}$和$N_{\verb|inner|}$是分别是外表和内表的元组条数，而运行代价是$O(N_{\verb|outer|}+N_{\verb|inner|})$。</p>
<p>与嵌套循环连接类似，归并连接在PostgreSQL中有4种变体。</p>
<h4 id="3521-归并连接">3.5.2.1 归并连接</h4>
<p>图3.20是归并连接的概念示意图。</p>
<p><strong>图3.20 归并连接</strong></p>
<p><img src="/img/blog/kernel/fig-3-20.png"></p>
<p>如果所有元组都可以存储在内存中，那么排序操作就能在内存中进行，否则会使用临时文件。</p>
<p>下面是一个具体的例子，一个归并连接的<code>EXPLAIN</code>输出如下所示。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Merge</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Join</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">944</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">71</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">984</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">71</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">Merge</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">809</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">39</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">834</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">39</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">145</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">135</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">33</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">137</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">83</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">85</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#000">Filter</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>第9行：执行器对内表<code>tbl_b</code>进行排序，使用顺序扫描（第11行）。</li>
<li>第6行：执行器对外表<code>tbl_a</code>进行排序，使用顺序扫描（第8行）。</li>
<li>第4行：执行器执行归并连接操作，外表是排好序的<code>tbl_a</code>，内表是排好序的<code>tbl_b</code>。</li>
</ul>
<h4 id="3522-物化归并连接">3.5.2.2 物化归并连接</h4>
<p>与嵌套循环连接类似，归并连接还支持<strong>物化归并连接（Materialized Merge Join）</strong>，物化内表，使内表扫描更为高效。</p>
<p><strong>图3.21 物化归并连接</strong></p>
<p><img src="/img/blog/kernel/fig-3-21.png"></p>
<p>这里是物化归并连接的<code>EXPLAIN</code>结果，很容易发现，与普通归并连接的差异是第9行：<code>Materialize</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                                     
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Merge</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Join</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10466</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">08</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">10578</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">58</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2064</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">Merge</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">6708</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">39</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">6733</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">39</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1032</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">1529</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1032</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Materialize</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3757</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">69</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">3782</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">69</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1032</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3757</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">69</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">3770</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1032</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">1193</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1032</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>第10行：执行器对内表<code>tbl_b</code>进行排序，使用顺序扫描（第12行）。</li>
<li>第9行：执行器对<code>tbl_b</code>排好序的结果进行物化。</li>
<li>第6行：执行器对外表<code>tbl_a</code>进行排序，使用顺序扫描（第8行）。</li>
<li>第4行：执行器执行归并连接操作，外表是排好序的<code>tbl_a</code>，内表是物化的排好序的<code>tbl_b</code>。</li>
</ul>
<h4 id="3523-其他变体">3.5.2.3 其他变体</h4>
<p>与嵌套循环连接类似，当外表上可以进行索引扫描时，归并连接也存在相应的变体。</p>
<p><strong>图3.22 归并连接的三种变体，使用外表索引扫描</strong></p>
<p><img src="/img/blog/kernel/fig-3-22.png"></p>
<p>这些连接的<code>EXPLAIN</code>结果如下。</p>
<ol>
<li>
<p>使用外表索引扫描的归并连接</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">enable_hashjoin</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">off</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">enable_nestloop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">off</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                      </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                                      
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Merge</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Join</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">135</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">61</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">322</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">Merge</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c_pkey</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">318</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">135</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">33</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">137</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">83</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">85</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#000">Filter</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>使用外表索引扫描的物化归并连接</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">enable_hashjoin</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">off</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">enable_nestloop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">off</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4500</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                      </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                                      
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Merge</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Join</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">421</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">84</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">672</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4500</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">Merge</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c_pkey</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">318</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Materialize</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">421</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">55</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">444</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">05</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4500</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">421</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">55</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">432</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4500</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">85</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4500</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#000">Filter</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4500</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>使用外表索引扫描的索引归并连接</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">enable_hashjoin</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">off</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">enable_nestloop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">off</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                      </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                                      
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Merge</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Join</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">57</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">226</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">07</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">Merge</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c_pkey</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">318</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">29</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">using</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_d_pkey</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">28</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">41</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">78</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">Index</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ol>
<h3 id="353-散列连接hash-join">3.5.3 散列连接（Hash Join）</h3>
<p>与归并连接类似，**散列连接（Hash Join）**只能用于自然连接与等值连接。</p>
<p>PostgreSQL中的散列连接的行为因表的大小而异。 如果目标表足够小（确切地讲，内表大小不超过工作内存的25％），那么散列连接就是简单的<strong>两阶段内存散列连接（two-phase in-memory hash join）</strong> ； 否则，将会使用带倾斜批次的<strong>混合散列连接（hybrid hash join）</strong>。</p>
<p>本小节将介绍PostgreSQL中这两种散列连接的执行过程。</p>
<p>这里省略了代价估算的部分，因为它很复杂。粗略来说，假设向散列表插入与搜索时没有遇到冲突，那么启动和运行成本复杂度都是$O(N_{\verb|outer|} + N_{\verb|inner|})$。</p>
<h4 id="3531-内存散列连接">3.5.3.1 内存散列连接</h4>
<p>下面将描述内存中的散列连接。</p>
<p>内存中的散列连接是在<code>work_mem</code>中处理的，在PostgreSQL中，散列表区域被称作<strong>处理批次（batch）</strong>。 一个处理批次会有多个<strong>散列槽(hash slots)</strong>，内部称其为<strong>桶（buckets）</strong>，桶的数量由<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeHash.c"><code>nodeHash.c</code></a>中定义的<code>ExecChooseHashTableSize()</code>函数所确定。 桶的数量总是2的整数次幂。</p>
<p>内存散列连接有两个阶段：**构建（build）<strong>阶段和</strong>探测（probe）**阶段。 在构建阶段，内表中的所有元组都会被插入到batch中；在探测阶段，每条外表元组都会与处理批次中的内表元组比较，如果满足连接条件，则将两条元组连接起来。</p>
<p>为了理解该操作的过程，下面是一个具体的例子。 假设该查询中的连接操作使用散列连接。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_outer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">outer</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_inner</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">inner</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">inner</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attr1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">outer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attr2</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>散列连接的过程如图3.23和3.24所示。</p>
<p><strong>图3.23 内存散列连接的构建阶段</strong></p>
<p><img src="/img/blog/kernel/fig-3-23.png"></p>
<ol>
<li>
<p>在工作内存上创建一个处理批次。</p>
<p>在本例中，处理批次有八个桶；即桶的数量是2的3次方。</p>
</li>
<li>
<p>将内表的第一个元组插入批次的相应的桶中。</p>
<p>具体过程如下：</p>
<ol>
<li>
<p>找出元组中涉及连接条件的属性，计算其散列键。</p>
<p>在本例中，因为<code>WHERE</code>子句是<code>inner.attr1 = outer.attr2</code>，因此内置的散列函数会对第一条元组的属性<code>attr1</code>取散列值，用作散列键。</p>
</li>
<li>
<p>将第一条元组插入散列键相应的桶中。</p>
<p>假设第一条元组的散列键以二进制记法表示为<code>0x000 ... 001</code>，即其末三**位（bit）**为<code>001</code>。 在这种情况下，该元组会被插入到键为<code>001</code>的桶中。</p>
</li>
</ol>
<p>在本文中，构建处理批次的插入操作会用运算符 ⊕ 表示。</p>
</li>
<li>
<p>插入内表中的其余元组。</p>
</li>
</ol>
<p><strong>图3.24. 内存散列连接的探测阶段</strong></p>
<p><img src="/img/blog/kernel/fig-3-24.png"></p>
<ol start="4">
<li>
<p>依外表的第一条元组进行探测。</p>
<p>详情如下：</p>
<ol>
<li>
<p>找出第一条外表元组中涉及连接条件的属性，计算其散列键。</p>
<p>在这个例子中，假设第一条元组的属性<code>attr2</code>的散列键是<code>0x000 ... 100</code>，即其末三**位（bit）**为<code>100</code>。 最后三位是<code>100</code>。</p>
</li>
<li>
<p>将外表中第一条元组与批次中的内表元组进行比较。如果满足连接条件，则连接内外表元组。</p>
<p>因为第一个元组的散列键的末三位为<code>100</code>，执行器找出键为<code>100</code>的桶中的所有内表元组，并对内外表元组两侧相应的属性进行比较。这些属性由连接条件（在<code>WHERE</code>子句中）所指明。</p>
<p>如果满足连接条件，执行器会连接外表中的第一条元组与内表中的相应元组。如果不满足则执行器不做任何事情。</p>
<p>在本例中，键为<code>100</code>的桶中有<code>Tuple_C</code>。如果<code>Tuple_C</code>的<code>attr1</code>等于第一条元组（<code>Tuple_W</code>）的<code>attr2</code>，则<code>Tuple_C</code>和<code>Tuple_W</code>将被连接，并保存至内存或临时文件中。</p>
</li>
</ol>
<p>在本文中，处理批次的探测操作用运算符 ⊗ 表示。</p>
</li>
<li>
<p>依次对外表中的其他元组执行探测。</p>
</li>
</ol>
<h4 id="3532-带倾斜的混合散列连接">3.5.3.2 带倾斜的混合散列连接</h4>
<p>当内表的元组无法全部存储在工作内存中的单个处理批次时，PostgreSQL使用带倾斜批次的混合散列连接算法，该算法是混合散列连接的一种变体。</p>
<p>首先，这里会描述混合散列连接的基本概念。在第一个构建和探测阶段，PostgreSQL准备多个批次。与桶的数目类似，处理批次的数目由函数<code>ExecChooseHashTableSize()</code>决定，也总是2的整数次幂。工作内存中只会分配一个处理批次，而其他批次作都以临时文件的形式创建。属于这些批次的元组将通过临时元组存储功能，被写入到相应的文件中。</p>
<p>图3.25说明了如何将元组存储在四个（$ 2 ^ 2 $）处理批次中。在本例中元组散列键的最后五个比特位决定了元组所属的批次与桶，因为处理批次的数量为$2^2$，而桶的数量为$2^3$，因此需要5个比特位来表示，其中前两位决定了元组所属的批次，而后三位决定了元组在该批次中所属的桶。例如：<code>Batch_0</code>存储着散列键介于$\textcolor{red}{00}000$与$\textcolor{red}{00}111$的元组；而<code>Batch_1</code>存储着散列键介于$\textcolor{red}{01}000$与$\textcolor{red}{01}111$的元组，依此类推。</p>
<p><strong>图3.25 混合散列连接中的多个处理批次</strong></p>
<p><img src="/img/blog/kernel/fig-3-25.png"></p>
<p>在混合散列连接中，构建与探测阶段的执行次数与处理批次的数目相同，因为内外表元组都被存至相同数量的处理批次中。在第一轮构建与探测阶段中，除了处理第一个处理批次，还会创建所有的处理批次。另一方面，第二轮及后续的处理批次都需要读写临时文件，这属于代价巨大的操作。因此PostgreSQL还准备了一个名为<strong>skew</strong>的特殊处理批次，即倾斜批次，以便在第一轮中高效处理尽可能多的元组。</p>
<p>这个特殊的倾斜批次中的内表元组在连接条件内表一侧属性上的取值，会选用外表连接属性上的高频值（MCV）。因此在第一轮处理中能与外表中尽可能多的元组相连接。这种解释不太好理解，因此下面给出了一个具体的例子。</p>
<p>假设有两个表：客户表<code>customers</code>与购买历史表<code>purchase_history</code>。<code>customers</code>由两个属性组成：<code>name</code>和<code>address</code>； <code>purchase_history</code>由两个属性组成：<code>customer_name</code>和<code>buying_item</code>。<code>customers</code>有10,000行，而<code>purchase_history</code>表有1,000,000行。前10％的客户进行了70％的购买。</p>
<p>理解了这些假设，让我们考虑当执行以下查询时，带倾斜的混合散列连接的第一轮是如何执行的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">customers</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">purchase_history</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">h</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">h</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">customer_name</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>如果<code>customers</code>是内表，而<code>purchase_history</code>是外表，则PostgreSQL将使用<code>purchase_history</code>表的高频值值，将前10％的<code>customers</code>元组存储于倾斜批次中。 请注意这里引用的是外表上的高频值，而插入倾斜批次的是内表元组。 在第一轮的探测阶段，外表（<code>purchase_history</code>）中70％的元组将与倾斜批次中存储的元组相连接。 因此，外表分布越是不均匀，第一轮中越是可以处理尽可能多的元组。</p>
<p>接下来会介绍带倾斜批次的混合散列连接的工作原理，如图3.26至3.29所示。</p>
<p><strong>图3.26 混合散列连接的构建阶段的第一轮</strong></p>
<p><img src="/img/blog/kernel/fig-3-26.png"></p>
<ol>
<li>
<p>在工作内存中创建一个处理批次，以及一个倾斜批次。</p>
</li>
<li>
<p>创建处理批次相应的临时文件，用于存储排好序的内表元组。</p>
<p>在本例中，内表被分割为四个批次，因此创建了三个批次文件。</p>
</li>
<li>
<p>为内表的第一条元组执行构建操作。</p>
<p>细节如下：</p>
<ol>
<li>
<p>如果第一条元组应当插入倾斜批次中，则将其插入倾斜批次；否则继续下一步。</p>
<p>在该例中，如果第一条元组属于前10％的客户，则将其插入到倾斜批次中。</p>
</li>
<li>
<p>计算第一条元组的散列键，然后将其插入相应的处理批次。</p>
</li>
</ol>
</li>
<li>
<p>对内表其余元组依次执行构建操作。</p>
</li>
</ol>
<p><strong>图3.27 混合散列连接，探测阶段第一轮</strong></p>
<p><img src="/img/blog/kernel/fig-3-27.png"></p>
<ol start="5">
<li>
<p>创建临时处理批次文件，用于外表排序。</p>
</li>
<li>
<p>为外表的第一条元组执行探测操作，如果外表第一条元组上相应字段取值为MCV，则在倾斜批次上进行探测，否则进行第七步。</p>
<p>在本例中，如果第一条元组是前10％客户的购买数据，则它会与倾斜批次中的内表元组进行比较。</p>
</li>
<li>
<p>为外表的第一条元组执行探测操作。</p>
<p>操作的内容取决于该元组散列键的取值。如果该元组属于<code>Batch_0</code>则直接完成探测操作；否则将其插入相应的外表处理批次中。</p>
</li>
<li>
<p>为外表的其余元组执行探测操作。</p>
<p>注意在本例中，外表中70％的元组已经在第一轮中的倾斜批次中处理了。</p>
</li>
</ol>
<p><strong>图3.28 构建阶段与探测阶段，第二轮</strong></p>
<p><img src="/img/blog/kernel/fig-3-28.png"></p>
<ol start="9">
<li>
<p>移除倾斜批次与<code>Batch_0</code>，为下一轮处理批次腾地方。</p>
</li>
<li>
<p>为批次文件<code>batch_1_in</code>中的内表元组执行构建操作。</p>
</li>
<li>
<p>为批次文件<code>batch_1_out</code>中的外表元组依次执行探测操作。</p>
</li>
</ol>
<p><strong>图3.29 构建阶段与探测阶段，第三轮及后续</strong></p>
<p><img src="/img/blog/kernel/fig-3-29.png"></p>
<ol start="12">
<li>
<p>为批次文件<code>batch_2_in</code>与<code>batch_2_out</code>执行构建操作与探测操作。</p>
</li>
<li>
<p>为批次文件<code>batch_3_in</code>与<code>batch_3_out</code>执行构建操作与探测操作。</p>
</li>
</ol>
<h3 id="354-连接访问路径与连接节点">3.5.4 连接访问路径与连接节点</h3>
<h4 id="3541-连接访问路径">3.5.4.1 连接访问路径</h4>
<p>嵌套循环连接的访问路径由<code>JoinPath</code>结构表示，其他连接访问路径，诸如<code>MergePath</code>与<code>HashPath</code>都基于其实现。</p>
<p>下图列出了所有的连接访问路径，细节略过不提。</p>
<p><strong>图3.30 Join访问路径</strong></p>
<p><img src="/img/blog/kernel/fig-3-30.png"></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#000">JoinPath</span> <span style="color:#000">NestPath</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">JoinType</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* 根据SQL JOIN语法确定的标准连接种类，解析器只允许输出这几种取值。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">         * (例如JoinExpr节点) */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">JOIN_INNER</span><span style="color:#000;font-weight:bold">,</span>           <span style="color:#8f5902;font-style:italic">/* 仅包含匹配的元组对 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">JOIN_LEFT</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#8f5902;font-style:italic">/* 匹配元组对 + 未匹配的左表元组 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">JOIN_FULL</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#8f5902;font-style:italic">/* 匹配元组对 + 未匹配的左右表元组  */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">JOIN_RIGHT</span><span style="color:#000;font-weight:bold">,</span>           <span style="color:#8f5902;font-style:italic">/* 匹配元组对 + 未匹配的右表元组  */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* 关系理论中的半连接(semijoin)与否定半连接(anti-semijoin)并没有用SQL JOIN
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">         * 语法来表示，而是用另一种风格标准来表示(举个例子，EXISTS)。计划器会认出这些情景
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">         * 并将其转换为连接。因此计划器与执行器必须支持这几种取值。注意：对于JOIN_SEMI的
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">         * 输出而言，连接到哪一条右表元组是不确定的。而对于JOIN_ANTI的输出而言，会保证使用
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">         * 空值进行行扩展。*/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">JOIN_SEMI</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#8f5902;font-style:italic">/* 左表元组的一份拷贝，如果该元组有相应匹配 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">JOIN_ANTI</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#8f5902;font-style:italic">/* 右表元组的一份拷贝，如果该元组有相应匹配 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* 这几种代码用于计划器内部，执行器并不支持。(其实大多数时候计划器也不会用)   */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">JOIN_UNIQUE_OUTER</span><span style="color:#000;font-weight:bold">,</span>    <span style="color:#8f5902;font-style:italic">/* 左表路径必须是UNIQUE的 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">JOIN_UNIQUE_INNER</span>     <span style="color:#8f5902;font-style:italic">/* 右表路径必须是UNIQUE的 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">JoinType</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">JoinPath</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Path</span>	   <span style="color:#000">path</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">JoinType</span>   <span style="color:#000">jointype</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Path</span>	   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">outerjoinpath</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 连接外表一侧的路径 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Path</span>	   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">innerjoinpath</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 连接内表一侧的路径 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">joinrestrictinfo</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 连接所适用的限制信息 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 参考RelOptInfo与ParamPathInfo才能理解为什么JoinPath需要有joinrestrictinfo
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * 且不能合并到RelOptInfo中。 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">JoinPath</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">MergePath</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">JoinPath</span>   <span style="color:#000">jpath</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">path_mergeclauses</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 归并所需的连接子句 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">outersortkeys</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 用于外表显式排序的键，如果存在 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span>	   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">innersortkeys</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 用于内表显式排序的键，如果存在 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span>	   <span style="color:#000">materialize_inner</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 为内表执行物化过程? */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">MergePath</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h4 id="3542-连接节点">3.5.4.2 连接节点</h4>
<p>本小节列出了三种连接节点：<code>NestedLoopNode</code>，<code>MergeJoinNode</code> 和<code>HashJoinNode</code>，它们都基于<code>JoinNode</code>实现，细节略过不提。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* ----------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *        连接节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * jointype:    连接左右子树元组的规则
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * joinqual:    来自 JOIN/ON 或 JOIN/USING 的连接限定条件
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *                (plan.qual 包含了来自WHERE子句的条件)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 当jointype为INNER时，joinqual 与 plan.qual 在语义上可以互换。对于OUTER而言这两者
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 则无法互换；只有joinqual会被用于匹配判定，以及是否需要生成空值扩展的元组。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * (但 plan.qual 仍然会在实际返回一条元组前生效。)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 对于外连接而言，只有joinquals能被用于归并连接或散列连接的连接条件。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * ----------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">Join</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Plan</span>        <span style="color:#000">plan</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">JoinType</span>    <span style="color:#000">jointype</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span>        <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">joinqual</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* 连接条件 (除 plan.qual 外) */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">Join</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* ----------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *        嵌套循环连接节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * nestParams的列表标识出了执行器所需的参数，这些参数从外表子计划中的当前行获取，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 并传入内表子计划中用于执行。当前我们限制这些值为简单的Vars，但也许某一天这一限制
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 会放松。（注意在创建执行计划期间，paramval实际上可能是一个PlaceHolderVar表达式；
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 但当其进入执行器时，它必须转换为varno为OUTER_VAR的Var。）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * ----------------*/</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">NestLoop</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Join</span>       <span style="color:#000">join</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">nestParams</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* NestLoopParam 节点的列表*/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">NestLoop</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">NestLoopParam</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">NodeTag</span>   <span style="color:#000">type</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span>       <span style="color:#000">paramno</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 需要配置的PARAM_EXEC参数数量 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Var</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">paramval</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* 需要赋值给Param的外表变量 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">NestLoopParam</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* ----------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *        归并连接节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 待归并列上期待的顺序是通过一个btree运算符族的OID，一个排序规则的OID，一个方向字段
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * （BTLessStrategyNumber 或 * BTGreaterStrategyNumber)，以及一个 NULL FIRST
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 标记位描述的。注意归并语句的两侧可能是不同的数据类型，但它们会按照共同的运算符族与排序
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 规则，以同样的方式排序。每个归并子句中的算子必须为相应运算符族中的等值运算。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * ---------------- */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">MergeJoin</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Join</span>    <span style="color:#000">join</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">mergeclauses</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* mergeclauses 是一颗表达式树 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* 这些字段都是数组，但与mergeclauses列表有着同样的长度： */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Oid</span>     <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">mergeFamilies</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* B树运算符族的OID列表，每条子句一个 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Oid</span>     <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">mergeCollations</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* 排序规则的OID列表，每条子句一个 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span>     <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">mergeStrategies</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* 顺序(ASC 或 DESC)的列表，每条子句一个 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">bool</span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">mergeNullsFirst</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* 空值顺序，每条子句一个  */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">MergeJoin</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* ----------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *        散列连接节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * ---------------- */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">HashJoin</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Join</span>    <span style="color:#000">join</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">List</span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">hashclauses</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">HashJoin</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h2 id="36-创建多表查询计划树">3.6 创建多表查询计划树</h2>
<p>本节将说明多表查询计划树的创建过程。</p>
<h3 id="361-预处理">3.6.1 预处理</h3>
<p>预处理由<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/plan/planner.c"><code>planner.c</code></a>中定义的<code>subquery_planner()</code>函数执行。第3.3.1节已经描述了单表查询的预处理。本节将描述多表查询的预处理；尽管这块内容很多，但这里只会挑其中一部分来讲。</p>
<ol>
<li>
<p>对CTE进行计划与转换</p>
<p>如果存在<code>WITH</code>列表，计划器就会通过<code>SS_process_ctes()</code>函数对每个<code>WITH</code>查询进行处理。</p>
</li>
<li>
<p>上拉子查询</p>
<p>如果<code>FROM</code>子句带有一个子查询，且该子查询没用用到<code>GROUP BY</code>，<code>HAVING</code>，<code>ORDER BY</code>，<code>LIMIT</code>和<code>DISTINCT</code>，<code>INTERSECT</code>或<code>EXCEPT</code>，那么计划器会使用<code>pull_up_subqueries()</code>函数将其转换为连接形式。例如下面一个<code>FROM</code>子句含子查询的查询就可以被转换为自然连接查询。自不必说，这种转换是在查询树上进行的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	 	       	     </span><span style="color:#a40000">↓</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>将外连接转为内连接</p>
<p>如果可能的话，计划器会将<code>OUTER JOIN</code>查询转换为<code>INNER JOIN</code>查询。</p>
</li>
</ol>
<h3 id="362-获取代价最小的路径">3.6.2 获取代价最小的路径</h3>
<p>为了获取最佳计划树，计划器必须考虑各个索引与各种连接方法之间的所有可能组合。 如果表的数量超过某个水平，该过程的代价就会因为组合爆炸而变得非常昂贵，以至于根本不可行。</p>
<p>幸运的是，如果表的数量小于12张，计划器可以使用动态规划来获取最佳计划； 否则计划器会使用遗传算法。详情如下：</p>
<blockquote>
<h4 id="基因查询优化器">基因查询优化器</h4>
<p>当执行一个多表连接查询时，大量时间耗费在了优化查询计划上。 为了应对这种情况，PostgreSQL实现了一个有趣的功能：<a href="https://www.postgresql.org/docs/current/static/geqo.html">基因查询优化器</a>。 这种近似算法能在合理时间内确定一个合理的计划。 因此在查询优化阶段，如果参与连接的表数量超过参数<a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-GEQO-THRESHOLD"><code>geqo_threshold</code></a>指定的阈值（默认值为12），PostgreSQL将使用遗传算法来生成查询计划。</p>
</blockquote>
<p>使用动态规划确定最佳计划树的过程，其步骤如下：</p>
<ul>
<li>
<p>第一层</p>
<p>获得每张表上代价最小的路径，代价最小的路径存储在表相应的<code>RelOptInfo</code>结构中。</p>
</li>
<li>
<p>第二层</p>
<p>从所有表中选择两个表，为每种组合找出代价最低的路径。</p>
<p>举个例子，如果总共有两张表，表<code>A</code>与表<code>B</code>，则表<code>A</code>和<code>B</code>表连接的各种路径中，代价最小的那条即为最终想要的答案。在下文中，两个表的<code>RelOptInfo</code>记做${A,B}$。</p>
<p>如果有三个表，则需要获取${A,B}, {A,C},{B,C}$三种组合里各自代价最小的路径。</p>
</li>
<li>
<p>第三层及其后</p>
<p>继续进行同样的处理，直到层级等于表数量。</p>
</li>
</ul>
<p>通过这种方式，在每个层级都能解决最小代价问题的一部分，且其结果能被更高层级的计算复用，从而使代价最小的计划树能够被高效地计算出来。</p>
<p><strong>图3.31 如何使用动态规划获取代价最小的访问路径</strong></p>
<p><img src="/img/blog/kernel/fig-3-31.png"></p>
<p>接下来会针对下面的查询，解释计划器是如何获取代价最小的计划的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">\</span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;public.tbl_a&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Type</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Modifiers</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------+---------+-----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Indexes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;tbl_a_pkey&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">\</span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;public.tbl_b&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Type</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Modifiers</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------+---------+-----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">400</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h4 id="3621-第一层的处理">3.6.2.1 第一层的处理</h4>
<p>在第一层中，计划器会为查询中涉及的关系创建相应的<code>RelOptInfo</code>结构，并估计每个关系上的最小代价。 在这一步中，<code>RelOptInfo</code>结构会被添加至该查询对应<code>PlannerInfo</code>的<code>simple_rel_arrey</code>数组字段中。</p>
<p><strong>图3.32 第一层处理后的<code>PlannerInfo</code>与<code>RelOptInfo</code></strong></p>
<p><img src="/img/blog/kernel/fig-3-32.png"></p>
<p>表<code>tbl_a</code>的<code>RelOptInfo</code>有三条访问路径，它们被添加至<code>RelOptInfo</code>的路径列表中。这三条路径分别被三个指针所链接，即三个指向代价最小路径的指针：启动代价最小的路径，总代价最小的路径，参数化代价最小的路径。 启动代价最小的路径与总代价最小的路径涵义显而易见，因此，这里只会说一下<strong>参数化索引扫描代价最小的路径（cheapest parameterized index scan path）</strong>。</p>
<p>如3.5.1.3节所述，计划器会考虑为索引嵌套循环连接使用<strong>参数化路径（parameterized path）</strong>（极少数情况下也会用于带外表索引扫描的索引化归并连接）。参数化索引扫描代价最小的路径，就是所有参数化路径中代价最小的那个。</p>
<p>表<code>tbl_b</code>的<code>RelOptInfo</code>仅有顺序扫描访问路径，因为<code>tbl_b</code>上没有相关索引。</p>
<h4 id="3622-第二层的处理">3.6.2.2 第二层的处理</h4>
<p>在第二层中，计划器会在<code>PlannerInfo</code>的<code>join_rel_list</code>字段中创建一个<code>RelOptInfo</code>结构。 然后估计所有可能连接路径的代价，并且选择代价最小的那条访问路径。 <code>RelOptInfo</code>会将最佳访问路径作为总代价最小的路径， 如图3.33所示。</p>
<p><strong>图3.33 第二层处理后的<code>PlannerInfo</code>和<code>RelOptInfo</code></strong></p>
<p><img src="/img/blog/kernel/fig-3-33.png"></p>
<p>表3.1展示了本例中连接访问路径的所有组合。本例中查询的连接类型为<strong>等值连接（equi-join）</strong>，因而对全部三种连接算法进行评估。 为方便起见，这里引入了一些有关访问路径的符号：</p>
<ul>
<li><code>SeqScanPath(table)</code>表示表<code>table</code>上的顺序扫描路径。</li>
<li><code>Materialized -&gt; SeqScanPath(table)</code>表示表<code>table</code>上的物化顺序扫描路径。</li>
<li><code>IndexScanPath(table,attribute)</code>表示按表<code>table</code>中属性<code>attribute</code>上的索引扫描路径。</li>
<li><code>ParameterizedIndexScanPath(table,attribute1,attribute2)</code>表示表<code>table</code>中属性<code>attribute1</code>上的参数化索引路径，并使用外表上的属性<code>attribute2</code>参数化。</li>
</ul>
<p><strong>表 3.1 此示例中的所有连接访问路径组合</strong></p>
<p><strong>嵌套循环连接</strong></p>
<table>
<thead>
<tr>
<th>外表路径</th>
<th>内表路径</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SeqScanPath(tbl_a)</code></td>
<td><code>SeqScanPath(tbl_b)</code></td>
<td></td>
</tr>
<tr>
<td><code>SeqScanPath(tbl_a)</code></td>
<td><code>Materialized -&gt; SeqScanPath(tbl_b)</code></td>
<td>物化嵌套循环链接</td>
</tr>
<tr>
<td><code>IndexScanPath(tbl_a,id)</code></td>
<td><code>SeqScanPath(tbl_b)</code></td>
<td>嵌套循环连接，走外表索引</td>
</tr>
<tr>
<td><code>IndexScanPath(tbl_a,id)</code></td>
<td><code>Materialized -&gt; SeqScanPath(tbl_b)</code></td>
<td>物化嵌套循环连接，走外表索引</td>
</tr>
<tr>
<td><code>SeqScanPath(tbl_b)</code></td>
<td><code>SeqScanPath(tbl_a)</code></td>
<td></td>
</tr>
<tr>
<td><code>SeqScanPath(tbl_b)</code></td>
<td><code>Materialized -&gt; SeqScanPath(tbl_a)</code></td>
<td>物化嵌套循环连接</td>
</tr>
<tr>
<td><code>SeqScanPath(tbl_b)</code></td>
<td><code>ParametalizedIndexScanPath(tbl_a, id, tbl_b.id)</code></td>
<td>索引嵌套循环连接</td>
</tr>
</tbody>
</table>
<p><strong>归并连接</strong></p>
<table>
<thead>
<tr>
<th>外表路径</th>
<th>内表路径</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SeqScanPath(tbl_a)</code></td>
<td><code>SeqScanPath(tbl_b)</code></td>
<td></td>
</tr>
<tr>
<td><code>IndexScanPath(tbl_a,id)</code></td>
<td><code>SeqScanPath(tbl_b)</code></td>
<td>用外表索引做归并连接</td>
</tr>
<tr>
<td><code>SeqScanPath(tbl_b)</code></td>
<td><code>SeqScanPath(tbl_a)</code></td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>哈希连接</strong></p>
<table>
<thead>
<tr>
<th>外表路径</th>
<th>内表路径</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SeqScanPath(tbl_a)</code></td>
<td><code>SeqScanPath(tbl_b)</code></td>
<td></td>
</tr>
<tr>
<td><code>SeqScanPath(tbl_b)</code></td>
<td><code>SeqScanPath(tbl_a)</code></td>
<td></td>
</tr>
</tbody>
</table>
<p>例如在嵌套循环连接的部分总共评估了七条连接路径。 第一条表示在外表<code>tbl_a</code>和内表<code>tbl_b</code>上都使用顺序扫描路径；第二条表示在外表<code>tbl_a</code>上使用路径顺序扫描路径，而在内表<code>tbl_b</code>上使用物化顺序扫描路径，诸如此类。</p>
<p>计划器最终从估计的连接访问路径中选择代价最小的那条，并且将其添加至<code>RelOptInfo{tbl_a,tbl_b}</code>的路径列表中，如图3.33所示。</p>
<p>在本例中，如下面<code>EXPLAIN</code>的结果所示，计划器选择了在内表<code>tbl_b</code>和外表<code>tbl_c</code>上进行散列连接。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">400</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                              </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                              
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Hash</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Join</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">90</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">277</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">400</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">Hash</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">145</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Hash</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">85</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">85</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">400</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Seq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">85</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">400</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#000">Filter</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">400</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="363-获取三表查询代价最小的路径">3.6.3 获取三表查询代价最小的路径</h3>
<p>涉及三个表的查询，其代价最小的路径的获取过程如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">\</span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;public.tbl_a&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Type</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Modifiers</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------+---------+-----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">\</span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;public.tbl_b&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Type</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Modifiers</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------+---------+-----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">\</span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;public.tbl_c&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Type</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Modifiers</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------+---------+-----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Indexes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;tbl_c_pkey&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_c</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">-#</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">40</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>
<p>第一层：</p>
<p>计划器估计所有表上各自开销最小的路径，并将该信息存储在表相应的<code>RelOptInfos</code>结构<code>{tbl_a}</code>，<code>{tbl_b}</code>，<code>{tbl_c}</code>中。</p>
</li>
<li>
<p>第二层：</p>
<p>计划器从三个表中选出两个，列出所有组合，分别评估每种组合里代价最小的路径。然后，规划器将信息存储在组合相应的<code>RelOptInfos</code>结构中：<code>{tbl_a,tbl_b}</code>，<code>{tbl_b,tbl_c}</code>和<code>{tbl_a,tbl_c}</code>中。</p>
</li>
<li>
<p>第三层：</p>
<p>计划器根据所有已获取的<code>RelOptInfos</code>，选择代价最小的路径。更确切地说，计划器会考虑三种<code>RelOptInfos</code>组合：<code>{tbl_a,{tbl_b,tbl_c}}</code>，<code>{tbl_b,{tbl_a,tbl_c}}</code>和<code>{tbl_c,{tbl_a,tbl_b}}</code>，而<code>{tbl_a,tbl_b,tbl_c}</code>如下所示：</p>
</li>
</ul>
<p>$$
\begin{equation}
{\verb|tbl_a|,\verb|tbl_b|,\verb|tbl_c|} = \ \mathrm{min}({\verb|tbl_a|,{\verb|tbl_b|,\verb|tbl_c|}}, {\verb|tbl_b|,{\verb|tbl_a|,\verb|tbl_c|}}, {\verb|tbl_c|,{\verb|tbl_a|,\verb|tbl_b|}}).
\end{equation}
$$</p>
<p>计划器会估算这里面所有可能连接路径的代价。</p>
<p>在处理<code>{tbl_c,{tbl_a,tbl_b}}</code>对应的<code>RelOptInfo</code>时，计划器会估计<code>tbl_c</code>和<code>{tbl_a,tbl_b}</code>连接代价最小的路径。本例中<code>{tbl_a,tbl_b}</code>已经选定为内表为<code>tbl_a</code>且外表为<code>tbl_b</code>的散列连接。如先前小节所述，在估计时三种连接算法及其变体都会被评估，即嵌套循环连接及其变体，归并连接及其变体，散列连接及其变体。</p>
<p>计划器以同样的方式处理<code>{tbl_a,{tbl_b,tbl_c}}</code>与<code>{tbl_b,{tbl_a,tbl_c}}</code>对应的<code>RelOptInfo</code>，并最终从所有估好的路径中选择代价最小的访问路径。</p>
<p>该查询的<code>EXPLAIN</code>命令结果如下所示：</p>
<p><img src="/img/blog/kernel/fig-3-34.png"></p>
<p>最外层的连接是索引嵌套循环连接（第5行），第13行显示了内表上的参数化索引扫描，外表则是一个散列连接的结果该散列连接的内表是<code>tbl_a</code>，外表是<code>tbl_b</code>（第7-12行）。 因此，执行程序首先执行<code>tbl_a</code>和<code>tbl_b</code>上的散列连接，再执行索引嵌套循环连接。</p>
<h2 id="参考文献">参考文献</h2>
<ul>
<li>[1] Abraham Silberschatz, Henry F. Korth, and S. Sudarshan, &ldquo;<a href="https://www.amazon.com/dp/0073523321">Database System Concepts</a>&rdquo;, McGraw-Hill Education, ISBN-13: 978-0073523323</li>
<li>[2] Thomas M. Connolly, and Carolyn E. Begg, &ldquo;<a href="https://www.amazon.com/dp/0321523067">Database Systems</a>&rdquo;, Pearson, ISBN-13: 978-0321523068</li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-d2910fe4d643465a0c1e033313ed87b0">第四章 外部数据包装器</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://www.interdb.jp/pg/">Hironobu SUZUKI</a> ，译者：<a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-01-08" class="text-muted">2018年01月08日</time>
        
	</div>
	<p>本章将介绍一种相当实用，而且很有趣的特性：<strong>外部数据包装器（Foreign Data Wrapper FDW）</strong>。</p>
<h2 id="41-外部数据包装器fdw">4.1 外部数据包装器（FDW）</h2>
<p>2003年，SQL标准中添加了一个访问远程数据的规范，称为<a href="https://wiki.postgresql.org/wiki/">SQL外部数据管理</a>（SQL/MED）。PostgreSQL在9.1版本开发出了FDW，实现了一部分SQL/MED中的特性。</p>
<p>在SQL/MED中，远程服务器上的表被称为<strong>外部表（Foreign Table）</strong>。 PostgreSQL的<strong>外部数据包装器（FDW）</strong> 使用与本地表类似的方式，通过SQL/MED来管理外部表。</p>
<p><strong>图4.1 FDW的基本概念</strong></p>
<p><img alt="Fig. 4.1. Basic concept of FDW." src="/img/blog/kernel/fig-4-1.png"></p>
<p>安装完必要的扩展并配置妥当后，就可以访问远程服务器上的外部表了。 例如假设有两个远程服务器分别名为<code>postgresql</code>和<code>mysql</code>，它们上面分别有两张表：<code>foreign_pg_tbl</code>和<code>foreign_my_tbl</code>。 在本例中，可以在本地服务器上执行<code>SELECT</code>查询以访问外部表，如下所示。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- foreign_pg_tbl 在远程postgresql服务器上
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">-#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foreign_pg_tbl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- foreign_my_tbl 在远程mysql服务器上
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">-#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foreign_my_tbl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>此外还可以在本地连接来自不同服务器中的外部表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foreign_pg_tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foreign_my_tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">m</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><a href="https://wiki.postgresql.org/wiki/Foreign_data_wrappers">Postgres wiki</a>中列出了很多现有的FDW扩展。但只有<a href="https://www.postgresql.org/docs/current/static/postgres-fdw.html"><code>postgres_fdw</code></a> 与<a href="https://www.postgresql.org/docs/current/static/file-fdw.html"><code>file_fdw</code></a> 是由官方PostgreSQL全球开发组维护的。<code>postgres_fdw</code>可用于访问远程PostgreSQL服务器。</p>
<p>以下部分将详细介绍PostgreSQL的FDW。 4.1.1节为概述，4.1.2节介绍了<code>postgres_fdw</code>扩展的工作方式。</p>
<blockquote>
<p><strong>Citus</strong></p>
<p><a href="https://github.com/citusdata/citus">Citus</a>是由<a href="https://www.citusdata.com">citusdata.com</a>开发的开源PostgreSQL扩展，它能创建用于并行化查询的分布式PostgreSQL服务器集群。citus算是PostgreSQL生态中机制上最为复杂，且商业上最为成功的扩展之一，它也是一种FDW。</p>
</blockquote>
<h3 id="411-概述">4.1.1 概述</h3>
<p>使用FDW特性需要先安装相应的扩展，并执行一些设置命令，例如<a href="https://www.postgresql.org/docs/current/static/sql-createforeigntable.html"><code>CREATE FOREIGN TABLE</code></a>，<a href="https://www.postgresql.org/docs/current/static/sql-createserver.html"><code>CREATE SERVER</code></a> 和<a href="https://www.postgresql.org/docs/current/static/sql-createusermapping.html"><code>CREATE USER MAPPING</code></a>（细节请参阅<a href="https://www.postgresql.org/docs/9.5/static/postgres-fdw.html#AEN180314">官方文档</a>）。</p>
<p>在配置妥当之后，查询处理期间，执行器将会调用扩展中定义的相应函数来访问外部表。</p>
<p><strong>图4.2 FDW是如何执行的</strong></p>
<p><img alt="Fig. 4.2. How FDWs perform." src="/img/blog/kernel/fig-4-2.png"></p>
<ol>
<li>分析器为输入的SQL创建一颗查询树。</li>
<li>计划器（或执行器）连接到远程服务器。</li>
<li>如果启用了<a href="https://www.postgresql.org/docs/current/static/postgres-fdw.html#id-1.11.7.43.10.4"><code>use_remote_estimate</code></a>选项（默认关闭），则计划器将执行<code>EXPLAIN</code>命令以估计每条计划路径的代价。</li>
<li>计划器按照计划树创建出纯文本SQL语句，在内部称该过程为<strong>逆解析（deparesing）</strong>。</li>
<li>执行器将纯文本SQL语句发送到远程服务器并接收结果。</li>
</ol>
<p>如有必要，执行器会进一步处理接收到的结果。 例如执行多表查询时，执行器会将收到的数据与其他表进行连接。</p>
<p>以下各节介绍了每一步中的具体细节。</p>
<h4 id="4111-创建一颗查询树">4.1.1.1 创建一颗查询树</h4>
<p>分析器会根据输入的SQL创建一颗查询树，并使用外部表的定义。当执行命令<a href="https://www.postgresql.org/docs/current/static/sql-createforeigntable.html"><code>CREATE FOREIGN TABLE</code></a> 和<a href="https://www.postgresql.org/docs/current/static/sql-importforeignschema.html"><code>IMPORT FOREIGN SCHEMA</code></a>时，外部表的定义会被存储至系统目录<a href="https://www.postgresql.org/docs/current/static/catalog-pg-class.html"><code>pg_catalog.pg_class</code></a>和<a href="https://www.postgresql.org/docs/current/static/catalog-pg-foreign-table.html"><code>pg_catalog.pg_foreign_table</code></a>中。</p>
<h4 id="4112-连接至远程服务器">4.1.1.2 连接至远程服务器</h4>
<p>计划器（或执行器）会使用特定的库连接至远程数据库服务器。 例如要连接至远程PostgreSQL服务器时，<code>postgres_fdw</code>会使用<a href="https://www.postgresql.org/docs/current/static/libpq.html"><code>libpq</code></a>。 而连接到mysql服务器时，由EnterpriseDB开发的<a href="https://github.com/EnterpriseDB/mysql_fdw"><code>mysql_fdw</code></a>使用<code>libmysqlclient</code>。</p>
<p>当执行<a href="https://www.postgresql.org/docs/current/static/sql-createusermapping.html"><code>CREATE USER MAPPING</code></a>和<a href="https://www.postgresql.org/docs/current/static/sql-createserver.html"><code>CREATE SERVER</code></a>命令时，诸如用户名，服务器IP地址和端口号等连接参数会被存储至系统目录<a href="https://www.postgresql.org/docs/current/static/catalog-pg-user-mapping.html"><code>pg_catalog.pg_user_mapping</code></a>和<a href="https://www.postgresql.org/docs/current/static/catalog-pg-foreign-server.html"><code>pg_catalog.pg_foreign_server</code></a>中。</p>
<h4 id="4113-使用explain命令创建计划树可选">4.1.1.3 使用EXPLAIN命令创建计划树（可选）</h4>
<p>PostgreSQL的FDW机制支持一种特性：获取外部表上的统计信息，用于估计查询代价。一些FDW扩展使用了该特性，例如<code>postgres_fdw</code>，<code>mysql_fdw</code>，<code>tds_fdw</code>和<code>jdbc2_fdw</code>。</p>
<p>如果使用<a href="https://www.postgresql.org/docs/current/static/sql-alterserver.html"><code>ALTER SERVER</code></a>命令将<code>use_remote_estimate</code>选项设置为<code>on</code>，则计划器会向远程服务器发起查询，执行<code>EXPLAIN</code>命令获取执行计划的代价。否则在默认情况下，会使用默认内置常量值作为代价。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SERVER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">remote_server_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OPTIONS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">use_remote_estimate</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;on&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>尽管一些扩展也会执行<code>EXPLAIN</code>命令，但目前只有<code>postgres_fdw</code>才能忠于<code>EXPLAIN</code>命令的真正意图，因为PostgreSQL的<code>EXPLAIN</code>命令会同时返回启动代价和总代价。而其他DBMS的FDW扩展一般无法使用<code>EXPLAIN</code>命令的结果进行规划。 例如MySQL的<code>EXPLAIN</code>命令仅仅返回估计的行数， 但如<a href="/zh/blog/kernel/ch3/">第3章</a>所述，PostgreSQL的计划器需要更多的信息来估算代价。</p>
<h4 id="4114-逆解析">4.1.1.4 逆解析</h4>
<p>在生成执行计划树的过程中，计划器会为执行计划树上外部表的扫描路径创建相应的纯文本SQL语句。 例如图4.3展示了下列<code>SELECT</code>语句对应的计划树。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>图4.3展示了一个存储着纯文本形式<code>SELECT</code>语句的<code>ForeignScan</code>节点，<code>PlannedStmt</code>是执行计划树对应的数据结构，包含指向<code>ForeignScan</code>节点的链接。 这里，<code>postgres_fdw</code>从查询树中重新创建出<code>SELECT</code>纯文本语句，该过程在PostgreSQL中被称为<strong>逆解析（deparsing）</strong>。</p>
<p><strong>图4.3 扫描外部表的计划树样例</strong></p>
<p><img alt="Fig. 4.3. Example of the plan tree that scans a foreign table." src="/img/blog/kernel/fig-4-3.png"></p>
<p>使用<code>mysql_fdw</code>时，则会从查询树中重新创建MySQL相应的<code>SELECT</code>语句。 使用<a href="https://github.com/pg-redis-fdw/redis_fdw"><code>redis_fdw</code></a>或<a href="https://github.com/nahanni/rw_redis_fdw"><code>rw_redis_fdw</code></a>会创建一条Redis中的<a href="https://redis.io/commands/select"><code>SELECT</code>命令</a>。</p>
<h4 id="4115-发送sql命令并接收结果">4.1.1.5 发送SQL命令并接收结果</h4>
<p>在进行逆解析之后，执行器将逆解析得到的SQL语句发送到远程服务器并接收结果。</p>
<p>扩展的开发者决定了将SQL语句发送至远程服务器的具体方法。 例如<code>mysql_fdw</code>在发送多条SQL语句时不使用事务。 在<code>mysql_fdw</code>中执行<code>SELECT</code>查询的典型SQL语句序列如下所示（图4.4）。</p>
<ul>
<li>（5-1）将<code>SQL_MODE</code>设置为<code>'ANSI_QUOTES'</code>。</li>
<li>（5-2）将<code>SELECT</code>语句发送到远程服务器。</li>
<li>（5-3）从远程服务器接收结果。这里<code>mysql_fdw</code>会将结果转换为PostgreSQL可读的格式。所有FDW扩展都实现了将结果转换为PostgreSQL可读数据的功能。</li>
</ul>
<p><strong>图4.4 <code>mysql_fdw</code>执行一个典型SELECT查询时的SQL语句序列</strong></p>
<p><img alt="Fig. 4.4. Typical sequence of SQL statements to execute a SELECT query in mysql_fdw" src="/img/blog/kernel/fig-4-4.png"></p>
<p>下面是远程服务器的日志，列出了实际接收到的语句。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">mysql</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">command_type</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">argument</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mysql</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">general_log</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">--------------+-----------------------------------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">command_type</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">argument</span><span style="color:#f8f8f8;text-decoration:underline">                                                              </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">--------------+-----------------------------------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">snip</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Query</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sql_mode</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;ANSI_QUOTES&#39;</span><span style="color:#f8f8f8;text-decoration:underline">                                            </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Prepare</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">tbl_a</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Close</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">stmt</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                                                                       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">--------------+-----------------------------------------------------------+
</span></span></span></code></pre></div><p><code>postgres_fdw</code>中的SQL命令顺序要更为复杂。在<code>postgres_fdw</code>中执行一个典型的<code>SELECT</code>查询，实际的语句序列如图4.5所示。</p>
<ul>
<li>
<p>（5-1）启动远程事务。远程事务的默认隔离级别是<code>REPEATABLE READ</code>；但如果本地事务的隔离级别设置为<code>SERIALIZABLE</code>，则远程事务的隔离级别也会设置为<code>SERIALIZABLE</code>。</p>
</li>
<li>
<p>（5-2）-（5-4）声明一个游标，SQL语句基本上以游标的方式来执行。</p>
</li>
<li>
<p>（5-5）执行<code>FETCH</code>命令获取结果。默认情况下<code>FETCH</code>命令一次获取100行。</p>
</li>
<li>
<p>（5-6）从远程服务器接收结果。</p>
</li>
<li>
<p>（5-7）关闭游标。</p>
</li>
<li>
<p>（5-8）提交远程事务。</p>
</li>
</ul>
<p><strong>图4.5 <code>postgres_fdw</code>执行一个典型SELECT查询时的SQL语句序列</strong></p>
<p><img alt="Fig. 4.5. Typical sequence of SQL statements to execute a SELECT query in postgres_fdw." src="/img/blog/kernel/fig-4-5.png"></p>
<p>这里是远程服务器的实际日志。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>LOG:  statement: START TRANSACTION ISOLATION LEVEL REPEATABLE READ
</span></span><span style="display:flex;"><span>LOG:  parse : DECLARE c1 CURSOR FOR SELECT id, data FROM public.tbl_a WHERE ((id &lt; 10))
</span></span><span style="display:flex;"><span>LOG:  bind : DECLARE c1 CURSOR FOR SELECT id, data FROM public.tbl_a WHERE ((id &lt; 10))
</span></span><span style="display:flex;"><span>LOG:  execute : DECLARE c1 CURSOR FOR SELECT id, data FROM public.tbl_a WHERE ((id &lt; 10))
</span></span><span style="display:flex;"><span>LOG:  statement: FETCH 100 FROM c1
</span></span><span style="display:flex;"><span>LOG:  statement: CLOSE c1
</span></span><span style="display:flex;"><span>LOG:  statement: COMMIT TRANSACTION
</span></span></code></pre></div><blockquote>
<h4 id="postgres_fdw中远程事务的默认隔离级别"><code>postgres_fdw</code>中远程事务的默认隔离级别</h4>
<p>远程事务的默认隔离级别为<code>REPEATABLE READ</code>，官方文档给出了原因和说明：</p>
<blockquote>
<p>当本地事务使用<code>SERIALIZABLE</code>隔离级别时，远程事务也会使用<code>SERIALIZABLE</code>隔离级别，否则使用<code>REPEATABLE READ</code>隔离级别。 这样做可以确保在远程服务器上执行多次扫表时，每次的结果之间都能保持一致。因此，即使其他活动在远程服务器上进行了并发更新，单个事务中的连续查询也将看到远程服务器上的一致性快照。</p>
</blockquote>
</blockquote>
<h3 id="412-postgres_fdw的工作原理">4.1.2 <code>postgres_fdw</code>的工作原理</h3>
<p><code>postgres_fdw</code>扩展是一个由PostgreSQL全球开发组官方维护的特殊模块，其源码包含在PostgreSQL源码树中。</p>
<p><code>postgres_fdw</code>正处于不断改善的过程中。 表4.1列出了官方文档中与<code>postgres_fdw</code>有关的发行说明。</p>
<p><strong>表4.1 与postgres_fdw有关的发布说明（摘自官方文档）</strong></p>
<table>
<thead>
<tr>
<th>版本</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>9.3</td>
<td><code>postgres_fdw</code>模块正式发布</td>
</tr>
<tr>
<td>9.6</td>
<td>在远程服务器上执行排序<br />在远程服务器上执行连接<br />如果可行，在远程服务器上执行<code>UPDATE</code>与<code>DELETE</code><br />允许在服务器与表的选项中设置批量拉取结果集的大小</td>
</tr>
<tr>
<td>10</td>
<td>如果可行， 将聚合函数下推至远程服务器</td>
</tr>
<tr>
<td>前一节描述了<code>postgres_fdw</code>如何处理单表查询，接下来的小节将介绍<code>postgres_fdw</code>如何处理多表查询，排序操作与聚合函数。</td>
<td></td>
</tr>
</tbody>
</table>
<p>本小节重点介绍<code>SELECT</code>语句；但<code>postgres_fdw</code>还可以处理其他DML（<code>INSERT</code>，<code>UPDATE</code>和<code>DELETE</code>）语句。</p>
<blockquote>
<h4 id="postgresql的fdw不会检测死锁">PostgreSQL的FDW不会检测死锁</h4>
<p><code>postgres_fdw</code>与FDW功能并不支持分布式锁管理器与分布式死锁检测功能， 因此很容易产生死锁。 例如某客户端A更新了一个本地表<code>tbl_local</code>与一个外部表<code>tbl_remote</code>，而另一个客户端B以相反的顺序更新<code>tbl_remote</code>和<code>tbl_local</code>，则这两个事务陷入死锁。但PostgreSQL无法检测到这种情况， 因而无法提交这些事务。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- Client A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_local</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_remote</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- Client B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_remote</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_local</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></blockquote>
<h4 id="4121-多表查询">4.1.2.1 多表查询</h4>
<p>当执行多表查询时，<code>postgres_fdw</code>使用单表<code>SELECT</code>语句依次拉取每个外部表，并在本地服务器上执行连接操作。</p>
<p>在9.5或更早版本中，即使所有外部表都存储在同一个远程服务器中，<code>postgres_fdw</code>也会单独拉取每个表再连接。</p>
<p>在9.6或更高版本中，<code>postgres_fdw</code>已经有所改进，当外部表位于同一服务器上且<a href="https://www.postgresql.org/docs/current/static/postgres-fdw.html"><code>use_remote_estimate</code></a>选项打开时，可以在远程服务器上执行远程连接操作。</p>
<p>执行细节如下所述。</p>
<p><strong>9.5及更早版本：</strong></p>
<p>我们研究一下PostgreSQL如何处理以下查询：两个外部表的连接：<code>tbl_a</code>和<code>tbl_b</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><code>EXPLAIN</code>的执行结果如下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                                  
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Merge</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Join</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">532</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">700</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">34</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10918</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">Merge</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">59</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">202</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">72</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">853</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Foreign</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">159</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">06</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">853</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">331</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">72</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">338</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2560</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Foreign</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">186</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2560</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>结果显示，执行器选择了归并连接，并按以下步骤处理：</p>
<ul>
<li>
<p>第8行：执行器使用外部表扫描拉取表<code>tbl_a</code>。</p>
</li>
<li>
<p>第6行：执行器在本地服务器上对拉取的<code>tbl_a</code>行进行排序。</p>
</li>
<li>
<p>第11行：执行器使用外表扫描拉取表<code>tbl_b</code>。</p>
</li>
<li>
<p>第9行：执行器在本地服务器上对拉取的<code>tbl_b</code>行进行排序。</p>
</li>
<li>
<p>第4行：执行器在本地服务器上执行归并连接操作。</p>
</li>
</ul>
<p>下面描述执行器如何拉取行集（图4.6）。</p>
<ul>
<li>
<p>（5-1）启动远程事务。</p>
</li>
<li>
<p>（5-2）声明游标<code>c1</code>，其<code>SELECT</code>语句如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#a40000">，</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#a40000">（</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#a40000">）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>（5-3）执行<code>FETCH</code>命令以拉取游标<code>c1</code>的结果。</p>
</li>
<li>
<p>（5-4）声明游标<code>c2</code>，其<code>SELECT</code>语句如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>注意原来双表查询中的WHERE子句是<code>tbl_a.id = tbl_b.id AND tbl_a.id &lt;200</code>；因而从逻辑上讲这条<code>SELECT</code>语句也可以添加上一条WHERE子句<code>tbl_b.id &lt;200</code>。但<code>postgres_fdw</code>没有办法执行这样的推理，因此执行器必须执行不包含任何WHERE子句的<code>SELECT</code>语句，获取外部表<code>tbl_b</code> 中的所有行。</p>
<p>这种处理方式效率很差，因为必须通过网络从远程服务器读取不必要的行。此外，执行归并连接还需要先对接受到的行进行排序。</p>
</li>
<li>
<p>（5-5）执行<code>FETCH</code>命令，拉取游标<code>c2</code>的结果。</p>
</li>
<li>
<p>（5-6）关闭游标<code>c1</code>。</p>
</li>
<li>
<p>（5-7）关闭游标<code>c2</code>。</p>
</li>
<li>
<p>（5-8）提交事务。</p>
</li>
</ul>
<p><strong>图4.6 在9.5及更早版本中执行多表查询时的SQL语句序列</strong></p>
<p><img alt="Fig. 4.6. Sequence of SQL statements to execute the Multi-Table Query in version 9.5 or earlier." src="/img/blog/kernel/fig-4-6.png"></p>
<p>这里是远程服务器的实际日志。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>LOG:  statement: START TRANSACTION ISOLATION LEVEL REPEATABLE READ
</span></span><span style="display:flex;"><span>LOG:  parse : DECLARE c1 CURSOR FOR
</span></span><span style="display:flex;"><span>      SELECT id, data FROM public.tbl_a WHERE ((id &lt; 200))
</span></span><span style="display:flex;"><span>LOG:  bind : DECLARE c1 CURSOR FOR
</span></span><span style="display:flex;"><span>      SELECT id, data FROM public.tbl_a WHERE ((id &lt; 200))
</span></span><span style="display:flex;"><span>LOG:  execute : DECLARE c1 CURSOR FOR
</span></span><span style="display:flex;"><span>      SELECT id, data FROM public.tbl_a WHERE ((id &lt; 200))
</span></span><span style="display:flex;"><span>LOG:  statement: FETCH 100 FROM c1
</span></span><span style="display:flex;"><span>LOG:  statement: FETCH 100 FROM c1
</span></span><span style="display:flex;"><span>LOG:  parse : DECLARE c2 CURSOR FOR
</span></span><span style="display:flex;"><span>      SELECT id, data FROM public.tbl_b
</span></span><span style="display:flex;"><span>LOG:  bind : DECLARE c2 CURSOR FOR
</span></span><span style="display:flex;"><span>      SELECT id, data FROM public.tbl_b
</span></span><span style="display:flex;"><span>LOG:  execute : DECLARE c2 CURSOR FOR
</span></span><span style="display:flex;"><span>      SELECT id, data FROM public.tbl_b
</span></span><span style="display:flex;"><span>LOG:  statement: FETCH 100 FROM c2
</span></span><span style="display:flex;"><span>LOG:  statement: FETCH 100 FROM c2
</span></span><span style="display:flex;"><span>LOG:  statement: FETCH 100 FROM c2
</span></span><span style="display:flex;"><span>LOG:  statement: FETCH 100 FROM c2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>... snip
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LOG:  statement: FETCH 100 FROM c2
</span></span><span style="display:flex;"><span>LOG:  statement: FETCH 100 FROM c2
</span></span><span style="display:flex;"><span>LOG:  statement: FETCH 100 FROM c2
</span></span><span style="display:flex;"><span>LOG:  statement: FETCH 100 FROM c2
</span></span><span style="display:flex;"><span>LOG:  statement: CLOSE c2
</span></span><span style="display:flex;"><span>LOG:  statement: CLOSE c1
</span></span><span style="display:flex;"><span>LOG:  statement: COMMIT TRANSACTION
</span></span></code></pre></div><p>在接收到行之后，执行器对接收到的<code>tbl_a</code>和<code>tbl_b</code>行进行排序，然后对已排序的行执行合并连接操作。</p>
<p><strong>9.6或更高版本：</strong></p>
<p>如果启用了<code>use_remote_estimate</code>选项（默认为关闭），则<code>postgres_fdw</code>会发送几条<code>EXPLAIN</code>命令，用于获取与外部表相关的所有计划的代价。</p>
<p>当发送<code>EXPLAIN</code>命令时，<code>postgres_fdw</code>将为每个单表查询执行<code>EXPLAIN</code>，也为执行远程连接操作时的<code>SELECT</code>语句执行<code>EXPLAIN</code> 。在本例中，以下七个<code>EXPLAIN</code>命令会被发送至远程服务器，用于估算每个<code>SELECT</code>语句的开销，从而选择开销最小的执行计划。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ASC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NULLS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LAST</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((((</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ASC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NULLS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LAST</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((((</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INNER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(((</span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>让我们在本地服务器上执行<code>EXPLAIN</code>命令，并观察计划器选择了哪一个计划。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                         
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Foreign</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">134</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">35</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">244</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">45</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">Relations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INNER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>结果显示，计划器选择了在远程服务器上进行<code>INNER JOIN</code>处理的执行计划，也是最有效率的执行计划。</p>
<p>下面讲述<code>postgres_fdw</code>是如何执行这一过程的，如图4.7所示。</p>
<p><strong>图4.7 执行远程连接操作时的SQL语句序列，9.6及更高版本</strong></p>
<p><img alt="Fig. 4.7. Sequence of SQL statements to execute the remote-join operation in version 9.6 or later." src="/img/blog/kernel/fig-4-7.png"></p>
<ul>
<li>
<p>（3-1）启动远程事务。</p>
</li>
<li>
<p>（3-2）执行<code>EXPLAIN</code>命令，估计每条计划路径的代价。在本例中执行了七条<code>EXPLAIN</code>命令。然后计划器根据<code>EXPLAIN</code>命令的结果，选取具有最低开销的<code>SELECT</code>查询。</p>
</li>
<li>
<p>（5-1）声明游标<code>c1</code>，其<code>SELECT</code>语句如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INNER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(((</span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>（5-2）从远程服务器接收结果。</p>
</li>
<li>
<p>（5-3）关闭游标<code>c1</code>。</p>
</li>
<li>
<p>（5-4）提交事务。</p>
</li>
</ul>
<p>这里是远程服务器的实际日志。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">START</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRANSACTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ISOLATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LEVEL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPEATABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">READ</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ASC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NULLS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LAST</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((((</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ASC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NULLS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LAST</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((((</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">integer</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INNER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(((</span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">parse</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CURSOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	   </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INNER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(((</span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CURSOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	   </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INNER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(((</span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">execute</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CURSOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	   </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INNER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(((</span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">r1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FETCH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FETCH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CLOSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRANSACTION</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>注意如果禁用<code>use_remote_estimate</code>选项（默认情况），则远程连接查询很少会被选择，因为这种情况下其代价会使用一个很大的预置值进行估计。</p>
<h4 id="4122-排序操作">4.1.2.2 排序操作</h4>
<p>在9.5或更早版本中，排序操作（如<code>ORDER BY</code>）都是在本地服务器上处理的。即，本地服务器在排序操作之前从远程服务器拉取所有的目标行。让我们通过<code>EXPLAIN</code>来看一个包含<code>ORDER BY</code>子句的简单查询是如何被处理的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                              </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                               
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">59</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">202</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">72</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">853</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">Sort</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Foreign</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">159</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">06</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">853</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>第6行：执行器将以下查询发送到远程服务器，然后获取查询结果。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SELECT id, data FROM public.tbl_a WHERE ((id &lt; 200))
</span></span></code></pre></div><p>第4行：执行器在本地服务器上对拉取的<code>tbl_a</code>中的行进行排序。</p>
<p>这里是远程服务器的实际日志。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>LOG:  statement: START TRANSACTION ISOLATION LEVEL REPEATABLE READ
</span></span><span style="display:flex;"><span>LOG:  parse : DECLARE c1 CURSOR FOR
</span></span><span style="display:flex;"><span>      SELECT id, data FROM public.tbl_a WHERE ((id &lt; 200))
</span></span><span style="display:flex;"><span>LOG:  bind : DECLARE c1 CURSOR FOR
</span></span><span style="display:flex;"><span>      SELECT id, data FROM public.tbl_a WHERE ((id &lt; 200))
</span></span><span style="display:flex;"><span>LOG:  execute : DECLARE c1 CURSOR FOR
</span></span><span style="display:flex;"><span>      SELECT id, data FROM public.tbl_a WHERE ((id &lt; 200))
</span></span><span style="display:flex;"><span>LOG:  statement: FETCH 100 FROM c1
</span></span><span style="display:flex;"><span>LOG:  statement: FETCH 100 FROM c1
</span></span><span style="display:flex;"><span>LOG:  statement: CLOSE c1
</span></span><span style="display:flex;"><span>LOG:  statement: COMMIT TRANSACTION
</span></span></code></pre></div><p>在9.6或更高版本中，如果可行，<code>postgres_fdw</code>能在远程服务器上直接执行带<code>ORDER BY</code>子句的<code>SELECT</code>语句。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                            
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Foreign</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">167</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">46</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">853</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>第4行：执行器将以下带<code>ORDER BY</code>子句的查询发送至远程服务器，然后拉取已排序的查询结果。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ASC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NULLS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LAST</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这里是远程服务器的实际日志。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">START</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRANSACTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ISOLATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LEVEL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPEATABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">READ</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">parse</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CURSOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	   </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ASC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NULLS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LAST</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">bind</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CURSOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	   </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ASC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NULLS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LAST</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">execute</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CURSOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	   </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ASC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NULLS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LAST</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FETCH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FETCH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CLOSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRANSACTION</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h4 id="4123-聚合函数">4.1.2.3 聚合函数</h4>
<p>在9.6及更早版本中，类似于前一小节中提到的排序操作，<code>AVG()</code>和<code>COUNT()</code>这样的聚合函数会在本地服务器上进行处理，如下所示。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AVG</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                              </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                               
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Aggregate</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">168</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">168</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">51</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Foreign</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">166</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">06</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">975</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>第5行：执行器将以下查询发送到远程服务器，然后拉取查询结果。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>第4行：执行器在本地服务器上对拉取的<code>tbl_a</code>行集求均值。</p>
<p>这一过程开销很大，因为发送大量的行会产生大量网络流量，而且需要很长时间。</p>
<p>这里是远程服务器的实际日志。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">START</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRANSACTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ISOLATION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LEVEL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPEATABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">READ</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">parse</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CURSOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">bind</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CURSOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">execute</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DECLARE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CURSOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FETCH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FETCH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CLOSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">statement</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COMMIT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRANSACTION</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在10或更高版本中，如果可行的话，<code>postgres_fdw</code>将在远程服务器上执行带聚合函数的<code>SELECT</code>语句。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">localdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXPLAIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AVG</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#000">QUERY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PLAN</span><span style="color:#f8f8f8;text-decoration:underline">                      
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Foreign</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Scan</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">102</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">44</span><span style="color:#000;font-weight:bold">..</span><span style="color:#0000cf;font-weight:bold">149</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">Relations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Aggregate</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>第4行：执行器将以下包含<code>AVG()</code>函数的查询发送至远程服务器，然后获取查询结果。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">avg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tbl_a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这种处理方式显然更为高效，因为远程服务器会负责计算均值，仅发送单行结果。</p>
<p>这里是远程服务器的实际日志。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>LOG:  statement: START TRANSACTION ISOLATION LEVEL REPEATABLE READ
</span></span><span style="display:flex;"><span>LOG:  parse : DECLARE c1 CURSOR FOR
</span></span><span style="display:flex;"><span>	   SELECT avg(data) FROM public.tbl_a WHERE ((id &lt; 200))
</span></span><span style="display:flex;"><span>LOG:  bind : DECLARE c1 CURSOR FOR
</span></span><span style="display:flex;"><span>	   SELECT avg(data) FROM public.tbl_a WHERE ((id &lt; 200))
</span></span><span style="display:flex;"><span>LOG:  execute : DECLARE c1 CURSOR FOR
</span></span><span style="display:flex;"><span>	   SELECT avg(data) FROM public.tbl_a WHERE ((id &lt; 200))
</span></span><span style="display:flex;"><span>LOG:  statement: FETCH 100 FROM c1
</span></span><span style="display:flex;"><span>LOG:  statement: CLOSE c1
</span></span><span style="display:flex;"><span>LOG:  statement: COMMIT TRANSACTION
</span></span></code></pre></div><blockquote>
<h4 id="下推">下推</h4>
<p>与上面的例子类似，<strong>下推（push-down）</strong> 指的是本地服务器允许一些操作在远程服务器上执行，例如聚合函数。</p>
</blockquote>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-0b65ca84d8bbbf7fe45a2acc95693e7e">第五章 并发控制</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://www.interdb.jp/pg/">Hironobu SUZUKI</a> ，译者：<a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-01-07" class="text-muted">2018年01月07日</time>
        
	</div>
	<p>当多个事务同时在数据库中运行时，<strong>并发控制</strong>是一种用于维持<strong>一致性</strong>与<strong>隔离性</strong>的技术，一致性与隔离性是ACID的两个属性。</p>
<p>从宽泛的意义上来讲，有三种并发控制技术：<strong>多版本并发控制（Multi-version Concurrency Control, MVCC）</strong>，<strong>严格两阶段锁定（Strict Two-Phase Locking, S2PL）<strong>和</strong>乐观并发控制（Optimistic Concurrency Control, OCC）</strong>，每种技术都有多种变体。在MVCC中，每个写操作都会创建一个新版本的数据项，并保留其旧版本。当事务读取数据对象时，系统会选择其中的一个版本，通过这种方式来确保各个事务间相互隔离。 MVCC的主要优势在于“读不会阻塞写，而写也不会阻塞读”，相反的例子是，基于S2PL的系统在写操作发生时会阻塞相应对象上的读操作，因为写入者获取了对象上的排他锁。 PostgreSQL和一些RDBMS使用一种MVCC的变体，名曰 <strong>快照隔离（Snapshot Isolation，SI）</strong>。</p>
<p>一些RDBMS（例如Oracle）使用回滚段来实现快照隔离SI。当写入新数据对象时，旧版本对象先被写入回滚段，随后用新对象覆写至数据区域。 PostgreSQL使用更简单的方法：新数据对象被直接插入到相关表页中。读取对象时，PostgreSQL根据<strong>可见性检查规则（visibility check rules）</strong>，为每个事务选择合适的对象版本作为响应。</p>
<p>SI中不会出现在ANSI SQL-92标准中定义的三种异常：脏读，不可重复读和幻读。但SI无法实现真正的可串行化，因为在SI中可能会出现串行化异常：例如 <strong>写偏差（write skew）</strong> 和 <strong>只读事务偏差（Read-only Transaction Skew）</strong> 。需要注意的是：ANSI SQL-92标准中可串行化的定义与现代理论中的定义<strong>并不相同</strong>。为了解决这个问题，PostgreSQL从9.1版本之后添加了<strong>可串行化快照隔离（SSI，Serializable Snapshot Isolation）</strong>，SSI可以检测串行化异常，并解决这种异常导致的冲突。因此，9.1版本之后的PostgreSQL提供了真正的<code>SERIALIZABLE</code>隔离等级（此外SQL Server也使用SSI，而Oracle仍然使用SI）。</p>
<p>本章包括以下四个部分：</p>
<ul>
<li>
<p>第1部分：第5.1~5.3节。</p>
<p>这一部分介绍了理解后续部分所需的基本信息。</p>
<p>第5.1和5.2节分别描述了事务标识和元组结构。第5.3节展示了如何插入，删除和更新元组。</p>
</li>
<li>
<p>第2部分：第5.4~5.6节。</p>
<p>这一部分说明了实现并发控制机制所需的关键功能。</p>
<p>第5.4，5.5和5.6节描述了<strong>提交日志（clog）</strong>，分别介绍了事务状态，事务快照和可见性检查规则。</p>
</li>
<li>
<p>第3部分：第5.7~5.9节。</p>
<p>这一部分使用具体的例子来介绍PostgreSQL中的并发控制。</p>
<p>这一部分说明了如何防止ANSI SQL标准中定义的三种异常。第5.7节描述了可见性检查，第5.8节介绍了如何防止丢失更新，第5.9节简要描述了SSI。</p>
</li>
<li>
<p>第4部分：第5.10节。</p>
<p>这一部分描述了并发控制机制持久运行所需的几个维护过程。维护过程主要通过 <strong>清理过程（vacuum processing）</strong> 进行，清理过程将在<a href="/zh/blog/kernel/ch6/">第6章</a>详细阐述。</p>
</li>
</ul>
<p>并发控制包含着很多主题，本章重点介绍PostgreSQL独有的内容。故这里省略了锁模式与死锁处理的内容（相关信息请参阅官方文档）。</p>
<hr>
<p><strong>PostgreSQL中的事务隔离等级</strong></p>
<blockquote>
<p>PostgreSQL实现的事务隔离等级如下表所示：</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:center">隔离等级</th>
<th style="text-align:center">脏读</th>
<th style="text-align:center">不可重复读</th>
<th style="text-align:center">幻读</th>
<th style="text-align:center">串行化异常</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">读已提交</td>
<td style="text-align:center">不可能</td>
<td style="text-align:center">可能</td>
<td style="text-align:center">可能</td>
<td style="text-align:center">可能</td>
</tr>
<tr>
<td style="text-align:center">可重复读[1]</td>
<td style="text-align:center">不可能</td>
<td style="text-align:center">不可能</td>
<td style="text-align:center">PG中不可能，见5.7.2小节<br />但ANSI SQL中可能</td>
<td style="text-align:center">可能</td>
</tr>
<tr>
<td style="text-align:center">可串行化</td>
<td style="text-align:center">不可能</td>
<td style="text-align:center">不可能</td>
<td style="text-align:center">不可能</td>
<td style="text-align:center">不可能</td>
</tr>
</tbody>
</table>
<p>[1]：在9.0及更早版本中，该级别被当做<code>SERIALIZABLE</code>，因为它不会出现ANSI SQL-92标准中定义的三种异常。 但9.1版中SSI的实现引入了真正的<code>SERIALIZABLE</code>级别，该级别已被改称为<code>REPEATABLE READ</code>。</p>
<blockquote>
<p>PostgreSQL对DML（<code>SELECT, UPDATE, INSERT, DELETE</code>等命令）使用SSI，对DDL（<code>CREATE TABLE</code>等命令）使用2PL。</p>
</blockquote>
<h2 id="51-事务标识">5.1 事务标识</h2>
<p>每当事务开始时，事务管理器就会为其分配一个称为 <strong>事务标识（transaction id, txid）</strong> 的唯一标识符。 PostgreSQL的<code>txid</code>是一个32位无符号整数，总取值约42亿。在事务启动后执行内置的<code>txid_current()</code>函数，即可获取当前事务的<code>txid</code>，如下所示。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">BEGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">txid_current</span><span style="color:#000;font-weight:bold">();</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">txid_current</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>PostgreSQL保留以下三个特殊<code>txid</code>：</p>
<ul>
<li><strong>0</strong> 表示 <strong>无效（Invalid）</strong> 的<code>txid</code>。</li>
<li><strong>1</strong> 表示 <strong>初始启动（Bootstrap）</strong> 的<code>txid</code>，仅用于数据库集群的初始化过程。</li>
<li><strong>2</strong> 表示 <strong>冻结（Frozen）</strong> 的<code>txid</code>，详情参考第5.10.1节。</li>
</ul>
<p><code>txid</code>可以相互比较大小。例如对于<code>txid=100</code>的事务，大于100的<code>txid</code>属于“未来”，且对于<code>txid=100</code>的事务而言都是 <strong>不可见（invisible）</strong> 的；小于100的<code>txid</code>属于“过去”，且对该事务可见，如图5.1(a)所示。</p>
<p><strong>图5.1  PostgreSQL中的事务标识</strong></p>
<p><img src="/img/blog/kernel/fig-5-01.png"></p>
<p>因为<code>txid</code>在逻辑上是无限的，而实际系统中的<code>txid</code>空间不足（4字节取值空间约42亿），因此PostgreSQL将<code>txid</code>空间视为一个环。对于某个特定的<code>txid</code>，其前约21亿个<code>txid</code>属于过去，而其后约21亿个<code>txid</code>属于未来。如图5.1(b)所示。</p>
<p>所谓的<code>txid</code>回卷问题将在5.10.1节中介绍。</p>
<blockquote>
<p>请注意，<code>txid</code>并非是在<code>BEGIN</code>命令执行时分配的。在PostgreSQL中，当执行<code>BEGIN</code>命令后的第一条命令时，事务管理器才会分配<code>txid</code>，并真正启动其事务。</p>
</blockquote>
<h2 id="52-元组结构">5.2 元组结构</h2>
<p>可以将表页中的堆元组分为两类：普通数据元组与TOAST元组。本节只会介绍普通元组。</p>
<p>堆元组由三个部分组成，即<code>HeapTupleHeaderData</code>结构，空值位图，以及用户数据，如图5.2所示。</p>
<p><strong>图5.2 元组结构</strong></p>
<p><img src="/img/blog/kernel/fig-5-02.png"></p>
<blockquote>
<p><code>HeapTupleHeaderData</code>结构在<a href="https://github.com/postgres/postgres/blob/ee943004466418595363d567f18c053bae407792/src/include/access/htup_details.h"><code>src/include/access/htup_details.h</code></a>中定义。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">HeapTupleFields</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">TransactionId</span> <span style="color:#000">t_xmin</span><span style="color:#000;font-weight:bold">;</span>		   <span style="color:#8f5902;font-style:italic">/* 插入事务的ID */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">TransactionId</span> <span style="color:#000">t_xmax</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">/*删除或锁定事务的ID*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">union</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">CommandId</span>       <span style="color:#000">t_cid</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">/* 插入或删除的命令ID */</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">TransactionId</span> 	<span style="color:#000">t_xvac</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* 老式VACUUM FULL的事务ID */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">t_field3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">HeapTupleFields</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">DatumTupleFields</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">int32</span>          <span style="color:#000">datum_len_</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">/* 变长头部长度*/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">int32</span>          <span style="color:#000">datum_typmod</span><span style="color:#000;font-weight:bold">;</span>   	    <span style="color:#8f5902;font-style:italic">/* -1或者是记录类型的标识 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Oid</span>            <span style="color:#000">datum_typeid</span><span style="color:#000;font-weight:bold">;</span>   	    <span style="color:#8f5902;font-style:italic">/* 复杂类型的OID或记录ID */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">DatumTupleFields</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">HeapTupleHeaderData</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">union</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">HeapTupleFields</span> <span style="color:#000">t_heap</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">DatumTupleFields</span> <span style="color:#000">t_datum</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">t_choice</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ItemPointerData</span> <span style="color:#000">t_ctid</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* 当前元组，或更新元组的TID */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* 下面的字段必需与结构MinimalTupleData相匹配! */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">uint16</span>          <span style="color:#000">t_infomask2</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* 属性与标记位 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">uint16</span>          <span style="color:#000">t_infomask</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">/* 很多标记位 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">uint8</span>           <span style="color:#000">t_hoff</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* 首部+位图+填充的长度 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* ^ - 23 bytes - ^ */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bits8</span>           <span style="color:#000">t_bits</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>      <span style="color:#8f5902;font-style:italic">/* NULL值的位图 —— 变长的 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* 本结构后面还有更多数据 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">HeapTupleHeaderData</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#000">HeapTupleHeaderData</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">HeapTupleHeader</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>虽然<code>HeapTupleHeaderData</code>结构包含七个字段，但后续部分中只需要了解四个字段即可。</p>
<ul>
<li><code>t_xmin</code>保存插入此元组的事务的<code>txid</code>。</li>
<li><code>t_xmax</code>保存删除或更新此元组的事务的<code>txid</code>。如果尚未删除或更新此元组，则<code>t_xmax</code>设置为0，即无效。</li>
<li><code>t_cid</code>保存<strong>命令标识（command id, cid）</strong>，<code>cid</code>意思是在当前事务中，执行当前命令之前执行了多少SQL命令，从零开始计数。例如，假设我们在单个事务中执行了三条<code>INSERT</code>命令<code>BEGIN;INSERT;INSERT;INSERT;COMMIT;</code>。如果第一条命令插入此元组，则该元组的<code>t_cid</code>会被设置为0。如果第二条命令插入此元组，则其<code>t_cid</code>会被设置为1，依此类推。</li>
<li><code>t_ctid</code>保存着指向自身或新元组的元组标识符（<code>tid</code>）。如第1.3节中所述，<code>tid</code>用于标识表中的元组。在更新该元组时，其<code>t_ctid</code>会指向新版本的元组；否则<code>t_ctid</code>会指向自己。</li>
</ul>
<h2 id="53-元组的增删改">5.3 元组的增删改</h2>
<p>本节会介绍元组的增删改过程，并简要描述用于插入与更新元组的<strong>自由空间映射（Free Space Map, FSM）</strong>。</p>
<p>这里主要关注元组，页首部与行指针不会在这里画出来，元组的具体表示如图5.3所示。</p>
<p><strong>图5.3 元组的表示</strong></p>
<p><img src="/img/blog/kernel/fig-5-03.png"></p>
<h3 id="531-插入">5.3.1 插入</h3>
<p>在插入操作中，新元组将直接插入到目标表的页面中，如图5.4所示。</p>
<p><strong>图5.4 插入元组</strong></p>
<p><img src="/img/blog/kernel/fig-5-04.png"></p>
<p>假设元组是由<code>txid=99</code>的事务插入页面中的，在这种情况下，被插入元组的首部字段会依以下步骤设置。</p>
<p><code>Tuple_1</code>：</p>
<ul>
<li><code>t_xmin</code>设置为99，因为此元组由<code>txid=99</code>的事务所插入。</li>
<li><code>t_xmax</code>设置为0，因为此元组尚未被删除或更新。</li>
<li><code>t_cid</code>设置为0，因为此元组是由<code>txid=99</code>的事务所执行的第一条命令所插入的。</li>
<li><code>t_ctid</code>设置为<code>(0,1)</code>，指向自身，因为这是该元组的最新版本。</li>
</ul>
<blockquote>
<h4 id="pageinspect"><code>pageinspect</code></h4>
<p>PostgreSQL自带了一个第三方贡献的扩展模块<code>pageinspect</code>，可用于检查数据库页面的具体内容。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pageinspect</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">A</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lp</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tuple</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_xmin</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_xmax</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_field3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_cid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_ctid</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">heap_page_items</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">get_raw_page</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">));</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tuple</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_xmin</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_xmax</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_cid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t_ctid</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------+--------+--------+-------+--------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">99</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></blockquote>
<h3 id="532-删除">5.3.2 删除</h3>
<p>在删除操作中，目标元组只是在逻辑上被标记为删除。目标元组的<code>t_xmax</code>字段将被设置为执行<code>DELETE</code>命令事务的<code>txid</code>。如图5.5所示。</p>
<p><strong>图5.5 删除元组</strong></p>
<p><img src="/img/blog/kernel/fig-5-05.png"></p>
<p>假设<code>Tuple_1</code>被<code>txid=111</code>的事务删除。在这种情况下，<code>Tuple_1</code>的首部字段会依以下步骤设置。</p>
<p><code>Tuple_1</code>：</p>
<ul>
<li><code>t_xmax</code>被设为111。</li>
</ul>
<p>如果<code>txid=111</code>的事务已经提交，那么<code>Tuple_1</code>就不是必需的了。通常不需要的元组在PostgreSQL中被称为<strong>死元组（dead tuple）</strong>。</p>
<p>死元组最终将从页面中被移除。清除死元组的过程被称为<strong>清理（VACUUM）过程</strong>，<a href="/zh/blog/kernel/ch6/">第6章</a>将介绍清理过程。</p>
<h3 id="533-更新">5.3.3 更新</h3>
<p>在更新操作中，PostgreSQL在逻辑上实际执行的是删除最新的元组，并插入一条新的元组（图5.6）。</p>
<p><strong>图5.6 两次更新同一行</strong></p>
<p><img src="/img/blog/kernel/fig-5-06.png"></p>
<p>假设由<code>txid=99</code>的事务插入的行，被<code>txid=100</code>的事务更新两次。</p>
<p>当执行第一条<code>UPDATE</code>命令时，<code>Tuple_1</code>的<code>t_xmax</code>被设为<code>txid 100</code>，在逻辑上被删除；然后<code>Tuple_2</code>被插入；接下来重写<code>Tuple_1</code>的<code>t_ctid</code>以指向<code>Tuple_2</code>。<code>Tuple_1</code>和<code>Tuple_2</code>的头部字段设置如下。</p>
<p><code>Tuple_1</code>：</p>
<ul>
<li><code>t_xmax</code>被设置为100。</li>
<li><code>t_ctid</code>从<code>(0,1)</code>被改写为<code>(0,2)</code>。</li>
</ul>
<p><code>Tuple_2</code>：</p>
<ul>
<li><code>t_xmin</code>被设置为100。</li>
<li><code>t_xmax</code>被设置为0。</li>
<li><code>t_cid</code>被设置为0。</li>
<li><code>t_ctid</code>被设置为<code>(0,2)</code>。</li>
</ul>
<p>当执行第二条<code>UPDATE</code>命令时，和第一条<code>UPDATE</code>命令类似，<code>Tuple_2</code>被逻辑删除，<code>Tuple_3</code>被插入。<code>Tuple_2</code>和<code>Tuple_3</code>的首部字段设置如下。</p>
<p><code>Tuple_2</code>：</p>
<ul>
<li><code>t_xmax</code>被设置为100。</li>
<li><code>t_ctid</code>从<code>(0,2)</code>被改写为<code>(0,3)</code>。</li>
</ul>
<p><code>Tuple_3</code>：</p>
<ul>
<li><code>t_xmin</code>被设置为100。</li>
<li><code>t_xmax</code>被设置为0。</li>
<li><code>t_cid</code>被设置为1。</li>
<li><code>t_ctid</code>被设置为<code>(0,3)</code>。</li>
</ul>
<p>与删除操作类似，如果<code>txid=100</code>的事务已经提交，那么<code>Tuple_1</code>和<code>Tuple_2</code>就成为了死元组，而如果<code>txid=100</code>的事务中止，<code>Tuple_2</code>和<code>Tuple_3</code>就成了死元组。</p>
<h3 id="534-空闲空间映射">5.3.4 空闲空间映射</h3>
<p>插入堆或索引元组时，PostgreSQL使用表与索引相应的<strong>FSM</strong>来选择可供插入的页面。</p>
<p>如1.2.3节所述，表和索引都有各自的FSM。每个FSM存储着相应表或索引文件中每个页面可用空间容量的信息。</p>
<p>所有FSM都以后缀<code>fsm</code>存储，在需要时它们会被加载到共享内存中。</p>
<blockquote>
<h4 id="pg_freespacemap"><code>pg_freespacemap</code></h4>
<p>扩展<code>pg_freespacemap</code>能提供特定表或索引上的空闲空间信息。以下查询列出了特定表中每个页面的空闲率。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># CREATE EXTENSION pg_freespacemap;</span>
</span></span><span style="display:flex;"><span>CREATE EXTENSION
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># SELECT *, round(100 * avail/8192 ,2) as &#34;freespace ratio&#34;</span>
</span></span><span style="display:flex;"><span>                FROM pg_freespace<span style="color:#ce5c00;font-weight:bold">(</span>accounts<span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span> blkno <span style="color:#000;font-weight:bold">|</span> avail <span style="color:#000;font-weight:bold">|</span> freespace ratio 
</span></span><span style="display:flex;"><span>-------+-------+-----------------
</span></span><span style="display:flex;"><span>     <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">7904</span> <span style="color:#000;font-weight:bold">|</span>           96.00
</span></span><span style="display:flex;"><span>     <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">7520</span> <span style="color:#000;font-weight:bold">|</span>           91.00
</span></span><span style="display:flex;"><span>     <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">7136</span> <span style="color:#000;font-weight:bold">|</span>           87.00
</span></span><span style="display:flex;"><span>     <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">7136</span> <span style="color:#000;font-weight:bold">|</span>           87.00
</span></span><span style="display:flex;"><span>     <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">7136</span> <span style="color:#000;font-weight:bold">|</span>           87.00
</span></span><span style="display:flex;"><span>     <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">7136</span> <span style="color:#000;font-weight:bold">|</span>           87.00
</span></span><span style="display:flex;"><span>....
</span></span></code></pre></div></blockquote>
<h2 id="54-提交日志clog">5.4 提交日志（clog）</h2>
<p>PostgreSQL在<strong>提交日志（Commit Log, clog）<strong>中保存事务的状态。提交日志（通常称为</strong>clog</strong>）分配于共享内存中，并用于事务处理过程的全过程。</p>
<p>本节将介绍PostgreSQL中事务的状态，clog的工作方式与维护过程。</p>
<h3 id="541-事务状态">5.4.1 事务状态</h3>
<p>PostgreSQL定义了四种事务状态，即：<code>IN_PROGRESS</code>，<code>COMMITTED</code>，<code>ABORTED</code>和<code>SUB_COMMITTED</code>。</p>
<p>前三种状态涵义显而易见。例如当事务正在进行时，其状态为<code>IN_PROGRESS</code>，依此类推。</p>
<p><code>SUB_COMMITTED</code>状态用于子事务，本文省略了与子事务相关的描述。</p>
<h3 id="542-提交日志如何工作">5.4.2 提交日志如何工作</h3>
<p>提交日志（下称clog）在逻辑上是一个数组，由共享内存中一系列8KB页面组成。数组的序号索引对应着相应事务的标识，而其内容则是相应事务的状态。clog的工作方式如图5.7所示。</p>
<p><strong>图5.7 clog如何工作</strong></p>
<p><img src="/img/blog/kernel/fig-5-07.png"></p>
<blockquote>
<p><strong>T1</strong>：<code>txid 200</code>提交；<code>txid 200</code>的状态从<code>IN_PROGRESS</code>变为<code>COMMITTED</code>。
<strong>T2</strong>：<code>txid 201</code>中止；<code>txid 201</code>的状态从<code>IN_PROGRESS</code>变为<code>ABORTED</code>。</p>
</blockquote>
<p><code>txid</code>不断前进，当clog空间耗尽无法存储新的事务状态时，就会追加分配一个新的页面。</p>
<p>当需要获取事务的状态时，PostgreSQL将调用相应内部函数读取clog，并返回所请求事务的状态。（参见第5.7.1节中的<strong>提示位（Hint Bits）</strong>）</p>
<h3 id="543-提交日志的维护">5.4.3 提交日志的维护</h3>
<p>当PostgreSQL关机或执行存档过程时，clog数据会写入至<code>pg_clog</code>子目录下的文件中（注意在10版本中，<code>pg_clog</code>被重命名为<code>pg_xact</code>）。这些文件被命名为<code>0000</code>，<code>0001</code>等等。文件的最大尺寸为256 KB。例如当clog使用八个页面时，从第一页到第八页的总大小为64 KB，这些数据会写入到文件<code>0000</code>（64 KB）中；而当clog使用37个页面时（296 KB），数据则会写入到<code>0000</code>和<code>0001</code>两个文件中，其大小分别为256 KB和40 KB。</p>
<p>当PostgreSQL启动时会加载存储在<code>pg_clog</code>（<code>pg_xact</code>）中的文件，用其数据初始化clog。</p>
<p>clog的大小会不断增长，因为只要clog一填满就会追加新的页面。但并非所有数据都是必需的。<a href="/zh/blog/kernel/ch6/">第6章</a>中描述的清理过程会定期删除这些不需要的旧数据（clog页面和文件），有关删除clog数据的详情请参见第6.4节。</p>
<h2 id="55-事务快照">5.5 事务快照</h2>
<p>**事务快照（transaction snapshot）**是一个数据集，存储着某个特定事务在某个特定时间点所看到的事务状态信息：哪些事务处于活跃状态。这里活跃状态意味着事务正在进行中，或还没有开始。</p>
<p>事务快照在PostgreSQL内部的文本表示格式定义为<code>100:100:</code>。举个例子，这里<code>100:100:</code>意味着<code>txid &lt; 100</code>的事务处于非活跃状态，而<code>txid ≥ 100</code>的事务处于活跃状态。下文都将使用这种便利形式来表示。如果读者还不熟悉这种形式，请参阅下文。</p>
<blockquote>
<h3 id="内置函数txid_current_snapshot及其文本表示">内置函数<code>txid_current_snapshot</code>及其文本表示</h3>
<p>函数<code>txid_current_snapshot</code>显示当前事务的快照。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">txid_current_snapshot</span><span style="color:#000;font-weight:bold">();</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">txid_current_snapshot</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">104</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">102</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><code>txid_current_snapshot</code>的文本表示是<code>xmin:xmax:xip_list</code>，各部分描述如下。</p>
<ul>
<li>
<p><strong><code>xmin</code></strong></p>
<p>最早仍然活跃的事务的<code>txid</code>。所有比它更早的事务<code>txid &lt; xmin</code>要么已经提交并可见，要么已经回滚并生成死元组。</p>
</li>
<li>
<p><strong><code>xmax</code></strong></p>
<p>第一个尚未分配的<code>txid</code>。所有<code>txid ≥ xmax</code>的事务在获取快照时尚未启动，因而其结果对当前事务不可见。</p>
</li>
<li>
<p><strong><code>xip_list</code></strong></p>
<p>获取快照时<strong>活跃事务</strong>的<code>txid</code>列表。该列表仅包括<code>xmin</code>与<code>xmax</code>之间的<code>txid</code>。</p>
<p>例如，在快照<code>100:104:100,102</code>中，<code>xmin</code>是<code>100</code>，<code>xmax</code>是<code>104</code>，而<code>xip_list</code>为<code>100,102</code>。</p>
</li>
</ul>
<p>以下显示了两个具体的示例：</p>
<p><strong>图5.8 事务快照的表示样例</strong></p>
<p><img src="/img/blog/kernel/fig-5-08.png"></p>
<p>第一个例子是<code>100:100:</code>，如图图5.8(a)所示，此快照表示：</p>
<ul>
<li>因为<code>xmin</code>为100，因此<code>txid &lt; 100</code>的事务是非活跃的</li>
<li>因为<code>xmax</code>为100，因此<code>txid ≥ 100</code>的事务是活跃的</li>
</ul>
<p>第二个例子是<code>100:104:100,102</code>，如图5.8(b)所示，此快照表示：</p>
<ul>
<li><code>txid &lt; 100</code>的事务不活跃。</li>
<li><code>txid ≥ 104</code>的事务是活跃的。</li>
<li><code>txid</code>等于100和102的事务是活跃的，因为它们在<code>xip_list</code>中，而<code>txid</code>等于101和103的事务不活跃。</li>
</ul>
</blockquote>
<p>事务快照是由事务管理器提供的。在<code>READ COMMITTED</code>隔离级别，事务在执行每条SQL时都会获取快照；其他情况下（<code>REPEATABLE READ</code>或<code>SERIALIZABLE</code>隔离级别），事务只会在执行第一条SQL命令时获取一次快照。获取的事务快照用于元组的可见性检查，如第5.7节所述。</p>
<p>使用获取的快照进行可见性检查时，所有<strong>活跃</strong>的事务都必须被当成<code>IN PROGRESS</code>的事务等同对待，无论它们实际上是否已经提交或中止。这条规则非常重要，因为它正是<code>READ COMMITTED</code>和<code>REPEATABLE READ/SERIALIZABLE</code>隔离级别中表现差异的根本来源，我们将在接下来几节中频繁回到这条规则上来。</p>
<p>在本节的剩余部分中，我们会通过一个具体的场景来描述事务与事务管理器，如图5.9所示。</p>
<p><strong>图5.9 事务管理器与事务</strong></p>
<p><img src="/img/blog/kernel/fig-5-09.png"></p>
<p>事务管理器始终保存着当前运行的事务的有关信息。假设三个事务一个接一个地开始，并且<code>Transaction_A</code>和<code>Transaction_B</code>的隔离级别是<code>READ COMMITTED</code>，<code>Transaction_C</code>的隔离级别是<code>REPEATABLE READ</code>。</p>
<ul>
<li>
<p>T1：
<code>Transaction_A</code>启动并执行第一条<code>SELECT</code>命令。执行第一个命令时，<code>Transaction_A</code>请求此刻的<code>txid</code>和快照。在这种情况下，事务管理器分配<code>txid=200</code>，并返回事务快照<code>200:200:</code>。</p>
</li>
<li>
<p>T2：
<code>Transaction_B</code>启动并执行第一条<code>SELECT</code>命令。事务管理器分配<code>txid=201</code>，并返回事务快照<code>200:200:</code>，因为<code>Transaction_A(txid=200)</code>正在进行中。因此无法从<code>Transaction_B</code>中看到<code>Transaction_A</code>。</p>
</li>
<li>
<p>T3：
<code>Transaction_C</code>启动并执行第一条<code>SELECT</code>命令。事务管理器分配<code>txid=202</code>，并返回事务快照<code>200:200:</code>，因此不能从<code>Transaction_C</code>中看到<code>Transaction_A</code>和<code>Transaction_B</code>。</p>
</li>
<li>
<p>T4：
<code>Transaction_A</code>已提交。事务管理器删除有关此事务的信息。</p>
</li>
<li>
<p>T5：
<code>Transaction_B</code>和<code>Transaction_C</code>执行它们各自的<code>SELECT</code>命令。</p>
<p><code>Transaction_B</code>需要一个新的事务快照，因为它使用了<code>READ COMMITTED</code>隔离等级。在这种情况下，<code>Transaction_B</code>获取新快照<code>201:201:</code>，因为<code>Transaction_A(txid=200)</code>已提交。因此<code>Transaction_A</code>的变更对<code>Transaction_B</code>可见了。</p>
<p><code>Transaction_C</code>不需要新的事务快照，因为它处于<code>REPEATABLE READ</code>隔离等级，并继续使用已获取的快照，即<code>200:200:</code>。因此，<code>Transaction_A</code>的变更仍然对<code>Transaction_C</code>不可见。</p>
</li>
</ul>
<h2 id="56-可见性检查规则">5.6 可见性检查规则</h2>
<p>可见性检查规则是一组规则，用于确定一条元组是否对一个事务可见，可见性检查规则会用到元组的<code>t_xmin</code>和<code>t_xmax</code>，提交日志clog，以及已获取的事务快照。这些规则太复杂，无法详细解释，故本书只列出了理解后续内容所需的最小规则子集。在下文中省略了与子事务相关的规则，并忽略了关于<code>t_ctid</code>的讨论，比如我们不会考虑在同一个事务中对一条元组多次重复更新的情况。</p>
<p>所选规则有十条，可以分类为三种情况。</p>
<h3 id="561--t_xmin的状态为aborted">5.6.1  <code>t_xmin</code>的状态为<code>ABORTED</code></h3>
<p><code>t_xmin</code>状态为<code>ABORTED</code>的元组始终不可见（规则1），因为插入此元组的事务已中止。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>			/* 创建元组的事务已经中止 */
</span></span><span style="display:flex;"><span>Rule 1:     IF t_xmin status is ABORTED THEN
</span></span><span style="display:flex;"><span>                RETURN Invisible
</span></span><span style="display:flex;"><span>            END IF
</span></span></code></pre></div><p>该规则明确表示为以下数学表达式。</p>
<ul>
<li><strong>规则1</strong>： <code>If Status(t_xmin) = ABORTED ⇒ Invisible</code></li>
</ul>
<h3 id="562--t_xmin的状态为in_progress">5.6.2  <code>t_xmin</code>的状态为<code>IN_PROGRESS</code></h3>
<p><code>t_xmin</code>状态为<code>IN_PROGRESS</code>的元组基本上是不可见的（规则3和4），但在一个条件下除外。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>            /* 创建元组的事务正在进行中 */
</span></span><span style="display:flex;"><span>            IF t_xmin status is IN_PROGRESS THEN
</span></span><span style="display:flex;"><span>                /* 当前事务自己创建了本元组 */
</span></span><span style="display:flex;"><span>            	IF t_xmin = current_txid THEN
</span></span><span style="display:flex;"><span>                    /* 该元组没有被标记删除，则应当看见本事务自己创建的元组 */
</span></span><span style="display:flex;"><span>Rule 2:             IF t_xmax = INVALID THEN 
</span></span><span style="display:flex;"><span>                        RETURN Visible /* 例外，被自己创建的未删元组可见 */
</span></span><span style="display:flex;"><span>Rule 3:             ELSE  
</span></span><span style="display:flex;"><span>                    /* 这条元组被当前事务自己创建后又删除掉了，故不可见 */
</span></span><span style="display:flex;"><span>                        RETURN Invisible
</span></span><span style="display:flex;"><span>                    END IF
</span></span><span style="display:flex;"><span>Rule 4:         ELSE   /* t_xmin ≠ current_txid */
</span></span><span style="display:flex;"><span>                    /* 其他运行中的事务创建了本元组 */
</span></span><span style="display:flex;"><span>		            RETURN Invisible
</span></span><span style="display:flex;"><span>                END IF
</span></span><span style="display:flex;"><span>            END IF
</span></span></code></pre></div><p>如果该元组被另一个进行中的事务插入（<code>t_xmin</code>对应事务状态为<code>IN_PROGRESS</code>），则该元组显然是不可见的（规则4）。</p>
<p>如果<code>t_xmin</code>等于当前事务的<code>txid</code>（即，是当前事务插入了该元组），且<code>t_xmax ≠ 0</code>，则该元组是不可见的，因为它已被当前事务更新或删除（规则3）。</p>
<p>例外是，当前事务插入此元组且<code>t_xmax</code>无效（<code>t_xmax = 0</code>）的情况。 在这种情况下，此元组对当前事务中可见（规则2）。</p>
<ul>
<li><strong>规则2</strong>： <code>If Status(t_xmin) = IN_PROGRESS ∧ t_xmin = current_txid ∧ t_xmax = INVAILD ⇒ Visible</code></li>
<li><strong>规则3</strong>：<code>If Status(t_xmin) = IN_PROGRESS ∧ t_xmin = current_txid ∧ t_xmax ≠ INVAILD ⇒ Invisible</code></li>
<li><strong>规则4</strong>： <code>If Status(t_xmin) = IN_PROGRESS ∧ t_xmin ≠ current_txid ⇒ Invisible</code></li>
</ul>
<h3 id="563--t_xmin的状态为committed">5.6.3  <code>t_xmin</code>的状态为<code>COMMITTED</code></h3>
<p><code>t_xmin</code>状态为<code>COMMITTED</code>的元组是可见的（规则 6，8和9），但在三个条件下除外。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>            /* 创建元组的事务已经提交 */
</span></span><span style="display:flex;"><span>            IF t_xmin status is COMMITTED THEN
</span></span><span style="display:flex;"><span>            	/* 创建元组的事务在获取的事务快照中处于活跃状态，创建无效，不可见 */
</span></span><span style="display:flex;"><span>Rule 5:         IF t_xmin is active in the obtained transaction snapshot THEN
</span></span><span style="display:flex;"><span>                      RETURN Invisible
</span></span><span style="display:flex;"><span>                /* 元组被删除，但删除元组的事务中止了，删除无效，可见 */
</span></span><span style="display:flex;"><span>                /* 创建元组的事务已提交，且非活跃，元组也没有被标记为删除，则可见 */
</span></span><span style="display:flex;"><span>Rule 6:         ELSE IF t_xmax = INVALID OR status of t_xmax is ABORTED THEN
</span></span><span style="display:flex;"><span>                      RETURN Visible
</span></span><span style="display:flex;"><span>                /* 元组被删除，但删除元组的事务正在进行中，分情况 */
</span></span><span style="display:flex;"><span>            	ELSE IF t_xmax status is IN_PROGRESS THEN
</span></span><span style="display:flex;"><span>                    /* 如果恰好是被本事务自己删除的，删除有效，不可见 */
</span></span><span style="display:flex;"><span>Rule 7:             IF t_xmax =  current_txid THEN
</span></span><span style="display:flex;"><span>                        RETURN Invisible
</span></span><span style="display:flex;"><span>                    /* 如果是被其他事务删除的，删除无效，可见 */
</span></span><span style="display:flex;"><span>Rule 8:             ELSE  /* t_xmax ≠ current_txid */
</span></span><span style="display:flex;"><span>                        RETURN Visible
</span></span><span style="display:flex;"><span>                    END IF
</span></span><span style="display:flex;"><span>                /* 元组被删除，且删除元组的事务已经提交 */
</span></span><span style="display:flex;"><span>            	ELSE IF t_xmax status is COMMITTED THEN
</span></span><span style="display:flex;"><span>                    /* 删除元组的事务在获取的事务快照中处于活跃状态，删除无效，不可见 */
</span></span><span style="display:flex;"><span>Rule 9:             IF t_xmax is active in the obtained transaction snapshot THEN
</span></span><span style="display:flex;"><span>                        RETURN Visible
</span></span><span style="display:flex;"><span>Rule 10:            ELSE /* 删除有效，可见 */
</span></span><span style="display:flex;"><span>                        RETURN Invisible
</span></span><span style="display:flex;"><span>                    END IF
</span></span><span style="display:flex;"><span>            	 END IF
</span></span><span style="display:flex;"><span>            END IF
</span></span></code></pre></div><p>规则6是显而易见的，因为<code>t_xmax</code>为<code>INVALID</code>，或者<code>t_xmax</code>对应事务已经中止，相应元组可见。三个例外条件及规则8与规则9的描述如下。</p>
<p>第一个例外情况是<code>t_xmin</code>在获取的事务快照中处于<strong>活跃</strong>状态（规则5）。在这种情况下，这条元组是不可见的，因为<code>t_xmin</code>应该被视为正在进行中（取快照时创建该元组的事务尚未提交，因此对于<code>REPEATABLE READ</code>以及更高隔离等级而言，即使在判断时创建该元组的事务已经提交，但其结果仍然不可见）。</p>
<p>第二个例外情况是<code>t_xmax</code>是当前的<code>txid</code>（规则7）。这种情况与规则3类似，此元组是不可见的，因为它已经被此事务本身更新或删除。</p>
<p>相反，如果<code>t_xmax</code>的状态是<code>IN_PROGRESS</code>并且<code>t_xmax</code>不是当前的<code>txid</code>（规则8），则元组是可见的，因为它尚未被删除（因为删除该元组的事务尚未提交）。</p>
<p>第三个例外情况是<code>t_xmax</code>的状态为<code>COMMITTED</code>，且<code>t_xmax</code>在获取的事务快照中是<strong>非活跃</strong>的（规则10）。在这种情况下该元组不可见，因为它已被另一个事务更新或删除。</p>
<p>相反，如果<code>t_xmax</code>的状态为<code>COMMITTED</code>，但<code>t_xmax</code>在获取的事务快照中处于活跃状态（规则9），则元组可见，因为<code>t_xmax</code>对应的事务应被视为正在进行中，删除尚未提交生效。</p>
<ul>
<li><strong>规则5</strong>：<code>If Status(t_xmin) = COMMITTED ∧ Snapshot(t_xmin) = active ⇒ Invisible</code></li>
<li><strong>规则6</strong>：<code>If Status(t_xmin) = COMMITTED ∧ (t_xmax = INVALID ∨ Status(t_xmax) = ABORTED) ⇒ Visible</code></li>
<li><strong>规则7</strong>： <code>If Status(t_xmin) = COMMITTED ∧ Status(t_xmax) = IN_PROGRESS ∧ t_xmax = current_txid ⇒ Invisible</code></li>
<li><strong>规则8</strong>：<code>If Status(t_xmin) = COMMITTED ∧ Status(t_xmax) = IN_PROGRESS ∧ t_xmax ≠ current_txid ⇒ Visible</code></li>
<li><strong>规则9</strong>： <code>If Status(t_xmin) = COMMITTED ∧ Status(t_xmax) = COMMITTED ∧ Snapshot(t_xmax) = active ⇒ Visible</code></li>
<li><strong>规则10</strong>：<code>If Status(t_xmin) = COMMITTED ∧ Status(t_xmax) = COMMITTED ∧ Snapshot(t_xmax) ≠ active ⇒ Invisible</code></li>
</ul>
<h2 id="57-可见性检查">5.7 可见性检查</h2>
<p>本节描述了PostgreSQL执行可见性检查的流程。<strong>可见性检查（Visiblity Check）</strong>，即如何为给定事务挑选堆元组的恰当版本。本节还介绍了PostgreSQL如何防止ANSI SQL-92标准中定义的异常：脏读，可重读和幻读。</p>
<h3 id="571-可见性检查">5.7.1 可见性检查</h3>
<p>图5.10中的场景描述了可见性检查的过程。</p>
<p><strong>图5.10 可见性检查场景一例</strong></p>
<p><img src="/img/blog/kernel/fig-5-10.png"></p>
<p>在图5.10所示的场景中，SQL命令按以下时序执行。</p>
<ul>
<li>T1：启动事务<code>(txid=200)</code></li>
<li>T2：启动事务<code>(txid=201)</code></li>
<li>T3：执行<code>txid=200</code>和201的事务的<code>SELECT</code>命令</li>
<li>T4：执行<code>txid=200</code>的事务的<code>UPDATE</code>命令</li>
<li>T5：执行<code>txid=200</code>和201的事务的<code>SELECT</code>命令</li>
<li>T6：提交<code>txid=200</code>的事务</li>
<li>T7：执行<code>txid=201</code>的事务的<code>SELECT</code>命令</li>
</ul>
<p>为了简化描述，假设这里只有两个事务，即<code>txid=200</code>和<code>201</code>的事务。<code>txid=200</code>的事务的隔离级别是<code>READ COMMITTED</code>，而<code>txid=201</code>的事务的隔离级别是<code>READ COMMITTED</code>或<code>REPEATABLE READ</code>。</p>
<p>我们将研究<code>SELECT</code>命令是如何为每条元组执行可见性检查的。</p>
<p><strong>T3的<code>SELECT</code>命令：</strong></p>
<p>在T3时间点，表<code>tbl</code>中只有一条元组<code>Tuple_1</code>，按照规则6，这条元组是可见的，因此两个事务中的<code>SELECT</code>命令都返回<code>&quot;Jekyll&quot;</code>。</p>
<ul>
<li>
<p><code>Rule 6(Tuple_1) ⇒ Status(t_xmin:199) = COMMITTED ∧ t_xmax = INVALID ⇒ Visible</code></p>
<p>创建元组<code>Tuple_1</code>的事务199已经提交，且该元组并未被标记删除，因此根据规则6，对当前事务可见。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- txid 200
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">  
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Jekyll</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- txid 201
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">  
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Jekyll</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>T5的<code>SELECT</code>命令</strong></p>
<p>首先来看一下由<code>txid=200</code>的事务所执行的<code>SELECT</code>命令。根据规则7，<code>Tuple_1</code>不可见，根据规则2，<code>Tuple_2</code>可见；因此该<code>SELECT</code>命令返回<code>&quot;Hyde&quot;</code>。</p>
<ul>
<li>
<p><code>Rule 7(Tuple_1): Status(t_xmin:199) = COMMITTED ∧ Status(t_xmax:200) = IN_PROGRESS ∧ t_xmax:200 = current_txid:200 ⇒ Invisible</code></p>
<p>创建元组<code>Tuple_1</code>的事务199已经提交，且该元组被当前事务标记删除，根据规则7，<code>Tuple_1</code>对当前事务不可见。</p>
</li>
<li>
<p><code>Rule 2(Tuple_2): Status(t_xmin:200) = IN_PROGRESS ∧ t_xmin:200 = current_txid:200 ∧ t_xmax = INVAILD ⇒ Visible</code></p>
<p>创建元组<code>Tuple_2</code>的事务200正在进行，而且就是当前事务自己，根据规则2，<code>Tuple_2</code>对当前事务可见。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- txid 200
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Hyde</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>另一方面，在由<code>txid=201</code>的事务所执行的<code>SELECT</code>命令中，<code>Tuple_1</code>基于规则8确定可见，而<code>Tuple_2</code>基于规则4不可见；因此该<code>SELECT</code>命令返回<code>&quot;Jekyll&quot;</code>。</p>
<ul>
<li>
<p><code>Rule 8(Tuple_1): Status(t_xmin:199) = COMMITTED ∧ Status(t_xmax:200) = IN_PROGRESS ∧ t_xmax:200 ≠ current_txid:201 ⇒ Visible</code></p>
<p>元组<code>Tuple_1</code>由已提交事务199创建，由活跃事务200标记删除，但删除效果对当前事务201不可见。因此根据规则8，<code>Tuple_1</code>可见。</p>
</li>
<li>
<p><code>Rule 4(Tuple_2): Status(t_xmin:200) = IN_PROGRESS ∧ t_xmin:200 ≠ current_txid:201 ⇒ Invisible</code></p>
<p>元组<code>Tuple_2</code>由活跃事务200创建，且不是由当前事务自己创建的，故根据规则4，<code>Tuple_2</code>不可见。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- txid 201
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">  
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Jekyll</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>如果更新的元组在本事务提交之前被其他事务看见，这种现象被称为<strong>脏读（Dirty Reads）</strong>，也称为<strong>写读冲突（wr-conflicts）</strong>。 但如上所示，PostgreSQL中任何隔离级别都不会出现脏读。</p>
<p><strong>T7的<code>SELECT</code>命令</strong></p>
<p>在下文中，描述了T7的<code>SELECT</code>命令在两个隔离级别中的行为。</p>
<p>首先来研究<code>txid=201</code>的事务处于<code>READ COMMITTED</code>隔离级别时的情况。 在这种情况下，<code>txid=200</code>的事务被视为已提交，因为在这个时间点获取的事务快照是<code>201:201:</code>。因此<code>Tuple_1</code>根据规则10不可见，<code>Tuple_2</code>根据规则6可见，<code>SELECT</code>命令返回<code>&quot;Hyde&quot;</code>。</p>
<ul>
<li>
<p><code>Rule 10(Tuple_1): Status(t_xmin:199) = COMMITTED ∧ Status(t_xmax:200) = COMMITTED ∧ Snapshot(t_xmax:200) ≠ active ⇒ Invisible</code></p>
<p>元组<code>Tuple_1</code>由已提交事务199创建，由非活跃的已提交事务200标记删除，<code>Tuple_1</code>按照规则10不可见。</p>
</li>
<li>
<p><code>Rule 6(Tuple_2): Status(t_xmin:200) = COMMITTED ∧ t_xmax = INVALID ⇒ Visible</code></p>
<p>元组<code>Tuple_2</code>由已提交事务200创建，且未被标记为删除，故<code>Tuple_2</code>按照规则6可见。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- txid 201 (READ COMMITTED)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Hyde</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这里需要注意，事务201中的<code>SELECT</code>命令，在<code>txid=200</code>的事务提交前后中时的执行结果是不一样的，这种现象通常被称作<strong>不可重复读（Non-Repeatable Read）</strong>。</p>
<p>相反的是，当<code>txid=201</code>的事务处于<code>REPEATABLE READ</code>级别时，即使在T7时刻<code>txid=200</code>的事务实际上已经提交，它也必须被视作仍在进行，因而获取到的事务快照是<code>200:200:</code>。 根据规则9，<code>Tuple_1</code>是可见的，根据规则5，<code>Tuple_2</code>不可见，所以最后<code>SELECT</code>命令会返回<code>&quot;Jekyll&quot;</code>。 请注意在<code>REPEATABLE READ</code>（和<code>SERIALIZABLE</code>）级别中不会发生不可重复读。</p>
<ul>
<li>
<p><code>Rule9(Tuple_1): Status(t_xmin:199) = COMMITTED ∧ Status(t_xmax:200) = COMMITTED ∧ Snapshot(t_xmax:200) = active ⇒ Visible</code></p>
<p>元组<code>Tuple_1</code>由已提交事务199创建，由已提交事务200标记删除，但因为事务200位于当前事物的活跃事务快照中（也就是在当前事物201开始执行并获取事务级快照时，事物200还未提交），因此删除对当前事务尚未生效，根据规则9，<code>Tuple_1</code>可见。</p>
<p><code>Tuple_1</code>按照规则10不可见。</p>
</li>
<li>
<p><code>Rule5(Tuple_2): Status(t_xmin:200) = COMMITTED ∧ Snapshot(t_xmin:200) = active ⇒ Invisible</code></p>
<p>元组<code>Tuple_2</code>由已提交事务200创建，但该事务在本事务快照中属于活跃事务（即在本事务开始前还未提交），因此事务200的变更对本事务尚不可见，按照规则5，<code>Tuple_2</code>不可见。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- txid 201 (REPEATABLE READ)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">  
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Jekyll</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><blockquote>
<h4 id="提示位hint-bits">提示位（Hint Bits）</h4>
<p>PostgreSQL在内部提供了三个函数<code>TransactionIdIsInProgress</code>，<code>TransactionIdDidCommit</code>和<code>TransactionIdDidAbort</code>，用于获取事务的状态。这些函数被设计为尽可能减少对clog的频繁访问。 尽管如此，如果在检查每条元组时都执行这些函数，那这里很可能会成为一个性能瓶颈。</p>
<p>为了解决这个问题，PostgreSQL使用了<strong>提示位（hint bits）</strong>，如下所示。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">HEAP_XMIN_COMMITTED</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000">x0100</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">/* 元组xmin对应事务已提交 */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">HEAP_XMIN_INVALID</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000">x0200</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">/* 元组xmin对应事务无效/中止 */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">HEAP_XMAX_COMMITTED</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000">x0400</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">/* 元组xmax对应事务已提交 */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">HEAP_XMAX_INVALID</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000">x0800</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">/* 元组xmax对应事务无效/中止 */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在读取或写入元组时，PostgreSQL会择机将提示位设置到元组的<code>t_informask</code>字段中。 举个例子，假设PostgreSQL检查了元组的<code>t_xmin</code>对应事务的状态，结果为<code>COMMITTED</code>。 在这种情况下，PostgreSQL会在元组的<code>t_infomask</code>中置位一个<code>HEAP_XMIN_COMMITTED</code>标记，表示创建这条元组的事务已经提交了。 如果已经设置了提示位，则不再需要调用<code>TransactionIdDidCommit</code>和<code>TransactionIdDidAbort</code>来获取事务状态了。 因此PostgreSQL能高效地检查每个元组<code>t_xmin</code>和<code>t_xmax</code>对应事务的状态。</p>
</blockquote>
<h3 id="572-postgresql可重复读等级中的幻读">5.7.2 PostgreSQL可重复读等级中的幻读</h3>
<p>ANSI SQL-92标准中定义的<code>REPEATABLE READ</code>隔离等级允许出现<strong>幻读（Phantom Reads）</strong>， 但PostgreSQL实现的<code>REPEATABLE READ</code>隔离等级不允许发生幻读。 在原则上，快照隔离中不允许出现幻读。</p>
<p>假设两个事务<code>Tx_A</code>和<code>Tx_B</code>同时运行。 它们的隔离级别分别为<code>READ COMMITTED</code>和<code>REPEATABLE READ</code>，它们的<code>txid</code>分别为100和101。两个事务一前一后接连开始，首先<code>Tx_A</code>插入一条元组，并提交。 插入的元组的<code>t_xmin</code>为100。接着，<code>Tx_B</code>执行<code>SELECT</code>命令；但根据规则5，<code>Tx_A</code>插入的元组对<code>Tx_B</code>是不可见的。因此不会发生幻读。</p>
<ul>
<li>
<p><code>Rule5(new tuple): Status(t_xmin:100) = COMMITTED ∧ Snapshot(t_xmin:100) = active ⇒ Invisible</code></p>
<p>新元组由已提交的事务<code>Tx_A</code>创建，但<code>Tx_A</code>在<code>Tx_B</code>的事务快照中处于活跃状态，因此根据规则5，新元组对<code>Tx_B</code>不可见。</p>
<table>
<thead>
<tr>
<th><code>Tx_A: txid = 100</code></th>
<th><code>Tx_B: txid = 101</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>START TRANSACTION ISOLATION LEVEL READ COMMITTED;</code></td>
<td><code>START TRANSACTION ISOLATION LEVEL REPEATABLE READ;</code></td>
</tr>
<tr>
<td><code>INSERT tbl(id, data) </code></td>
<td></td>
</tr>
<tr>
<td><code>COMMIT;</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>SELECT * FROM tbl WHERE id=1;</code></td>
</tr>
<tr>
<td></td>
<td><code>(0 rows)</code></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="58-防止丢失更新">5.8 防止丢失更新</h2>
</li>
</ul>
<p><strong>丢失更新（Lost Update）</strong>，又被称作<strong>写-写冲突（ww-conflict）</strong>，是事务并发更新同一行时所发生的异常，<code>REPEATABLE READ</code>和<code>SERIALIZABLE</code>隔离等级必须阻止该异常的出现。 本节将会介绍PostgreSQL是如何防止丢失更新的，并举一些例子来说明。</p>
<h3 id="581-并发update命令的行为">5.8.1 并发<code>UPDATE</code>命令的行为</h3>
<p>执行<code>UPDATE</code>命令时，内部实际上调用了<code>ExecUpdate</code>函数。 <code>ExecUpdate</code>的伪代码如下所示：</p>
<blockquote>
<h5 id="伪代码execupdate">伪代码：<code>ExecUpdate</code></h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>(1) FOR row in 本UPDATE命令待更新的所有行集
</span></span><span style="display:flex;"><span>(2)     WHILE true
</span></span><span style="display:flex;"><span>            /* 第一部分 */
</span></span><span style="display:flex;"><span>(3)         IF 目标行 正在 被更新 THEN
</span></span><span style="display:flex;"><span>(4)	            等待 更新目标行的事务 结束(提交或中止)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(5)	            IF (更新目标行的事务已提交)
</span></span><span style="display:flex;"><span>   	                AND (当前事务隔离级别是 可重复读或可串行化) THEN
</span></span><span style="display:flex;"><span>(6)	                    中止当前事务  /* 以先更新者为准 */
</span></span><span style="display:flex;"><span>	            ELSE 
</span></span><span style="display:flex;"><span>(7)                     跳转步骤（2）
</span></span><span style="display:flex;"><span>	            END IF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            /* 第二部分 */
</span></span><span style="display:flex;"><span>(8)         ELSE IF 目标行 已经 被另一个并发事务所更新 THEN
</span></span><span style="display:flex;"><span>(9)	            IF (当前事务的隔离级别是 读已提交 ) THEN
</span></span><span style="display:flex;"><span>(10)	            更新目标行
</span></span><span style="display:flex;"><span>	            ELSE
</span></span><span style="display:flex;"><span>(11)	            中止当前事务  /* 先更新者为准 */
</span></span><span style="display:flex;"><span>                END IF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            /* 第三部分 */
</span></span><span style="display:flex;"><span>            /* 目标行没有被修改过，或者被一个 已经结束 的事务所更新 */
</span></span><span style="display:flex;"><span>            ELSE  
</span></span><span style="display:flex;"><span>(12)	            更新目标行
</span></span><span style="display:flex;"><span>            END IF
</span></span><span style="display:flex;"><span>        END WHILE 
</span></span><span style="display:flex;"><span>    END FOR 
</span></span></code></pre></div><ol>
<li>获取被本<code>UPDATE</code>命令更新的每一行，并对每一行依次执行下列操作。</li>
<li>重复以下过程，直到目标行更新完成，或本事务中止。</li>
<li>如果目标行<strong>正在</strong>被更新则进入步骤（4），否则进入步骤（8）。</li>
<li>等待正在更新目标行的事务结束，因为PostgreSQL在SI中使用了**以先更新者为准（first-updater-win）**的方案。</li>
<li>如果更新目标行的事务已经提交，且当前事务的隔离等级为可重复读或可串行化则进入步骤（6），否则进入步骤（7）。</li>
<li>中止本事务，以防止丢失更新。（因为另一个事务已经对目标行进行了更新并提交）</li>
<li>跳转回步骤（2），并对目标行进行新一轮的更新尝试。</li>
<li>如果目标行<strong>已被</strong>另一个<strong>并发</strong>事务所更新则进入步骤（9），否则进入步骤（12）。</li>
<li>如果当前事务的隔离级别为<strong>读已提交</strong>则进入步骤（10），否则进入步骤（11）。</li>
<li>更新目标行，并回到步骤（1），处理下一条目标行。</li>
<li>中止当前事务，以防止丢失更新。</li>
<li>更新目标行，并回到步骤（1），因为目标行尚未被修改过，或者虽然已经被更新，但更新它的事务已经结束。已终止的事务更新，即存在写写冲突。</li>
</ol>
</blockquote>
<p>此函数依次为每个待更新的目标行执行更新操作。 它有一个外层循环来更新每一行，而内部while循环则包含了三个分支，分支条件如图5.11所示。</p>
<p><strong>图5.11 <code>ExecUpdate</code>内部的三个部分</strong></p>
<p><img alt="Fig. 5.11. Three internal blocks in ExecUpdate." src="/img/blog/kernel/fig-5-11.png"></p>
<ol>
<li>
<p>目标行正在被更新，如图5.11[1]所示</p>
<p>“正在被更新”意味着该行正在被另一个事务同时更新，且另一个事务尚未结束。在这种情况下，当前事务必须等待更新目标行的事务结束，因为PostgreSQL的SI实现采用**以先更新者为准（first-updater-win）**的方案。例如，假设事务<code>Tx_A</code>和<code>Tx_B</code>同时运行，且<code>Tx_B</code>尝试更新某一行；但<code>Tx_A</code>已更新了这一行，且仍在进行中。在这种情况下<code>Tx_B</code>会等待<code>Tx_A</code>结束。</p>
<p>在更新目标行的事务提交后，当前事务的更新操作将完成等待继续进行。如果当前事务处于<code>READ COMMITTED</code>隔离等级，则会更新目标行；而若处于<code>REPEATABLE READ</code>或<code>SERIALIZABLE</code>隔离等级时，当前事务则会立即中止，以防止丢失更新。</p>
</li>
<li>
<p>目标行<strong>已经</strong>被另一个并发事务所更新，如图5.11[2]所示</p>
<p>当前事务尝试更新目标元组，但另一个并发事务已经更新了目标行并提交。在这种情况下，如果当前事务处于<code>READ COMMITTED</code>级别，则会更新目标行；否则会立即中止以防止丢失更新。</p>
</li>
<li>
<p>没有冲突，如图5.11[3]所示</p>
<p>当没有冲突时，当前事务可以直接更新目标行。</p>
</li>
</ol>
<blockquote>
<h5 id="以先更新者为准--以先提交者为准">以先更新者为准 / 以先提交者为准</h5>
<p>PostgreSQL基于SI的并发控制机制采用**以先更新者为准（first-updater-win）<strong>方案。 相反如下一节所述，PostgreSQL的SSI实现使用</strong>以先提交者为准（first-commiter-win）**方案。</p>
</blockquote>
<h3 id="582-例子">5.8.2 例子</h3>
<p>以下是三个例子。 第一个和第二个例子展示了目标行<strong>正在</strong>被更新时的行为，第三个例子展示了目标行已经被更新的行为。</p>
<h4 id="例1">例1</h4>
<p>事务<code>Tx_A</code>和<code>Tx_B</code>更新同一张表中的同一行，它们的隔离等级均为<code>READ COMMITTED</code>。</p>
<table>
<thead>
<tr>
<th><code>Tx_A</code></th>
<th><code>Tx_B</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>START TRANSACTION ISOLATION LEVEL READ COMMITTED;</code></td>
<td></td>
</tr>
<tr>
<td><em><code>START TRANSACTION</code></em></td>
<td><code>START TRANSACTION ISOLATION LEVEL READ COMMITTED;</code></td>
</tr>
<tr>
<td></td>
<td><em><code>START TRANSACTION</code></em></td>
</tr>
<tr>
<td><code>UPDATE tbl SET name = 'Hyde';</code></td>
<td></td>
</tr>
<tr>
<td><em><code>UPDATE 1</code></em></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>UPDATE tbl SET name = 'Utterson';</code></td>
</tr>
<tr>
<td></td>
<td>↓ <em>&ndash; 本事务进入阻塞状态，等待<code>Tx_A</code>完成</em></td>
</tr>
<tr>
<td><code>COMMIT;</code></td>
<td>↓ <em>&ndash; <code>Tx_A</code>提交，阻塞解除</em></td>
</tr>
<tr>
<td></td>
<td><em><code>UPDATE 1</code></em></td>
</tr>
</tbody>
</table>
<p><code>Tx_B</code>的执行过程如下：</p>
<ol>
<li>在执行<code>UPDATE</code>命令之后，<code>Tx_B</code>应该等待<code>Tx_A</code>结束，因为目标元组正在被<code>Tx_A</code>更新（<code>ExecUpdate</code>步骤4）</li>
<li>在<code>Tx_A</code>提交后，<code>Tx_B</code>尝试更新目标行（<code>ExecUpdate</code>步骤7）</li>
<li>在<code>ExecUpdate</code>内循环第二轮中，目标行被<code>Tx_B</code>更新（<code>ExecUpdate</code>步骤2,8,9,10）。</li>
</ol>
<h4 id="例2">例2</h4>
<p><code>Tx_A</code>和<code>Tx_B</code>更新同一张表中的同一行，它们的隔离等级分别为读已提交和可重复读。</p>
<table>
<thead>
<tr>
<th><code>Tx_A</code></th>
<th><code>Tx_B</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>START TRANSACTION ISOLATION LEVEL READ COMMITTED;</code></td>
<td></td>
</tr>
<tr>
<td><em><code>START TRANSACTION</code></em></td>
<td><code>START TRANSACTION ISOLATION LEVEL REPEATABLE READ;</code></td>
</tr>
<tr>
<td></td>
<td><em><code>START TRANSACTION</code></em></td>
</tr>
<tr>
<td><code>UPDATE tbl SET name = 'Hyde';</code></td>
<td></td>
</tr>
<tr>
<td><em><code>UPDATE 1</code></em></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>UPDATE tbl SET name = 'Utterson';</code></td>
</tr>
<tr>
<td></td>
<td>↓ <em>&ndash; 本事务进入阻塞状态，等待<code>Tx_A</code>完成</em></td>
</tr>
<tr>
<td><code>COMMIT;</code></td>
<td>↓ <em>&ndash; <code>Tx_A</code>提交，阻塞解除</em></td>
</tr>
<tr>
<td></td>
<td><em><code>ERROR:couldn't serialize access due to concurrent update</code></em></td>
</tr>
</tbody>
</table>
<p><code>Tx_B</code>的执行过程如下：</p>
<ol>
<li><code>Tx_B</code>在执行<code>UPDATE</code>命令后阻塞，等待<code>Tx_A</code>终止（<code>ExecUpdate</code>步骤4）。</li>
<li>当<code>Tx_A</code>提交后，<code>Tx_B</code>会中止以解决冲突。因为目标行已经被更新，且当前事务<code>Tx_B</code>的隔离级别为可重复读（<code>ExecUpdate</code>步骤5，6）。</li>
</ol>
<h4 id="例3">例3</h4>
<p><code>Tx_B</code>（可重复读）尝试更新已经被<code>Tx_A</code>更新的目标行，且<code>Tx_A</code>已经提交。 在这种情况下，<code>Tx_B</code>会中止（<code>ExecUpdate</code>中的步骤2,8,9,11）。</p>
<table>
<thead>
<tr>
<th><code>Tx_A</code></th>
<th><code>Tx_B</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>START TRANSACTION ISOLATION LEVEL READ COMMITTED;</code></td>
<td></td>
</tr>
<tr>
<td><em><code>START TRANSACTION</code></em></td>
<td><code>START TRANSACTION ISOLATION LEVEL REPEATABLE READ;</code></td>
</tr>
<tr>
<td></td>
<td><em><code>START TRANSACTION</code></em></td>
</tr>
<tr>
<td><code>UPDATE tbl SET name = 'Hyde';</code></td>
<td></td>
</tr>
<tr>
<td><em><code>UPDATE 1</code></em></td>
<td></td>
</tr>
<tr>
<td><code>COMMIT;</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>UPDATE tbl SET name = 'Utterson';</code></td>
</tr>
<tr>
<td></td>
<td><em><code>ERROR:couldn't serialize access due to concurrent update</code></em></td>
</tr>
</tbody>
</table>
<h2 id="59-可串行化快照隔离">5.9 可串行化快照隔离</h2>
<p>从版本9.1开始，可串行化快照隔离（SSI）已经嵌入到快照隔离（SI）中，用以实现真正的可串行化隔离等级。SSI解释起来过于复杂，故本书仅解释其概要，详细信息请参阅文献[2]。</p>
<p>下文使用了以下技术术语而未加定义。 如果读者不熟悉这些术语，请参阅[1,3]。</p>
<ul>
<li><strong>前趋图（precedence graph）</strong>，亦称作<strong>依赖图（dependency graph）<strong>或</strong>串行化图（serialization graph）</strong></li>
<li><strong>串行化异常（serialization anomalies）</strong>（例如，<strong>写偏差（Write-Skew）</strong>）</li>
</ul>
<h3 id="591-ssi实现的基本策略">5.9.1 SSI实现的基本策略</h3>
<p>如果前趋图中存在由某些冲突构成的环，则会出现串行化异常。 这里使用一种最简单的异常来解释，即<strong>写偏差（Write-Skew）</strong>。</p>
<p>图5.12(1)展示了一种调度方式。 这里<code>Transaction_A</code>读取了<code>Tuple_B</code>，<code>Transaction_B</code>读取了<code>Tuple_A</code>。 然后<code>Transaction_A</code>写<code>Tuple_A</code>，<code>Transaction_B</code>写<code>Tuple_B</code>。 在这种情况下存在两个<strong>读-写冲突（rw-conflict）</strong>，它们在该调度的前趋图中构成了一个环，如图5.12(2)所示。 故该调度存在串行化异常，即写偏差。</p>
<p><strong>图5.12 存在写偏差的调度及其前趋图</strong></p>
<p><img alt="Fig. 5.11. Three internal blocks in ExecUpdate." src="/img/blog/kernel/fig-5-12.png"></p>
<p>从概念上讲，存在三种类型的冲突：<strong>写-读冲突（wr-conflicts）</strong>（脏读），<strong>写-写冲突（ww-conflicts）</strong>（丢失更新），以及<strong>读写冲突（rw-conflicts）</strong>。 但是这里无需考虑写-读冲突与写-写冲突，因为如前所述，PostgreSQL可以防止此类冲突。 因此PostgreSQL中的SSI实现只需要考虑读-写冲突。</p>
<p>PostgreSQL在SSI实现中采用以下策略：</p>
<ol>
<li>使用SIREAD锁记录事务访问的所有对象（元组，页面，关系）。</li>
<li>当写入任何堆元组/索引元组时，使用SIREAD锁检测读-写冲突。</li>
<li>如果从读-写冲突中检测出串行化异常，则中止事务。</li>
</ol>
<h3 id="592-postgresql的ssi实现">5.9.2 PostgreSQL的SSI实现</h3>
<p>为了实现上述策略，PostgreSQL实现了很多数据结构与函数。 但这里我们只会使用两种数据结构：SIREAD锁与读-写冲突来描述SSI机制。它们都储存在共享内存中。</p>
<blockquote>
<p>为简单起见，本文省略了一些重要的数据结构，例如<code>SERIALIZABLEXACT</code>。 因此对<code>CheckTargetForConflictOut</code>，<code>CheckTargetForConflictIn</code>和<code>PreCommit_CheckForSerializationFailure</code>等函数的解释也极为简化。比如本文虽然指出哪些函数能检测到冲突；但并没有详细解释如何检测冲突。 如果读者想了解详细信息，请参阅源代码：<a href="https://github.com/postgres/postgres/blob/master/src/backend/storage/lmgr/predicate.c">predicate.c</a>。</p>
</blockquote>
<h4 id="siread锁">SIREAD锁</h4>
<p>SIREAD锁，在内部又被称为<strong>谓词锁（predicate lock）</strong>，是一个由对象与（虚拟）事务标识构成的二元组，存储着哪个事务访问了哪个对象的相关信息。注意这里省略了对虚拟事务标识的描述，使用<code>txid</code>而非虚拟<code>txid</code>能大幅简化说明。</p>
<p>在<code>SERIALIZABLE</code>模式下只要执行DML命令，就会通过<code>CheckTargetForConflictsOut</code>函数创建出SIREAD锁。举个例子，如果<code>txid=100</code>的事务读取给定表的<code>Tuple_1</code>，则会创建一个SIREAD锁<code>{Tuple_1,{100}}</code>。如果是其他事务，例如<code>txid=101</code>读取了<code>Tuple_1</code>，则SIREAD锁会更新为<code>{Tuple_1,{100,101}}</code>。请注意，读取索引页时也会创建SIREAD锁，因为在使用了第7.2节中将描述的**仅索引扫描（Index-Only Scan）**时，数据库只会读取索引页而不读取表页。</p>
<p>SIREAD锁有三个级别：元组，页面，以及关系。如果单个页面内所有元组的SIREAD锁都被创建，则它们会聚合为该页上的单个SIREAD锁，原有相关元组上的SIREAD锁都会被释放（删除），以减少内存空间占用。对读取的页面也是同理。</p>
<p>当为索引创建SIREAD锁时，一开始会创建页级别的SIREAD锁。当使用顺序扫描时，无论是否存在索引，是否存在<code>WHERE</code>子句，一开始都会创建关系级别的SIREAD锁。请注意在某些情况下，这种实现可能会导致串行化异常的误报（<strong>假阳性（false-positive）</strong>），细节将在第5.9.4节中描述。</p>
<h4 id="读-写冲突">读-写冲突</h4>
<p>读-写冲突是一个三元组，由SIREAD锁，以及两个分别读写该SIREAD锁的事务<code>txid</code>构成。</p>
<p>当在可串行化模式下执行<code>INSERT</code>，<code>UPDATE</code>或<code>DELETE</code>命令时，函数<code>CheckTargetForConflictsIn</code>会被调用，并检查SIREAD锁来检测是否存在冲突，如果有就创建一个读-写冲突。</p>
<p>举个例子，假设<code>txid = 100</code>的事务读取了<code>Tuple_1</code>，然后<code>txid=101</code>的事务更新了<code>Tuple_1</code>。在这种情况下，<code>txid=101</code>的事务中的<code>UPDATE</code>命令会调用<code>CheckTargetForConflictsIn</code>函数，并检测到在<code>Tuple_1</code>上存在<code>txid=100,101</code>之间的读-写冲突，并创建<code>rw-conflict{r = 100, w = 101, {Tuple_1}}</code>。</p>
<p><code>CheckTargetForConflictOut</code>、<code>CheckTargetForConflictIn</code>函数，以及在可串行化模式中执行<code>COMMIT</code>命令会触发的<code>PreCommit_CheckForSerializationFailure</code>函数，都会使用创建的读写冲突来检查串行化异常。如果它们检测到异常，则只有先提交的事务会真正提交，其他事务会中止（依据**以先提交者为准（first-committer-win）**策略）。</p>
<h3 id="593-ssi的原理">5.9.3 SSI的原理</h3>
<p>本节将描述SSI如何解决写偏差异常，下面将使用一个简单的表<code>tbl</code>为例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">primary</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">flag</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bool</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">generate_series</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ANALYZE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>事务<code>Tx_A</code>和<code>Tx_B</code>执行以下命令，如图5.13所示。</p>
<p><strong>图5.13 写偏差场景一例</strong></p>
<p><img alt="写偏" src="/img/blog/kernel/fig-5-13.png"></p>
<p>假设所有命令都使用索引扫描。 因此当执行命令时，它们会同时读取堆元组与索引页，每个索引页都包含指向相应堆元组的索引元组，如图5.14所示。</p>
<p><strong>图5.14 例子中索引与表的关系</strong></p>
<p><img alt="索引和表的关系" src="/img/blog/kernel/fig-5-14.png"></p>
<ul>
<li><strong>T1</strong>：<code>Tx_A</code>执行<code>SELECT</code>命令，该命令读取堆元组<code>Tuple_2000</code>，以及包含主键的索引页<code>Pkey_2</code>。</li>
<li><strong>T2</strong>：<code>Tx_B</code>执行<code>SELECT</code>命令。 此命令读取堆元组<code>Tuple_1</code>，以及包含主键的索引页<code>Pkey_1</code>。</li>
<li><strong>T3</strong>：<code>Tx_A</code>执行<code>UPDATE</code>命令，更新<code>Tuple_1</code>。</li>
<li><strong>T4</strong>：<code>Tx_B</code>执行<code>UPDATE</code>命令，更新<code>Tuple_2000</code>。</li>
<li><strong>T5</strong>：<code>Tx_A</code>提交。</li>
<li><strong>T6</strong>：<code>Tx_B</code>提交，然而由于写偏差异常而被中止。</li>
</ul>
<p>图5.15展示了PostgreSQL如何检测和解决上述场景中描述的写偏差异常。</p>
<p><strong>图5.15 SIREA锁与读-写冲突，图5.13场景中的调度方式</strong></p>
<p><img alt="SIREAD锁和rw-conflict" src="/img/blog/kernel/fig-5-15.png"></p>
<ul>
<li>
<p><strong>T1</strong>：
执行<code>Tx_A</code>的<code>SELECT</code>命令时，<code>CheckTargetForConflictsOut</code>会创建SIREAD锁。在本例中该函数会创建两个SIREAD锁：<code>L1</code>与<code>L2</code>。<code>L1</code>和<code>L2</code>分别与<code>Pkey_2</code>和<code>Tuple_2000</code>相关联。</p>
</li>
<li>
<p><strong>T2</strong>：
执行<code>Tx_B</code>的<code>SELECT</code>命令时，<code>CheckTargetForConflictsOut</code>会创建两个SIREAD锁：<code>L3</code>和<code>L4</code>。<code>L3</code>和<code>L4</code>分别与<code>Pkey_1</code>和<code>Tuple_1</code>相关联。</p>
</li>
<li>
<p><strong>T3</strong>：
执行<code>Tx_A</code>的<code>UPDATE</code>命令时，<code>CheckTargetForConflictsOut</code>和<code>CheckTargetForConflictsIN</code>会分别在<code>ExecUpdate</code>执行前后被调用。在本例中，<code>CheckTargetForConflictsOut</code>什么都不做。而<code>CheckTargetForConflictsIn</code>则会创建读-写冲突<code>C1</code>，这是<code>Tx_B</code>和<code>Tx_A</code>在<code>Pkey_1</code>和<code>Tuple_1</code>上的冲突，因为<code>Pkey_1</code>和<code>Tuple_1</code>都由<code>Tx_B</code>读取并被<code>Tx_A</code>写入。</p>
</li>
<li>
<p><strong>T4</strong>：
执行<code>Tx_B</code>的<code>UPDATE</code>命令时，<code>CheckTargetForConflictsIn</code>会创建读-写冲突<code>C2</code>，这是<code>Tx_A</code>与<code>Tx_B</code>在<code>Pkey_2</code>和<code>Tuple_2000</code>上的冲突。</p>
<p>在这种情况下，<code>C1</code>和<code>C2</code>在前趋图中构成一个环；因此<code>Tx_A</code>和<code>Tx_B</code>处于不可串行化状态。但事务<code>Tx_A</code>和<code>Tx_B</code>都尚未提交，因此<code>CheckTargetForConflictsIn</code>不会中止<code>Tx_B</code>。注意这是因为PostgreSQL的SSI实现采用先提交者为准方案。</p>
</li>
<li>
<p><strong>T5</strong>：
当<code>Tx_A</code>尝试提交时，将调用<code>PreCommit_CheckForSerializationFailure</code>。此函数可以检测串行化异常，并在允许的情况下执行提交操作。在这里因为<code>Tx_B</code>仍在进行中，<code>Tx_A</code>成功提交。</p>
</li>
<li>
<p><strong>T6</strong>：
当<code>Tx_B</code>尝试提交时，<code>PreCommit_CheckForSerializationFailure</code>检测到串行化异常，且<code>Tx_A</code>已经提交；因此<code>Tx_B</code>被中止。</p>
</li>
</ul>
<p>此外，如果在<code>Tx_A</code>提交之后（T5时刻），<code>Tx_B</code>执行了<code>UPDATE</code>命令，则<code>Tx_B</code>会立即中止。因为<code>Tx_B</code>的<code>UPDATE</code>命令会调用<code>CheckTargetForConflictsIn</code>，并检测到串行化异常，如图5.16(1)所示。</p>
<p>如果<code>Tx_B</code>在T6时刻执行<code>SELECT</code>命令而不是<code>COMMIT</code>命令，则<code>Tx_B</code>也会立即中止。因为<code>Tx_B</code>的<code>SELECT</code>命令调用的<code>CheckTargetForConflictsOut</code>会检测到串行化异常，如图5.16(2)所示。</p>
<p><strong>图5.16 其他写偏差场景</strong></p>
<p><img alt="其他写偏" src="/img/blog/kernel/fig-5-16.png"></p>
<blockquote>
<p>这里的<a href="https://wiki.postgresql.org/wiki/SSI">Wiki</a>解释了几种更为复杂的异常。</p>
</blockquote>
<h3 id="594-假阳性的串行化异常">5.9.4 假阳性的串行化异常</h3>
<p>在可串行化模式下，因为永远不会检测到**假阴性（false-negative，发生异常但未检测到）**串行化异常，PostgreSQL能始终完全保证并发事务的可串行性。 但相应的是在某些情况下，可能会检测到假阳性异常（没有发生异常但误报发生），用户在使用<code>SERIALIZABLE</code>模式时应牢记这一点。 下文会描述PostgreSQL检测到假阳性异常的情况。</p>
<p>图5.17展示了发生假阳性串行化异常的情况。</p>
<p><strong>图5.17 发生假阳性串行化异常的场景</strong></p>
<p><img alt="假阳性串行化异常的场景" src="/img/blog/kernel/fig-5-17.png"></p>
<p>当使用顺序扫描时，如SIREAD锁的解释中所述，PostgreSQL创建了一个关系级的SIREAD锁。 图5.18(1)展示了PostgreSQL使用顺序扫描时的SIREAD锁和读-写冲突。 在这种情况下，产生了与<code>tbl</code>表上SIREAD锁相关联的读-写冲突：<code>C1</code>和<code>C2</code>，并且它们在前趋图中构成了一个环。 因此会检测到假阳性的写偏差异常（即，虽然实际上没有冲突，但<code>Tx_A</code>与<code>Tx_B</code>两者之一也将被中止）。</p>
<p><strong>图 5.18 假阳性异常(1) - 使用顺序扫描</strong></p>
<p><img alt="使用顺序扫描" src="/img/blog/kernel/fig-5-18.png"></p>
<p>即使使用索引扫描，如果事务<code>Tx_A</code>和<code>Tx_B</code>都获取里相同的索引SIREAD锁，PostgreSQL也会误报假阳性异常。 图5.19展示了这种情况。 假设索引页<code>Pkey_1</code>包含两条索引项，其中一条指向<code>Tuple_1</code>，另一条指向<code>Tuple_2</code>。 当<code>Tx_A</code>和<code>Tx_B</code>执行相应的<code>SELECT</code>和<code>UPDATE</code>命令时，<code>Pkey_1</code>同时被<code>Tx_A</code>和<code>Tx_B</code>读取与写入。 这时候会产生<code>Pkey_1</code>相关联的读-写冲突：<code>C1</code>和<code>C2</code>，并在前趋图中构成一个环，因而检测到假阳性写偏差异常（如果<code>Tx_A</code>和<code>Tx_B</code>获取不同索引页上的SIREAD锁则不会误报，并且两个事务都可以提交）。</p>
<p><strong>图5.19 假阳性异常(2) - 使用相同索引页的索引扫描</strong></p>
<p><img alt="使用相同索引页的索引扫描" src="/img/blog/kernel/fig-5-19.png"></p>
<h2 id="510-所需的维护进程">5.10 所需的维护进程</h2>
<p>PostgreSQL的并发控制机制需要以下维护过程。</p>
<ol>
<li>删除死元组及指向死元组的索引元组</li>
<li>移除**提交日志（clog）**中非必需的部分</li>
<li>冻结旧的<strong>事务标识（txid）</strong></li>
<li>更新FSM，VM，以及统计信息</li>
</ol>
<p>第5.3.2和5.4.3节分别解释了为什么需要第一个和第二个过程。第三个过程与事务标识回卷问题有关，本小节将概述**事务标识回卷（txid wrap around）**问题。</p>
<p>在PostgreSQL中，清理过程（<strong><code>VACUUM</code></strong>）负责这些过程。**清理过程（VACUUM）**在<a href="/zh/blog/kernel/ch6/">第6章</a>中描述。</p>
<h3 id="5101--冻结处理">5.10.1  冻结处理</h3>
<p>接下来将介绍**事务标识回卷（txid wrap around）**问题。</p>
<p>假设元组<code>Tuple_1</code>是由<code>txid = 100</code>事务创建的，即<code>Tuple_1</code>的<code>t_xmin = 100</code>。服务器运行了很长时间，但<code>Tuple_1</code>一直未曾被修改。假设<code>txid</code>已经前进到了$2^{31}+100$，这时候正好执行了一条<code>SELECT</code>命令。此时，因为对当前事务而言<code>txid = 100</code>的事务属于过去的事务，因而<code>Tuple_1</code>对当前事务可见。然后再执行相同的<code>SELECT</code>命令，此时<code>txid</code>步进至$2^{31}+101$。但因对当前事务而言，<code>txid = 100</code>的事务是属于未来的，因此<code>Tuple_1</code>不再可见（图5.20）。这就是PostgreSQL中所谓的事务回卷问题。</p>
<p><strong>图5.20 回卷问题</strong></p>
<p><img src="/img/blog/kernel/fig-5-20.png"></p>
<p>为了解决这个问题，PostgreSQL引入了一个**冻结事务标识（Frozen txid）**的概念，并实现了一个名为<code>FREEZE</code>的过程。</p>
<p>在PostgreSQL中定义了一个冻结的<code>txid</code>，它是一个特殊的保留值<code>txid = 2</code>，在参与事务标识大小比较时，它总是比所有其他<code>txid</code>都旧。换句话说，冻结的<code>txid</code>始终处于<strong>非活跃状态</strong>，且其结果对其他事务始终可见。</p>
<p><strong>清理过程（<code>VACUUM</code>）<strong>会调用冻结过程（</strong><code>FREEZE</code></strong>）。冻结过程将扫描所有表文件，如果元组的<code>t_xmin</code>比当前<code>txid - vacuum_freeze_min_age</code>（默认值为5000万）更老，则将该元组的<code>t_xmin</code>重写为冻结事务标识。在<a href="/zh/blog/kernel/ch6/">第6章</a>中会有更详细的解释。</p>
<p>举个例子，如图5.21(a)所示，当前<code>txid</code>为5000万，此时通过<code>VACUUM</code>命令调用冻结过程。在这种情况下，<code>Tuple_1</code>和<code>Tuple_2</code>的<code>t_xmin</code>都被重写为2。</p>
<p>在版本9.4或更高版本中使用元组<code>t_infomask</code>字段中的<code>XMIN_FROZEN</code>标记位来标识冻结元组，而不是将元组的<code>t_xmin</code>重写为冻结的<code>txid</code>，如图5.21(b)所示。</p>
<p><strong>图5.21 冻结过程</strong></p>
<p><img src="/img/blog/kernel/fig-5-21.png"></p>
<h2 id="参考文献">参考文献</h2>
<ul>
<li>[1] Abraham Silberschatz, Henry F. Korth, and S. Sudarshan, &ldquo;<a href="https://www.amazon.com//dp/0073523321">Database System Concepts</a>&rdquo;, McGraw-Hill Education, ISBN-13: 978-0073523323</li>
<li>[2] Dan R. K. Ports, and Kevin Grittner, &ldquo;<a href="https://drkp.net/papers/ssi-vldb12.pdf">Serializable Snapshot Isolation in PostgreSQL</a>&rdquo;, VDBL 2012</li>
<li>[3] Thomas M. Connolly, and Carolyn E. Begg, &ldquo;<a href="https://www.amazon.com/dp/0321523067">Database Systems</a>&rdquo;, Pearson, ISBN-13: 978-0321523068</li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-1371330787723aaa6945d377225794f0">第六章 垃圾清理过程</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://www.interdb.jp/pg/">Hironobu SUZUKI</a> ，译者：<a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-01-06" class="text-muted">2018年01月06日</time>
        
	</div>
	<p>**清理（VACUUM）**是一种维护过程，有助于PostgreSQL的持久运行。它的两个主要任务是删除死元组，以及冻结事务标识，两者都在第5.10节中简要提到过。</p>
<p>为了移除死元组，清理过程有两种模式：<strong>并发清理（Concurrent Vacuum）</strong> 与<strong>完整清理（Full Vacuum）</strong> 。并发清理（通常简称为<code>VACUUM</code>）会删除表文件每个页面中的死元组，而其他事务可以在其运行时继续读取该表。相反，完整清理不仅会移除整个文件中所有的死元组，还会对整个文件中所有的活元组进行碎片整理。而其他事务在完整清理运行时无法访问该表。</p>
<p>尽管清理过程对PostgreSQL至关重要，但与其他功能相比，它的改进相对其他功能而言要慢一些。例如在8.0版本之前，清理过程必须手动执行（通过<code>psql</code>实用程序或使用<code>cron</code>守护进程）。直到2005年实现了<code>autovacuum</code>守护进程时，这一过程才实现了自动化。</p>
<p>由于清理过程涉及到全表扫描，因此该过程代价高昂。在版本8.4（2009）中引入了**可见性映射（Visibility Map, VM）**来提高移除死元组的效率。在版本9.6（2016）中增强了VM，从而改善了冻结过程的表现。</p>
<p>6.1节概述了并发清理的过程，而后续部分的内容如下所示：</p>
<ul>
<li>可见性映射</li>
<li>**冻结（Freeze）**过程</li>
<li>移除不必要的clog文件</li>
<li>**自动清理（AutoVacuum）**守护进程</li>
<li>完整清理</li>
</ul>
<h2 id="61-并发清理概述">6.1 并发清理概述</h2>
<p>清理过程为指定的表，或数据库中的所有表执行以下任务。</p>
<ol>
<li>移除死元组
<ul>
<li>移除每一页中的死元组，并对每一页内的活元组进行碎片整理。</li>
<li>移除指向死元组的索引元组。</li>
</ul>
</li>
<li>冻结旧的事务标识（<code>txid</code>）
<ul>
<li>如有必要，冻结旧元组的事务标识（txid）。</li>
<li>更新与冻结事务标识相关的系统视图（<code>pg_database</code>与<code>pg_class</code>）。</li>
<li>如果可能，移除非必需的提交日志（clog）。</li>
</ul>
</li>
<li>其他
<ul>
<li>更新已处理表的空闲空间映射（FSM）和可见性映射（VM）。</li>
<li>更新一些统计信息（<code>pg_stat_all_tables</code>等）。</li>
</ul>
</li>
</ol>
<p>这里假设读者已经熟悉以下术语：死元组，冻结事务标识，FSM，clog；如果读者不熟悉这些术语的含义，请参阅<a href="/zh/blog/kernel/ch5/">第5章</a>。VM将在第6.2节中介绍。</p>
<p>以下伪代码描述了清理的过程。</p>
<blockquote>
<h3 id="伪码并发清理">伪码：并发清理</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>(1)     FOR each table
</span></span><span style="display:flex;"><span>(2)         在目标表上获取 ShareUpdateExclusiveLock 锁
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>            /* 第一部分 */
</span></span><span style="display:flex;"><span>(3)         扫描所有页面，定位死元组；如有必要，冻结过老的元组。
</span></span><span style="display:flex;"><span>(4)         如果存在，移除指向死元组的索引元组。
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>            /* 第二部分 */
</span></span><span style="display:flex;"><span>(5)         FOR each page of the table
</span></span><span style="display:flex;"><span>(6)             移除死元组，重排本页内的活元组。
</span></span><span style="display:flex;"><span>(7)             更新 FSM 与 VM
</span></span><span style="display:flex;"><span>            END FOR
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>            /* 第三部分 */
</span></span><span style="display:flex;"><span>(8)         如果可能，截断最后的页面。
</span></span><span style="display:flex;"><span>(9)         更新系统数据字典与统计信息
</span></span><span style="display:flex;"><span>            释放ShareUpdateExclusiveLock锁
</span></span><span style="display:flex;"><span>        END FOR
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        /* 后续处理 */
</span></span><span style="display:flex;"><span>(10)    更新统计信息与系统数据字典
</span></span><span style="display:flex;"><span>(11)    如果可能，移除没有必要的文件，以及clog中的文件。
</span></span></code></pre></div><ol>
<li>从指定的表集中依次处理每一张表。</li>
<li>获取表上的<code>ShareUpdateExclusiveLock</code>锁， 此锁允许其他事务对该表进行读取。</li>
<li>扫描表中所有的页面，以获取所有的死元组，并在必要时冻结旧元组。</li>
<li>删除指向相应死元组的索引元组（如果存在）。</li>
<li>对表的每个页面执行步骤(6)和(7)中的操作</li>
<li>移除死元组，并重新分配页面中的活元组。</li>
<li>更新目标表对应的FSM与VM。</li>
<li>如果最后一个页面没有任何元组，则截断最后一页。</li>
<li>更新与<strong>目标表</strong>清理过程相关的统计数据和系统视图。</li>
<li>更新与清理过程相关的统计数据和系统视图。</li>
<li>如果可能，移除clog中非必需的文件与页面。</li>
</ol>
</blockquote>
<p>该伪码分为两大块：一块是依次处理表的循环，一块是后处理逻辑。而循环块又能分为三个部分，每一个部分都有各自的任务。接下来会描述这三个部分，以及后处理的逻辑。</p>
<h3 id="611-第一部分">6.1.1 第一部分</h3>
<p>这一部分执行冻结处理，并删除指向死元组的索引元组。</p>
<p>首先，PostgreSQL扫描目标表以构建死元组列表，如果可能的话，还会冻结旧元组。该列表存储在本地内存中的<a href="https://www.postgresql.org/docs/current/static/runtime-config-resource.html#GUC-MAINTENANCE-WORK-MEM"><code>maintenance_work_mem</code></a>里（维护用的工作内存）。冻结处理将在第6.3节中介绍。</p>
<p>扫描完成后，PostgreSQL根据构建得到的死元组列表来删除索引元组。该过程在内部被称为“<strong>清除阶段（cleanup stage）</strong>”。不用说，该过程代价高昂。在10或更早版本中始终会执行清除阶段。在11或更高版本中，如果目标索引是B树，是否执行清除阶段由配置参数<a href="https://www.postgresql.org/docs/devel/static/runtime-config-resource.html#RUNTIME-CONFIG-INDEX-VACUUM"><code>vacuum_cleanup_index_scale_factor</code></a>决定。详细信息请参考<a href="https://www.postgresql.org/docs/devel/static/runtime-config-resource.html#RUNTIME-CONFIG-INDEX-VACUUM">此参数的说明</a>。</p>
<p>当<code>maintenance_work_mem</code>已满，且未完成全部扫描时，PostgreSQL继续进行后续任务，即步骤4到7；完成后再重新返回步骤3并继续扫描。</p>
<h3 id="612-第二部分">6.1.2 第二部分</h3>
<p>这一部分会移除死元组，并逐页更新FSM和VM。图6.1展示了一个例子：</p>
<p><strong>图6.1 删除死元组</strong></p>
<p><img src="/img/blog/kernel/fig-6-01.png">
假设该表包含三个页面，这里先关注0号页面（即第一个页面）。该页面包含三条元组， 其中<code>Tuple_2</code>是一条死元组，如图6.1(1)所示。在这里PostgreSQL移除了<code>Tuple_2</code>，并重排剩余元组来整理碎片空间，然后更新该页面的FSM和VM，如图6.1(2)所示。 PostgreSQL不断重复该过程直至最后一页。</p>
<p>请注意，非必需的行指针是不会被移除的，它们会在将来被重用。因为如果移除了行指针，就必须同时更新所有相关索引中的索引元组。</p>
<h3 id="613-第三部分">6.1.3 第三部分</h3>
<p>第三部分会针对每个表，更新与清理过程相关的统计信息和系统视图。</p>
<p>此外，如果最后一页中没有元组，则该页会从表文件中被截断。</p>
<h3 id="614-后续处理">6.1.4 后续处理</h3>
<p>当处理完成后，PostgreSQL会更新与清理过程相关的几个统计数据，以及相关的系统视图；如果可能的话，它还会移除部分非必需的clog（第6.4节）。</p>
<blockquote>
<p>清理过程使用8.5节中将描述的<strong>环形缓冲区（ring buffer）</strong>。因此处理过的页面不会缓存在共享缓冲区中。</p>
</blockquote>
<h2 id="62-可见性映射">6.2 可见性映射</h2>
<p>清理过程的代价高昂，因此PostgreSQL在8.4版中引入了VM，用于减小清理的开销。</p>
<p>VM的基本概念很简单。 每个表都拥有各自的可见性映射，用于保存表文件中每个页面的可见性。 页面的可见性确定了每个页面是否包含死元组。清理过程可以跳过没有死元组的页面。</p>
<p>图6.2展示了VM的使用方式。 假设该表包含三个页面，第0页和第2页包含死元组，而第1页不包含死元组。 表的可见性映射中保存着哪些页面包含死元组的信息。 在这种情况下，清理过程可以参考VM中的信息，跳过第一个页面。</p>
<p><strong>图6.2 VM的使用方式</strong></p>
<p><img src="/img/blog/kernel/fig-6-02.png"></p>
<p>每个VM由一个或多个8 KB页面组成，文件以后缀<code>_vm</code>存储。 例如，一个表文件的<code>relfilenode</code>是18751，其FSM（<code>18751_fsm</code>）和VM（<code>18751_vm</code>）文件如下所示。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#204a87">cd</span> <span style="color:#000">$PGDATA</span>
</span></span><span style="display:flex;"><span>$ ls -la base/16384/18751*
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#0000cf;font-weight:bold">1</span> postgres postgres  <span style="color:#0000cf;font-weight:bold">8192</span> Apr <span style="color:#0000cf;font-weight:bold">21</span> 10:21 base/16384/18751
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#0000cf;font-weight:bold">1</span> postgres postgres <span style="color:#0000cf;font-weight:bold">24576</span> Apr <span style="color:#0000cf;font-weight:bold">21</span> 10:18 base/16384/18751_fsm
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#0000cf;font-weight:bold">1</span> postgres postgres  <span style="color:#0000cf;font-weight:bold">8192</span> Apr <span style="color:#0000cf;font-weight:bold">21</span> 10:18 base/16384/18751_vm
</span></span></code></pre></div><h3 id="621-可见性映射的改进">6.2.1 可见性映射的改进</h3>
<p>可见性映射在9.6版中进行了加强，以提高冻结处理的效率。新的VM除了显示页面可见性之外，还包含了页面中元组是否全部冻结的信息，参见第6.3.3节。</p>
<h2 id="63-冻结过程">6.3 冻结过程</h2>
<p>冻结过程有两种模式，依特定条件而择其一执行。为方便起见，将这两种模式分别称为<strong>惰性模式（lazy mode）<strong>和</strong>迫切模式（eager mode）</strong>。</p>
<blockquote>
<p>**并发清理（Concurrent VACUUM）<strong>通常在内部被称为“<strong>惰性清理（lazy vacuum）</strong>”。但是，本文中定义的惰性模式是</strong>冻结过程（Freeze Processing）**执行的模式。</p>
</blockquote>
<p>冻结过程通常以惰性模式运行；但当满足特定条件时，也会以迫切模式运行。在惰性模式下，冻结处理仅使用目标表对应的VM扫描包含死元组的页面。迫切模式相则反，它会扫描所有的页面，无论其是否包含死元组，它还会更新与冻结处理相关的系统视图，并在可能的情况下删除不必要的clog。</p>
<p>第6.3.1和6.3.2节分别描述了这两种模式；第6.3.3节描述了改进后的迫切模式冻结过程。</p>
<h3 id="631-惰性模式">6.3.1 惰性模式</h3>
<p>当开始冻结处理时，PostgreSQL计算<code>freezeLimit_txid</code>，并冻结<code>t_xmin</code>小于<code>freezeLimit_txid</code>的元组。</p>
<p><code>freezeLimit_txid</code>定义如下：
$$
\begin{align}
\verb|freezeLimit_txid| = (\verb|OldestXmin| - \verb|vacuum_freeze_min_age|)
\end{align}
$$</p>
<p>而<code>OldestXmin</code>是当前正在运行的事务中最早的<strong>事务标识（txid）</strong>。 举个例子，如果在执行<code>VACUUM</code>命令时，还有其他三个事务正在运行，且其<code>txid</code>分别为<code>100,101,102</code>，那么这里<code>OldestXmin</code>就是100。如果不存在其他事务，<code>OldestXmin</code> 就是执行此<code>VACUUM</code>命令的事务标识。 这里<code>vacuum_freeze_min_age</code>是一个配置参数（默认值为<code>50,000,000</code>）。</p>
<p>图6.3给出了一个具体的例子。这里<code>Table_1</code>由三个页面组成，每个页面包含三条元组。 执行<code>VACUUM</code>命令时，当前<code>txid</code>为<code>50,002,500</code>且没有其他事务。在这种情况下，<code>OldestXmin</code>就是<code>50,002,500</code>；因此<code>freezeLimit_txid</code>为<code>2500</code>。冻结过程按照如下步骤执行。</p>
<p><strong>图6.3 冻结元组——惰性模式</strong></p>
<p><img src="/img/blog/kernel/fig-6-03.png"></p>
<ul>
<li>
<p>第0页：</p>
<p>三条元组被冻结，因为所有元组的<code>t_xmin</code>值都小于<code>freezeLimit_txid</code>。此外，因为<code>Tuple_1</code>是一条死元组，因而在该清理过程中被移除。</p>
</li>
<li>
<p>第1页：</p>
<p>通过引用可见性映射（从VM中发现该页面所有元组都可见），清理过程跳过了对该页面的清理。</p>
</li>
<li>
<p>第2页：</p>
<p><code>Tuple_7</code>和<code>Tuple_8</code>被冻结，且<code>Tuple_7</code>被移除。</p>
</li>
</ul>
<p>在完成清理过程之前，与清理相关的统计数据会被更新，例如<code>pg_stat_all_tables</code>视图中的<code>n_live_tup</code>，<code>n_dead_tup</code>，<code>last_vacuum</code>，<code>vacuum_count</code>等字段。</p>
<p>如上例所示，因为惰性模式可能会跳过页面，它可能无法冻结所有需要冻结的元组。</p>
<h3 id="632-迫切模式">6.3.2 迫切模式</h3>
<p>迫切模式弥补了惰性模式的缺陷。它会扫描所有页面，检查表中的所有元组，更新相关的系统视图，并在可能时删除非必需的clog文件与页面。</p>
<p>当满足以下条件时，会执行迫切模式。
$$
\begin{align}
\verb|pg_database.datfrozenxid| &lt; (\verb|OldestXmin| - \verb|vacuum_freeze_table_age|)
\end{align}
$$
在上面的条件中，<code>pg_database.datfrozenxid</code>是系统视图<code>pg_database</code>中的列，并保存着每个数据库中最老的已冻结的事务标识。细节将在后面描述；因此这里我们假设所有<code>pg_database.datfrozenxid</code>的值都是<code>1821</code>（这是在9.5版本中安装新数据库集群之后的初始值）。 <code>vacuum_freeze_table_age</code>是配置参数（默认为<code>150,000,000</code>）。</p>
<p>图6.4给出了一个具体的例子。在表1中，<code>Tuple_1</code>和<code>Tuple_7</code>都已经被删除。<code>Tuple_10</code>和<code>Tuple_11</code>则已经插入第2页中。执行<code>VACUUM</code>命令时的事务标识为<code>150,002,000</code>，且没有其他事务。因此，<code>OldestXmin=150,002,000</code>，<code>freezeLimit_txid=100,002,000</code>。在这种情况下满足了上述条件：因为<code>1821 &lt; (150002000 - 150000000)</code>	，因而冻结过程会以迫切模式执行，如下所示。</p>
<p>（注意，这里是版本9.5或更早版本的行为；最新版本的行为将在第6.3.3节中描述。）</p>
<p><strong>图6.4 冻结旧元组——迫切模式（9.5或更早版本）</strong></p>
<p><img src="/img/blog/kernel/fig-6-04.png"></p>
<ul>
<li>
<p>第0页：</p>
<p>即使所有元组都被冻结，也会检查<code>Tuple_2</code>和<code>Tuple_3</code>。</p>
</li>
<li>
<p>第1页：</p>
<p>此页面中的三条元组都会被冻结，因为所有元组的<code>t_xmin</code>值都小于<code>freezeLimit_txid</code>。注意在惰性模式下会跳过此页面。</p>
</li>
<li>
<p>第2页：</p>
<p>将<code>Tuple_10</code>冻结，而<code>Tuple_11</code>没有冻结。</p>
</li>
</ul>
<p>冻结一张表后，目标表的<code>pg_class.relfrozenxid</code>将被更新。 <a href="https://www.postgresql.org/docs/current/catalog-pg-class.html"><code>pg_class</code></a>是一个系统视图，每个<code>pg_class.relfrozenxid</code>列都保存着相应表的最近冻结的事务标识。本例中表1的<code>pg_class.relfrozenxid</code>会被更新为当前的<code>freezeLimit_txid</code>（即<code>100,002,000</code>），这意味着表1中<code>t_xmin</code>小于<code>100,002,000</code>的所有元组都已被冻结。</p>
<p>在完成清理过程之前，必要时会更新<code>pg_database.datfrozenxid</code>。每个<code>pg_database.datfrozenxid</code>列都包含相应数据库中的最小<code>pg_class.relfrozenxid</code>。例如，如果在迫切模式下仅仅对表1做冻结处理，则不会更新该数据库的<code>pg_database.datfrozenxid</code>，因为其他关系的<code>pg_class.relfrozenxid</code>（当前数据库可见的其他表和系统视图）还没有发生变化，如图6.5(1)所示。如果当前数据库中的所有关系都以迫切模式冻结，则数据库的<code>pg_database.datfrozenxid</code>就会被更新，因为此数据库的所有关系的<code>pg_class.relfrozenxid</code>都被更新为当前的<code>freezeLimit txid</code>，如图6.5(2)所示。</p>
<p><strong>图6.5  <code>pg_database.datfrozenxid</code>与<code>pg_class.relfrozenxid</code>之间的关系</strong></p>
<p><img src="/img/blog/kernel/fig-6-05.png"></p>
<blockquote>
<h4 id="如何显示pg_classrelfrozenxid与pg_databasedatfrozenxid"> 如何显示<code>pg_class.relfrozenxid</code>与<code>pg_database.datfrozenxid</code></h4>
<p>如下所示，第一个查询显示<code>testdb</code>数据库中所有可见关系的<code>relfrozenxid</code>，第二个查询显示<code>testdb</code>数据库的<code>pg_database.datfrozenxld</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VACUUM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">VACUUM</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Schema&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Name&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relfrozenxid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">LEFT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_namespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relkind</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;r&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;information_schema&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">!~</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;^pg_toast&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_is_visible</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relfrozenxid</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">text</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">bigint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">Schema</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#000">Name</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relfrozenxid</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">------------+-------------------------+--------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_1</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#0000cf;font-weight:bold">100002000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_2</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#0000cf;font-weight:bold">1846</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_database</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#0000cf;font-weight:bold">1827</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_user_mapping</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#0000cf;font-weight:bold">1821</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_largeobject</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#0000cf;font-weight:bold">1821</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_catalog</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_transform</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#0000cf;font-weight:bold">1821</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">57</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datfrozenxid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_database</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;testdb&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datfrozenxid</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------+--------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">testdb</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#0000cf;font-weight:bold">1821</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></blockquote>
<blockquote>
<h4 id="freeze选项"><code>FREEZE</code>选项</h4>
<p>带有<code>FREEZE</code>选项的<code>VACUUM</code>命令会强制冻结指定表中的所有事务标识。虽然这是在迫切模式下执行的，但这里<code>freezeLimit</code>会被设置为<code>OldestXmin</code>（而不是<code>OldestXmin - vacuum_freeze_min_age</code>）。 例如当<code>txid=5000</code>的事务执行<code>VACUUM FULL</code>命令，且没有其他正在运行的事务时，<code>OldesXmin</code>会被设置为5000，而<code>t_xmin</code>小于5000的元组将会被冻结。</p>
</blockquote>
<h3 id="633-改进迫切模式中的冻结过程">6.3.3 改进迫切模式中的冻结过程</h3>
<p>9.5或更早版本中的迫切模式效率不高，因为它始终会扫描所有页面。 比如在第6.3.2节的例子中，尽管第0页中所有元组都被冻结，但也会被扫描。</p>
<p>为了解决这一问题，9.6版本改进了可见性映射VM与冻结过程。如第6.2.1节所述，新VM包含着每个页面中所有元组是否都已被冻结的信息。在迫切模式下进行冻结处理时，可以跳过仅包含冻结元组的页面。</p>
<p>图6.6给出了一个例子。 根据VM中的信息，冻结此表时会跳过第0页。在更新完1号页面后，相关的VM信息会被更新，因为该页中所有的元组都已经被冻结了。</p>
<p><strong>图6.6  冻结旧元组——迫切模式（9.6或更高版本）</strong></p>
<p><img src="/img/blog/kernel/fig-6-06.png"></p>
<h2 id="64-移除不必要的提交日志文件">6.4 移除不必要的提交日志文件</h2>
<p>如5.4节中所述，**提交日志（clog）**存储着事务的状态。 当更新<code>pg_database.datfrozenxid</code>时，PostgreSQL会尝试删除不必要的clog文件。 注意相应的clog页面也会被删除。</p>
<p>图6.7给出了一个例子。 如果clog文件<code>0002</code>中包含最小的<code>pg_database.datfrozenxid</code>，则可以删除旧文件（<code>0000</code>和<code>0001</code>），因为存储在这些文件中的所有事务在整个数据库集簇中已经被视为冻结了。</p>
<p><strong>图6.7  删除不必要的clog文件和页面</strong></p>
<p><img src="/img/blog/kernel/fig-6-07.png"></p>
<blockquote>
<h3 id="pg_databasedatfrozenxid与clog文件"> <code>pg_database.datfrozenxid</code>与clog文件</h3>
<p>下面展示了<code>pg_database.datfrozenxid</code>与clog文件的实际输出</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ psql testdb -c <span style="color:#4e9a06">&#34;SELECT datname, datfrozenxid FROM pg_database&#34;</span>
</span></span><span style="display:flex;"><span>  datname  <span style="color:#000;font-weight:bold">|</span> datfrozenxid 
</span></span><span style="display:flex;"><span>-----------+--------------
</span></span><span style="display:flex;"><span> template1 <span style="color:#000;font-weight:bold">|</span>      <span style="color:#0000cf;font-weight:bold">7308883</span>
</span></span><span style="display:flex;"><span> template0 <span style="color:#000;font-weight:bold">|</span>      <span style="color:#0000cf;font-weight:bold">7556347</span>
</span></span><span style="display:flex;"><span> postgres  <span style="color:#000;font-weight:bold">|</span>      <span style="color:#0000cf;font-weight:bold">7339732</span>
</span></span><span style="display:flex;"><span> testdb    <span style="color:#000;font-weight:bold">|</span>      <span style="color:#0000cf;font-weight:bold">7506298</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span> rows<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ls -la -h data/pg_clog/	<span style="color:#8f5902;font-style:italic"># 10或更新的版本, &#34;ls -la -h data/pg_xact/&#34;</span>
</span></span><span style="display:flex;"><span>total 316K
</span></span><span style="display:flex;"><span>drwx------  <span style="color:#0000cf;font-weight:bold">2</span> postgres postgres   <span style="color:#0000cf;font-weight:bold">28</span> Dec <span style="color:#0000cf;font-weight:bold">29</span> 17:15 .
</span></span><span style="display:flex;"><span>drwx------ <span style="color:#0000cf;font-weight:bold">20</span> postgres postgres 4.0K Dec <span style="color:#0000cf;font-weight:bold">29</span> 17:13 ..
</span></span><span style="display:flex;"><span>-rw-------  <span style="color:#0000cf;font-weight:bold">1</span> postgres postgres 256K Dec <span style="color:#0000cf;font-weight:bold">29</span> 17:15 <span style="color:#0000cf;font-weight:bold">0006</span>
</span></span><span style="display:flex;"><span>-rw-------  <span style="color:#0000cf;font-weight:bold">1</span> postgres postgres  56K Dec <span style="color:#0000cf;font-weight:bold">29</span> 17:15 <span style="color:#0000cf;font-weight:bold">0007</span>
</span></span></code></pre></div></blockquote>
<h2 id="65-自动清理守护进程">6.5 自动清理守护进程</h2>
<p>**自动清理（AutoVacuum）**守护进程已经将清理过程自动化，因此PostgreSQL运维起来非常简单。</p>
<p>自动清理守护程序周期性地唤起几个<code>autovacuum_worker</code>进程，默认情况下会每分钟唤醒一次（由参数<a href="https://www.postgresql.org/docs/current/runtime-config-autovacuum.html#GUC-AUTOVACUUM-NAPTIME"><code>autovacuum_naptime</code></a>定义），每次唤起三个工作进程（由<a href="https://www.postgresql.org/docs/current/runtime-config-autovacuum.html#GUC-AUTOVACUUM-MAX-WORKERS"><code>autovacuum_max_works</code></a>定义）。</p>
<p>自动清理守护进程唤起的<code>autovacuum</code>工作进程会依次对各个表执行并发清理，从而将对数据库活动的影响降至最低。</p>
<blockquote>
<h6 id="关于如何维护autovacuum">关于如何维护<code>AUTOVACUUM</code></h6>
<p>参考文章：[PostgreSQL中的Autovacuum调参，Autovacuum内幕][https://www.percona.com/blog/2018/08/10/tuning-autovacuum-in-postgresql-and-autovacuum-internals/]</p>
</blockquote>
<h2 id="66-完整清理full-vacuum">6.6 完整清理（<code>FULL VACUUM</code>）</h2>
<p>虽然并发清理对于运维至关重要，但光有它还不够。比如，即使删除了许多死元组，也无法压缩表大小的情况。</p>
<p>图6.8给出了一个极端的例子。假设一个表由三个页面组成，每个页面包含六条元组。执行以下<code>DELETE</code>命令以删除元组，并执行<code>VACUUM</code>命令以移除死元组：</p>
<p><strong>图6.8 并发清理的缺陷示例</strong></p>
<p><img src="/img/blog/kernel/fig-6-08.png"></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DELETE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VACUUM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>死元组虽然都被移除了，但表的尺寸没有减小。 这种情况既浪费了磁盘空间，又会对数据库性能产生负面影响。 例如在上面的例子中，当读取表中的三条元组时，必须从磁盘加载三个页面。</p>
<p>为了解决这种情况，PostgreSQL提供了<strong>完整清理</strong>模式。 图6.9概述了该模式。</p>
<p><strong>图6.9 完整清理模式概述</strong></p>
<p><img src="/img/blog/kernel/fig-6-09.png"></p>
<ol>
<li>
<p>创建新的表文件：见图6.9(1)</p>
<p>当对表执行<code>VACUUM FULL</code>命令时，PostgreSQL首先获取表上的<code>AccessExclusiveLock</code>锁，并创建一个大小为8 KB的新的表文件。 <code>AccessExclusiveLock</code>锁不允许任何其他访问。</p>
</li>
<li>
<p>将活元组复制到新表：见图6.9(2)</p>
<p>PostgreSQL只将旧表文件中的活元组复制到新表中。</p>
</li>
<li>
<p>删除旧文件，重建索引，并更新统计信息，FSM和VM，见图6.9(3)</p>
<p>复制完所有活元组后，PostgreSQL将删除旧文件，重建所有相关的表索引，更新表的FSM和VM，并更新相关的统计信息和系统视图。</p>
</li>
</ol>
<p>完整清理的伪代码如下所示：</p>
<blockquote>
<h4 id="伪代码完整清理">伪代码：完整清理</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>(1)     FOR each table
</span></span><span style="display:flex;"><span>(2)         获取表上的AccessExclusiveLock锁
</span></span><span style="display:flex;"><span>(3)         创建一个新的表文件
</span></span><span style="display:flex;"><span>(4)         FOR 每个活元组 in 老表
</span></span><span style="display:flex;"><span>(5)             将活元组拷贝到新表中
</span></span><span style="display:flex;"><span>(6)             如果有必要，冻结该元组。
</span></span><span style="display:flex;"><span>            END FOR
</span></span><span style="display:flex;"><span>(7)         移除旧的表文件
</span></span><span style="display:flex;"><span>(8)         重建所有索引
</span></span><span style="display:flex;"><span>(9)         更新FSM与VM
</span></span><span style="display:flex;"><span>(10)        更新统计信息
</span></span><span style="display:flex;"><span>            释放AccessExclusiveLock锁
</span></span><span style="display:flex;"><span>        END FOR
</span></span><span style="display:flex;"><span>(11)    移除不必要的clog文件
</span></span></code></pre></div></blockquote>
<p>使用<code>VACUUM FULL</code>命令时，应当考虑两点。</p>
<ol>
<li>当执行完整清理时，没有人可以访问（读/写）表。</li>
<li>最多会临时使用两倍于表的磁盘空间；因此在处理大表时，有必要检查剩余磁盘容量。</li>
</ol>
<blockquote>
<h3 id="什么时候该使用vacuum-full">什么时候该使用<code>VACUUM FULL</code>？</h3>
<p>不幸的是，并没有关于什么时候该执行<code>VACUUM FULL</code>的最佳实践。但是扩展<a href="https://www.postgresql.org/docs/current/static/pgfreespacemap.html"><code>pg_freespacemap</code></a>可能会给出很好的建议。</p>
<p>以下查询给出了表的平均空间空闲率。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_freespacemap</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;number of pages&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">cast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">avg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avail</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Av. freespace size&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">avg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avail</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">8192</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Av. freespace ratio&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_freespace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;accounts&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Av</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">freespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Av</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">freespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------------+--------------------+---------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">1640</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">99</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bytes</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">21</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>从上面的结果可以看出，没有多少空闲空间。</p>
<p>如果删除几乎所有的元组，并执行<code>VACUUM</code>命令，则可以发现每个页面几乎都是空的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DELETE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">accounts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">DELETE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">90009</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VACUUM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">accounts</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">VACUUM</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;number of pages&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">cast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">avg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avail</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Av. freespace size&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">avg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avail</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">8192</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Av. freespace ratio&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_freespace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;accounts&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Av</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">freespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Av</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">freespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------------+--------------------+---------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#0000cf;font-weight:bold">1640</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">7124</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bytes</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:bold">86</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">97</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>以下查询检查特定表中每个页面的自由空间占比。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">avail</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">8192</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;freespace ratio&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_freespace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;accounts&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">blkno</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">avail</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">freespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-------+-------+-----------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:bold">7904</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">96</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:bold">7520</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">91</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:bold">7136</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">87</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:bold">7136</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">87</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:bold">7136</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">87</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:bold">7136</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#0000cf;font-weight:bold">87</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">....</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>执行<code>VACUUM FULL</code>后会发现表被压实了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VACUUM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">accounts</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">VACUUM</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;number of blocks&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">cast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">avg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avail</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">bigint</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Av. freespace size&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">avg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avail</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">8192</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Av. freespace ratio&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_freespace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;accounts&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">number</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">of</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Av</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">freespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Av</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">freespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-----------------+--------------------+---------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#0000cf;font-weight:bold">164</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bytes</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">00</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></blockquote>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-3ca993226c6ab42d101318229d3dcbb8">第七章 堆内元组与仅索引扫描</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://www.interdb.jp/pg/">Hironobu SUZUKI</a> ，译者：<a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-01-05" class="text-muted">2018年01月05日</time>
        
	</div>
	<p>本章中介绍两个和索引扫描有关的特性—— <strong>堆内元组（heap only tuple, HOT）<strong>和</strong>仅索引扫描（index-only scan）</strong> 。</p>
<h2 id="71-堆内元组hot">7.1 堆内元组（HOT）</h2>
<p>在8.3版本中实现的HOT特性，使得更新行的时候，可以将新行放置在老行所处的同一个数据页中，从而高效地利用索引与表的数据页；HOT特性减少了不必要的清理过程。</p>
<p>在源码的<a href="https://github.com/postgres/postgres/blob/master/src/backend/access/heap/README.HOT"><code>README.HOT</code></a>中有关于HOT的详细介绍，本章只是简短的介绍HOT。首先，7.1.1节描述了在没有HOT特性的时候，更新一行是怎样一个过程，以阐明要解决的问题。接下来，在7.1.2中将介绍HOT做了什么。</p>
<h3 id="711-没有hot时的行更新">7.1.1 没有HOT时的行更新</h3>
<p>假设表<code>tbl</code>有两个列：<code>id</code>和<code>data</code>；<code>id</code>是<code>tbl</code>的主键。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">\</span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;public.tbl&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Type</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Collation</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Nullable</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------+---------+-----------+----------+---------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Indexes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;tbl_pkey&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>表<code>tbl</code>有1000条元组；最后一个元组的<code>id</code>是1000，存储在第五个数据页中。最后一条元组被相应的索引元组所引用，索引元组的<code>key</code>是1000，且<code>tid</code>是<code>(5,1)</code>，如图7.1(a)所示。</p>
<p><strong>图 7.1 没有HOT的行更新</strong></p>
<p><img alt="update" src="/img/blog/kernel/fig-7-01.png"></p>
<p>我们考虑一下，没有HOT特性时，最后一个元组是如何更新的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;B&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在该场景中，PostgreSQL不仅要插入一条新的表元组，还需要在索引页中插入新的索引元组，如图7.1(b)所示。索引元组的插入消耗了索引页的空间，而且索引元组的插入和清理都是开销很大的操作。HOT的目的，就是降低这种影响。</p>
<h3 id="712-hot如何工作">7.1.2 HOT如何工作</h3>
<p>当使用HOT特性更新行时，如果被更新的元组存储在老元组所在的页面中，PostgreSQL就不会再插入相应的索引元组，而是分别设置新元组的<code>HEAP_ONLY_TUPLE</code>标记位与老元组的<code>HEAP_HOT_UPDATED</code>标记位，两个标记位都保存在元组的<code>t_informask2</code>字段中。如图7.2和7.3所示；</p>
<p><strong>图7.2 HOT的行更新</strong></p>
<p><img alt="hot" src="/img/blog/kernel/fig-7-02.png">
<img alt="informask" src="/img/blog/kernel/fig-7-03.png"></p>
<p>比如在这个例子中，<code>Tuple_1</code>和<code>Tuple_2</code>分别被设置成<code>HEAP_HOT_UPDATED</code>和<code>HEAP_ONLY_TUPLE</code>。</p>
<p>另外，在**修剪（pruning）<strong>和</strong>碎片整理（defragmentation）**处理过程中，都会使用下面介绍的<code>HEAP_HOT_UPDATED</code>和<code>HEAP_ONLY_TUPLE</code>标记位。</p>
<p>接下来会介绍，当基于HOT更新一个元组后，PostgreSQL是如何在索引扫描中访问这些被HOT更新的元组的，如图7.4(a)所示。</p>
<p><strong>图7.4 行指针修剪</strong></p>
<p><img alt="pruning" src="/img/blog/kernel/fig-7-04.png"></p>
<ol>
<li>找到指向目标数据元组的索引元组</li>
<li>按所获索引元组指向的位置访问行指针数组，找到行指针<code>1</code></li>
<li>读取<code>Tuple_1</code></li>
<li>经由<code>Tuple_1</code>的<code>t_ctid</code>字段，读取<code>Tuple_2</code>。</li>
</ol>
<p>在这种情况下，PostgreSQL会读取两条元组，<code>Tuple_1</code>和<code>Tuple_2</code>，并通过<a href="/zh/blog/kernel/ch5/">第5章</a>所述的并发控制机制来判断哪条元组是可见的；但如果数据页中的**死元组（dead tuple）**已经被清理了，那就有问题了。比如在图7.4(a)中，如果<code>Tuple_1</code>由于是死元组而被清理了，就无法通过索引访问<code>Tuple_2</code>了。</p>
<p>为了解决这个问题，PostgreSQL会在合适的时候进行行指针重定向：将指向老元组的行指针重新指向新元组的行指针。在PostgreSQL中，这个过程称为<strong>修剪（pruning）</strong>。图7.4(b)说明了PostgreSQL在修剪之后如何访问更新的元组。</p>
<ol>
<li>找到索引元组</li>
<li>通过索引元组，找到行指针<code>[1]</code></li>
<li>通过重定向的行指针<code>[1]</code>，找到行指针<code>[2]</code>；</li>
<li>通过行指针<code>[2]</code>，读取<code>Tuple_2</code></li>
</ol>
<p>可能的话，剪枝任何时候都有可能会发生，比如 <code>SELECT</code> ，<code>UPDATE</code>， <code>INSERT</code> ，<code>DELETE</code>这类SQL命令执行的时候，确切的执行时机不会在本章中描述，因为它太复杂了。细节可以在<a href="https://github.com/postgres/postgres/blob/master/src/backend/access/heap/README.HOT"><code>README.HOT</code></a>文件中找到。</p>
<p>在PostgreSQL执行剪枝时，如果可能，会挑选合适的时机来清理死元组。在PostgreSQL中这种操作称为<strong>碎片整理（defragmentation）</strong>，图7.5中描述了HOT中的碎片整理过程。</p>
<p><strong>图 7.5 死元组的碎片整理</strong></p>
<p><img src="/img/blog/kernel/fig-7-05.png"></p>
<p>需要注意的是，因为碎片整理的工作并不涉及到索引元组的移除，因此碎片整理比起常规的清理开销要小得多。</p>
<p>因此，HOT特性降低了索引和表的空间消耗，同样减少了清理过程需要处理的元组数量。由于减少了更新操作需要插入的索引元组数量，并减小了清理操作需要处理的元组数量，HOT对于性能提高有良好的促进作用。</p>
<blockquote>
<h4 id="hot不可用的场景">HOT不可用的场景</h4>
<p>为了清晰地理解HOT的工作，这里介绍一些HOT不可用的场景。</p>
<ol>
<li>当更新的元组在其他的页面时，即和老元组在不在同一个数据页中时，指向该元组的索引元组也会被添加至索引页中，如图7.6(a)所示。</li>
<li>当索引的<strong>键</strong>更新时，会在索引页中插入一条新的索引元组，如图7.6(b)所示。</li>
</ol>
<p><strong>图7.6 HOT不适用的情况</strong></p>
<p><img alt="notavaible" src="/img/blog/kernel/fig-7-06.png"></p>
</blockquote>
<blockquote>
<p><a href="https://www.postgresql.org/docs/current/static/monitoring-stats.html#PG-STAT-ALL-TABLES-VIEW"><code>pg_stat_all_tables</code></a>视图提供了每个表的统计信息视图，也可以参考这个<a href="https://github.com/s-hironobu/pg_stats">扩展</a>。</p>
</blockquote>
<h2 id="72-仅索引扫描">7.2 仅索引扫描</h2>
<p>当<code>SELECT</code>语句的所有的目标列都在索引键中时，为了减少I/O代价，<strong>仅索引扫描（Index-Only Scan）</strong>（又叫仅索引访问）会直接使用索引中的键值。所有商业关系型数据库中都提供这个技术，比如DB2和Oracle。PostgreSQL在9.2版本中引入这个特性。</p>
<p>接下来我们会基于一个特殊的例子，介绍PostgreSQL中仅索引扫描的工作过程。</p>
<p>首先是关于这个例子的假设：</p>
<ul>
<li>
<p>表定义</p>
<p>我们有一个<code>tbl</code>表，其定义如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">\</span><span style="color:#000">d</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;public.tbl&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Type</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Modifiers</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------+---------+-----------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">integer</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">text</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Indexes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;tbl_idx&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>索引</p>
<p>表<code>tbl</code>有一个索引<code>tbl_idx</code>，包含两列：<code>id</code>和<code>name</code>。</p>
</li>
<li>
<p>元组</p>
<p><code>tbl</code>已经插入了一些元组。</p>
<p><code>id=18, name = 'Queen'</code>的<code>Tuple_18</code>存储在0号数据页中。</p>
<p><code>id=19, name='BOSTON'</code>的<code>Tuple_19</code>存储在1号数据页中。</p>
</li>
<li>
<p>可见性</p>
<p>所有在0号页面中的元组永远可见；1号页面中的元组并不总是可见的。注意每个页的可见性信息都存储在相应的**可见性映射（visibility map）**中，关于可见性映射的描述可以参考第6.2节。</p>
</li>
</ul>
<p>我们来研究一下，当下面的<code>SELECT</code>语句执行时，PostgreSQL是如何读取元组的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BETWEEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline">   
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----+--------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Queen</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Boston</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>查询需要从表中读取两列：<code>id</code>和<code>name</code>，然而索引<code>tbl_idx</code>包含了这些列。因此在使用索引扫描时，第一眼看上去好像访问表的页面是没有必要的，因为索引中已经包含了必要的数据。然而原则上，PostgreSQL有必要需要检查这些元组的可见性，然而索引元组中并没有任何关于堆元组的事务相关信息，比如<code>t_xmin</code>和<code>t_xmax</code>，详细参考第5章。因此，PostgreSQL需要访问表数据来检查索引元组中数据的可见性，这就有点本末倒置了。</p>
<p>面对这种困境，PostgreSQL使用目标数据表对应的可见性映射表来解决此问题。如果某一页中存储所有的元组都是可见的，PostgreSQL就会使用索引元组，而不去访问索引元组指向的数据页去检查可见性；否则，PostgreSQL读取索引元组指向的数据元组并检查元组可见性，而这个就跟原来设想的一样。</p>
<p>在这个例子中，因为的0号页面被标记为可见，因此0号页面中存储的包括<code>Tuple_18</code>在内的所有元组都是可见的，所以就无需再去访问<code>Tuple_18</code>了。相应的，因为1号页面并没有被标记为可见，此时为了检查并发控制的可见性，需要访问<code>Tuple_19</code>。</p>
<p><strong>图 7.7 仅索引扫描的工作过程</strong></p>
<p><img alt="vm" src="/img/blog/kernel/fig-7-07.png"></p>
<h2 id="73-readmehot">7.3 README.HOT</h2>
<p>这是PostgreSQL官方文档中关于HOT的介绍。</p>
<h3 id="堆内元组hot">堆内元组（HOT）</h3>
<p><strong>堆内元组（HOT）<strong>功能消除了冗余索引条目，并允许在不进行表级清理的前提下，重用被删除或被更新的元组空间。这是通过<em>单页清理</em> 实现的，也称为</strong>碎片整理（defragmentation）</strong>。</p>
<p>注意：本文档末尾有一个词汇表，对于新读者可能会有所帮助。</p>
<h3 id="技术挑战">技术挑战</h3>
<p>一次一页的清理通常是不切实际的，因为找到并移除链接到待回收元组的索引项开销很大。标准清理会完整扫描索引，并确保所有这些索引项都被移除。但是将索引扫描的开销分摊到许多死元组上是可能的；这种方法向下扩展的并不好，比如只是回收几个元组。原则上，这样的问题只需要重新计算索引键，并进行标准的索引搜索找出这些索引项。但因为函数索引的存在，可能会有各种充满Bug的用户定义函数被用于函数索引，这样做会有风险。声称<code>IMMUTABLE</code>但实际上可变的函数会妨碍我们重新找到索引项（而且我们没法仅仅因为没找到索引项就报错，特别是当死掉的索引项有时候会提前回收）。这些问题可能会导致很严重的索引损坏问题，例如以这样一种形式：索引项指向了一些包含无关内容的元组槽。在任何情况下，我们都更倾向于在不调用任何用户编写的代码的情况下来进行清理。</p>
<p>HOT针对一种受限但很实用的场景解决了这一问题：当一条元组以不改变其索引键的方式被重复更新（这里，<strong>“索引列（index column）”</strong> 意味着在索引定义中引用的任何列，包括部分索引中用于条件测试但并未实际存储的列）。</p>
<p>HOT的另一个特性是它减小了索引的尺寸，通过避免创建键相等的索引项。这能提高搜索速度。</p>
<h3 id="单个索引项的更新链">单个索引项的更新链</h3>
<p>在没有HOT的情况下，在更新链条上行的每一个版本都有它们各自的索引项，尽管这些索引项中的索引列值都是相同的。在有HOT的情况下，如果一个元组被放置在与其旧元组相同的页面中，且与旧元组在索引列上值相同，那么新的元组不会产生新的索引项。这意味着在这个堆页面上的一整条更新链，只会有且仅有一条索引项。没有相应索引项的元组会被标记为<code>HEAP_ONLY_TUPLE</code>，而先前的行版本则会被标记为<code>HEAP_HOT_UPDATED</code>，而在一条更新链中，它们的<code>t_ctid</code>字段都会继续指向更新的版本。</p>
<p>举个例子：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>索引指向1
</span></span><span style="display:flex;"><span>lp [1]  [2]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[111111111]-&gt;[2222222222]
</span></span></code></pre></div><p>在上面这幅图中，索引指向了行指针1，而元组1被标记为<code>HEAP_HOT_UPDATED</code>。元组2是一个HOT元组，带有<code>HEAP_ONLY_TUPLE</code>，意味着没有索引项指向它。尽管元组2没有被索引直接引用，它仍然能够通过索引搜索被找到。当从索引遍历至元组1时，索引搜索会继续跟进其子元组，只要它看到<code>HEAP_HOT_UPDATED</code>就会尽可能远地持续前进。因为我们将HOT链限制在单个页面内，这样的操作不会导致额外的页面访问，因此也不会引入很多性能损失。</p>
<p>最后元组1不再对任何事务可见，在那个时候，它就应该被清理掉了。但是它的行指针无法被清理掉，因为索引项仍然指向该行指针，而元组2仍然需要通过索引被搜索到。HOT通过将行指针1变为一个“重定向行指针”来解决这个问题，该指针没有实际的元组与之关联，而会链接至元组2。这时候看上去应该是这样的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>索引指向1
</span></span><span style="display:flex;"><span>lp [1]-&gt;[2]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[2222222222]
</span></span></code></pre></div><p>如果现在这一行又被更新了，到了版本3，页面看上去就会是这样的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>索引指向1
</span></span><span style="display:flex;"><span>lp [1]-&gt;[2]  [3]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[2222222222]-&gt;[3333333333]
</span></span></code></pre></div><p>当没有事务能在其快照中看见元组2时，元组2和它的行指针可以被整个剪枝掉：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>索引指向1
</span></span><span style="display:flex;"><span>lp [1]------&gt;[3]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[3333333333]
</span></span></code></pre></div><p>这是安全的，因为没有指向行指针2的索引项。在该页面中，后续的插入可以回收利用行指针2和原来元组2占用的空间。</p>
<p>如果更新修改了被索引的列，或者同一页中没有空间能放下这个新元组，那么这条更新链就会结束：最后一个成员会有一个通常的<code>t_ctid</code>，指向下一个版本的位置，而且不会被标记为<code>HEAP_HOT_UPDATED</code>。（原则上讲我们是能够跨越页面继续这条HOT链的，但是这会打破我们所期望的性质：能够使用页面本地的操作回收空间。无论如何，我们都不想追着越过好几个堆页面，只是为了拿到一个索引项对应的元组，在那种情况下为新的元组创建一个新的索引项看上去会是一个更好的选择）如果后续的更新继续出现，下一个版本会成为一条新更新链的根。</p>
<p>只要当前页面中更新链还有任何活着的元组，行指针1就始终需要保留。当没有的时候，就可以将其标记为“死掉”，这就允许我们立即回收最后一个子节点的行指针与元组空间。下一次常规的VACUUM扫描会回收该索引项，以及索引项指向的这些行指针本身。因为比起元组而言行指针很小，这并不会出现过度的空间浪费。</p>
<p>注意：我们我们可以用“死掉”的行指针指向任何被删除的元组，无论它是不是HOT链中的元组。这允许我们像HOT更新一样在VACUUM之前，对普通的DELETE也可以进行空间回收。</p>
<p>进行HOT更新的必要条件是被索引的列上没有发生变化，这是在运行时检查旧值与新值的二进制表示来实现的。我们坚持位级别的相等，而不是特定于数据类型的等值比较方法。这样做的原因是后者可能会产生等价的多种表现形式。而我们并不知道索引用的是哪一种。我们假设位级别的相等保证对于所有目的的相等性都是适用的。</p>
<h3 id="中止的情形">中止的情形</h3>
<h3 id="索引扫描与顺序扫描">索引扫描与顺序扫描</h3>
<h3 id="剪枝">剪枝</h3>
<h3 id="碎片整理">碎片整理</h3>
<h3 id="什么时候使用剪枝或碎片整理">什么时候使用剪枝或碎片整理</h3>
<h3 id="清理">清理</h3>
<h3 id="统计">统计</h3>
<h3 id="创建索引">创建索引</h3>
<h3 id="并行创建索引">并行创建索引</h3>
<h3 id="并行移除索引">并行移除索引</h3>
<h3 id="局限性">局限性</h3>
<h3 id="词汇表">词汇表</h3>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-e086b4187addb45eb09f4a7211c9ea61">第八章 缓冲区管理器</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://www.interdb.jp/pg/">Hironobu SUZUKI</a> ，译者：<a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-01-04" class="text-muted">2018年01月04日</time>
        
	</div>
	<p><strong>缓冲区管理器（Buffer Manager）管</strong>理着共享内存和持久存储之间的数据传输，对于DBMS的性能有着重要的影响。PostgreSQL的缓冲区管理器十分高效。</p>
<p>本章介绍了PostgreSQL的缓冲区管理器。第一节概览了缓冲区管理器，后续的章节分别介绍以下内容：</p>
<ul>
<li>
<p>缓冲区管理器的结构</p>
</li>
<li>
<p>缓冲区管理器的锁</p>
</li>
<li>
<p>缓冲区管理器是如何工作的</p>
</li>
<li>
<p>环形缓冲区</p>
</li>
<li>
<p>脏页刷写</p>
</li>
</ul>
<p><strong>图8.1 缓冲区管理器，存储和后端进程之间的关系</strong></p>
<p><img alt="C76949F9-6362-4AA8-A5FB-9537C9A9B970" src="/img/blog/kernel/fig-8-01.png"></p>
<h2 id="81-概览">8.1 概览</h2>
<p>本节介绍了一些关键概念，有助于理解后续章节。</p>
<h3 id="811-缓冲区管理器的结构">8.1.1 缓冲区管理器的结构</h3>
<p>PostgreSQL缓冲区管理器由缓冲表，缓冲区描述符和缓冲池组成，这几个组件将在接下来的小节中介绍。 <strong>缓冲池（buffer pool）<strong>层存储着数据文件页面，诸如表页与索引页，及其相应的<a href="/zh/blog/kernel/ch5/">自由空间映射</a>和<a href="/zh/blog/kernel/ch6/">可见性映射</a>的页面。 缓冲池是一个数组，数据的每个槽中存储数据文件的一页。 缓冲池数组的序号索引称为</strong><code>buffer_id</code></strong>。8.2和8.3节描述了缓冲区管理器的内部细节。</p>
<h3 id="812-缓冲区标签buffer_tag">8.1.2 缓冲区标签（<code>buffer_tag</code>）</h3>
<p>PostgreSQL中的每个数据文件页面都可以分配到唯一的标签，即<strong>缓冲区标签（buffer tag）</strong>。 当缓冲区管理器收到请求时，PostgreSQL会用到目标页面的缓冲区标签。</p>
<p><strong>缓冲区标签（buffer_tag）</strong> 由三个值组成：<strong>关系文件节点（relfilenode）</strong>，<strong>关系分支编号（fork number）</strong>，<strong>页面块号（block number）</strong>。例如，缓冲区标签<code>{(16821, 16384, 37721), 0, 7}</code>表示，在<code>oid=16821</code>的表空间中的<code>oid=16384</code>的数据库中的<code>oid=37721</code>的表的0号分支（关系本体）的第七号页面。再比如缓冲区标签<code>{(16821, 16384, 37721), 1, 3}</code>表示该表空闲空间映射文件的三号页面。（关系本体<code>main</code>分支编号为0，空闲空间映射<code>fsm</code>分支编号为1）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * Buffer tag 标识了缓冲区中包含着哪一个磁盘块。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 注意：BufferTag中的数据必需足以在不参考pg_class或pg_tablespace中的数据项
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 的前提下，能够直接确定该块需要写入的位置。不过有可能出现这种情况：刷写缓冲区的
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 后端进程甚至都不认为自己能在那个时刻看见相应的关系（譬如，后段进程对应的的事务
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 开始时间早于创建该关系的事务）。无论如何，存储管理器都必须能应对这种情况。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 注意：如果结构中存在任何填充字节，INIT_BUFFERTAG需要将所有字段抹为零，因为整个
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 结构体被当成一个散列键来用。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">buftag</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RelFileNode</span> <span style="color:#000">rnode</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 关系的物理标识符 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ForkNumber</span>	<span style="color:#000">forkNum</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 关系的分支编号   */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BlockNumber</span> <span style="color:#000">blockNum</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 相对于关系开始位置的块号 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">BufferTag</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">RelFileNode</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Oid</span>         <span style="color:#000">spcNode</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 表空间 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Oid</span>         <span style="color:#000">dbNode</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* 数据库 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Oid</span>         <span style="color:#000">relNode</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 关系 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">RelFileNode</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h3 id="813-后端进程如何读取数据页">8.1.3 后端进程如何读取数据页</h3>
<p>本小节描述了后端进程如何从缓冲区管理器中读取页面，如图8.2所示。</p>
<p><strong>图8.2 后端进程如何读取数据页</strong></p>
<p><img src="/img/blog/kernel/fig-8-02.png"></p>
<ol>
<li>当读取表或索引页时，后端进程向缓冲区管理器发送请求，请求中带有目标页面的<code>buffer_tag</code>。</li>
<li>缓冲区管理器会根据<code>buffer_tag</code>返回一个<code>buffer_id</code>，即目标页面存储在数组中的槽位的序号。如果请求的页面没有存储在缓冲池中，那么缓冲区管理器会将页面从持久存储中加载到其中一个缓冲池槽位中，然后再返回该槽位的<code>buffer_id</code>。</li>
<li>后端进程访问<code>buffer_id</code>对应的槽位（以读取所需的页面）。</li>
</ol>
<p>当后端进程修改缓冲池中的页面时（例如向页面插入元组），这种尚未刷新到持久存储，但已被修改的页面被称为<strong>脏页（dirty page）</strong>。</p>
<p>第8.4节描述了缓冲区管理器的工作原理。</p>
<h3 id="814-页面置换算法">8.1.4 页面置换算法</h3>
<p>当所有缓冲池槽位都被占用，且其中未包含所请求的页面时，缓冲区管理器必须在缓冲池中选择一个页面逐出，用于放置被请求的页面。 在计算机科学领域中，选择页面的算法通常被称为<strong>页面置换算法（page replacement algorithms）</strong>，而所选择的页面被称为<strong>受害者页面（victim page）</strong>。</p>
<p>针对页面置换算法的研究从计算机科学出现以来就一直在进行，因此先前已经提出过很多置换算法了。 从8.1版本开始，PostgreSQL使用**时钟扫描（clock-sweep）**算法，因为比起以前版本中使用的LRU算法，它更为简单高效。</p>
<p>第8.4.4节描述了时钟扫描的细节。</p>
<h3 id="815-刷写脏页">8.1.5 刷写脏页</h3>
<p>脏页最终应该被刷入存储，但缓冲区管理器执行这个任务需要额外帮助。 在PostgreSQL中，两个后台进程：**检查点进程（checkpointer）<strong>和</strong>后台写入器（background writer）**负责此任务。</p>
<p>8.6节描述了检查点进程和后台写入器。</p>
<blockquote>
<h4 id="直接iodirect-io">直接I/O（Direct I/O）</h4>
<p>PostgreSQL并<strong>不</strong>支持直接I/O，但有时会讨论它。 如果你想了解更多详细信息，可以参考<a href="https://lwn.net/Articles/580542/">这篇文章</a>，以及pgsql-ML中的这个<a href="https://www.postgresql.org/message-id/529E267F.4050700@agliodbs.com">讨论</a>。</p>
</blockquote>
<h2 id="82-缓冲区管理器的结构">8.2 缓冲区管理器的结构</h2>
<p>PostgreSQL缓冲区管理器由三层组成，即<strong>缓冲表层</strong>，<strong>缓冲区描述符层</strong>和<strong>缓冲池层</strong>（图8.3）：</p>
<p><strong>图8.3 缓冲区管理器的三层结构</strong></p>
<p><img src="/img/blog/kernel/fig-8-03.png"></p>
<ul>
<li>
<p>**缓冲池（buffer pool）**层是一个数组。 每个槽都存储一个数据文件页，数组槽的索引称为<code>buffer_id</code>。</p>
</li>
<li>
<p>**缓冲区描述符（buffer descriptors）**层是一个由缓冲区描述符组成的数组。 每个描述符与缓冲池槽一一对应，并保存着相应槽的元数据。请注意，术语“<strong>缓冲区描述符层</strong>”只是在本章中为方便起见使用的术语。</p>
</li>
<li>
<p>**缓冲表（buffer table）**层是一个哈希表，它存储着页面的<code>buffer_tag</code>与描述符的<code>buffer_id</code>之间的映射关系。</p>
</li>
</ul>
<p>这些层将在以下的节中详细描述。</p>
<h3 id="821-缓冲表">8.2.1 缓冲表</h3>
<p>缓冲表可以在逻辑上分为三个部分：散列函数，散列桶槽，以及数据项（图8.4）。</p>
<p>内置散列函数将<code>buffer_tag</code>映射到哈希桶槽。 即使散列桶槽的数量比缓冲池槽的数量要多，冲突仍然可能会发生。因此缓冲表采用了**使用链表的分离链接方法（separate chaining with linked lists）**来解决冲突。 当数据项被映射到至同一个桶槽时，该方法会将这些数据项保存在一个链表中，如图8.4所示。</p>
<p><strong>图8.4 缓冲表</strong></p>
<p><img src="/img/blog/kernel/fig-8-04.png"></p>
<p>数据项包括两个值：页面的<code>buffer_tag</code>，以及包含页面元数据的描述符的<code>buffer_id</code>。例如数据项<code>Tag_A,id=1</code> 表示，<code>buffer_id=1</code>对应的缓冲区描述符中，存储着页面<code>Tag_A</code>的元数据。</p>
<blockquote>
<h4 id="散列函数">散列函数</h4>
<p>这里使用的散列函数是由<a href="https://doxygen.postgresql.org/dynahash_8c.html#ae802f2654df749ae0e0aadf4b5c5bcbd"><code>calc_bucket()</code></a>与 <a href="https://doxygen.postgresql.org/rege__dfa_8c.html#a6aa3a27e7a0fc6793f3329670ac3b0cb"><code>hash()</code></a>组合而成。 下面是用伪函数表示的形式。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">uint32</span> <span style="color:#000">bucket_slot</span> <span style="color:#ce5c00;font-weight:bold">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">calc_bucket</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#000">hash</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BufferTag</span> <span style="color:#000">buffer_tag</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">uint32</span> <span style="color:#000">bucket_size</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div></blockquote>
<p>这里还没有对诸如查找、插入、删除数据项的基本操作进行解释。这些常见的操作将在后续小节详细描述。</p>
<h3 id="822-缓冲区描述符">8.2.2 缓冲区描述符</h3>
<p>本节将描述缓冲区描述符的结构，下一小节将描述缓冲区描述符层。</p>
<p><strong>缓冲区描述符</strong>保存着页面的元数据，这些与缓冲区描述符相对应的页面保存在缓冲池槽中。缓冲区描述符的结构由<a href="https://github.com/postgres/postgres/blob/REL9_5_STABLE/src/include/storage/buf_internals.h"><code>BufferDesc</code></a>结构定义。这个结构有很多字段，主要字段如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* src/include/storage/buf_internals.h  (before 9.6) */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 缓冲区描述符的标记位定义(since 9.6)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 注意：TAG_VALID实际上意味着缓冲区哈希表中有一条与本tag关联的项目。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_DIRTY                (1 &lt;&lt; 0)    </span><span style="color:#8f5902;font-style:italic">/* 数据需要写入 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_VALID                (1 &lt;&lt; 1)    </span><span style="color:#8f5902;font-style:italic">/* 数据有效 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_TAG_VALID            (1 &lt;&lt; 2)    </span><span style="color:#8f5902;font-style:italic">/* 已经分配标签 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_IO_IN_PROGRESS       (1 &lt;&lt; 3)    </span><span style="color:#8f5902;font-style:italic">/* 读写进行中 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_IO_ERROR             (1 &lt;&lt; 4)    </span><span style="color:#8f5902;font-style:italic">/* 先前的I/O失败 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_JUST_DIRTIED         (1 &lt;&lt; 5)    </span><span style="color:#8f5902;font-style:italic">/* 写之前已经脏了 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_PIN_COUNT_WAITER     (1 &lt;&lt; 6)    </span><span style="color:#8f5902;font-style:italic">/* 有人等着钉页面 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_CHECKPOINT_NEEDED    (1 &lt;&lt; 7)    </span><span style="color:#8f5902;font-style:italic">/* 必需在检查点时写入 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_PERMANENT            (1 &lt;&lt; 8)    </span><span style="color:#8f5902;font-style:italic">/* 永久缓冲(不是unlogged) */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* BufferDesc -- 单个共享缓冲区的共享描述符/共享状态
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 注意: 读写tag, flags, usage_count, refcount, wait_backend_pid等字段时必须持有
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * buf_hdr_lock锁。buf_id字段在初始化之后再也不会改变，所以不需要锁。freeNext是通过
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * buffer_strategy_lock来保护的，而不是buf_hdr_lock。LWLocks字段可以自己管好自己。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 注意buf_hdr_lock *不是* 用来控制对缓冲区内数据的访问的！
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 一个例外是，如果我们固定了(pinned)缓冲区，它的标签除了我们自己之外不会被偷偷修改。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 所以我们无需锁定自旋锁就可以检视该标签。此外，一次性的标记读取也无需锁定自旋锁，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 当我们期待测试标记位不会改变时，这种做法很常见。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 如果另一个后端固定了该缓冲区，我们就无法从磁盘页面上物理移除项目了。因此后端需要等待
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 所有其他的钉被移除。移除时它会得到通知，这是通过将它的PID存到wait_backend_pid，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 并设置BM_PIN_COUNT_WAITER标记为而实现的。就目前而言，每个缓冲区只能有一个等待者。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 对于本地缓冲区，我们也使用同样的首部，不过锁字段就没用了，一些标记位也没用了。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sbufdesc</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">BufferTag</span>    <span style="color:#000">tag</span><span style="color:#000;font-weight:bold">;</span>                 <span style="color:#8f5902;font-style:italic">/* 存储在缓冲区中页面的标识 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">BufFlags</span>     <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">;</span>               <span style="color:#8f5902;font-style:italic">/* 标记位 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">uint16</span>       <span style="color:#000">usage_count</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* 时钟扫描要用到的引用计数 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">unsigned</span>     <span style="color:#000">refcount</span><span style="color:#000;font-weight:bold">;</span>            <span style="color:#8f5902;font-style:italic">/* 在本缓冲区上持有pin的后端进程数 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">int</span>          <span style="color:#000">wait_backend_pid</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* 等着Pin本缓冲区的后端进程PID */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">slock_t</span>      <span style="color:#000">buf_hdr_lock</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 用于保护上述字段的锁 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">int</span>          <span style="color:#000">buf_id</span><span style="color:#000;font-weight:bold">;</span>              <span style="color:#8f5902;font-style:italic">/* 缓冲的索引编号 (从0开始) */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">int</span>          <span style="color:#000">freeNext</span><span style="color:#000;font-weight:bold">;</span>            <span style="color:#8f5902;font-style:italic">/* 空闲链表中的链接 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">LWLockId</span>     <span style="color:#000">io_in_progress_lock</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 等待I/O完成的锁 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">LWLockId</span>     <span style="color:#000">content_lock</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 访问缓冲区内容的锁 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">BufferDesc</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><ul>
<li>
<p><strong><code>tag</code></strong> 保存着目标页面的<code>buffer_tag</code>，该页面存储在相应的缓冲池槽中（缓冲区标签的定义在8.1.2节给出）。</p>
</li>
<li>
<p><strong><code>buffer_id</code></strong> 标识了缓冲区描述符（亦相当于对应缓冲池槽的<code>buffer_id</code>）。</p>
</li>
<li>
<p><strong><code>refcount</code></strong> 保存当前访问相应页面的PostgreSQL进程数，也被称为<strong>钉数（pin count）</strong>。当PostgreSQL进程访问相应页面时，其引用计数必须自增1（<code>refcount ++</code>）。访问结束后其引用计数必须减1（<code>refcount--</code>）。 当<code>refcount</code>为零，即页面当前并未被访问时，页面将<strong>取钉（unpinned）</strong> ，否则它会被<strong>钉住（pinned）</strong>。</p>
</li>
<li>
<p><strong><code>usage_count</code></strong> 保存着相应页面加载至相应缓冲池槽后的访问次数。<code>usage_count</code>会在页面置换算法中被用到（第8.4.4节）。</p>
</li>
<li>
<p><strong><code>context_lock</code></strong> 和 **<code>io_in_progress_lock</code>**是轻量级锁，用于控制对相关页面的访问。第8.3.2节将介绍这些字段。</p>
</li>
<li>
<p><strong><code>flags</code></strong> 用于保存相应页面的状态，主要状态如下：</p>
<ul>
<li><strong>脏位（<code>dirty bit</code>）</strong> 指明相应页面是否为脏页。</li>
<li><strong>有效位（<code>valid bit</code>）</strong> 指明相应页面是否可以被读写（有效）。例如，如果该位被设置为<code>&quot;valid&quot;</code>，那就意味着对应的缓冲池槽中存储着一个页面，而该描述符中保存着该页面的元数据，因而可以对该页面进行读写。反之如果有效位被设置为<code>&quot;invalid&quot;</code>，那就意味着该描述符中并没有保存任何元数据；即，对应的页面无法读写，缓冲区管理器可能正在将该页面换出。</li>
<li>IO进行标记位（<strong><code>io_in_progress</code></strong>） 指明缓冲区管理器是否正在从存储中读/写相应页面。换句话说，该位指示是否有一个进程正持有此描述符上的<code>io_in_pregress_lock</code>。</li>
</ul>
</li>
<li>
<p><strong><code>freeNext</code></strong> 是一个指针，指向下一个描述符，并以此构成一个空闲列表（<code>freelist</code>），细节在下一小节中介绍。</p>
</li>
</ul>
<blockquote>
<p>结构<code>BufferDesc</code>定义于<a href="https://github.com/postgres/postgres/blob/master/src/include/storage/buf_internals.h"><code>src/include/storage/buf_internals.h</code></a>中。</p>
</blockquote>
<p>为了简化后续章节的描述，这里定义三种描述符状态：</p>
<ul>
<li><strong>空（<code>Empty</code>）</strong>：当相应的缓冲池槽不存储页面（即<code>refcount</code>与<code>usage_count</code>都是0），该描述符的状态为<strong>空</strong>。</li>
<li><strong>钉住（<code>Pinned</code>）</strong>：当相应缓冲池槽中存储着页面，且有PostgreSQL进程正在访问的相应页面（即<code>refcount</code>和<code>usage_count</code>都大于等于1），该缓冲区描述符的状态为<strong>钉住</strong>。</li>
<li><strong>未钉住（<code>Unpinned</code>）</strong>：当相应的缓冲池槽存储页面，但没有PostgreSQL进程正在访问相应页面时（即 <code>usage_count</code>大于或等于1，但<code>refcount</code>为0），则此缓冲区描述符的状态为<strong>未钉住</strong>。</li>
</ul>
<p>每个描述符都处于上述状态之一。描述符的状态会根据特定条件而改变，这将在下一小节中描述。</p>
<p>在下图中，缓冲区描述符的状态用彩色方框表示。</p>
<ul>
<li>${□}$（白色）<strong>空</strong></li>
<li>$\color{blue}{█}$（蓝色）钉住</li>
</ul>
<ul>
<li>$\color{cyan}{█}$（青色）未钉住</li>
</ul>
<p>此外，脏页面会带有“X”的标记。例如一个未固定的脏描述符用 $\color{cyan}☒$ 表示。</p>
<h3 id="823-缓冲区描述符层">8.2.3 缓冲区描述符层</h3>
<p>缓冲区描述符的集合构成了一个数组。本书称该数组为<strong>缓冲区描述符层（buffer descriptors layer）</strong>。</p>
<p>当PostgreSQL服务器启动时，所有缓冲区描述符的状态都为<strong>空</strong>。在PostgreSQL中，这些描述符构成了一个名为**<code>freelist</code>**的链表，如图8.5所示。</p>
<p><strong>图8.5 缓冲区管理器初始状态</strong></p>
<p><img src="/img/blog/kernel/fig-8-05.png"></p>
<blockquote>
<p>请注意PostgreSQL中的**<code>freelist</code>**完全不同于Oracle中<code>freelists</code>的概念。PostgreSQL的<code>freelist</code>只是空缓冲区描述符的链表。PostgreSQL中与Oracle中的<code>freelist</code>相对应的对象是空闲空间映射（FSM）（第5.3.4节）。</p>
</blockquote>
<p>图8.6展示了第一个页面是如何加载的。</p>
<ol>
<li>从<code>freelist</code>的头部取一个空描述符，并将其钉住（即，将其<code>refcount</code>和<code>usage_count</code>增加1）。</li>
<li>在缓冲表中插入新项，该缓冲表项保存了页面<code>buffer_tag</code>与所获描述符<code>buffer_id</code>之间的关系。</li>
<li>将新页面从存储器加载至相应的缓冲池槽中。</li>
<li>将新页面的元数据保存至所获取的描述符中。</li>
</ol>
<p>第二页，以及后续页面都以类似方式加载，其他细节将在第8.4.2节中介绍。</p>
<p><strong>图8.6 加载第一页</strong></p>
<p><img src="/img/blog/kernel/fig-8-06.png"></p>
<p>从<code>freelist</code>中摘出的描述符始终保存着页面的元数据。换而言之，仍然在使用的非空描述符不会返还到<code>freelist</code>中。但当下列任一情况出现时，描述符状态将变为“空”，并被重新插入至<code>freelist</code>中：</p>
<ol>
<li>相关表或索引已被删除。</li>
<li>相关数据库已被删除。</li>
<li>相关表或索引已经被<code>VACUUM FULL</code>命令清理了。</li>
</ol>
<blockquote>
<h4 id="为什么使用freelist来维护空描述符">为什么使用<code>freelist</code>来维护空描述符？</h4>
<p>保留<code>freelist</code>的原因是为了能立即获取到一个描述符。这是内存动态分配的常规做法，详情参阅这里的<a href="https://en.wikipedia.org/wiki/Free_list">说明</a>。</p>
</blockquote>
<p><strong>缓冲区描述符层</strong>包含着一个32位无符号整型变量**<code>nextVictimBuffer</code>**。此变量用于8.4.4节将介绍的页面置换算法。</p>
<h3 id="824-缓冲池">8.2.4 缓冲池</h3>
<p>缓冲池只是一个用于存储关系数据文件（例如表或索引）页面的简单数组。缓冲池数组的序号索引也就是<code>buffer_id</code>。</p>
<p>缓冲池槽的大小为8KB，等于页面大小，因而每个槽都能存储整个页面。</p>
<h2 id="83-缓冲区管理器锁">8.3 缓冲区管理器锁</h2>
<p>缓冲区管理器会出于不同的目的使用各式各样的锁，本节将介绍理解后续部分所必须的一些锁。</p>
<blockquote>
<p>注意本节中描述的锁，指的是是缓冲区管理器<strong>同步机制</strong>的一部分。它们与SQL语句和SQL操作中的锁没有任何关系。</p>
</blockquote>
<h3 id="831-缓冲表锁">8.3.1 缓冲表锁</h3>
<p>**<code>BufMappingLock</code>**保护整个缓冲表的数据完整性。它是一种轻量级的锁，有共享模式与独占模式。在缓冲表中查询条目时，后端进程会持有共享的<code>BufMappingLock</code>。插入或删除条目时，后端进程会持有独占的<code>BufMappingLock</code>。</p>
<p><code>BufMappingLock</code>会被分为多个分区，以减少缓冲表中的争用（默认为128个分区）。每个<code>BufMappingLock</code>分区都保护着一部分相应的散列桶槽。</p>
<p>图8.7给出了一个<code>BufMappingLock</code>分区的典型示例。两个后端进程可以同时持有各自分区的<code>BufMappingLock</code>独占锁以插入新的数据项。如果<code>BufMappingLock</code>是系统级的锁，那么其中一个进程就需要等待另一个进程完成处理。</p>
<p><strong>图8.7 两个进程同时获取相应分区的<code>BufMappingLock</code>独占锁，以插入新数据项</strong></p>
<p><img src="/img/blog/kernel/fig-8-07.png"></p>
<p>缓冲表也需要许多其他锁。例如，在缓冲表内部会使用**自旋锁（spin lock）**来删除数据项。不过本章不需要其他这些锁的相关知识，因此这里省略了对其他锁的介绍。</p>
<blockquote>
<p>在9.4版本之前，<code>BufMappingLock</code>在默认情况下被分为16个独立的锁。</p>
</blockquote>
<h3 id="832-缓冲区描述符相关的锁">8.3.2 缓冲区描述符相关的锁</h3>
<p>每个缓冲区描述符都会用到两个轻量级锁 —— <strong><code>content_lock</code></strong> 与 <strong><code>io_in_progress_lock</code></strong>，来控制对相应缓冲池槽页面的访问。当检查或更改描述符本身字段的值时，则会用到自旋锁。</p>
<h4 id="8321-内容锁content_lock">8.3.2.1 内容锁（<code>content_lock</code>）</h4>
<p><code>content_lock</code>是一个典型的强制限制访问的锁。它有两种模式：<strong>共享（shared）</strong> 与<strong>独占（exclusive）</strong>。</p>
<p>当读取页面时，后端进程以共享模式获取页面相应缓冲区描述符中的<code>content_lock</code>。</p>
<p>但执行下列操作之一时，则会获取独占模式的<code>content_lock</code>：</p>
<ul>
<li>将行（即元组）插入页面，或更改页面中元组的<code>t_xmin/t_xmax</code>字段时（<code>t_xmin</code>和<code>t_xmax</code>在<a href="/zh/blog/kernel/ch5/">第5.2节</a>中介绍，简单地说，这些字段会在相关元组被删除或更新行时发生更改）。</li>
<li>物理移除元组，或压紧页面上的空闲空间（由清理过程和HOT执行，分别在<a href="http://www.interdb.jp/pg/pgsql06.html">第6章</a>和<a href="http://www.interdb.jp/pg/pgsql06.html">第7章</a>中介绍）。</li>
<li>冻结页面中的元组（冻结过程在<a href="/zh/blog/kernel/ch5/">第5.10.1节</a>与<a href="/zh/blog/kernel/ch6/">第6.3节</a>中介绍）。</li>
</ul>
<p>官方<a href="https://github.com/postgres/postgres/blob/master/src/backend/storage/buffer/README"><code>README</code></a>文件包含更多的细节。</p>
<h4 id="8322-io进行锁io_in_progress_lock">8.3.2.2 IO进行锁（<code>io_in_progress_lock</code>）</h4>
<p><code>io_in_progress_lock</code>用于等待缓冲区上的I/O完成。当PostgreSQL进程加载/写入页面数据时，该进程在访问页面期间，持有对应描述符上独占的<code>io_in_progres_lock</code>。</p>
<h4 id="8323-自旋锁spinlock">8.3.2.3 自旋锁（<code>spinlock</code>）</h4>
<p>当检查或更改标记字段与其他字段时（例如<code>refcount</code>和<code>usage_count</code>），会用到自旋锁。下面是两个使用自旋锁的具体例子：</p>
<ol>
<li>下面是<strong>钉住</strong>缓冲区描述符的例子：
<ol>
<li>获取缓冲区描述符上的自旋锁。</li>
<li>将其<code>refcount</code>和<code>usage_count</code>的值增加1。</li>
<li>释放自旋锁。</li>
</ol>
</li>
</ol>
<ul>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">LockBufHdr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bufferdesc</span><span style="color:#000;font-weight:bold">);</span>    <span style="color:#8f5902;font-style:italic">/* 获取自旋锁 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000">bufferdesc</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">refcont</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">bufferdesc</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">usage_count</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">UnlockBufHdr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bufferdesc</span><span style="color:#000;font-weight:bold">);</span>  <span style="color:#8f5902;font-style:italic">/* 释放该自旋锁 */</span>
</span></span></code></pre></div></li>
</ul>
<ol start="2">
<li>
<p>下面是将脏位设置为<code>&quot;1&quot;</code>的例子：</p>
<ol>
<li>获取缓冲区描述符上的自旋锁。</li>
<li>使用位操作将脏位置位为<code>&quot;1&quot;</code>。</li>
<li>释放自旋锁。</li>
</ol>
</li>
</ol>
<ul>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_DIRTY             (1 &lt;&lt; 0)    </span><span style="color:#8f5902;font-style:italic">/* 数据需要写回 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_VALID             (1 &lt;&lt; 1)    </span><span style="color:#8f5902;font-style:italic">/* 数据有效 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_TAG_VALID         (1 &lt;&lt; 2)    </span><span style="color:#8f5902;font-style:italic">/* 已经分配了TAG */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_IO_IN_PROGRESS    (1 &lt;&lt; 3)    </span><span style="color:#8f5902;font-style:italic">/* 正在进行读写 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_JUST_DIRTIED      (1 &lt;&lt; 5)    </span><span style="color:#8f5902;font-style:italic">/* 开始写之后刚写脏 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000">LockBufHdr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bufferdesc</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">bufferdesc</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">flags</span> <span style="color:#ce5c00;font-weight:bold">|=</span> <span style="color:#000">BM_DIRTY</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">UnlockBufHdr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bufferdesc</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div>其他标记位也是通过同样的方式来设置的。</li>
</ul>
<blockquote>
<h4 id="用原子操作替换缓冲区管理器的自旋锁">用原子操作替换缓冲区管理器的自旋锁</h4>
<p>在9.6版本中，缓冲区管理器的自旋锁被替换为原子操作，可以参考这个<a href="https://commitfest.postgresql.org/9/408/">提交日志</a>的内容。如果想进一步了解详情，可以参阅这里的<a href="http://www.postgresql.org/message-id/flat/2400449.GjM57CE0Yg@dinodell#2400449.GjM57CE0Yg@dinodell">讨论</a>。</p>
<p>附，9.6版本中缓冲区描述符的数据结构定义。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* src/include/storage/buf_internals.h  (since 9.6, 移除了一些字段) */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 缓冲区描述符的标记位定义(since 9.6)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 注意：TAG_VALID实际上意味着缓冲区哈希表中有一条与本tag关联的项目。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_LOCKED				(1U &lt;&lt; 22)	</span><span style="color:#8f5902;font-style:italic">/* 缓冲区首部被锁定 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_DIRTY				(1U &lt;&lt; 23)	</span><span style="color:#8f5902;font-style:italic">/* 数据需要写入 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_VALID				(1U &lt;&lt; 24)	</span><span style="color:#8f5902;font-style:italic">/* 数据有效 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_TAG_VALID			(1U &lt;&lt; 25)	</span><span style="color:#8f5902;font-style:italic">/* 标签有效，已经分配 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_IO_IN_PROGRESS		(1U &lt;&lt; 26)	</span><span style="color:#8f5902;font-style:italic">/* 读写进行中 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_IO_ERROR				(1U &lt;&lt; 27)	</span><span style="color:#8f5902;font-style:italic">/* 先前的I/O失败 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_JUST_DIRTIED			(1U &lt;&lt; 28)	</span><span style="color:#8f5902;font-style:italic">/* 写之前已经脏了 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_PIN_COUNT_WAITER		(1U &lt;&lt; 29)	</span><span style="color:#8f5902;font-style:italic">/* 有人等着钉页面 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_CHECKPOINT_NEEDED	(1U &lt;&lt; 30)	</span><span style="color:#8f5902;font-style:italic">/* 必需在检查点时写入 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BM_PERMANENT			(1U &lt;&lt; 31)	</span><span style="color:#8f5902;font-style:italic">/* 永久缓冲 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* BufferDesc -- 单个共享缓冲区的共享描述符/共享状态
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 注意: 读写tag, state, wait_backend_pid 等字段时必须持有缓冲区首部锁(BM_LOCKED标记位)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 简单地说，refcount, usagecount,标记位组合起来被放入一个原子变量state中，而缓冲区首部锁
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 实际上是嵌入标记位中的一个bit。 这种设计允许我们使用单个原子操作，而不是获取/释放自旋锁
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 来实现一些操作。举个例子，refcount的增减。buf_id字段在初始化之后再也不会改变，所以不需要锁。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * freeNext是通过buffer_strategy_lock而非buf_hdr_lock来保护的。LWLocks字段可以自己管好自
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 己。注意buf_hdr_lock *不是* 用来控制对缓冲区内数据的访问的！
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 我们假设当持有首部锁时，没人会修改state字段。因此持有缓冲区首部锁的人可以在一次写入中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 中对state变量进行很复杂的更新，包括更新完的同时释放锁（清理BM_LOCKED标记位）。此外，不持有
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 缓冲区首部锁而对state进行更新仅限于CAS操作，它能确保操作时BM_LOCKED标记位没有被置位。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 不允许使用原子自增/自减，OR/AND等操作。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 一个例外是，如果我们固定了(pinned)该缓冲区，它的标签除了我们自己之外不会被偷偷修改。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 所以我们无需锁定自旋锁就可以检视该标签。此外，一次性的标记读取也无需锁定自旋锁，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 当我们期待测试标记位不会改变时，这种做法很常见。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 如果另一个后端固定了该缓冲区，我们就无法从磁盘页面上物理移除项目了。因此后端需要等待
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 所有其他的钉被移除。移除时它会得到通知，这是通过将它的PID存到wait_backend_pid，并设置
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * BM_PIN_COUNT_WAITER标记为而实现的。目前而言，每个缓冲区只能有一个等待者。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 对于本地缓冲区，我们也使用同样的首部，不过锁字段就没用了，一些标记位也没用了。为了避免不必要
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 的额外开销，对state字段的操作不需要用实际的原子操作（即pg_atomic_read_u32，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * pg_atomic_unlocked_write_u32）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 增加该结构的尺寸，增减，重排该结构的成员时需要特别小心。保证该结构体小于64字节对于性能
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 至关重要(最常见的CPU缓存线尺寸)。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">BufferDesc</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BufferTag</span>	<span style="color:#000">tag</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 存储在缓冲区中页面的标识 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span>			<span style="color:#000">buf_id</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 缓冲区的索引编号 (从0开始) */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 标记的状态，包含标记位，引用计数，使用计数 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* 9.6使用原子操作替换了很多字段的功能 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pg_atomic_uint32</span> <span style="color:#000">state</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span>			<span style="color:#000">wait_backend_pid</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 等待钉页计数的后端进程PID */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span>			<span style="color:#000">freeNext</span><span style="color:#000;font-weight:bold">;</span>		    <span style="color:#8f5902;font-style:italic">/* 空闲链表中的链接 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">LWLock</span>		<span style="color:#000">content_lock</span><span style="color:#000;font-weight:bold">;</span>	    <span style="color:#8f5902;font-style:italic">/* 访问缓冲内容的锁 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">BufferDesc</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div></blockquote>
<h2 id="84-缓冲区管理器的工作原理">8.4 缓冲区管理器的工作原理</h2>
<p>本节介绍缓冲区管理器的工作原理。当后端进程想要访问所需页面时，它会调用<code>ReadBufferExtended</code>函数。</p>
<p>函数<code>ReadBufferExtended</code>的行为依场景而异，在逻辑上具体可以分为三种情况。每种情况都将用一小节介绍。最后一小节将介绍PostgreSQL中基于**时钟扫描（clock-sweep）**的页面置换算法。</p>
<h3 id="841-访问存储在缓冲池中的页面">8.4.1 访问存储在缓冲池中的页面</h3>
<p>首先来介绍最简单的情况，即，所需页面已经存储在缓冲池中。在这种情况下，缓冲区管理器会执行以下步骤：</p>
<ol>
<li>创建所需页面的<code>buffer_tag</code>（在本例中<code>buffer_tag</code>是<code>'Tag_C'</code>），并使用散列函数计算与描述符相对应的散列桶槽。</li>
<li>获取相应散列桶槽分区上的<code>BufMappingLock</code>共享锁（该锁将在步骤(5)中被释放）。</li>
<li>查找标签为<code>&quot;Tag_C&quot;</code>的条目，并从条目中获取<code>buffer_id</code>。本例中<code>buffer_id</code>为2。</li>
<li>将<code>buffer_id=2</code>的缓冲区描述符钉住，即将描述符的<code>refcount</code>和<code>usage_count</code>增加1（8.3.2节描述了钉住）。</li>
<li>释放<code>BufMappingLock</code>。</li>
<li>访问<code>buffer_id=2</code>的缓冲池槽。</li>
</ol>
<p><strong>图8.8 访问存储在缓冲池中的页面。</strong></p>
<p><img src="/img/blog/kernel/fig-8-08.png"></p>
<p>然后，当从缓冲池槽中的页面里读取行时，PostgreSQL进程获取相应缓冲区描述符的共享<code>content_lock</code>。因而缓冲池槽可以同时被多个进程读取。</p>
<p>当向页面插入（及更新、删除）行时，该postgres后端进程获取相应缓冲区描述符的独占<code>content_lock</code>（注意这里必须将相应页面的脏位置位为<code>&quot;1&quot;</code>）。</p>
<p>访问完页面后，相应缓冲区描述符的引用计数值减1。</p>
<h3 id="842-将页面从存储加载至空槽">8.4.2 将页面从存储加载至空槽</h3>
<p>在第二种情况下，假设所需页面不在缓冲池中，且<code>freelist</code>中有空闲元素（空描述符）。在这种情况下，缓冲区管理器将执行以下步骤：</p>
<ol>
<li>
<p>查找缓冲区表（本节假设页面不存在，找不到对应页面）。</p>
<ol>
<li>
<p>创建所需页面的<code>buffer_tag</code>（本例中<code>buffer_tag</code>为<code>'Tag_E'</code>）并计算其散列桶槽。</p>
</li>
<li>
<p>以共享模式获取相应分区上的<code>BufMappingLock</code>。</p>
</li>
<li>
<p>查找缓冲区表（根据假设，这里没找到）。</p>
</li>
<li>
<p>释放<code>BufMappingLock</code>。</p>
</li>
</ol>
</li>
<li>
<p>从<code>freelist</code>中获取<strong>空缓冲区描述符</strong>，并将其钉住。在本例中所获的描述符<code>buffer_id=4</code>。</p>
</li>
<li>
<p>以<strong>独占</strong>模式获取相应分区的<code>BufMappingLock</code>（此锁将在步骤(6)中被释放）。</p>
</li>
<li>
<p>创建一条新的缓冲表数据项：<code>buffer_tag='Tag_E’, buffer_id=4</code>，并将其插入缓冲区表中。</p>
</li>
<li>
<p>将页面数据从存储加载至<code>buffer_id=4</code>的缓冲池槽中，如下所示：</p>
<ol>
<li>
<p>以排他模式获取相应描述符的<code>io_in_progress_lock</code>。</p>
</li>
<li>
<p>将相应描述符的<code>IO_IN_PROGRESS</code>标记位设置为<code>1</code>，以防其他进程访问。</p>
</li>
<li>
<p>将所需的页面数据从存储加载到缓冲池插槽中。</p>
</li>
<li>
<p>更改相应描述符的状态；将<code>IO_IN_PROGRESS</code>标记位置位为<code>&quot;0&quot;</code>，且<code>VALID</code>标记位被置位为<code>&quot;1&quot;</code>。</p>
</li>
<li>
<p>释放<code>io_in_progress_lock</code>。</p>
</li>
</ol>
</li>
<li>
<p>释放相应分区的<code>BufMappingLock</code>。</p>
</li>
<li>
<p>访问<code>buffer_id=4</code>的缓冲池槽。</p>
</li>
</ol>
<p><strong>图8.9 将页面从存储装载到空插槽</strong></p>
<p><img src="/img/blog/kernel/fig-8-09.png"></p>
<h3 id="843-将页面从存储加载至受害者缓冲池槽中">8.4.3 将页面从存储加载至受害者缓冲池槽中</h3>
<p>在这种情况下，假设所有缓冲池槽位都被页面占用，且未存储所需的页面。缓冲区管理器将执行以下步骤：</p>
<ol>
<li>
<p>创建所需页面的<code>buffer_tag</code>并查找缓冲表。在本例中假设<code>buffer_tag</code>是<code>'Tag_M'</code>（且相应的页面在缓冲区中找不到）。</p>
</li>
<li>
<p>使用时钟扫描算法选择一个受害者缓冲池槽位，从缓冲表中获取包含着受害者槽位<code>buffer_id</code>的旧表项，并在缓冲区描述符层将受害者槽位的缓冲区描述符钉住。本例中受害者槽的<code>buffer_id=5</code>，旧表项为<code>Tag_F, id = 5</code>。时钟扫描将在下一节中介绍。</p>
</li>
<li>
<p>如果受害者页面是脏页，将其刷盘（<code>write &amp; fsync</code>），否则进入步骤(4)。</p>
<p>在使用新数据覆盖脏页之前，必须将脏页写入存储中。脏页的刷盘步骤如下：</p>
<ol>
<li>
<p>获取<code>buffer_id=5</code>描述符上的共享<code>content_lock</code>和独占<code>io_in_progress_lock</code>（在步骤6中释放）。</p>
</li>
<li>
<p>更改相应描述符的状态：相应<code>IO_IN_PROCESS</code>位被设置为<code>&quot;1&quot;</code>，<code>JUST_DIRTIED</code>位设置为<code>&quot;0&quot;</code>。</p>
</li>
<li>
<p>根据具体情况，调用<code>XLogFlush()</code>函数将WAL缓冲区上的WAL数据写入当前WAL段文件（详细信息略，WAL和<code>XLogFlush</code>函数在<a href="/zh/blog/kernel/ch9/">第9章</a>中介绍）。</p>
</li>
<li>
<p>将受害者页面的数据刷盘至存储中。</p>
</li>
<li>
<p>更改相应描述符的状态；将<code>IO_IN_PROCESS</code>位设置为<code>&quot;0&quot;</code>，将<code>VALID</code>位设置为<code>&quot;1&quot;</code>。</p>
</li>
<li>
<p>释放<code>io_in_progress_lock</code>和<code>content_lock</code>。</p>
</li>
</ol>
</li>
<li>
<p>以排他模式获取缓冲区表中旧表项所在分区上的<code>BufMappingLock</code>。</p>
</li>
<li>
<p>获取新表项所在分区上的<code>BufMappingLock</code>，并将新表项插入缓冲表：</p>
<ol>
<li>创建由新表项：由<code>buffer_tag='Tag_M'</code>与受害者的<code>buffer_id</code>组成的新表项。</li>
<li>以独占模式获取新表项所在分区上的<code>BufMappingLock</code>。</li>
<li>将新表项插入缓冲区表中。</li>
</ol>
</li>
</ol>
<p><strong>图8.10 将页面从存储加载至受害者缓冲池槽</strong></p>
<p><img src="/img/blog/kernel/fig-8-10.png"></p>
<ol start="6">
<li>
<p>从缓冲表中删除旧表项，并释放旧表项所在分区的<code>BufMappingLock</code>。</p>
</li>
<li>
<p>将目标页面数据从存储加载至受害者槽位。然后用<code>buffer_id=5</code>更新描述符的标识字段；将脏位设置为0，并按流程初始化其他标记位。</p>
</li>
<li>
<p>释放新表项所在分区上的<code>BufMappingLock</code>。</p>
</li>
<li>
<p>访问<code>buffer_id=5</code>对应的缓冲区槽位。</p>
</li>
</ol>
<p><strong>图8.11 将页面从存储加载至受害者缓冲池槽（接图8.10）</strong></p>
<p><img src="/img/blog/kernel/fig-8-11.png"></p>
<h3 id="844-页面替换算法时钟扫描">8.4.4 页面替换算法：时钟扫描</h3>
<p>本节的其余部分介绍了**时钟扫描（clock-sweep）<strong>算法。该算法是</strong>NFU（Not Frequently Used）**算法的变体，开销较小，能高效地选出较少使用的页面。</p>
<p>我们将缓冲区描述符想象为一个循环列表（如图8.12所示）。而<code>nextVictimBuffer</code>是一个32位的无符号整型变量，它总是指向某个缓冲区描述符并按顺时针顺序旋转。该算法的伪代码与算法描述如下：</p>
<blockquote>
<h4 id="伪代码时钟扫描">伪代码：时钟扫描</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>    WHILE true
</span></span><span style="display:flex;"><span>(1)     获取nextVictimBuffer指向的缓冲区描述符
</span></span><span style="display:flex;"><span>(2)     IF 缓冲区描述符没有被钉住 THEN
</span></span><span style="display:flex;"><span>(3)	        IF 候选缓冲区描述符的 usage_count == 0 THEN
</span></span><span style="display:flex;"><span>	            BREAK WHILE LOOP  /* 该描述符对应的槽就是受害者槽 */
</span></span><span style="display:flex;"><span>	        ELSE
</span></span><span style="display:flex;"><span>		        将候选描述符的 usage_count - 1
</span></span><span style="display:flex;"><span>            END IF
</span></span><span style="display:flex;"><span>        END IF
</span></span><span style="display:flex;"><span>(4)     迭代 nextVictimBuffer，指向下一个缓冲区描述符
</span></span><span style="display:flex;"><span>    END WHILE 
</span></span><span style="display:flex;"><span>(5) RETURN 受害者页面的 buffer_id
</span></span></code></pre></div><ol>
<li>获取<code>nextVictimBuffer</code>指向的<strong>候选缓冲区描述符（candidate buffer descriptor）</strong>。</li>
<li>如果候选描述符<strong>未被钉住（unpinned）</strong>，则进入步骤(3)， 否则进入步骤(4)。</li>
<li>如果候选描述符的<code>usage_count</code>为0，则选择该描述符对应的槽作为受害者，并进入步骤(5)；否则将此描述符的<code>usage_count</code>减1，并继续执行步骤(4)。</li>
<li>将<code>nextVictimBuffer</code>迭代至下一个描述符（如果到末尾则回绕至头部）并返回步骤(1)。重复至找到受害者。</li>
<li>返回受害者的<code>buffer_id</code>。</li>
</ol>
</blockquote>
<p>具体的例子如图8.12所示。缓冲区描述符为蓝色或青色的方框，框中的数字显示每个描述符的<code>usage_count</code>。</p>
<p><strong>图8.12 时钟扫描</strong></p>
<p><img src="/img/blog/kernel/fig-8-12.png"></p>
<ol>
<li><code>nextVictimBuffer</code>指向第一个描述符（<code>buffer_id = 1</code>）；但因为该描述符被钉住了，所以跳过。</li>
<li><code>extVictimBuffer</code>指向第二个描述符（<code>buffer_id = 2</code>）。该描述符未被钉住，但其<code>usage_count</code>为2；因此该描述符的<code>usage_count</code>将减1，而<code>nextVictimBuffer</code>迭代至第三个候选描述符。</li>
<li><code>nextVictimBuffer</code>指向第三个描述符（<code>buffer_id = 3</code>）。该描述符未被钉住，但其<code>usage_count = 0</code>，因而成为本轮的受害者。</li>
</ol>
<p>当<code>nextVictimBuffer</code>扫过未固定的描述符时，其<code>usage_count</code>会减1。因此只要缓冲池中存在未固定的描述符，该算法总能在旋转若干次<code>nextVictimBuffer</code>后，找到一个<code>usage_count</code>为0的受害者。</p>
<h2 id="85-环形缓冲区">8.5 环形缓冲区</h2>
<p>在读写大表时，PostgreSQL会使用**环形缓冲区（ring buffer）**而不是缓冲池。<strong>环形缓冲器</strong>是一个很小的临时缓冲区域。当满足下列任一条件时，PostgreSQL将在共享内存中分配一个环形缓冲区：</p>
<ol>
<li>
<p><strong>批量读取</strong></p>
<p>当扫描关系读取数据的大小超过缓冲池的四分之一（<code>shared_buffers/4</code>）时，在这种情况下，环形缓冲区的大小为<em>256 KB</em>。</p>
</li>
<li>
<p><strong>批量写入</strong></p>
<p>当执行下列SQL命令时，这种情况下，环形缓冲区大小为<em>16 MB</em>。</p>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/sql-copy.html"><code>COPY FROM</code></a>命令。</li>
</ul>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/sql-createtableas.html"><code>CREATE TABLE AS</code></a>命令。</li>
<li><a href="http://www.postgresql.org/docs/current/static/sql-creatematerializedview.html"><code>CREATE MATERIALIZED VIEW</code></a>或 <a href="http://www.postgresql.org/docs/current/static/sql-refreshmaterializedview.html"><code>REFRESH MATERIALIZED VIEW</code></a>命令。</li>
<li><a href="http://www.postgresql.org/docs/current/static/sql-altertable.html"><code>ALTER TABLE</code></a>命令。</li>
</ul>
</li>
<li>
<p><strong>清理过程</strong></p>
<p>当自动清理守护进程执行清理过程时，这种情况环形缓冲区大小为256 KB。</p>
</li>
</ol>
<p>分配的环形缓冲区将在使用后被立即释放。</p>
<p>环形缓冲区的好处显而易见，如果后端进程在不使用环形缓冲区的情况下读取大表，则所有存储在缓冲池中的页面都会被移除（踢出），因而会导致缓存命中率降低。环形缓冲区可以避免此问题。</p>
<blockquote>
<h4 id="为什么批量读取和清理过程的默认环形缓冲区大小为256-kb">为什么批量读取和清理过程的默认环形缓冲区大小为256 KB？</h4>
<p>为什么是256 KB？源代码中缓冲区管理器目录下的<a href="https://github.com/postgres/postgres/blob/master/src/backend/storage/buffer/README">README</a>中解释了这个问题。</p>
<blockquote>
<p>顺序扫描使用256KB的环缓冲。它足够小，因而能放入L2缓存中，从而使得操作系统缓存到共享缓冲区的页面传输变得高效。通常更小一点也可以，但环形缓冲区必需足够大到能同时容纳扫描中被钉住的所有页面。</p>
</blockquote>
</blockquote>
<h2 id="86-脏页刷盘">8.6 脏页刷盘</h2>
<p>除了置换受害者页面之外，**检查点进程（Checkpointer）**进程和后台写入器进程也会将脏页刷写至存储中。尽管两个进程都具有相同的功能（刷写脏页），但它们有着不同的角色和行为。</p>
<p>检查点进程将**检查点记录（checkpoint record）**写入WAL段文件，并在检查点开始时进行脏页刷写。<a href="/zh/blog/kernel/ch9/">9.7节</a>介绍了检查点，以及检查点开始的时机。</p>
<p>后台写入器的目的是通过少量多次的脏页刷盘，减少检查点带来的密集写入的影响。后台写入器会一点点地将脏页落盘，尽可能减小对数据库活动造成的影响。默认情况下，后台写入器每200毫秒被唤醒一次（由参数<a href="http://www.postgresql.org/docs/current/static/runtime-config-resource.html#GUC-BGWRITER-DELAY"><code>bgwriter_delay</code></a>定义），且最多刷写<a href="http://www.postgresql.org/docs/current/static/runtime-config-resource.html#GUC-BGWRITER-LRU-MAXPAGES"><code>bgwriter_lru_maxpages</code></a>个页面（默认为100个页面）。</p>
<h4 id="为什么检查点进程与后台写入器相分离">为什么检查点进程与后台写入器相分离？</h4>
<blockquote>
<p>在9.1版及更早版本中，后台写入器会规律性的执行检查点过程。在9.2版本中，检查点进程从后台写入器进程中被单独剥离出来。原因在一篇题为”<a href="https://www.postgresql.org/message-id/CA%2BU5nMLv2ah-HNHaQ%3D2rxhp_hDJ9jcf-LL2kW3sE4msfnUw9gA%40mail.gmail.com">将检查点进程与后台写入器相分离</a>“的提案中有介绍。下面是一些摘录：</p>
<blockquote>
<p>当前（在2011年）后台写入器进程既执行后台写入，又负责检查点，还处理一些其他的职责。这意味着我们没法在不停止后台写入的情况下执行检查点最终的<code>fsync</code>。因此，在同一个进程中做两件事会有负面的性能影响。</p>
<p>此外，在9.2版本中，我们的一个目标是通过将轮询循环替换为锁存器，从而降低功耗。<code>bgwriter</code>中的循环复杂度太高了，以至于无法找到一种简洁的使用锁存器的方法。</p>
</blockquote>
</blockquote>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-d51b3c996033eb4e91b4c059656c305c">第九章 预写式日志</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://www.interdb.jp/pg/">Hironobu SUZUKI</a> ，译者：<a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-01-03" class="text-muted">2018年01月03日</time>
        
	</div>
	<p>事务日志（<strong>transaction log</strong>）是数据库的关键组件，因为当出现系统故障时，任何数据库管理系统都不允许丢失数据。事务日志是数据库系统中所有**变更（change）<strong>与</strong>行为（action）**的历史记录，当诸如电源故障，或其他服务器错误导致服务器崩溃时，它被用于确保数据不会丢失。由于日志包含每个已执行事务的相关充分信息，因此当服务器崩溃时，数据库服务器应能通过重放事务日志中的变更与行为来恢复数据库集群。</p>
<p>在计算机科学领域，WAL是<strong>Write Ahead Logging</strong>的缩写，它指的是将<strong>变更与行为写入事务日志的协议或规则</strong>；而在PostgreSQL中，WAL是<strong>Write Ahead Log</strong>的缩写。在这里它被当成事务日志的同义词，而且也用来指代一种将<strong>行为</strong>写入事务日志（WAL）的实现机制。虽然有些令人困惑， 但本文将使用PostgreSQL中的定义。</p>
<p>WAL机制在7.1版本中首次被实现，用以减轻服务器崩溃的影响。它还是**时间点恢复（Point-in-Time Recovery PIRT）<strong>与</strong>流复制（Streaming Replication, SR）**实现的基础，这两者将分别在<a href="/zh/blog/kernel/ch10/">第10章</a>和<a href="/zh/blog/kernel/ch11/">第11章</a>中介绍。</p>
<p>尽管理解WAL机制对于管理、集成PostgreSQL非常重要，但由于它的复杂性，不可能做到简要介绍。因此本章将会对WAL做一个完整的解释。第一节描绘了WAL的全貌，介绍了一些重要的概念与关键词。接下来的小节中会依次讲述其他主题：</p>
<ul>
<li>事务日志（WAL）的逻辑结构与物理结构</li>
<li>WAL数据的内部布局</li>
<li>WAL数据的写入</li>
<li>WAL写入者进程</li>
<li>检查点过程</li>
<li>数据库恢复流程</li>
<li>管理WAL段文件</li>
<li>持续归档</li>
</ul>
<h2 id="91-概述">9.1 概述</h2>
<p>让我们先来概述一下WAL机制。为了阐明WAL要解决的问题，第一部分展示了如果PostgreSQL在没有实现WAL时崩溃会发生什么。第二部分介绍了一些关键概念，并概览了本章中的一些关键主题。最后一部分总结了WAL概述部分，并引出了一个更为重要的概念。</p>
<h3 id="911-没有wal的插入操作">9.1.1 没有WAL的插入操作</h3>
<p>正如在<a href="/zh/blog/kernel/ch8/">第八章</a>中讨论的那样，为了能高效访问关系表的页面，几乎所有的DBMS都实现了共享缓冲池。</p>
<p>假设有这样一个没有实现WAL机制的PostgreSQL，现在向表A中插入一些数据元组，如图9.1所示。</p>
<p><strong>图9.1 没有WAL的插入操作</strong></p>
<p><img alt="图9.1 没有WAL的插入操作" src="/img/blog/kernel/fig-9-01.png"></p>
<ol>
<li>发起第一条<code>INSERT</code>语句时，PostgreSQL从数据库集簇文件中加载表A的页面到内存中的共享缓冲池。然后向页面中插入一条元组。页面并没有立刻写回到数据库集簇文件中。正如<a href="/zh/blog/kernel/ch8/">第8章</a>中提到的，被修改过的页面通常称为<strong>脏页（dirty page）</strong></li>
<li>发起第二条<code>INSERT</code>语句时，PostgreSQL直接向缓冲池里的页面内添加了一条新元组。这一页仍然没有被写回到持久存储中。</li>
<li>如果操作系统或PostgreSQL服务器因为各种原因失效（例如电源故障），所有插入的数据都会丢失。</li>
</ol>
<p>因此没有WAL的数据库在系统崩溃时是很脆弱的。</p>
<h3 id="912-插入操作与数据库恢复">9.1.2 插入操作与数据库恢复</h3>
<p>为了解决上述系统失效问题，同时又不招致性能损失，PostgreSQL支持了WAL。这一部分介绍了一些关键词和概念，以及WAL数据的写入和数据库系统的恢复。</p>
<p>为了应对系统失效，PostgreSQL将所有修改作为历史数据写入持久化存储中。这份历史数据称为<strong>XLOG记录（xlog record）<strong>或</strong>WAL数据（wal data）</strong>。</p>
<p>当插入、删除、提交等变更动作发生时，PostgreSQL会将XLOG记录写入内存中的<strong>WAL缓冲区（WAL Buffer）</strong>。当事务提交或中止时，它们会被立即写入持久存储上的**WAL段文件（WAL segment file）<strong>中（更精确来讲，其他场景也可能会有XLOG记录写入，细节将在9.5节中描述）。XLOG记录的</strong>日志序列号（Log Sequence Number, LSN）**标识了该记录在事务日志中的位置，记录的LSN被用作XLOG记录的唯一标识符。</p>
<p>顺便一提，当我们考虑数据库系统如何恢复时，可能会想到一个问题：PostgreSQL是从哪一点开始恢复的？答案是<strong>重做点（REDO Point）</strong>，即最新一个<strong>检查点（Checkpoint）<strong>开始时</strong>XLOG记录</strong>写入的位置。（PostgreSQL中的检查点将在9.7节中描述）。实际上，数据库恢复过程与检查点过程紧密相连，两者是不可分割的。</p>
<blockquote>
<p>WAL与检查点过程在7.1版本中同时实现</p>
</blockquote>
<p>介绍完了主要的关键词与概念，现在来说一下带有WAL时的元组插入操作。如图9.2所示：</p>
<p><strong>图9.2 带有WAL的插入操作</strong></p>
<p><img alt="图9.2 带有WAL的插入操作" src="/img/blog/kernel/fig-9-02.png"></p>
<blockquote>
<p>表A的LSN展示的是表A页面中页首部里<code>pd_lsn</code>类型的<code>PageXLogRecPtr</code>字段，与页面的LSN是一回事。</p>
</blockquote>
<ol>
<li>检查点进程是一个后台进程，周期性地执行过程。当检查点进程开始执行检查点时，它会向当前WAL段文件写入一条XLOG记录，称为<strong>检查点（Checkpoint Record）</strong>。这条记录包含了最新的<strong>重做点</strong>位置。</li>
<li>发起第一条<code>INSERT</code>语句时，PostgreSQL从数据库集簇文件中加载表A的页面至内存中的共享缓冲池，向页面中插入一条元组，然后在<code>LSN_1</code>位置创建并写入一条相应的XLOG记录，然后将表A的LSN从<code>LSN_0</code>更新为<code>LSN_1</code>。在本例中，XLOG记录是由首部数据与<strong>完整元组</strong>组成的一对值。</li>
<li>当该事务提交时，PostgreSQL向WAL缓冲区创建并写入一条关于该提交行为的XLOG记录，然后将WAL缓冲区中的所有XLOG记录刷写入WAL段文件中。</li>
<li>发起第二条<code>INSERT</code>语句时，PostgreSQL向页面中插入一条新元组，然后在<code>LSN_2</code>位置创建并写入一条相应的XLOG记录，然后将表A的LSN从<code>LSN_1</code>更新为<code>LSN_2</code>。</li>
<li>当这条语句的事务提交时，PostgreSQL执行同步骤3类似的操作。</li>
<li>设想当操作系统失效发生时，尽管共享缓冲区中的所有数据都丢失了，但所有页面修改已经作为历史记录被写入WAL段文件中。</li>
</ol>
<p>接下来的步骤展示了如何将数据库集簇恢复到崩溃时刻前的状态。不需要任何特殊的操作，重启PostgreSQL时会自动进入恢复模式，如图9.3所示。PostgreSQL会从<strong>重做点</strong>开始，依序读取正确的WAL段文件并重放XLOG记录。</p>
<p><strong>图9.3 使用WAL进行数据库恢复</strong></p>
<p><img alt="图9.3 使用WAL进行数据库恢复" src="/img/blog/kernel/fig-9-03.png"></p>
<ol>
<li>PostgreSQL从相关的WAL段文件中读取第一条<code>INSERT</code>语句的XLOG记录，并从硬盘上的数据库集簇目录加载表A的页面到内存中的共享缓冲区中。</li>
<li>在重放XLOG记录前，PostgreSQL会比较XLOG记录的LSN与相应页面的LSN。这么做的原因在第9.8节中描述。重放XLOG记录的规则如下所示：
<ul>
<li>如果XLOG记录的LSN要比页面LSN大，XLOG记录中的数据部分就会被插入到页面中，并将页面的LSN更新为XLOG记录的LSN。</li>
<li>如果XLOG记录的LSN要比页面的LSN小，那么不用做任何事情，直接读取后续的WAL数据即可。</li>
</ul>
</li>
<li>PostgreSQL按照同样的方式重放其余的XLOG记录。</li>
</ol>
<p>PostgreSQL可以通过按时间顺序重放写在WAL段文件中的XLOG记录来自我恢复，因此，PostgreSQL的XLOG记录显然是一种<strong>重做日志（REDO log）</strong>。</p>
<blockquote>
<p>PostgreSQL不支持<strong>撤销日志（UNDO log）</strong></p>
</blockquote>
<p>尽管写XLOG记录肯定有一定的代价，这些代价和全页写入相比微不足道。所付出的代价换来了巨大的收益，比如，系统崩溃时的恢复能力。</p>
<h3 id="913-整页写入">9.1.3 整页写入</h3>
<p>假设后台写入进程在写入脏页的过程中出现了操作系统故障，导致磁盘上表A的页面数据损坏。XLOG是无法在损坏的页面上重放的，我们需要其他功能来确保这一点。</p>
<blockquote>
<p>译注：PostgreSQL默认使用8KB的页面，操作系统通常使用4KB的页面，可能出现只写入一个4KB页面的情况。</p>
</blockquote>
<p>PostgreSQL支持诸如<strong>整页写入（full-page write）<strong>的功能来处理这种失效。如果启用，PostgreSQL会在每次检查点之后，在每个页面第一次发生变更时，会将</strong>整个页面</strong>及相应首部作为一条XLOG记录写入。这个功能默认是开启的。在PostgreSQL中，这种包含完整页面的XLOG记录称为<strong>备份区块（backup block）</strong>，或者<strong>整页镜像（full-page image）</strong>。</p>
<p><strong>图9.4 整页写入</strong></p>
<p><img alt="图9.4 整页写入" src="/img/blog/kernel/fig-9-04.png"></p>
<ol>
<li>检查点进程开始进行检查点过程。</li>
<li>在第一条<code>INSERT</code>语句进行插入操作时，PostgreSQL执行的操作几乎同上所述。区别在于这里的XLOG记录是当前页的<strong>备份区块</strong>（即，包含了完整的页面），因为这是自最近一次检查点以来，该页面的第一次写入。</li>
<li>当事务提交时，PostgreSQL的操作同上节所述。</li>
<li>第二条<code>INSERT</code>语句进行插入操作时，PostgreSQL的操作同上所述，这里的XLOG记录就不是备份块了。</li>
<li>当这条语句的事务提交时，PostgreSQL的操作同上节所述。</li>
<li>为了说明整页写入的效果，我们假设后台写入进程在向磁盘写入脏页的过程中出现了操作系统故障，导致磁盘上表A的页面数据损坏。</li>
</ol>
<p>重启PostgreSQL即可修复损坏的集簇，如图9.5所示</p>
<p><strong>图9.5 使用备份区块进行数据库恢复</strong></p>
<p><img alt="图9.5 使用备份区块进行数据库恢复" src="/img/blog/kernel/fig-9-05.png"></p>
<ol>
<li>
<p>PostgreSQL读取第一条<code>INSERT</code>语句的XLOG记录，并从数据库集簇目录加载表A的页面至共享缓冲池中。在本例中，按照整页写入的规则，这条XLOG记录是一个备份区块。</p>
</li>
<li>
<p>当一条XLOG记录是备份区块时，会使用另一条重放规则：XLOG记录的数据部分会直接覆盖当前页面，无视页面或XLOG记录中的LSN，然后将页面的LSN更新为XLOG记录的LSN。</p>
<p>在本例中，PostgreSQL使用记录的数据部分覆写了损坏的页面，并将表A的LSN更新为<code>LSN_1</code>，通过这种方式，损坏的页面通过它自己的备份区块恢复回来了。</p>
</li>
<li>
<p>因为第二条XLOG记录不是备份区块， 因此PostgreSQL的操作同上所述。</p>
</li>
</ol>
<p>即使发生一些数据写入错误，PostgreSQL也能从中恢复。（当然如果发生文件系统或物理介质失效，就不行了）</p>
<h2 id="92-事务日志与wal段文件">9.2 事务日志与WAL段文件</h2>
<p>PostgreSQL在逻辑上将XLOG记录写入事务日志，即，一个长度用8字节表示的虚拟文件（16 EB）。</p>
<p>虽说事务日志的容量实际上应该是无限的，但8字节长度的地址空间已经足够宽广了。目前是不可能处理这个量级的单个文件的。因此PostgreSQL中的事务日志实际上默认被划分为16M大小的一系列文件，这些文件被称作<strong>WAL段（WAL Segment）</strong>。如图9.6所示。</p>
<blockquote>
<h3 id="wal段文件尺寸">WAL段文件尺寸</h3>
<p>从版本11开始，在使用<code>initdb</code>创建数据库时，可以通过<a href="https://www.postgresql.org/docs/11/static/app-initdb.html"><code>--wal-segsize</code></a>选项来配置WAL段文件的大小。</p>
</blockquote>
<p><strong>图9.6 事务日志与WAL段文件</strong></p>
<p><img alt="图9.6 事务日志与WAL段文件" src="/img/blog/kernel/fig-9-06.png"></p>
<p>WAL段文件的文件名是由24个十六进制数字组成的，其命名规则如下：
$$
\begin{align}
\verb|WAL段文件名| = \verb|timelineId| + (\verb|uint32|) \frac{\verb|LSN|-1}{16\verb|M|*256}<br>
+ (\verb|uint32|)\left(\frac{\verb|LSN|-1}{16\verb|M|}\right) % 256
\end{align}
$$</p>
<blockquote>
<h3 id="时间线标识">时间线标识</h3>
<p>PostgreSQL的WAL有<strong>时间线标识（TimelineID，四字节无符号整数）<strong>的概念，用于<a href="/zh/blog/kernel/ch10/">第十章</a>中所述的</strong>时间点恢复（PITR）</strong>。不过在本章中时间线标识将固定为<code>0x00000001</code>，因为接下来的几节里还不需要这个概念。</p>
</blockquote>
<p>第一个WAL段文件名是$00000001\color{blue}{00000000}000000\color{blue}{01}$，如果第一个段被XLOG记录写满了，就会创建第二个段$00000001\color{blue}{00000000}000000\color{blue}{02}$，后续的文件名将使用升序。在$00000001\color{blue}{00000000}000000\color{blue}{FF}$被填满之后，就会使用下一个文件$00000001\color{blue}{00000001}000000\color{blue}{00}$。通过这种方式，每当最后两位数字要进位时，中间8位数字就会加一。与之类似，在$00000001\color{blue}{00000001}000000\color{blue}{FF}$被填满后，就会开始使用$00000001\color{blue}{00000002}000000\color{blue}{00}$，依此类推。</p>
<blockquote>
<h3 id="wal文件名">WAL文件名</h3>
<p>使用内建的函数<code>pg_xlogfile_name</code>（9.6及以前的版本），或<code>pg_walfile_name</code>（10及以后的版本），我们可以找出包含特定LSN的WAL段文件。例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_xlogfile_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;1/00002D3E&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- 9.6-
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- SELECT pg_walfile_name(&#39;1/00002D3E&#39;); -- 10+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000">pg_xlogfile_name</span><span style="color:#f8f8f8;text-decoration:underline">     
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">000000010000000100000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></blockquote>
<h2 id="93-wal段文件的内部布局">9.3 WAL段文件的内部布局</h2>
<p>一个WAL段文件大小默认为16MB，并在内部划分为大小为8192字节（8KB）的页面。第一个页包含了由<code>XLogLongPageHeaderData</code>定义的首部数据，其他的页包含了由<code>XLogPageHeaderData</code>定义的首部数据。每页在首部数据之后，紧接着就是以<strong>降序</strong>写入的XLOG记录，如图9.7所示。</p>
<p><strong>图9.7 WAL段文件内部布局</strong></p>
<p><img alt="图9.7 WAL段文件内部布局" src="/img/blog/kernel/fig-9-07.png"></p>
<p><code>XLogLongPageHeaderData</code>与<code>XLogPageHeaderData</code>结构定义在 <a href="https://github.com/postgres/postgres/blob/master/src/include/access/xlog_internal.h"><code>src/include/access/xlog_internal.h</code></a>中。这两个结构的具体说明就不在此展开了，因为对于后续小节并非必需。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogPageHeaderData</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint16</span>		<span style="color:#000">xlp_magic</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 用于正确性检查的魔数 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint16</span>		<span style="color:#000">xlp_info</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 标记位，详情见下 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TimeLineID</span>	<span style="color:#000">xlp_tli</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 页面中第一条记录的时间线ID */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">XLogRecPtr</span>	<span style="color:#000">xlp_pageaddr</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 当前页的XLOG地址 */</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 当本页放不下一条完整记录时，我们会在下一页继续，xlp_rem_len存储了来自先前页面
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * 记录剩余的字节数。注意xl_rem_len包含了备份区块的数据，也就是说它会在第一个首部跟踪
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * xl_tot_len而不是xl_len。还要注意延续的数据不一定是对齐的。*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint32</span>		<span style="color:#000">xlp_rem_len</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 记录所有剩余数据的长度 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">XLogPageHeaderData</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#000">XLogPageHeaderData</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">XLogPageHeader</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 当设置了XLP_LONG_HEADER标记位时，我们将在页首部中存储额外的字段。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * (通常是在XLOG文件中的第一个页面中) 额外的字段用于确保文件的正确性。 */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogLongPageHeaderData</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">XLogPageHeaderData</span> <span style="color:#000">std</span><span style="color:#000;font-weight:bold">;</span>            <span style="color:#8f5902;font-style:italic">/* 标准首部 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uint64</span>             <span style="color:#000">xlp_sysid</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* 来自pg_control中的系统标识符 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uint32</span>             <span style="color:#000">xlp_seg_size</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* 交叉校验 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uint32</span>             <span style="color:#000">xlp_xlog_blcksz</span><span style="color:#000;font-weight:bold">;</span><span style="color:#8f5902;font-style:italic">/* 交叉校验 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">XLogLongPageHeaderData</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h2 id="94-wal记录的内部布局">9.4 WAL记录的内部布局</h2>
<p>一条XLOG记录由通用的首部部分与特定的数据部分构成。本章第一节描述了首部的结构，剩下两个节分别解释了9.5版本前后数据部分的结构。（9.5版本改变了数据格式）</p>
<h3 id="941-wal记录首部部分">9.4.1 WAL记录首部部分</h3>
<p>所有的XLOG记录都有一个通用的首部，由结构<code>XLogRecord</code>定义。9.5更改了首部的定义，9.4及更早版本的结构定义如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogRecord</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">uint32</span>          <span style="color:#000">xl_tot_len</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* 整条记录的全长 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">TransactionId</span>   <span style="color:#000">xl_xid</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* 事务ID */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">uint32</span>          <span style="color:#000">xl_len</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* 资源管理器的数据长度 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">uint8</span>           <span style="color:#000">xl_info</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* 标记位，如下所示 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">RmgrId</span>          <span style="color:#000">xl_rmid</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* 本记录的资源管理器 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#8f5902;font-style:italic">/* 这里有2字节的填充，初始化为0 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">XLogRecPtr</span>      <span style="color:#000">xl_prev</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* 在日志中指向先前记录的指针 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">pg_crc32</span>        <span style="color:#000">xl_crc</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* 本记录的CRC */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">XLogRecord</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>除了两个变量，大多数变量的意思非常明显，无需多言。<code>xl_rmid</code>与<code>xl_info</code>都是与**资源管理器（resource manager）**相关的变量，它是一些与WAL功能（写入，重放XLOG记录）相关的操作集合。资源管理器的数目随着PostgreSQL不断增加，第10版包括这些：</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">资源管理器</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">堆元组操作</td>
<td style="text-align:left"><code>RM_HEAP</code>, <code>RM_HEAP2</code></td>
</tr>
<tr>
<td style="text-align:left">索引操作</td>
<td style="text-align:left"><code>RM_BTREE</code>, <code>RM_HASH</code>, <code>RM_GIN</code>, <code>RM_GIST</code>, <code>RM_SPGIST</code>, <code>RM_BRIN</code></td>
</tr>
<tr>
<td style="text-align:left">序列号操作</td>
<td style="text-align:left"><code>RM_SEQ</code></td>
</tr>
<tr>
<td style="text-align:left">事务操作</td>
<td style="text-align:left"><code>RM_XACT</code>, <code>RM_MULTIXACT</code>, <code>RM_CLOG</code>, <code>RM_XLOG</code>, <code>RM_COMMIT_TS</code></td>
</tr>
<tr>
<td style="text-align:left">表空间操作</td>
<td style="text-align:left"><code>RM_SMGR</code>, <code>RM_DBASE</code>, <code>RM_TBLSPC</code>, <code>RM_RELMAP</code></td>
</tr>
<tr>
<td style="text-align:left">复制与热备操作</td>
<td style="text-align:left"><code>RM_STANDBY</code>, <code>RM_REPLORIGIN</code>, <code>RM_GENERIC_ID</code>, <code>RM_LOGICALMSG_ID</code></td>
</tr>
</tbody>
</table>
<p>下面是一些有代表性的例子，展示了资源管理器工作方式。</p>
<ul>
<li>如果发起的是<code>INSERT</code>语句，则其相应XLOG记录首部中的变量<code>xl_rmid</code>与<code>xl_info</code>会相应地被设置为<code>RM_HEAP</code>与<code>XLOG_HEAP_INSERT</code>。当恢复数据库集簇时，就会按照<code>xl_info</code>选用资源管理器<code>RM_HEAP</code>的函数<code>heap_xlog_insert()</code>来重放当前XLOG记录。</li>
<li><code>UPDATE</code>语句与之类似，首部变量中的<code>xl_info</code>会被设置为<code>XLOG_HEAP_UPDATE</code>，而在数据库恢复时就会选用资源管理器<code>RM_HEAP</code>的函数<code>heap_xlog_update()</code>进行重放。</li>
<li>当事务提交时，相应XLOG记录首部的变量<code>xl_rmid</code>与<code>xl_info</code>会被相应地设置为<code>RM_XACT</code>与<code>XLOG_XACT_COMMIT</code>。当数据库恢复时，<code>RM_XACT</code>的<code>xact_redo_commit()</code>就会执行本记录的重放。</li>
</ul>
<p>在9.5及之后的版本，首部结构<a href="https://github.com/postgres/postgres/blob/9d4649ca49416111aee2c84b7e4441a0b7aa2fac/src/include/access/xlogrecord.h"><code>XLogRecord</code></a>移除了一个字段<code>xl_len</code>，精简了XLOG记录的格式，省了几个字节。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogRecord</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint32</span>		<span style="color:#000">xl_tot_len</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 整条记录的总长度 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TransactionId</span> <span style="color:#000">xl_xid</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 事物标识 xid */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">XLogRecPtr</span>	<span style="color:#000">xl_prev</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 指向日志中前一条记录的指针 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint8</span>		<span style="color:#000">xl_info</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 标记位，详情见下*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RmgrId</span>		<span style="color:#000">xl_rmid</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 本条记录对应的资源管理器 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 这里有2字节的填充，初始化为0 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pg_crc32c</span>	<span style="color:#000">xl_crc</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 本记录的CRC */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 紧随其后的是XLogRecordBlockHeaders 与 XLogRecordDataHeader ，不带填充 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">XLogRecord</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><blockquote>
<p>9.4版本中的<code>XLogRecord</code>结构定义在<a href="https://github.com/postgres/postgres/blob/REL9_4_STABLE/src/include/access/xlog.h"><code>src/include/access/xlog.h</code></a>中，9.5及以后的定义在<a href="https://github.com/postgres/postgres/blob/master/src/include/access/xlogrecord.h"><code>src/include/access/xlogrecord.h</code></a>。<code>heap_xlog_insert</code>与<code>heap_xlog_update</code>定义在<a href="https://github.com/postgres/postgres/blob/master/src/backend/access/heap/heapam.c"><code>src/backend/access/heap/heapam.c</code></a> ；而函数<code>xact_redo_commit</code>定义在<a href="https://github.com/postgres/postgres/blob/master/src/backend/access/transam/xact.c"><code>src/backend/access/transam/xact.c</code></a>中</p>
</blockquote>
<h3 id="942-xlog记录数据部分94及以前">9.4.2 XLOG记录数据部分（9.4及以前）</h3>
<p>XLOG记录的数据部分可以分为两类：备份区块（完整的页面），或非备份区块（不同的操作相应的数据不同）。</p>
<p><strong>图9.8 XLOG记录的样例（9.4版本或更早）</strong></p>
<p><img src="/img/blog/kernel/fig-9-08.png"></p>
<p>让我们通过几个具体示例来了解XLOG记录的内部布局。</p>
<h4 id="9421-备份区块">9.4.2.1 备份区块</h4>
<p>备份区块如图9.8(a)所示，它由两个数据结构和一个数据对象组成，如下所述：</p>
<ol>
<li>首部部分，<code>XLogRecord</code>结构体</li>
<li><code>BkpBlock</code>结构体</li>
<li>除去空闲空间的完整页面。</li>
</ol>
<p><code>BkpBlock</code>包括了用于在数据库集簇目录中定位该页面的变量（比如，包含该页面的关系表的<code>RelFileNode</code>与<code>ForkNumber</code>，以及文件内的区块号<code>BlockNumber</code>），以及当前页面空闲空间的开始位置与长度。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @include/access/xlog_internal.h
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">BkpBlock</span> 
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">RelFileNode</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 包含该块的关系 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ForkNumber</span>  <span style="color:#000">fork</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 关系的分支(main,vm,fsm,...) */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">BlockNumber</span> <span style="color:#000">block</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* 区块号 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uint16</span>      <span style="color:#000">hole_offset</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* &#34;空洞&#34;前的字节数 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uint16</span>      <span style="color:#000">hole_length</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* &#34;空洞&#34;的长度 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">/* 实际的区块数据紧随该结构体后 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">BkpBlock</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h4 id="9422-非备份区块">9.4.2.2 非备份区块</h4>
<p>在非备份区块中，数据部分的布局依不同操作而异。这里举一个具有代表性的例子：一条<code>INSERT</code>语句的XLOG记录。如图9.8(b)所示，<code>INSERT</code>语句的XLOG记录是由两个数据结构与一个数据对象组成的：</p>
<ol>
<li>首部部分，<code>XLogRecord</code>结构体</li>
<li><code>xl_heap_insert</code>结构体</li>
<li>被插入的元组 —— 更精确地说，是移除了一些字节的元组。</li>
</ol>
<p>结构体<code>xl_heap_insert</code>包含的变量用于在数据库集簇中定位被插入的元组。（即，包含该元组的表的<code>RelFileNode</code>，以及该元组的<code>tid</code>），以及该元组的可见性标记位。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">BlockIdData</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">uint16</span>          <span style="color:#000">bi_hi</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">uint16</span>          <span style="color:#000">bi_lo</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">BlockIdData</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#000">uint16</span> <span style="color:#000">OffsetNumber</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ItemPointerData</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">BlockIdData</span>     <span style="color:#000">ip_blkid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">OffsetNumber</span>    <span style="color:#000">ip_posid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">RelFileNode</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">Oid</span>             <span style="color:#000">spcNode</span><span style="color:#000;font-weight:bold">;</span>             <span style="color:#8f5902;font-style:italic">/* 表空间 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">Oid</span>             <span style="color:#000">dbNode</span><span style="color:#000;font-weight:bold">;</span>              <span style="color:#8f5902;font-style:italic">/* 数据库 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">Oid</span>             <span style="color:#000">relNode</span><span style="color:#000;font-weight:bold">;</span>             <span style="color:#8f5902;font-style:italic">/* 关系 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">RelFileNode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xl_heaptid</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">RelFileNode</span>     <span style="color:#000">node</span><span style="color:#000;font-weight:bold">;</span>				<span style="color:#8f5902;font-style:italic">/* 关系定位符 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">ItemPointerData</span> <span style="color:#000">tid</span><span style="color:#000;font-weight:bold">;</span>                 <span style="color:#8f5902;font-style:italic">/* 元组在关系中的位置 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">xl_heaptid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xl_heap_insert</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">xl_heaptid</span>      <span style="color:#000">target</span><span style="color:#000;font-weight:bold">;</span>              <span style="color:#8f5902;font-style:italic">/* 被插入的元组ID */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">bool</span>            <span style="color:#000">all_visible_cleared</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* PD_ALL_VISIBLE 是否被清除 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">xl_heap_insert</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><blockquote>
<p>在结构体<code>xl_heap_header</code>的代码注释中解释了移除插入元组中若干字节的原因：</p>
<p>我们并没有在WAL中存储被插入或被更新元组的固定部分（即<code>HeapTupleHeaderData</code>，堆元组首部），我们可以在需要时从WAL中的其它部分重建这几个字段，以此节省一些字节。或者根本就无需重建。</p>
</blockquote>
<p>这里还有一个例子值得一提，如图9.8(c)所示，检查点的XLOG记录相当简单，它由如下所示的两个数据结构组成：</p>
<ol>
<li><code>XLogRecord</code>结构（首部部分）</li>
<li>包含检查点信息的<code>CheckPoint</code>结构体（参见<a href="/zh/blog/kernel/ch9/#9.7">9.7节</a>）</li>
</ol>
<blockquote>
<p><code>xl_heap_header</code>结构定义在<a href="https://github.com/postgres/postgres/blob/master/src/include/access/htup.h"><code>src/include/access/htup.h</code></a>中，而<code>CheckPoint</code>结构体定义在<a href="https://github.com/postgres/postgres/blob/master/src/include/catalog/pg_control.h"><code>src/include/catalog/pg_control.h</code></a>中。</p>
</blockquote>
<h3 id="943-xlog记录数据部分95及后续版本">9.4.3 XLOG记录数据部分（9.5及后续版本）</h3>
<p>在9.4及之前的版本，XLOG记录并没有通用的格式，因此每一种资源管理器都需要定义各自的格式。在这种情况下，维护源代码，以及实现与WAL相关的新功能变得越来越困难。为了解决这个问题，9.5版引入了一种通用的结构化格式，不依赖于特定的资源管理器。</p>
<p>XLOG记录的数据部分可以被划分为两个部分：首部与数据，如图9.9所示：</p>
<p><strong>图9.9 通用XLOG记录格式</strong></p>
<p><img src="/img/blog/kernel/fig-9-09.png"></p>
<p>首部部分包含零个或多个<code>XLogRecordBlockHeaders</code>，以及零个或一个<code>XLogRecordDataHeaderShort</code>（或<code>XLogRecordDataHeaderLong</code>）；它必须至少包含其中一个。当记录存储着整页镜像时（即备份区块），<code>XLogRecordBlockHeader</code>会包含<code>XLogRecordBlockImageHeader</code>，如果启用压缩还会包含<code>XLogRecordBlockCompressHeader</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 追加写入XLOG记录的区块数据首部。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * &#39;data_length&#39;是与本区块关联的，特定于资源管理器的数据荷载长度。它不包括可能会出现
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 的整页镜像的长度，也不会包括XLogRecordBlockHeader结构本身。注意我们并不会对
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * XLogRecordBlockHeader结构做边界对齐！因此在使用前该结构体必须拷贝到对齐的本地存储中。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogRecordBlockHeader</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint8</span>		<span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>				<span style="color:#8f5902;font-style:italic">/* 块引用 ID */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint8</span>		<span style="color:#000">fork_flags</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 关系中的分支，以及标志位 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint16</span>		<span style="color:#000">data_length</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 荷载字节数（不包括页面镜像） */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 如果设置 BKPBLOCK_HAS_IMAGE, 紧接一个XLogRecordBlockImageHeader结构 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 如果未设置 BKPBLOCK_SAME_REL, 紧接着一个RelFileNode结构 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 紧接着区块号码 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">XLogRecordBlockHeader</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 分支标号放在fork_flags的低4位中，高位用于标记位 */</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BKPBLOCK_FORK_MASK	0x0F
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BKPBLOCK_FLAG_MASK	0xF0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BKPBLOCK_HAS_IMAGE	0x10	</span><span style="color:#8f5902;font-style:italic">/* 区块数据是一个XLogRecordBlockImage */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BKPBLOCK_HAS_DATA	0x20
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BKPBLOCK_WILL_INIT	0x40	</span><span style="color:#8f5902;font-style:italic">/* 重做会重新初始化当前页 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BKPBLOCK_SAME_REL	0x80	</span><span style="color:#8f5902;font-style:italic">/* 忽略RelFileNode，与前一个相同 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* XLogRecordDataHeaderShort/Long 被用于本记录的“主数据”部分。如果数据的长度小于256字节
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 则会使用Short版本的格式，即使用单个字节来保存长度，否则会使用长版本的格式。 */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogRecordDataHeaderShort</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint8</span>		<span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>				<span style="color:#8f5902;font-style:italic">/* XLR_BLOCK_ID_DATA_SHORT */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint8</span>		<span style="color:#000">data_length</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 载荷字节数目 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>			<span style="color:#000">XLogRecordDataHeaderShort</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SizeOfXLogRecordDataHeaderShort (sizeof(uint8) * 2)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogRecordDataHeaderLong</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint8</span>		<span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>				<span style="color:#8f5902;font-style:italic">/* XLR_BLOCK_ID_DATA_LONG */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 紧随其后的是uint32类型的data_length, 未对齐 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>			<span style="color:#000">XLogRecordDataHeaderLong</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 当包含整页镜像时额外的首部信息(即当BKPBLOCK_HAS_IMAGE标记位被设置时)。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * XLOG相关的代码会意识到数据压缩上一个显而易见的情况，即PG里的数据页面通常会在中间包含一个
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 未使用的“空洞”，空洞里面通常只有置零的字节。如果空洞的长度大于0，我们就会从存储的数据中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 移除该“空洞”（且XLOG记录的CRC也不会计算该空洞）。因此区块数据的总量实际上是块大小BLCKSZ
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 减去空洞包含的字节大小。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 当启用 wal_compression 时，一个包含空洞的整页镜像除了移除空洞，还会额外是引用PGLZ压缩
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 算法进行压缩。这能减小WAL日志的体积，但会增加在记录WAL日志过程中的CPU开销。在这种情况下，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 空洞的大小就无法通过块大小-页面镜像大小来计算了。基本上，这需要存储额外的信息。但当没有
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 空洞存在时，我们可以假设空洞大小为0，因此就不需要存储额外信息了。注意，当压缩节约的字节数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 小于额外信息的长度时，WAL里就会存储原始的页面镜像，而不是压缩过的版本。因此当成功进行压缩
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 时，区块数据的总量总是要比（块大小BLCKSZ - 空洞字节数 - 额外信息长度）要更小。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogRecordBlockImageHeader</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint16</span>		<span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 页面镜像的字节数 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint16</span>		<span style="color:#000">hole_offset</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 空洞前面的字节数 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint8</span>		<span style="color:#000">bimg_info</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 标记位，详情见下 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 如果 BKPIMAGE_HAS_HOLE 且 BKPIMAGE_IS_COMPRESSED, 后面会跟着
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * XLogRecordBlockCompressHeader 结构体 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">XLogRecordBlockImageHeader</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 当页面镜像含有“空洞”且被压缩时，会用到这里的额外首部信息 */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogRecordBlockCompressHeader</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint16</span>		<span style="color:#000">hole_length</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* number of bytes in &#34;hole&#34; */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">XLogRecordBlockCompressHeader</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>数据部分则由零或多个区块数据与零或一个主数据组成，区块数据与<code>XLogRecordBlockHeader(s)</code>对应，而**主数据（main data）**则与<code>XLogRecordDataHeader</code>对应。</p>
<blockquote>
<h4 id="wal压缩">WAL压缩</h4>
<p>在9.5及其后的版本，可以通过设置<code>wal_compression = enable</code>启用WAL压缩：使用LZ压缩方法对带有整页镜像的XLOG记录进行压缩。在这种情况下，会添加<code>XLogRecordBlockCompressHeader</code>结构。</p>
<p>该功能有两个优点与一个缺点，优点是降低写入记录的I/O开销，并减小WAL段文件的消耗量；缺点是会消耗更多的CPU资源来执行压缩。</p>
</blockquote>
<p><strong>图9.10 XLOG记录样例（9.5及其后的版本）</strong></p>
<p><img src="/img/blog/kernel/fig-9-10.png"></p>
<p>和前一小节一样，这里通过一些特例来描述。</p>
<h4 id="9431-备份区块">9.4.3.1 备份区块</h4>
<p>由<code>INSERT</code>语句创建的备份区块如图9.10(a)所示，它由如下所示的四个数据结构与一个数据对象组成：</p>
<ol>
<li><code>XLogRecord</code>结构 （首部部分）</li>
<li><code>XLogRecordBlockHeader</code>结构，且包含一个<code>XLogRecordBlockImageHeader</code></li>
<li><code>XLogRecordDataHeaderShort</code>结构</li>
<li>一个备份区块（区块数据）</li>
<li><code>xl_heap_insert</code>结构 (主数据)</li>
</ol>
<p><code>XLogRecordBlockHeader</code>包含了用于在数据库集簇中定位区块的变量 (关系节点，分支编号，以及区块号)； <code>XLogRecordImageHeader</code> 包含了当前区块的长度与偏移量（这两个首部结构合起来效果与9.4及先前版本中的<code>BkpBlock</code>结构相同）。</p>
<p><code>XLogRecordDataHeaderShort</code>存储了<code>xl_heap_insert</code>结构的长度，该结构是当前记录的主数据部分（见下）。</p>
<blockquote>
<p>除了某些特例外（例如逻辑解码与<strong>推测插入（speculative insertion）</strong>），包含整页镜像的XLOG记录的<strong>主数据</strong>不会被使用。它们会在记录重放时被忽略，属于冗余数据，未来可能会对其改进。</p>
<p>此外，备份区块记录的主数据与创建它们的语句相关。例如<code>UPDATE</code>语句就会追加写入<code>xl_heap_lock</code>或<code>xl_heap_updated</code>。</p>
</blockquote>
<h4 id="9432-非备份区块">9.4.3.2 非备份区块</h4>
<p>接下来描述由<code>INSERT</code>语句创建的非备份区块，如图9.10(b)所示，它由四个数据结构与一个数据对象组成：</p>
<ol>
<li><code>XLogRecord</code>结构 （首部部分）</li>
<li><code>XLogRecordBlockHeader</code>结构</li>
<li><code>XLogRecordDataHeaderShort</code>结构</li>
<li>一条被插入的元组（更精确地说，一个<code>xl_heap_header</code>结构与完整的插入数据）</li>
<li><code>xl_heap_insert</code>结构 (主数据)</li>
</ol>
<p><code>XLogRecordBlockHeader</code>包含三个值 (关系节点，分支编号，以及区块号)，用以指明该元组被插入到哪个区块中，以及要插入数据部分的长度。<code>XLogRecordDataHeaderShort</code>存储了<code>xl_heap_insert</code>结构的长度，该结构是当前记录的主数据部分。</p>
<p>新版本的<code>xl_heap_insert</code>仅包含两个值：当前元组在区块内的偏移量，以及一个可见性标记。该结构变得十分简单，因为<code>XLogRecordBlockHeader</code>存储了旧版本中该结构体的绝大多数数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 这里是关于该INSERT操作，我们所需要知道的一切 */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xl_heap_insert</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">OffsetNumber</span> <span style="color:#000">offnum</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 被插入元组的偏移量 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint8</span>		<span style="color:#000">flags</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* xl_heap_header &amp; 备份区块0中的元组数据 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">xl_heap_insert</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>最后一个例子，检查点的记录如图9.10(c)所示，它由三个数据结构组成：</p>
<ol>
<li><code>XLogRecord</code>结构体（首部部分）</li>
<li><code>XLogRecordDataHeaderShort</code>结构，包含了主数据的长度。</li>
<li>结构体<code>CheckPoint</code>（主数据）</li>
</ol>
<blockquote>
<p><code>xl_heap_header</code>定义于<a href="https://github.com/postgres/postgres/blob/master/src/include/access/htup.h"><code>src/include/access/htup.h</code></a>中，而<code>CheckPoint</code>结构定义于<a href="https://github.com/postgres/postgres/blob/master/src/include/catalog/pg_control.h"><code>src/include/catalog/pg_control.h</code></a>.</p>
</blockquote>
<p>尽管对我们来说新格式稍显复杂，但它对于资源管理器的解析而言，设计更为合理，而且许多类型的XLOG记录的大小都比先前要小。主要的结构如图9.8和图9.10所示，你可以计算并相互比较这些记录的大小。（新版<code>CheckPoint</code>记录的尺寸要比旧版本大一些，但它也包含了更多的变量）。</p>
<h2 id="95-wal记录的写入">9.5 WAL记录的写入</h2>
<p>完成了热身练习后，现在我们已经做好理解XLOG记录写入过程的准备了。因此在本节中，我将尽可能仔细地描述。首先，以下列语句的执行为例，让我们来看一看PostgreSQL的内幕。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;A&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>通过发出上述语句，内部函数<code>exec_simple_query()</code>会被调用，其伪代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">exec_simple_query</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#a40000">@</span><span style="color:#000">postgres</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ExtendCLOG</span><span style="color:#000;font-weight:bold">()</span>	<span style="color:#a40000">@</span><span style="color:#000">clog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>     <span style="color:#8f5902;font-style:italic">/* 将当前事务的状态&#34;IN_PROGRESS&#34;写入CLOG */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">heap_insert</span><span style="color:#000;font-weight:bold">()</span>	<span style="color:#a40000">@</span><span style="color:#000">heapam</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>	<span style="color:#8f5902;font-style:italic">/* 插入元组，创建一条XLOG记录并调用函XLogInsert. */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#000">XLogInsert</span><span style="color:#000;font-weight:bold">()</span>	<span style="color:#a40000">@</span><span style="color:#000">xlog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span> 	<span style="color:#8f5902;font-style:italic">/* (9.5 以及后续的版本为 xloginsert.c) */</span>
</span></span><span style="display:flex;"><span>								<span style="color:#8f5902;font-style:italic">/* 将插入元组的XLOG记录写入WAL缓冲区，更新页面的 pd_lsn */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">finish_xact_command</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#a40000">@</span><span style="color:#000">postgres</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>	<span style="color:#8f5902;font-style:italic">/* 执行提交 */</span>   
</span></span><span style="display:flex;"><span>      <span style="color:#000">XLogInsert</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#a40000">@</span><span style="color:#000">xlog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>  			<span style="color:#8f5902;font-style:italic">/* (9.5 以及后续的版本为 xloginsert.c) */</span>
</span></span><span style="display:flex;"><span>										<span style="color:#8f5902;font-style:italic">/* 将该提交行为的XLOG记录写入WAL缓冲区 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#000">XLogWrite</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#a40000">@</span><span style="color:#000">xlog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>				<span style="color:#8f5902;font-style:italic">/* 将WAL缓冲区中所有的XLOG刷写入WAL段中 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">TransactionIdCommitTree</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#a40000">@</span><span style="color:#000">transam</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>	
</span></span><span style="display:flex;"><span>							<span style="color:#8f5902;font-style:italic">/* 在CLOG中将当前事务的状态由&#34;IN_PROGRESS&#34;修改为&#34;COMMITTED&#34; /*
</span></span></span></code></pre></div><p>在接下来的段落中将会解释每一行伪代码，从而理解XLOG记录写入的过程。如图9.11和图9.12所示。</p>
<ol>
<li>函数<code>ExtendCLOG()</code>将当前事务的状态<code>IN_PROGRESS</code>写入内存中的CLOG。</li>
<li>函数<code>heap_insert()</code>向共享缓冲池的目标页面中插入堆元组，创建当前页面的XLOG记录，并执行函数<code>XLogInsert()</code>。</li>
<li>函数<code>XLogInsert()</code>会将<code>heap_insert()</code>创建的XLOG记录写入WAL缓冲区<code>LSN_1</code>处，并将被修改页面的<code>pd_lsn</code>从<code>LSN_0</code>更新为<code>LSN_1</code>。</li>
<li>函数<code>finish_xact_command()</code>会在该事务被提交时被调用，用于创建该提交动作的XLOG记录，而这里的<code>XLogInsert()</code>函数会将该记录写入WAL缓冲区<code>LSN_2</code>处。</li>
</ol>
<p><strong>图9.11 XLOG记录的写入顺序</strong></p>
<p><img src="/img/blog/kernel/fig-9-11.png"></p>
<blockquote>
<p>上图的XLOG格式是9.4版本的</p>
</blockquote>
<ol start="5">
<li>函数<code>XLogWrite()</code>会冲刷WAL缓冲区，并将所有内容写入WAL段文件中。如果<code>wal_sync_method</code>参数被配置为<code>open_sync</code>或<code>open_datasync</code>，记录会被同步写入（译者注：而不是提交才会刷新WAL缓冲区），因为函数会使用带有<code>O_SYNC</code>或<code>O_DSYNC</code>标记的<code>open()</code>系统调用。如果该参数被配置为<code>fsync</code>，<code>fsync_writethrough</code>，<code>fdatasync</code>，相应的系统调用就是<code>fsync()</code>，带有<code>F_FULLSYNC</code>选项的<code>fcntl()</code>，以及<code>fdatasync()</code>。无论哪一种情况，所有的XLOG记录都会被确保写入存储之中。</li>
<li>函数<code>TransactionIdCommitTree()</code>将提交日志clog中当前事务的状态从<code>IN_PROGRESS</code>更改为<code>COMMITTED</code>。</li>
</ol>
<p><strong>图9.12 XLOG记录的写入顺序（续图9.11）</strong></p>
<p><img src="/img/blog/kernel/fig-9-12.png"></p>
<p>在上面这个例子中，<code>COMMIT</code>操作致使XLOG记录写入WAL段文件。但发生在下列任一情况时，都会执行这种写入操作：</p>
<ol>
<li>一个运行中的事务提交或中止。</li>
<li>WAL缓冲区被写入的元组填满（WAL缓冲区的大小由参数<code>wal_buffers</code>控制）</li>
<li>WAL写入者进程周期性执行写入（参见下一节）</li>
</ol>
<p>如果出现上述情况之一，无论其事务是否已提交，WAL缓冲区上的所有WAL记录都将写入WAL段文件中。</p>
<p>DML操作写XLOG记录是理所当然的，但非DML操作也会产生XLOG。如上所述，<code>COMMIT</code>操作会写入包含着提交的事务ID的XLOG记录。另一个例子是<code>Checkpoint</code>操作会写入关于该检查点概述信息的XLOG记录。此外，尽管不是很常见，<code>SELECT</code>语句在一些特殊情况下也会创建XLOG记录。例如在SELECT语句处理的过程中，如果因为HOT（Heap Only Tuple）需要删除不必要元组并拼接必要的元组时，修改对应页面的XLOG记录就会写入WAL缓冲区。</p>
<h2 id="96-wal写入进程">9.6 WAL写入进程</h2>
<p>WAL写入者是一个后台进程，用于定期检查WAL缓冲区，并将所有未写入的XLOG记录写入WAL段文件。 这个进程的目的是避免XLOG记录的突发写入。 如果没有启用该进程，则在一次提交大量数据时，XLOG记录的写入可能会成为瓶颈。</p>
<p>WAL写入者默认是启用的，无法禁用。但检查间隔可以通过参数<code>wal_writer_delay</code>进行配置，默认值为200毫秒。</p>
<h2 id="97-postgresql中的检查点过程">9.7 PostgreSQL中的检查点过程</h2>
<p>在PostgreSQL中，检查点进程（后台）会执行检查点；当下列情形之一发生时，它会启动处理：</p>
<ol>
<li>距离上次检查点已经过去了由参数<code>checkpoint_timeout</code>配置的时间间隔（默认间隔为300秒（5分钟））。</li>
<li>在9.4及以前的版本中，自上一次检查点以来消耗的WAL段文件超出了参数<code>checkpoint_segments</code>的数量（默认值为3）。</li>
<li>在9.5及以后的版本，<code>pg_xlog</code>（10之后是<code>pg_wal</code>）中的WAL段文件总大小超过参数<code>max_wal_size</code>配置的值（默认值为1GB，64个段文件）。</li>
<li>PostgreSQL服务器以<code>smart</code>或<code>fast</code>模式关闭。</li>
</ol>
<p>当超级用户手动执行<code>CHECKPOINT</code>命令时，该进程也会启动。</p>
<blockquote>
<p>在9.1或更早的版本中，后台写入进程（见8.6节）同时负责脏页写入与检查点。</p>
</blockquote>
<p>在接下来的几个小节中会简要描述检查点过程与<code>pg_control</code>文件，<code>pg_control</code>文件保存了当前检查点的元数据。</p>
<h3 id="971-检查点过程概述">9.7.1 检查点过程概述</h3>
<p>检查点进程负责两个方面：为数据库恢复做准备工作，以及共享缓冲池上脏页的刷盘工作。在本小节介绍其内部过程时，将重点关注前一个方面。参见图9.13和以下描述。</p>
<p><strong>图9.13 PostgreSQL检查点的内部流程</strong></p>
<p><img src="/img/blog/kernel/fig-9-13.png"></p>
<ol>
<li>当检查点进程启动时，会将**重做点（REDO Point）**存储在内存中；<strong>重做点</strong>是上次检查点开始时刻时XLOG记录的写入位置，也是数据库恢复的开始位置。</li>
<li>该检查点相应的XLOG记录（即检查点）会被写入WAL缓冲区，该记录的数据部分是由<code>CheckPoint</code>结构体定义的，包含了一些变量，比如第一步中重做点的位置。另外，写入检查点记录的位置，也按照字面意义叫做<strong>检查点（checkpoint</strong>）。</li>
<li>共享内存中的所有数据（例如，CLOG的内容）都会被刷入持久存储中。</li>
<li>共享缓冲池中的所有脏页都会被逐渐刷写到存储中。</li>
<li>更新<code>pg_control</code>文件，该文件包含了一些基础信息，例如上一次检查点的位置，后面会介绍该文件的细节</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">CheckPoint</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">XLogRecPtr</span>      <span style="color:#000">redo</span><span style="color:#000;font-weight:bold">;</span>           <span style="color:#8f5902;font-style:italic">/* 当创建存盘时，下一个可用的RecPtr(即重做点) */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">TimeLineID</span>      <span style="color:#000">ThisTimeLineID</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 当前时间线ID TLI */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">TimeLineID</span>      <span style="color:#000">PrevTimeLineID</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 前一个时间线ID TLI, 如果当前记录开启了一条新的时间线
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                                   * (其他情况下等于ThisTimeLineID) */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">bool</span>            <span style="color:#000">fullPageWrites</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 当前全页写入的状态 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uint32</span>          <span style="color:#000">nextXidEpoch</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* 下一个时事务ID（nextXid）的高位bit */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">TransactionId</span>   <span style="color:#000">nextXid</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 下一个空闲事务ID */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Oid</span>             <span style="color:#000">nextOid</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 下一个空闲OID */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">MultiXactId</span>     <span style="color:#000">nextMulti</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* 下一个空闲MultiXactId */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">MultiXactOffset</span> <span style="color:#000">nextMultiOffset</span><span style="color:#000;font-weight:bold">;</span><span style="color:#8f5902;font-style:italic">/* 下一个空闲MultiXact 偏移量 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">TransactionId</span>   <span style="color:#000">oldestXid</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* 集蔟范围最小的datfronzenxid */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Oid</span>             <span style="color:#000">oldestXidDB</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* 带有最小datfrozenxid的数据库 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">MultiXactId</span>     <span style="color:#000">oldestMulti</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* 集蔟范围内最小的datminmxid */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Oid</span>             <span style="color:#000">oldestMultiDB</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">/* 带有最小datminmxid的数据库 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">pg_time_t</span>       <span style="color:#000">time</span><span style="color:#000;font-weight:bold">;</span>           <span style="color:#8f5902;font-style:italic">/* 存盘的时间戳 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic">/* 最老的仍然在运行的事务ID，只有当从在线检查点中初始化一个热备时才会需要该字段。因此只有
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  * 当在线检查点且wal_level配置为热备时我们才会费劲计算这个字段。其他情况下会被设置为
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  * InvalidTransactionId  */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">TransactionId</span> <span style="color:#000">oldestActiveXid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">CheckPoint</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>让我们从数据库恢复的角度来总结上面的内容，检查点过程会创建包含重做点的检查点，并将检查点位置与其他信息存储到<code>pg_control</code>文件中。因此，PostgreSQL能够通过从重做点回放WAL数据来进行恢复（重做点是从检查点中获取的）。</p>
<h3 id="972-pg_crontrol文件">9.7.2 <code>pg_crontrol</code>文件</h3>
<p>由于<code>pg_control</code>文件包含了检查点的基本信息，因此它对于数据库恢复肯定是必不可少的。如果它被破坏或不可读，因为系统不知道从哪里开始恢复，则恢复过程就无法启动。</p>
<p>尽管<code>pg_control</code>文件存储了40多条数据项，如下三个是接下来和我们讨论内容相关的：</p>
<ol>
<li><strong>状态（State）</strong> —— 最近检查点过程开始时数据库的状态，总共有七种状态：<code>start up</code>表示系统正在启动，<code>shut down</code>表示系统被关机命令正常关闭，<code>in production</code>表示数据库正在运行，诸如此类。</li>
<li><strong>最新检查点位置（Latest Checkpoint Location）</strong> —— 最新检查点的LSN位置</li>
<li><strong>上次检查点位置（Prior Checkpoint Location）</strong>—— 前一个检查点的LSN位置，在版本11中已经弃用，细节如引文所示。</li>
</ol>
<p><code>pg_control</code>文件存储在数据目录中<code>global</code>子目录内；可以使用<code>pg_controldata</code>程序显示其内容。</p>
<blockquote>
<h3 id="postgresql11中移除了前任检查点">PostgreSQL11中移除了前任检查点</h3>
<p>PostgreSQL 11及后续版本只会存储包含最新检查点或更新版本的WAL段文件；将不会存储包含先前检查点的旧段文件，以减少用于在<code>pg_xlog(pg_wal)</code>子目录下保存WAL段文件的磁盘空间。 详细信息请参见此<a href="http://www.postgresql-archive.org/Remove-secondary-checkpoint-tt5989050.html">主题</a>。</p>
</blockquote>
<h2 id="98-postgresql中的数据库恢复">9.8 PostgreSQL中的数据库恢复</h2>
<p>PostgreSQL的恢复功能基于**重做日志（REDO log）**实现。如果数据库服务器崩溃，PostgreSQL通过从REDO点依序重放WAL段文件中的XLOG记录来恢复数据库集群。</p>
<p>在本节之前，我们已经多次讨论过数据库恢复，所以这里将会介绍两个与恢复有关，但尚未解释过的事情。</p>
<p>第一件事是PostgreSQL如何启动恢复过程。当PostgreSQL启动时，它首先读取<code>pg_control</code>文件。以下是从那时起恢复处理的细节。参见图9.14和以下描述。</p>
<p><strong>图9.14 恢复过程的细节</strong></p>
<p><img src="/img/blog/kernel/fig-9-14.png"></p>
<ol>
<li>PostgreSQL在启动时读取<code>pg_control</code>文件的所有项。如果<code>state</code>项是<code>in production</code>，PostgreSQL将进入恢复模式，因为这意味着数据库没有正常停止；如果是<code>shut down</code>，它就会进入正常的启动模式。</li>
<li>PostgreSQL从合适的WAL段文件中读取最近的检查点，该记录的位置写在<code>pg_control</code>文件中，并从该检查点中获得重做点。如果最新的检查点是无效的，PostgreSQL会读取前一个检查点。如果两个记录都不可读，它就会放弃自我恢复（注意在PostgreSQL11中不会存储前一个检查点）。</li>
<li>使用合适的资源管理器按顺序读取并重放XLOG记录，从重做点开始，直到最新WAL段文件的最后位置。当遇到一条属于备份区块的XLOG记录时，无论其LSN如何，它都会覆写相应表的页面。其他情况下，只有当此记录的LSN大于相应页面的<code>pd_lsn</code>时，才会重放该（非备份区块的）XLOG记录。</li>
</ol>
<p>第二件事是关于LSN的比较：为什么应该比较非备份区块的LSN和相应页面的<code>pd_lsn</code>。与前面的示例不同，这里使用需要在两个LSN之间进行比较的具体例子来解释，如图9.15和图9.16。 （注意这里省略了WAL缓冲区，以简化描述）。</p>
<p><strong>图9.15 当后台写入者工作时的插入操作</strong></p>
<p><img src="/img/blog/kernel/fig-9-15.png"></p>
<ol>
<li>
<p>PostgreSQL将一条元组插入表A，并将一条XLOG记录写入<code>LSN_1</code>。</p>
</li>
<li>
<p>后台写入者进程将表A的页面写入存储。此时，此页面的<code>pd_lsn</code>为<code>LSN_1</code>。</p>
</li>
<li>
<p>PostgreSQL在表A中插入一条新元组，并在<code>LSN_2</code>处写入一条XLOG记录。修改后的页面尚未写入存储。</p>
</li>
</ol>
<p>与本章概述中的例子不同，在本场景中，表A的页面已经被一次性写入存储中。</p>
<p>使用<code>immediate</code>模式关闭数据库，然后启动数据库。</p>
<p><strong>图9.16 数据库恢复</strong></p>
<p><img src="/img/blog/kernel/fig-9-15.png"></p>
<ol>
<li>PostgreSQL加载第一条XLOG记录和表A的页面，但不重放它，因为该记录的LSN不大于表A的LSN（两个值都是<code>LSN_1</code>）。实际上一目了然，没有重放该记录的必要性。</li>
<li>接下来，PostgreSQL会重放第二条XLOG记录，因为该记录的LSN（<code>LSN_2</code>）大于当前表A的LSN（<code>LSN_1</code>）。</li>
</ol>
<p>从这个例子中可以看出，如果非备份区块的重放顺序不正确，或者多次重放非备份区块，数据库集群将不再一致。简而言之，非备份区块的重做（重放）操作不是**幂等（idempotent）**的。因此，为了确保正确的重放顺序，非备份区块中的记录当且仅当其LSN大于相应页面的<code>pd_lsn</code>时，才执行重放。</p>
<p>另一方面，由于备份区块的重放操作是幂等的，不管其LSN为何值，备份块可以重放任意次。</p>
<h2 id="99-wal段文件管理">9.9 WAL段文件管理</h2>
<p>PostgreSQL将XLOG记录写入<code>pg_xlog</code>子目录中的WAL段文件中（版本10之后是<code>pg_wal</code>子目录），当旧的段文件写满时就会切换至新的段文件。WAL文件的数量会根据几个配置参数的变化而变化，一些服务器的行为也会相应变化。此外，在9.5版中，段文件的管理机制也有了一些改善。</p>
<h3 id="991-wal段切换">9.9.1 WAL段切换</h3>
<p>当出现下列任一情况时，WAL段会发生切换：</p>
<ol>
<li>WAL段已经被填满。</li>
<li>函数<code>pg_switch_xlog()</code>（10以后为<code>pg_switch_wal()</code>）被调用。</li>
<li>启用了<code>archive_mode</code>，且已经超过<code>archive_timeout</code>配置的时间。</li>
</ol>
<p>被切换的文件通常会被回收（重命名或重用），以供未来之用。但如果不是需要的话，也可能会被移除。</p>
<h3 id="992-wal段管理95版及以后">9.9.2 WAL段管理（9.5版及以后）</h3>
<p>每当检查点过程启动时，PostgreSQL都会估计并准备下一个检查点周期所需的WAL段文件数。这种估计基于前一个检查点周期中消耗的文件数量，即从包含上一个重做点的段文件开始计数，而这个值应当在<code>min_wal_size</code>（默认80MB，5个文件）与<code>max_wal_size</code>之间（默认1GB，64个文件）。如果检查点过程启动，必需的段文件会被保留或回收，而不必要的段文件会被移除。</p>
<p>一个具体的例子如图9.17所示，假设在检查点开始前有六个文件，<code>WAL_3</code>包含了上一个重做点（版本10及以前，版本11后就是当前重做点），PostgreSQL估计会需要五个文件，在这种情况下，<code>WAL_1</code>被重命名为<code>WAL_7</code>回收利用，而<code>WAL_2</code>会被移除。</p>
<blockquote>
<p>任何比包含上一个重做点的段文件更老的段文件都可以被移除，因为按照9.8节中描述的恢复机制，这些文件永远不会被用到了。</p>
</blockquote>
<p><strong>图9.17 在检查点时发生的WAL段文件循环与回收</strong></p>
<p><img src="/img/blog/kernel/fig-9-17.png"></p>
<p>如果出现了WAL活动尖峰，导致需要更多的文件，新的文件会被创建，而WAL文件的总大小是小于<code>max_wal_size</code>的。例如在图9.18中，如果<code>WAL_7</code>被填满，<code>WAL_8</code>就会被新创建出来。</p>
<p><strong>9.18 创建WAL段文件</strong></p>
<p><img src="/img/blog/kernel/fig-9-18.png"></p>
<p>WAL文件的数量会根据服务器活动而自动适配。 如果WAL数据写入量持续增加，则WAL段文件的估计数量以及WAL文件的总大小也会逐渐增加。 在相反的情况下（即WAL数据写入量减少），这些值也会减少。</p>
<p>如果WAL文件的总大小超过<code>max_wal_size</code>，则将启动检查点。 图9.19说明了这种情况。 检查点将会创建一个新的重做点，最近的重做点将会变为上一个重做点，不是必需的文件将被回收。通过这种方式，PostgreSQL将始终只保留数据库恢复所必需的WAL段文件。</p>
<p><strong>图9.19 检查点与回收WAL段文件</strong></p>
<p><img src="/img/blog/kernel/fig-9-19.png"></p>
<p>配置参数<code>wal_keep_segments</code>以及**复制槽（Replication Slot）**功能都会影响WAL段文件的数量。</p>
<h3 id="993-wal段管理94版及以前">9.9.3 WAL段管理（9.4版及以前）</h3>
<p>WAL段文件的数量主要由下列三个参数控制：</p>
<ul>
<li><code>checkpoint_segments</code></li>
<li><code>checkpoint_completion_target</code></li>
<li><code>wal_keep_segments</code>。</li>
</ul>
<p>WAL段文件的数量通常会：</p>
<p>比 $((2 + \verb|checkpoint_completion_target|) × \verb|checkpoint_segments| + 1 )$ 要大</p>
<p>比$( \verb|checkpoint_segments| + \verb|wal_keep_segments| + 1)$要大</p>
<p>且不超过$(3×\verb|checkpoint_segments|+1)$个文件</p>
<p>WAL段文件具体数目的取决于不同的服务器活动，复制槽的存在也会影响WAL文件的数量。</p>
<p>如第9.7节中所提到的，当消耗了超过<code>checkpoint_segments</code>个数量的文件时，就会启动检查点过程。因此可以保证WAL段文件中总是包含至少两个重做点，因为文件的数量始终大于$2×\verb|checkpoint_segments|$，对于由超时导致的检查点同样适用。PostgreSQL总是会保留足够用于恢复的WAL段文件（有时候会超出必需的量）。</p>
<blockquote>
<p>在版本9.4或更早版本中，调整参数<code>checkpoint_segments</code>是一个痛苦的问题。 如果设置为较小的值，则检查点会频繁发生，这会导致性能下降；而如果设置为较大的数值，则WAL文件总是需要巨大的磁盘空间，但其中一些空间不是必须的。</p>
<p>在9.5版本中，WAL文件的管理策略得到了改善，而<code>checkpoint_segments</code>参数被弃用，因此上述的权衡问题已经得到解决。</p>
</blockquote>
<h2 id="910-归档日志与持续归档">9.10 归档日志与持续归档</h2>
<p><strong>持续归档（continuous archiving）<strong>是当WAL段文件发生切换时会自动将其拷贝至归档区域的一项功能。持续归档是由归档后台进程执行的，拷贝的文件称为</strong>归档日志（archive log）</strong>。该功能通常用于物理备份与时间点恢复（参见<a href="/zh/blog/kernel/ch10/">第十章</a>）。</p>
<p>归档区域的配置取决于配置参数<code>archieve_command</code>，例如使用下列配置时，每当发生段文件切换时，WAL段文件会被拷贝到目录<code>/home/postgres/archives</code>目录下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">archive_command</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;cp %p /home/postgres/archives/%f&#39;</span>
</span></span></code></pre></div><p>这里<code>%p</code>是被拷贝WAL段文件的路径占位符，而<code>%f</code>是归档日志文件名的占位符。</p>
<p><strong>图9.20 持续归档</strong></p>
<p><img src="/img/blog/kernel/fig-9-20.png"></p>
<p>当WAL段文件<code>WAL_7</code>发生切换时，该文件被拷贝至归档区域，作为归档日志7。</p>
<p><code>archive_command</code>参数可以配置为任意的Unix命令或程序，因此你也能用<code>scp</code>将归档日志发送到其他主机上，或使用任意的文件备份工具来替代普通的拷贝命令。</p>
<blockquote>
<p>PostgreSQL<strong>并不会</strong>清理归档日志，所以在使用该功能时需要管理好这些日志。如果什么都不做，归档日志的数量会不断增长。</p>
<p><a href="https://www.postgresql.org/docs/current/static/pgarchivecleanup.html"><code>pg_archivecleanup</code></a>工具是一个管理归档日志的实用工具。</p>
</blockquote>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-982c12de27d971f4bf42fb2127f9aa9f">第十章 基础备份与时间点恢复</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://www.interdb.jp/pg/">Hironobu SUZUKI</a> ，译者：<a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-01-02" class="text-muted">2018年01月02日</time>
        
	</div>
	<p>在线数据库备份大致可分为两类：逻辑备份和物理备份。它们有着各自的优点和缺点。尽管各有优劣，但逻辑备份有一个缺点：执行需要花费太多时间。特别是对于大型数据库而言，需要花费很长时间进行备份，而从备份数据中恢复数据库可能需要更长的时间。相反的是，物理备份可以在相对较短的时间内备份和恢复大型数据库，因此在实际系统中，它是一个非常重要而实用的功能。</p>
<p>在PostgreSQL中，自8.0版本开始提供在线的全量物理备份，整个数据库集簇（即物理备份数据）的运行时快照称为<strong>基础备份（base backup）</strong>。</p>
<p>PostgreSQL还在8.0版中引入了<strong>时间点恢复（Point-In-Time Recovery, PITR）</strong>。这一功能可以将数据库恢复至任意时间点，这是通过使用一个<strong>基础备份</strong>和由<a href="/zh/blog/kernel/ch9/">持续归档</a>生成的<strong>归档日志</strong>来实现的。例如，即使你犯了一个严重的错误（例如<code>TRUNCATE</code>所有的表），此功能使您可以将数据库恢复至错误发生之前的时刻。</p>
<p>本章描述了以下主题：</p>
<ul>
<li>什么是基础备份</li>
<li>PITR的工作原理</li>
<li>时间线标识（TimelineID）是什么</li>
<li>时间线历史文件是什么</li>
</ul>
<blockquote>
<p>在7.4或更早版本中，PostgreSQL仅支持逻辑备份（全量逻辑备份、部分逻辑备份，数据导出）。</p>
</blockquote>
<h2 id="101-基础备份">10.1 基础备份</h2>
<p>首先，使用底层命令进行基本备份的标准过程如下所示：</p>
<ol>
<li>
<p>发出<a href="https://www.postgresql.org/docs/current/static/functions-admin.html#FUNCTIONS-ADMIN-BACKUP"><code>pg_start_backup</code></a>命令</p>
</li>
<li>
<p>使用你想用的归档命令获取数据库集簇的快照</p>
</li>
<li>
<p>发出<a href="https://www.postgresql.org/docs/current/functions-admin.html#FUNCTIONS-ADMIN-BACKUP"><code>pg_stop_backup</code></a>命令</p>
</li>
</ol>
<p>这个简单的过程对于DBA来说很容易操作，因为它不需要特殊工具，只需要常用工具（如复制命令或类似的归档工具）来创建基本备份。此外，在此过程中，不需要获取表上的锁，所有用户都可以在不受备份操作影响的情况下发起查询。相对于其他开源关系型数据库，这是一个巨大的优势。</p>
<p>更简单的方式是使用<a href="https://www.postgresql.org/docs/current/static/app-pgbasebackup.html"><code>pg_basebackup</code></a>命令来做基础备份，不过在它内部也是使用这些底层命令来工作的。</p>
<p><strong>图10.1 制作基础备份</strong></p>
<p><img src="/img/blog/kernel/fig-10-01.png"></p>
<p>由于这些命令对显然是理解PITR的关键点之一，我们将在以下小节中探讨它们。</p>
<blockquote>
<p><code>pg_start_backup</code>和<code>pg_stop_backup</code>命令定义在：<a href="https://github.com/postgres/postgres/blob/master/src/backend/access/transam/xlogfuncs.c"><code>src/backend/access/transam/xlogfuncs.c</code></a>。</p>
</blockquote>
<h3 id="1011-pg_start_backup">10.1.1 <code>pg_start_backup</code></h3>
<p><code>pg_start_backup</code>开始为制作基础备份进行准备工作。如<a href="/zh/blog/kernel/ch9/">第9.8节</a>所述，恢复过程从重做点开始，因此<code>pg_start_backup</code>必须执行检查点，以便在制作基础备份的开始时刻显式创建一个重做点。此外，这次检查点的检查点位置必须保存在不同于<code>pg_control</code>的其他文件中，因为在备份期间可能会进行多次常规检查点。因此<code>pg_start_backup</code>执行下列四个操作：</p>
<ol>
<li>强制进入<strong>整页写入</strong>模式。</li>
<li>切换到当前的WAL段文件（8.4或更高版本）。</li>
<li>执行检查点。</li>
<li>创建<code>backup_label</code>文件 —— 该文件创建于基本目录顶层中，包含有关该基本备份本身的关键信息，例如检查点的检查点位置。</li>
</ol>
<p>第三和第四个操作是该命令的核心。第一和第二个操作是为了更可靠地恢复数据库集簇。</p>
<p>备份标签<code>backup_label</code>文件包含以下六个项目（11或更新版本为七个项目）：</p>
<ul>
<li><strong>检查点位置（<code>CHECKPOINT LOCATION</code>）</strong> —— 该命令所创建检查点的LSN位置。</li>
<li><strong>WAL开始位置（<code>START WAL LOCATION</code>）</strong> —— 这不是给PITR用的，而是为<a href="/zh/blog/kernel/ch11/">第11章</a>描述的流复制准备的。它被命名为<code>START WAL LOCATION</code>，因为复制模式下的备用服务器在初始启动时只读取一次该值。</li>
<li><strong>备份方法（<code>BACKUP METHOD</code>）</strong> —— 这是用于进行此基本备份的方法。 （<code>pg_start_backup</code>或<code>pg_basebackup</code>）</li>
<li><strong>备份来源（<code>BACKUP FROM</code>）</strong> —— 说明此备份是从主库还是备库拉取。</li>
<li><strong>开始时间（<code>START TIME</code>）</strong>——  这是执行<code>pg_start_backup</code>时的时间戳。</li>
<li><strong>备份标签（<code>LABEL</code>）</strong> —— 这是<code>pg_start_backup</code>中指定的标签。</li>
<li><strong>开始时间线（<code>START TIMELINE</code>）</strong> —— 这是备份开始的时间线。这是为了进行正常性检查，在版本11中被引入。</li>
</ul>
<blockquote>
<h4 id="备份标签">备份标签</h4>
<p>一个9.6版本中备份标签的实际例子如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>postgres&gt; cat /usr/local/pgsql/data/backup_label
</span></span><span style="display:flex;"><span>START WAL LOCATION: 0/9000028 <span style="color:#ce5c00;font-weight:bold">(</span>file 000000010000000000000009<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>CHECKPOINT LOCATION: 0/9000060
</span></span><span style="display:flex;"><span>BACKUP METHOD: pg_start_backup
</span></span><span style="display:flex;"><span>BACKUP FROM: master
</span></span><span style="display:flex;"><span>START TIME: 2018-7-9 11:45:19 GMT
</span></span><span style="display:flex;"><span>LABEL: Weekly Backup
</span></span></code></pre></div></blockquote>
<p>可以想象，当使用此基础备份恢复数据库时，PostgreSQL从<code>backup_label</code>文件中取出检查点位置<code>CHECKPOINT LOCATION</code>，然后从归档日志中的合适位置读取检查点记录，然后从检查点记录中获取重做点的位置，最后从重做点开始进行恢复过程（下一节将介绍细节）。</p>
<h3 id="1012-pg_stop_backup">10.1.2 <code>pg_stop_backup</code></h3>
<p><code>pg_stop_backup</code>执行以下五个操作以完成备份。</p>
<ol>
<li>如果<code>pg_start_backup</code>打开了<strong>整页写入</strong>，那么关闭<strong>整页写入</strong>。</li>
<li>写入一条备份结束的XLOG记录。</li>
<li>切换WAL段文件。</li>
<li>创建一个备份历史记录文件 —— 此文件包含<code>backup_label</code>文件的内容，以及已执行<code>pg_stop_backup</code>的时间戳。</li>
<li>删除<code>backup_label</code>文件 —— 从基础备份恢复需要<code>backup_label</code>文件，不过一旦被复制，原始的数据库集簇中就不需要它了。</li>
</ol>
<blockquote>
<p>备份历史文件的命名方法如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">WAL段文件名</span><span style="color:#000;font-weight:bold">}.{</span><span style="color:#a40000">基础备份开始时的偏移量</span><span style="color:#000;font-weight:bold">}.</span><span style="color:#000">backup</span>
</span></span></code></pre></div></blockquote>
<h2 id="102-时间点恢复pitr的工作原理">10.2 时间点恢复（PITR）的工作原理</h2>
<p>图10.2展示了PITR的基本概念。 PITR模式下的PostgreSQL会在基础备份上重放归档日志中的WAL数据，从<code>pg_start_backup</code>创建的重做点开始，恢复至你想要的位置为止。在PostgreSQL中，要恢复到的位置，被称为<strong>恢复目标（recovery target）</strong>。</p>
<p><strong>图10.2 PITR的基本概念</strong></p>
<p><img src="/img/blog/kernel/fig-10-02.png"></p>
<p>PITR是这样工作的。假设你在GMT时间<code>2018-07-16 12:05:00</code>搞出了错误。那你应该删掉当前的数据库集簇，并使用之前制作的基础备份恢复一个新的出来。然后，创建一个<code>recovery.conf</code>文件，并在其中将参数<code>recovery_target_time</code>参数配置为你犯错误的时间点（在本例中，也就是12:05 GMT） 。<code>recovery.conf</code>文件如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Place archive logs under /mnt/server/archivedir directory.</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">restore_command</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;cp /mnt/server/archivedir/%f %p&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">recovery_target_time</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;2018-7-16 12:05 GMT&#34;</span>
</span></span></code></pre></div><p>当PostgreSQL启动的时候，如果数据库集簇中存在<code>recovery.conf</code>和<code>backup_label</code>文件，它就会进入恢复模式。</p>
<p>PITR过程几乎与<a href="/zh/blog/kernel/ch9/">第九章</a>中描述的常规恢复过程一模一样，唯一的区别只有以下两点：</p>
<ol>
<li>从哪里读取WAL段/归档日志？
<ul>
<li>正常恢复模式 —— 来自基础目录下的<code>pg_xlog</code>子目录（10或更新版本，<code>pg_wal</code>子目录）。</li>
<li>PITR模式 —— 来自配置参数<code>archive_command</code>中设置的归档目录。</li>
</ul>
</li>
<li>从哪里读取检查点位置？
<ul>
<li>正常恢复模式 —— 来自<code>pg_control</code>文件。</li>
<li>PITR模式 —— 来自<code>backup_label</code>文件。</li>
</ul>
</li>
</ol>
<p>PITR流程概述如下：</p>
<ol>
<li>
<p>为了找到重做点，PostgreSQL使用内部函数<code>read_backup_label</code>从<code>backup_label</code>文件中读取<code>CHECKPOINT LOCATION</code>的值。</p>
</li>
<li>
<p>PostgreSQL从<code>recovery.conf</code>中读取一些参数值；在此示例中为<code>restore_command</code>和<code>recovery_target_time</code>。</p>
</li>
<li>
<p>PostgreSQL开始从重做点重放WAL数据，重做点的位置可以简单地从<code>CHECKPOINT LOCATION</code>的值中获得。 PostgreSQL执行参数<code>restore_command</code>中配置的命令，将归档日志从归档区域拷贝到临时区域，并从中读取WAL数据（复制到临时区域中的日志文件会在使用后删除）。</p>
<p>在本例中，PostgreSQL从重做点读取并重放WAL数据，直到时间戳<code>2018-7-16 12:05:00</code>为止，因为参数<code>recovery_target_time</code>被设置为该时间戳。如果<code>recovery.conf</code>中没有配置恢复目标，则PostgreSQL将重放至归档日志的末尾。</p>
</li>
<li>
<p>当恢复过程完成时，会在<code>pg_xlog</code>子目录（10或更高版本为<code>pg_wal</code>子目录）中创建时间线历史文件，例如<code>00000002.history</code>；如果启用了日志归档功能，则还会在归档目录中创建相同的命名文件。以下各节介绍了此文件的内容和作用。</p>
</li>
</ol>
<p>提交和中止操作的记录包含每个操作完成时的时间戳（两个操作的XLOG数据部分分别在<code>xl_xact_commit</code>和<code>xl_xact_abort</code>中定义）。因此，如果将目标时间设置为参数<code>recovery_target_time</code>，只要PostgreSQL重放提交或中止操作的XLOG记录，它可以选择是否继续恢复。当重放每个动作的XLOG记录时，PostgreSQL会比较目标时间和记录中写入的每个时间戳；如果时间戳超过目标时间，PITR过程将完成。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xl_xact_commit</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">TimestampTz</span>	<span style="color:#000">xact_time</span><span style="color:#000;font-weight:bold">;</span>              <span style="color:#8f5902;font-style:italic">/* 提交时间 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">uint32</span>          <span style="color:#000">xinfo</span><span style="color:#000;font-weight:bold">;</span>              <span style="color:#8f5902;font-style:italic">/* 信息标记位 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span>            	<span style="color:#000">nrels</span><span style="color:#000;font-weight:bold">;</span>              <span style="color:#8f5902;font-style:italic">/* RelFileNodes的数量 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span>            	<span style="color:#000">nsubxacts</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">/* 子事务XIDs的数量 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span>            	<span style="color:#000">nmsgs</span><span style="color:#000;font-weight:bold">;</span>              <span style="color:#8f5902;font-style:italic">/* 共享失效消息的数量 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Oid</span>            	<span style="color:#000">dbId</span><span style="color:#000;font-weight:bold">;</span>               <span style="color:#8f5902;font-style:italic">/* MyDatabaseId, 数据库Oid */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Oid</span>            	<span style="color:#000">tsId</span><span style="color:#000;font-weight:bold">;</span>               <span style="color:#8f5902;font-style:italic">/* MyDatabaseTableSpace, 表空间Oid */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* 在提交时需要丢弃的RelFileNode(s)数组 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">RelFileNode</span>     <span style="color:#000">xnodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>          <span style="color:#8f5902;font-style:italic">/* 变长数组 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* 紧接着已提交的子事务XIDs数组 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* 紧接着共享失效消息的数组 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">xl_xact_commit</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xl_xact_abort</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">TimestampTz</span>     <span style="color:#000">xact_time</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">/* 中止时间 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span>            	<span style="color:#000">nrels</span><span style="color:#000;font-weight:bold">;</span>              <span style="color:#8f5902;font-style:italic">/* RelFileNodes的数量 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span>             <span style="color:#000">nsubxacts</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">/* 子事务XIDs的数量 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* 在中止时需要丢弃的RelFileNode(s)数组 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">RelFileNode</span>     <span style="color:#000">xnodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>          <span style="color:#8f5902;font-style:italic">/* 变长数组 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* 紧接着已提交的子事务XIDs数组 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">xl_xact_abort</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><blockquote>
<p>函数<code>read_backup_label</code>定义于<a href="https://github.com/postgres/postgres/blob/master/src/backend/access/transam/xlog.c"><code>src/backend/access/transam/xlog.c</code></a>中。
结构<code>xl_xact_commit</code>和<code>xl_xact_abort</code>定义于<a href="https://github.com/postgres/postgres/blob/master/src/backend/access/transam/xlog.c"><code>src/backend/access/transam/xlog.c</code></a>。</p>
</blockquote>
<blockquote>
<h4 id="为什么可以用一般归档工具做基础备份"> 为什么可以用一般归档工具做基础备份？</h4>
<p>尽管数据库集簇可能是不一致的，但恢复过程是使数据库集簇达成一致状态的过程。由于PITR是基于恢复过程的，所以即使基础备份是一堆不一致的文件，它也可以恢复数据库集簇。因此我们可以在没有文件系统快照功能，或其他特殊工具的情况下，使用一般归档工具做基础备份。</p>
</blockquote>
<h2 id="103-时间线与时间线历史文件">10.3 时间线与时间线历史文件</h2>
<p>PostgreSQL中的时间线用于区分原始数据库集簇和恢复生成的数据库集簇，它是PITR的核心概念。在本节中，描述了与时间线相关的两件事：<strong>时间线标识（TimelineID）</strong>，以及<strong>时间线历史文件（Timeline History Files）</strong>。</p>
<h3 id="1031-时间线标识timelineid">10.3.1 时间线标识（<code>TimelineID</code>）</h3>
<p>每个时间线都有一个相应的<strong>时间线标识</strong>，一个四字节的无符号整型，从1开始计数。</p>
<p>每个数据库集簇都会被指定一个时间线标识。由<code>initdb</code>命令创建的原始数据库集簇，其时间线标识为1。每当数据库集簇恢复时，时间线标识都会增加1。例如在前一节的例子中，从原始集簇中恢复得到的集簇，其时间线标识为2。</p>
<p>图10.3从时间线标识的角度展示了PITR过程。首先，我们删除当前的数据库集簇，并替换为过去的基础备份，以便返回到恢复的起始点，这一步在图中用红色曲线箭头标识。接下来，我们启动PostgreSQL服务器，它通过跟踪初始时间线（时间线标识<code>1</code>），从<code>pg_start_backup</code>创建的重做点开始，重放归档日志中的WAL数据，直到恢复目标达成，这一步在图中用蓝色直线箭头标识。接下来，恢复得到的数据库集簇将被分配一个新的时间线标识<code>2</code>，而PostgreSQL将运行在新的时间线上。</p>
<p><strong>图10.3 原始数据库集簇和恢复数据库集簇之间时间线标识的关系</strong></p>
<p><img src="/img/blog/kernel/fig-10-03.png"></p>
<p>正如<a href="/zh/blog/kernel/ch9/">第九章</a>中简要提到的，WAL段文件名的前8位数字等于创建这些段文件的数据库集簇的时间线标识。当时间线标识发生变化时，WAL段文件名也会相应改变。</p>
<p>让我们从WAL段文件的角度重新审视恢复过程。假设我们使用两个归档日志文件来恢复数据库：</p>
<p>$\color{blue}{00000001}0000000000000009$，以及 $\color{blue}{00000001}000000000000000A$。新恢复得到的数据库集簇被分配了时间线标识<code>2</code>，而PostgreSQL就会从 $\color{blue}{00000002}000000000000000A$ 开始创建WAL段。如图10.4所示。</p>
<p><strong>图10.4 原始数据库集簇和恢复数据库集簇之间WAL段文件的关系</strong></p>
<p><img src="/img/blog/kernel/fig-10-04.png"></p>
<h3 id="1032-时间线历史文件">10.3.2 时间线历史文件</h3>
<p>当PITR过程完成时，会在归档目录和<code>pg_xlog</code>子目录（10或更高版本为<code>pg_wal</code>子目录）下创建名称为<code>00000002.history</code>的时间线历史文件。该文件记录了当前时间线是从哪条时间线分叉出来的，以及分叉的时间。</p>
<p>该文件的命名规则如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>“8位数字的新时间线标识”.history
</span></span></code></pre></div><p>时间线历史文件至少包含一行，每行由以下三项组成：</p>
<ul>
<li>时间线标识 —— 曾用于恢复的归档日志的时间线。</li>
<li>LSN —— 发生WAL段切换的LSN位置。</li>
<li>原因 —— 可读的时间线发生变化的原因解释。</li>
</ul>
<p>具体示例如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>postgres&gt; cat /home/postgres/archivelogs/00000002.history
</span></span><span style="display:flex;"><span>1	  0/A000198	before 2018-7-9 12:05:00.861324+00
</span></span></code></pre></div><p>含义如下：</p>
<blockquote>
<p>数据库集簇（时间线标识为2）基于时间线标识为1的基础备份，并在<code>2018-7-9 12:05:00.861324+00</code>之前，通过重放检查点日志，恢复至<code>0/A000198</code>的位置。</p>
</blockquote>
<p>通过这种方式，每个时间线历史文件都会告诉我们每个恢复所得的数据库集簇的完整历史。二期它也在PITR过程中也有使用。下一节将描述具体细节。</p>
<blockquote>
<p>时间线历史文件的格式在9.3版本中发生变化。9.3前后的格式如下所示，但相对简略。</p>
<p>9.3及后续版本：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>timelineId	LSN	&#34;reason&#34;
</span></span></code></pre></div><p>9.2及先前版本</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>timelineId	WAL_segment	&#34;reason&#34;
</span></span></code></pre></div></blockquote>
<h2 id="104-时间点恢复与时间线历史文件">10.4 时间点恢复与时间线历史文件</h2>
<p>时间线历史文件在第二次及后续PITR过程中起着重要作用。通过尝试第二次恢复，我们将探索如何使用它。</p>
<p>同样，假设您在<code>12:15:00</code>又犯了一个错误，错误发生在时间线ID为2的数据库集簇上。在这种情况下为了恢复数据库集簇，你需要创建一个如下所示的<code>recovery.conf</code>文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">restore_command</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;cp /mnt/server/archivedir/%f %p&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">recovery_target_time</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;2018-7-16 12:15:00 GMT&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">recovery_target_timeline</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">2</span>
</span></span></code></pre></div><p>参数<code>recovery_target_time</code>被设置为您犯下新错误的时间，而<code>recovery_target_timeline</code>被设置为<code>2</code>，以便沿着这条时间线恢复。</p>
<p>重启PostgreSQL服务器并进入PITR模式，数据库会沿着时间线标识2进行恢复。如图10.5所示。</p>
<p><strong>图10.5 沿着时间线2将数据库恢复至12:15的状态</strong></p>
<p><img src="/img/blog/kernel/fig-10-05.png"></p>
<ol>
<li>
<p>PostgreSQL从<code>backup_label</code>文件中读取<code>CHECKPOINT LOCATION</code>的值。</p>
</li>
<li>
<p>从<code>recovery.conf</code>中读取一些参数值；在此示例中为<code>restore_command</code>，<code>recovery_target_time</code>和<code>recovery_target_timeline</code>。</p>
</li>
<li>
<p>PostgreSQL读取时间线历史文件<code>00000002.history</code>，该文件对应参数<code>recovery_target_timeline</code>的值。</p>
</li>
<li>
<p>PostgreSQL通过以下步骤重放WAL数据：</p>
<ol>
<li>对于从重做点到<code>LSN 0/A000198</code>（该值写在<code>00000002.history</code>文件中）之间的WAL数据，PostgreSQL会（从合适的归档日志中）读取并重放<code>TimelineID=1</code>的WAL数据。</li>
<li>对于从<code>LSN 0/A000198</code>，到时间戳<code>2018-7-9 12:15:00</code>之间的WAL数据，PostgreSQL会（从合适的归档日志中）读取并重放<code>TimelineID=2</code>的WAL数据。</li>
</ol>
</li>
<li>
<p>当恢复过程完成时，当前的时间线标识将增加到3，并在<code>pg_xlog</code>子目录（10及后续版本为<code>pg_wal</code>子目录）和归档目录中创建名为<code>00000003.history</code>的新时间线历史文件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>postgres&gt; cat /home/postgres/archivelogs/00000003.history
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1</span>         0/A000198     before 2018-7-9 12:05:00.861324+00
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">2</span>         0/B000078     before 2018-7-9 12:15:00.927133+00
</span></span></code></pre></div></li>
</ol>
<p>当你进行过超过一次的PITR时，应明确设置时间线标识，以便使用合适的时间线历史文件。</p>
<p>因此，时间线历史文件不仅仅是数据库集簇的历史日志，还是PITR过程的参考恢复指令。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-285d7f9e5ab8ec8cef0c0d43401c9bf1">第十一章 流复制</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://www.interdb.jp/pg/">Hironobu SUZUKI</a> ，译者：<a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2018-01-01" class="text-muted">2018年01月01日</time>
        
	</div>
	<p>PostgreSQL在9.1版本中实现了流复制。它属于所谓的一主多从类型的复制，而这两个术语 —— <strong>主（master）<strong>和</strong>从（slave）</strong>，在PostgreSQL中通常分别被称为<strong>主（primary）<strong>和</strong>备（standby）</strong>。</p>
<blockquote>
<p>译注：存储数据库副本的每个节点称为<strong>副本（replica）</strong>。每一次对数据库的写入操作都需要传播到所有副本上，否则副本就会包含不一样的数据。最常见的解决方案被称为<strong>基于领导者的复制（leader-based replication）</strong>，也称<strong>主动/被动（active/passive）</strong> 或 <strong>主/从（master/slave）<strong>复制。其中，副本之一被指定为</strong>领导者（leader）</strong>，也称为 <strong>主库（master）</strong> ，<strong>首要（primary）</strong>。当客户端要向数据库写入时，它必须将请求发送给<strong>领导者</strong>，领导者会将新数据写入其本地存储。其他副本被称为<strong>追随者（followers）</strong>，亦称为<strong>只读副本（read replicas）</strong>，<strong>从库（slaves）</strong>，<strong>次要（ sencondaries）</strong>，<strong>热备（hot-standby）</strong>。</p>
</blockquote>
<p>这种原生复制功能是基于日志传输实现的，这是一种通用的复制技术：主库不断发送<strong>WAL数据</strong>，而每个备库接受WAL数据，并立即重放日志。</p>
<p>本章将介绍以下主题，重点介绍流复制的工作原理：</p>
<ul>
<li>流复制是如何启动的</li>
<li>数据是如何在主备之间传递的</li>
<li>主库如何管理多个备库</li>
<li>主库如何检测到备库的失效</li>
</ul>
<blockquote>
<p>尽管在9.0版本中最初实现的复制功能只能进行异步复制，它很快就在9.1版中被新的实现（如今采用的）所替代，可以支持同步复制。</p>
</blockquote>
<h2 id="111-流复制的启动">11.1 流复制的启动</h2>
<p>在流复制中，有三种进程协同工作。首先，主库上的<strong>walsender（WAL发送器）<strong>进程将WAL数据发送到备库；同时，备库上的</strong>walreceiver（WAL接收器）<strong>在接收这些数据，而备库上的</strong>startup</strong>进程可以重放这些数据。 其中<strong>walsender</strong>和<strong>walreceiver</strong> 之间使用单条TCP连接进行通信。</p>
<p>在本节中，我们将探讨流复制的启动顺序，以了解这些进程如何启动并且它们之间是如何建立连接的。图11.1显示了流复制的启动顺序图：</p>
<p><strong>图11.1  流复制的启动顺序</strong></p>
<p><img src="/img/blog/kernel/fig-11-01.png"></p>
<ol>
<li>启动主库服务器和备库服务器。</li>
<li>备库服务器启动一个<strong>startup</strong>进程。</li>
<li>备库服务器启动一个<strong>walreceiver</strong>进程。</li>
<li><strong>walreceiver</strong>向主库服务器发送连接请求。如果主库尚未启动，<strong>walreceiver</strong>会定期重发该请求。</li>
<li>当主库服务器收到连接请求时，将启动<strong>walsender</strong>进程，并建立<strong>walsender</strong>和<strong>walreceiver</strong>之间的TCP连接。</li>
<li><strong>walreceiver</strong>发送备库数据库集簇上最新的LSN。在IT领域中通常将该阶段称作<strong>握手（handshaking）</strong>。</li>
<li>如果备库最新的LSN小于主库最新的LSN（备库的LSN &lt; 主库的LSN），则<strong>walsender</strong>会将前一个LSN到后一个LSN之间的WAL数据发送到<strong>walreceiver</strong>。这些WAL数据由存储在主库<code>pg_xlog</code>子目录（版本号为10+的更名为<code>pg_wal</code>）中的WAL段提供。最终，备库重放接收到的WAL数据。在这一阶段，备库在追赶主库，因此被称为**追赶（catch-up）**阶段。</li>
<li>最终，流复制开始工作。</li>
</ol>
<p>每个<strong>walsender</strong>进程都维护了连接上的<strong>walreceiver</strong>或其他应用程序的<strong>复制进度状态</strong>（请注意，不是连接到<strong>walsender</strong>的<strong>walreceiver</strong>或应用程序的本身的状态）。如下是其可能的状态：</p>
<ul>
<li><strong>启动（start-up）</strong> —— 从启动<strong>walsender</strong>到握手结束。如图11.1(5)-(6)。</li>
<li><strong>追赶（catch-up）</strong> —— 处于追赶期间，如图11.1(7)。</li>
<li><strong>流复制（streaming）</strong>—— 正在运行流复制。如图11.1(8)。</li>
<li><strong>备份（backup）</strong>—— 处于向<code>pg_basebackup</code>等备份工具发送整个数据库集簇文件的过程中。</li>
</ul>
<p>系统视图<code>pg_stat_replication</code>显示了所有正在运行的<strong>walsenders</strong>的状态，如下例所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># SELECT application_name,state FROM pg_stat_replication;</span>
</span></span><span style="display:flex;"><span> application_name <span style="color:#000;font-weight:bold">|</span>   state
</span></span><span style="display:flex;"><span>------------------+-----------
</span></span><span style="display:flex;"><span> standby1         <span style="color:#000;font-weight:bold">|</span> streaming
</span></span><span style="display:flex;"><span> standby2         <span style="color:#000;font-weight:bold">|</span> streaming
</span></span><span style="display:flex;"><span> pg_basebackup    <span style="color:#000;font-weight:bold">|</span> backup
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span> rows<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>如上结果所示，有两个<strong>walsender</strong>正在运行，其正在向连接的备库发送WAL数据，另一个<strong>walsender</strong>在向<code>pg_basebackup</code>应用发送所有数据库集簇中的文件。</p>
<blockquote>
<p> ### 在备库长时间停机后，如果重启会发生什么？</p>
<p>在9.3版及更早版本中，如果备库所需的WAL段在主库上已经被回收了，备库就无法追上主库了。这一问题并没有可靠的解决方案，只能为参数<a href="https://www.postgresql.org/docs/current/static/runtime-config-replication.html#GUC-WAL-KEEP-SEGMENTS"><code>wal_keep_segments</code></a>配置一个较大的值，以减少这种情况发生的可能性，但这只是权宜之计。</p>
<p>在9.4及后续版本中，可以使用**复制槽（replications slot）<strong>来预防此问题发生。复制槽是一项提高WAL数据发送灵活性的功能。主要是为</strong>逻辑复制（logical replication）**而提出的，同时也能解决这类问题 ——复制槽通过暂停回收过程，从而保留<code>pg_xlog</code>（10及后续版本的<code>pg_wal</code>）中含有未发送数据的的WAL段文件，详情请参阅<a href="https://www.postgresql.org/docs/current/static/warm-standby.html#STREAMING-REPLICATION-SLOTS">官方文档</a>。</p>
</blockquote>
<h2 id="112-如何实施流复制">11.2 如何实施流复制</h2>
<p>流复制有两个方面：日志传输和数据库同步。因为流复制基于日志，日志传送显然是其中的一个方面 —— 主库会在写入日志记录时，将WAL数据发送到连接的备库。同步复制中需要数据库同步 —— 主库与多个备库通信，从而同步整个数据库集簇。</p>
<p>为准确理解流复制的工作原理，我们应该探究下主库如何管理多个备库。为了尽可能简化问题，本节描述了一个特例（即单主单备系统），而下一节将描述一般情况（单主多备系统）。</p>
<h3 id="1121-主从间的通信">11.2.1 主从间的通信</h3>
<p>假设备库处于同步复制模式，但配置参数<code>hot-standby</code>已禁用，且<code>wal_level</code>为<code>'archive'</code>。主库的主要参数如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">synchronous_standby_names</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;standby1&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">hot_standby</span> <span style="color:#ce5c00;font-weight:bold">=</span> off
</span></span><span style="display:flex;"><span><span style="color:#000">wal_level</span> <span style="color:#ce5c00;font-weight:bold">=</span> archive
</span></span></code></pre></div><p>另外，在9.5节中提到，有三个情况触发写WAL数据，这里我们只关注事务提交。</p>
<p>假设主库上的一个后端进程在自动提交模式下发出一个简单的<code>INSERT</code>语句。后端启动事务，发出<code>INSERT</code>语句，然后立即提交事务。让我们进一步探讨此提交操作如何完成的。如图11.2中的序列图：</p>
<p><strong>图11.2  流复制的通信序列图</strong></p>
<p><img src="/img/blog/kernel/fig-11-02.png"></p>
<ol>
<li>后端进程通过执行函数<code>XLogInsert()</code>和<code>XLogFlush()</code>，将WAL数据写入并刷新到WAL段文件中。</li>
<li><strong>walsender</strong>进程将写入WAL段文件的WAL数据发送到<strong>walreceiver</strong>进程。</li>
<li>在发送WAL数据之后，后端进程继续等待来自备库的ACK响应。更确切地说，后端进程通过执行内部函数<code>SyncRepWaitForLSN()</code>来获取<strong>锁存器</strong>（latch），并等待它被释放。</li>
<li>备库上的<strong>walreceiver</strong>通过<code>write()</code>系统调用，将接收到的WAL数据写入备库的WAL段，并向<strong>walsender</strong>返回ACK响应。</li>
<li><strong>walreceiver</strong>通过系统调用（例如<code>fsync()</code>）将WAL数据刷新到WAL段中，向<strong>walsender</strong>返回另一个ACK响应，并通知**启动进程（startup process ）**相关WAL数据的更新。</li>
<li>启动进程重放已写入WAL段的WAL数据。</li>
<li><strong>walsender</strong>在收到来自<strong>walreceiver</strong>的ACK响应后释放后端进程的锁存器，然后，后端进程完成<code>commit</code>或<code>abort</code>动作。 锁存器释放的时间取决于参数<code>synchronous_commit</code>。如果它是<code>'on'</code>（默认），当接收到步骤（5）的ACK时，锁存器被释放。而当它是<code>'remote_write'</code>时，接收到步骤（4）的ACK时，即被释放。</li>
</ol>
<blockquote>
<p>如果配置参数<code>wal_level</code>是<code>'hot_standby'</code>或<code>'logical'</code>，则PostgreSQL会根据<code>COMMIT</code>或<code>ABORT</code>操作的记录，写入热备功能相关的WAL记录。（在这个例子中，PostgreSQL不写那些记录，因为它是<code>'archive'</code>。）</p>
</blockquote>
<p>每个ACK响应将备库的内部信息通知给主库。包含以下四个项目：</p>
<ul>
<li>已写入最新WAL数据的LSN位置。</li>
<li>已刷新最新WAL数据的LSN位置。</li>
<li>启动进程已经重放最新的WAL数据的LSN。</li>
<li>发送此响应的时间戳。</li>
</ul>
<p><strong>walreceiver</strong>不仅在写入和刷新WAL数据时返回ACK响应，而且还定期发送备库的心跳响应。因此，主库始终掌握所有连接备库的状态。</p>
<p>执行如下查询，可以显示所连接备库的相关LSN信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># SELECT application_name AS host,</span>
</span></span><span style="display:flex;"><span>        write_location AS write_LSN, flush_location AS flush_LSN, 
</span></span><span style="display:flex;"><span>        replay_location AS replay_LSN FROM pg_stat_replication<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   host   <span style="color:#000;font-weight:bold">|</span> write_lsn <span style="color:#000;font-weight:bold">|</span> flush_lsn <span style="color:#000;font-weight:bold">|</span> replay_lsn 
</span></span><span style="display:flex;"><span>----------+-----------+-----------+------------
</span></span><span style="display:flex;"><span> standby1 <span style="color:#000;font-weight:bold">|</span> 0/5000280 <span style="color:#000;font-weight:bold">|</span> 0/5000280 <span style="color:#000;font-weight:bold">|</span> 0/5000280
</span></span><span style="display:flex;"><span> standby2 <span style="color:#000;font-weight:bold">|</span> 0/5000280 <span style="color:#000;font-weight:bold">|</span> 0/5000280 <span style="color:#000;font-weight:bold">|</span> 0/5000280
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span> rows<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><blockquote>
<p>心跳的间隔设置为参数<code>wal_receiver_status_interval</code>，默认为10秒。</p>
</blockquote>
<h3 id="1122-发生故障时的行为">11.2.2 发生故障时的行为</h3>
<p>在本小节中，将介绍在同步备库发生故障时，主库的行为方式，以及主库会如何处理该情况。</p>
<p>即使同步备库发生故障，且不再能够返回ACK响应，主库也会继续等待响应。因此，正在运行的事务无法提交，而后续查询也无法启动。换而言之，实际上主库的所有操作都已停止（流复制不支持发生超时时自动降级回滚到异步模式的功能）。</p>
<p>有两种方法可以避免这种情况。其中之一是使用多个备库来提高系统可用性，另一个是通过手动执行以下步骤从同步模式切换到异步模式。</p>
<ol>
<li>
<p>将参数<code>synchronous_standby_names</code>的值设置为空字符串。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>synchronous_standby_names = &#39;&#39;
</span></span></code></pre></div></li>
<li>
<p>使用<code>reload</code>选项执行<code>pg_ctl</code>命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#000">postgres</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">pg_ctl</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">D</span> <span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">PGDATA</span> <span style="color:#000">reload</span>
</span></span></code></pre></div></li>
</ol>
<p>上述过程不会影响连接的客户端。主库继续事务处理，以及会保持客户端与相应的后端进程之间的所有会话。</p>
<h2 id="112-流复制如何实施">11.2 流复制如何实施</h2>
<p>流式复制有两个部分：日志传输与数据库同步。日志传输是很明显的部分，因为流复制正是基于此的 —— 每当主库发生写入时，它会向所有连接着的备库发送WAL数据。数据库同步对于同步复制而言则是必需的 —— 主库与多个备库中的每一个相互沟通，以便各自的数据库集簇保持同步。</p>
<p>为了准确理解流复制的工作原理，我们应当研究主库是如何管理多个备库的。为了简单起见，下面的小节将会描述一种特殊场景（即一主一从的情况），而通用的场景（一主多从）会在更后面一个小节中描述。</p>
<h3 id="1121-主库与同步备库之间的通信">11.2.1 主库与同步备库之间的通信</h3>
<p>假设备库处于同步复制模式，但参数<code>hot_standby</code>被配置为禁用，而<code>wal_level</code>被配置为<code>archive</code>，而主库上的主要参数如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">synchronous_standby_names</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;standby1&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">hot_standby</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">off</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">wal_level</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">archive</span>
</span></span></code></pre></div><p>除了在<a href="/zh/blog/kernel/ch9/">9.5节</a>中提到过的三种操作外，我们在这里主要关注事务的提交。</p>
<p>假设主库上一个后端进程在自动提交模式中发起了一条<code>INSERT</code>语句。首先，后端进程开启了一个事务，执行<code>INSERT</code>语句，然后立即提交。让我们深入研究一下这个提交动作是如何完成的，如下面的序列图11.2。</p>
<p><img src="/img/blog/kernel/fig-11-02.png"></p>
<ol>
<li>后端进程通过执行函数<code>XLogInsert()</code>和<code>XLogFlush()</code>将WAL数据刷写入WAL段文件中。</li>
<li><strong>walsender</strong>进程将写入WAL段的WAL数据发送到<strong>walreceiver</strong>进程。</li>
<li>在发送WAL数据之后，后端进程继续等待来自备库的ACK响应。更确切地说，后端进程通过执行内部函数<code>SyncRepWaitForLSN()</code>来获取<strong>锁存器（latch）</strong>，并等待它被释放。</li>
<li>备库上的<strong>walreceiver</strong>使用<code>write()</code>系统调用将接收到的WAL数据写入备库的WAL段，并向<strong>walsender</strong>返回ACK响应。</li>
<li>备库上的<strong>walreceiver</strong>使用诸如<code>fsync()</code>的系统调用将WAL数据刷入WAL段中，向<strong>walsender</strong>返回另一个ACK响应，并通知<strong>startup</strong>进程WAL数据已经更新。</li>
<li><strong>startup</strong>进程重放已经被写入WAL段文件中的WAL数据。</li>
<li><strong>walsender</strong>在收到来自<strong>walreceiver</strong>的ACK响应后，释放后端进程的锁存器，然后后端进程的提交或中止动作就会完成。释放锁存器的时机取决于参数<code>synchronous_commit</code>，其默认是<code>on</code>，也就是当收到步骤(5)中的确认（远端刷入）时，而当其值为<code>remote_write</code>时，则是在步骤(4)（远端写入）时。</li>
</ol>
<blockquote>
<p>如果配置参数<code>wal_level</code>是<code>hot_standby</code>或<code>logical</code>，PostgreSQL会按照热备功能来写WAL记录，并写入提交或终止的记录（在本例中PostgreSQL不会写这些记录，因为它被配置为<code>archive</code>）</p>
</blockquote>
<p>每一个ACK响应都会告知主库一些关于备库的信息，包含下列四个项目：</p>
<ul>
<li>最近被**写入（write）**的WAL数据的LSN位置。</li>
<li>最近被**刷盘（flush）**的WAL数据的LSN位置。</li>
<li>最近被**重放（replay）**的WAL数据的LSN位置。</li>
<li>响应发送的时间戳。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic">/* XLogWalRcvSendReply(void) */</span>
</span></span><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic">/* src/backend/replication/walreceiver.c */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic">/* 构造一条新消息 */</span>
</span></span><span style="display:flex;"><span> <span style="color:#000">reply_message</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">write</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LogstreamResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#000">reply_message</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">flush</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LogstreamResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flush</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#000">reply_message</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">apply</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">GetXLogReplayRecPtr</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#000">reply_message</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sendTime</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">now</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic">/* 为消息添加消息类型，并执行发送 */</span>
</span></span><span style="display:flex;"><span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;r&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#000">memcpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">reply_message</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">StandbyReplyMessage</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span> <span style="color:#000">walrcv_send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">StandbyReplyMessage</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>walreceiver不仅仅在写入和刷盘WAL数据时返回ACK响应，也会周期性地发送ACK，作为备库的心跳。因此主库能掌控所有连接到自己的备库的状态。</p>
<p>在主库上执行下面的查询，可以显示所有关联的备库与LSN相关的信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">application_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">write_location</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">write_LSN</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">flush_location</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">flush_LSN</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">replay_location</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replay_LSN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stat_replication</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">write_lsn</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">flush_lsn</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replay_lsn</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------+-----------+-----------+------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">standby1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">5000280</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">5000280</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">5000280</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">standby2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">5000280</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">5000280</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">5000280</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><blockquote>
<p>心跳频率是由参数<code>wal_receiver_status_interval</code>决定的，默认为10秒。</p>
</blockquote>
<h3 id="1122-失效时的行为">11.2.2 失效时的行为</h3>
<p>本节将介绍当备库失效时主库的行为，以及如何处理这种情况。</p>
<p>当备库发生故障且不再能返回ACK响应，主库也会继续并永远等待响应。导致运行中的事务无法提交，而后续的查询处理也无法开始。换而言之，主库上的所有操作实际上都停止了（流复制并不支持这种功能：通过超时将同步提交模式降级为异步提交模式）</p>
<p>有两种方法能避免这种情况，一种是使用多个备库，以提高系统的可用性；另一种方法是通过手动执行下列步骤，将同步提交模式改为**异步提交（Asynchronous）**模式：</p>
<ol>
<li>
<p>将参数<code>synchronous_standby_names</code>的值配置为空字符串</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">synchronous_standby_names</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;&#39;</span>
</span></span></code></pre></div></li>
<li>
<p>使用<code>pg_ctl</code>执行<code>reload</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>postgres&gt; pg_ctl -D <span style="color:#000">$PGDATA</span> reload
</span></span></code></pre></div></li>
</ol>
<p>上述过程不会影响连接着的客户端，主库会继续进行事务处理，所有客户端与后端进程之间的会话也会被保留。</p>
<h2 id="113-管理多个备库">11.3 管理多个备库</h2>
<p>本节描述了存在多个备库时，流复制是如何工作的。</p>
<h3 id="1131-同步优先级与同步状态">11.3.1 同步优先级与同步状态</h3>
<p>主库为自己管理的每一个备库指定一个<strong>同步优先级（<code>sync_priority</code>）</strong> 与 <strong>同步状态（<code>sync_state</code>）</strong> 。（上一节并没有提到这一点，即使主库只管理一个备库，也会指定这些值）。</p>
<p>**同步优先级（sync_priority）**表示备库在同步模式下的优先级，它是一个固定值。较小的值表示较高的优先级，而<code>0</code>是一个特殊值，表示“异步模式”。备库优先级是一个有序列表，在主库配置参数 <code>synchronous_standby_names</code>中依序给出。例如在以下配置中，<code>standby1</code>和<code>standby2</code>的优先级分别为1和2。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">synchronous_standby_names</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;standby1, standby2&#39;</span>
</span></span></code></pre></div><p>（未列于此参数中的备库处于异步模式，优先级为0）</p>
<p>**同步状态（sync_state）**是备库的状态，它因所有在列备库的运行状态及其优先级而异，以下是可能的状态：</p>
<ul>
<li>**同步（Sync）**状态的备库，是所有正在工作中的备库中，具有最高优先级的同步备库的状态（异步模式除外）。</li>
<li><strong>潜在（Potential）</strong> 状态的备库，是所有工作备库（异步备库除外）中，优先级等于或低于2的闲置同步备库。如果同步备库失效，潜在备库中有着最高优先级的那个将替换为同步备库。</li>
<li><strong>异步（Async）</strong> 状态的备库是固定的。主库以与潜在备库相同的方式处理异步备库，只是它们的<code>sync_state</code>永远不会是<code>sync</code>或<code>potential</code>。</li>
</ul>
<p>执行以下查询来显示备库的优先级和状态：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">application_name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">sync_priority</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sync_state</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stat_replication</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sync_priority</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sync_state</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------+---------------+------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">standby1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sync</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">standby2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">potential</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><blockquote>
<p>最近有几个开发者尝试实现“多个同步备库”。详情参见<a href="https://commitfest.postgresql.org/6/293/">此处</a>。</p>
</blockquote>
<h3 id="1132-主库如何管理多个备库">11.3.2 主库如何管理多个备库</h3>
<p>主库仅等待来自同步备库的ACK响应。换句话说，主库仅确保同步备库写入并刷新WAL数据。因此在流复制中，只有同步备库的状态是与主库始终一致且同步的。</p>
<p>图11.3展示了潜在备库的ACK响应早于首要备库ACK响应的情况。这时主库并不会完成当前事务的<code>COMMIT</code>操作，而是继续等待首要备库的ACK响应。而当收到首要备库的响应时，后端进程释放锁存器并完成当前事务的处理。</p>
<p><strong>图11.3 管理多个备库</strong></p>
<p><img src="/img/blog/kernel/fig-11-03.png"></p>
<blockquote>
<p>备库1与备库2的同步状态分别为<code>sync</code>和<code>potential</code>。</p>
<ol>
<li>尽管从潜在备库接收到ACK响应，但主库的后端进程会继续等待来自同步备库的ACK响应。</li>
<li>主库的后端进程释放锁存器，完成当前的事务处理。</li>
</ol>
</blockquote>
<p>在相反的情况下（即首要从库的ACK响应返回早于潜在从库的响应），主库会立即完成当前事务的<code>COMMIT</code>操作，而不会去确认潜在从库是否已经写入和刷盘了WAL数据。</p>
<h3 id="1133-发生故障时的行为">11.3.3 发生故障时的行为</h3>
<p>我们再来看看当从库发生故障时主库的表现。</p>
<p>当潜在或异步备库发生故障时，主库会终止连接到故障备库的<strong>walsender</strong>进程，并继续进行所有处理。换而言之，主库上的事务处理不会受到这两种备库的影响。</p>
<p>当同步备库发生故障时，主库将终止连接到故障备库的<strong>walsender</strong>进程，并使用具有最高优先级的潜在备库替换首要同步备库，如图11.4。与上述的故障相反，主库将会暂停从失效点到成功替换同步备库之间的查询处理。（因此备库的故障检测对于提高复制系统可用性至关重要，故障检测将在下一节介绍）</p>
<p><strong>图11.4 更换同步备库</strong></p>
<p><img src="/img/blog/kernel/fig-11-04.png"></p>
<p>在任何情况下，如果一个或多个备库在同步模式下运行，主库始终只会保留一个同步备库，而同步备库始终与主库保持一致且同步的状态。</p>
<h2 id="114-备库的故障检测">11.4 备库的故障检测</h2>
<p>流复制使用两种常见的故障检测过程，不需要任何特别的硬件。</p>
<ol>
<li>
<p>备库服务器的失效检测</p>
<p>当检测到<strong>walsender</strong>和<strong>walreceiver</strong>之间的连接断开时，主库<strong>立即</strong>判定备库或<strong>walreceiver</strong>进程出现故障。当底层网络函数由于未能成功读写<strong>walreceiver</strong>的套接字接口而返回错误时，主库也会立即判定其失效。</p>
</li>
<li>
<p>硬件与网络的失效检测</p>
<p>如果<strong>walreceiver</strong>在参数<code>wal_sender_timeout</code>（默认为60秒）配置的时间段内没有返回任何结果，则主库会判定备库出现故障。相对于上面的故障而言，尽管从库可能因为一些失效原因（例如备库上的硬件失效，网络失效等），已经无法发送任何响应，但主库仍需要耗费特定的时间 —— 最大为<code>wal_sender_timeout</code>，来确认备库的死亡。</p>
</li>
</ol>
<p>取决于失效的类型，一些失效可以在失效发生时被立即检测到，而有时候则可能在出现失效与检测到失效之间存在一段时间延迟。如果在同步从库上出现后一种失效，那么即使有多个潜在备库正常工作，直到检测到同步备库失效了，主库仍然可能会停止一段时间的事务处理。</p>
<blockquote>
<p>在9.2或更早版本中，参数<code>wal_sender_timeout</code>被称为<code>replication_timeout</code>。</p>
</blockquote>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-cff78653f62240bfcb66183486df6554">WAL与检查点概述</h1>
	<div class="lead">介绍PostgreSQL中的WAL与检查点机制。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
	</div>
	<p>数据库需要保证两个基本的特性：<strong>可靠性</strong>与<strong>可用性</strong>。通俗来讲：</p>
<p>可靠性就是：出了故障，既不会丢数据，也不会弄脏数据。</p>
<p>可用性就是：保证足够的读写性能，出了故障后，能够快速恢复服务。</p>
<p>朴素的数据库实现有两个选项：在内存中修改数据页，或者将事物变更直接写入磁盘。但这产生了一个两难困境：</p>
<ul>
<li>内存支持随机读写，因此在性能上表现强悍，然而作为易失性存储，一旦故障就会丢数据。</li>
<li>硬盘恰恰相反，随机读写表现糟糕，但在故障时数据要可靠的多。</li>
</ul>
<p>内存可用性强可靠性差，硬盘可用性差但可靠性强，如何解决这一对矛盾，让内存与硬盘取长补短，就是生产级数据库需要考虑的问题了。</p>
<hr>
<h2 id="0x1-核心思想">0x1 核心思想</h2>
<p>硬盘的随机写入性能很糟糕，但顺序写入的性能却非常可观。即使是SSD也符合这一规律，因为一次写入的擦除单位是Block（通常是几M），而操作系统的写入单元是Page（通常约4k）。如果每次事物提交都要直接将脏数据页落盘，性能表现肯定不会可观。但如果采用另一种方式，将<strong>数据的变更</strong>而不是<strong>变更后的最新数据本身</strong>落盘，就可以将随机写入变为顺序写入，从而极大地提高磁盘写入效率。</p>
<p>于是，预写式日志（WAL，Write Ahead Log） 出现了，所谓日志，在最朴素的意义上来讲，就是一个Append-Only的数据文件，记录了操作的内容。只要保留了WAL，数据库就是可靠的，可以恢复的。从一个给定的状态，例如空数据库开始，回放所有的操作日志到当前的时间点，就可以恢复出当前数据库应有的状态。与此同时，如果日志已经落盘确保了可靠性，数据页就不需要在每次提交时落盘了。数据页的读写可以完全在内存进行，从而提供强悍的性能支持。</p>
<p><strong>但可用性不仅仅包括足够的性能，当发生故障时能够快速恢复也是可用性要求的一部分</strong>。考虑最极端的情况，从数据库创建之初所有数据页就在内存里一直飘着，只有操作日志落了盘。现在数据库运行了一整年，突然崩溃了，这时候要想恢复就需要重放一整年的操作日志，也许需要几个小时，也许需要好几天。对于生产环境，这是无法接受的，检查点（Checkpoint）解决了这个问题。</p>
<p>检查点（Checkpoint）类似于游戏中存档的概念，远古时期的很多游戏没有存档，一旦Game Over就要重头再来。后来的游戏有了记忆和存档，当挑战Boss失败时，只要读取最近的存档，就可以避免从头开始。</p>
<p>数据库中的检查点代表这样一种操作，在某一个检查点时，所有脏数据页会写回到磁盘中，使得磁盘和内存中的数据保持一致。这样当故障恢复时，只需要从该检查点开始回放操作日志即可。</p>
<p>例如，每个整点执行一次检查点，存档一次，那么当故障时，只需要从本小时开始的检查点开始回放WAL，就可以完成恢复。同时，检查点还有一个好处是，当数据页落盘之后，在这个检查点之前的WAL日志就可以不用了。对于高负载数据库，例如每小时产生TB级别WAL的数据库，使用检查点能够极大地减少恢复的时间和磁盘的用量。</p>
<p>通过检查点和预写式日志，数据库可以同时保证高度的可靠性和可用性。</p>
<hr>
<h2 id="0x2-wal概述">0x2 WAL概述</h2>
<p>预写式日志（WAL）是保证数据完整性的一种标准方法。对其详尽的描述几乎可以在所有（如果不是全部）有关事务处理的书中找到。简单来说，WAL的中心概念是数据文件（存储着表和索引）的修改必须在这些动作被日志记录之后才被写入，即在描述这些改变的日志记录被刷到持久存储以后。如果我们遵循这种过程，我们不需要在每个事务提交时刷写数据页面到磁盘，因为我们知道在发生崩溃时可以使用日志来恢复数据库：任何还没有被应用到数据页面的改变可以根据其日志记录重做（这是前滚恢复，也被称为REDO）。</p>
<p>使用WAL可以显著降低磁盘的写次数，因为只有日志文件需要被刷出到磁盘以保证事务被提交，而被事务改变的每一个数据文件则不必被刷出。<strong>日志文件被按照顺序写入，因此同步日志的代价要远低于刷写数据页面的代价</strong>。在处理很多影响数据存储不同部分的小事务的服务器上这一点尤其明显。此外，当服务器在处理很多小的并行事务时，日志文件的一个<code>fsync</code>可以提交很多事务。</p>
<p>##异步提交</p>
<p><em>异步提交</em>是一个允许事务能更快完成的选项，代价是在数据库崩溃时最近的事务会丢失。在很多应用中这是一个可接受的交换。</p>
<p>如前一节所述，事务提交通常是<em>同步的</em>：服务器等到事务的WAL记录被刷写到持久存储之后才向客户端返回成功指示。因此客户端可以确保那些报告已被提交的事务确会被保存，即便随后马上发生了一次服务器崩溃。但是，对于短事务来说这种延迟是其总执行时间的主要部分。选择异步提交模式意味着服务器将在事务被逻辑上提交后立刻返回成功，而此时由它生成的WAL记录还没有被真正地写到磁盘上。这将为小型事务的生产力产生显著地提升。</p>
<p>异步提交会带来数据丢失的风险。在向客户端报告事务完成到事务真正被提交（即能保证服务器崩溃时它也不会被丢失）之间有一个短的时间窗口。因此如果客户端将会做一些要求其事务被记住的外部动作，就不应该用异步提交。例如，一个银行肯定不会使用异步提交事务来记录一台ATM的现金分发。但是在很多情境中不需要这种强的保证，例如事件日志。</p>
<p>使用异步提交带来的风险是数据丢失，而不是数据损坏。如果数据库可能崩溃，它会通过重放WAL到被刷写的最后一个记录来进行恢复。数据库将因此被恢复到一个自身一致状态，但是任何还没有被刷写到磁盘的事务将不会反映在该状态中。因此其影响就是丢失了最后的少量事务。由于事务按照提交顺序被重放，所以不会出现任何不一致性 — 例如一个事务B按照前面一个事务A的效果来进行修改，则不会出现A的效果丢失而B的效果被保留的情况。</p>
<p>用户可以选择每一个事务的提交模式，这样可以有同步提交和异步提交的事务并行运行。这允许我们灵活地在性能和事务持久性之间进行权衡。提交模式由用户可设置的参数<a href="http://www.postgres.cn/docs/9.6/runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT">synchronous_commit</a>控制，它可以使用任何一种修改配置参数的方法进行设置。一个事务真正使用的提交模式取决于当事务提交开始时<code>synchronous_commit</code>的值。</p>
<p>特定的实用命令，如<code>DROP TABLE</code>，被强制按照同步提交而不考虑<code>synchronous_commit</code>的设定。这是为了确保服务器文件系统和数据库逻辑状态之间的一致性。支持两阶段提交的命令页总是同步提交的，如<code>PREPARE TRANSACTION</code>。</p>
<p>如果数据库在异步提交和事务WAL记录写入之间的风险窗口期间崩溃，在该事务期间所作的修改<em>将</em>丢失。风险窗口的持续时间是有限制的，因为一个后台进程（&ldquo;WAL写进程&rdquo;）每<a href="http://www.postgres.cn/docs/9.6/runtime-config-wal.html#GUC-WAL-WRITER-DELAY">wal_writer_delay</a>毫秒会把未写入的WAL记录刷写到磁盘。风险窗口实际的最大持续时间是<code>wal_writer_delay</code>的3倍，因为WAL写进程被设计成倾向于在忙时一次写入所有页面。</p>
<p>一个立刻关闭等同于一次服务器崩溃，因此也将会导致未刷写的异步提交丢失。</p>
<p>异步提交提供的行为与配置<a href="http://www.postgres.cn/docs/9.6/runtime-config-wal.html#GUC-FSYNC">fsync</a> = off不同。<code>fsync</code>是一个服务器范围的设置，它将会影响所有事务的行为。它禁用了PostgreSQL中所有尝试同步写入到数据库不同部分的逻辑，并且因此一次系统崩溃（即，一个硬件或操作系统崩溃，不是PostgreSQL本身的失败）可能造成数据库状态的任意损坏。在很多情境中，带来大部分性能提升的异步提交可以通过关闭<code>fsync</code>来获得，而且不会带来数据损坏的风险。</p>
<p><a href="http://www.postgres.cn/docs/9.6/runtime-config-wal.html#GUC-COMMIT-DELAY">commit_delay</a>也看起来很像异步提交，但它实际上是一种同步提交方法（事实上，<code>commit_delay</code>在异步提交时被忽略）。<code>commit_delay</code>会使事务在刷写WAL到磁盘之前有一个延迟，它期望由一个这样的事务所执行的刷写能够也服务于其他同时提交的事务。该设置可以被看成是一种时间窗口，在其期间事务可以参与到一次单一的刷写中，这种方式用于在多个事务之间摊销刷写的开销。</p>
<hr>
<h2 id="0x03-查看wal状态">0x03 查看WAL状态</h2>
<ul>
<li>pg_current_wal_lsn</li>
<li>pg_current_wal_flush_lsn</li>
<li>pg_current_wal_insert_lsn</li>
<li>pg_last_wal_receive_lsn</li>
<li>pg_last_wal_replay_lsn</li>
<li>pg_last_xact_replay_timestamp</li>
</ul>
<hr>
<h2 id="0x04-流复制">0x04 流复制</h2>
<p>流复制是通过重放 WAL 实现的。</p>
<hr>
<h2 id="0x05-checkpoint">0x05 Checkpoint</h2>
<p>执行 <code>CHECKPOINT</code> 命令，会强制发起一个事务日志检查点。</p>
<p>一个检查点是事务日志序列中的一个点，在该点上所有数据文件 都已经被更新为反映日志中的信息。所有数据文件将被刷写到磁盘。 检查点期间发生的细节可见<a href="http://www.postgres.cn/docs/9.6/wal-configuration.html">第 30.4 节</a>。</p>
<p><code>CHECKPOINT</code>命令在发出时强制一个 立即的检查点，而不用等待由系统规划的常规检查点（由 <a href="http://www.postgres.cn/docs/9.6/runtime-config-wal.html#RUNTIME-CONFIG-WAL-CHECKPOINTS">第 19.5.2 节</a>中的设置控制）。 <code>CHECKPOINT</code>不是用来在普通操作中 使用的命令。</p>
<p>如果在恢复期间执行，<code>CHECKPOINT</code> 命令将强制一个重启点（见<a href="http://www.postgres.cn/docs/9.6/wal-configuration.html">第 30.4 节</a>） 而不是写一个新检查点。</p>
<p>只有超级用户能够调用<code>CHECKPOINT</code>。</p>
<hr>
<h2 id="安全的删除wal">安全的删除WAL</h2>
<p>如果想要删除wal日志，要么让pg在CHECKPOINT的时候自己删除，或者使用<code>pg_archivecleanup</code>。除了以下三种情况，pg会自动清除不再需要的wal日志：</p>
<ol>
<li><code>archive_mond=on</code>，但是<code>archive_command</code>failed，这样pg会一直保留wal日志，直到重试成功。</li>
<li><code>wal_keep_segments</code>需要保留一定的数据。</li>
<li>9.4之后，可能会因为replication slot保留；</li>
</ol>
<p>如果都不符合上述情况，我们想要清理wal日志，可以通过执行<code>CHECKPOINT</code>来清理当前不需要的wal。</p>
<p>在一些非寻常情况下，可能需要<code>pg_archivecleanup</code>命令，比如由于wal归档失败导致的wal堆积引起的磁盘空间溢出。你可能使用这个命令来清理归档wal日志，但是永远不要手动删除wal段；</p>

</div>





    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Mail" aria-label="Mail">
    <a target="_blank" rel="noopener" href="mailto:rh@vonng.com" aria-label="Mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Vonng/pigsty" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://twitter.com/GobeUncleWang" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="WeChat" aria-label="WeChat">
    <a target="_blank" rel="noopener" href="/img/pigsty/pigsty-cc.jpg" aria-label="WeChat">
      <i class="fa fa-comment"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Discord" aria-label="Discord">
    <a target="_blank" rel="noopener" href="https://discord.gg/wDzt5VyWEz" aria-label="Discord">
      <i class="fab fa-discord"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Telegram" aria-label="Telegram">
    <a target="_blank" rel="noopener" href="https://t.me/joinchat/gV9zfZraNPM3YjFh" aria-label="Telegram">
      <i class="fab fa-telegram"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2018&ndash;2025
    <span class="td-footer__authors">Ruohang Feng</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span></span><span class="ms-2"><a href="https://vonng.com/en/" target="_blank" rel="noopener">@Vonng</a></span>
<br><span>Pigsty® distributed under <a href="/docs/about/license" target="_blank" rel="noopener">AGPLv3</a></span>
<br><span class="ms-2"><a href="/docs/about/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
<span><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">浙ICP备15016890号</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.248655eb216150e39da254c2f7aa5357805d0ec66bdb741b591cd35fb5f629ab.js" integrity="sha256-JIZV6yFhUOOdolTC96pTV4BdDsZr23QbWRzTX7X2Kas=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
