<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>第九章 预写式日志 | Pigsty</title>
<meta name="description" content="事务日志（transaction log）是数据库的关键组件，因为当出现系统故障时，任何数据库管理系统都不允许丢失数据。事务日志是数据库系统中所有**变更（change）与行为（action）**的历史记录，当诸如电源故障，或其他服务器错误导致服务器崩溃时，它被用于确保数据不会丢失。由于日志包含每个已执行事务的相关充分信息，因此当服务器崩溃时，数据库服务器应能通过重放事务日志中的变更与行为来恢复数据库集群。
在计算机科学领域，WAL是Write Ahead Logging的缩写，它指的是将变更与行为写入事务日志的协议或规则；而在PostgreSQL中，WAL是Write Ahead Log的缩写。在这里它被当成事务日志的同义词，而且也用来指代一种将行为写入事务日志（WAL）的实现机制。虽然有些令人困惑， 但本文将使用PostgreSQL中的定义。
WAL机制在7.1版本中首次被实现，用以减轻服务器崩溃的影响。它还是**时间点恢复（Point-in-Time Recovery PIRT）与流复制（Streaming Replication, SR）**实现的基础，这两者将分别在第10章和第11章中介绍。
尽管理解WAL机制对于管理、集成PostgreSQL非常重要，但由于它的复杂性，不可能做到简要介绍。因此本章将会对WAL做一个完整的解释。第一节描绘了WAL的全貌，介绍了一些重要的概念与关键词。接下来的小节中会依次讲述其他主题：
事务日志（WAL）的逻辑结构与物理结构 WAL数据的内部布局 WAL数据的写入 WAL写入者进程 检查点过程 数据库恢复流程 管理WAL段文件 持续归档 9.1 概述 让我们先来概述一下WAL机制。为了阐明WAL要解决的问题，第一部分展示了如果PostgreSQL在没有实现WAL时崩溃会发生什么。第二部分介绍了一些关键概念，并概览了本章中的一些关键主题。最后一部分总结了WAL概述部分，并引出了一个更为重要的概念。
9.1.1 没有WAL的插入操作 正如在第八章中讨论的那样，为了能高效访问关系表的页面，几乎所有的DBMS都实现了共享缓冲池。
假设有这样一个没有实现WAL机制的PostgreSQL，现在向表A中插入一些数据元组，如图9.1所示。
图9.1 没有WAL的插入操作
发起第一条INSERT语句时，PostgreSQL从数据库集簇文件中加载表A的页面到内存中的共享缓冲池。然后向页面中插入一条元组。页面并没有立刻写回到数据库集簇文件中。正如第8章中提到的，被修改过的页面通常称为脏页（dirty page） 发起第二条INSERT语句时，PostgreSQL直接向缓冲池里的页面内添加了一条新元组。这一页仍然没有被写回到持久存储中。 如果操作系统或PostgreSQL服务器因为各种原因失效（例如电源故障），所有插入的数据都会丢失。 因此没有WAL的数据库在系统崩溃时是很脆弱的。
9.1.2 插入操作与数据库恢复 为了解决上述系统失效问题，同时又不招致性能损失，PostgreSQL支持了WAL。这一部分介绍了一些关键词和概念，以及WAL数据的写入和数据库系统的恢复。
为了应对系统失效，PostgreSQL将所有修改作为历史数据写入持久化存储中。这份历史数据称为XLOG记录（xlog record）或WAL数据（wal data）。
当插入、删除、提交等变更动作发生时，PostgreSQL会将XLOG记录写入内存中的WAL缓冲区（WAL Buffer）。当事务提交或中止时，它们会被立即写入持久存储上的**WAL段文件（WAL segment file）中（更精确来讲，其他场景也可能会有XLOG记录写入，细节将在9.5节中描述）。XLOG记录的日志序列号（Log Sequence Number, LSN）**标识了该记录在事务日志中的位置，记录的LSN被用作XLOG记录的唯一标识符。
顺便一提，当我们考虑数据库系统如何恢复时，可能会想到一个问题：PostgreSQL是从哪一点开始恢复的？答案是重做点（REDO Point），即最新一个检查点（Checkpoint）开始时XLOG记录写入的位置。（PostgreSQL中的检查点将在9.7节中描述）。实际上，数据库恢复过程与检查点过程紧密相连，两者是不可分割的。
WAL与检查点过程在7.1版本中同时实现
介绍完了主要的关键词与概念，现在来说一下带有WAL时的元组插入操作。如图9.2所示：
图9.2 带有WAL的插入操作
表A的LSN展示的是表A页面中页首部里pd_lsn类型的PageXLogRecPtr字段，与页面的LSN是一回事。
检查点进程是一个后台进程，周期性地执行过程。当检查点进程开始执行检查点时，它会向当前WAL段文件写入一条XLOG记录，称为检查点（Checkpoint Record）。这条记录包含了最新的重做点位置。 发起第一条INSERT语句时，PostgreSQL从数据库集簇文件中加载表A的页面至内存中的共享缓冲池，向页面中插入一条元组，然后在LSN_1位置创建并写入一条相应的XLOG记录，然后将表A的LSN从LSN_0更新为LSN_1。在本例中，XLOG记录是由首部数据与完整元组组成的一对值。 当该事务提交时，PostgreSQL向WAL缓冲区创建并写入一条关于该提交行为的XLOG记录，然后将WAL缓冲区中的所有XLOG记录刷写入WAL段文件中。 发起第二条INSERT语句时，PostgreSQL向页面中插入一条新元组，然后在LSN_2位置创建并写入一条相应的XLOG记录，然后将表A的LSN从LSN_1更新为LSN_2。 当这条语句的事务提交时，PostgreSQL执行同步骤3类似的操作。 设想当操作系统失效发生时，尽管共享缓冲区中的所有数据都丢失了，但所有页面修改已经作为历史记录被写入WAL段文件中。 接下来的步骤展示了如何将数据库集簇恢复到崩溃时刻前的状态。不需要任何特殊的操作，重启PostgreSQL时会自动进入恢复模式，如图9.3所示。PostgreSQL会从重做点开始，依序读取正确的WAL段文件并重放XLOG记录。
图9.3 使用WAL进行数据库恢复
PostgreSQL从相关的WAL段文件中读取第一条INSERT语句的XLOG记录，并从硬盘上的数据库集簇目录加载表A的页面到内存中的共享缓冲区中。 在重放XLOG记录前，PostgreSQL会比较XLOG记录的LSN与相应页面的LSN。这么做的原因在第9.8节中描述。重放XLOG记录的规则如下所示： 如果XLOG记录的LSN要比页面LSN大，XLOG记录中的数据部分就会被插入到页面中，并将页面的LSN更新为XLOG记录的LSN。 如果XLOG记录的LSN要比页面的LSN小，那么不用做任何事情，直接读取后续的WAL数据即可。 PostgreSQL按照同样的方式重放其余的XLOG记录。 PostgreSQL可以通过按时间顺序重放写在WAL段文件中的XLOG记录来自我恢复，因此，PostgreSQL的XLOG记录显然是一种重做日志（REDO log）。">
<meta property="og:title" content="第九章 预写式日志" />
<meta property="og:description" content="事务日志（transaction log）是数据库的关键组件，因为当出现系统故障时，任何数据库管理系统都不允许丢失数据。事务日志是数据库系统中所有**变更（change）与行为（action）**的历史记录，当诸如电源故障，或其他服务器错误导致服务器崩溃时，它被用于确保数据不会丢失。由于日志包含每个已执行事务的相关充分信息，因此当服务器崩溃时，数据库服务器应能通过重放事务日志中的变更与行为来恢复数据库集群。
在计算机科学领域，WAL是Write Ahead Logging的缩写，它指的是将变更与行为写入事务日志的协议或规则；而在PostgreSQL中，WAL是Write Ahead Log的缩写。在这里它被当成事务日志的同义词，而且也用来指代一种将行为写入事务日志（WAL）的实现机制。虽然有些令人困惑， 但本文将使用PostgreSQL中的定义。
WAL机制在7.1版本中首次被实现，用以减轻服务器崩溃的影响。它还是**时间点恢复（Point-in-Time Recovery PIRT）与流复制（Streaming Replication, SR）**实现的基础，这两者将分别在第10章和第11章中介绍。
尽管理解WAL机制对于管理、集成PostgreSQL非常重要，但由于它的复杂性，不可能做到简要介绍。因此本章将会对WAL做一个完整的解释。第一节描绘了WAL的全貌，介绍了一些重要的概念与关键词。接下来的小节中会依次讲述其他主题：
事务日志（WAL）的逻辑结构与物理结构 WAL数据的内部布局 WAL数据的写入 WAL写入者进程 检查点过程 数据库恢复流程 管理WAL段文件 持续归档 9.1 概述 让我们先来概述一下WAL机制。为了阐明WAL要解决的问题，第一部分展示了如果PostgreSQL在没有实现WAL时崩溃会发生什么。第二部分介绍了一些关键概念，并概览了本章中的一些关键主题。最后一部分总结了WAL概述部分，并引出了一个更为重要的概念。
9.1.1 没有WAL的插入操作 正如在第八章中讨论的那样，为了能高效访问关系表的页面，几乎所有的DBMS都实现了共享缓冲池。
假设有这样一个没有实现WAL机制的PostgreSQL，现在向表A中插入一些数据元组，如图9.1所示。
图9.1 没有WAL的插入操作
发起第一条INSERT语句时，PostgreSQL从数据库集簇文件中加载表A的页面到内存中的共享缓冲池。然后向页面中插入一条元组。页面并没有立刻写回到数据库集簇文件中。正如第8章中提到的，被修改过的页面通常称为脏页（dirty page） 发起第二条INSERT语句时，PostgreSQL直接向缓冲池里的页面内添加了一条新元组。这一页仍然没有被写回到持久存储中。 如果操作系统或PostgreSQL服务器因为各种原因失效（例如电源故障），所有插入的数据都会丢失。 因此没有WAL的数据库在系统崩溃时是很脆弱的。
9.1.2 插入操作与数据库恢复 为了解决上述系统失效问题，同时又不招致性能损失，PostgreSQL支持了WAL。这一部分介绍了一些关键词和概念，以及WAL数据的写入和数据库系统的恢复。
为了应对系统失效，PostgreSQL将所有修改作为历史数据写入持久化存储中。这份历史数据称为XLOG记录（xlog record）或WAL数据（wal data）。
当插入、删除、提交等变更动作发生时，PostgreSQL会将XLOG记录写入内存中的WAL缓冲区（WAL Buffer）。当事务提交或中止时，它们会被立即写入持久存储上的**WAL段文件（WAL segment file）中（更精确来讲，其他场景也可能会有XLOG记录写入，细节将在9.5节中描述）。XLOG记录的日志序列号（Log Sequence Number, LSN）**标识了该记录在事务日志中的位置，记录的LSN被用作XLOG记录的唯一标识符。
顺便一提，当我们考虑数据库系统如何恢复时，可能会想到一个问题：PostgreSQL是从哪一点开始恢复的？答案是重做点（REDO Point），即最新一个检查点（Checkpoint）开始时XLOG记录写入的位置。（PostgreSQL中的检查点将在9.7节中描述）。实际上，数据库恢复过程与检查点过程紧密相连，两者是不可分割的。
WAL与检查点过程在7.1版本中同时实现
介绍完了主要的关键词与概念，现在来说一下带有WAL时的元组插入操作。如图9.2所示：
图9.2 带有WAL的插入操作
表A的LSN展示的是表A页面中页首部里pd_lsn类型的PageXLogRecPtr字段，与页面的LSN是一回事。
检查点进程是一个后台进程，周期性地执行过程。当检查点进程开始执行检查点时，它会向当前WAL段文件写入一条XLOG记录，称为检查点（Checkpoint Record）。这条记录包含了最新的重做点位置。 发起第一条INSERT语句时，PostgreSQL从数据库集簇文件中加载表A的页面至内存中的共享缓冲池，向页面中插入一条元组，然后在LSN_1位置创建并写入一条相应的XLOG记录，然后将表A的LSN从LSN_0更新为LSN_1。在本例中，XLOG记录是由首部数据与完整元组组成的一对值。 当该事务提交时，PostgreSQL向WAL缓冲区创建并写入一条关于该提交行为的XLOG记录，然后将WAL缓冲区中的所有XLOG记录刷写入WAL段文件中。 发起第二条INSERT语句时，PostgreSQL向页面中插入一条新元组，然后在LSN_2位置创建并写入一条相应的XLOG记录，然后将表A的LSN从LSN_1更新为LSN_2。 当这条语句的事务提交时，PostgreSQL执行同步骤3类似的操作。 设想当操作系统失效发生时，尽管共享缓冲区中的所有数据都丢失了，但所有页面修改已经作为历史记录被写入WAL段文件中。 接下来的步骤展示了如何将数据库集簇恢复到崩溃时刻前的状态。不需要任何特殊的操作，重启PostgreSQL时会自动进入恢复模式，如图9.3所示。PostgreSQL会从重做点开始，依序读取正确的WAL段文件并重放XLOG记录。
图9.3 使用WAL进行数据库恢复
PostgreSQL从相关的WAL段文件中读取第一条INSERT语句的XLOG记录，并从硬盘上的数据库集簇目录加载表A的页面到内存中的共享缓冲区中。 在重放XLOG记录前，PostgreSQL会比较XLOG记录的LSN与相应页面的LSN。这么做的原因在第9.8节中描述。重放XLOG记录的规则如下所示： 如果XLOG记录的LSN要比页面LSN大，XLOG记录中的数据部分就会被插入到页面中，并将页面的LSN更新为XLOG记录的LSN。 如果XLOG记录的LSN要比页面的LSN小，那么不用做任何事情，直接读取后续的WAL数据即可。 PostgreSQL按照同样的方式重放其余的XLOG记录。 PostgreSQL可以通过按时间顺序重放写在WAL段文件中的XLOG记录来自我恢复，因此，PostgreSQL的XLOG记录显然是一种重做日志（REDO log）。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/zh/blog/kernel/ch9/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2018-01-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-05-22T16:35:31+08:00" />

<meta itemprop="name" content="第九章 预写式日志">
<meta itemprop="description" content="事务日志（transaction log）是数据库的关键组件，因为当出现系统故障时，任何数据库管理系统都不允许丢失数据。事务日志是数据库系统中所有**变更（change）与行为（action）**的历史记录，当诸如电源故障，或其他服务器错误导致服务器崩溃时，它被用于确保数据不会丢失。由于日志包含每个已执行事务的相关充分信息，因此当服务器崩溃时，数据库服务器应能通过重放事务日志中的变更与行为来恢复数据库集群。
在计算机科学领域，WAL是Write Ahead Logging的缩写，它指的是将变更与行为写入事务日志的协议或规则；而在PostgreSQL中，WAL是Write Ahead Log的缩写。在这里它被当成事务日志的同义词，而且也用来指代一种将行为写入事务日志（WAL）的实现机制。虽然有些令人困惑， 但本文将使用PostgreSQL中的定义。
WAL机制在7.1版本中首次被实现，用以减轻服务器崩溃的影响。它还是**时间点恢复（Point-in-Time Recovery PIRT）与流复制（Streaming Replication, SR）**实现的基础，这两者将分别在第10章和第11章中介绍。
尽管理解WAL机制对于管理、集成PostgreSQL非常重要，但由于它的复杂性，不可能做到简要介绍。因此本章将会对WAL做一个完整的解释。第一节描绘了WAL的全貌，介绍了一些重要的概念与关键词。接下来的小节中会依次讲述其他主题：
事务日志（WAL）的逻辑结构与物理结构 WAL数据的内部布局 WAL数据的写入 WAL写入者进程 检查点过程 数据库恢复流程 管理WAL段文件 持续归档 9.1 概述 让我们先来概述一下WAL机制。为了阐明WAL要解决的问题，第一部分展示了如果PostgreSQL在没有实现WAL时崩溃会发生什么。第二部分介绍了一些关键概念，并概览了本章中的一些关键主题。最后一部分总结了WAL概述部分，并引出了一个更为重要的概念。
9.1.1 没有WAL的插入操作 正如在第八章中讨论的那样，为了能高效访问关系表的页面，几乎所有的DBMS都实现了共享缓冲池。
假设有这样一个没有实现WAL机制的PostgreSQL，现在向表A中插入一些数据元组，如图9.1所示。
图9.1 没有WAL的插入操作
发起第一条INSERT语句时，PostgreSQL从数据库集簇文件中加载表A的页面到内存中的共享缓冲池。然后向页面中插入一条元组。页面并没有立刻写回到数据库集簇文件中。正如第8章中提到的，被修改过的页面通常称为脏页（dirty page） 发起第二条INSERT语句时，PostgreSQL直接向缓冲池里的页面内添加了一条新元组。这一页仍然没有被写回到持久存储中。 如果操作系统或PostgreSQL服务器因为各种原因失效（例如电源故障），所有插入的数据都会丢失。 因此没有WAL的数据库在系统崩溃时是很脆弱的。
9.1.2 插入操作与数据库恢复 为了解决上述系统失效问题，同时又不招致性能损失，PostgreSQL支持了WAL。这一部分介绍了一些关键词和概念，以及WAL数据的写入和数据库系统的恢复。
为了应对系统失效，PostgreSQL将所有修改作为历史数据写入持久化存储中。这份历史数据称为XLOG记录（xlog record）或WAL数据（wal data）。
当插入、删除、提交等变更动作发生时，PostgreSQL会将XLOG记录写入内存中的WAL缓冲区（WAL Buffer）。当事务提交或中止时，它们会被立即写入持久存储上的**WAL段文件（WAL segment file）中（更精确来讲，其他场景也可能会有XLOG记录写入，细节将在9.5节中描述）。XLOG记录的日志序列号（Log Sequence Number, LSN）**标识了该记录在事务日志中的位置，记录的LSN被用作XLOG记录的唯一标识符。
顺便一提，当我们考虑数据库系统如何恢复时，可能会想到一个问题：PostgreSQL是从哪一点开始恢复的？答案是重做点（REDO Point），即最新一个检查点（Checkpoint）开始时XLOG记录写入的位置。（PostgreSQL中的检查点将在9.7节中描述）。实际上，数据库恢复过程与检查点过程紧密相连，两者是不可分割的。
WAL与检查点过程在7.1版本中同时实现
介绍完了主要的关键词与概念，现在来说一下带有WAL时的元组插入操作。如图9.2所示：
图9.2 带有WAL的插入操作
表A的LSN展示的是表A页面中页首部里pd_lsn类型的PageXLogRecPtr字段，与页面的LSN是一回事。
检查点进程是一个后台进程，周期性地执行过程。当检查点进程开始执行检查点时，它会向当前WAL段文件写入一条XLOG记录，称为检查点（Checkpoint Record）。这条记录包含了最新的重做点位置。 发起第一条INSERT语句时，PostgreSQL从数据库集簇文件中加载表A的页面至内存中的共享缓冲池，向页面中插入一条元组，然后在LSN_1位置创建并写入一条相应的XLOG记录，然后将表A的LSN从LSN_0更新为LSN_1。在本例中，XLOG记录是由首部数据与完整元组组成的一对值。 当该事务提交时，PostgreSQL向WAL缓冲区创建并写入一条关于该提交行为的XLOG记录，然后将WAL缓冲区中的所有XLOG记录刷写入WAL段文件中。 发起第二条INSERT语句时，PostgreSQL向页面中插入一条新元组，然后在LSN_2位置创建并写入一条相应的XLOG记录，然后将表A的LSN从LSN_1更新为LSN_2。 当这条语句的事务提交时，PostgreSQL执行同步骤3类似的操作。 设想当操作系统失效发生时，尽管共享缓冲区中的所有数据都丢失了，但所有页面修改已经作为历史记录被写入WAL段文件中。 接下来的步骤展示了如何将数据库集簇恢复到崩溃时刻前的状态。不需要任何特殊的操作，重启PostgreSQL时会自动进入恢复模式，如图9.3所示。PostgreSQL会从重做点开始，依序读取正确的WAL段文件并重放XLOG记录。
图9.3 使用WAL进行数据库恢复
PostgreSQL从相关的WAL段文件中读取第一条INSERT语句的XLOG记录，并从硬盘上的数据库集簇目录加载表A的页面到内存中的共享缓冲区中。 在重放XLOG记录前，PostgreSQL会比较XLOG记录的LSN与相应页面的LSN。这么做的原因在第9.8节中描述。重放XLOG记录的规则如下所示： 如果XLOG记录的LSN要比页面LSN大，XLOG记录中的数据部分就会被插入到页面中，并将页面的LSN更新为XLOG记录的LSN。 如果XLOG记录的LSN要比页面的LSN小，那么不用做任何事情，直接读取后续的WAL数据即可。 PostgreSQL按照同样的方式重放其余的XLOG记录。 PostgreSQL可以通过按时间顺序重放写在WAL段文件中的XLOG记录来自我恢复，因此，PostgreSQL的XLOG记录显然是一种重做日志（REDO log）。"><meta itemprop="datePublished" content="2018-01-03T00:00:00+00:00" />
<meta itemprop="dateModified" content="2024-05-22T16:35:31+08:00" />
<meta itemprop="wordCount" content="1100">
<meta itemprop="keywords" content="PostgreSQL,PG内核," /><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="第九章 预写式日志"/>
<meta name="twitter:description" content="事务日志（transaction log）是数据库的关键组件，因为当出现系统故障时，任何数据库管理系统都不允许丢失数据。事务日志是数据库系统中所有**变更（change）与行为（action）**的历史记录，当诸如电源故障，或其他服务器错误导致服务器崩溃时，它被用于确保数据不会丢失。由于日志包含每个已执行事务的相关充分信息，因此当服务器崩溃时，数据库服务器应能通过重放事务日志中的变更与行为来恢复数据库集群。
在计算机科学领域，WAL是Write Ahead Logging的缩写，它指的是将变更与行为写入事务日志的协议或规则；而在PostgreSQL中，WAL是Write Ahead Log的缩写。在这里它被当成事务日志的同义词，而且也用来指代一种将行为写入事务日志（WAL）的实现机制。虽然有些令人困惑， 但本文将使用PostgreSQL中的定义。
WAL机制在7.1版本中首次被实现，用以减轻服务器崩溃的影响。它还是**时间点恢复（Point-in-Time Recovery PIRT）与流复制（Streaming Replication, SR）**实现的基础，这两者将分别在第10章和第11章中介绍。
尽管理解WAL机制对于管理、集成PostgreSQL非常重要，但由于它的复杂性，不可能做到简要介绍。因此本章将会对WAL做一个完整的解释。第一节描绘了WAL的全貌，介绍了一些重要的概念与关键词。接下来的小节中会依次讲述其他主题：
事务日志（WAL）的逻辑结构与物理结构 WAL数据的内部布局 WAL数据的写入 WAL写入者进程 检查点过程 数据库恢复流程 管理WAL段文件 持续归档 9.1 概述 让我们先来概述一下WAL机制。为了阐明WAL要解决的问题，第一部分展示了如果PostgreSQL在没有实现WAL时崩溃会发生什么。第二部分介绍了一些关键概念，并概览了本章中的一些关键主题。最后一部分总结了WAL概述部分，并引出了一个更为重要的概念。
9.1.1 没有WAL的插入操作 正如在第八章中讨论的那样，为了能高效访问关系表的页面，几乎所有的DBMS都实现了共享缓冲池。
假设有这样一个没有实现WAL机制的PostgreSQL，现在向表A中插入一些数据元组，如图9.1所示。
图9.1 没有WAL的插入操作
发起第一条INSERT语句时，PostgreSQL从数据库集簇文件中加载表A的页面到内存中的共享缓冲池。然后向页面中插入一条元组。页面并没有立刻写回到数据库集簇文件中。正如第8章中提到的，被修改过的页面通常称为脏页（dirty page） 发起第二条INSERT语句时，PostgreSQL直接向缓冲池里的页面内添加了一条新元组。这一页仍然没有被写回到持久存储中。 如果操作系统或PostgreSQL服务器因为各种原因失效（例如电源故障），所有插入的数据都会丢失。 因此没有WAL的数据库在系统崩溃时是很脆弱的。
9.1.2 插入操作与数据库恢复 为了解决上述系统失效问题，同时又不招致性能损失，PostgreSQL支持了WAL。这一部分介绍了一些关键词和概念，以及WAL数据的写入和数据库系统的恢复。
为了应对系统失效，PostgreSQL将所有修改作为历史数据写入持久化存储中。这份历史数据称为XLOG记录（xlog record）或WAL数据（wal data）。
当插入、删除、提交等变更动作发生时，PostgreSQL会将XLOG记录写入内存中的WAL缓冲区（WAL Buffer）。当事务提交或中止时，它们会被立即写入持久存储上的**WAL段文件（WAL segment file）中（更精确来讲，其他场景也可能会有XLOG记录写入，细节将在9.5节中描述）。XLOG记录的日志序列号（Log Sequence Number, LSN）**标识了该记录在事务日志中的位置，记录的LSN被用作XLOG记录的唯一标识符。
顺便一提，当我们考虑数据库系统如何恢复时，可能会想到一个问题：PostgreSQL是从哪一点开始恢复的？答案是重做点（REDO Point），即最新一个检查点（Checkpoint）开始时XLOG记录写入的位置。（PostgreSQL中的检查点将在9.7节中描述）。实际上，数据库恢复过程与检查点过程紧密相连，两者是不可分割的。
WAL与检查点过程在7.1版本中同时实现
介绍完了主要的关键词与概念，现在来说一下带有WAL时的元组插入操作。如图9.2所示：
图9.2 带有WAL的插入操作
表A的LSN展示的是表A页面中页首部里pd_lsn类型的PageXLogRecPtr字段，与页面的LSN是一回事。
检查点进程是一个后台进程，周期性地执行过程。当检查点进程开始执行检查点时，它会向当前WAL段文件写入一条XLOG记录，称为检查点（Checkpoint Record）。这条记录包含了最新的重做点位置。 发起第一条INSERT语句时，PostgreSQL从数据库集簇文件中加载表A的页面至内存中的共享缓冲池，向页面中插入一条元组，然后在LSN_1位置创建并写入一条相应的XLOG记录，然后将表A的LSN从LSN_0更新为LSN_1。在本例中，XLOG记录是由首部数据与完整元组组成的一对值。 当该事务提交时，PostgreSQL向WAL缓冲区创建并写入一条关于该提交行为的XLOG记录，然后将WAL缓冲区中的所有XLOG记录刷写入WAL段文件中。 发起第二条INSERT语句时，PostgreSQL向页面中插入一条新元组，然后在LSN_2位置创建并写入一条相应的XLOG记录，然后将表A的LSN从LSN_1更新为LSN_2。 当这条语句的事务提交时，PostgreSQL执行同步骤3类似的操作。 设想当操作系统失效发生时，尽管共享缓冲区中的所有数据都丢失了，但所有页面修改已经作为历史记录被写入WAL段文件中。 接下来的步骤展示了如何将数据库集簇恢复到崩溃时刻前的状态。不需要任何特殊的操作，重启PostgreSQL时会自动进入恢复模式，如图9.3所示。PostgreSQL会从重做点开始，依序读取正确的WAL段文件并重放XLOG记录。
图9.3 使用WAL进行数据库恢复
PostgreSQL从相关的WAL段文件中读取第一条INSERT语句的XLOG记录，并从硬盘上的数据库集簇目录加载表A的页面到内存中的共享缓冲区中。 在重放XLOG记录前，PostgreSQL会比较XLOG记录的LSN与相应页面的LSN。这么做的原因在第9.8节中描述。重放XLOG记录的规则如下所示： 如果XLOG记录的LSN要比页面LSN大，XLOG记录中的数据部分就会被插入到页面中，并将页面的LSN更新为XLOG记录的LSN。 如果XLOG记录的LSN要比页面的LSN小，那么不用做任何事情，直接读取后续的WAL数据即可。 PostgreSQL按照同样的方式重放其余的XLOG记录。 PostgreSQL可以通过按时间顺序重放写在WAL段文件中的XLOG记录来自我恢复，因此，PostgreSQL的XLOG记录显然是一种重做日志（REDO log）。"/>




<link rel="preload" href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" as="style">
<link href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="/js/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LG1V9WTKGE');
}
</script>
  </head>
  <body class="td-page td-blog">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/zh/"><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class="navbar-brand__name">Pigsty</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/zh/docs/"><i class='fa-solid fa-book'></i><span>文档</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="/zh/blog/"><i class="fas fa-blog"></i><span>博客</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/Vonng/pigsty/" target="_blank" rel="noopener"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-language"></i>中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/">English</a></li>
    </ul>
</div>
</li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.950327bee4cc242f0f17520341fce2c9.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            <div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.950327bee4cc242f0f17520341fce2c9.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type="button" data-bs-toggle="collapse" data-bs-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="td-sidebar-nav collapse foldable-nav" id="td-section-nav">
    <div class="td-sidebar-nav__section nav-item dropdown d-block d-lg-none">
      <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-language"></i>中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/">English</a></li>
    </ul>
</div>

    </div>
    <ul class="td-sidebar-nav__section pe-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-zhblog-li">
  <a href="/zh/blog/" title="Pigsty 博客文章" class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-zhblog"><span class="">博客</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-zhblogdb-li">
  <input type="checkbox" id="m-zhblogdb-check"/>
  <label for="m-zhblogdb-check"><a href="/zh/blog/db/" class="align-left ps-0  td-sidebar-link td-sidebar-link__section" id="m-zhblogdb"><i class="fas fa-database"></i><span class="">数据库</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbguru-li">
  <input type="checkbox" id="m-zhblogdbguru-check"/>
  <label for="m-zhblogdbguru-check"><a href="/zh/blog/db/guru/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbguru"><span class="">数据库老司机：文章导航</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdb7-week-7-db-li">
  <input type="checkbox" id="m-zhblogdb7-week-7-db-check"/>
  <label for="m-zhblogdb7-week-7-db-check"><a href="/zh/blog/db/7-week-7-db/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdb7-week-7-db"><span class="">七周七数据库（2025年）</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbsupabase-li">
  <input type="checkbox" id="m-zhblogdbsupabase-check"/>
  <label for="m-zhblogdbsupabase-check"><a href="/zh/blog/db/supabase/" title="自建Supabase：创业出海的首选数据库" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbsupabase"><span class="">自建Supabase其实很容易</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbfuture-hardware-li">
  <input type="checkbox" id="m-zhblogdbfuture-hardware-check"/>
  <label for="m-zhblogdbfuture-hardware-check"><a href="/zh/blog/db/future-hardware/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbfuture-hardware"><span class="">面向未来数据库的现代硬件</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbcan-mysql-catchup-li">
  <input type="checkbox" id="m-zhblogdbcan-mysql-catchup-check"/>
  <label for="m-zhblogdbcan-mysql-catchup-check"><a href="/zh/blog/db/can-mysql-catchup/" title="PZ：MySQL还有机会赶上PostgreSQL的势头吗？" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbcan-mysql-catchup"><span class="">MySQL还能赶上PG吗？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdblinus-ban-ru-li">
  <input type="checkbox" id="m-zhblogdblinus-ban-ru-check"/>
  <label for="m-zhblogdblinus-ban-ru-check"><a href="/zh/blog/db/linus-ban-ru/" title="开源“暴君”Linus清洗整风" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdblinus-ban-ru"><span class="">开源暴君Linus清君侧</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbbio-core-cpu-core-li">
  <input type="checkbox" id="m-zhblogdbbio-core-cpu-core-check"/>
  <label for="m-zhblogdbbio-core-cpu-core-check"><a href="/zh/blog/db/bio-core-cpu-core/" title="先优化碳基BIO核，再优化硅基CPU核" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbbio-core-cpu-core"><span class="">先优化BIO核，再优化CPU核</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbbad-mongo-li">
  <input type="checkbox" id="m-zhblogdbbad-mongo-check"/>
  <label for="m-zhblogdbbad-mongo-check"><a href="/zh/blog/db/bad-mongo/" title="MongoDB没有未来：好营销救不了烂芒果" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbbad-mongo"><span class="">Mongo没有未来</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbmongo-powered-by-pg-li">
  <input type="checkbox" id="m-zhblogdbmongo-powered-by-pg-check"/>
  <label for="m-zhblogdbmongo-powered-by-pg-check"><a href="/zh/blog/db/mongo-powered-by-pg/" title="MongoDB: 现在由PostgreSQL强力驱动？" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbmongo-powered-by-pg"><span class="">MongoDB：现由PGSQL驱动</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdboss-gov-li">
  <input type="checkbox" id="m-zhblogdboss-gov-check"/>
  <label for="m-zhblogdboss-gov-check"><a href="/zh/blog/db/oss-gov/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdboss-gov"><span class="">瑞士强制政府软件开源</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbmysql-is-dead-li">
  <input type="checkbox" id="m-zhblogdbmysql-is-dead-check"/>
  <label for="m-zhblogdbmysql-is-dead-check"><a href="/zh/blog/db/mysql-is-dead/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbmysql-is-dead"><span class="">MySQL 已死，PostgreSQL 当立</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbcve-2024-6387-li">
  <input type="checkbox" id="m-zhblogdbcve-2024-6387-check"/>
  <label for="m-zhblogdbcve-2024-6387-check"><a href="/zh/blog/db/cve-2024-6387/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbcve-2024-6387"><span class="">CVE-2024-6387 SSH 漏洞修复</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbcan-oracle-save-mysql-li">
  <input type="checkbox" id="m-zhblogdbcan-oracle-save-mysql-check"/>
  <label for="m-zhblogdbcan-oracle-save-mysql-check"><a href="/zh/blog/db/can-oracle-save-mysql/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbcan-oracle-save-mysql"><span class="">Oracle 还能挽救 MySQL 吗？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdboracle-kill-mysql-li">
  <input type="checkbox" id="m-zhblogdboracle-kill-mysql-check"/>
  <label for="m-zhblogdboracle-kill-mysql-check"><a href="/zh/blog/db/oracle-kill-mysql/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdboracle-kill-mysql"><span class="">Oracle最终还是杀死了MySQL</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbsakila-where-are-you-going-li">
  <input type="checkbox" id="m-zhblogdbsakila-where-are-you-going-check"/>
  <label for="m-zhblogdbsakila-where-are-you-going-check"><a href="/zh/blog/db/sakila-where-are-you-going/" title="MySQL性能越来越差，Sakila将何去何从？" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbsakila-where-are-you-going"><span class="">MySQL 到底将何去何从？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbcheap-polar-li">
  <input type="checkbox" id="m-zhblogdbcheap-polar-check"/>
  <label for="m-zhblogdbcheap-polar-check"><a href="/zh/blog/db/cheap-polar/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbcheap-polar"><span class="">20刀好兄弟PolarDB：论数据库该卖什么价？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbdb-china-li">
  <input type="checkbox" id="m-zhblogdbdb-china-check"/>
  <label for="m-zhblogdbdb-china-check"><a href="/zh/blog/db/db-china/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbdb-china"><span class="">国产数据库到底能不能打？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbredis-oss-li">
  <input type="checkbox" id="m-zhblogdbredis-oss-check"/>
  <label for="m-zhblogdbredis-oss-check"><a href="/zh/blog/db/redis-oss/" title="Redis不开源是“开源”之耻，更是公有云之耻" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbredis-oss"><span class="">Redis不开源是“开源”之耻</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbbad-mysql-li">
  <input type="checkbox" id="m-zhblogdbbad-mysql-check"/>
  <label for="m-zhblogdbbad-mysql-check"><a href="/zh/blog/db/bad-mysql/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbbad-mysql"><span class="">MySQL正确性竟如此垃圾？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbdb-in-k8s-li">
  <input type="checkbox" id="m-zhblogdbdb-in-k8s-check"/>
  <label for="m-zhblogdbdb-in-k8s-check"><a href="/zh/blog/db/db-in-k8s/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbdb-in-k8s"><span class="">数据库应该放入K8S里吗？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbsvdb-is-dead-li">
  <input type="checkbox" id="m-zhblogdbsvdb-is-dead-check"/>
  <label for="m-zhblogdbsvdb-is-dead-check"><a href="/zh/blog/db/svdb-is-dead/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbsvdb-is-dead"><span class="">专用向量数据库凉了吗？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbdb-choke-li">
  <input type="checkbox" id="m-zhblogdbdb-choke-check"/>
  <label for="m-zhblogdbdb-choke-check"><a href="/zh/blog/db/db-choke/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbdb-choke"><span class="">数据库真被卡脖子了吗？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbrhel-compatibility-li">
  <input type="checkbox" id="m-zhblogdbrhel-compatibility-check"/>
  <label for="m-zhblogdbrhel-compatibility-check"><a href="/zh/blog/db/rhel-compatibility/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbrhel-compatibility"><span class="">EL系操作系统发行版哪家强？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbsovereign-dbos-li">
  <input type="checkbox" id="m-zhblogdbsovereign-dbos-check"/>
  <label for="m-zhblogdbsovereign-dbos-check"><a href="/zh/blog/db/sovereign-dbos/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbsovereign-dbos"><span class="">基础软件需要什么样的自主可控？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbrethink-li">
  <input type="checkbox" id="m-zhblogdbrethink-check"/>
  <label for="m-zhblogdbrethink-check"><a href="/zh/blog/db/rethink/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbrethink"><span class="">正本清源：技术反思录</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbdemand-pyramid-li">
  <input type="checkbox" id="m-zhblogdbdemand-pyramid-check"/>
  <label for="m-zhblogdbdemand-pyramid-check"><a href="/zh/blog/db/demand-pyramid/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbdemand-pyramid"><span class="">数据库需求层次金字塔</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbdistributive-bullshit-li">
  <input type="checkbox" id="m-zhblogdbdistributive-bullshit-check"/>
  <label for="m-zhblogdbdistributive-bullshit-check"><a href="/zh/blog/db/distributive-bullshit/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbdistributive-bullshit"><span class="">分布式数据库是不是伪需求？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbmicroservice-bad-idea-li">
  <input type="checkbox" id="m-zhblogdbmicroservice-bad-idea-check"/>
  <label for="m-zhblogdbmicroservice-bad-idea-check"><a href="/zh/blog/db/microservice-bad-idea/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbmicroservice-bad-idea"><span class="">微服务是不是个蠢主意？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbgoodbye-gpl-li">
  <input type="checkbox" id="m-zhblogdbgoodbye-gpl-check"/>
  <label for="m-zhblogdbgoodbye-gpl-check"><a href="/zh/blog/db/goodbye-gpl/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbgoodbye-gpl"><span class="">是时候和GPL说再见了</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbpg-in-docker-li">
  <input type="checkbox" id="m-zhblogdbpg-in-docker-check"/>
  <label for="m-zhblogdbpg-in-docker-check"><a href="/zh/blog/db/pg-in-docker/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbpg-in-docker"><span class="">容器化数据库是个好主意吗？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbreason-about-time-li">
  <input type="checkbox" id="m-zhblogdbreason-about-time-check"/>
  <label for="m-zhblogdbreason-about-time-check"><a href="/zh/blog/db/reason-about-time/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbreason-about-time"><span class="">理解时间：闰年闰秒，时间与时区</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbcharacter-encoding-li">
  <input type="checkbox" id="m-zhblogdbcharacter-encoding-check"/>
  <label for="m-zhblogdbcharacter-encoding-check"><a href="/zh/blog/db/character-encoding/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbcharacter-encoding"><span class="">理解字符编码原理</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbconcurrent-control-li">
  <input type="checkbox" id="m-zhblogdbconcurrent-control-check"/>
  <label for="m-zhblogdbconcurrent-control-check"><a href="/zh/blog/db/concurrent-control/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbconcurrent-control"><span class="">并发异常那些事</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbblockchian-li">
  <input type="checkbox" id="m-zhblogdbblockchian-check"/>
  <label for="m-zhblogdbblockchian-check"><a href="/zh/blog/db/blockchian/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbblockchian"><span class="">区块链与分布式数据库</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbconsistency-li">
  <input type="checkbox" id="m-zhblogdbconsistency-check"/>
  <label for="m-zhblogdbconsistency-check"><a href="/zh/blog/db/consistency/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbconsistency"><span class="">一致性：过载的术语</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbwhy-learn-database-li">
  <input type="checkbox" id="m-zhblogdbwhy-learn-database-check"/>
  <label for="m-zhblogdbwhy-learn-database-check"><a href="/zh/blog/db/why-learn-database/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbwhy-learn-database"><span class="">为什么要学习数据库原理</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdbdb-in-2025-li">
  <input type="checkbox" id="m-zhblogdbdb-in-2025-check"/>
  <label for="m-zhblogdbdb-in-2025-check"><a href="/zh/blog/db/db-in-2025/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdbdb-in-2025"><span class=""></span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-zhblogcloud-li">
  <input type="checkbox" id="m-zhblogcloud-check"/>
  <label for="m-zhblogcloud-check"><a href="/zh/blog/cloud/" class="align-left ps-0  td-sidebar-link td-sidebar-link__section" id="m-zhblogcloud"><i class="fas fa-cloud"></i><span class="">云计算</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudpatsy-li">
  <input type="checkbox" id="m-zhblogcloudpatsy-check"/>
  <label for="m-zhblogcloudpatsy-check"><a href="/zh/blog/cloud/patsy/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudpatsy"><span class="">花钱买罪受的大冤种：逃离云计算妙瓦底</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudexit-li">
  <input type="checkbox" id="m-zhblogcloudexit-check"/>
  <label for="m-zhblogcloudexit-check"><a href="/zh/blog/cloud/exit/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudexit"><span class="">云计算泥石流：文章导航</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudopenai-failure-li">
  <input type="checkbox" id="m-zhblogcloudopenai-failure-check"/>
  <label for="m-zhblogcloudopenai-failure-check"><a href="/zh/blog/cloud/openai-failure/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudopenai-failure"><span class="">OpenAI全球宕机复盘：K8S循环依赖</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudwordpress-drama-li">
  <input type="checkbox" id="m-zhblogcloudwordpress-drama-check"/>
  <label for="m-zhblogcloudwordpress-drama-check"><a href="/zh/blog/cloud/wordpress-drama/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudwordpress-drama"><span class="">WordPress社区内战：论共同体划界问题</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudrds-scam-li">
  <input type="checkbox" id="m-zhblogcloudrds-scam-check"/>
  <label for="m-zhblogcloudrds-scam-check"><a href="/zh/blog/cloud/rds-scam/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudrds-scam"><span class="">云数据库：用米其林的价格，吃预制菜大锅饭</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudaliyun-ha-li">
  <input type="checkbox" id="m-zhblogcloudaliyun-ha-check"/>
  <label for="m-zhblogcloudaliyun-ha-check"><a href="/zh/blog/cloud/aliyun-ha/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudaliyun-ha"><span class="">阿里云：高可用容灾神话破灭</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudcloud-exit-li">
  <input type="checkbox" id="m-zhblogcloudcloud-exit-check"/>
  <label for="m-zhblogcloudcloud-exit-check"><a href="/zh/blog/cloud/cloud-exit/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudcloud-exit"><span class="">云计算泥石流：合订本</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudrds-failure-li">
  <input type="checkbox" id="m-zhblogcloudrds-failure-check"/>
  <label for="m-zhblogcloudrds-failure-check"><a href="/zh/blog/cloud/rds-failure/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudrds-failure"><span class="">草台班子唱大戏，阿里云PG翻车记</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudnetease-li">
  <input type="checkbox" id="m-zhblogcloudnetease-check"/>
  <label for="m-zhblogcloudnetease-check"><a href="/zh/blog/cloud/netease/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudnetease"><span class="">我们能从网易云音乐故障中学到什么？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudbsod-friday-li">
  <input type="checkbox" id="m-zhblogcloudbsod-friday-check"/>
  <label for="m-zhblogcloudbsod-friday-check"><a href="/zh/blog/cloud/bsod-friday/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudbsod-friday"><span class="">蓝屏星期五：甲乙双方都是草台班子</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudahrefs-saving-li">
  <input type="checkbox" id="m-zhblogcloudahrefs-saving-check"/>
  <label for="m-zhblogcloudahrefs-saving-check"><a href="/zh/blog/cloud/ahrefs-saving/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudahrefs-saving"><span class="">Ahrefs不上云，省下四亿美元</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudgcp-unisuper-li">
  <input type="checkbox" id="m-zhblogcloudgcp-unisuper-check"/>
  <label for="m-zhblogcloudgcp-unisuper-check"><a href="/zh/blog/cloud/gcp-unisuper/" title="删库：Google云爆破了大基金的整个云账户" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudgcp-unisuper"><span class="">Google云删库：UniSuper</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogclouds3-scam-li">
  <input type="checkbox" id="m-zhblogclouds3-scam-check"/>
  <label for="m-zhblogclouds3-scam-check"><a href="/zh/blog/cloud/s3-scam/" title="云上黑暗森林：打爆云账单，只需要S3桶名" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogclouds3-scam"><span class="">打爆云账单，只需要S3桶名</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudcf-interview-li">
  <input type="checkbox" id="m-zhblogcloudcf-interview-check"/>
  <label for="m-zhblogcloudcf-interview-check"><a href="/zh/blog/cloud/cf-interview/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudcf-interview"><span class="">Cloudflare圆桌访谈与问答录</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudqcloud-li">
  <input type="checkbox" id="m-zhblogcloudqcloud-check"/>
  <label for="m-zhblogcloudqcloud-check"><a href="/zh/blog/cloud/qcloud/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudqcloud"><span class="">我们能从腾讯云大故障中学到什么?</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudcloudflare-li">
  <input type="checkbox" id="m-zhblogcloudcloudflare-check"/>
  <label for="m-zhblogcloudcloudflare-check"><a href="/zh/blog/cloud/cloudflare/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudcloudflare"><span class="">吊打公有云的赛博佛祖 Cloudflare</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudluo-live-li">
  <input type="checkbox" id="m-zhblogcloudluo-live-check"/>
  <label for="m-zhblogcloudluo-live-check"><a href="/zh/blog/cloud/luo-live/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudluo-live"><span class="">罗永浩救不了牙膏云？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudecs-li">
  <input type="checkbox" id="m-zhblogcloudecs-check"/>
  <label for="m-zhblogcloudecs-check"><a href="/zh/blog/cloud/ecs/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudecs"><span class="">剖析阿里云服务器算力成本</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogclouduptime-li">
  <input type="checkbox" id="m-zhblogclouduptime-check"/>
  <label for="m-zhblogclouduptime-check"><a href="/zh/blog/cloud/uptime/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogclouduptime"><span class="">云下高可用秘诀：拒绝复杂度自慰</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogclouds3-li">
  <input type="checkbox" id="m-zhblogclouds3-check"/>
  <label for="m-zhblogclouds3-check"><a href="/zh/blog/cloud/s3/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogclouds3"><span class="">扒皮云对象存储：从降本到杀猪</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudcloud-exit-faq-li">
  <input type="checkbox" id="m-zhblogcloudcloud-exit-faq-check"/>
  <label for="m-zhblogcloudcloud-exit-faq-check"><a href="/zh/blog/cloud/cloud-exit-faq/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudcloud-exit-faq"><span class="">半年下云省千万，DHH下云FAQ</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudsmile-li">
  <input type="checkbox" id="m-zhblogcloudsmile-check"/>
  <label for="m-zhblogcloudsmile-check"><a href="/zh/blog/cloud/smile/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudsmile"><span class="">从降本增笑到真的降本增效</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudbonus-li">
  <input type="checkbox" id="m-zhblogcloudbonus-check"/>
  <label for="m-zhblogcloudbonus-check"><a href="/zh/blog/cloud/bonus/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudbonus"><span class="">重新拿回计算机硬件的红利</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudaliyun-li">
  <input type="checkbox" id="m-zhblogcloudaliyun-check"/>
  <label for="m-zhblogcloudaliyun-check"><a href="/zh/blog/cloud/aliyun/" title="我们能从阿里云全球故障中学到什么?" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudaliyun"><span class="">阿里云史诗级故障非官方复盘</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudcheap-ecs-li">
  <input type="checkbox" id="m-zhblogcloudcheap-ecs-check"/>
  <label for="m-zhblogcloudcheap-ecs-check"><a href="/zh/blog/cloud/cheap-ecs/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudcheap-ecs"><span class="">薅阿里云羊毛，打造数字家园</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogclouddebris-li">
  <input type="checkbox" id="m-zhblogclouddebris-check"/>
  <label for="m-zhblogclouddebris-check"><a href="/zh/blog/cloud/debris/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogclouddebris"><span class="">云计算泥石流：用数据解构公有云</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudodyssey-done-li">
  <input type="checkbox" id="m-zhblogcloudodyssey-done-check"/>
  <label for="m-zhblogcloudodyssey-done-check"><a href="/zh/blog/cloud/odyssey-done/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudodyssey-done"><span class="">DHH：下云省下千万美元，比预想的还要多！</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudodyssey-li">
  <input type="checkbox" id="m-zhblogcloudodyssey-check"/>
  <label for="m-zhblogcloudodyssey-check"><a href="/zh/blog/cloud/odyssey/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudodyssey"><span class="">下云奥德赛：该放弃云计算了吗？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudfinops-li">
  <input type="checkbox" id="m-zhblogcloudfinops-check"/>
  <label for="m-zhblogcloudfinops-check"><a href="/zh/blog/cloud/finops/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudfinops"><span class="">FinOps终点是下云</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudprofit-li">
  <input type="checkbox" id="m-zhblogcloudprofit-check"/>
  <label for="m-zhblogcloudprofit-check"><a href="/zh/blog/cloud/profit/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudprofit"><span class="">云计算为啥还没挖沙子赚钱？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudsla-li">
  <input type="checkbox" id="m-zhblogcloudsla-check"/>
  <label for="m-zhblogcloudsla-check"><a href="/zh/blog/cloud/sla/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudsla"><span class="">云SLA是不是安慰剂？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudebs-li">
  <input type="checkbox" id="m-zhblogcloudebs-check"/>
  <label for="m-zhblogcloudebs-check"><a href="/zh/blog/cloud/ebs/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudebs"><span class="">云盘是不是杀猪盘？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudcdn-li">
  <input type="checkbox" id="m-zhblogcloudcdn-check"/>
  <label for="m-zhblogcloudcdn-check"><a href="/zh/blog/cloud/cdn/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudcdn"><span class="">垃圾腾讯云CDN：从入门到放弃？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudno-dba-bullshit-li">
  <input type="checkbox" id="m-zhblogcloudno-dba-bullshit-check"/>
  <label for="m-zhblogcloudno-dba-bullshit-check"><a href="/zh/blog/cloud/no-dba-bullshit/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudno-dba-bullshit"><span class="">驳《再论为什么你不应该招DBA》</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudparadigm-li">
  <input type="checkbox" id="m-zhblogcloudparadigm-check"/>
  <label for="m-zhblogcloudparadigm-check"><a href="/zh/blog/cloud/paradigm/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudparadigm"><span class="">范式转移：从云到本地优先</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudrds-li">
  <input type="checkbox" id="m-zhblogcloudrds-check"/>
  <label for="m-zhblogcloudrds-check"><a href="/zh/blog/cloud/rds/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudrds"><span class="">云数据库是不是智商税</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogcloudis-dba-good-job-li">
  <input type="checkbox" id="m-zhblogcloudis-dba-good-job-check"/>
  <label for="m-zhblogcloudis-dba-good-job-check"><a href="/zh/blog/cloud/is-dba-good-job/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogcloudis-dba-good-job"><span class="">DBA还是一份好工作吗？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogclouddrop-rds-li">
  <input type="checkbox" id="m-zhblogclouddrop-rds-check"/>
  <label for="m-zhblogclouddrop-rds-check"><a href="/zh/blog/cloud/drop-rds/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogclouddrop-rds"><span class="">云RDS：从删库到跑路</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogclouddba-vs-rds-li">
  <input type="checkbox" id="m-zhblogclouddba-vs-rds-check"/>
  <label for="m-zhblogclouddba-vs-rds-check"><a href="/zh/blog/cloud/dba-vs-rds/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogclouddba-vs-rds"><span class="">DBA会被云淘汰吗？</span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-zhblogpg-li">
  <input type="checkbox" id="m-zhblogpg-check"/>
  <label for="m-zhblogpg-check"><a href="/zh/blog/pg/" class="align-left ps-0  td-sidebar-link td-sidebar-link__section" id="m-zhblogpg"><i class="fas fa-bullhorn"></i><span class="">PG 生态</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpig-li">
  <input type="checkbox" id="m-zhblogpgpig-check"/>
  <label for="m-zhblogpgpig-check"><a href="/zh/blog/pg/pig/" title="小猪骑大象：PG内核与扩展包管理神器" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpig"><span class="">小猪骑大象：PG包管理神器Pig</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-faint-li">
  <input type="checkbox" id="m-zhblogpgpg-faint-check"/>
  <label for="m-zhblogpgpg-faint-check"><a href="/zh/blog/pg/pg-faint/" title="不要更新！发布当日叫停：PG也躲不过大翻车" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-faint"><span class="">发布当日叫停：PG也躲不过大翻车</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg12-eol-pg17-up-li">
  <input type="checkbox" id="m-zhblogpgpg12-eol-pg17-up-check"/>
  <label for="m-zhblogpgpg12-eol-pg17-up-check"><a href="/zh/blog/pg/pg12-eol-pg17-up/" title="PostgreSQL 12 过保，PG 17 上位" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg12-eol-pg17-up"><span class="">PG12过保，PG17上位</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-ext-repo-li">
  <input type="checkbox" id="m-zhblogpgpg-ext-repo-check"/>
  <label for="m-zhblogpgpg-ext-repo-check"><a href="/zh/blog/pg/pg-ext-repo/" title="PostgreSQL神功大成！最全扩展仓库来了！" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-ext-repo"><span class="">PostgreSQL神功大成！</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-convention-li">
  <input type="checkbox" id="m-zhblogpgpg-convention-check"/>
  <label for="m-zhblogpgpg-convention-check"><a href="/zh/blog/pg/pg-convention/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-convention"><span class="">PostgreSQL 规约（2024版）</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-17-li">
  <input type="checkbox" id="m-zhblogpgpg-17-check"/>
  <label for="m-zhblogpgpg-17-check"><a href="/zh/blog/pg/pg-17/" title="PostgreSQL 17 发布：摊牌了，我不装了！" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-17"><span class="">PG17发布：摊牌了，我不装了！</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-replace-mssql-li">
  <input type="checkbox" id="m-zhblogpgpg-replace-mssql-check"/>
  <label for="m-zhblogpgpg-replace-mssql-check"><a href="/zh/blog/pg/pg-replace-mssql/" title="PostgreSQL可以替代微软SQL Server吗？" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-replace-mssql"><span class="">PG可以替代MSSQL吗？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-duckdb-li">
  <input type="checkbox" id="m-zhblogpgpg-duckdb-check"/>
  <label for="m-zhblogpgpg-duckdb-check"><a href="/zh/blog/pg/pg-duckdb/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-duckdb"><span class="">谁整合好DuckDB，谁赢得OLAP世界</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-is-no1-again-li">
  <input type="checkbox" id="m-zhblogpgpg-is-no1-again-check"/>
  <label for="m-zhblogpgpg-is-no1-again-check"><a href="/zh/blog/pg/pg-is-no1-again/" title="StackOverflow 2024调研：PostgreSQL已经杀疯了" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-is-no1-again"><span class="">SO 2024：PostgreSQL已经杀疯了</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgdify-setup-li">
  <input type="checkbox" id="m-zhblogpgdify-setup-check"/>
  <label for="m-zhblogpgdify-setup-check"><a href="/zh/blog/pg/dify-setup/" title="使用Pigsty,PG,PGVector自建Dify -- AI工作流平台" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgdify-setup"><span class="">使用Pigsty自建Dify，AI工作流</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpgcondev-2024-li">
  <input type="checkbox" id="m-zhblogpgpgcondev-2024-check"/>
  <label for="m-zhblogpgpgcondev-2024-check"><a href="/zh/blog/pg/pgcondev-2024/" title="让PG停摆一周的大会：PGCon.Dev 2024 参会记" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpgcondev-2024"><span class="">PGCon.Dev 2024 参会记</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-17-beta1-li">
  <input type="checkbox" id="m-zhblogpgpg-17-beta1-check"/>
  <label for="m-zhblogpgpg-17-beta1-check"><a href="/zh/blog/pg/pg-17-beta1/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-17-beta1"><span class="">PostgreSQL 17 beta1 发布！</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-for-everything-li">
  <input type="checkbox" id="m-zhblogpgpg-for-everything-check"/>
  <label for="m-zhblogpgpg-for-everything-check"><a href="/zh/blog/pg/pg-for-everything/" title="为什么PostgreSQL是未来数据库的事实标准？" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-for-everything"><span class="">为什么PG是未来数据的基石？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-license-li">
  <input type="checkbox" id="m-zhblogpgpg-license-check"/>
  <label for="m-zhblogpgpg-license-check"><a href="/zh/blog/pg/pg-license/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-license"><span class="">PostgreSQL会修改开源许可证吗？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-eat-db-world-li">
  <input type="checkbox" id="m-zhblogpgpg-eat-db-world-check"/>
  <label for="m-zhblogpgpg-eat-db-world-check"><a href="/zh/blog/pg/pg-eat-db-world/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-eat-db-world"><span class="">PostgreSQL正在吞噬数据库世界</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgjust-use-pg-li">
  <input type="checkbox" id="m-zhblogpgjust-use-pg-check"/>
  <label for="m-zhblogpgjust-use-pg-check"><a href="/zh/blog/pg/just-use-pg/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgjust-use-pg"><span class="">技术极简主义：一切皆用Postgres</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgparadedb-li">
  <input type="checkbox" id="m-zhblogpgparadedb-check"/>
  <label for="m-zhblogpgparadedb-check"><a href="/zh/blog/pg/paradedb/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgparadedb"><span class="">PG生态新玩家：ParadeDB</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-scalability-li">
  <input type="checkbox" id="m-zhblogpgpg-scalability-check"/>
  <label for="m-zhblogpgpg-scalability-check"><a href="/zh/blog/pg/pg-scalability/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-scalability"><span class="">令人惊叹的PostgreSQL可伸缩性</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-dbeng-2024-li">
  <input type="checkbox" id="m-zhblogpgpg-dbeng-2024-check"/>
  <label for="m-zhblogpgpg-dbeng-2024-check"><a href="/zh/blog/pg/pg-dbeng-2024/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-dbeng-2024"><span class="">PostgreSQL荣获2024年度数据库之王！（第五次）</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-in-2024-li">
  <input type="checkbox" id="m-zhblogpgpg-in-2024-check"/>
  <label for="m-zhblogpgpg-in-2024-check"><a href="/zh/blog/pg/pg-in-2024/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-in-2024"><span class="">展望 PostgreSQL 的2024</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgferretdb-li">
  <input type="checkbox" id="m-zhblogpgferretdb-check"/>
  <label for="m-zhblogpgferretdb-check"><a href="/zh/blog/pg/ferretdb/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgferretdb"><span class="">FerretDB：假扮成MongoDB的PG</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgvector-json-pg-li">
  <input type="checkbox" id="m-zhblogpgvector-json-pg-check"/>
  <label for="m-zhblogpgvector-json-pg-check"><a href="/zh/blog/pg/vector-json-pg/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgvector-json-pg"><span class="">向量是新的 JSON</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-is-no1-li">
  <input type="checkbox" id="m-zhblogpgpg-is-no1-check"/>
  <label for="m-zhblogpgpg-is-no1-check"><a href="/zh/blog/pg/pg-is-no1/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-is-no1"><span class="">PostgreSQL：最成功的数据库</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-performence-li">
  <input type="checkbox" id="m-zhblogpgpg-performence-check"/>
  <label for="m-zhblogpgpg-performence-check"><a href="/zh/blog/pg/pg-performence/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-performence"><span class="">PostgreSQL 到底有多强？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-is-best-li">
  <input type="checkbox" id="m-zhblogpgpg-is-best-check"/>
  <label for="m-zhblogpgpg-is-best-check"><a href="/zh/blog/pg/pg-is-best/" title="为什么PostgreSQL是最成功的数据库？" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-is-best"><span class="">为什么PG是最成功的数据库？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpigsty-intro-li">
  <input type="checkbox" id="m-zhblogpgpigsty-intro-check"/>
  <label for="m-zhblogpgpigsty-intro-check"><a href="/zh/blog/pg/pigsty-intro/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpigsty-intro"><span class="">开箱即用的PG发行版：Pigsty</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-is-great-li">
  <input type="checkbox" id="m-zhblogpgpg-is-great-check"/>
  <label for="m-zhblogpgpg-is-great-check"><a href="/zh/blog/pg/pg-is-great/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-is-great"><span class="">为什么PostgreSQL前途无量？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-is-good-li">
  <input type="checkbox" id="m-zhblogpgpg-is-good-check"/>
  <label for="m-zhblogpgpg-is-good-check"><a href="/zh/blog/pg/pg-is-good/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-is-good"><span class="">PostgreSQL好处都有啥</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogpgpg-go-driver-li">
  <input type="checkbox" id="m-zhblogpgpg-go-driver-check"/>
  <label for="m-zhblogpgpg-go-driver-check"><a href="/zh/blog/pg/pg-go-driver/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogpgpg-go-driver"><span class="">Go数据库教程：database/sql</span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-zhblogdev-li">
  <input type="checkbox" id="m-zhblogdev-check"/>
  <label for="m-zhblogdev-check"><a href="/zh/blog/dev/" class="align-left ps-0  td-sidebar-link td-sidebar-link__section" id="m-zhblogdev"><i class="fas fa-keyboard"></i><span class="">PG 开发</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevllm-and-pgvector-li">
  <input type="checkbox" id="m-zhblogdevllm-and-pgvector-check"/>
  <label for="m-zhblogdevllm-and-pgvector-check"><a href="/zh/blog/dev/llm-and-pgvector/" title="AI大模型与向量库 PGVector" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevllm-and-pgvector"><span class="">AI大模型与PGVector</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevfuzzymatch-li">
  <input type="checkbox" id="m-zhblogdevfuzzymatch-check"/>
  <label for="m-zhblogdevfuzzymatch-check"><a href="/zh/blog/dev/fuzzymatch/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevfuzzymatch"><span class="">高级模糊查询的实现</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevwire-protocol-li">
  <input type="checkbox" id="m-zhblogdevwire-protocol-check"/>
  <label for="m-zhblogdevwire-protocol-check"><a href="/zh/blog/dev/wire-protocol/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevwire-protocol"><span class="">前后端通信线缆协议</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevisolation-level-li">
  <input type="checkbox" id="m-zhblogdevisolation-level-check"/>
  <label for="m-zhblogdevisolation-level-check"><a href="/zh/blog/dev/isolation-level/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevisolation-level"><span class="">事务隔离等级注意事项</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevlogical-decoding-li">
  <input type="checkbox" id="m-zhblogdevlogical-decoding-check"/>
  <label for="m-zhblogdevlogical-decoding-check"><a href="/zh/blog/dev/logical-decoding/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevlogical-decoding"><span class="">CDC 变更数据捕获机理</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevpg-lock-li">
  <input type="checkbox" id="m-zhblogdevpg-lock-check"/>
  <label for="m-zhblogdevpg-lock-check"><a href="/zh/blog/dev/pg-lock/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevpg-lock"><span class="">PostgreSQL中的锁</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevgin-li">
  <input type="checkbox" id="m-zhblogdevgin-check"/>
  <label for="m-zhblogdevgin-check"><a href="/zh/blog/dev/gin/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevgin"><span class="">GIN搜索的O(n2)负载度</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevgeoip-li">
  <input type="checkbox" id="m-zhblogdevgeoip-check"/>
  <label for="m-zhblogdevgeoip-check"><a href="/zh/blog/dev/geoip/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevgeoip"><span class="">GeoIP 地理逆查询优化</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevsql-trigger-li">
  <input type="checkbox" id="m-zhblogdevsql-trigger-check"/>
  <label for="m-zhblogdevsql-trigger-check"><a href="/zh/blog/dev/sql-trigger/" title="PostgreSQL的触发器使用注意事项" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevsql-trigger"><span class="">触发器使用注意事项</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevpg-convention-li">
  <input type="checkbox" id="m-zhblogdevpg-convention-check"/>
  <label for="m-zhblogdevpg-convention-check"><a href="/zh/blog/dev/pg-convention/" title="PostgreSQL开发规约（2018版）" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevpg-convention"><span class="">PostgreSQL开发规约2018版</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevknn-optimize-li">
  <input type="checkbox" id="m-zhblogdevknn-optimize-check"/>
  <label for="m-zhblogdevknn-optimize-check"><a href="/zh/blog/dev/knn-optimize/" title="KNN极致优化：从RDS到PostGIS" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevknn-optimize"><span class="">KNN极致优化：GIS圈选</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevadcode-geodecode-li">
  <input type="checkbox" id="m-zhblogdevadcode-geodecode-check"/>
  <label for="m-zhblogdevadcode-geodecode-check"><a href="/zh/blog/dev/adcode-geodecode/" title="PostGIS高效解决行政区划归属查询" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevadcode-geodecode"><span class="">行政区划查询：GIS点找面</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevsql-distinct-on-li">
  <input type="checkbox" id="m-zhblogdevsql-distinct-on-check"/>
  <label for="m-zhblogdevsql-distinct-on-check"><a href="/zh/blog/dev/sql-distinct-on/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevsql-distinct-on"><span class="">Distinct On 去除重复数据</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevsql-func-volatility-li">
  <input type="checkbox" id="m-zhblogdevsql-func-volatility-check"/>
  <label for="m-zhblogdevsql-func-volatility-check"><a href="/zh/blog/dev/sql-func-volatility/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevsql-func-volatility"><span class="">函数易变性等级分类</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevsql-exclude-li">
  <input type="checkbox" id="m-zhblogdevsql-exclude-check"/>
  <label for="m-zhblogdevsql-exclude-check"><a href="/zh/blog/dev/sql-exclude/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevsql-exclude"><span class="">用 Exclude 实现互斥约束</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevnotify-trigger-based-repl-li">
  <input type="checkbox" id="m-zhblogdevnotify-trigger-based-repl-check"/>
  <label for="m-zhblogdevnotify-trigger-based-repl-check"><a href="/zh/blog/dev/notify-trigger-based-repl/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevnotify-trigger-based-repl"><span class="">GO与PG实现缓存同步</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevaudit-change-li">
  <input type="checkbox" id="m-zhblogdevaudit-change-check"/>
  <label for="m-zhblogdevaudit-change-check"><a href="/zh/blog/dev/audit-change/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevaudit-change"><span class="">用触发器审计数据变化</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevpg-recsys-li">
  <input type="checkbox" id="m-zhblogdevpg-recsys-check"/>
  <label for="m-zhblogdevpg-recsys-check"><a href="/zh/blog/dev/pg-recsys/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevpg-recsys"><span class="">SQL实现ItemCF推荐系统</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogdevuuid-li">
  <input type="checkbox" id="m-zhblogdevuuid-check"/>
  <label for="m-zhblogdevuuid-check"><a href="/zh/blog/dev/uuid/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogdevuuid"><span class="">UUID性质原理与应用</span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-zhblogadmin-li">
  <input type="checkbox" id="m-zhblogadmin-check"/>
  <label for="m-zhblogadmin-check"><a href="/zh/blog/admin/" class="align-left ps-0  td-sidebar-link td-sidebar-link__section" id="m-zhblogadmin"><i class="fas fa-balance-scale"></i><span class="">PG 管理</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminlogical-replication-li">
  <input type="checkbox" id="m-zhblogadminlogical-replication-check"/>
  <label for="m-zhblogadminlogical-replication-check"><a href="/zh/blog/admin/logical-replication/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminlogical-replication"><span class="">PostgreSQL 逻辑复制详解</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminpgss-li">
  <input type="checkbox" id="m-zhblogadminpgss-check"/>
  <label for="m-zhblogadminpgss-check"><a href="/zh/blog/admin/pgss/" title="PostgreSQL 宏观查询优化之 pg_stat_statements" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminpgss"><span class="">PG查询优化：观宏之道</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminpg-filedump-li">
  <input type="checkbox" id="m-zhblogadminpg-filedump-check"/>
  <label for="m-zhblogadminpg-filedump-check"><a href="/zh/blog/admin/pg-filedump/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminpg-filedump"><span class="">如何用 pg_filedump 抢救数据？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadmincollate-li">
  <input type="checkbox" id="m-zhblogadmincollate-check"/>
  <label for="m-zhblogadmincollate-check"><a href="/zh/blog/admin/collate/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadmincollate"><span class="">PG中的本地化排序规则</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminreplica-identity-li">
  <input type="checkbox" id="m-zhblogadminreplica-identity-check"/>
  <label for="m-zhblogadminreplica-identity-check"><a href="/zh/blog/admin/replica-identity/" title="PG复制标识详解（Replica Identity）" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminreplica-identity"><span class="">PG复制标识详解</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminslow-query-li">
  <input type="checkbox" id="m-zhblogadminslow-query-check"/>
  <label for="m-zhblogadminslow-query-check"><a href="/zh/blog/admin/slow-query/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminslow-query"><span class="">PG慢查询诊断方法论</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadmintime-travel-li">
  <input type="checkbox" id="m-zhblogadmintime-travel-check"/>
  <label for="m-zhblogadmintime-travel-check"><a href="/zh/blog/admin/time-travel/" title="故障档案:时间回溯导致的Patroni故障" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadmintime-travel"><span class="">故障档案：NTP/Patroni</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminalter-type-li">
  <input type="checkbox" id="m-zhblogadminalter-type-check"/>
  <label for="m-zhblogadminalter-type-check"><a href="/zh/blog/admin/alter-type/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminalter-type"><span class="">在线修改主键列类型</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadmingolden-metrics-li">
  <input type="checkbox" id="m-zhblogadmingolden-metrics-check"/>
  <label for="m-zhblogadmingolden-metrics-check"><a href="/zh/blog/admin/golden-metrics/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadmingolden-metrics"><span class="">黄金监控指标：错误延迟吞吐饱和</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminentity-and-naming-li">
  <input type="checkbox" id="m-zhblogadminentity-and-naming-check"/>
  <label for="m-zhblogadminentity-and-naming-check"><a href="/zh/blog/admin/entity-and-naming/" title="数据库集群管理概念与实体命名规范" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminentity-and-naming"><span class="">数据库管理实体与命名规范</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminpg-load-li">
  <input type="checkbox" id="m-zhblogadminpg-load-check"/>
  <label for="m-zhblogadminpg-load-check"><a href="/zh/blog/admin/pg-load/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminpg-load"><span class="">PostgreSQL的KPI</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminmigrate-column-type-li">
  <input type="checkbox" id="m-zhblogadminmigrate-column-type-check"/>
  <label for="m-zhblogadminmigrate-column-type-check"><a href="/zh/blog/admin/migrate-column-type/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminmigrate-column-type"><span class="">在线修改PG字段类型</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminextension-li">
  <input type="checkbox" id="m-zhblogadminextension-check"/>
  <label for="m-zhblogadminextension-check"><a href="/zh/blog/admin/extension/" title="故障档案：PG安装Extension导致无法连接" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminextension"><span class="">故障:扩展导致拒绝连接</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminreplication-plan-li">
  <input type="checkbox" id="m-zhblogadminreplication-plan-check"/>
  <label for="m-zhblogadminreplication-plan-check"><a href="/zh/blog/admin/replication-plan/" title="PostgreSQL 常见复制拓扑方案" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminreplication-plan"><span class="">常见复制拓扑方案</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminbackup-plan-li">
  <input type="checkbox" id="m-zhblogadminbackup-plan-check"/>
  <label for="m-zhblogadminbackup-plan-check"><a href="/zh/blog/admin/backup-plan/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminbackup-plan"><span class="">温备：使用pg_receivewal</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminpg-dump-failure-li">
  <input type="checkbox" id="m-zhblogadminpg-dump-failure-check"/>
  <label for="m-zhblogadminpg-dump-failure-check"><a href="/zh/blog/admin/pg-dump-failure/" title="故障档案：pg_dump导致的连接池污染" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminpg-dump-failure"><span class="">故障档案：连接池污染</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminpage-corruption-li">
  <input type="checkbox" id="m-zhblogadminpage-corruption-check"/>
  <label for="m-zhblogadminpage-corruption-check"><a href="/zh/blog/admin/page-corruption/" title="PostgreSQL数据页面损坏修复" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminpage-corruption"><span class="">故障档案：数据页损坏</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminbloat-li">
  <input type="checkbox" id="m-zhblogadminbloat-check"/>
  <label for="m-zhblogadminbloat-check"><a href="/zh/blog/admin/bloat/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminbloat"><span class="">关系膨胀的监控与治理</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminpipeline-intro-li">
  <input type="checkbox" id="m-zhblogadminpipeline-intro-check"/>
  <label for="m-zhblogadminpipeline-intro-check"><a href="/zh/blog/admin/pipeline-intro/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminpipeline-intro"><span class="">PipelineDB快速上手</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadmintimescale-install-li">
  <input type="checkbox" id="m-zhblogadmintimescale-install-check"/>
  <label for="m-zhblogadmintimescale-install-check"><a href="/zh/blog/admin/timescale-install/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadmintimescale-install"><span class="">TimescaleDB 快速上手</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminxid-wrap-around-li">
  <input type="checkbox" id="m-zhblogadminxid-wrap-around-check"/>
  <label for="m-zhblogadminxid-wrap-around-check"><a href="/zh/blog/admin/xid-wrap-around/" title="故障档案：PostgreSQL事务号回卷" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminxid-wrap-around"><span class="">故障档案：XID回卷</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminsequence-overflow-li">
  <input type="checkbox" id="m-zhblogadminsequence-overflow-check"/>
  <label for="m-zhblogadminsequence-overflow-check"><a href="/zh/blog/admin/sequence-overflow/" title="故障档案：序列号消耗过快导致整型溢出" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminsequence-overflow"><span class="">故障档案：序列号溢出</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminmon-table-size-li">
  <input type="checkbox" id="m-zhblogadminmon-table-size-check"/>
  <label for="m-zhblogadminmon-table-size-check"><a href="/zh/blog/admin/mon-table-size/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminmon-table-size"><span class="">监控PG中的表大小</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminpgadmin-install-li">
  <input type="checkbox" id="m-zhblogadminpgadmin-install-check"/>
  <label for="m-zhblogadminpgadmin-install-check"><a href="/zh/blog/admin/pgadmin-install/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminpgadmin-install"><span class="">PgAdmin安装配置</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadmindownload-failure-li">
  <input type="checkbox" id="m-zhblogadmindownload-failure-check"/>
  <label for="m-zhblogadmindownload-failure-check"><a href="/zh/blog/admin/download-failure/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadmindownload-failure"><span class="">故障档案：快慢不匀雪崩</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminpsql-and-bash-li">
  <input type="checkbox" id="m-zhblogadminpsql-and-bash-check"/>
  <label for="m-zhblogadminpsql-and-bash-check"><a href="/zh/blog/admin/psql-and-bash/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminpsql-and-bash"><span class="">Bash与psql小技巧</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminroutine-maintain-li">
  <input type="checkbox" id="m-zhblogadminroutine-maintain-check"/>
  <label for="m-zhblogadminroutine-maintain-check"><a href="/zh/blog/admin/routine-maintain/" title="PostgreSQL例行维护" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminroutine-maintain"><span class="">PgSQL例行维护任务</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminbackup-overview-li">
  <input type="checkbox" id="m-zhblogadminbackup-overview-check"/>
  <label for="m-zhblogadminbackup-overview-check"><a href="/zh/blog/admin/backup-overview/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminbackup-overview"><span class="">备份恢复手段概览</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminpgbackrest-li">
  <input type="checkbox" id="m-zhblogadminpgbackrest-check"/>
  <label for="m-zhblogadminpgbackrest-check"><a href="/zh/blog/admin/pgbackrest/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminpgbackrest"><span class="">PgBackRest2中文文档</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminpgbouncer-usage-li">
  <input type="checkbox" id="m-zhblogadminpgbouncer-usage-check"/>
  <label for="m-zhblogadminpgbouncer-usage-check"><a href="/zh/blog/admin/pgbouncer-usage/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminpgbouncer-usage"><span class="">Pgbouncer快速上手</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminlogging-li">
  <input type="checkbox" id="m-zhblogadminlogging-check"/>
  <label for="m-zhblogadminlogging-check"><a href="/zh/blog/admin/logging/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminlogging"><span class="">PG服务器日志常规配置</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminmigration-without-downtime-li">
  <input type="checkbox" id="m-zhblogadminmigration-without-downtime-check"/>
  <label for="m-zhblogadminmigration-without-downtime-check"><a href="/zh/blog/admin/migration-without-downtime/" title="空中换引擎 —— PostgreSQL不停机迁移数据" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminmigration-without-downtime"><span class="">不停机迁移数据迁移基本原理</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminfio-li">
  <input type="checkbox" id="m-zhblogadminfio-check"/>
  <label for="m-zhblogadminfio-check"><a href="/zh/blog/admin/fio/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminfio"><span class="">使用FIO测试磁盘性能</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminsysbench-li">
  <input type="checkbox" id="m-zhblogadminsysbench-check"/>
  <label for="m-zhblogadminsysbench-check"><a href="/zh/blog/admin/sysbench/" title="使用sysbench测试PostgreSQL性能" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminsysbench"><span class="">使用sysbench测试性能</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminfind-dummy-index-li">
  <input type="checkbox" id="m-zhblogadminfind-dummy-index-check"/>
  <label for="m-zhblogadminfind-dummy-index-check"><a href="/zh/blog/admin/find-dummy-index/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminfind-dummy-index"><span class="">找出没用过的索引</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminssh-add-key-li">
  <input type="checkbox" id="m-zhblogadminssh-add-key-check"/>
  <label for="m-zhblogadminssh-add-key-check"><a href="/zh/blog/admin/ssh-add-key/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminssh-add-key"><span class="">批量配置SSH免密登录</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminwireshark-capture-li">
  <input type="checkbox" id="m-zhblogadminwireshark-capture-check"/>
  <label for="m-zhblogadminwireshark-capture-check"><a href="/zh/blog/admin/wireshark-capture/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminwireshark-capture"><span class="">Wireshark抓包分析协议</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminfile_fdw-li">
  <input type="checkbox" id="m-zhblogadminfile_fdw-check"/>
  <label for="m-zhblogadminfile_fdw-check"><a href="/zh/blog/admin/file_fdw/" title="file_fdw妙用无穷——从数据库读取系统信息" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminfile_fdw"><span class="">FileFDW用例：读取OS信息</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminunix-tool-li">
  <input type="checkbox" id="m-zhblogadminunix-tool-check"/>
  <label for="m-zhblogadminunix-tool-check"><a href="/zh/blog/admin/unix-tool/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminunix-tool"><span class="">Linux 常用统计 CLI 工具</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminpostgis-install-li">
  <input type="checkbox" id="m-zhblogadminpostgis-install-check"/>
  <label for="m-zhblogadminpostgis-install-check"><a href="/zh/blog/admin/postgis-install/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminpostgis-install"><span class="">源码编译安装 PostGIS</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogadminmongo_fdw-install-li">
  <input type="checkbox" id="m-zhblogadminmongo_fdw-install-check"/>
  <label for="m-zhblogadminmongo_fdw-install-check"><a href="/zh/blog/admin/mongo_fdw-install/" title="PostgreSQL MongoFDW安装部署" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogadminmongo_fdw-install"><span class="">MongoFDW安装部署</span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-zhblogkernel-li">
  <input type="checkbox" id="m-zhblogkernel-check" checked/>
  <label for="m-zhblogkernel-check"><a href="/zh/blog/kernel/" class="align-left ps-0  td-sidebar-link td-sidebar-link__section" id="m-zhblogkernel"><i class="fas fa-gears"></i><span class="">PG 内核</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogkernelpg-wal-page-seq-li">
  <input type="checkbox" id="m-zhblogkernelpg-wal-page-seq-check"/>
  <label for="m-zhblogkernelpg-wal-page-seq-check"><a href="/zh/blog/kernel/pg-wal-page-seq/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogkernelpg-wal-page-seq"><span class="">PG先写脏页还是先写WAL？</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogkernelch1-li">
  <input type="checkbox" id="m-zhblogkernelch1-check"/>
  <label for="m-zhblogkernelch1-check"><a href="/zh/blog/kernel/ch1/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogkernelch1"><span class="">第一章 数据库的物理/逻辑结构</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogkernelch2-li">
  <input type="checkbox" id="m-zhblogkernelch2-check"/>
  <label for="m-zhblogkernelch2-check"><a href="/zh/blog/kernel/ch2/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogkernelch2"><span class="">第二章 进程和内存架构</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogkernelch3-li">
  <input type="checkbox" id="m-zhblogkernelch3-check"/>
  <label for="m-zhblogkernelch3-check"><a href="/zh/blog/kernel/ch3/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogkernelch3"><span class="">第三章 查询处理</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogkernelch4-li">
  <input type="checkbox" id="m-zhblogkernelch4-check"/>
  <label for="m-zhblogkernelch4-check"><a href="/zh/blog/kernel/ch4/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogkernelch4"><span class="">第四章 外部数据包装器</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogkernelch5-li">
  <input type="checkbox" id="m-zhblogkernelch5-check"/>
  <label for="m-zhblogkernelch5-check"><a href="/zh/blog/kernel/ch5/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogkernelch5"><span class="">第五章 并发控制</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogkernelch6-li">
  <input type="checkbox" id="m-zhblogkernelch6-check"/>
  <label for="m-zhblogkernelch6-check"><a href="/zh/blog/kernel/ch6/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogkernelch6"><span class="">第六章 垃圾清理过程</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogkernelch7-li">
  <input type="checkbox" id="m-zhblogkernelch7-check"/>
  <label for="m-zhblogkernelch7-check"><a href="/zh/blog/kernel/ch7/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogkernelch7"><span class="">第七章 堆内元组与仅索引扫描</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogkernelch8-li">
  <input type="checkbox" id="m-zhblogkernelch8-check"/>
  <label for="m-zhblogkernelch8-check"><a href="/zh/blog/kernel/ch8/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogkernelch8"><span class="">第八章 缓冲区管理器</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-zhblogkernelch9-li">
  <input type="checkbox" id="m-zhblogkernelch9-check" checked/>
  <label for="m-zhblogkernelch9-check"><a href="/zh/blog/kernel/ch9/" class="align-left ps-0  active td-sidebar-link td-sidebar-link__page" id="m-zhblogkernelch9"><span class="td-sidebar-nav-active-item">第九章 预写式日志</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogkernelch10-li">
  <input type="checkbox" id="m-zhblogkernelch10-check"/>
  <label for="m-zhblogkernelch10-check"><a href="/zh/blog/kernel/ch10/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogkernelch10"><span class="">第十章 基础备份与时间点恢复</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogkernelch11-li">
  <input type="checkbox" id="m-zhblogkernelch11-check"/>
  <label for="m-zhblogkernelch11-check"><a href="/zh/blog/kernel/ch11/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogkernelch11"><span class="">第十一章 流复制</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogkernelwal-and-checkpoint-li">
  <input type="checkbox" id="m-zhblogkernelwal-and-checkpoint-check"/>
  <label for="m-zhblogkernelwal-and-checkpoint-check"><a href="/zh/blog/kernel/wal-and-checkpoint/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogkernelwal-and-checkpoint"><span class="">WAL与检查点概述</span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-zhblogreleases-li">
  <input type="checkbox" id="m-zhblogreleases-check"/>
  <label for="m-zhblogreleases-check"><a href="/zh/blog/releases/" class="align-left ps-0  td-sidebar-link td-sidebar-link__section" id="m-zhblogreleases"><i class="fas fa-newspaper"></i><span class="">版本发布</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv320-li">
  <input type="checkbox" id="m-zhblogreleasesv320-check"/>
  <label for="m-zhblogreleasesv320-check"><a href="/zh/blog/releases/v3.2.0/" title="v3.2：命令行工具pig，完备的ARM扩展仓库，Supabase &amp; Grafana 加强" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv320"><span class="">v3.2：Pig CLI, ARM EXT</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv310-li">
  <input type="checkbox" id="m-zhblogreleasesv310-check"/>
  <label for="m-zhblogreleasesv310-check"><a href="/zh/blog/releases/v3.1.0/" title="v3.1：Supabase一键自建，PG17上位，ARM与Ubuntu24支持，MinIO改进" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv310"><span class="">v3.1：ARM, PG17 &amp; Supabase</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv300-li">
  <input type="checkbox" id="m-zhblogreleasesv300-check"/>
  <label for="m-zhblogreleasesv300-check"><a href="/zh/blog/releases/v3.0.0/" title="v3.0：海量扩展，插拔内核，RDS服务" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv300"><span class="">v3.0：扩展，服务，与内核</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv270-li">
  <input type="checkbox" id="m-zhblogreleasesv270-check"/>
  <label for="m-zhblogreleasesv270-check"><a href="/zh/blog/releases/v2.7.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv270"><span class="">v2.7：集异璧之大成</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv260-li">
  <input type="checkbox" id="m-zhblogreleasesv260-check"/>
  <label for="m-zhblogreleasesv260-check"><a href="/zh/blog/releases/v2.6.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv260"><span class="">v2.6：PG 踢馆 OLAP</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv250-li">
  <input type="checkbox" id="m-zhblogreleasesv250-check"/>
  <label for="m-zhblogreleasesv250-check"><a href="/zh/blog/releases/v2.5.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv250"><span class="">v2.5：Ubuntu &amp; PG16</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv240-li">
  <input type="checkbox" id="m-zhblogreleasesv240-check"/>
  <label for="m-zhblogreleasesv240-check"><a href="/zh/blog/releases/v2.4.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv240"><span class="">v2.4：监控云数据库</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv230-li">
  <input type="checkbox" id="m-zhblogreleasesv230-check"/>
  <label for="m-zhblogreleasesv230-check"><a href="/zh/blog/releases/v2.3.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv230"><span class="">v2.3：丰富应用生态</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv220-li">
  <input type="checkbox" id="m-zhblogreleasesv220-check"/>
  <label for="m-zhblogreleasesv220-check"><a href="/zh/blog/releases/v2.2.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv220"><span class="">v2.2：监控全面翻新</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv210-li">
  <input type="checkbox" id="m-zhblogreleasesv210-check"/>
  <label for="m-zhblogreleasesv210-check"><a href="/zh/blog/releases/v2.1.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv210"><span class="">v2.1：向量&#43;PG全系支持！</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv200-li">
  <input type="checkbox" id="m-zhblogreleasesv200-check"/>
  <label for="m-zhblogreleasesv200-check"><a href="/zh/blog/releases/v2.0.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv200"><span class="">v2.0：开源RDS PG替代</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv150-li">
  <input type="checkbox" id="m-zhblogreleasesv150-check"/>
  <label for="m-zhblogreleasesv150-check"><a href="/zh/blog/releases/v1.5.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv150"><span class="">v1.5.0 发布注记</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv140-li">
  <input type="checkbox" id="m-zhblogreleasesv140-check"/>
  <label for="m-zhblogreleasesv140-check"><a href="/zh/blog/releases/v1.4.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv140"><span class="">v1.4.0 发布注记</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv130-li">
  <input type="checkbox" id="m-zhblogreleasesv130-check"/>
  <label for="m-zhblogreleasesv130-check"><a href="/zh/blog/releases/v1.3.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv130"><span class="">v1.3.0 发布注记</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv120-li">
  <input type="checkbox" id="m-zhblogreleasesv120-check"/>
  <label for="m-zhblogreleasesv120-check"><a href="/zh/blog/releases/v1.2.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv120"><span class="">v1.2.0 发布注记</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv110-li">
  <input type="checkbox" id="m-zhblogreleasesv110-check"/>
  <label for="m-zhblogreleasesv110-check"><a href="/zh/blog/releases/v1.1.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv110"><span class="">v1.1.0 发布注记</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv100-li">
  <input type="checkbox" id="m-zhblogreleasesv100-check"/>
  <label for="m-zhblogreleasesv100-check"><a href="/zh/blog/releases/v1.0.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv100"><span class="">v1.0.0 发布注记</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv090-li">
  <input type="checkbox" id="m-zhblogreleasesv090-check"/>
  <label for="m-zhblogreleasesv090-check"><a href="/zh/blog/releases/v0.9.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv090"><span class="">v0.9.0 发布注记</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv080-li">
  <input type="checkbox" id="m-zhblogreleasesv080-check"/>
  <label for="m-zhblogreleasesv080-check"><a href="/zh/blog/releases/v0.8.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv080"><span class="">v0.8.0 发布注记</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv070-li">
  <input type="checkbox" id="m-zhblogreleasesv070-check"/>
  <label for="m-zhblogreleasesv070-check"><a href="/zh/blog/releases/v0.7.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv070"><span class="">v0.7.0 发布注记</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv060-li">
  <input type="checkbox" id="m-zhblogreleasesv060-check"/>
  <label for="m-zhblogreleasesv060-check"><a href="/zh/blog/releases/v0.6.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv060"><span class="">v0.6.0 发布注记</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv050-li">
  <input type="checkbox" id="m-zhblogreleasesv050-check"/>
  <label for="m-zhblogreleasesv050-check"><a href="/zh/blog/releases/v0.5.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv050"><span class="">v0.5.0 发布注记</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv040-li">
  <input type="checkbox" id="m-zhblogreleasesv040-check"/>
  <label for="m-zhblogreleasesv040-check"><a href="/zh/blog/releases/v0.4.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv040"><span class="">v0.4.0 发布注记</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-zhblogreleasesv030-li">
  <input type="checkbox" id="m-zhblogreleasesv030-check"/>
  <label for="m-zhblogreleasesv030-check"><a href="/zh/blog/releases/v0.3.0/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-zhblogreleasesv030"><span class="">v0.3.0 发布注记</span></a></label>
  
</li>
  </ul>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            <div class="td-page-meta ms-2 pb-1 pt-2 mb-0">
<a href="https://github.com/Vonng/pigsty.cc/tree/main/content/zh/blog/kernel/ch9.md" class="td-page-meta--view td-page-meta__view" target="_blank" rel="noopener"><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
  <a href="https://github.com/Vonng/pigsty.cc/edit/main/content/zh/blog/kernel/ch9.md" class="td-page-meta--edit td-page-meta__edit" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
  <a href="https://github.com/Vonng/pigsty.cc/new/main/content/zh/blog/kernel?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child td-page-meta__child" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
  <a href="https://github.com/Vonng/pigsty.cc/issues/new?title=%e7%ac%ac%e4%b9%9d%e7%ab%a0%20%e9%a2%84%e5%86%99%e5%bc%8f%e6%97%a5%e5%bf%97" class="td-page-meta--issue td-page-meta__issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
  <a href="https://github.com/Vonng/pigsty/issues/new" class="td-page-meta--project td-page-meta__project-issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create project issue</a>
  <a id="print" href="/zh/blog/kernel/_print/"><i class="fa-solid fa-print fa-fw"></i> Print entire section</a>

</div>

            <div class="td-toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#91-概述">9.1 概述</a>
      <ul>
        <li><a href="#911-没有wal的插入操作">9.1.1 没有WAL的插入操作</a></li>
        <li><a href="#912-插入操作与数据库恢复">9.1.2 插入操作与数据库恢复</a></li>
        <li><a href="#913-整页写入">9.1.3 整页写入</a></li>
      </ul>
    </li>
    <li><a href="#92-事务日志与wal段文件">9.2 事务日志与WAL段文件</a>
      <ul>
        <li><a href="#wal段文件尺寸">WAL段文件尺寸</a></li>
        <li><a href="#时间线标识">时间线标识</a></li>
        <li><a href="#wal文件名">WAL文件名</a></li>
      </ul>
    </li>
    <li><a href="#93-wal段文件的内部布局">9.3 WAL段文件的内部布局</a></li>
    <li><a href="#94-wal记录的内部布局">9.4 WAL记录的内部布局</a>
      <ul>
        <li><a href="#941-wal记录首部部分">9.4.1 WAL记录首部部分</a></li>
        <li><a href="#942-xlog记录数据部分94及以前">9.4.2 XLOG记录数据部分（9.4及以前）</a></li>
        <li><a href="#943-xlog记录数据部分95及后续版本">9.4.3 XLOG记录数据部分（9.5及后续版本）</a></li>
      </ul>
    </li>
    <li><a href="#95-wal记录的写入">9.5 WAL记录的写入</a></li>
    <li><a href="#96-wal写入进程">9.6 WAL写入进程</a></li>
    <li><a href="#97-postgresql中的检查点过程">9.7 PostgreSQL中的检查点过程</a>
      <ul>
        <li><a href="#971-检查点过程概述">9.7.1 检查点过程概述</a></li>
        <li><a href="#972-pg_crontrol文件">9.7.2 <code>pg_crontrol</code>文件</a></li>
        <li><a href="#postgresql11中移除了前任检查点">PostgreSQL11中移除了前任检查点</a></li>
      </ul>
    </li>
    <li><a href="#98-postgresql中的数据库恢复">9.8 PostgreSQL中的数据库恢复</a></li>
    <li><a href="#99-wal段文件管理">9.9 WAL段文件管理</a>
      <ul>
        <li><a href="#991-wal段切换">9.9.1 WAL段切换</a></li>
        <li><a href="#992-wal段管理95版及以后">9.9.2 WAL段管理（9.5版及以后）</a></li>
        <li><a href="#993-wal段管理94版及以前">9.9.3 WAL段管理（9.4版及以前）</a></li>
      </ul>
    </li>
    <li><a href="#910-归档日志与持续归档">9.10 归档日志与持续归档</a></li>
  </ul>
</nav>
      </div>
    
            <div class="taxonomy taxonomy-terms-cloud taxo-module">
      <h5 class="taxonomy-title">Modules</h5>
      <ul class="taxonomy-terms">
        <li><a class="taxonomy-term" href="/zh/module/app/" data-taxonomy-term="app"><span class="taxonomy-label">APP</span><span class="taxonomy-count">9</span></a></li>
        <li><a class="taxonomy-term" href="/zh/module/blog/" data-taxonomy-term="blog"><span class="taxonomy-label">BLOG</span><span class="taxonomy-count">8</span></a></li>
        <li><a class="taxonomy-term" href="/zh/module/docker/" data-taxonomy-term="docker"><span class="taxonomy-label">DOCKER</span><span class="taxonomy-count">8</span></a></li>
        <li><a class="taxonomy-term" href="/zh/module/etcd/" data-taxonomy-term="etcd"><span class="taxonomy-label">ETCD</span><span class="taxonomy-count">8</span></a></li>
        <li><a class="taxonomy-term" href="/zh/module/infra/" data-taxonomy-term="infra"><span class="taxonomy-label">INFRA</span><span class="taxonomy-count">9</span></a></li>
        <li><a class="taxonomy-term" href="/zh/module/jupyter/" data-taxonomy-term="jupyter"><span class="taxonomy-label">JUPYTER</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/module/kafka/" data-taxonomy-term="kafka"><span class="taxonomy-label">KAFKA</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/module/minio/" data-taxonomy-term="minio"><span class="taxonomy-label">MINIO</span><span class="taxonomy-count">9</span></a></li>
        <li><a class="taxonomy-term" href="/zh/module/mongo/" data-taxonomy-term="mongo"><span class="taxonomy-label">MONGO</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/module/mysql/" data-taxonomy-term="mysql"><span class="taxonomy-label">MYSQL</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/module/node/" data-taxonomy-term="node"><span class="taxonomy-label">NODE</span><span class="taxonomy-count">4</span></a></li>
        <li><a class="taxonomy-term" href="/zh/module/pgsql/" data-taxonomy-term="pgsql"><span class="taxonomy-label">PGSQL</span><span class="taxonomy-count">64</span></a></li>
        <li><a class="taxonomy-term" href="/zh/module/pigsty/" data-taxonomy-term="pigsty"><span class="taxonomy-label">PIGSTY</span><span class="taxonomy-count">42</span></a></li>
        <li><a class="taxonomy-term" href="/zh/module/redis/" data-taxonomy-term="redis"><span class="taxonomy-label">REDIS</span><span class="taxonomy-count">6</span></a></li>
        <li><a class="taxonomy-term" href="/zh/module/software/" data-taxonomy-term="software"><span class="taxonomy-label">SOFTWARE</span><span class="taxonomy-count">16</span></a></li>
        <li><a class="taxonomy-term" href="/zh/module/tigerbeetle/" data-taxonomy-term="tigerbeetle"><span class="taxonomy-label">TigerBeetle</span><span class="taxonomy-count">4</span></a></li>
        <li><a class="taxonomy-term" href="/zh/module/victoria/" data-taxonomy-term="victoria"><span class="taxonomy-label">VICTORIA</span><span class="taxonomy-count">1</span></a></li>
        </ul>
    </div>
  <div class="taxonomy taxonomy-terms-cloud taxo-categories">
      <h5 class="taxonomy-title">Categories</h5>
      <ul class="taxonomy-terms">
        <li><a class="taxonomy-term" href="/zh/categories/about/" data-taxonomy-term="about"><span class="taxonomy-label">About</span><span class="taxonomy-count">10</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/admin/" data-taxonomy-term="admin"><span class="taxonomy-label">Admin</span><span class="taxonomy-count">26</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/ai/" data-taxonomy-term="ai"><span class="taxonomy-label">AI</span><span class="taxonomy-count">4</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/arch/" data-taxonomy-term="arch"><span class="taxonomy-label">Arch</span><span class="taxonomy-count">3</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/business/" data-taxonomy-term="business"><span class="taxonomy-label">Business</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/concept/" data-taxonomy-term="concept"><span class="taxonomy-label">Concept</span><span class="taxonomy-count">12</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/config/" data-taxonomy-term="config"><span class="taxonomy-label">Config</span><span class="taxonomy-count">26</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/dashboard/" data-taxonomy-term="dashboard"><span class="taxonomy-label">Dashboard</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/database/" data-taxonomy-term="database"><span class="taxonomy-label">Database</span><span class="taxonomy-count">4</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/develop/" data-taxonomy-term="develop"><span class="taxonomy-label">Develop</span><span class="taxonomy-count">11</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/enterprise/" data-taxonomy-term="enterprise"><span class="taxonomy-label">Enterprise</span><span class="taxonomy-count">5</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/extension/" data-taxonomy-term="extension"><span class="taxonomy-label">Extension</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/faq/" data-taxonomy-term="faq"><span class="taxonomy-label">FAQ</span><span class="taxonomy-count">9</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/install/" data-taxonomy-term="install"><span class="taxonomy-label">Install</span><span class="taxonomy-count">3</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/kernel/" data-taxonomy-term="kernel"><span class="taxonomy-label">Kernel</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/metrics/" data-taxonomy-term="metrics"><span class="taxonomy-label">Metrics</span><span class="taxonomy-count">8</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/module/" data-taxonomy-term="module"><span class="taxonomy-label">Module</span><span class="taxonomy-count">16</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/monitor/" data-taxonomy-term="monitor"><span class="taxonomy-label">Monitor</span><span class="taxonomy-count">5</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/overview/" data-taxonomy-term="overview"><span class="taxonomy-label">Overview</span><span class="taxonomy-count">20</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/param/" data-taxonomy-term="param"><span class="taxonomy-label">Param</span><span class="taxonomy-count">5</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/playbook/" data-taxonomy-term="playbook"><span class="taxonomy-label">Playbook</span><span class="taxonomy-count">6</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/postgresql/" data-taxonomy-term="postgresql"><span class="taxonomy-label">PostgreSQL</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/reference/" data-taxonomy-term="reference"><span class="taxonomy-label">Reference</span><span class="taxonomy-count">6</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/release/" data-taxonomy-term="release"><span class="taxonomy-label">Release</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/section/" data-taxonomy-term="section"><span class="taxonomy-label">Section</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/setup/" data-taxonomy-term="setup"><span class="taxonomy-label">Setup</span><span class="taxonomy-count">14</span></a></li>
        <li><a class="taxonomy-term" href="/zh/categories/usage/" data-taxonomy-term="usage"><span class="taxonomy-label">Usage</span><span class="taxonomy-count">2</span></a></li>
        </ul>
    </div>
  <div class="taxonomy taxonomy-terms-cloud taxo-tags">
      <h5 class="taxonomy-title">Tags</h5>
      <ul class="taxonomy-terms">
        <li><a class="taxonomy-term" href="/zh/tags/1-node/" data-taxonomy-term="1-node"><span class="taxonomy-label">1-Node</span><span class="taxonomy-count">6</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/2-node/" data-taxonomy-term="2-node"><span class="taxonomy-label">2-Node</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/3-node/" data-taxonomy-term="3-node"><span class="taxonomy-label">3-Node</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/4-node/" data-taxonomy-term="4-node"><span class="taxonomy-label">4-Node</span><span class="taxonomy-count">6</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/5-node/" data-taxonomy-term="5-node"><span class="taxonomy-label">5-Node</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/access/" data-taxonomy-term="access"><span class="taxonomy-label">Access</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/admin/" data-taxonomy-term="admin"><span class="taxonomy-label">Admin</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/auth/" data-taxonomy-term="auth"><span class="taxonomy-label">Auth</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/aws/" data-taxonomy-term="aws"><span class="taxonomy-label">AWS</span><span class="taxonomy-count">4</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/cdc/" data-taxonomy-term="cdc"><span class="taxonomy-label">CDC</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/cdn/" data-taxonomy-term="cdn"><span class="taxonomy-label">CDN</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/citus/" data-taxonomy-term="citus"><span class="taxonomy-label">Citus</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/cloudberry/" data-taxonomy-term="cloudberry"><span class="taxonomy-label">Cloudberry</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/cloudflare/" data-taxonomy-term="cloudflare"><span class="taxonomy-label">Cloudflare</span><span class="taxonomy-count">3</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/cost/" data-taxonomy-term="cost"><span class="taxonomy-label">Cost</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/database/" data-taxonomy-term="database"><span class="taxonomy-label">Database</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/dba/" data-taxonomy-term="dba"><span class="taxonomy-label">DBA</span><span class="taxonomy-count">4</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/dhh/" data-taxonomy-term="dhh"><span class="taxonomy-label">DHH</span><span class="taxonomy-count">3</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/docker/" data-taxonomy-term="docker"><span class="taxonomy-label">Docker</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/ebs/" data-taxonomy-term="ebs"><span class="taxonomy-label">EBS</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/ecs/" data-taxonomy-term="ecs"><span class="taxonomy-label">ECS</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/extension/" data-taxonomy-term="extension"><span class="taxonomy-label">Extension</span><span class="taxonomy-count">24</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/failure/" data-taxonomy-term="failure"><span class="taxonomy-label">Failure</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/finops/" data-taxonomy-term="finops"><span class="taxonomy-label">FinOps</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/gin/" data-taxonomy-term="gin"><span class="taxonomy-label">GIN</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/gis/" data-taxonomy-term="gis"><span class="taxonomy-label">GIS</span><span class="taxonomy-count">3</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/go/" data-taxonomy-term="go"><span class="taxonomy-label">Go</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/greenplum/" data-taxonomy-term="greenplum"><span class="taxonomy-label">Greenplum</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/hba/" data-taxonomy-term="hba"><span class="taxonomy-label">HBA</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/kernel/" data-taxonomy-term="kernel"><span class="taxonomy-label">Kernel</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/knn/" data-taxonomy-term="knn"><span class="taxonomy-label">KNN</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/kubernetes/" data-taxonomy-term="kubernetes"><span class="taxonomy-label">Kubernetes</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/linux/" data-taxonomy-term="linux"><span class="taxonomy-label">Linux</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/migration/" data-taxonomy-term="migration"><span class="taxonomy-label">Migration</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/mongodb/" data-taxonomy-term="mongodb"><span class="taxonomy-label">MongoDB</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/mssql/" data-taxonomy-term="mssql"><span class="taxonomy-label">MSSQL</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/mysql/" data-taxonomy-term="mysql"><span class="taxonomy-label">MySQL</span><span class="taxonomy-count">6</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/neon/" data-taxonomy-term="neon"><span class="taxonomy-label">Neon</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/offline/" data-taxonomy-term="offline"><span class="taxonomy-label">Offline</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/oracle/" data-taxonomy-term="oracle"><span class="taxonomy-label">Oracle</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/os/" data-taxonomy-term="os"><span class="taxonomy-label">OS</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/pg%E5%86%85%E6%A0%B8/" data-taxonomy-term="pg%E5%86%85%E6%A0%B8"><span class="taxonomy-label">PG内核</span><span class="taxonomy-count">14</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/pg%E5%BC%80%E5%8F%91/" data-taxonomy-term="pg%E5%BC%80%E5%8F%91"><span class="taxonomy-label">PG开发</span><span class="taxonomy-count">20</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/pg%E7%94%9F%E6%80%81/" data-taxonomy-term="pg%E7%94%9F%E6%80%81"><span class="taxonomy-label">PG生态</span><span class="taxonomy-count">19</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/pg%E7%AE%A1%E7%90%86/" data-taxonomy-term="pg%E7%AE%A1%E7%90%86"><span class="taxonomy-label">PG管理</span><span class="taxonomy-count">40</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/pigsty/" data-taxonomy-term="pigsty"><span class="taxonomy-label">Pigsty</span><span class="taxonomy-count">25</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/pigstyapp/" data-taxonomy-term="pigstyapp"><span class="taxonomy-label">PigstyApp</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/pitr/" data-taxonomy-term="pitr"><span class="taxonomy-label">PITR</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/polardb/" data-taxonomy-term="polardb"><span class="taxonomy-label">PolarDB</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/postgresql/" data-taxonomy-term="postgresql"><span class="taxonomy-label">PostgreSQL</span><span class="taxonomy-count">104</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/provision/" data-taxonomy-term="provision"><span class="taxonomy-label">Provision</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/rds/" data-taxonomy-term="rds"><span class="taxonomy-label">RDS</span><span class="taxonomy-count">8</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/redis/" data-taxonomy-term="redis"><span class="taxonomy-label">Redis</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/release/" data-taxonomy-term="release"><span class="taxonomy-label">Release</span><span class="taxonomy-count">24</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/rpm/" data-taxonomy-term="rpm"><span class="taxonomy-label">RPM</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/s3/" data-taxonomy-term="s3"><span class="taxonomy-label">S3</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/security/" data-taxonomy-term="security"><span class="taxonomy-label">Security</span><span class="taxonomy-count">4</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/service/" data-taxonomy-term="service"><span class="taxonomy-label">Service</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/sla/" data-taxonomy-term="sla"><span class="taxonomy-label">SLA</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/slim/" data-taxonomy-term="slim"><span class="taxonomy-label">Slim</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/sop/" data-taxonomy-term="sop"><span class="taxonomy-label">SOP</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/sponsor/" data-taxonomy-term="sponsor"><span class="taxonomy-label">Sponsor</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/sql/" data-taxonomy-term="sql"><span class="taxonomy-label">SQL</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/user/" data-taxonomy-term="user"><span class="taxonomy-label">User</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/visualization/" data-taxonomy-term="visualization"><span class="taxonomy-label">Visualization</span><span class="taxonomy-count">8</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/wal/" data-taxonomy-term="wal"><span class="taxonomy-label">WAL</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E4%B8%8B%E4%BA%91/" data-taxonomy-term="%E4%B8%8B%E4%BA%91"><span class="taxonomy-label">下云</span><span class="taxonomy-count">35</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E4%BA%91%E6%95%85%E9%9A%9C/" data-taxonomy-term="%E4%BA%91%E6%95%85%E9%9A%9C"><span class="taxonomy-label">云故障</span><span class="taxonomy-count">5</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/" data-taxonomy-term="%E4%BA%91%E8%AE%A1%E7%AE%97"><span class="taxonomy-label">云计算</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2/" data-taxonomy-term="%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="taxonomy-label">全文检索</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E5%87%BD%E6%95%B0/" data-taxonomy-term="%E5%87%BD%E6%95%B0"><span class="taxonomy-label">函数</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" data-taxonomy-term="%E5%88%86%E5%B8%83%E5%BC%8F"><span class="taxonomy-label">分布式</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E5%90%91%E9%87%8F/" data-taxonomy-term="%E5%90%91%E9%87%8F"><span class="taxonomy-label">向量</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93/" data-taxonomy-term="%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="taxonomy-label">向量数据库</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E5%95%86%E4%B8%9A/" data-taxonomy-term="%E5%95%86%E4%B8%9A"><span class="taxonomy-label">商业</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E5%9B%BD%E4%BA%A7%E6%95%B0%E6%8D%AE%E5%BA%93/" data-taxonomy-term="%E5%9B%BD%E4%BA%A7%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="taxonomy-label">国产数据库</span><span class="taxonomy-count">4</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E5%A4%87%E4%BB%BD/" data-taxonomy-term="%E5%A4%87%E4%BB%BD"><span class="taxonomy-label">备份</span><span class="taxonomy-count">3</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E5%B7%A5%E5%85%B7/" data-taxonomy-term="%E5%B7%A5%E5%85%B7"><span class="taxonomy-label">工具</span><span class="taxonomy-count">5</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E5%BC%80%E6%BA%90/" data-taxonomy-term="%E5%BC%80%E6%BA%90"><span class="taxonomy-label">开源</span><span class="taxonomy-count">7</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E6%80%A7%E8%83%BD/" data-taxonomy-term="%E6%80%A7%E8%83%BD"><span class="taxonomy-label">性能</span><span class="taxonomy-count">6</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E6%89%A9%E5%B1%95/" data-taxonomy-term="%E6%89%A9%E5%B1%95"><span class="taxonomy-label">扩展</span><span class="taxonomy-count">13</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E6%8C%87%E6%A0%87/" data-taxonomy-term="%E6%8C%87%E6%A0%87"><span class="taxonomy-label">指标</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/" data-taxonomy-term="%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F"><span class="taxonomy-label">推荐系统</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" data-taxonomy-term="%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F"><span class="taxonomy-label">操作系统</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E6%95%85%E9%9A%9C/" data-taxonomy-term="%E6%95%85%E9%9A%9C"><span class="taxonomy-label">故障</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E6%95%85%E9%9A%9C%E6%A1%A3%E6%A1%88/" data-taxonomy-term="%E6%95%85%E9%9A%9C%E6%A1%A3%E6%A1%88"><span class="taxonomy-label">故障档案</span><span class="taxonomy-count">8</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" data-taxonomy-term="%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="taxonomy-label">数据库</span><span class="taxonomy-count">32</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E6%95%B0%E6%8D%AE%E6%8D%9F%E5%9D%8F/" data-taxonomy-term="%E6%95%B0%E6%8D%AE%E6%8D%9F%E5%9D%8F"><span class="taxonomy-label">数据损坏</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E6%97%A5%E5%BF%97/" data-taxonomy-term="%E6%97%A5%E5%BF%97"><span class="taxonomy-label">日志</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E6%9E%B6%E6%9E%84/" data-taxonomy-term="%E6%9E%B6%E6%9E%84"><span class="taxonomy-label">架构</span><span class="taxonomy-count">3</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E6%BC%8F%E6%B4%9E/" data-taxonomy-term="%E6%BC%8F%E6%B4%9E"><span class="taxonomy-label">漏洞</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E7%9B%91%E6%8E%A7/" data-taxonomy-term="%E7%9B%91%E6%8E%A7"><span class="taxonomy-label">监控</span><span class="taxonomy-count">3</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E7%A1%AC%E4%BB%B6/" data-taxonomy-term="%E7%A1%AC%E4%BB%B6"><span class="taxonomy-label">硬件</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E7%BC%96%E7%A0%81/" data-taxonomy-term="%E7%BC%96%E7%A0%81"><span class="taxonomy-label">编码</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E8%85%BE%E8%AE%AF%E4%BA%91/" data-taxonomy-term="%E8%85%BE%E8%AE%AF%E4%BA%91"><span class="taxonomy-label">腾讯云</span><span class="taxonomy-count">3</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E8%A7%84%E7%BA%A6/" data-taxonomy-term="%E8%A7%84%E7%BA%A6"><span class="taxonomy-label">规约</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E8%A7%A6%E5%8F%91%E5%99%A8/" data-taxonomy-term="%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="taxonomy-label">触发器</span><span class="taxonomy-count">3</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E8%BF%81%E7%A7%BB/" data-taxonomy-term="%E8%BF%81%E7%A7%BB"><span class="taxonomy-label">迁移</span><span class="taxonomy-count">2</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E8%BF%9E%E6%8E%A5%E6%B1%A0/" data-taxonomy-term="%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="taxonomy-label">连接池</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E9%94%81/" data-taxonomy-term="%E9%94%81"><span class="taxonomy-label">锁</span><span class="taxonomy-count">1</span></a></li>
        <li><a class="taxonomy-term" href="/zh/tags/%E9%98%BF%E9%87%8C%E4%BA%91/" data-taxonomy-term="%E9%98%BF%E9%87%8C%E4%BA%91"><span class="taxonomy-label">阿里云</span><span class="taxonomy-count">7</span></a></li>
        </ul>
    </div>
  
	
          </aside>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role="main">
            <a class="td-rss-button" title="RSS" href="/zh/blog/kernel/index.xml" target="_blank" rel="noopener">
              <i class="fa-solid fa-rss" aria-hidden="true"></i>
            </a>
            
<div class="td-content">
	<h1>第九章 预写式日志</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://www.interdb.jp/pg/">Hironobu SUZUKI</a> ，译者：<a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
		<time datetime="2018-01-03" class="text-muted">2018年01月03日</time>
	</div>
	<header class="article-meta">
		<div class="taxonomy taxonomy-terms-article taxo-tags">
  <h5 class="taxonomy-title">Tags:</h5>
  <ul class="taxonomy-terms">
    <li><a class="taxonomy-term" href="/zh/tags/postgresql/" data-taxonomy-term="postgresql"><span class="taxonomy-label">PostgreSQL</span></a></li>
    <li><a class="taxonomy-term" href="/zh/tags/pg%E5%86%85%E6%A0%B8/" data-taxonomy-term="pg%E5%86%85%E6%A0%B8"><span class="taxonomy-label">PG内核</span></a></li>
    </ul>
</div>

  </header>
	<p>事务日志（<strong>transaction log</strong>）是数据库的关键组件，因为当出现系统故障时，任何数据库管理系统都不允许丢失数据。事务日志是数据库系统中所有**变更（change）<strong>与</strong>行为（action）**的历史记录，当诸如电源故障，或其他服务器错误导致服务器崩溃时，它被用于确保数据不会丢失。由于日志包含每个已执行事务的相关充分信息，因此当服务器崩溃时，数据库服务器应能通过重放事务日志中的变更与行为来恢复数据库集群。</p>
<p>在计算机科学领域，WAL是<strong>Write Ahead Logging</strong>的缩写，它指的是将<strong>变更与行为写入事务日志的协议或规则</strong>；而在PostgreSQL中，WAL是<strong>Write Ahead Log</strong>的缩写。在这里它被当成事务日志的同义词，而且也用来指代一种将<strong>行为</strong>写入事务日志（WAL）的实现机制。虽然有些令人困惑， 但本文将使用PostgreSQL中的定义。</p>
<p>WAL机制在7.1版本中首次被实现，用以减轻服务器崩溃的影响。它还是**时间点恢复（Point-in-Time Recovery PIRT）<strong>与</strong>流复制（Streaming Replication, SR）**实现的基础，这两者将分别在<a href="/zh/blog/kernel/ch10/">第10章</a>和<a href="/zh/blog/kernel/ch11/">第11章</a>中介绍。</p>
<p>尽管理解WAL机制对于管理、集成PostgreSQL非常重要，但由于它的复杂性，不可能做到简要介绍。因此本章将会对WAL做一个完整的解释。第一节描绘了WAL的全貌，介绍了一些重要的概念与关键词。接下来的小节中会依次讲述其他主题：</p>
<ul>
<li>事务日志（WAL）的逻辑结构与物理结构</li>
<li>WAL数据的内部布局</li>
<li>WAL数据的写入</li>
<li>WAL写入者进程</li>
<li>检查点过程</li>
<li>数据库恢复流程</li>
<li>管理WAL段文件</li>
<li>持续归档</li>
</ul>
<h2 id="91-概述">9.1 概述</h2>
<p>让我们先来概述一下WAL机制。为了阐明WAL要解决的问题，第一部分展示了如果PostgreSQL在没有实现WAL时崩溃会发生什么。第二部分介绍了一些关键概念，并概览了本章中的一些关键主题。最后一部分总结了WAL概述部分，并引出了一个更为重要的概念。</p>
<h3 id="911-没有wal的插入操作">9.1.1 没有WAL的插入操作</h3>
<p>正如在<a href="/zh/blog/kernel/ch8/">第八章</a>中讨论的那样，为了能高效访问关系表的页面，几乎所有的DBMS都实现了共享缓冲池。</p>
<p>假设有这样一个没有实现WAL机制的PostgreSQL，现在向表A中插入一些数据元组，如图9.1所示。</p>
<p><strong>图9.1 没有WAL的插入操作</strong></p>
<p><img alt="图9.1 没有WAL的插入操作" src="/img/blog/kernel/fig-9-01.png"></p>
<ol>
<li>发起第一条<code>INSERT</code>语句时，PostgreSQL从数据库集簇文件中加载表A的页面到内存中的共享缓冲池。然后向页面中插入一条元组。页面并没有立刻写回到数据库集簇文件中。正如<a href="/zh/blog/kernel/ch8/">第8章</a>中提到的，被修改过的页面通常称为<strong>脏页（dirty page）</strong></li>
<li>发起第二条<code>INSERT</code>语句时，PostgreSQL直接向缓冲池里的页面内添加了一条新元组。这一页仍然没有被写回到持久存储中。</li>
<li>如果操作系统或PostgreSQL服务器因为各种原因失效（例如电源故障），所有插入的数据都会丢失。</li>
</ol>
<p>因此没有WAL的数据库在系统崩溃时是很脆弱的。</p>
<h3 id="912-插入操作与数据库恢复">9.1.2 插入操作与数据库恢复</h3>
<p>为了解决上述系统失效问题，同时又不招致性能损失，PostgreSQL支持了WAL。这一部分介绍了一些关键词和概念，以及WAL数据的写入和数据库系统的恢复。</p>
<p>为了应对系统失效，PostgreSQL将所有修改作为历史数据写入持久化存储中。这份历史数据称为<strong>XLOG记录（xlog record）<strong>或</strong>WAL数据（wal data）</strong>。</p>
<p>当插入、删除、提交等变更动作发生时，PostgreSQL会将XLOG记录写入内存中的<strong>WAL缓冲区（WAL Buffer）</strong>。当事务提交或中止时，它们会被立即写入持久存储上的**WAL段文件（WAL segment file）<strong>中（更精确来讲，其他场景也可能会有XLOG记录写入，细节将在9.5节中描述）。XLOG记录的</strong>日志序列号（Log Sequence Number, LSN）**标识了该记录在事务日志中的位置，记录的LSN被用作XLOG记录的唯一标识符。</p>
<p>顺便一提，当我们考虑数据库系统如何恢复时，可能会想到一个问题：PostgreSQL是从哪一点开始恢复的？答案是<strong>重做点（REDO Point）</strong>，即最新一个<strong>检查点（Checkpoint）<strong>开始时</strong>XLOG记录</strong>写入的位置。（PostgreSQL中的检查点将在9.7节中描述）。实际上，数据库恢复过程与检查点过程紧密相连，两者是不可分割的。</p>
<blockquote>
<p>WAL与检查点过程在7.1版本中同时实现</p>
</blockquote>
<p>介绍完了主要的关键词与概念，现在来说一下带有WAL时的元组插入操作。如图9.2所示：</p>
<p><strong>图9.2 带有WAL的插入操作</strong></p>
<p><img alt="图9.2 带有WAL的插入操作" src="/img/blog/kernel/fig-9-02.png"></p>
<blockquote>
<p>表A的LSN展示的是表A页面中页首部里<code>pd_lsn</code>类型的<code>PageXLogRecPtr</code>字段，与页面的LSN是一回事。</p>
</blockquote>
<ol>
<li>检查点进程是一个后台进程，周期性地执行过程。当检查点进程开始执行检查点时，它会向当前WAL段文件写入一条XLOG记录，称为<strong>检查点（Checkpoint Record）</strong>。这条记录包含了最新的<strong>重做点</strong>位置。</li>
<li>发起第一条<code>INSERT</code>语句时，PostgreSQL从数据库集簇文件中加载表A的页面至内存中的共享缓冲池，向页面中插入一条元组，然后在<code>LSN_1</code>位置创建并写入一条相应的XLOG记录，然后将表A的LSN从<code>LSN_0</code>更新为<code>LSN_1</code>。在本例中，XLOG记录是由首部数据与<strong>完整元组</strong>组成的一对值。</li>
<li>当该事务提交时，PostgreSQL向WAL缓冲区创建并写入一条关于该提交行为的XLOG记录，然后将WAL缓冲区中的所有XLOG记录刷写入WAL段文件中。</li>
<li>发起第二条<code>INSERT</code>语句时，PostgreSQL向页面中插入一条新元组，然后在<code>LSN_2</code>位置创建并写入一条相应的XLOG记录，然后将表A的LSN从<code>LSN_1</code>更新为<code>LSN_2</code>。</li>
<li>当这条语句的事务提交时，PostgreSQL执行同步骤3类似的操作。</li>
<li>设想当操作系统失效发生时，尽管共享缓冲区中的所有数据都丢失了，但所有页面修改已经作为历史记录被写入WAL段文件中。</li>
</ol>
<p>接下来的步骤展示了如何将数据库集簇恢复到崩溃时刻前的状态。不需要任何特殊的操作，重启PostgreSQL时会自动进入恢复模式，如图9.3所示。PostgreSQL会从<strong>重做点</strong>开始，依序读取正确的WAL段文件并重放XLOG记录。</p>
<p><strong>图9.3 使用WAL进行数据库恢复</strong></p>
<p><img alt="图9.3 使用WAL进行数据库恢复" src="/img/blog/kernel/fig-9-03.png"></p>
<ol>
<li>PostgreSQL从相关的WAL段文件中读取第一条<code>INSERT</code>语句的XLOG记录，并从硬盘上的数据库集簇目录加载表A的页面到内存中的共享缓冲区中。</li>
<li>在重放XLOG记录前，PostgreSQL会比较XLOG记录的LSN与相应页面的LSN。这么做的原因在第9.8节中描述。重放XLOG记录的规则如下所示：
<ul>
<li>如果XLOG记录的LSN要比页面LSN大，XLOG记录中的数据部分就会被插入到页面中，并将页面的LSN更新为XLOG记录的LSN。</li>
<li>如果XLOG记录的LSN要比页面的LSN小，那么不用做任何事情，直接读取后续的WAL数据即可。</li>
</ul>
</li>
<li>PostgreSQL按照同样的方式重放其余的XLOG记录。</li>
</ol>
<p>PostgreSQL可以通过按时间顺序重放写在WAL段文件中的XLOG记录来自我恢复，因此，PostgreSQL的XLOG记录显然是一种<strong>重做日志（REDO log）</strong>。</p>
<blockquote>
<p>PostgreSQL不支持<strong>撤销日志（UNDO log）</strong></p>
</blockquote>
<p>尽管写XLOG记录肯定有一定的代价，这些代价和全页写入相比微不足道。所付出的代价换来了巨大的收益，比如，系统崩溃时的恢复能力。</p>
<h3 id="913-整页写入">9.1.3 整页写入</h3>
<p>假设后台写入进程在写入脏页的过程中出现了操作系统故障，导致磁盘上表A的页面数据损坏。XLOG是无法在损坏的页面上重放的，我们需要其他功能来确保这一点。</p>
<blockquote>
<p>译注：PostgreSQL默认使用8KB的页面，操作系统通常使用4KB的页面，可能出现只写入一个4KB页面的情况。</p>
</blockquote>
<p>PostgreSQL支持诸如<strong>整页写入（full-page write）<strong>的功能来处理这种失效。如果启用，PostgreSQL会在每次检查点之后，在每个页面第一次发生变更时，会将</strong>整个页面</strong>及相应首部作为一条XLOG记录写入。这个功能默认是开启的。在PostgreSQL中，这种包含完整页面的XLOG记录称为<strong>备份区块（backup block）</strong>，或者<strong>整页镜像（full-page image）</strong>。</p>
<p><strong>图9.4 整页写入</strong></p>
<p><img alt="图9.4 整页写入" src="/img/blog/kernel/fig-9-04.png"></p>
<ol>
<li>检查点进程开始进行检查点过程。</li>
<li>在第一条<code>INSERT</code>语句进行插入操作时，PostgreSQL执行的操作几乎同上所述。区别在于这里的XLOG记录是当前页的<strong>备份区块</strong>（即，包含了完整的页面），因为这是自最近一次检查点以来，该页面的第一次写入。</li>
<li>当事务提交时，PostgreSQL的操作同上节所述。</li>
<li>第二条<code>INSERT</code>语句进行插入操作时，PostgreSQL的操作同上所述，这里的XLOG记录就不是备份块了。</li>
<li>当这条语句的事务提交时，PostgreSQL的操作同上节所述。</li>
<li>为了说明整页写入的效果，我们假设后台写入进程在向磁盘写入脏页的过程中出现了操作系统故障，导致磁盘上表A的页面数据损坏。</li>
</ol>
<p>重启PostgreSQL即可修复损坏的集簇，如图9.5所示</p>
<p><strong>图9.5 使用备份区块进行数据库恢复</strong></p>
<p><img alt="图9.5 使用备份区块进行数据库恢复" src="/img/blog/kernel/fig-9-05.png"></p>
<ol>
<li>
<p>PostgreSQL读取第一条<code>INSERT</code>语句的XLOG记录，并从数据库集簇目录加载表A的页面至共享缓冲池中。在本例中，按照整页写入的规则，这条XLOG记录是一个备份区块。</p>
</li>
<li>
<p>当一条XLOG记录是备份区块时，会使用另一条重放规则：XLOG记录的数据部分会直接覆盖当前页面，无视页面或XLOG记录中的LSN，然后将页面的LSN更新为XLOG记录的LSN。</p>
<p>在本例中，PostgreSQL使用记录的数据部分覆写了损坏的页面，并将表A的LSN更新为<code>LSN_1</code>，通过这种方式，损坏的页面通过它自己的备份区块恢复回来了。</p>
</li>
<li>
<p>因为第二条XLOG记录不是备份区块， 因此PostgreSQL的操作同上所述。</p>
</li>
</ol>
<p>即使发生一些数据写入错误，PostgreSQL也能从中恢复。（当然如果发生文件系统或物理介质失效，就不行了）</p>
<h2 id="92-事务日志与wal段文件">9.2 事务日志与WAL段文件</h2>
<p>PostgreSQL在逻辑上将XLOG记录写入事务日志，即，一个长度用8字节表示的虚拟文件（16 EB）。</p>
<p>虽说事务日志的容量实际上应该是无限的，但8字节长度的地址空间已经足够宽广了。目前是不可能处理这个量级的单个文件的。因此PostgreSQL中的事务日志实际上默认被划分为16M大小的一系列文件，这些文件被称作<strong>WAL段（WAL Segment）</strong>。如图9.6所示。</p>
<blockquote>
<h3 id="wal段文件尺寸">WAL段文件尺寸</h3>
<p>从版本11开始，在使用<code>initdb</code>创建数据库时，可以通过<a href="https://www.postgresql.org/docs/11/static/app-initdb.html"><code>--wal-segsize</code></a>选项来配置WAL段文件的大小。</p>
</blockquote>
<p><strong>图9.6 事务日志与WAL段文件</strong></p>
<p><img alt="图9.6 事务日志与WAL段文件" src="/img/blog/kernel/fig-9-06.png"></p>
<p>WAL段文件的文件名是由24个十六进制数字组成的，其命名规则如下：
$$
\begin{align}
\verb|WAL段文件名| = \verb|timelineId| + (\verb|uint32|) \frac{\verb|LSN|-1}{16\verb|M|*256}<br>
+ (\verb|uint32|)\left(\frac{\verb|LSN|-1}{16\verb|M|}\right) % 256
\end{align}
$$</p>
<blockquote>
<h3 id="时间线标识">时间线标识</h3>
<p>PostgreSQL的WAL有<strong>时间线标识（TimelineID，四字节无符号整数）<strong>的概念，用于<a href="/zh/blog/kernel/ch10/">第十章</a>中所述的</strong>时间点恢复（PITR）</strong>。不过在本章中时间线标识将固定为<code>0x00000001</code>，因为接下来的几节里还不需要这个概念。</p>
</blockquote>
<p>第一个WAL段文件名是$00000001\color{blue}{00000000}000000\color{blue}{01}$，如果第一个段被XLOG记录写满了，就会创建第二个段$00000001\color{blue}{00000000}000000\color{blue}{02}$，后续的文件名将使用升序。在$00000001\color{blue}{00000000}000000\color{blue}{FF}$被填满之后，就会使用下一个文件$00000001\color{blue}{00000001}000000\color{blue}{00}$。通过这种方式，每当最后两位数字要进位时，中间8位数字就会加一。与之类似，在$00000001\color{blue}{00000001}000000\color{blue}{FF}$被填满后，就会开始使用$00000001\color{blue}{00000002}000000\color{blue}{00}$，依此类推。</p>
<blockquote>
<h3 id="wal文件名">WAL文件名</h3>
<p>使用内建的函数<code>pg_xlogfile_name</code>（9.6及以前的版本），或<code>pg_walfile_name</code>（10及以后的版本），我们可以找出包含特定LSN的WAL段文件。例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_xlogfile_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;1/00002D3E&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- 9.6-
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- SELECT pg_walfile_name(&#39;1/00002D3E&#39;); -- 10+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000">pg_xlogfile_name</span><span style="color:#f8f8f8;text-decoration:underline">     
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">000000010000000100000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></blockquote>
<h2 id="93-wal段文件的内部布局">9.3 WAL段文件的内部布局</h2>
<p>一个WAL段文件大小默认为16MB，并在内部划分为大小为8192字节（8KB）的页面。第一个页包含了由<code>XLogLongPageHeaderData</code>定义的首部数据，其他的页包含了由<code>XLogPageHeaderData</code>定义的首部数据。每页在首部数据之后，紧接着就是以<strong>降序</strong>写入的XLOG记录，如图9.7所示。</p>
<p><strong>图9.7 WAL段文件内部布局</strong></p>
<p><img alt="图9.7 WAL段文件内部布局" src="/img/blog/kernel/fig-9-07.png"></p>
<p><code>XLogLongPageHeaderData</code>与<code>XLogPageHeaderData</code>结构定义在 <a href="https://github.com/postgres/postgres/blob/master/src/include/access/xlog_internal.h"><code>src/include/access/xlog_internal.h</code></a>中。这两个结构的具体说明就不在此展开了，因为对于后续小节并非必需。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogPageHeaderData</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint16</span>		<span style="color:#000">xlp_magic</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 用于正确性检查的魔数 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint16</span>		<span style="color:#000">xlp_info</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 标记位，详情见下 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TimeLineID</span>	<span style="color:#000">xlp_tli</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 页面中第一条记录的时间线ID */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">XLogRecPtr</span>	<span style="color:#000">xlp_pageaddr</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 当前页的XLOG地址 */</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 当本页放不下一条完整记录时，我们会在下一页继续，xlp_rem_len存储了来自先前页面
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * 记录剩余的字节数。注意xl_rem_len包含了备份区块的数据，也就是说它会在第一个首部跟踪
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * xl_tot_len而不是xl_len。还要注意延续的数据不一定是对齐的。*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint32</span>		<span style="color:#000">xlp_rem_len</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 记录所有剩余数据的长度 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">XLogPageHeaderData</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#000">XLogPageHeaderData</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">XLogPageHeader</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 当设置了XLP_LONG_HEADER标记位时，我们将在页首部中存储额外的字段。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * (通常是在XLOG文件中的第一个页面中) 额外的字段用于确保文件的正确性。 */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogLongPageHeaderData</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">XLogPageHeaderData</span> <span style="color:#000">std</span><span style="color:#000;font-weight:bold">;</span>            <span style="color:#8f5902;font-style:italic">/* 标准首部 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uint64</span>             <span style="color:#000">xlp_sysid</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* 来自pg_control中的系统标识符 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uint32</span>             <span style="color:#000">xlp_seg_size</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* 交叉校验 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uint32</span>             <span style="color:#000">xlp_xlog_blcksz</span><span style="color:#000;font-weight:bold">;</span><span style="color:#8f5902;font-style:italic">/* 交叉校验 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">XLogLongPageHeaderData</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h2 id="94-wal记录的内部布局">9.4 WAL记录的内部布局</h2>
<p>一条XLOG记录由通用的首部部分与特定的数据部分构成。本章第一节描述了首部的结构，剩下两个节分别解释了9.5版本前后数据部分的结构。（9.5版本改变了数据格式）</p>
<h3 id="941-wal记录首部部分">9.4.1 WAL记录首部部分</h3>
<p>所有的XLOG记录都有一个通用的首部，由结构<code>XLogRecord</code>定义。9.5更改了首部的定义，9.4及更早版本的结构定义如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogRecord</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">uint32</span>          <span style="color:#000">xl_tot_len</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* 整条记录的全长 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">TransactionId</span>   <span style="color:#000">xl_xid</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* 事务ID */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">uint32</span>          <span style="color:#000">xl_len</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* 资源管理器的数据长度 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">uint8</span>           <span style="color:#000">xl_info</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* 标记位，如下所示 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">RmgrId</span>          <span style="color:#000">xl_rmid</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* 本记录的资源管理器 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#8f5902;font-style:italic">/* 这里有2字节的填充，初始化为0 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">XLogRecPtr</span>      <span style="color:#000">xl_prev</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* 在日志中指向先前记录的指针 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">pg_crc32</span>        <span style="color:#000">xl_crc</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* 本记录的CRC */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">XLogRecord</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>除了两个变量，大多数变量的意思非常明显，无需多言。<code>xl_rmid</code>与<code>xl_info</code>都是与**资源管理器（resource manager）**相关的变量，它是一些与WAL功能（写入，重放XLOG记录）相关的操作集合。资源管理器的数目随着PostgreSQL不断增加，第10版包括这些：</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">资源管理器</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">堆元组操作</td>
<td style="text-align:left"><code>RM_HEAP</code>, <code>RM_HEAP2</code></td>
</tr>
<tr>
<td style="text-align:left">索引操作</td>
<td style="text-align:left"><code>RM_BTREE</code>, <code>RM_HASH</code>, <code>RM_GIN</code>, <code>RM_GIST</code>, <code>RM_SPGIST</code>, <code>RM_BRIN</code></td>
</tr>
<tr>
<td style="text-align:left">序列号操作</td>
<td style="text-align:left"><code>RM_SEQ</code></td>
</tr>
<tr>
<td style="text-align:left">事务操作</td>
<td style="text-align:left"><code>RM_XACT</code>, <code>RM_MULTIXACT</code>, <code>RM_CLOG</code>, <code>RM_XLOG</code>, <code>RM_COMMIT_TS</code></td>
</tr>
<tr>
<td style="text-align:left">表空间操作</td>
<td style="text-align:left"><code>RM_SMGR</code>, <code>RM_DBASE</code>, <code>RM_TBLSPC</code>, <code>RM_RELMAP</code></td>
</tr>
<tr>
<td style="text-align:left">复制与热备操作</td>
<td style="text-align:left"><code>RM_STANDBY</code>, <code>RM_REPLORIGIN</code>, <code>RM_GENERIC_ID</code>, <code>RM_LOGICALMSG_ID</code></td>
</tr>
</tbody>
</table>
<p>下面是一些有代表性的例子，展示了资源管理器工作方式。</p>
<ul>
<li>如果发起的是<code>INSERT</code>语句，则其相应XLOG记录首部中的变量<code>xl_rmid</code>与<code>xl_info</code>会相应地被设置为<code>RM_HEAP</code>与<code>XLOG_HEAP_INSERT</code>。当恢复数据库集簇时，就会按照<code>xl_info</code>选用资源管理器<code>RM_HEAP</code>的函数<code>heap_xlog_insert()</code>来重放当前XLOG记录。</li>
<li><code>UPDATE</code>语句与之类似，首部变量中的<code>xl_info</code>会被设置为<code>XLOG_HEAP_UPDATE</code>，而在数据库恢复时就会选用资源管理器<code>RM_HEAP</code>的函数<code>heap_xlog_update()</code>进行重放。</li>
<li>当事务提交时，相应XLOG记录首部的变量<code>xl_rmid</code>与<code>xl_info</code>会被相应地设置为<code>RM_XACT</code>与<code>XLOG_XACT_COMMIT</code>。当数据库恢复时，<code>RM_XACT</code>的<code>xact_redo_commit()</code>就会执行本记录的重放。</li>
</ul>
<p>在9.5及之后的版本，首部结构<a href="https://github.com/postgres/postgres/blob/9d4649ca49416111aee2c84b7e4441a0b7aa2fac/src/include/access/xlogrecord.h"><code>XLogRecord</code></a>移除了一个字段<code>xl_len</code>，精简了XLOG记录的格式，省了几个字节。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogRecord</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint32</span>		<span style="color:#000">xl_tot_len</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 整条记录的总长度 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TransactionId</span> <span style="color:#000">xl_xid</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 事物标识 xid */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">XLogRecPtr</span>	<span style="color:#000">xl_prev</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 指向日志中前一条记录的指针 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint8</span>		<span style="color:#000">xl_info</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 标记位，详情见下*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RmgrId</span>		<span style="color:#000">xl_rmid</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 本条记录对应的资源管理器 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 这里有2字节的填充，初始化为0 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pg_crc32c</span>	<span style="color:#000">xl_crc</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 本记录的CRC */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 紧随其后的是XLogRecordBlockHeaders 与 XLogRecordDataHeader ，不带填充 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">XLogRecord</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><blockquote>
<p>9.4版本中的<code>XLogRecord</code>结构定义在<a href="https://github.com/postgres/postgres/blob/REL9_4_STABLE/src/include/access/xlog.h"><code>src/include/access/xlog.h</code></a>中，9.5及以后的定义在<a href="https://github.com/postgres/postgres/blob/master/src/include/access/xlogrecord.h"><code>src/include/access/xlogrecord.h</code></a>。<code>heap_xlog_insert</code>与<code>heap_xlog_update</code>定义在<a href="https://github.com/postgres/postgres/blob/master/src/backend/access/heap/heapam.c"><code>src/backend/access/heap/heapam.c</code></a> ；而函数<code>xact_redo_commit</code>定义在<a href="https://github.com/postgres/postgres/blob/master/src/backend/access/transam/xact.c"><code>src/backend/access/transam/xact.c</code></a>中</p>
</blockquote>
<h3 id="942-xlog记录数据部分94及以前">9.4.2 XLOG记录数据部分（9.4及以前）</h3>
<p>XLOG记录的数据部分可以分为两类：备份区块（完整的页面），或非备份区块（不同的操作相应的数据不同）。</p>
<p><strong>图9.8 XLOG记录的样例（9.4版本或更早）</strong></p>
<p><img src="/img/blog/kernel/fig-9-08.png"></p>
<p>让我们通过几个具体示例来了解XLOG记录的内部布局。</p>
<h4 id="9421-备份区块">9.4.2.1 备份区块</h4>
<p>备份区块如图9.8(a)所示，它由两个数据结构和一个数据对象组成，如下所述：</p>
<ol>
<li>首部部分，<code>XLogRecord</code>结构体</li>
<li><code>BkpBlock</code>结构体</li>
<li>除去空闲空间的完整页面。</li>
</ol>
<p><code>BkpBlock</code>包括了用于在数据库集簇目录中定位该页面的变量（比如，包含该页面的关系表的<code>RelFileNode</code>与<code>ForkNumber</code>，以及文件内的区块号<code>BlockNumber</code>），以及当前页面空闲空间的开始位置与长度。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @include/access/xlog_internal.h
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">BkpBlock</span> 
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">RelFileNode</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 包含该块的关系 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ForkNumber</span>  <span style="color:#000">fork</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 关系的分支(main,vm,fsm,...) */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">BlockNumber</span> <span style="color:#000">block</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* 区块号 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uint16</span>      <span style="color:#000">hole_offset</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* &#34;空洞&#34;前的字节数 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uint16</span>      <span style="color:#000">hole_length</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* &#34;空洞&#34;的长度 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">/* 实际的区块数据紧随该结构体后 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">BkpBlock</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h4 id="9422-非备份区块">9.4.2.2 非备份区块</h4>
<p>在非备份区块中，数据部分的布局依不同操作而异。这里举一个具有代表性的例子：一条<code>INSERT</code>语句的XLOG记录。如图9.8(b)所示，<code>INSERT</code>语句的XLOG记录是由两个数据结构与一个数据对象组成的：</p>
<ol>
<li>首部部分，<code>XLogRecord</code>结构体</li>
<li><code>xl_heap_insert</code>结构体</li>
<li>被插入的元组 —— 更精确地说，是移除了一些字节的元组。</li>
</ol>
<p>结构体<code>xl_heap_insert</code>包含的变量用于在数据库集簇中定位被插入的元组。（即，包含该元组的表的<code>RelFileNode</code>，以及该元组的<code>tid</code>），以及该元组的可见性标记位。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">BlockIdData</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">uint16</span>          <span style="color:#000">bi_hi</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">uint16</span>          <span style="color:#000">bi_lo</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">BlockIdData</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#000">uint16</span> <span style="color:#000">OffsetNumber</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ItemPointerData</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">BlockIdData</span>     <span style="color:#000">ip_blkid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">OffsetNumber</span>    <span style="color:#000">ip_posid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">RelFileNode</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">Oid</span>             <span style="color:#000">spcNode</span><span style="color:#000;font-weight:bold">;</span>             <span style="color:#8f5902;font-style:italic">/* 表空间 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">Oid</span>             <span style="color:#000">dbNode</span><span style="color:#000;font-weight:bold">;</span>              <span style="color:#8f5902;font-style:italic">/* 数据库 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">Oid</span>             <span style="color:#000">relNode</span><span style="color:#000;font-weight:bold">;</span>             <span style="color:#8f5902;font-style:italic">/* 关系 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">RelFileNode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xl_heaptid</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">RelFileNode</span>     <span style="color:#000">node</span><span style="color:#000;font-weight:bold">;</span>				<span style="color:#8f5902;font-style:italic">/* 关系定位符 */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">ItemPointerData</span> <span style="color:#000">tid</span><span style="color:#000;font-weight:bold">;</span>                 <span style="color:#8f5902;font-style:italic">/* 元组在关系中的位置 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">xl_heaptid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xl_heap_insert</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">xl_heaptid</span>      <span style="color:#000">target</span><span style="color:#000;font-weight:bold">;</span>              <span style="color:#8f5902;font-style:italic">/* 被插入的元组ID */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">bool</span>            <span style="color:#000">all_visible_cleared</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* PD_ALL_VISIBLE 是否被清除 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">xl_heap_insert</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><blockquote>
<p>在结构体<code>xl_heap_header</code>的代码注释中解释了移除插入元组中若干字节的原因：</p>
<p>我们并没有在WAL中存储被插入或被更新元组的固定部分（即<code>HeapTupleHeaderData</code>，堆元组首部），我们可以在需要时从WAL中的其它部分重建这几个字段，以此节省一些字节。或者根本就无需重建。</p>
</blockquote>
<p>这里还有一个例子值得一提，如图9.8(c)所示，检查点的XLOG记录相当简单，它由如下所示的两个数据结构组成：</p>
<ol>
<li><code>XLogRecord</code>结构（首部部分）</li>
<li>包含检查点信息的<code>CheckPoint</code>结构体（参见<a href="/zh/blog/kernel/ch9/#9.7">9.7节</a>）</li>
</ol>
<blockquote>
<p><code>xl_heap_header</code>结构定义在<a href="https://github.com/postgres/postgres/blob/master/src/include/access/htup.h"><code>src/include/access/htup.h</code></a>中，而<code>CheckPoint</code>结构体定义在<a href="https://github.com/postgres/postgres/blob/master/src/include/catalog/pg_control.h"><code>src/include/catalog/pg_control.h</code></a>中。</p>
</blockquote>
<h3 id="943-xlog记录数据部分95及后续版本">9.4.3 XLOG记录数据部分（9.5及后续版本）</h3>
<p>在9.4及之前的版本，XLOG记录并没有通用的格式，因此每一种资源管理器都需要定义各自的格式。在这种情况下，维护源代码，以及实现与WAL相关的新功能变得越来越困难。为了解决这个问题，9.5版引入了一种通用的结构化格式，不依赖于特定的资源管理器。</p>
<p>XLOG记录的数据部分可以被划分为两个部分：首部与数据，如图9.9所示：</p>
<p><strong>图9.9 通用XLOG记录格式</strong></p>
<p><img src="/img/blog/kernel/fig-9-09.png"></p>
<p>首部部分包含零个或多个<code>XLogRecordBlockHeaders</code>，以及零个或一个<code>XLogRecordDataHeaderShort</code>（或<code>XLogRecordDataHeaderLong</code>）；它必须至少包含其中一个。当记录存储着整页镜像时（即备份区块），<code>XLogRecordBlockHeader</code>会包含<code>XLogRecordBlockImageHeader</code>，如果启用压缩还会包含<code>XLogRecordBlockCompressHeader</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 追加写入XLOG记录的区块数据首部。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * &#39;data_length&#39;是与本区块关联的，特定于资源管理器的数据荷载长度。它不包括可能会出现
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 的整页镜像的长度，也不会包括XLogRecordBlockHeader结构本身。注意我们并不会对
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * XLogRecordBlockHeader结构做边界对齐！因此在使用前该结构体必须拷贝到对齐的本地存储中。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogRecordBlockHeader</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint8</span>		<span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>				<span style="color:#8f5902;font-style:italic">/* 块引用 ID */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint8</span>		<span style="color:#000">fork_flags</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 关系中的分支，以及标志位 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint16</span>		<span style="color:#000">data_length</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 荷载字节数（不包括页面镜像） */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 如果设置 BKPBLOCK_HAS_IMAGE, 紧接一个XLogRecordBlockImageHeader结构 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 如果未设置 BKPBLOCK_SAME_REL, 紧接着一个RelFileNode结构 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 紧接着区块号码 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">XLogRecordBlockHeader</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 分支标号放在fork_flags的低4位中，高位用于标记位 */</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BKPBLOCK_FORK_MASK	0x0F
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BKPBLOCK_FLAG_MASK	0xF0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BKPBLOCK_HAS_IMAGE	0x10	</span><span style="color:#8f5902;font-style:italic">/* 区块数据是一个XLogRecordBlockImage */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BKPBLOCK_HAS_DATA	0x20
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BKPBLOCK_WILL_INIT	0x40	</span><span style="color:#8f5902;font-style:italic">/* 重做会重新初始化当前页 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define BKPBLOCK_SAME_REL	0x80	</span><span style="color:#8f5902;font-style:italic">/* 忽略RelFileNode，与前一个相同 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* XLogRecordDataHeaderShort/Long 被用于本记录的“主数据”部分。如果数据的长度小于256字节
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 则会使用Short版本的格式，即使用单个字节来保存长度，否则会使用长版本的格式。 */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogRecordDataHeaderShort</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint8</span>		<span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>				<span style="color:#8f5902;font-style:italic">/* XLR_BLOCK_ID_DATA_SHORT */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint8</span>		<span style="color:#000">data_length</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 载荷字节数目 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>			<span style="color:#000">XLogRecordDataHeaderShort</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SizeOfXLogRecordDataHeaderShort (sizeof(uint8) * 2)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogRecordDataHeaderLong</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint8</span>		<span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>				<span style="color:#8f5902;font-style:italic">/* XLR_BLOCK_ID_DATA_LONG */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 紧随其后的是uint32类型的data_length, 未对齐 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>			<span style="color:#000">XLogRecordDataHeaderLong</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 当包含整页镜像时额外的首部信息(即当BKPBLOCK_HAS_IMAGE标记位被设置时)。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * XLOG相关的代码会意识到数据压缩上一个显而易见的情况，即PG里的数据页面通常会在中间包含一个
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 未使用的“空洞”，空洞里面通常只有置零的字节。如果空洞的长度大于0，我们就会从存储的数据中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 移除该“空洞”（且XLOG记录的CRC也不会计算该空洞）。因此区块数据的总量实际上是块大小BLCKSZ
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 减去空洞包含的字节大小。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 当启用 wal_compression 时，一个包含空洞的整页镜像除了移除空洞，还会额外是引用PGLZ压缩
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 算法进行压缩。这能减小WAL日志的体积，但会增加在记录WAL日志过程中的CPU开销。在这种情况下，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 空洞的大小就无法通过块大小-页面镜像大小来计算了。基本上，这需要存储额外的信息。但当没有
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 空洞存在时，我们可以假设空洞大小为0，因此就不需要存储额外信息了。注意，当压缩节约的字节数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 小于额外信息的长度时，WAL里就会存储原始的页面镜像，而不是压缩过的版本。因此当成功进行压缩
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 时，区块数据的总量总是要比（块大小BLCKSZ - 空洞字节数 - 额外信息长度）要更小。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogRecordBlockImageHeader</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint16</span>		<span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span>			<span style="color:#8f5902;font-style:italic">/* 页面镜像的字节数 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint16</span>		<span style="color:#000">hole_offset</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* 空洞前面的字节数 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint8</span>		<span style="color:#000">bimg_info</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 标记位，详情见下 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* 如果 BKPIMAGE_HAS_HOLE 且 BKPIMAGE_IS_COMPRESSED, 后面会跟着
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * XLogRecordBlockCompressHeader 结构体 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">XLogRecordBlockImageHeader</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 当页面镜像含有“空洞”且被压缩时，会用到这里的额外首部信息 */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">XLogRecordBlockCompressHeader</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint16</span>		<span style="color:#000">hole_length</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* number of bytes in &#34;hole&#34; */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">XLogRecordBlockCompressHeader</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>数据部分则由零或多个区块数据与零或一个主数据组成，区块数据与<code>XLogRecordBlockHeader(s)</code>对应，而**主数据（main data）**则与<code>XLogRecordDataHeader</code>对应。</p>
<blockquote>
<h4 id="wal压缩">WAL压缩</h4>
<p>在9.5及其后的版本，可以通过设置<code>wal_compression = enable</code>启用WAL压缩：使用LZ压缩方法对带有整页镜像的XLOG记录进行压缩。在这种情况下，会添加<code>XLogRecordBlockCompressHeader</code>结构。</p>
<p>该功能有两个优点与一个缺点，优点是降低写入记录的I/O开销，并减小WAL段文件的消耗量；缺点是会消耗更多的CPU资源来执行压缩。</p>
</blockquote>
<p><strong>图9.10 XLOG记录样例（9.5及其后的版本）</strong></p>
<p><img src="/img/blog/kernel/fig-9-10.png"></p>
<p>和前一小节一样，这里通过一些特例来描述。</p>
<h4 id="9431-备份区块">9.4.3.1 备份区块</h4>
<p>由<code>INSERT</code>语句创建的备份区块如图9.10(a)所示，它由如下所示的四个数据结构与一个数据对象组成：</p>
<ol>
<li><code>XLogRecord</code>结构 （首部部分）</li>
<li><code>XLogRecordBlockHeader</code>结构，且包含一个<code>XLogRecordBlockImageHeader</code></li>
<li><code>XLogRecordDataHeaderShort</code>结构</li>
<li>一个备份区块（区块数据）</li>
<li><code>xl_heap_insert</code>结构 (主数据)</li>
</ol>
<p><code>XLogRecordBlockHeader</code>包含了用于在数据库集簇中定位区块的变量 (关系节点，分支编号，以及区块号)； <code>XLogRecordImageHeader</code> 包含了当前区块的长度与偏移量（这两个首部结构合起来效果与9.4及先前版本中的<code>BkpBlock</code>结构相同）。</p>
<p><code>XLogRecordDataHeaderShort</code>存储了<code>xl_heap_insert</code>结构的长度，该结构是当前记录的主数据部分（见下）。</p>
<blockquote>
<p>除了某些特例外（例如逻辑解码与<strong>推测插入（speculative insertion）</strong>），包含整页镜像的XLOG记录的<strong>主数据</strong>不会被使用。它们会在记录重放时被忽略，属于冗余数据，未来可能会对其改进。</p>
<p>此外，备份区块记录的主数据与创建它们的语句相关。例如<code>UPDATE</code>语句就会追加写入<code>xl_heap_lock</code>或<code>xl_heap_updated</code>。</p>
</blockquote>
<h4 id="9432-非备份区块">9.4.3.2 非备份区块</h4>
<p>接下来描述由<code>INSERT</code>语句创建的非备份区块，如图9.10(b)所示，它由四个数据结构与一个数据对象组成：</p>
<ol>
<li><code>XLogRecord</code>结构 （首部部分）</li>
<li><code>XLogRecordBlockHeader</code>结构</li>
<li><code>XLogRecordDataHeaderShort</code>结构</li>
<li>一条被插入的元组（更精确地说，一个<code>xl_heap_header</code>结构与完整的插入数据）</li>
<li><code>xl_heap_insert</code>结构 (主数据)</li>
</ol>
<p><code>XLogRecordBlockHeader</code>包含三个值 (关系节点，分支编号，以及区块号)，用以指明该元组被插入到哪个区块中，以及要插入数据部分的长度。<code>XLogRecordDataHeaderShort</code>存储了<code>xl_heap_insert</code>结构的长度，该结构是当前记录的主数据部分。</p>
<p>新版本的<code>xl_heap_insert</code>仅包含两个值：当前元组在区块内的偏移量，以及一个可见性标记。该结构变得十分简单，因为<code>XLogRecordBlockHeader</code>存储了旧版本中该结构体的绝大多数数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 这里是关于该INSERT操作，我们所需要知道的一切 */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xl_heap_insert</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">OffsetNumber</span> <span style="color:#000">offnum</span><span style="color:#000;font-weight:bold">;</span>		<span style="color:#8f5902;font-style:italic">/* 被插入元组的偏移量 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uint8</span>		<span style="color:#000">flags</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/* xl_heap_header &amp; 备份区块0中的元组数据 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">xl_heap_insert</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>最后一个例子，检查点的记录如图9.10(c)所示，它由三个数据结构组成：</p>
<ol>
<li><code>XLogRecord</code>结构体（首部部分）</li>
<li><code>XLogRecordDataHeaderShort</code>结构，包含了主数据的长度。</li>
<li>结构体<code>CheckPoint</code>（主数据）</li>
</ol>
<blockquote>
<p><code>xl_heap_header</code>定义于<a href="https://github.com/postgres/postgres/blob/master/src/include/access/htup.h"><code>src/include/access/htup.h</code></a>中，而<code>CheckPoint</code>结构定义于<a href="https://github.com/postgres/postgres/blob/master/src/include/catalog/pg_control.h"><code>src/include/catalog/pg_control.h</code></a>.</p>
</blockquote>
<p>尽管对我们来说新格式稍显复杂，但它对于资源管理器的解析而言，设计更为合理，而且许多类型的XLOG记录的大小都比先前要小。主要的结构如图9.8和图9.10所示，你可以计算并相互比较这些记录的大小。（新版<code>CheckPoint</code>记录的尺寸要比旧版本大一些，但它也包含了更多的变量）。</p>
<h2 id="95-wal记录的写入">9.5 WAL记录的写入</h2>
<p>完成了热身练习后，现在我们已经做好理解XLOG记录写入过程的准备了。因此在本节中，我将尽可能仔细地描述。首先，以下列语句的执行为例，让我们来看一看PostgreSQL的内幕。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">testdb</span><span style="color:#ce5c00;font-weight:bold">=#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INSERT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">INTO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VALUES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;A&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>通过发出上述语句，内部函数<code>exec_simple_query()</code>会被调用，其伪代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">exec_simple_query</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#a40000">@</span><span style="color:#000">postgres</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ExtendCLOG</span><span style="color:#000;font-weight:bold">()</span>	<span style="color:#a40000">@</span><span style="color:#000">clog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>     <span style="color:#8f5902;font-style:italic">/* 将当前事务的状态&#34;IN_PROGRESS&#34;写入CLOG */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">heap_insert</span><span style="color:#000;font-weight:bold">()</span>	<span style="color:#a40000">@</span><span style="color:#000">heapam</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>	<span style="color:#8f5902;font-style:italic">/* 插入元组，创建一条XLOG记录并调用函XLogInsert. */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#000">XLogInsert</span><span style="color:#000;font-weight:bold">()</span>	<span style="color:#a40000">@</span><span style="color:#000">xlog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span> 	<span style="color:#8f5902;font-style:italic">/* (9.5 以及后续的版本为 xloginsert.c) */</span>
</span></span><span style="display:flex;"><span>								<span style="color:#8f5902;font-style:italic">/* 将插入元组的XLOG记录写入WAL缓冲区，更新页面的 pd_lsn */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">finish_xact_command</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#a40000">@</span><span style="color:#000">postgres</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>	<span style="color:#8f5902;font-style:italic">/* 执行提交 */</span>   
</span></span><span style="display:flex;"><span>      <span style="color:#000">XLogInsert</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#a40000">@</span><span style="color:#000">xlog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>  			<span style="color:#8f5902;font-style:italic">/* (9.5 以及后续的版本为 xloginsert.c) */</span>
</span></span><span style="display:flex;"><span>										<span style="color:#8f5902;font-style:italic">/* 将该提交行为的XLOG记录写入WAL缓冲区 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#000">XLogWrite</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#a40000">@</span><span style="color:#000">xlog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>				<span style="color:#8f5902;font-style:italic">/* 将WAL缓冲区中所有的XLOG刷写入WAL段中 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">TransactionIdCommitTree</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#a40000">@</span><span style="color:#000">transam</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span>	
</span></span><span style="display:flex;"><span>							<span style="color:#8f5902;font-style:italic">/* 在CLOG中将当前事务的状态由&#34;IN_PROGRESS&#34;修改为&#34;COMMITTED&#34; /*
</span></span></span></code></pre></div><p>在接下来的段落中将会解释每一行伪代码，从而理解XLOG记录写入的过程。如图9.11和图9.12所示。</p>
<ol>
<li>函数<code>ExtendCLOG()</code>将当前事务的状态<code>IN_PROGRESS</code>写入内存中的CLOG。</li>
<li>函数<code>heap_insert()</code>向共享缓冲池的目标页面中插入堆元组，创建当前页面的XLOG记录，并执行函数<code>XLogInsert()</code>。</li>
<li>函数<code>XLogInsert()</code>会将<code>heap_insert()</code>创建的XLOG记录写入WAL缓冲区<code>LSN_1</code>处，并将被修改页面的<code>pd_lsn</code>从<code>LSN_0</code>更新为<code>LSN_1</code>。</li>
<li>函数<code>finish_xact_command()</code>会在该事务被提交时被调用，用于创建该提交动作的XLOG记录，而这里的<code>XLogInsert()</code>函数会将该记录写入WAL缓冲区<code>LSN_2</code>处。</li>
</ol>
<p><strong>图9.11 XLOG记录的写入顺序</strong></p>
<p><img src="/img/blog/kernel/fig-9-11.png"></p>
<blockquote>
<p>上图的XLOG格式是9.4版本的</p>
</blockquote>
<ol start="5">
<li>函数<code>XLogWrite()</code>会冲刷WAL缓冲区，并将所有内容写入WAL段文件中。如果<code>wal_sync_method</code>参数被配置为<code>open_sync</code>或<code>open_datasync</code>，记录会被同步写入（译者注：而不是提交才会刷新WAL缓冲区），因为函数会使用带有<code>O_SYNC</code>或<code>O_DSYNC</code>标记的<code>open()</code>系统调用。如果该参数被配置为<code>fsync</code>，<code>fsync_writethrough</code>，<code>fdatasync</code>，相应的系统调用就是<code>fsync()</code>，带有<code>F_FULLSYNC</code>选项的<code>fcntl()</code>，以及<code>fdatasync()</code>。无论哪一种情况，所有的XLOG记录都会被确保写入存储之中。</li>
<li>函数<code>TransactionIdCommitTree()</code>将提交日志clog中当前事务的状态从<code>IN_PROGRESS</code>更改为<code>COMMITTED</code>。</li>
</ol>
<p><strong>图9.12 XLOG记录的写入顺序（续图9.11）</strong></p>
<p><img src="/img/blog/kernel/fig-9-12.png"></p>
<p>在上面这个例子中，<code>COMMIT</code>操作致使XLOG记录写入WAL段文件。但发生在下列任一情况时，都会执行这种写入操作：</p>
<ol>
<li>一个运行中的事务提交或中止。</li>
<li>WAL缓冲区被写入的元组填满（WAL缓冲区的大小由参数<code>wal_buffers</code>控制）</li>
<li>WAL写入者进程周期性执行写入（参见下一节）</li>
</ol>
<p>如果出现上述情况之一，无论其事务是否已提交，WAL缓冲区上的所有WAL记录都将写入WAL段文件中。</p>
<p>DML操作写XLOG记录是理所当然的，但非DML操作也会产生XLOG。如上所述，<code>COMMIT</code>操作会写入包含着提交的事务ID的XLOG记录。另一个例子是<code>Checkpoint</code>操作会写入关于该检查点概述信息的XLOG记录。此外，尽管不是很常见，<code>SELECT</code>语句在一些特殊情况下也会创建XLOG记录。例如在SELECT语句处理的过程中，如果因为HOT（Heap Only Tuple）需要删除不必要元组并拼接必要的元组时，修改对应页面的XLOG记录就会写入WAL缓冲区。</p>
<h2 id="96-wal写入进程">9.6 WAL写入进程</h2>
<p>WAL写入者是一个后台进程，用于定期检查WAL缓冲区，并将所有未写入的XLOG记录写入WAL段文件。 这个进程的目的是避免XLOG记录的突发写入。 如果没有启用该进程，则在一次提交大量数据时，XLOG记录的写入可能会成为瓶颈。</p>
<p>WAL写入者默认是启用的，无法禁用。但检查间隔可以通过参数<code>wal_writer_delay</code>进行配置，默认值为200毫秒。</p>
<h2 id="97-postgresql中的检查点过程">9.7 PostgreSQL中的检查点过程</h2>
<p>在PostgreSQL中，检查点进程（后台）会执行检查点；当下列情形之一发生时，它会启动处理：</p>
<ol>
<li>距离上次检查点已经过去了由参数<code>checkpoint_timeout</code>配置的时间间隔（默认间隔为300秒（5分钟））。</li>
<li>在9.4及以前的版本中，自上一次检查点以来消耗的WAL段文件超出了参数<code>checkpoint_segments</code>的数量（默认值为3）。</li>
<li>在9.5及以后的版本，<code>pg_xlog</code>（10之后是<code>pg_wal</code>）中的WAL段文件总大小超过参数<code>max_wal_size</code>配置的值（默认值为1GB，64个段文件）。</li>
<li>PostgreSQL服务器以<code>smart</code>或<code>fast</code>模式关闭。</li>
</ol>
<p>当超级用户手动执行<code>CHECKPOINT</code>命令时，该进程也会启动。</p>
<blockquote>
<p>在9.1或更早的版本中，后台写入进程（见8.6节）同时负责脏页写入与检查点。</p>
</blockquote>
<p>在接下来的几个小节中会简要描述检查点过程与<code>pg_control</code>文件，<code>pg_control</code>文件保存了当前检查点的元数据。</p>
<h3 id="971-检查点过程概述">9.7.1 检查点过程概述</h3>
<p>检查点进程负责两个方面：为数据库恢复做准备工作，以及共享缓冲池上脏页的刷盘工作。在本小节介绍其内部过程时，将重点关注前一个方面。参见图9.13和以下描述。</p>
<p><strong>图9.13 PostgreSQL检查点的内部流程</strong></p>
<p><img src="/img/blog/kernel/fig-9-13.png"></p>
<ol>
<li>当检查点进程启动时，会将**重做点（REDO Point）**存储在内存中；<strong>重做点</strong>是上次检查点开始时刻时XLOG记录的写入位置，也是数据库恢复的开始位置。</li>
<li>该检查点相应的XLOG记录（即检查点）会被写入WAL缓冲区，该记录的数据部分是由<code>CheckPoint</code>结构体定义的，包含了一些变量，比如第一步中重做点的位置。另外，写入检查点记录的位置，也按照字面意义叫做<strong>检查点（checkpoint</strong>）。</li>
<li>共享内存中的所有数据（例如，CLOG的内容）都会被刷入持久存储中。</li>
<li>共享缓冲池中的所有脏页都会被逐渐刷写到存储中。</li>
<li>更新<code>pg_control</code>文件，该文件包含了一些基础信息，例如上一次检查点的位置，后面会介绍该文件的细节</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">CheckPoint</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">XLogRecPtr</span>      <span style="color:#000">redo</span><span style="color:#000;font-weight:bold">;</span>           <span style="color:#8f5902;font-style:italic">/* 当创建存盘时，下一个可用的RecPtr(即重做点) */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">TimeLineID</span>      <span style="color:#000">ThisTimeLineID</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 当前时间线ID TLI */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">TimeLineID</span>      <span style="color:#000">PrevTimeLineID</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 前一个时间线ID TLI, 如果当前记录开启了一条新的时间线
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                                   * (其他情况下等于ThisTimeLineID) */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">bool</span>            <span style="color:#000">fullPageWrites</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* 当前全页写入的状态 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uint32</span>          <span style="color:#000">nextXidEpoch</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* 下一个时事务ID（nextXid）的高位bit */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">TransactionId</span>   <span style="color:#000">nextXid</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 下一个空闲事务ID */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Oid</span>             <span style="color:#000">nextOid</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* 下一个空闲OID */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">MultiXactId</span>     <span style="color:#000">nextMulti</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* 下一个空闲MultiXactId */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">MultiXactOffset</span> <span style="color:#000">nextMultiOffset</span><span style="color:#000;font-weight:bold">;</span><span style="color:#8f5902;font-style:italic">/* 下一个空闲MultiXact 偏移量 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">TransactionId</span>   <span style="color:#000">oldestXid</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* 集蔟范围最小的datfronzenxid */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Oid</span>             <span style="color:#000">oldestXidDB</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* 带有最小datfrozenxid的数据库 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">MultiXactId</span>     <span style="color:#000">oldestMulti</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* 集蔟范围内最小的datminmxid */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Oid</span>             <span style="color:#000">oldestMultiDB</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">/* 带有最小datminmxid的数据库 */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">pg_time_t</span>       <span style="color:#000">time</span><span style="color:#000;font-weight:bold">;</span>           <span style="color:#8f5902;font-style:italic">/* 存盘的时间戳 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic">/* 最老的仍然在运行的事务ID，只有当从在线检查点中初始化一个热备时才会需要该字段。因此只有
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  * 当在线检查点且wal_level配置为热备时我们才会费劲计算这个字段。其他情况下会被设置为
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  * InvalidTransactionId  */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">TransactionId</span> <span style="color:#000">oldestActiveXid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">CheckPoint</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>让我们从数据库恢复的角度来总结上面的内容，检查点过程会创建包含重做点的检查点，并将检查点位置与其他信息存储到<code>pg_control</code>文件中。因此，PostgreSQL能够通过从重做点回放WAL数据来进行恢复（重做点是从检查点中获取的）。</p>
<h3 id="972-pg_crontrol文件">9.7.2 <code>pg_crontrol</code>文件</h3>
<p>由于<code>pg_control</code>文件包含了检查点的基本信息，因此它对于数据库恢复肯定是必不可少的。如果它被破坏或不可读，因为系统不知道从哪里开始恢复，则恢复过程就无法启动。</p>
<p>尽管<code>pg_control</code>文件存储了40多条数据项，如下三个是接下来和我们讨论内容相关的：</p>
<ol>
<li><strong>状态（State）</strong> —— 最近检查点过程开始时数据库的状态，总共有七种状态：<code>start up</code>表示系统正在启动，<code>shut down</code>表示系统被关机命令正常关闭，<code>in production</code>表示数据库正在运行，诸如此类。</li>
<li><strong>最新检查点位置（Latest Checkpoint Location）</strong> —— 最新检查点的LSN位置</li>
<li><strong>上次检查点位置（Prior Checkpoint Location）</strong>—— 前一个检查点的LSN位置，在版本11中已经弃用，细节如引文所示。</li>
</ol>
<p><code>pg_control</code>文件存储在数据目录中<code>global</code>子目录内；可以使用<code>pg_controldata</code>程序显示其内容。</p>
<blockquote>
<h3 id="postgresql11中移除了前任检查点">PostgreSQL11中移除了前任检查点</h3>
<p>PostgreSQL 11及后续版本只会存储包含最新检查点或更新版本的WAL段文件；将不会存储包含先前检查点的旧段文件，以减少用于在<code>pg_xlog(pg_wal)</code>子目录下保存WAL段文件的磁盘空间。 详细信息请参见此<a href="http://www.postgresql-archive.org/Remove-secondary-checkpoint-tt5989050.html">主题</a>。</p>
</blockquote>
<h2 id="98-postgresql中的数据库恢复">9.8 PostgreSQL中的数据库恢复</h2>
<p>PostgreSQL的恢复功能基于**重做日志（REDO log）**实现。如果数据库服务器崩溃，PostgreSQL通过从REDO点依序重放WAL段文件中的XLOG记录来恢复数据库集群。</p>
<p>在本节之前，我们已经多次讨论过数据库恢复，所以这里将会介绍两个与恢复有关，但尚未解释过的事情。</p>
<p>第一件事是PostgreSQL如何启动恢复过程。当PostgreSQL启动时，它首先读取<code>pg_control</code>文件。以下是从那时起恢复处理的细节。参见图9.14和以下描述。</p>
<p><strong>图9.14 恢复过程的细节</strong></p>
<p><img src="/img/blog/kernel/fig-9-14.png"></p>
<ol>
<li>PostgreSQL在启动时读取<code>pg_control</code>文件的所有项。如果<code>state</code>项是<code>in production</code>，PostgreSQL将进入恢复模式，因为这意味着数据库没有正常停止；如果是<code>shut down</code>，它就会进入正常的启动模式。</li>
<li>PostgreSQL从合适的WAL段文件中读取最近的检查点，该记录的位置写在<code>pg_control</code>文件中，并从该检查点中获得重做点。如果最新的检查点是无效的，PostgreSQL会读取前一个检查点。如果两个记录都不可读，它就会放弃自我恢复（注意在PostgreSQL11中不会存储前一个检查点）。</li>
<li>使用合适的资源管理器按顺序读取并重放XLOG记录，从重做点开始，直到最新WAL段文件的最后位置。当遇到一条属于备份区块的XLOG记录时，无论其LSN如何，它都会覆写相应表的页面。其他情况下，只有当此记录的LSN大于相应页面的<code>pd_lsn</code>时，才会重放该（非备份区块的）XLOG记录。</li>
</ol>
<p>第二件事是关于LSN的比较：为什么应该比较非备份区块的LSN和相应页面的<code>pd_lsn</code>。与前面的示例不同，这里使用需要在两个LSN之间进行比较的具体例子来解释，如图9.15和图9.16。 （注意这里省略了WAL缓冲区，以简化描述）。</p>
<p><strong>图9.15 当后台写入者工作时的插入操作</strong></p>
<p><img src="/img/blog/kernel/fig-9-15.png"></p>
<ol>
<li>
<p>PostgreSQL将一条元组插入表A，并将一条XLOG记录写入<code>LSN_1</code>。</p>
</li>
<li>
<p>后台写入者进程将表A的页面写入存储。此时，此页面的<code>pd_lsn</code>为<code>LSN_1</code>。</p>
</li>
<li>
<p>PostgreSQL在表A中插入一条新元组，并在<code>LSN_2</code>处写入一条XLOG记录。修改后的页面尚未写入存储。</p>
</li>
</ol>
<p>与本章概述中的例子不同，在本场景中，表A的页面已经被一次性写入存储中。</p>
<p>使用<code>immediate</code>模式关闭数据库，然后启动数据库。</p>
<p><strong>图9.16 数据库恢复</strong></p>
<p><img src="/img/blog/kernel/fig-9-15.png"></p>
<ol>
<li>PostgreSQL加载第一条XLOG记录和表A的页面，但不重放它，因为该记录的LSN不大于表A的LSN（两个值都是<code>LSN_1</code>）。实际上一目了然，没有重放该记录的必要性。</li>
<li>接下来，PostgreSQL会重放第二条XLOG记录，因为该记录的LSN（<code>LSN_2</code>）大于当前表A的LSN（<code>LSN_1</code>）。</li>
</ol>
<p>从这个例子中可以看出，如果非备份区块的重放顺序不正确，或者多次重放非备份区块，数据库集群将不再一致。简而言之，非备份区块的重做（重放）操作不是**幂等（idempotent）**的。因此，为了确保正确的重放顺序，非备份区块中的记录当且仅当其LSN大于相应页面的<code>pd_lsn</code>时，才执行重放。</p>
<p>另一方面，由于备份区块的重放操作是幂等的，不管其LSN为何值，备份块可以重放任意次。</p>
<h2 id="99-wal段文件管理">9.9 WAL段文件管理</h2>
<p>PostgreSQL将XLOG记录写入<code>pg_xlog</code>子目录中的WAL段文件中（版本10之后是<code>pg_wal</code>子目录），当旧的段文件写满时就会切换至新的段文件。WAL文件的数量会根据几个配置参数的变化而变化，一些服务器的行为也会相应变化。此外，在9.5版中，段文件的管理机制也有了一些改善。</p>
<h3 id="991-wal段切换">9.9.1 WAL段切换</h3>
<p>当出现下列任一情况时，WAL段会发生切换：</p>
<ol>
<li>WAL段已经被填满。</li>
<li>函数<code>pg_switch_xlog()</code>（10以后为<code>pg_switch_wal()</code>）被调用。</li>
<li>启用了<code>archive_mode</code>，且已经超过<code>archive_timeout</code>配置的时间。</li>
</ol>
<p>被切换的文件通常会被回收（重命名或重用），以供未来之用。但如果不是需要的话，也可能会被移除。</p>
<h3 id="992-wal段管理95版及以后">9.9.2 WAL段管理（9.5版及以后）</h3>
<p>每当检查点过程启动时，PostgreSQL都会估计并准备下一个检查点周期所需的WAL段文件数。这种估计基于前一个检查点周期中消耗的文件数量，即从包含上一个重做点的段文件开始计数，而这个值应当在<code>min_wal_size</code>（默认80MB，5个文件）与<code>max_wal_size</code>之间（默认1GB，64个文件）。如果检查点过程启动，必需的段文件会被保留或回收，而不必要的段文件会被移除。</p>
<p>一个具体的例子如图9.17所示，假设在检查点开始前有六个文件，<code>WAL_3</code>包含了上一个重做点（版本10及以前，版本11后就是当前重做点），PostgreSQL估计会需要五个文件，在这种情况下，<code>WAL_1</code>被重命名为<code>WAL_7</code>回收利用，而<code>WAL_2</code>会被移除。</p>
<blockquote>
<p>任何比包含上一个重做点的段文件更老的段文件都可以被移除，因为按照9.8节中描述的恢复机制，这些文件永远不会被用到了。</p>
</blockquote>
<p><strong>图9.17 在检查点时发生的WAL段文件循环与回收</strong></p>
<p><img src="/img/blog/kernel/fig-9-17.png"></p>
<p>如果出现了WAL活动尖峰，导致需要更多的文件，新的文件会被创建，而WAL文件的总大小是小于<code>max_wal_size</code>的。例如在图9.18中，如果<code>WAL_7</code>被填满，<code>WAL_8</code>就会被新创建出来。</p>
<p><strong>9.18 创建WAL段文件</strong></p>
<p><img src="/img/blog/kernel/fig-9-18.png"></p>
<p>WAL文件的数量会根据服务器活动而自动适配。 如果WAL数据写入量持续增加，则WAL段文件的估计数量以及WAL文件的总大小也会逐渐增加。 在相反的情况下（即WAL数据写入量减少），这些值也会减少。</p>
<p>如果WAL文件的总大小超过<code>max_wal_size</code>，则将启动检查点。 图9.19说明了这种情况。 检查点将会创建一个新的重做点，最近的重做点将会变为上一个重做点，不是必需的文件将被回收。通过这种方式，PostgreSQL将始终只保留数据库恢复所必需的WAL段文件。</p>
<p><strong>图9.19 检查点与回收WAL段文件</strong></p>
<p><img src="/img/blog/kernel/fig-9-19.png"></p>
<p>配置参数<code>wal_keep_segments</code>以及**复制槽（Replication Slot）**功能都会影响WAL段文件的数量。</p>
<h3 id="993-wal段管理94版及以前">9.9.3 WAL段管理（9.4版及以前）</h3>
<p>WAL段文件的数量主要由下列三个参数控制：</p>
<ul>
<li><code>checkpoint_segments</code></li>
<li><code>checkpoint_completion_target</code></li>
<li><code>wal_keep_segments</code>。</li>
</ul>
<p>WAL段文件的数量通常会：</p>
<p>比 $((2 + \verb|checkpoint_completion_target|) × \verb|checkpoint_segments| + 1 )$ 要大</p>
<p>比$( \verb|checkpoint_segments| + \verb|wal_keep_segments| + 1)$要大</p>
<p>且不超过$(3×\verb|checkpoint_segments|+1)$个文件</p>
<p>WAL段文件具体数目的取决于不同的服务器活动，复制槽的存在也会影响WAL文件的数量。</p>
<p>如第9.7节中所提到的，当消耗了超过<code>checkpoint_segments</code>个数量的文件时，就会启动检查点过程。因此可以保证WAL段文件中总是包含至少两个重做点，因为文件的数量始终大于$2×\verb|checkpoint_segments|$，对于由超时导致的检查点同样适用。PostgreSQL总是会保留足够用于恢复的WAL段文件（有时候会超出必需的量）。</p>
<blockquote>
<p>在版本9.4或更早版本中，调整参数<code>checkpoint_segments</code>是一个痛苦的问题。 如果设置为较小的值，则检查点会频繁发生，这会导致性能下降；而如果设置为较大的数值，则WAL文件总是需要巨大的磁盘空间，但其中一些空间不是必须的。</p>
<p>在9.5版本中，WAL文件的管理策略得到了改善，而<code>checkpoint_segments</code>参数被弃用，因此上述的权衡问题已经得到解决。</p>
</blockquote>
<h2 id="910-归档日志与持续归档">9.10 归档日志与持续归档</h2>
<p><strong>持续归档（continuous archiving）<strong>是当WAL段文件发生切换时会自动将其拷贝至归档区域的一项功能。持续归档是由归档后台进程执行的，拷贝的文件称为</strong>归档日志（archive log）</strong>。该功能通常用于物理备份与时间点恢复（参见<a href="/zh/blog/kernel/ch10/">第十章</a>）。</p>
<p>归档区域的配置取决于配置参数<code>archieve_command</code>，例如使用下列配置时，每当发生段文件切换时，WAL段文件会被拷贝到目录<code>/home/postgres/archives</code>目录下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">archive_command</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;cp %p /home/postgres/archives/%f&#39;</span>
</span></span></code></pre></div><p>这里<code>%p</code>是被拷贝WAL段文件的路径占位符，而<code>%f</code>是归档日志文件名的占位符。</p>
<p><strong>图9.20 持续归档</strong></p>
<p><img src="/img/blog/kernel/fig-9-20.png"></p>
<p>当WAL段文件<code>WAL_7</code>发生切换时，该文件被拷贝至归档区域，作为归档日志7。</p>
<p><code>archive_command</code>参数可以配置为任意的Unix命令或程序，因此你也能用<code>scp</code>将归档日志发送到其他主机上，或使用任意的文件备份工具来替代普通的拷贝命令。</p>
<blockquote>
<p>PostgreSQL<strong>并不会</strong>清理归档日志，所以在使用该功能时需要管理好这些日志。如果什么都不做，归档日志的数量会不断增长。</p>
<p><a href="https://www.postgresql.org/docs/current/static/pgarchivecleanup.html"><code>pg_archivecleanup</code></a>工具是一个管理归档日志的实用工具。</p>
</blockquote>

	<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
  <li>
    <a href="/zh/blog/kernel/ch10/" aria-label="Previous - 第十章 基础备份与时间点恢复" class="btn btn-primary"><span class="me-1">←</span>Previous</a>
  </li>
  <li>
    <a href="/zh/blog/kernel/ch8/" aria-label="Next - 第八章 缓冲区管理器" class="btn btn-primary">Next<span class="ms-1">→</span></a>
  </li>
</ul>

	<div class="td-page-meta__lastmod">
  Last modified 2024-05-22: <a href="https://github.com/Vonng/pigsty.cc/commit/99d801856ab5f792c96873f6dadeb431ef3bdffe">adjust blog structure (99d80185)</a>
</div>
</div>


          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Mail" aria-label="Mail">
    <a target="_blank" rel="noopener" href="mailto:rh@vonng.com" aria-label="Mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Vonng/pigsty" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://twitter.com/GobeUncleWang" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="WeChat" aria-label="WeChat">
    <a target="_blank" rel="noopener" href="/img/pigsty/pigsty-cc.jpg" aria-label="WeChat">
      <i class="fa fa-comment"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Discord" aria-label="Discord">
    <a target="_blank" rel="noopener" href="https://discord.gg/wDzt5VyWEz" aria-label="Discord">
      <i class="fab fa-discord"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Telegram" aria-label="Telegram">
    <a target="_blank" rel="noopener" href="https://t.me/joinchat/gV9zfZraNPM3YjFh" aria-label="Telegram">
      <i class="fab fa-telegram"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2018&ndash;2025
    <span class="td-footer__authors">Ruohang Feng</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span></span><span class="ms-2"><a href="https://vonng.com/en/" target="_blank" rel="noopener">@Vonng</a></span>
<br><span>Pigsty® distributed under <a href="/docs/about/license" target="_blank" rel="noopener">AGPLv3</a></span>
<br><span class="ms-2"><a href="/docs/about/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
<span><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">浙ICP备15016890号</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.248655eb216150e39da254c2f7aa5357805d0ec66bdb741b591cd35fb5f629ab.js" integrity="sha256-JIZV6yFhUOOdolTC96pTV4BdDsZr23QbWRzTX7X2Kas=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>