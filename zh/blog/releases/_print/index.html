<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="/zh/blog/releases/">
<link rel="alternate" type="application/rss&#43;xml" href="/zh/blog/releases/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>版本发布 | Pigsty</title>
<meta name="description" content="Pigsty是开源免费的 PostgreSQL 数据库发行版，提供本地优先的RDS替代，以及开箱即用的监控、管控、IaC、高可用，以及PG生态的两百余款插件">
<meta property="og:title" content="版本发布" />
<meta property="og:description" content="Pigsty是开源免费的 PostgreSQL 数据库发行版，提供本地优先的RDS替代，以及开箱即用的监控、管控、IaC、高可用，以及PG生态的两百余款插件" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/zh/blog/releases/" />

<meta itemprop="name" content="版本发布">
<meta itemprop="description" content="Pigsty是开源免费的 PostgreSQL 数据库发行版，提供本地优先的RDS替代，以及开箱即用的监控、管控、IaC、高可用，以及PG生态的两百余款插件"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="版本发布"/>
<meta name="twitter:description" content="Pigsty是开源免费的 PostgreSQL 数据库发行版，提供本地优先的RDS替代，以及开箱即用的监控、管控、IaC、高可用，以及PG生态的两百余款插件"/>




<link rel="preload" href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" as="style">
<link href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="/js/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LG1V9WTKGE');
}
</script>
  </head>
  <body class="td-section td-blog">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/zh/"><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class="navbar-brand__name">Pigsty</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/zh/docs/"><i class='fa-solid fa-book'></i><span>文档</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="/zh/blog/"><i class="fas fa-blog"></i><span>博客</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/Vonng/pigsty/" target="_blank" rel="noopener"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-language"></i>中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/blog/releases/">English</a></li>
    </ul>
</div>
</li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.b40d8bc16bcda835248990ff9db38455.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/zh/blog/releases/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">版本发布</h1>





    <ul>
    
  
  
  
  

  
    
    
	

    <li><a href="#pg-f8f51d260e9f8aa141b991bcff0ac817">v3.2：命令行工具pig，完备的ARM扩展仓库，Supabase &amp; Grafana 加强</a></li>



    
  
    
    
	

    <li><a href="#pg-93a85e78558ffe12d450f9660ac47211">v3.1：Supabase一键自建，PG17上位，ARM与Ubuntu24支持，MinIO改进</a></li>



    
  
    
    
	

    <li><a href="#pg-e7e4e4c92d83a217d8bda0fa106a91e3">v3.0：海量扩展，插拔内核，RDS服务</a></li>



    
  
    
    
	

    <li><a href="#pg-39e2c61ab8b91d698dfa3ef858800027">v2.7：集异璧之大成</a></li>



    
  
    
    
	

    <li><a href="#pg-8057c0bc48b0902a8d3c8eeddea32e77">v2.6：PG 踢馆 OLAP</a></li>



    
  
    
    
	

    <li><a href="#pg-877785c5632b343eb253c95e8f53bb0d">v2.5：Ubuntu &amp; PG16</a></li>



    
  
    
    
	

    <li><a href="#pg-cec3476d5ea1563fac8cc4175e0fe4b1">v2.4：监控云数据库</a></li>



    
  
    
    
	

    <li><a href="#pg-66e10e82bb6e5a34062744a4d5f34ea1">v2.3：丰富应用生态</a></li>



    
  
    
    
	

    <li><a href="#pg-64a3297ad799d4639405ad1f505ddbaa">v2.2：监控全面翻新</a></li>



    
  
    
    
	

    <li><a href="#pg-1faf1f211dddb5c08bd00bf6bd5453e2">v2.1：向量&#43;PG全系支持！</a></li>



    
  
    
    
	

    <li><a href="#pg-27acbe2d482c252f88c15bd84c664282">v2.0：开源RDS PG替代</a></li>



    
  
    
    
	

    <li><a href="#pg-81dacd29684b0b4454631f9f21450afb">v1.5.0 发布注记</a></li>



    
  
    
    
	

    <li><a href="#pg-434178e5fe8c53371b4d97db657374b7">v1.4.0 发布注记</a></li>



    
  
    
    
	

    <li><a href="#pg-a0fb8b384cade6ec407c2453f1e2d292">v1.3.0 发布注记</a></li>



    
  
    
    
	

    <li><a href="#pg-d2b8bcedf0eac31226e2b7f3dcba7d8a">v1.2.0 发布注记</a></li>



    
  
    
    
	

    <li><a href="#pg-854c111b55099c9d05d054f2e73a5cbf">v1.1.0 发布注记</a></li>



    
  
    
    
	

    <li><a href="#pg-794b5d90dc8a76efe53cd1189faf34ff">v1.0.0 发布注记</a></li>



    
  
    
    
	

    <li><a href="#pg-53940fb31dd185924dcbf98876521bbc">v0.9.0 发布注记</a></li>



    
  
    
    
	

    <li><a href="#pg-1c0e38dfb9d42ffaff8ca7937ecd2e21">v0.8.0 发布注记</a></li>



    
  
    
    
	

    <li><a href="#pg-a757729041ec674785eddd6b2c1694e2">v0.7.0 发布注记</a></li>



    
  
    
    
	

    <li><a href="#pg-9d3157a4b85f04c552b9dc4e0605e241">v0.6.0 发布注记</a></li>



    
  
    
    
	

    <li><a href="#pg-a31bec40c01f539af16d13999ac7c1ab">v0.5.0 发布注记</a></li>



    
  
    
    
	

    <li><a href="#pg-b5d77a188caf8e3a09a3d3b5b8acaa94">v0.4.0 发布注记</a></li>



    
  
    
    
	

    <li><a href="#pg-7df560570ddd6f526d521202261d0bf9">v0.3.0 发布注记</a></li>



    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-f8f51d260e9f8aa141b991bcff0ac817">v3.2：命令行工具pig，完备的ARM扩展仓库，Supabase &amp; Grafana 加强</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a> | <a href="https://github.com/Vonng/pigsty/releases/tag/v3.2.0">发行注记</a> | <a href="/zh/">微信公众号</a></b> |
        
		<time datetime="2024-12-29" class="text-muted">2024年12月29日</time>
        
	</div>
	<p>新年就要到了，Pigsty 迎来了 2024 年的最后一次发布 v3.2。
本次发布带来了一个命令行工具 <code>pig</code> ，以及完善的 ARM 扩展支持，两者合体，可为用户带来10大主流 Linux 系统上丝滑的 PG 交付能力。
本次发布例行修复了一些问题，同时跟进了 Supabase 发布周的密集变化，并为 Grafana 扩展插件与数据源提供了 RPM / DEB 包。</p>
<hr>
<h2 id="pig-命令行工具">Pig 命令行工具</h2>
<p>Pigsty v3.2 默认提供了一个命令行工具 <a href="/zh/blog/pg/pig">pig</a> ，可以用来进一步简化 Pigsty 的安装部署配置过程。
但 <code>pig</code> 并非仅仅是一个 Pigsty 的命令行工具，它还是一个可以独立使用的全功能 PostgreSQL 包管理器。</p>
<p>你是否曾在安装 PostgreSQL 的扩展插件时，面对各种发行版、各种芯片架构，一把辛酸泪？
将大把时间耗费在过时的 README，晦涩的配置脚本和随机的 GitHub 分支中翻找？
又或者苦恼于国内网络环境，仓库缺失、镜像被墙？下载犹如便秘阻塞？</p>
<p>现在好了，“小猪骑大象”正式登场，为你打包解决所有难题：
让我们迎来 Pig，一个全新的、基于 Go 的包管理器，它能够处理 Postgres 和 它不断扩展的扩展库，而不会让你的一天变成调试马拉松。</p>
<p>Pig 本身是用 Go 编写的轻量级二进制，无依赖、易安装：只需一行命令即可安装，即刻开启“猪猪冲锋”。
它尊重操作系统的包管理传统，拒绝重新发明轮子，基于 yum/dnf/apt 实现包管理；</p>
<p>Pig 专注于跨发行版的和谐——无论你是在 Debian、Ubuntu 还是 Red Hat 衍生版上，
你都可以获得一种单一、流畅的安装和更新 Postgres 及任何扩展的方法。不再需要从源代码编译或处理半成品仓库。</p>
<p>如果说 <a href="/zh/blog/pg/pg-eat-db-world">PostgreSQL 的未来是无法阻挡的可扩展性</a>，Pig 就是帮助你解锁它的精灵。
老实说，没有人会抱怨他们的 Postgres 实例拥有太多扩展 —— 毕竟不用的时候没有任何影响，用的事后它就在手边，免费的午餐谁不爱？</p>
<hr>
<h2 id="arm-扩展仓库">ARM 扩展仓库</h2>
<p>Pig 的幕后魔法是一个充满难找或新发布扩展的补充<a href="/zh/blog/pg/pg-ext-repo">扩展仓库</a>，因此你总是可以轻松获取优质扩展 —— 经过测试驱动、精心策划并准备就绪。</p>
<p>在最近一个月内，Pigsty 已经为 ARM64 系统架构做好了完整的支持。我们为受支持的五个主流 Linux 发行版 （EL8，EL9， Debian12，Ubuntu 22/24）提供了 <strong>完整</strong> 的 ARM 支持。
完整的意思是你在 AMD64 上使用的配置文件可以一模一样用在 ARM64 架构的系统上。当然少不了零星例外：极个别扩展目前缺少 ARM 支持，我们将在后面逐一解决这些特里。</p>
<p>还在为寻找那些小众的 Git 仓库、不完整的 Docker 构建或者过时的维基文档而苦恼，只为安装某个必须的 Postgres 插件吗？
我们懂你的痛。尽管 PostgreSQL 的可扩展性堪称超能力，但整个生态面临的最大难题一直是分发——如何在不陷入编译地狱的情况下，顺利安装各种 FDW、向量扩展、GIS 库、Rust 模块等“神兵利器”？</p>
<p>现在有了 Pigsty Extension Repo，它集合了 340+ 精选 Postgres 扩展，编译成方便使用的 .rpm 和 .deb 包，支持多版本、多架构。Timescale？OK。Supabase 相关？全套到位。
DuckDB 的各种缝合包？都已就绪。我们搭建了一个跨发行版的流水线，将社区自研的新扩展、历久弥新的老模块，以及官方 PGDG 包整合在一起，让它们能在 Debian、Ubuntu、Red Hat 系列等各大系统上一键无缝安装。
秘诀是什么？我们不造轮子，而是直接基于每个发行版原生的包管理器（YUM、APT、DNF 等），保持与官方 PGDG 仓库的版本对齐。</p>
<p>从底层看，这个仓库是更大范围的 Pigsty PostgreSQL 发行版一部分，但你也可以在自己的环境中独立使用，无需全部接纳 Pigsty。
我们投入了大量精力来修补、测试和打磨每个扩展，你可以坐收渔利。所有内容都是免费、开源的，而且整合起来非常轻松。已经有几家友商将它作为额外的上游用于安装扩展了！</p>
<p>想彻底解决你对 Postgres 扩展的所有烦恼？点击访问 ext.pigsty.io 深入了解，查阅完整的扩展索引和使用说明。
我们把能找到的所有插件都进行了打包测试，只为让 Postgres 成为那个本该无所不能的“最终形态”——毕竟，谁会嫌自己的超能力太多呢？欢迎体验！</p>
<p>针对 ARM64 平台的支持给了我很大信心，因此我也将目光放到了更多的芯片架构支持上。
例如 IBM LinuxOne Cloud 最近有一个活动，赞助开源项目一台永久的虚拟机 （2c/8g/100g），最主要的是还是 s390x 大型机。
所以我准备最近试试水，让 Pigsty 跑在 IBM 大型机上，哈哈。</p>
<hr>
<h2 id="supabase-例行跟进">Supabase 例行跟进</h2>
<p>Pigsty 之前推出的 <a href="/zh/db/supabase">Supabase 自建教程</a> 能让用户在一台机器上迅速拉起自建的 Supabase 服务。
对于密集使用 Supabase 的创业群体中引起了一些反响，所以我们也在 Supabase 的最新版本上做了一些跟进。</p>
<p>Supabase 最近在 2024 年的最后一个月里发布了一系列重要更新，Pigsty v3.2 也跟进了这些变化，为用户提供了最新的 Supabase 版本。
当然说实话除了 AI 噱头，大部分都是：Supabase 又提供了XXX能力（比如队列），但底下本质上是新收录了 XXX PG 扩展（比如 PGMQ）。</p>
<p>当然 Supabase 最近的大动作是 OrieloDB（年中被 supabase 收购了！），一个很有趣的 PostgreSQL Fork，专注于提升 PG 的 OLTP 性能。
目前这项功能在 Supabase 中被标记为 Beta，作为一个用户的可选项存在，但我需要确保即使以后 Supabase 使用它作为主干，Pigsty 也能支持。</p>
<p>目前，我们正在准备 OrieloDB 的 RPM/DEB 包，以及针对 OrieloDB 的扩展插件。凭借这个契机，我们也准备进一步将这些扩展的超能力普及到更多的 PG 分叉上，
例如 Oracle 兼容的 IvorySQL 3/4 ，SQL Server 兼容的 WiltonDB，以及 PolarDB PG。</p>
<hr>
<h2 id="grafana-的可扩展性">Grafana 的可扩展性</h2>
<p>Grafana 是一个非常流行的开源监控和可视化工具。当然，它也有着许多扩展插件，比如各类数据可视化面板与数据源。但这些扩展插件的安装和管理一直是一个问题。
Grafana自己的 CLI 工具确实可以用于安装插件，不过墙内的用户必须科学上网才能使用，带来了很大的不便。</p>
<p>在 v3.2 中，我们将 Grafana 常用的扩展面板与数据源插件都做成了 RPM/DEB 包，方便开箱即用。例如，以下这些架构无关的扩展现在被制作成了一个 grafana-plugins 软件包：</p>
<ul>
<li>volkovlabs-echarts-panel</li>
<li>volkovlabs-image-panel</li>
<li>volkovlabs-form-panel</li>
<li>volkovlabs-table-panel</li>
<li>volkovlabs-variable-panel</li>
<li>knightss27-weathermap-panel</li>
<li>marcusolsson-dynamictext-panel</li>
<li>marcusolsson-treemap-panel</li>
<li>marcusolsson-calendar-panel</li>
<li>marcusolsson-hourly-heatmap-panel</li>
<li>marcusolsson-static-datasource</li>
<li>marcusolsson-json-datasource</li>
<li>volkovlabs-rss-datasource</li>
<li>volkovlabs-grapi-datasource</li>
</ul>
<p>而此外，我们还针对那些架构相关（里面包含了 x86, ARM 二进制）的数据源扩展制作独立的 RPM/DEB 包，例如 Grafana 最近推出的 Infinity 数据源插件：
你可以使用任意 REST/GRAPHQL API，使用 CSV/TSV/XML/HTML 作为数据源，这极大扩展了 Grafana 的数据接入能力。</p>
<p>与此同时，我们还针对 VictoriaMetrics 和 VictoriaLogs 的 Grafana 数据源插件制作了 RPM/DEB 包，方便用户在 Grafana 中使用这两个开源的时序数据库和日志数据库。</p>
<hr>
<h2 id="下一步的发展规划">下一步的发展规划</h2>
<p>目前，Pigsty 本身已经达到了一个让我非常满意的状态。
接下来一段时间的工作中心，我会放在 pig 这个工具，以及扩展仓库的维护上。</p>
<p>目前是一个比较难得的机会窗口，用户与开发者开始意识到了扩展的重要性，但 PostgreSQL 还没有扩展分发的事实标准。
在这个关键时刻，我希望 Pigsty / pig 能够成为一个有影响力的 PG扩展插件事实标准，抢占生态位高地。</p>
<p>当然，Pigsty 本身一直也缺少一个足够好用的 CLI 工具，接下来我会把散落在各个Ansible剧本中的功能整合到 pig 中，让用户可以更方便地管理 Pigsty 与 PostgreSQL。</p>
<hr>
<h2 id="v320-发行注记">v3.2.0 发行注记</h2>
<h3 id="亮点特性">亮点特性</h3>
<ul>
<li>Pigsty 命令行工具：<a href="https://github.com/pgsty/pig"><code>pig</code></a> 0.2.0，可用于管理扩展插件。</li>
<li>提供五大发行版上 <a href="https://ext.pigsty.io/">340 个扩展</a> 的 ARM64 扩展支持</li>
<li>Supabase 发布周最新版本更新，全发行版均可自建。</li>
<li>Grafana 更新至 11.4 ，新增 infinity 数据源。</li>
</ul>
<h3 id="软件包变化">软件包变化</h3>
<ul>
<li>
<p><strong>新增扩展</strong></p>
<ul>
<li>新增 timescaledb, timescaledb-loader timescaledb-toolkit timescaledb-tool to PIGSTY repo</li>
<li>新增 <a href="https://github.com/timescale/timescaledb">pg_timescaledb</a>，针对 EL 进行的编译重制版本</li>
<li>新增 <a href="https://ext.pigsty.io/#/pgroonga">pgroonga</a>，针对 EL 全系进行编译重制</li>
<li>新增 <a href="https://github.com/tensorchord/VectorChord">vchord</a> 0.1.0</li>
<li>新增 <a href="https://github.com/tensorchord/pg_bestmatch.rs">pg_bestmatch.rs</a> 0.0.1</li>
<li>新增 <a href="https://github.com/frectonz/pglite-fusion">pglite_fusion</a> 0.0.3</li>
<li>新增 <a href="https://github.com/Florents-Tselai/pgpdf">pgpdf</a> 0.1.0</li>
</ul>
</li>
<li>
<p><strong>更新扩展</strong></p>
<ul>
<li>pgvectorscale 0.4.0 -&gt; 0.5.1</li>
<li>pg_parquet 0.1.0 -&gt; 0.1.1</li>
<li>pg_polyline 0.0.1</li>
<li>pg_cardano 1.0.2 -&gt; 1.0.3</li>
<li>pg_vectorize 0.20.0</li>
<li>pg_duckdb 0.1.0 -&gt; 0.2.0</li>
<li>pg_search 0.13.0 -&gt; 0.13.1</li>
<li>aggs_for_vecs 1.3.1 -&gt; 1.3.2</li>
<li><code>pgoutput</code> 被标记为新的 PostgreSQL Contrib 扩展</li>
</ul>
</li>
<li>
<p><strong>基础设施</strong></p>
<ul>
<li>新增 promscale 0.17.0</li>
<li>新增 grafana-plugins 11.4</li>
<li>新增 grafana-infinity-plugins</li>
<li>新增 grafana-victoriametrics-ds</li>
<li>新增 grafana-victorialogs-ds</li>
<li>vip-manager 2.8.0 -&gt; 3.0.0</li>
<li>vector 0.42.0 -&gt; 0.43.0</li>
<li>grafana 11.3 -&gt; 11.4</li>
<li>prometheus 3.0.0 -&gt; 3.0.1 (软件包名从 <code>prometheus2</code> 变更为 <code>prometheus</code>)</li>
<li>nginx_exporter 1.3.0 -&gt; 1.4.0</li>
<li>mongodb_exporter 0.41.2 -&gt; 0.43.0</li>
<li>VictoriaMetrics 1.106.1 -&gt; 1.107.0</li>
<li>VictoriaLogs 1.0.0 -&gt; 1.3.2</li>
<li>pg_timetable 5.9.0 -&gt; 5.10.0</li>
<li>tigerbeetle 0.16.13 -&gt; 0.16.17</li>
<li>pg_export 0.7.0 -&gt; 0.7.1</li>
</ul>
</li>
<li>
<p><strong>缺陷修复</strong></p>
<ul>
<li>el8.aarch64 添加 python3-cdiff 修复 patroni 依赖错漏问题</li>
<li>el9.aarch64 添加 timescaledb-tools ，修复官方仓库缺失问题</li>
<li>el9.aarch64 添加 pg_filedump ，修复官方仓库缺失问题</li>
</ul>
</li>
<li>
<p><strong>移除扩展</strong></p>
<ul>
<li><strong>pg_mooncake</strong> 因为与 <code>pg_duckdb</code> 冲突而被移除。</li>
<li><strong>pg_top</strong> 因为出现太多版本出现缺失，因质量问题而淘汰。</li>
<li><strong>hunspell_pt_pt</strong> 因为与 PG 官方字典文件冲突而被淘汰。</li>
<li><strong>pg_timeit</strong> 因为无法在 AARCH64 架构上使用而被淘汰。</li>
<li><strong>pgdd</strong> 因为缺乏维护，PG 17 与 pgrx 版本老旧而被标记为弃用。</li>
<li><strong>old_snapshot</strong> 与 <strong>adminpack</strong> 被标记为 PG 17 不可用。</li>
<li><strong>pgml</strong> 被设置为默认不下载不安装。</li>
</ul>
</li>
</ul>
<h3 id="api变化">API变化</h3>
<ul>
<li><a href="https://pigsty.cc/zh/docs/reference/param/#repo_url_packages"><code>repo_url_packages</code></a> 参数现在默认值为空数组，因为所有软件包现在都通过操作系统包管理器进行安装。</li>
<li><code>grafana_plugin_cache</code> 参数弃用，现在 Grafana 插件通过操作系统包管理器进行安装</li>
<li><code>grafana_plugin_list</code> 参数弃用，现在 Grafana 插件通过操作系统包管理器进行安装</li>
<li>原名为 <code>prod</code> 的 36 节点仿真模板现在重命名为 <code>simu</code>。</li>
<li>原本在 <code>node_id/vars</code> 针对每个发行版代码生成的配置，现在同样针对 <code>aarch64</code> 生成。</li>
<li><code>infra_packages</code> 中默认添加命令行管理工具 <code>pig</code></li>
<li><code>configure</code> 命令同样会修改自动生成配置文件中 <code>pgsql-xxx</code> 别名的版本号。</li>
<li><code>adminpack</code> 在 PG 17 中被移除，因此从 Pigsty 默认扩展中被移除。</li>
</ul>
<h3 id="问题修复">问题修复</h3>
<ul>
<li>修复了 <code>pgbouncer</code> 仪表盘选择器问题 <a href="https://github.com/Vonng/pigsty/issues/474">#474</a></li>
<li><code>pg-pitr</code> 新增 <code>--arg value</code> 参数解析支持 by <a href="https://github.com/Vonng/pigsty/pulls?q=is%3Apr+author%3Awaitingsong">@waitingsong</a></li>
<li>修复 Redis 日志信息 typo by <a href="https://github.com/Vonng/pigsty/pull/476">@waitingsong</a></li>
</ul>
<h3 id="软件包校验和">软件包校验和</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>8fdc6a60820909b0a2464b0e2b90a3a6  pigsty-v3.2.0.tgz
</span></span><span style="display:flex;"><span>d2b85676235c9b9f2f8a0ad96c5b15fd  pigsty-pkg-v3.2.0.el9.aarch64.tgz
</span></span><span style="display:flex;"><span>649f79e1d94ec1845931c73f663ae545  pigsty-pkg-v3.2.0.el9.x86_64.tgz
</span></span><span style="display:flex;"><span>c42da231067f25104b71a065b4a50e68  pigsty-pkg-v3.2.0.d12.aarch64.tgz
</span></span><span style="display:flex;"><span>ebb818f98f058f932b57d093d310f5c2  pigsty-pkg-v3.2.0.d12.x86_64.tgz
</span></span><span style="display:flex;"><span>24c0be1d8436f3c64627c12f82665a17  pigsty-pkg-v3.2.0.u22.aarch64.tgz
</span></span><span style="display:flex;"><span>0b9be0e137661e440cd4f171226d321d  pigsty-pkg-v3.2.0.u22.x86_64.tgz
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-93a85e78558ffe12d450f9660ac47211">v3.1：Supabase一键自建，PG17上位，ARM与Ubuntu24支持，MinIO改进</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a> | <a href="https://github.com/Vonng/pigsty/releases/tag/v3.1.0">发行注记</a> | <a href="https://mp.weixin.qq.com/s/MNM5wlnIqa3QUAcvYGHKqg">微信公众号</a></b> |
        
		<time datetime="2024-11-24" class="text-muted">2024年11月24日</time>
        
	</div>
	<p>随着前天 PostgreSQL 17.2 的发布，Pigsty 也立即跟进了 v3.1 版本。
在这个版本中，PostgreSQL 17 被提升成为默认使用的大版本，近 340 个 PG 扩展插件开箱即用。</p>
<p>此外，Pigsty 3.1 还提供了一键 <a href="/zh/docs/kernel/supabase">自建 Supabase</a> 的能力，改进了 <a href="/zh/docs/minio">MinIO</a> 对象存储的使用最佳实践。
与此同时，Pigsty还提供了ARM64 架构的初步支持，并且支持了新发布的 Ubuntu 24.04 大操作系统发行版大版本。
最后，这个版本提供了一系列开箱即用的场景化模板，统一了不同操作系统发行版使用配置文件，极大简化了配置管理工作。</p>
<hr>
<h2 id="自建supabase">自建Supabase</h2>
<p>Supabase 是一个开源的 Firebase 替代，对 PostgreSQL 进行了封装，并提供了认证，开箱即用的 API，边缘函数，实时订阅，对象存储，向量嵌入能力。
Supabase 的口号是：“<strong>花个周末写写，随便扩容至百万</strong>”。在试用之后，我觉得此言不虚。
这是一个低代码的一站式后端平台，能让你几乎告别大部分后端开发的工作，只需要懂数据库设计与前端即可快速出活了！</p>
<p><img alt="supa-price.png" src="/zh/blog/releases/v3.1.0/supa-price.png"></p>
<p>小微规模（4c8g）内的 Supabase 云服务<a href="https://supabase.com/pricing">极有性价比</a>，堪称赛博菩萨。那 Supabase 云服务这么香，为什么要自建呢？有几个原因：</p>
<p>最直观的原因是是《<a href="/zh/blog/cloud">云计算泥石流</a>》中说过的：云数据库服务只要稍微上一点儿规模，成本就很容易爆炸。而且考虑到当下本地 NVMe 盘的无敌性价比，自建的成本与性能优势是显而易见的。</p>
<p>另一个重要的原因是 Supabase 云服务的功能受限 —— <a href="https://mp.weixin.qq.com/s/EH7RPB6ImfMHXhOMU7P5Qg">与RDS逻辑相同</a>，很多强力扩展出于多租户的安全问题考虑是不太可能在云端提供的 —— supabase 云服务中有64个可用扩展，但使用 Pigsty 自建 supabase 时，你可以拥有全部 <a href="https://ext.pigsty.io/#/list"><strong>340</strong></a> 个。
此外，Supabase 官方使用 PostgreSQL 15 作为底层数据库，而在 Pigsty 中，你可以使用 PG 14 - 17 的任意版本，运行在 EL / Debian / Ubuntu 主流 Linux <a href="/zh/docs/reference/compatibility">操作系统裸机</a> 上而无需虚拟化支持，充分地利用现代硬件的性能与成本优势。</p>
<p>我发现身边很多创业出海公司都在使用 Supabase，而其中一些的规模确实已经达到了需要自建的状态，而且有人愿意付费咨询来做这件事了。
所以 Pigsty 早在去年9月发布的 v2.4 就支持自建 Supabase （所需的 PostgreSQL）了。但那毕竟还涉及到一些手工操作，比如配置 PG 集群，拉起 Docker。
而在这个版本中，我们将体验优化到了这种状态 —— 一台新装操作系统的裸机，执行以下几条命令之后，一套新鲜的 Supabase 就出炉了！</p>
<p><img alt="supabase-selfhosting.png" src="/zh/blog/releases/v3.1.0/supabase-selfhosting.png"></p>
<p>这两天我会准备一些关于 <a href="/zh/docs/kernel/supabase">自建 Supabase 最佳实践</a> 的教程，敬请期待。</p>
<hr>
<h2 id="postgresql-17">PostgreSQL 17</h2>
<p>在《<a href="/zh/blog/pg/pg12-eol-pg17-up/">PG12过保，PG17上位</a>》中，我们已经详细介绍了 PostgreSQL 17 的新特性与改进。</p>
<p>其中最令人欣慰的莫过于白给的性能优化了：PostgreSQL 17 据说在写入性能上有了显著提升。我找了一台物理机测试了一下，确实不错。
相比与三年前针对 PostgreSQL 14 的测试结果《<a href="/zh/blog/pg/pg-performence">PostgreSQL到底有多强</a>》，写入确实有不小的提升。</p>
<p>例如，以前 PG 14 在标准配置下，PG 的 WAL 写入吞吐量在 110 MB/s 附近，这是软件的瓶颈，不是硬件的。
而在 PG 17 下，这个数字能达到 180 MB/s。当然，把安全开关都关掉后性能还能翻几番，但体面评测就不玩那些作弊手段了</p>
<p><img alt="perf.png" src="/zh/blog/releases/v3.1.0/perf.png"></p>
<p>Pigsty 3.1 + PostgreSQL 17 的性能回归测试，详细的性能评测报告将会在最近几天发出，敬请期待。</p>
<hr>
<h2 id="340个扩展插件">340个扩展插件</h2>
<p>Pigsty 3.1 版本的另一个亮点特性是，这个版本中提供了 <strong>340</strong> 个 PostgreSQL 扩展插件。
这是一个非常恐怖的数字了，而且这是在我进行审慎精选踢出十几个“扩展”后的结果，不然按照本期规划应该能到 360 个了。</p>
<p>为了实现这一目标，我建设了一个 YUM / APT 仓库，针对 EL 8/9, Ubuntu 22.04/24.04, Debian 12 这几个主流操作系统发行版，
以及 PG 12 - 17 这六个大版本提供开箱即用的扩展 RPM/DEB 包。目前提供 x86_64 的包，ARM64 和其他架构还在路上，目前仅对专业用户按需提供。
当然除了仓库之外，更重要的是我还维护了一个 <a href="https://ext.pigsty.io">扩展目录</a>，详细记录了每个扩展的元数据， OS/DB 版本可用性，以及一些使用说明，方便用户找到自己需要的扩展。</p>
<p><img alt="ext-repo.png" src="/zh/blog/releases/v3.1.0/ext-repo.png"></p>
<p>Pigsty 的扩展仓库基于原生的操作系统包管理器，公开共享，你不一定非要使用 Pigsty 才能按照这些扩展。
你完全可以在现有系统，Dockerfile中添加此仓库并通过 yum/apt install 的方式安装这些扩展。
目前我很欣慰的是有一个比较流行的开源集群部署项目 postgresql-cluster 已经默认用起了这个仓库，作为安装流程的一部分，向用户提供并分发扩展插件。</p>
<p><img alt="postgresql-cluster.png" src="/zh/blog/releases/v3.1.0/postgresql-cluster.png"></p>
<p>当然，更多细节，在《<a href="/zh/blog/pg/pg-ext-repo/">PostgreSQL神功大成，最全扩展仓库</a>》中对此已经有过介绍。
目前使用 Rust + pgrx 开发扩展的新项目不少，Pigsty 收录了 <strong>23</strong> 个 Rust 扩展。
如果你有好的扩展推荐，欢迎告诉我，我会考察测试后，尽快将其加入到仓库中。
如果你是 PostgreSQL 扩展作者，我们也欢迎将你的扩展提交到 Pigsty 仓库中，我们可以帮助您打包分发，解决最后一公里的交付问题。</p>
<hr>
<h2 id="ubuntu-2404-支持">Ubuntu 24.04 支持</h2>
<p>Ubuntu 24.04 noble 已经发布半年了，已经开始有一些用户在生产环境中真实使用它了。
因此，Pigsty v3.1 版本也提供了对 Ubuntu 24.04 的正式支持。</p>
<p>尽管如此，作为一个比较新的系统，Ubuntu 24.04 相比 22.04 还有一些缺陷，例如 <code>citus</code> 和 <code>topn</code> 扩展在整个系统上是缺位的，而 <code>timescaledb_toolkit</code> 目前还没有提供 u24 x86_64 的支持。
但总体来说，除了这些个例外，绝大部分扩展都已经支持 Ubuntu 24.04 了。因此将其纳入 Pigsty 的主要支持范围是没有问题的。</p>
<p>相应地，我们将 Ubuntu 20.04 focal 从 Pigsty 主力支持的操作系统中逐出，虽然 Ubuntu 20.04 在明年五月份才正式 EOL。
但是因为它的一些软件缺漏与依赖版本问题比较严重（PostGIS），我非常乐意能将其提早淘汰，踢出开源版本的支持范畴。
当然，理论上您还是可以继续在 Ubuntu 20.04 上安装并使用，而且在我们的订阅服务中也继续提供对 Ubuntu 20.04 的支持。</p>
<p>因此，目前 Pigsty 支持的主流操作系统发行版为：EL 8/9, Ubuntu 22.04 / Ubuntu 24.04, 以及 Debian 12 这五个。
我们会针对这五个操作系统发行版提供最新的软件包，完整的扩展插件。</p>
<table>
<thead>
<tr>
<th style="text-align:center">Code</th>
<th>OS Distro</th>
<th style="text-align:center"><code>x86_64</code></th>
<th style="text-align:center">PG17</th>
<th style="text-align:center">PG16</th>
<th style="text-align:center">PG15</th>
<th style="text-align:center">PG14</th>
<th style="text-align:center">PG13</th>
<th style="text-align:center">PG12</th>
<th style="text-align:center"><code>Arm64</code></th>
<th style="text-align:right">PG17</th>
<th style="text-align:center">PG16</th>
<th style="text-align:center">PG15</th>
<th style="text-align:center">PG14</th>
<th style="text-align:center">PG13</th>
<th style="text-align:center">PG12</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>EL9</strong></td>
<td>RHEL 9 / Rocky9 / Alma9</td>
<td style="text-align:center"><code>el9.x86_64</code></td>
<td style="text-align:center"><i class="fas fa-circle-check text-primary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><code>el9.arm64</code></td>
<td style="text-align:right"><i class="fas fa-circle-check text-primary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
</tr>
<tr>
<td style="text-align:center"><strong>EL8</strong></td>
<td>RHEL 8 / Rocky8 / Alma8 / Anolis8</td>
<td style="text-align:center"><code>el8.x86_64</code></td>
<td style="text-align:center"><i class="fas fa-circle-check text-primary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><code>el8.arm64</code></td>
<td style="text-align:right"><i class="fas fa-circle-check text-primary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
</tr>
<tr>
<td style="text-align:center"><strong>U24</strong></td>
<td>Ubuntu 24.04 (<code>noble</code>)</td>
<td style="text-align:center"><code>u24.x86_64</code></td>
<td style="text-align:center"><i class="fas fa-circle-check text-primary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><code>u24.arm64</code></td>
<td style="text-align:right"><i class="fas fa-circle-check text-primary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
</tr>
<tr>
<td style="text-align:center"><strong>U22</strong></td>
<td>Ubuntu 22.04 (<code>jammy</code>)</td>
<td style="text-align:center"><code>u22.x86_64</code></td>
<td style="text-align:center"><i class="fas fa-circle-check text-primary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><code>u22.arm64</code></td>
<td style="text-align:right"><i class="fas fa-circle-check text-primary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
</tr>
<tr>
<td style="text-align:center"><strong>D12</strong></td>
<td>Debian 12 (<code>bookworm</code>)</td>
<td style="text-align:center"><code>d12.x86_64</code></td>
<td style="text-align:center"><i class="fas fa-circle-check text-primary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><code>d12.arm64</code></td>
<td style="text-align:right"><i class="fas fa-circle-check text-primary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-secondary"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
</tr>
<tr>
<td style="text-align:center"><strong>D11</strong></td>
<td>Debian 11 (<code>bullseye</code>)</td>
<td style="text-align:center"><code>d12.x86_64</code></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><code>d11.arm64</code></td>
<td style="text-align:right"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"><strong>U20</strong></td>
<td>Ubuntu 20.04 (<code>focal</code>)</td>
<td style="text-align:center"><code>d12.x86_64</code></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><code>u20.arm64</code></td>
<td style="text-align:right"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"><strong>EL7</strong></td>
<td>RHEL7 / CentOS7 / UOS &hellip;</td>
<td style="text-align:center"><code>d12.x86_64</code></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><i class="fas fa-circle-check text-danger"></i></td>
<td style="text-align:center"><code>el7.arm64</code></td>
<td style="text-align:right"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<blockquote>
<p><i class="fas fa-circle-check text-primary"></i> = 首要版本支持；<i class="fas fa-circle-check text-secondary"></i> = 配置可选支持； <i class="fas fa-circle-check text-danger"></i> = 过期版本商业支持</p>
</blockquote>
<hr>
<h2 id="arm-支持">ARM 支持</h2>
<p>ARM 架构最近不断攻城略地，尤其是在云计算领域，ARM 服务器的市场份额正在逐渐增加。早在俩年前，就有用户提出对 ARM 架构支持的需求。
其实 Pigsty 在早先做 “国产化系统” 适配的时候，就已经有一个 ARM 支持了。但是在开源版本中提供 ARM64 架构支持，v3.1 版本是第一次。</p>
<p>当然，目前的版本，ARM 还处在一个 Beta 状态：功能是有了，也能跑通，但是到底效果怎么样还是要跑一段时间，有了反馈才知道。</p>
<p>目前 Pigsty 的主体功能已经都完成适配了，比如 Grafana / Prometheus  全家桶这些我也都打好了 ARM 的软件包，
尚未支持的部分主要是 PG 扩展 —— 特指由 Pigsty 维护的 140 个扩展 —— 目前还没有提供 ARM 支持，已经在做了。
不过，如果你用到的扩展都是 PGDG 中已经提供的（比如 postgis, pgvector 这种），那么没有问题。</p>
<p>目前，ARM 版本在 EL9，Debian 12，Ubuntu 22.04 上运行状态良好。
EL8 有一些PGDG官方包缺失，Ubuntu24有个别扩展缺失，所以目前还不建议在这两个系统上使用 ARM 版本。</p>
<p>我准备将 ARM 试点运行一两个小版本，当扩展齐全之后，我会将其标记为 GA。欢迎各位朋友试用 ARM 版本并向我提出反馈意见。</p>
<hr>
<h2 id="配置简化">配置简化</h2>
<p>另一个在 Pigsty v3.1 中进行的显著改进是配置简化，如何管理不同操作系统发行版，大小版本的软件包差异一直是一个比较让人头疼的问题。</p>
<p>比如，因为很多操作系统发行版上的包名，可用软件集合其实是有一些区别的，所以在此前的版本里，Pigsty 会根据每个操作系统发行版生成一个独立的配置文件。
但是这样很快就会出现排列组合爆炸，比如，Pigsty 默认提供十几种场景下的配置模板，如果每个模板都要针对 5 - 7 个 操作系统版本生成，那么总数就要爆炸了。</p>
<p>但计算机科学中的任何问题都可以通过增加一个间接层来解决，而这个问题呢也也不例外。在 v3.1 版本中，Pigsty 引入了一个新的配置文件 <code>package_map</code>，用于定义软件包的别名。
然后针对每个操作系统发行版，我们都会生成一个 <code>node_id/vars</code> 配置文件，将固定的包别名翻译为操作系统上具体的软件包列表。</p>
<p><img alt="config.png" src="/zh/blog/releases/v3.1.0/config.png"></p>
<p>比如，Supabase 自建模板中启用了几十个扩展，用户只需要提供扩展的名字就可以了，至于芯片架构，操作系统版本，PG版本，包名之类的细节差异全都在内部处理好了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg_extensions: <span style="color:#8f5902;font-style:italic"># extensions to be installed on this cluster</span>
</span></span><span style="display:flex;"><span>- supabase   <span style="color:#8f5902;font-style:italic"># essential extensions for supabase</span>
</span></span><span style="display:flex;"><span>- timescaledb postgis pg_graphql pg_jsonschema wrappers pg_search pg_analytics pg_parquet plv8 duckdb_fdw pg_cron pg_timetable pgqr
</span></span><span style="display:flex;"><span>- supautils pg_plan_filter passwordcheck plpgsql_check pgaudit pgsodium pg_vault pgjwt pg_ecdsa pg_session_jwt index_advisor
</span></span><span style="display:flex;"><span>- pgvector pgvectorscale pg_summarize pg_tiktoken pg_tle pg_stat_monitor hypopg pg_hint_plan pg_http pg_net pg_smtp_client pg_idkit
</span></span></code></pre></div><p>举个例子，如果你想下载安装 PG 16 的内核与扩展，以前你需要把下载列表和安装列表里的包全换成16的版本，现在你只需要简单的修改一个 <code>pg_version</code> 参数就行了。
最后的效果非常好，基本实现了所有操作系统发行版都能使用相同的配置文件进行安装，将不同系统的差异与管理复杂度都隐藏在了内部。</p>
<hr>
<h2 id="基础设施改进">基础设施改进</h2>
<p>除了功能上的改进之外，我们还在不断改善基础设施。例如在 v3.0 引入的安装 MSSQL 兼容的 Babelfish 内核，Oracle 兼容的 IvorySQL 内核，以及国产 PolarDB 内核，都要求用户使用一个外部仓库在线安装。</p>
<p>现在，Pigsty 官方仓库直接提供了 Babelfish，IvorySQL，PolarDB 等内核的镜像仓库，安装这些“异国风味”PG替换内核变得更加简单了 —— 现在的效果就是，不需要什么额外的配置，使用预置模板一键安装即可。</p>
<p>此外，我们还维护着 Prometheus 与 Grafana 的 YUM/ATP x AMD/ARM 软件仓库，并实时跟进这些可观测性组件的版本。在这次升级中，Prometheus 升级到了 v3 大版本，而 VictoriaLogs 也正式发布了 v1 版本。
总的来说，如果你需要用到这些监控软件，Pigsty 的仓库也能帮到您。</p>
<hr>
<h2 id="minio-改进">MinIO 改进</h2>
<p>最后我们来聊一下开源对象存储自建，MinIO。
Pigsty 将 MinIO 用作 PostgreSQL 的备份存储，与 Supabase 的底层存储服务，
并致力于将 MinIO 的部署门槛压低到有手就行 —— Deploy in minutes, Scale to millions。</p>
<p>在我们最早内部使用 MinIO 的时候，还是 0.x 的版本，而从那时到现在 MinIO 也有了很大的进步。
当年我们用 MinIO 存 25 PB 数据，因为 MinIO 不支持在线扩容，所以只能拆出了七八个独立集群依次使用。
而现在 MinIO 虽然仍然不能在线修改磁盘/节点数量，但可以通过添加存储池 - 迁移 - 淘汰旧存储池的方式实现平滑扩容了。</p>
<p><img alt="minio.png" src="/zh/blog/releases/v3.1.0/minio.png"></p>
<p>在 Pigsty v3.1 中，我重新通读了 MinIO 的文档，并根据新版本的特性调整了 MinIO 的最佳实践配置模板与SOP。
除了之前的 MinIO 单机单盘，单机多盘，多机多盘模式，我们还支持了多存储池部署模式，并提供了 Pigsty 中 MinIO 的管理预案 ——
包括磁盘故障，节点故障的处理，集群上下线，存储扩缩容，使用 VIP 与 HAProxy 对外提供高可用接入的方案，全都有据可查，几行命令就能轻松解决。</p>
<p>对象存储是云上的基石性服务，MinIO 作为开源对象存储的代表，其性能与功能都非常优秀，更重要的是，它是一个云中立的开源软件。</p>
<p>您也可以使用 MinIO 来替代云上的对象存储服务，正如《<a href="https://mp.weixin.qq.com/s/mknFXO5DSfxw7st8hhxjBQ">DHH：下云超预期，能省一个亿</a>》所述，
他们云上有 10PB 的对象存储（列表价每年300万），SavingPlan打折后每年130万美元，合 93万人民币 / PB·年。
而 1.2 PB的专用存储服务器一台十几万人民币上下，三副本冗余， 整几台套上MinIO就是对象存储了。
再加上网电运维，整个五年TCO 也超不过云上一年的折后消费，所以这里蕴含着惊人的降本增效潜力。
如果你的的业务在大量使用对象存储，那么本地 MinIO 自建 + Cloudflare 可能是非常值得考虑的一个更优解。</p>
<hr>
<h2 id="服务体系">服务体系</h2>
<p>Pigsty v3.1 达到了一个我比较满意的状态，接下来我的工作重心会放在服务体系的构建上。</p>
<p>Pigsty 是个开源免费的软件，它已经解决了 PG 运维中会遇到的绝大多数问题。如果你自己是开源老司机，真遇上疑难杂症自己也可以解决。
但是对于一些大型企业用户，特别是那些没有专职 DBA 的企业来说，还是需要有人来“兜底”的，毕竟，开源软件的核心就是 NO WARRANTY。</p>
<p>正如《<a href="https://mp.weixin.qq.com/s/E0MtNxPVMQ4PAkIFmispTw">PolarDB20块好兄弟：数据库到底应该卖什么价</a>》中所述，体面数据库服务其实是有市场公允价的，一般在 <strong>1~2万人民币 / vCPU·年</strong>。
不论你是去买 Oracle 的服务支持，还是 EDB，Fujitsu 的开源PG服务，或者是 AWS 的 RDS / Aurora ，其实都是这个价位。</p>
<p>之前我定的服务价格太低，已经引起海内外同行微词 —— 乃这不是破坏市场，低价倾销吗？你作为国内顶级PG专家定这个价还公开，让我们怎么办。</p>
<p><img alt="price.png" src="/zh/blog/releases/v3.1.0/price.png"></p>
<p>所以这次我也重新调整了一下定价体系，基本锚定业界平均定价水平。反正这也是你情我愿的双向选择，欢迎有兴趣的朋友们选购专业服务，打钱支持！新人新办法，老客老价格。</p>
<hr>
<h2 id="v310">v3.1.0</h2>
<p><strong>亮点特性</strong></p>
<ul>
<li>PostgreSQL 17 现已成为默认使用的主要版本 (17.2)</li>
<li>Ubuntu 24.04 系统支持</li>
<li>arm 架构支持：EL9, Debian12, Ubuntu 22.04</li>
<li>Supabase 一键自建，新的剧本 <code>supabase.yml</code></li>
<li>MinIO 最佳实践改进，配置模板与 Vagrant 模板</li>
<li>提供了一系列开箱即用的配置模板与文档说明。</li>
<li>允许在 <code>configure</code> 过程中使用 <code>-v|--version</code> 指定使用的 PG 大版本。</li>
<li>调整 PG 默认插件策略：默认安装 <code>pg_repack</code>, <code>wal2json</code> 以及 <code>pgvector</code> 三个关键扩展。</li>
<li>大幅简化 <code>repo_packages</code> 本地软件源构建逻辑，允许在 <code>repo_packages</code> 中使用软件包组别名</li>
<li>提供了 WiltonDB，IvorySQL，PolarDB 的软件源镜像，简化三者的安装。</li>
<li>默认启用数据库校验和。</li>
<li>修复 ETCD 与 MINIO 日志面板</li>
</ul>
<p><strong>软件升级</strong></p>
<ul>
<li>PostgreSQL 17.2, 16.6, 15.10, 14.15, 13.18, 12.22</li>
<li>PostgreSQL 扩展版本变动请参考：https://ext.pigsty.io</li>
<li>Patroni 4.0.4</li>
<li>MinIO 20241107 / MCLI 20241117</li>
<li>Rclone 1.68.2</li>
<li>Prometheus: 2.54.0 -&gt; 3.0.0</li>
<li>VictoriaMetrics 1.102.1 -&gt; 1.106.1</li>
<li>VictoriaLogs v0.28.0 -&gt; 1.0.0</li>
<li>vslogcli 1.0.0</li>
<li>MySQL Exporter 0.15.1 -&gt; 0.16.0</li>
<li>Redis Exporter 1.62.0 -&gt; 1.66.0</li>
<li>MongoDB Exporter 0.41.2 -&gt; 0.42.0</li>
<li>Keepalived Exporter 1.3.3 -&gt; 1.4.0</li>
<li>DuckDB 1.1.2 -&gt; 1.1.3</li>
<li>etcd 3.5.16 -&gt; 3.5.17</li>
<li>tigerbeetle 16.8 -&gt; 0.16.13</li>
</ul>
<p><strong>API变更</strong></p>
<ul>
<li><code>repo_upstream</code>: 针对每个具体的操作系统发行版生成默认值：<a href="https://github.com/Vonng/pigsty/tree/main/roles/node_id/vars"><code>roles/node_id/vars</code></a></li>
<li><code>repo_packages</code>: 允许使用 <code>package_map</code> 中定义的别名。</li>
<li><code>repo_extra_packages</code>: 新增未指定时的默认值，允许使用 <code>package_map</code> 中定义的别名。</li>
<li><code>pg_checksum</code>: 默认值修改为 <code>true</code>，默认打开。</li>
<li><code>pg_packages</code>: 默认值修改为：<code>postgresql, wal2json pg_repack pgvector, patroni pgbouncer pgbackrest pg_exporter pgbadger vip-manager</code></li>
<li><code>pg_extensions</code>: 默认值修改为空数组 <code>[]</code>。</li>
<li><code>infra_portal</code>: 允许为 <code>home</code> 服务器指定 <code>path</code>，替代默认的本地仓库路径 <code>nginx_home</code> (<code>/www</code>)</li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-e7e4e4c92d83a217d8bda0fa106a91e3">v3.0：海量扩展，插拔内核，RDS服务</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a> | <a href="https://github.com/Vonng/pigsty/releases/tag/v3.0.0">发行注记</a></b> |
        
		<time datetime="2024-08-25" class="text-muted">2024年08月25日</time>
        
	</div>
	<hr>
<h3 id="亮点特性">亮点特性</h3>
<p><strong>扩展大爆炸</strong>：</p>
<p>Pigsty v3 提供了史无前例的 <a href="/zh/docs/pgext/list"><strong>340</strong></a> 个可用扩展插件。
包括 <strong>121</strong> 个扩展 <a href="/zh/docs/pgext/list/rpm/"><strong>RPM包</strong></a> 与 <strong>133</strong> 个 <a href="/zh/docs/pgext/list/deb/"><strong>DEB包</strong></a>，数量已经超过了 PGDG 官方仓库提供的扩展数量总和（135 RPM/ 109 DEB）。
而且，Pigsty 还将EL系统与Debian生态的独有PG扩展插件相互移植，实现了两大发行版的插件生态大对齐。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#000">timescaledb periods temporal_tables emaj table_version pg_cron pg_later pg_background pg_timetable</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">postgis pgrouting pointcloud pg_h3 q3c ogr_fdw geoip #pg_geohash</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#mobilitydb</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">pgvector pgvectorscale pg_vectorize pg_similarity pg_tiktoken pgml</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#smlar</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">pg_search pg_bigm zhparser hunspell</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">hydra pg_lakehouse pg_duckdb duckdb_fdw pg_fkpart pg_partman plproxy</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#pg_strom citus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">pg_hint_plan age hll rum pg_graphql pg_jsonschema jsquery index_advisor hypopg imgsmlr pg_ivm pgmq pgq</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#rdkit</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">pg_tle plv8 pllua plprql pldebugger plpgsql_check plprofiler plsh</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#pljava plr pgtap faker dbt2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">prefix semver pgunit md5hash asn1oid roaringbitmap pgfaceting pgsphere pg_country pg_currency pgmp numeral pg_rational pguint ip4r timestamp9 chkpass #pg_uri #pgemailaddr #acl #debversion</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#pg_rrule</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">topn pg_gzip pg_http pg_net pg_html5_email_address pgsql_tweaks pg_extra_time pg_timeit count_distinct extra_window_functions first_last_agg tdigest aggs_for_arrays pg_arraymath pg_idkit pg_uuidv7 permuteseq pg_hashids</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">sequential_uuids pg_math pg_random pg_base36 pg_base62 floatvec pg_financial pgjwt pg_hashlib shacrypt cryptint pg_ecdsa pgpcre icu_ext envvar url_encode #pg_zstd #aggs_for_vecs #quantile #lower_quantile #pgqr</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#pg_protobuf</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">pg_repack pg_squeeze pg_dirtyread pgfincore pgdd ddlx pg_prioritize pg_checksums pg_readonly safeupdate pg_permissions pgautofailover pg_catcheck preprepare pgcozy pg_orphaned pg_crash pg_cheat_funcs pg_savior table_log pg_fio</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#pgpool pgagent</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">pg_profile pg_show_plans pg_stat_kcache pg_stat_monitor pg_qualstats pg_store_plans pg_track_settings pg_wait_sampling system_stats pg_meta pgnodemx pg_sqlog bgw_replstatus pgmeminfo toastinfo pagevis powa pg_top #pg_statviz #pgexporter_ext</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#pg_mon</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">passwordcheck supautils pgsodium pg_vault anonymizer pg_tde pgsmcrypto pgaudit pgauditlogtofile pg_auth_mon credcheck pgcryptokey pg_jobmon logerrors login_hook set_user pg_snakeoil pgextwlist pg_auditor noset</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#sslutils</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">wrappers multicorn mysql_fdw tds_fdw sqlite_fdw pgbouncer_fdw mongo_fdw redis_fdw pg_redis_pubsub kafka_fdw hdfs_fdw firebird_fdw aws_s3 log_fdw #oracle_fdw</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#db2_fdw</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">orafce pgtt session_variable pg_statement_rollback pg_dbms_metadata pg_dbms_lock pgmemcache #pg_dbms_job</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#wiltondb</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">pglogical pgl_ddl_deploy pg_failover_slots wal2json wal2mongo decoderbufs decoder_raw mimeo pgcopydb pgloader pg_fact_loader pg_bulkload pg_comparator pgimportdoc pgexportdoc #repmgr</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#slony</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">gis-stack rag-stack fdw-stack fts-stack etl-stack feat-stack olap-stack supa-stack stat-stack json-stack</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>换内核</strong>：</p>
<p>Pigsty v3 允许您更换 PostgreSQL 内核，目前支持了 SQL Server 兼容的 Babelfish （线缆协议级仿真），Oracle 兼容的 IvorySQL，以及 PG 版的 RAC PolarDB；此外，现在自托管 Supabase 也在 Debian 系统中可用。
您可以让 Pigsty 中带有 HA，IaC，PITR，监控的生产级 PostgreSQL 集群仿真 MSSQL (via WiltonDB)，Oracle via (IvorySQL)，Oracle RAC (via PolarDB), MongoDB（via FerretDB），以及 Firebase （via Supabase）。</p>
<p><strong>企业版</strong>：</p>
<p>我们现在提供 Pigsty Pro <a href="/zh/docs/price"><strong>专业版</strong></a>，在开源版的功能基础上提供增值服务。专业版提供额外的功能模块：MSSQL，Oracle，Mongo，K8S，Victoria，Kafka，TigerBeetle 等……，并提供更广泛的 PG 大版本、操作系统、芯片架构的支持。
提供针对全系操作系统精准小版本定制的离线安装包，以及 EL7，Debian 11，Ubuntu 20.04 等过保老系统的支持；此外，专业版还提供内核可插拔定制服务，并对PolarDB PG/Oracle 的原生部署、监控管控支持以满足“国产化”需要。</p>
<p>使用以下命令<a href="/zh/docs/setup/install"><strong>快速安装</strong></a>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -fsSL https://repo.pigsty.cc/get <span style="color:#000;font-weight:bold">|</span> bash
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty<span style="color:#000;font-weight:bold">;</span> ./bootstrap<span style="color:#000;font-weight:bold">;</span> ./configure<span style="color:#000;font-weight:bold">;</span> ./install.yml
</span></span></code></pre></div><hr>
<h3 id="重大变更">重大变更</h3>
<p>本次 Pigsty 发布调整大版本号，从 2.x 升级到 3.0，带有一些重大变更：</p>
<ul>
<li>
<p>首要支持操作系统调整为：EL 8 / EL 9 / Debian 12 / Ubuntu 22.04</p>
<ul>
<li>EL7 / Debian 11 / Ubuntu 20.04 等系统进入弃用阶段，不再提供支持</li>
<li>有在这些系统上运行需求的用户请考虑我们的 <a href="https://pigsty.io/zh/docs/price">订阅服务</a></li>
</ul>
</li>
<li>
<p>默认使用在线安装，不再提供离线软件包，从而解决操作系统小版本兼容性问题。</p>
<ul>
<li><code>bootstrap</code> 过程现在不再询问是否下载离线安装包，但如果 <code>/tmp/pkg.tgz</code> 存在，仍然会自动使用离线安装包。</li>
<li>有离线安装需求请自行制作离线软件包或考虑我们的 <a href="https://pigsty.io/zh/docs/about/service">订阅服务</a></li>
</ul>
</li>
<li>
<p>Pigsty 使用的上游软件仓库进行统一调整，地址变更，并对所有软件包进行 GPG 签名与校验</p>
<ul>
<li>标准仓库： <code>https://repo.pigsty.io/{apt/yum}</code></li>
<li>国内镜像： <code>https://repo.pigsty.cc/{apt/yum}</code></li>
</ul>
</li>
<li>
<p>API 参数变更与配置模板变更</p>
<ul>
<li>EL 系与 Debian 系配置模板现在收拢统一，有差异的参数统一放置于 <a href="https://github.com/Vonng/pigsty/tree/master/roles/node_id/vars"><code>roles/node_id/vars/</code></a> 目录进行管理。</li>
<li>配置目录变更，所有配置文件模板统一放置在 <code>conf</code> 目录下，并分为 <code>default</code>, <code>dbms</code>, <code>demo</code>, <code>build</code> 四大类。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="其他新特性">其他新特性</h3>
<ul>
<li>PG OLAP 分析能力史诗级加强：DuckDB 1.0.0，DuckDB FDW，以及 PG Lakehouse，Hydra 移植至 Deb 系统中。</li>
<li>PG 向量检索与全文检索能力加强：Vectorscale 提供 DiskANN 向量索引，Hunspell 分词字典支持，pg_search 0.9.1。</li>
<li>帮助 ParadeDB 解决了软件包构建问题，现在我们在 Debian/Ubuntu 上也能提供这一扩展。</li>
<li>Supabase 所需的扩展在 Debian/Ubuntu 上全部可用，Supabase 现在可在全OS上自托管。</li>
<li>提供了场景化预置扩展堆栈的能力，如果您不知道安装哪些扩展，我们准备了针对特定应用场景的扩展推荐包（Stack）。</li>
<li>针对所有 PostgreSQL 生态的扩展，制作了元数据表格、文档、索引、名称映射，针对 EL与Deb 进行对齐，确保扩展可用性。</li>
<li>为了解决 DockerHub 被 Ban 的问题，我们加强了 <code>proxy_env</code> 参数的功能并简化其配置方式。</li>
<li>建设了一个专用的新软件仓库，提供了 12-17 版本的全部扩展插件，其中，PG16的扩展仓库会在 Pigsty 默认的版本中实装。</li>
<li>现有软件仓库升级改造，使用标准的签名与校验机制，确保软件包的完整性与安全性。APT 仓库采用新的标准布局通过 <code>reprepro</code> 构建。</li>
<li>提供了 1,2,3,4,43 节点的沙箱环境：<code>meta</code>, <code>dual</code>, <code>trio</code>, <code>full</code>, <code>prod</code>，以及针对 7 大 OS Distro 的快捷配置模板。</li>
<li>PG Exporter 新增了 PostgreSQL 17 与 pgBouncer 1.23 新监控指标收集器的定义，与使用这些指标的 Grafana Panel</li>
<li>监控面板修缮，修复了各种问题，为 PGSQL Pgbouncer 与 PGSQL Patroni 监控面板添加了日志仪表盘。</li>
<li>使用全新的 <code>cache.yml</code> Ansible 剧本，替换了原有制作离线软件包的 <code>bin/cache</code> 与 <code>bin/release-pkg</code> 脚本。</li>
</ul>
<hr>
<h3 id="api变更">API变更</h3>
<ul>
<li>新参数选项： <code>pg_mode</code> 现在支持的模式有 <code>pgsql</code>, <code>citus</code>, <code>gpsql</code>, <code>mssql</code>, <code>ivory</code>, <code>polar</code>，用于指定 PostgreSQL 集群的模式
<ul>
<li><code>pgsql</code>： 标准 PostgreSQL 高可用集群</li>
<li><code>citus</code>： Citus 水平分布式 PostgreSQL 原生高可用集群</li>
<li><code>gpsql</code>： 用于 Greenplum 与 GP 兼容数据库的监控（专业版）</li>
<li><code>mssql</code>： 安装 WiltonDB / Babelfish，提供 Microsoft SQL Server 兼容性模式的标准 PostgreSQL 高可用集群，线缆协议级支持，扩展不可用</li>
<li><code>ivory</code>： 安装 IvorySQL 提供的 Oracle 兼容性 PostgreSQL 高可用集群，Oracle语法/数据类型/函数/存储过程兼容，扩展不可用 （专业版）</li>
<li><code>polar</code>： 安装 PolarDB for PostgreSQL （PG RAC）开源版本，提供国产化数据库能力支持，扩展不可用。（专业版）</li>
</ul>
</li>
<li>新参数： <code>pg_parameters</code>，用于在实例级别指定 <code>postgresql.auto.conf</code> 中的参数，覆盖集群配置，实现不同实例成员的个性化配置。</li>
<li>新参数： <code>pg_files</code>，用于将额外的文件拷贝到PGDATA数据目录，针对需要License文件的商业版PostgreSQL分叉内核设计。</li>
<li>新参数： <code>repo_extra_packages</code>，用于额外指定需要下载的软件包，与 <code>repo_packages</code> 共同使用，便于指定OS版本独有的扩展列表。</li>
<li>参数重命名： <code>patroni_citus_db</code> 重命名为 <code>pg_primary_db</code>，用于指定集群中的主要数据库（在 Citus 模式中使用）</li>
<li>参数强化：<code>proxy_env</code> 中的代理服务器配置会写入 Docker Daemon，解决科学上网问题，<code>configure -x</code> 选项会自动在配置中写入当前环境中的代理服务器配置。</li>
<li>参数强化：<code>repo_url_packages</code> 中的 <code>repo.pigsty.io</code> 会在区域为中国时自动替换为 <code>repo.pigsty.cc</code>，解决科学上网问题，此外，现在可以指定下载后的文件名称。</li>
<li>参数强化：<code>pg_databases.extensions</code> 中的 <code>extension</code> 字段现在可以支持字典与扩展名字符串两种模式，字典模式提供 <code>version</code> 支持，允许安装特定版本的扩展。</li>
<li>参数强化：<code>repo_upstream</code> 参数如果没有显式覆盖定义，将从 <a href="https://github.com/Vonng/pigsty/blob/master/roles/node_id/vars/rpm.yml"><code>rpm.yml</code></a> 或 <a href="https://github.com/Vonng/pigsty/blob/master/roles/node_id/vars/rpm.yml"><code>deb.yml</code></a> 中定义的 <code>repo_upstream_default</code> 提取对应系统的默认值。</li>
<li>参数强化：<code>repo_packages</code> 参数如果没有显式覆盖定义，将从 <a href="https://github.com/Vonng/pigsty/blob/master/roles/node_id/vars/rpm.yml"><code>rpm.yml</code></a> 或 <a href="https://github.com/Vonng/pigsty/blob/master/roles/node_id/vars/rpm.yml"><code>deb.yml</code></a> 中定义的 <code>repo_packages_default</code> 提取对应系统的默认值。</li>
<li>参数强化：<code>infra_packages</code> 参数如果没有显式覆盖定义，将从 <a href="https://github.com/Vonng/pigsty/blob/master/roles/node_id/vars/rpm.yml"><code>rpm.yml</code></a> 或 <a href="https://github.com/Vonng/pigsty/blob/master/roles/node_id/vars/rpm.yml"><code>deb.yml</code></a> 中定义的 <code>infra_packages_default</code> 提取对应系统的默认值。</li>
<li>参数强化：<code>node_default_packages</code> 参数如果没有显式覆盖定义，将从 <a href="https://github.com/Vonng/pigsty/blob/master/roles/node_id/vars/rpm.yml"><code>rpm.yml</code></a> 或 <a href="https://github.com/Vonng/pigsty/blob/master/roles/node_id/vars/rpm.yml"><code>deb.yml</code></a> 中定义的 <code>node_packages_default</code> 提取对应系统的默认值。</li>
<li>参数强化：<code>pg_packages</code> 与 <code>pg_extensions</code> 中的扩展现在都会从  <a href="https://github.com/Vonng/pigsty/blob/master/roles/node_id/vars/rpm.yml"><code>rpm.yml</code></a> 或 <a href="https://github.com/Vonng/pigsty/blob/master/roles/node_id/vars/rpm.yml"><code>deb.yml</code></a> 中定义的 <code>pg_package_map</code> 执行一次查找与翻译。</li>
<li>参数强化：<code>node_packages</code> 与 <code>pg_extensions</code> 参数中指定的软件包在安装时会升级至最新版本， <code>node_packages</code> 中现在默认值变为 <code>[openssh-server</code>]，帮助修复 <a href="https://pigsty.io/zh/blog/db/cve-2024-6387/">OpenSSH CVE</a></li>
<li>参数强化：<code>pg_dbsu_uid</code> 会自动根据操作系统类型调整为 <code>26</code> （EL）或 <code>543</code> （Debian），避免了手工调整。</li>
<li>Boostrap 逻辑变化，不再下载离线软件包，添加 <code>-k|--keep</code> 参数，用于指定在本地安装 ansible 时是否保留现有的软件源。</li>
<li>Configure 移除了 <code>-m|--mode</code> 参数，使用 <code>-m|--conf</code> 参数指定配置文件，使用 <code>-x|--proxy</code> 参数指定代理服务器配置，不再尝试修复 ssh 本机问题。</li>
<li>设置了 pgbouncer 默认参数，<code>max_prepared_statements = 128</code> 启用了事物池化模式下的准备语句支持，并设置 <code>server_lifetime</code> 为 600，</li>
<li>修改了 patroni 模板默认参数，统一增大 <code>max_worker_processes</code> +8 可用后端进程，提高 <code>max_wal_senders</code> 与 <code>max_replication_slots</code> 至 50，并增大 OLAP 模板临时文件的大小限制为主磁盘的 1/5</li>
</ul>
<hr>
<h3 id="版本升级">版本升级</h3>
<p>截止至发布时刻，Pigsty 主要组件的版本升级如下：</p>
<ul>
<li><a href="https://www.postgresql.org/about/news/postgresql-164-158-1413-1316-1220-and-17-beta-3-released-2910/"><strong>PostgreSQL</strong></a> 16.4, 15.8, 14.13, 13.16, 12.20</li>
<li><a href="https://github.com/Vonng/pg_exporter">pg_exporter</a> : 0.7.0</li>
<li><a href="https://patroni.readthedocs.io/en/latest/">Patroni</a>: 3.3.2</li>
<li><a href="https://www.pgbouncer.org/2024/08/pgbouncer-1-23-1">pgBouncer</a>: 1.23.1</li>
<li><a href="https://pgbackrest.org/release.html#2.53.1">pgBackRest</a>: 2.53.1</li>
<li><a href="https://github.com/duckdb/duckdb">duckdb</a> : 1.0.0</li>
<li><a href="https://github.com/etcd-io/etcd">etcd</a> : 3.5.15</li>
<li><a href="https://github.com/cybertec-postgresql/pg_timetable">pg_timetable</a>: 5.9.0</li>
<li><a href="https://github.com/FerretDB/FerretDB">ferretdb</a>: 1.23.1</li>
<li><a href="https://github.com/cybertec-postgresql/vip-manager">vip-manager</a>: 2.6.0</li>
<li><a href="https://github.com/minio/minio">minio</a>: 20240817012454</li>
<li><a href="https://github.com/minio/mc">mcli</a>: 20240817113350</li>
<li><a href="https://github.com/grafana/grafana/">grafana</a> : 11.1.4</li>
<li><a href="https://github.com/grafana/loki">loki</a> : 3.1.1</li>
<li><a href="https://github.com/grafana/loki">promtail</a> : 3.0.0</li>
<li><a href="https://github.com/prometheus/prometheus">prometheus</a> : 2.54.0</li>
<li><a href="https://github.com/prometheus/pushgateway">pushgateway</a> : 1.9.0</li>
<li><a href="https://github.com/prometheus/alertmanager">alertmanager</a> : 0.27.0</li>
<li><a href="https://github.com/prometheus/blackbox_exporter">blackbox_exporter</a> : 0.25.0</li>
<li><a href="https://github.com/nginxinc/nginx-prometheus-exporter">nginx_exporter</a> : 1.3.0</li>
<li><a href="https://github.com/prometheus/node_exporter">node_exporter</a> : 1.8.2</li>
<li><a href="https://github.com/gen2brain/keepalived_exporter">keepalived_exporter</a> : 0.7.0</li>
<li><a href="https://github.com/woblerr/pgbackrest_exporter">pgbackrest_exporter</a> 0.18.0</li>
<li><a href="https://github.com/prometheus/mysqld_exporter">mysqld_exporter</a> : 0.15.1</li>
<li><a href="https://github.com/oliver006/redis_exporter">redis_exporter</a> : v1.62.0</li>
<li><a href="https://github.com/danielqsj/kafka_exporter">kafka_exporter</a> : 1.8.0</li>
<li><a href="https://github.com/percona/mongodb_exporter">mongodb_exporter</a> : 0.40.0</li>
<li><a href="https://github.com/VictoriaMetrics/VictoriaMetrics">VictoriaMetrics</a> : 1.102.1</li>
<li><a href="https://github.com/VictoriaMetrics/VictoriaMetrics/releases">VictoriaLogs</a> : v0.28.0</li>
<li><a href="https://github.com/labring/sealos">sealos</a>: 5.0.0</li>
<li><a href="https://github.com/vectordotdev/vector/releases">vector</a> : 0.40.0</li>
</ul>
<p>Pigsty 重新编译了所有 PostgreSQL 扩展插件，PostgreSQL 扩展插件的最新版本，请参考 <a href="/zh/docs/pgext/list/">扩展列表</a></p>
<hr>
<h3 id="新应用">新应用</h3>
<p>Pigsty 现在提供开箱即用的 Dify 与 Odoo Docker Compose 模板：</p>
<ul>
<li><a href="/zh/docs/software/dify">Dify</a>： AI智能体工作流编排与 LLMOps</li>
<li><a href="/zh/docs/software/odoo">Odoo</a>： 企业级开源 ERP 系统</li>
</ul>
<p>Pigsty 专业版现在提供试点的 Kubernetes 部署支持与 Kafka KRaft 集群部署与监控支持</p>
<ul>
<li><strong><code>KUBE</code></strong>： 使用 cri-dockerd 或 containerd 部署由 Pigsty 托管的 Kubernetes 集群</li>
<li><strong><code>KAFKA</code></strong>：部署由 Kraft 协议支持的高可用 Kafka 集群</li>
</ul>
<hr>
<h3 id="问题修复">问题修复</h3>
<ul>
<li>通过 <code>node_packages</code> 中的默认值 <code>[openssh-server</code>]，<a href="https://pigsty.io/zh/blog/db/cve-2024-6387/">CVE-2024-6387</a> 可以在 Pigsty 安装过程中被自动修复。</li>
<li>修复了 Loki 解析 Nginx 日志标签基数过大导致的内存消耗问题。</li>
<li>修复了 EL8 系统中上游 Ansible 依赖变化导致的 bootstrap 失效问题（python3.11-jmespath 升级至 python3.12-jmespath）</li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-39e2c61ab8b91d698dfa3ef858800027">v2.7：集异璧之大成</h1>
	
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）| <a href="https://mp.weixin.qq.com/s/CzNUNAVnafO-hMCMdfxgZA">微信公众号</a></b> |
        
		<time datetime="2024-05-21" class="text-muted">2024年05月21日</time>
        
	</div>
	<p>2024-05-20，Pigsty v2.7 发布了。在这个版本中收录的可用扩展插件数量，达到了惊人的 <strong>255</strong> 个，成功让 PostgreSQL 的<strong>全能性</strong>又达到了一个全新高度！</p>
<p>同时，我们提供了一些新的 Docker 应用模板，例如开源的企业 ERP 软件全家桶 —— <strong>Odoo</strong>，<strong>Jupyter</strong> Notebook，并率先提供了 <strong>Supabase</strong> GA 版本的支持。
同时，我们还为后续容器版本的推出扫清了障碍；提供了帮助用户应付国产信创检查的方案 —— PolarDB 支持；并正式进行了专业版与开源版的产品功能区分。</p>
<ul>
<li><a href="/zh/blog/releases/v2.7.0/#扩展尽入吾彀中">扩展尽入吾彀中！</a></li>
<li><a href="/zh/blog/releases/v2.7.0/#pg集异璧之大成">PG集异璧之大成</a></li>
<li><a href="/zh/blog/releases/v2.7.0/#国产信创数据库？">国产信创数据库？</a></li>
<li><a href="/zh/blog/releases/v2.7.0/#开箱即用的erp">开箱即用的ERP</a></li>
<li><a href="/zh/blog/releases/v2.7.0/#pitr与监控面板">PITR与监控面板</a></li>
<li><a href="/zh/blog/releases/v2.7.0/#专业版与开源版">专业版与开源版</a></li>
</ul>
<hr>
<h2 id="扩展尽入吾彀中">扩展尽入吾彀中</h2>
<p>在《<a href="/zh/blog/pg/pg-eat-db-world">PostgreSQL正在吞噬数据库世界</a>》一文中，我抛出了一个观点：PostgreSQL 并不是一个简单的关系型数据库，而是一个数据管理的抽象框架，具有囊括一切，吞噬整个数据库世界的力量。</p>
<p>而 PG 之所以能做到这一点，除了<strong>开源</strong>、<strong>先进</strong>这两点外，真正的秘诀在于 <strong>扩展</strong> —— <strong>极致可扩展性，与繁荣的扩展生态</strong> 是 PostgreSQL 独一无二的特点，也是它从无数数据库中脱颖而出的法宝与秘诀。</p>
<p>因此，在 Pigsty v2.7 版本中，我们重新审视了整个 PostgreSQL 生态的所有扩展插件，将其中一些佼佼者收录其中，我们新收录的扩展如下：</p>
<table>
<thead>
<tr>
<th>扩展</th>
<th style="text-align:center">版本</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/supabase/pg_jsonschema">pg_jsonschema</a></td>
<td style="text-align:center">0.3.1</td>
<td>提供JSON Schema校验能力</td>
</tr>
<tr>
<td><a href="https://github.com/supabase/wrappers">wrappers</a></td>
<td style="text-align:center">0.3.1</td>
<td>Supabase提供的外部数据源包装器捆绑包</td>
</tr>
<tr>
<td><a href="https://github.com/alitrack/duckdb_fdw">duckdb_fdw</a></td>
<td style="text-align:center">1.1</td>
<td>DuckDB 外部数据源包装器 (libduck 0.10.2)</td>
</tr>
<tr>
<td><a href="https://github.com/paradedb/paradedb/tree/dev/pg_search">pg_search</a></td>
<td style="text-align:center">0.7.0</td>
<td>ParadeDB BM25算法全文检索插件，ES全文检索</td>
</tr>
<tr>
<td><a href="https://github.com/paradedb/paradedb/tree/dev/pg_lakehouse">pg_lakehouse</a></td>
<td style="text-align:center">0.7.0</td>
<td>ParadeDB 湖仓分析引擎</td>
</tr>
<tr>
<td><a href="https://github.com/paradedb/pg_analytics">pg_analytics</a></td>
<td style="text-align:center">0.6.1</td>
<td>加速 PostgreSQL 内部的分析查询处理</td>
</tr>
<tr>
<td><a href="https://github.com/tembo-io/pgmq">pgmq</a></td>
<td style="text-align:center">1.5.2</td>
<td>轻量级消息队列，类似于 AWS SQS 和 RSMQ.</td>
</tr>
<tr>
<td><a href="https://github.com/tembo-io/pg_tier">pg_tier</a></td>
<td style="text-align:center">0.0.3</td>
<td>支将将冷数据分级存储到 AWS S3</td>
</tr>
<tr>
<td><a href="https://github.com/tembo-io/pg_vectorize">pg_vectorize</a></td>
<td style="text-align:center">0.15.0</td>
<td>在 PG 中实现 RAG 向量检索的封装</td>
</tr>
<tr>
<td><a href="https://github.com/tembo-io/pg_later">pg_later</a></td>
<td style="text-align:center">0.1.0</td>
<td>现在执行 SQL，并在稍后获取结果</td>
</tr>
<tr>
<td><a href="https://github.com/VADOSWARE/pg_idkit">pg_idkit</a></td>
<td style="text-align:center">0.2.3</td>
<td>生成各式各样的唯一标识符：UUIDv6, ULID, KSUID</td>
</tr>
<tr>
<td><a href="https://github.com/kaspermarstal/plprql">plprql</a></td>
<td style="text-align:center">0.1.0</td>
<td>在PostgreSQL使用PRQL——管线式关系查询语言</td>
</tr>
<tr>
<td><a href="https://github.com/zhuobie/pgsmcrypto">pgsmcrypto</a></td>
<td style="text-align:center">0.1.0</td>
<td>为PostgreSQL提供商密算法支持：SM2,SM3,SM4</td>
</tr>
<tr>
<td><a href="https://github.com/kelvich/pg_tiktoken">pg_tiktoken</a></td>
<td style="text-align:center">0.0.1</td>
<td>计算 OpenAI 使用的 Token 数量</td>
</tr>
<tr>
<td><a href="https://github.com/rustprooflabs/pgdd">pgdd</a></td>
<td style="text-align:center">0.5.2</td>
<td>提供通过标准SQL查询数据库目录集簇的能力</td>
</tr>
<tr>
<td><a href="https://github.com/pgspider/parquet_s3_fdw">parquet_s3_fdw</a></td>
<td style="text-align:center">1.1.0</td>
<td>针对S3/MinIO上的Parquet文件的外部数据源包装器</td>
</tr>
<tr>
<td><a href="https://github.com/plv8/plv8">plv8</a></td>
<td style="text-align:center">3.2.2</td>
<td>PL/JavaScript (v8) 可信过程程序语言</td>
</tr>
<tr>
<td><a href="https://github.com/tvondra/md5hash">md5hash</a></td>
<td style="text-align:center">1.0.1</td>
<td>提供128位MD5的原生数据类型</td>
</tr>
<tr>
<td><a href="https://github.com/Percona-Lab/pg_tde">pg_tde</a></td>
<td style="text-align:center">1.0-alpha</td>
<td>PostgreSQL 的实验性加密存储引擎。</td>
</tr>
<tr>
<td><a href="https://github.com/df7cb/pg_dirtyread">pg_dirtyread</a></td>
<td style="text-align:center">2.6</td>
<td>从 PostgreSQL 表中读取未清理的死元组，用于脏读</td>
</tr>
</tbody>
</table>
<p>这里面有许多使用 Rust 和 <strong>pgrx</strong> 开发的扩展插件，许多扩展都提供了非常强大的能力 —— 比如说：</p>
<hr>
<p>Supabase 出品的 <a href="https://github.com/supabase/wrappers"><strong>wrappers</strong></a> 看上去是一个扩展，但它其实提供了一个用 Rust 编写 FDW 的插件，提供了对<strong>十种</strong>外部数据源的包装访问！</p>
<table>
<thead>
<tr>
<th>FDW</th>
<th>Description</th>
<th>Read</th>
<th>Modify</th>
</tr>
</thead>
<tbody>
<tr>
<td>HelloWorld</td>
<td>A demo FDW to show how to develop a basic FDW.</td>
<td></td>
<td></td>
</tr>
<tr>
<td>BigQuery</td>
<td>A FDW for Google <a href="https://cloud.google.com/bigquery">BigQuery</a></td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>Clickhouse</td>
<td>A FDW for <a href="https://clickhouse.com/">ClickHouse</a></td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>Stripe</td>
<td>A FDW for <a href="https://stripe.com/">Stripe</a> API</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>Firebase</td>
<td>A FDW for Google <a href="https://firebase.google.com/">Firebase</a></td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td>Airtable</td>
<td>A FDW for <a href="https://airtable.com/">Airtable</a> API</td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td>S3</td>
<td>A FDW for <a href="https://aws.amazon.com/s3/">AWS S3</a></td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td>Logflare</td>
<td>A FDW for <a href="https://logflare.app/">Logflare</a></td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td>Auth0</td>
<td>A FDW for <a href="https://auth0.com/">Auth0</a></td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td>SQL Server</td>
<td>A FDW for <a href="https://www.microsoft.com/en-au/sql-server/">Microsoft SQL Server</a></td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td>Redis</td>
<td>A FDW for <a href="https://redis.io/">Redis</a></td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td>AWS Cognito</td>
<td>A FDW for <a href="https://aws.amazon.com/cognito/">AWS Cognito</a></td>
<td>✅</td>
<td>❌</td>
</tr>
</tbody>
</table>
<p>这意味着，你现在可以用 PostgreSQL <strong>读写</strong> BigQuery, ClickHouse, 以及支付服务 Stripe 数据了。Firebase，Airtable，S3，Logflare，Auth0，SQL Server，Redis，Cognito 也提供了通过 PostgreSQL ，使用 SQL 读取的能力。</p>
<hr>
<p>再比如 <a href="https://prql-lang.org/"><strong><code>plprql</code></strong></a> 扩展，提供了一种类似于 SQL 的全新数据库查询语言 PRQL：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">invoices</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">filter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">invoice_date</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#0000cf;font-weight:bold">1970</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">01</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">derive</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">transaction_fees</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">income</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">total</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">transaction_fees</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">filter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">income</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">group</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">customer_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">aggregate</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">average</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">total</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">sum_income</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">income</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">ct</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">total</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">sort</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">sum_income</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">take</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">join</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">customers</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#000">customer_id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">derive</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">f</span><span style="color:#4e9a06">&#34;{c.last_name}, {c.first_name}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">customer_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sum_income</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">derive</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">db_version</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#4e9a06">&#34;version()&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>同时，新加入 Pigsty 的 <strong>plv8</strong> 扩展，允许你使用 Javascript 在 PostgreSQL 中编写存储过程，PostgreSQL 的存储过程语言支持之丰富，实在是让人惊叹！</p>
<p><img src="/zh/blog/releases/v2.7.0/pl.png"></p>
<hr>
<p>再比如说 <strong>parquet_s3_fdw</strong> ，看上去只是让你访问 S3 上存储的 Parquet 文件，但它的意义是 —— PG 可以成为真正的湖仓了 —— 等效于新增了一个没有存储容量限制的分析引擎！</p>
<p>构建在它基础上的 <a href="https://github.com/tembo-io/pg_tier"><strong><code>pg_tier</code></strong></a> ，更是提供了便利的分级冷存储功能 —— 你可以将 PG 中很少访问的海量冷存储，用 SQL 轻松归档到 S3 / MinIO 上去！</p>
<p>如果您觉得仅仅是 Parquet 太不过瘾，那么由 ParadeDB 提供的 <a href="https://github.com/paradedb/paradedb/tree/dev/pg_lakehouse"><strong><code>pg_lakehouse</code></strong></a>，则把这件事拔高到了一个新高度 —— 你现在可以直接将PG作为湖仓使用，读取 S3 / MinIO / 本地文件系统上的 Parquet，CSV，JSON，Avro，DeltaLake，以及 后续的 ORC 格式文件，用于湖仓数据分析！</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_lakehouse</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOREIGN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DATA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">WRAPPER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3_wrapper</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">HANDLER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3_fdw_handler</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VALIDATOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3_fdw_validator</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Provide S3 credentials
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SERVER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3_server</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOREIGN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DATA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">WRAPPER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3_wrapper</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">OPTIONS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">region</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;us-east-1&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_anonymous</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;true&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Create foreign table
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOREIGN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">trips</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;VendorID&#34;</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87">INT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;tpep_pickup_datetime&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">TIMESTAMP</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;tpep_dropoff_datetime&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TIMESTAMP</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;passenger_count&#34;</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87">BIGINT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;trip_distance&#34;</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000">DOUBLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRECISION</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;RatecodeID&#34;</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#000">DOUBLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRECISION</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;store_and_fwd_flag&#34;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;PULocationID&#34;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87">REAL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;DOLocationID&#34;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87">REAL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;payment_type&#34;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">DOUBLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRECISION</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;fare_amount&#34;</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#000">DOUBLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRECISION</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;extra&#34;</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#000">DOUBLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRECISION</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;mta_tax&#34;</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#000">DOUBLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRECISION</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;tip_amount&#34;</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#000">DOUBLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRECISION</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;tolls_amount&#34;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">DOUBLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRECISION</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;improvement_surcharge&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DOUBLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRECISION</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;total_amount&#34;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">DOUBLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRECISION</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">SERVER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3_server</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">OPTIONS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;s3://paradedb-benchmarks/yellow_tripdata_2024-01.parquet&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">extension</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;parquet&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- Success! Now you can query the remote Parquet file like a regular Postgres table
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">COUNT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">trips</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">---------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2964624</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>当然，同样由 ParadeDB 出品的 <strong>pg_analytics</strong> 与 <strong>pg_search</strong> 扩展也非常值得一提，前者提供了第一梯队的分析性能，而后者提供了 ElasticSearch BM25 全文检索能力的的 PG 替代品。</p>
<p>此外，Tembo 也提供了四个使用 Rust 编写的实用 PG 扩展，例如，他们出品的 <strong>pgmq</strong> 就可以在 PG 上提供一个轻量的消息队列 API，类似于 AWS 的 SQS 与 RSMQ，作为 <strong>pgq</strong> 的替代与补充。</p>
<hr>
<p>在 AI 人工智能方向上，<a href="https://github.com/pgvector/pgvector"><strong>pgvector</strong></a> 0.7 引入了重大的升级，现在支持稀疏向量（让 <strong>pg_sparse</strong> 原地退役了！），支持 <strong>half</strong> <strong>float</strong> 量化，向量最大维度翻倍到了 <strong>4000</strong> 维，添加了 <strong>binary</strong> 量化模式（维度可达 64K ），添加了两种新的距离度量与相应的索引。最重要的是，现在还支持用 SIMD 指令了，性能相比一年前有了翻天覆地的改善！</p>
<blockquote>
<ul>
<li>Added halfvec type</li>
<li>Added sparsevec type</li>
<li>Added support for indexing bit type</li>
<li>Added support for indexing L1 distance with HNSW</li>
<li>Added binary_quantize function</li>
<li>Added hamming_distance function</li>
<li>Added jaccard_distance function</li>
<li>Added l2_normalize function</li>
<li>Added subvector function</li>
<li>Added concatenate operator for vectors</li>
<li>Added CPU dispatching for distance functions on Linux x86-64</li>
<li>Updated comparison operators to support vectors with different dimensions</li>
</ul>
</blockquote>
<blockquote>
<p><a href="https://github.com/pgvector/pgvector/blob/master/CHANGELOG.md">v0.7 changelog</a></p>
</blockquote>
<p>当然，还有其他一些 AI 相关的扩展插件，例如 <strong>pg_vectorize</strong> 可以帮助你封装实现一个 RAG 服务，新的 <strong>pg_tiktoken</strong> 可以帮助你在 PG 中，计算调用 OpenAI 模型时所需的 Token 数量。此外，<strong>pg_similarity</strong> 可以提供17种额外的距离度量函数，<strong>imgsmlr</strong> 可以提供图片相似度处理函数, <strong>bigm</strong> 可以提供基于二元组的全文检索支持, <strong>zhparser</strong> 可以提供中文分词能力。</p>
<hr>
<p>在新的数据类型支持上，<strong>md5hash</strong> 允许你直接高效存储 128 位的 MD5 摘要，而不是一长串字符文本。 <strong>pg_idkit</strong> 允许你在数据库中直接生成十多种不同类型的 ID 方案（UUIDv6, UUIDv7, nanoid, ksuid, ulid, Timeflake, PushID, xid, cuid, cuid 等），<strong>rrule</strong> 扩展更是允许你在数据库中存储、解析、处理“日历重复事件”这一神奇的数据类型。</p>
<hr>
<p>此外，还有一些扩展，能在数据库管理上提供帮助。<strong>pgdd</strong> 允许你直接使用 SQL ，管理与访问 PG 的数据库目录，<strong>pg_later</strong> 允许你异步执行 SQL 命令并取回结果。<strong>pg_dirtyread</strong> 允许你进行脏读，读取尚未被垃圾回收的数据，进行数据抢救，<strong>pg_show_plans</strong> 可以显示出当前正在运行查询的执行计划！</p>
<p>在加密能力上，<strong>pg_tde</strong> 扩展提供了一个实验性的PG透明加密的存储引擎，用于确保即使你的硬盘被人拔了，数据也不会泄漏。 <strong>pgsmcrypto</strong> 则为 PostgreSQL 提供了 “国产数据库” 的商密算法（SM2,3,4）支持。</p>
<hr>
<h2 id="pg集异璧之大成">PG集异璧之大成</h2>
<p>加上 <a href="https://mp.weixin.qq.com/s/y3qY9eBfOic6tQYOiErIHg">以前的扩展</a>，在 Pigsty v2.7 中，在所有操作系统上可用的 PG 扩展数量达到了 <strong>255</strong> 个之多。
我们可以自豪地说，在整个 PostgreSQL 生态中，没有一个发行版或者服务提供商，能达到我们的收录的这个扩展数量：</p>
<p><img src="/zh/blog/releases/v2.7.0/extensions.png"></p>
<p>在EL系操作系统上，总共有 <strong>230</strong> 个可用的 RPM 扩展插件，其中包括 73 个 PG 自带的扩展和 157 个第三方扩展，其中由 Pigsty 维护的占 34 个。
在 Debian 与 Ubuntu 系操作系统上，总共有 <strong>189</strong> 个可用的 DEB 扩展插件，其中包括 73 个 PG 自带的扩展和 116 个第三方扩展，其中由 Pigsty 维护的占 10 个。</p>
<blockquote>
<p>完整的扩展列表，请参考 <a href="https://pigsty.cc/zh/docs/reference/extension"><strong>扩展列表</strong></a></p>
</blockquote>
<p>所有的扩展，被我们按照功能与用途分为了 <strong>11</strong> 个大类，方便用户根据主题选用：</p>
<table>
<thead>
<tr>
<th style="text-align:left">类目</th>
<th style="text-align:left">扩展</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">TYPE</td>
<td style="text-align:left">pg_uuidv7, pgmp, semver, timestamp9, uint, roaringbitmap, unit, prefix, md5hash, ip4r, asn1oid, pg_rrule, pg_rational, debversion, numeral, pgfaceting</td>
</tr>
<tr>
<td style="text-align:left">GIS</td>
<td style="text-align:left">pointcloud, pgrouting, h3, address_standardizer_data_us, postgis_tiger_geocoder, postgis_topology, postgis_raster, postgis_sfcgal, address_standardizer, postgis, h3_postgis, pointcloud_postgis, geoip, mobilitydb</td>
</tr>
<tr>
<td style="text-align:left">SHARD</td>
<td style="text-align:left">pg_fkpart, pg_partman, plproxy, citus</td>
</tr>
<tr>
<td style="text-align:left">TEST</td>
<td style="text-align:left">pgtap, faker, dbt2</td>
</tr>
<tr>
<td style="text-align:left">SEARCH</td>
<td style="text-align:left">pg_bigm, pg_search, zhparser</td>
</tr>
<tr>
<td style="text-align:left">ETL</td>
<td style="text-align:left">pg_bulkload, wal2json, pg_fact_loader, decoderbufs</td>
</tr>
<tr>
<td style="text-align:left">REPL</td>
<td style="text-align:left">pglogical_origin, pglogical, repmgr, londiste, mimeo, pglogical_ticker</td>
</tr>
<tr>
<td style="text-align:left">SEC</td>
<td style="text-align:left">pgaudit, pgsodium, anon, passwordcracklib, supabase_vault, pgauditlogtofile, set_user, login_hook, pgcryptokey, pg_jobmon, logerrors, pg_auth_mon, pgsmcrypto, pg_tde, credcheck, table_log, pg_snakeoil</td>
</tr>
<tr>
<td style="text-align:left">OLAP</td>
<td style="text-align:left">pg_lakehouse, duckdb_fdw, citus_columnar, parquet_s3_fdw, columnar, pg_analytics, timescaledb, pg_tier</td>
</tr>
<tr>
<td style="text-align:left">FUNC</td>
<td style="text-align:left">count_distinct, pgsql_tweaks, tdigest, topn, pgjwt, pg_net, extra_window_functions, http, gzip, pg_later, pg_idkit, pg_background, pgpcre, first_last_agg, icu_ext, q3c, pg_sphere</td>
</tr>
<tr>
<td style="text-align:left">FDW</td>
<td style="text-align:left">hdfs_fdw, mysql_fdw, pgbouncer_fdw, mongo_fdw, sqlite_fdw, tds_fdw, ogr_fdw, oracle_fdw, multicorn, db2_fdw, wrappers</td>
</tr>
<tr>
<td style="text-align:left">LANG</td>
<td style="text-align:left">plpgsql_check, plsh, pllua, plr, plluau, pldbgapi, plv8, plprql, pg_tle, pljava, hstore_plluau, hstore_pllua, omnidb_plpgsql_debugger</td>
</tr>
<tr>
<td style="text-align:left">SIM</td>
<td style="text-align:left">orafce, pg_extra_time, pgmemcache, pg_dbms_job, mysqlcompat, pg_dbms_metadata, pg_dbms_lock</td>
</tr>
<tr>
<td style="text-align:left">ADMIN</td>
<td style="text-align:left">pg_readonly, pg_squeeze, pgfincore, pgl_ddl_deploy, prioritize, ddlx, pgagent, pg_repack, pg_cron, pgpool_recovery, pgpool_regclass, pgpool_adm, pg_dirtyread, pgdd, pgautofailover, safeupdate, toastinfo</td>
</tr>
<tr>
<td style="text-align:left">STAT</td>
<td style="text-align:left">pg_permissions, pg_qualstats, pg_stat_kcache, pg_stat_monitor, pg_track_settings, pg_wait_sampling, plprofiler, powa, pgexporter_ext, system_stats, pg_store_plans, pgmeminfo, pg_profile, pg_show_plans, pg_statviz</td>
</tr>
<tr>
<td style="text-align:left">AI</td>
<td style="text-align:left">pg_tiktoken, imgsmlr, svector, pg_similarity, pgml, vectorize, vector</td>
</tr>
<tr>
<td style="text-align:left">FEAT</td>
<td style="text-align:left">periods, pg_ivm, jsquery, hll, pgtt, rum, pg_hint_plan, age, temporal_tables, table_version, pg_graphql, pgq, pgmq, pg_strom, pg_jsonschema, hypopg, emaj, pgq_node, pre_prepare, rdkit</td>
</tr>
</tbody>
</table>
<p>这些扩展之间，许多都可以相互组合使用，产生协同效应，产生 1+1 &raquo; 2 的神奇效果。</p>
<p>正如 TimescaleDB CEO Ajay 在 《<a href="/zh/blog/pg/pg-for-everything">为什么PostgreSQL是未来数据的基石？</a>》 一文中所述，<strong>PostgreSQL 正在成为事实上的数据库标准</strong>。</p>
<p>通过极致可扩展性的魔法，PostgreSQL <strong>集异璧之大成</strong>，做到了守正出奇，实现了主干极致稳定性与功能敏捷性的统一**。**扎实的基本盘配上惊人的演进速度，让它成为了数据库世界中的一个异数，彻底改变了数据库世界的游戏规则。</p>
<p>时至当下，PostgreSQL 已是不可挡。而 Pigsty 让 PostgreSQL 如虎添翼，插上一对起飞的翅膀。</p>
<hr>
<h2 id="国产信创数据库">国产信创数据库？</h2>
<p>在中国做数据库赛道，绕不开的一个问题就是“<strong>国产化</strong>”与“信创”。关于这个主题，我已经写过很多文章深入探讨过了：</p>
<ul>
<li>《<a href="https://mp.weixin.qq.com/s/hWbcc9cMM9qTjPJ0m6G0Kg">基础软件需要什么样的自主可控？</a>》</li>
<li>《<a href="https://mp.weixin.qq.com/s/AqcYpOgVj91JnkB1B3s4sA">国产数据库到底能不能打？</a>》</li>
<li>《<a href="https://mp.weixin.qq.com/s/aLXC7f2iYUfATNWsnyotkA">国产数据库是大炼钢铁吗？</a>》</li>
<li>《<a href="https://mp.weixin.qq.com/s/79_PnX-a5iSfDMgz_VUx5A">中国对PostgreSQL的贡献约等于零吗？</a>》</li>
<li>《<a href="https://mp.weixin.qq.com/s/xHG8OURTYlmnQTorFkzioA">EL系操作系统发行版哪家强？</a>》</li>
</ul>
<p>我的观点是：整个国产信创数据库行业完全基于一个事实上根本不成立的假设 —— 所谓 “数据库卡脖子” 的风险。在开源的 PostgreSQL 面前，所谓卡脖子是个伪命题
—— 如果被欧美严厉制裁的俄国企业们数据库没有崩溃，中国也完全可以同样拿 PG 做同样的事，而不是弄出一堆换皮魔改或土法炼钢的劣质轮子出来。</p>
<p>许多国产数据库都是这样的：企业花点钱买一套“国产xxx”放在那里，上面来检查了，就拿出来糊弄一下，实际上该用啥还是继续用啥（我要给这种务实的态度点个赞！👍）
但是很多时候，即使客户想要用的就是原生 PG，但没有一块 “<strong>国产</strong>” 的牌子，确实是很难走立项采购流程的，我们就有一些客户面临这样让人头大的难题。</p>
<p>不过大部分用户也不愿意当傻狍子和冤大头，许多有国产化要求的企业都是这样的：花点钱买一套“国产xxx”放在那里，上面来检查了，就拿出来糊弄一下，实际上该用啥还是继续用啥（我要给这种务实的态度点个赞！👍）
但是很多时候，即使客户想要用的就是原生 PG，但没有一块 “<strong>国产</strong>” 的牌子，确实是很难走立项采购流程的，我们就有一些客户面临这样让人头大的难题。</p>
<p>因此，我们想了一个绝妙的折衷办法 —— PolarDB for PostgreSQL。根据 【<a href="http://www.itsec.gov.cn/aqkkcp/cpgg/202312/t20231226_162074.html">安全可靠测评结果公告（2023年第1号）</a>】，附表三、集中式数据库：
PolarDB 属于自主可控，安全可靠的国产信创数据库。（中国信息安全测评中心-产品测评公告，证书编号：<a href="http://www.itsec.gov.cn/cp/cpcpgg/202205/t20220510_107153.html">CNITSEC2022I&amp;OE0047</a>）</p>
<table>
<thead>
<tr>
<th>中国信息安全测评中心-产品测评公告</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>证号：</td>
<td>CNITSEC2022I&amp;OE0047</td>
</tr>
<tr>
<td>发证日期：</td>
<td>2022-04-26</td>
</tr>
<tr>
<td>截至时间：</td>
<td>2025-04-25</td>
</tr>
<tr>
<td>产品名称：</td>
<td>阿里云PolarDB V2.0内核核心模块</td>
</tr>
<tr>
<td>厂商：</td>
<td>阿里云计算有限公司</td>
</tr>
<tr>
<td>认证级别：</td>
<td>自主原创</td>
</tr>
<tr>
<td>认证评价：</td>
<td></td>
</tr>
</tbody>
</table>
<p>最妙的是，PolarDB PG 是开源的。所以 Pigsty 提供了对 PolarDB PG 的完整监控支持，以及使用 Docker 进行部署的能力，可以帮助客户快速拉起一个“国产数据库”稻草人，无论是应付检查，还是作为立项采购的名头，都非常好用！
而且相对于其他那些过时落后，魔改的亲妈都不认识的杂种 PG 国产库，PolarDB 的含 P 量很高，所以如果想用，真的是可以拿来当成一个 PG 11 用起来的。</p>
<p>最后说点实际的，如果你问我，有什么功能是“国产数据库”有，而 PostgreSQL 没有的，我还真知道一个 —— 所谓的 “商密” 算法。最主要的是三个：
用于替代 RSA 的 SM2 算法，用于替代 MD5/SHA 的 SM3 算法，用于替代 DES/AES 的 SM4 算法。但现在，原生的 PostgreSQL 也可以通过 <code>smcrypto</code> 扩展插件也可以提供商密算法支持了！</p>
<hr>
<h2 id="开箱即用的erp">开箱即用的ERP</h2>
<p>与 “国产数据库” 类似，许多国产 ERP 软件也是处在一个很尴尬的位置上，因为已经有一个足够好的开源 ERP 系统了 —— <strong>Odoo</strong> （原名 OpenERP）。</p>
<p>不少 Pigsty 的用户是拿着 PG 去跑 Odoo 的，这引起了我的好奇，于是我也混入了 Odoo 社区学习，也自己搭了一套试了一把，确实非常牛逼，要是早点试试这么好的东西，就不去折腾什么土法建站了。</p>
<p><img alt="odoo-intro.png" src="/zh/blog/releases/v2.7.0/odoo-intro.png"></p>
<blockquote>
<p>Odoo 插件非常多，功能强大远超我想象，堪称企业应用全家桶大王。</p>
</blockquote>
<p>作为开源免费的软件，Odoo靠高级扩展插件收钱，这个订阅价格也不算贵。要是一分都不想花，Odoo社区也提供了这些高级扩展插件的免费开源平替版本… —— 高级付费插件（比如财务模块）也有社区开源版！</p>
<p><img alt="odoo-module.png" src="/zh/blog/releases/v2.7.0/odoo-module.png"></p>
<p>Odoo 使用，且仅使用了 PostgreSQL 作为数据存储。整套 ERP 软件，只需要一个 PG 数据库，一个 Docker 镜像就可以搞定了！堪称是 PostgreSQL 杀手级应用的典范。</p>
<p>作为一个 PostgreSQL 发行版，我没理由不去支持 Odoo。因此在 Pigsty v2.7 中提供了一个 Docker Compose 模板，可以一键拉起 Odoo。你还可以复用 Pigsty 提供的基础设施，轻松通过 Nginx 对外暴露 Web 服务，提供 HTTPS 接入。</p>
<p>最后能实现的效果是，在一台裸虚拟机上，你只需要几行命令就可以拉起生产质量的企业级 ERP 系统！关于 Odoo ，后面我会专门出一期教程，介绍如何利用 Pigsty 自建 ERP 系统。</p>
<hr>
<h2 id="pitr与监控面板">PITR与监控面板</h2>
<p>像 Odoo 这样的 ERP 系统，对数据库的要求与传统互联网行业非常不一样。例如：我在 Odoo 社区看到了如下对话：“<em>我的 Odoo 已经用了好几年了，现在 PostgreSQL 里的数据量已经到 2.5GB 了</em>”，下面朋友回复 —— “<em>那真的是非常大了！</em>”</p>
<p>2.5 GB的数据量，对于互联网规模的应用来说简直是微不足道。但是对于一个 ERP 系统来说，这已经是一个非常大的数据库了。比起性能 &amp; 高可用，像 ERP 这样的系统更关注的是数据完整性与机密性，很多时候，也就是拿一台服务器就跑起来了，不要 HA，只要有备份与 <strong>时间点恢复</strong> （PITR） 就行。</p>
<p>Pigsty 已经提供了开箱即用的 PITR ，允许用户回滚到任意时间点。但是这个过程所需的信息和反馈却散落在监控系统中的不同角落中，因此在 Pigsty v2.7 中，Pigsty 提供了一个专用的监控面板 PGSQL PITR，用于提供 PITR 时间点回复过程的上下文。</p>
<p><img alt="pitr.png" src="/zh/blog/releases/v2.7.0/pitr.png"></p>
<p>后面，我们会专门出一期教程，介绍如何利用 Pigsty 的 <a href="/zh/docs/concept/pitr"><strong>PITR</strong></a> 功能，实现企业级的数据备份与恢复。</p>
<hr>
<h2 id="开源版与专业版">开源版与专业版</h2>
<p>在 《<a href="https://mp.weixin.qq.com/s/NlNGwUXZPa058ZDk_tdtew">Pigsty v2.6：PostgreSQL 踢馆 OLAP</a>》 中，我已经提到过我们将区分 Pigsty 开源版与 <a href="/zh/docs/about/service/">专业版</a>。</p>
<p>在 Pigsty v2.7 中，我们将开源版支持的操作系统发行版收敛到 Redhat, Debian, Ubuntu 这三个主干上来。我们提供 PostgreSQL 16 在 EL8, Debian12, Ubuntu22.04 的第一类支持，并提供可以无需互联网进行安装的开源版离线软件包。
当然，EL7, EL9, Debian11, Ubuntu20.04 这些系统还是可以继续使用 Pigsty 的，但是不会有离线软件包，只能通过联网安装的模式进行首次部署。</p>
<div class="td-card-group card-group p-0 mb-4">

<div class="td-card card border me-4">
<div class="card-header">
      <strong>Pigsty 开源版</strong>
    </div>
<div class="card-body">
    <h5 class="card-title">
        开源免费！</h5>
    <h6 class="card-title ms-2 text-muted">
        自给自足的开源老司机</h6>
    <p class="card-text">
        

<p><b>PG支持：16</b></p>
<p><b>OS支持：三系主力版本</b><p>
<ul>
<li>EL 8.9</li>
<li>Debian 12</li>
<li>Ubuntu 22.04</li>
</ul>
<p><b>功能：<a href="/zh/docs/about/module#核心模块">核心模块</a></b></p>
<p><b>SLA：无</b></p>
<p><b>社区公益支持答疑</b></p>
<ul>
<li><a href="/zh/docs/about/community">微信讨论群组</a></li>
<li><a href="https://github.com/Vonng/pigsty/issues/">GitHub Issue</a></li>
<li><a href="https://discord.gg/j5pG8qfKxU">Discord Channel</a></li>
</ul>

</p>
      </div>
  <div class="card-footer">
      自给自足的开源老司机</div>
  </div>



<div class="td-card card border me-4">
<div class="card-header">
      <strong>Pigsty 基础版</strong>
    </div>
<div class="card-body">
    <h5 class="card-title">
        50,000 ¥ / 年</h5>
    <h6 class="card-title ms-2 text-muted">
        或 5,000 ¥/月</h6>
    <p class="card-text">
        

<p><b>PG支持：15，16</b></p>
<p><b>OS支持：五系最新小版本</b><p>
<ul>
<li>EL 7.9 / 8.9 / 9.3 </li>
<li>Ubuntu 20.04 / 22.04</li>
<li>Debian 11 / 12</li>
</ul>

<p><b>功能：<a href="/zh/docs/about/module">所有模块</a></b></p>
<p><b>SLA：工作日时效内响应</b></p>
<p><b>提供基础咨询服务：</b></p>
<ul>
<li>软件缺陷修复</li>
<li>疑难杂症分析</li>
<li>升级路径支持</li>
</ul>


</p>
      </div>
  <div class="card-footer">
      需要兜底的成熟团队</div>
  </div>


<div class="td-card card border me-4">
<div class="card-header">
      <strong>Pigsty 专业版</strong>
    </div>
<div class="card-body">
    <h5 class="card-title">
        150,000 ¥ / 年</h5>
    <h6 class="card-title ms-2 text-muted">
        或 15,000 ¥/月</h6>
    <p class="card-text">
        

<p><b>PG支持：12 - 16</b></p>
<p><b>OS支持：五系全部小版本</b><p>
<ul>
<li>EL 7.x / 8.x / 9.x </li>
<li>Ubuntu 20.x / 22.x</li>
<li>Debian 11.x / 12.x</li>
</ul>

<p><b>功能：<a href="/zh/docs/about/module">所有模块</a></b></p>
<p><b>SLA：5 x 8 (<4h)</b></p>
<p><b>提供专业咨询服务：</b></p>
<ul>
<li>软件缺陷修复</li>
<li>疑难杂症分析</li>
<li>升级路径支持</li>
<li>备份合规建议</li>
<li>DBA答疑解惑</li>
</ul>

</p>
      </div>
  <div class="card-footer">
      普通用户的默认之选</div>
  </div>




<div class="td-card card border me-4">
<div class="card-header">
      <strong>Pigsty 企业版</strong>
    </div>
<div class="card-body">
    <h5 class="card-title">
        400,000 ¥ / 年</h5>
    <h6 class="card-title ms-2 text-muted">
        或 40,000 ¥/月</h6>
    <p class="card-text">
        

<p><b>PG支持：9.0 - 16</b></p>
<p><b>OS支持：按需定制</b><p>
<ul>
<li>EL, Debian, Ubuntu</li>
<li>云上 Linux 操作系统</li>
<li>国产操作系统与ARM</li>
</ul>

<p><b>功能：<a href="/zh/docs/about/module">所有模块</a></b></p>
<p><b>SLA：7 x 24 (紧急on-call)</b></p>
<p><b>提供企业级咨询服务：</b></p>
<ul>
<li>软件缺陷修复</li>
<li>疑难杂症分析</li>
<li>升级路径支持</li>
<li>备份合规建议</li>
<li>DBA答疑解惑</li>
<li>故障根因定位</li>
<li>年度架构评估</li>
</ul>

</p>
      </div>
  <div class="card-footer">
      严格 SLA 的关键场景</div>
  </div>

</div>

<p>Pigsty 专业版与开源的区别主要在于兼容性与功能模块，例如 PostgreSQL 大版本支持范围，操作系统大版本支持范围，芯片架构支持范围。</p>
<p>在原本的功能设计中，开源版将只包括 INFRA, NODE, PGSQL, ETCD 四个与 PostgreSQL 服务紧密关联的核心模块，我纠结了很久是否要将 MinIO, Redis, FerretDB (Mongo), 以及 Docker 四个 <strong>扩展模块</strong> 划到专业版中，但最终还是决定将其保留在开源版里 —— 因为它们已经开源了，没道理再阉割掉。
但是与 PostgreSQL 相关性不大的其他模块以及后续的新功能模块，例如 Greenplum，MySQL，DuckDB，Kafka，Mongo, SealOS (Cloud) 都一定会划归专业版中。</p>
<p>在兼容性上，Pigsty 专业版将提供 PG完整生命周期 12 - 16 五个大版本，在七个主力大版本与其兼容系统上的支持，专业版采用按需定制的方式，交付专业版源码包，以及用户所需操作系统精准小版本的全功能离线软件安装包，包含所有生命周期内 PG 大版本的所有可用扩展插件。
另外，在这个版本中，我们自己维护了完整的 ARM64 Prometheus &amp; Grafana 软件源，也可以在专业版中提供 Arm64 的芯片架构支持了，如果有需要跑在 arm 服务器，或者 “国产芯片” 上，这是一个不错的特性。</p>
<p>总的来说，Pigsty v2.7 的开源/专业版区分，在不影响开源用户使用体验的前提下，又给了企业用户一个充分的付费理由 ；）。</p>
<hr>
<h2 id="展望未来">展望未来</h2>
<p>总的来说， Pigsty 已经达到我心目中比较理想的状态了。在功能上，它已经做的足够好了！在某些方面已经远超 RDS 了（比如扩展支持与监控系统）。</p>
<p>但正所谓，酒香也怕巷子深 —— 所以接下来的工作重点会更多地转移到运营、营销、销售上去。开源项目的持续运营离不开用户与客户的支持，如果 Pigsty 帮助到了您，欢迎考虑赞助我们，或采购我们的服务订阅～。</p>
<p>当然，说起运营 —— 就在下周，也就是五月28号，我将去温哥华参加 2024 PostgreSQL 开发者大会，a.k.a 第一届 PGConf.Dev （以前叫 PG Con）。共同探讨 PostgreSQL 的未来，并更进一步地把 Pigsty 推向全球！</p>
<hr>
<h2 id="v270-发布注记">v2.7.0 发布注记</h2>
<p><strong>亮点特性</strong></p>
<p>新增了大量强力扩展插件，特别是一些使用 <code>rust</code> 与 <code>pgrx</code> 进行开发的强力扩展：</p>
<ul>
<li><a href="https://github.com/paradedb/paradedb/tree/dev/pg_search">pg_search</a> v0.7.0：使用 BM25 算法对 SQL 表进行全文搜索</li>
<li><a href="https://github.com/paradedb/paradedb/tree/dev/pg_lakehouse">pg_lakehouse</a> v0.7.0：在对象存储（如 S3）和表格式（如 DeltaLake）上进行查询的引擎</li>
<li><a href="https://github.com/paradedb/pg_analytics">pg_analytics</a> v0.6.1：加速 PostgreSQL 内部的分析查询处理</li>
<li><a href="https://github.com/supabase/pg_graphql">pg_graphql</a> v1.5.4：为 PostgreSQL 数据库提供 GraphQL 支持</li>
<li><a href="https://github.com/supabase/pg_jsonschema">pg_jsonschema</a> v0.3.1：提供 JSON Schema 校验的 PostgreSQL 扩展</li>
<li><a href="https://github.com/supabase/wrappers">wrappers</a> v0.3.1：由 Supabase 提供的 PostgreSQL 外部数据封装器集合</li>
<li><a href="https://github.com/tembo-io/pgmq">pgmq</a> v1.5.2：轻量级消息队列，类似于 AWS SQS 和 RSMQ</li>
<li><a href="https://github.com/tembo-io/pg_tier">pg_tier</a> v0.0.3：支将将冷数据分级存储到 AWS S3</li>
<li><a href="https://github.com/tembo-io/pg_vectorize">pg_vectorize</a> v0.15.0: 在 PG 中实现 RAG 向量检索的封装</li>
<li><a href="https://github.com/tembo-io/pg_later">pg_later</a> v0.1.0：现在执行 SQL，并在稍后获取结果</li>
<li><a href="https://github.com/VADOSWARE/pg_idkit">pg_idkit</a> v0.2.3：生成多种流行类型的标识符（UUID）</li>
<li><a href="https://github.com/kaspermarstal/plprql">plprql</a> v0.1.0：在 PostgreSQL 中使用 PRQL 查询语言</li>
<li><a href="https://github.com/zhuobie/pgsmcrypto">pgsmcrypto</a> v0.1.0：PostgreSQL 的国密 SM 算法扩展</li>
<li><a href="https://github.com/kelvich/pg_tiktoken">pg_tiktoken</a> v0.0.1：计算 OpenAI 使用的 Token 数量</li>
<li><a href="https://github.com/rustprooflabs/pgdd">pgdd</a> v0.5.2：通过纯 SQL 接口，访问数据目录的元数据</li>
</ul>
<p>当然，也有一些使用原生 C 和 C++ 开发的强力扩展：</p>
<ul>
<li><a href="https://github.com/pgspider/parquet_s3_fdw">parquet_s3_fdw</a> 1.1.0：从 S3 存取 Parquet 格式文件，作为湖仓之用</li>
<li><a href="https://github.com/plv8/plv8">plv8</a> 3.2.2：使用 V8 引擎，允许在 PostgreSQL 中使用 Javascript 语言编写存储过程</li>
<li><a href="https://github.com/tvondra/md5hash">md5hash</a> 1.0.1：用于存储原生MD5哈希数据类型，而非文本。</li>
<li><a href="https://github.com/Percona-Lab/pg_tde">pg_tde</a> 1.0 alpha：PostgreSQL 的实验性加密存储引擎。</li>
<li><a href="https://github.com/df7cb/pg_dirtyread">pg_dirtyread</a> 2.6：从 PostgreSQL 表中读取未清理的死元组，用于脏读</li>
<li>新的 deb PGDG 扩展：<code>pg_roaringbitmap</code>, <code>pgfaceting</code>, <code>mobilitydb</code>, <code>pgsql-http</code>, <code>pg_hint_plan</code>, <code>pg_statviz</code>, <code>pg_rrule</code></li>
<li>新的 rpm PGDG 扩展：<code>pg_profile</code>, <code>pg_show_plans</code>, 使用 PGDG 的 <code>pgsql_http</code>, <code>pgsql_gzip</code>, <code>pg_net</code>, <code>pg_bigm</code> 替代 Pigsty 维护的 RPM。</li>
</ul>
<p><strong>新特性</strong></p>
<ul>
<li>允许 Pigsty 在特定 Docker 虚拟机镜像中运行。</li>
<li>针对 Ubuntu 与 EL 系操作系统发行版准备了 INFRA &amp; PGSQL 模块的 arm64 软件包</li>
<li>新安装脚本，可从 cloudflare 下载软件，可以指定版本，提供更完善的提示信息。</li>
<li>新增的 PGSQL PITR 监控面板，用于在 PITR 过程中提供更好的可观测性</li>
<li>针对在 Docker 虚拟机镜像中运行 Pigsty 进行了一系列铺垫与准备。</li>
<li>新增了 <a href="https://github.com/Vonng/pigsty/issues/402">防呆设计</a>，避免在非 Pigsty 纳管的节点上运行 pgsql.yml 剧本 （<a href="https://github.com/AdamYLK">AdamYLK</a>）</li>
<li>针对每个支持的发行版大版本配置了独立的配置文件：el7, el8, el9, debian11, debian12, ubuntu20, ubuntu22</li>
</ul>
<p><strong>Docker应用模板</strong></p>
<ul>
<li><a href="https://github.com/Vonng/pigsty/tree/master/app/odoo">Odoo</a>：开源 ERP 软件与插件</li>
<li><a href="https://github.com/Vonng/pigsty/tree/master/app/jupyter">Jupyter</a>：使用容器运行 Jupyter Notebook</li>
<li><a href="https://github.com/Vonng/pigsty/tree/master/app/polardb">PolarDB</a>：运行“国产数据库” PolarDB，应付信创检查！</li>
<li><a href="https://github.com/Vonng/pigsty/tree/master/app/supabase">supabase</a>：更新至最近的 GA 版本</li>
<li><a href="https://github.com/Vonng/pigsty/tree/master/app/bytebase">bytebase</a>：使用 <code>latest</code> 标签替代特定版本号。</li>
<li><a href="https://github.com/Vonng/pigsty/tree/master/app/pg_exporter">pg_exporter</a>：更新了 Docker 镜像的例子。</li>
</ul>
<p><strong>软件版本升级</strong></p>
<ul>
<li><strong>PostgreSQL 16.3</strong></li>
<li>Patroni 3.3.0</li>
<li>pgBackRest 2.51</li>
<li>VIP-Manager v2.5.0</li>
<li>Haproxy 2.9.7</li>
<li>Grafana 10.4.2</li>
<li>Prometheus 2.51</li>
<li>Loki &amp; Promtail: 3.0.0 (警告：大版本非兼容性变更！)</li>
<li>Alertmanager 0.27.0</li>
<li>BlackBox Exporter 0.25.0</li>
<li>Node Exporter 1.8.0</li>
<li>pgBackrest Exporter 0.17.0</li>
<li>duckdb 0.10.2</li>
<li>etcd 3.5.13</li>
<li>minio-20240510014138 / mcli-20240509170424</li>
<li>pev2 v1.8.0 -&gt; v1.11.0</li>
<li><strong>pgvector</strong> 0.6.1 -&gt; 0.7.0</li>
<li>pg_tle: v1.3.4 -&gt; v1.4.0</li>
<li>hydra: v1.1.1 -&gt; v1.1.2</li>
<li>duckdb_fdw: v1.1.0 重新针对 libduckdb 0.10.2 进行编译</li>
<li>pg_bm25 0.5.6 -&gt; pg_search 0.7.0</li>
<li>pg_analytics: 0.5.6 -&gt; 0.6.1</li>
<li>pg_graphql: 1.5.0 -&gt; 1.5.4</li>
<li>pg_net 0.8.0 -&gt; 0.9.1</li>
<li>pg_sparse (deprecated)</li>
</ul>
<p><strong>缺陷修复</strong></p>
<ul>
<li>修复了 pg_exporters 角色中的变量空白问题。</li>
<li>修复了 <code>minio_cluster</code> 变量没有在全局配置中注释掉的问题</li>
<li>修复了 EL7 模板中的 <code>postgis34</code> 插件名称问题，应该使用 <code>postgis33</code></li>
<li>修复了 EL8 <code>python3.11-cryptography</code> 依赖名的问题，上游现在变更为 <code>python3-cryptography</code>。</li>
<li>修复了 <code>/pg/bin/pg-role</code> 无法在非交互式 Shell 模式下获取操作系统用户名的问题</li>
<li>修复了 <code>/pg/bin/pg-pitr</code> 无法正确提示 <code>-X</code> <code>-P</code> 选项的问题</li>
</ul>
<p><strong>API变更</strong></p>
<ul>
<li>新参数 <code>node_write_etc_hosts</code>，用于控制是否向目标节点的 <code>/etc/hosts</code> 文件写入静态 DNS 解析记录</li>
<li>新增了 <code>prometheus_sd_dir</code> 参数，用于指定 Prometheus 静态服务发现的目标文件目录</li>
<li>configure 脚本新增了 <code>-x|--proxy</code> 参数，用于将当前环境的代理信息写入配置文件 by @waitingsong in <a href="https://github.com/Vonng/pigsty/pull/405">https://github.com/Vonng/pigsty/pull/405</a></li>
<li>不再使用 Promtail &amp; Loki 解析 Infra 节点上的 Nginx 日志细节标签，因为这样会导致标签基数爆炸。</li>
<li>在 Prometheus 配置中使用 alertmanager API v2 替代 v1</li>
<li>在 PGSQL 模块中，使用 <code>/pg/cert/ca.crt</code> 代替 <code>/etc/pki/ca.crt</code>，降低对节点根证书的依赖。</li>
</ul>
<p><strong>新的贡献者</strong></p>
<ul>
<li>@NeroSong made their first contribution in <a href="https://github.com/Vonng/pigsty/pull/373">https://github.com/Vonng/pigsty/pull/373</a></li>
<li>@waitingsong made their first contribution in <a href="https://github.com/Vonng/pigsty/pull/405">https://github.com/Vonng/pigsty/pull/405</a></li>
</ul>
<p><strong>完整的变更日志</strong>: <a href="https://github.com/Vonng/pigsty/compar">https://github.com/Vonng/pigsty/compar</a></p>
<p><strong>离线软件包校验和</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ec271a1d34b2b1360f78bfa635986c3a  pigsty-pkg-v2.7.0.el8.x86_64.tgz
</span></span><span style="display:flex;"><span>f3304bfd896b7e3234d81d8ff4b83577  pigsty-pkg-v2.7.0.debian12.x86_64.tgz
</span></span><span style="display:flex;"><span>5b071c2a651e8d1e68fc02e7e922f2b3  pigsty-pkg-v2.7.0.ubuntu22.x86_64.tgz
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-8057c0bc48b0902a8d3c8eeddea32e77">v2.6：PG 踢馆 OLAP</h1>
	<div class="lead">Pigsty v2.6 使用 PostgreSQL 16.2 作为了默认主版本，并引入了 ParadeDB 与 DuckDB 支持。</div>
	<div class="td-byline mb-4">
		By <b>Ruohang Feng（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2024-02-27" class="text-muted">2024年02月27日</time>
        
	</div>
	<p>二月的最后一天里，Pigsty v2.6 正式发布了 🎉。这个版本正式使用 PostgreSQL 16  作为默认的大版本，并引入了一系列全新的扩展，包括 <a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486913&idx=1&sn=3b7d8cf3f0e323932aba52c897f3c7a4&chksm=fe4b381ac93cb10cc6175c4c7978b5903946d369fe0084fbae5edf76ab08d84134260f28dffc&scene=21#wechat_redirect"><strong>ParadeDB</strong></a> 与 DuckDB ，让 PostgreSQL 的 OLAP 分析能力提高到一个全新的水准，喊一声 HTAP 标杆，数据库全能王当之无愧。</p>
<p>此外，我们还全面翻新了 Pigsty 官方网站、文档与博客，提出了更为凝练的六条核心价值主张。在全球范围内，我们使用了由 Cloudflare 支持的全新域名 <strong>pigsty.io</strong> 。作为默认的官方站地址与仓库地址。原有的 pigsty.cc 域名、网站、仓库继续在国内作为镜像提供服务。</p>
<p>最后，我们还正式推出了明码标价的 Pigsty 专业版与服务订阅，为那些需要更强支持力度的用户提供进阶功能与兜底选项。</p>
<hr>
<h2 id="分析性能史诗级加强">分析性能史诗级加强</h2>
<p>TPC-H 和 Clickbench 是分析领域的权威评测，Clickbench 上有许多 OLAP 数据库性能的横向对比，可以作为量化参考依据。例如在这个最有代表性的例子中，我们可以看到许多知名的数据库组件的相对性能表现（耗时越短越好）：</p>
<p><img alt="olap.jpg" src="/zh/blog/releases/v2.6.0/olap.jpg"></p>
<p>c6a.4xlarge, 500gb gp2 / 10亿条记录</p>
<p>在这张图表上我们标注出了 PostgreSQL 与生态扩展插件的性能表现。原生未经过调优的 PostgreSQL 耗时（<strong>x1000</strong>），调优后可以达到（<strong>x47</strong>），同时，PG生态还有三个与分析有关系的扩展：列存 <strong>Hydra</strong>（<strong>x42</strong>），时序扩展 <strong>TimescaleDB</strong>（<strong>x103</strong>），以及分布式扩展 <strong>Citus</strong>（<strong>x262</strong>）。但与专注于 OLAP 的第一梯队组件：Umbra，ClickHouse，Databend，SelectDB（<strong>x3~x4</strong>）相比仍然有十几倍的性能差距。然而最近出现的 <a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486913&idx=1&sn=3b7d8cf3f0e323932aba52c897f3c7a4&chksm=fe4b381ac93cb10cc6175c4c7978b5903946d369fe0084fbae5edf76ab08d84134260f28dffc&scene=21#wechat_redirect"><strong>ParadeDB</strong></a> 和 <strong>DuckDB</strong> 的出现改变了这一点！</p>
<p><strong>ParadeDB</strong> 提供的 PG 原生扩展 <strong>pg_analytics</strong> 实现了第二梯队（<strong>x10</strong>）的性能表现，与第一梯队的 OLAP 数据库只有 3～4 倍的性能差距。比起额外的好处来说：ACID，数据新鲜性，无需 ETL，额外学习成本，维护独立的新服务，（更别提它还提供了 ElasticSearch 质量的全文检索能力），这种性能差距通常是可以接受的。</p>
<p>而 <strong>DuckDB</strong> （<strong>x3.2</strong>）则把 OLAP 拔高到了一个全新高度 —— 抛开 Umbra 这种学术类研究数据库的用例，DuckDB 也许是 OLAP 实战性能最快的分析数据库。虽然说它并不是 PG 的扩展插件，但它是一个嵌入式组件，而 <strong>DuckDB FDW</strong> 以及 <strong>pg_quack</strong> 这样的项目能让 PostgreSQL 充分利用到 DuckDB 带来的完整分析性能红利！</p>
<p><img alt="duck.jpg" src="/zh/blog/releases/v2.6.0/duck.jpg"></p>
<p>来自 ParadeDB 创始人与 DuckdbFDW 作者的感谢致意</p>
<hr>
<h2 id="全新的价值主张">全新的价值主张</h2>
<p>价值主张是数据库发行版的灵魂，在这个版本中，我们提出了<strong>六条核心价值</strong>，如下图所示：</p>
<p><img alt="value1.jpg" src="/zh/blog/releases/v2.6.0/value1.jpg"></p>
<p>这张图列出了 PostgreSQL 要解决的六个核心问题：Postgres 的可扩展性，基础设施的可靠性，图形化的可观测性，服务的可用性，工具的可维护性，以及扩展模块和三方组件可组合性。</p>
<p><img alt="value2.jpg" src="/zh/blog/releases/v2.6.0/value2.jpg"></p>
<p>Pigsty 的六条缩写正好构成 PIGSTY 首字母缩写 —— 除了 <strong>P</strong>ostgreSQL <strong>i</strong>n <strong>G</strong>reat <strong>STY</strong>le 之外，这六点价值主张提供了另外一种缩写解释：</p>
<blockquote>
<p><strong>P</strong>ostgres, <strong>I</strong>nfras, <strong>G</strong>raphics, <strong>S</strong>ervice, <strong>T</strong>oolbox, <strong>Y</strong>ours.</p>
<p>你的图形化 Postgres 基础设施服务工具箱。</p>
</blockquote>
<p>同时我们还重新设计了 Logo，从戴墨镜的装象猪头变成了六边形组合，配色正好是这些关键组件的颜色（PG蓝，ETCD青，Grafana橙，Ansible黑，Redis/MinIO 红，Nginx绿），是上图大六边形的一个浓缩精简版本。原来的墨镜小猪将作为 Pigsty 项目的吉祥物继续存在。</p>
<p><img alt="mascot.jpg" src="/zh/blog/releases/v2.6.0/mascot.jpg"></p>
<hr>
<h2 id="全新的网站">全新的网站</h2>
<p>在这个版本中，我们重新翻修了老网站。使用了最新版本的 Docsy 作为文档框架，并更新调整了大量内容。我们放弃了花哨繁而不实的设计，直接把将 Pigsty 的价值主张与核心特性放在 Landing Page 上。</p>
<p><img alt="web1.jpg" src="/zh/blog/releases/v2.6.0/web1.jpg"></p>
<p>而真正的内容，都在文档目录里，我们重新梳理设计了文档的目录结构</p>
<p><img alt="web2.jpg" src="/zh/blog/releases/v2.6.0/web2.jpg"></p>
<p>当然，抛下了纯 Markdown 的执念后，我们也可以在文档内容中使用一些好看的样式与花活。</p>
<p><img alt="web3.jpg" src="/zh/blog/releases/v2.6.0/web3.jpg"></p>
<p>除了文档外，我们也整理了一下最近的文章纳入 Pigsty 博客。重新划分为六个专栏：云计算泥石流，数据库老司机，以及 PostgreSQL 的生态、开发、管理、内核四个板块。</p>
<p><img alt="web4.jpg" src="/zh/blog/releases/v2.6.0/web4.jpg"></p>
<p>与此同时， Pigsty 提供的软件源也有了全球的镜像仓库，由 Cloudflare R2 强力驱动。并托管在 Cloudflare 上，为全球用户都带来丝滑的访问体验（当然国内可以继续使用 pigsty.cc ）。</p>
<hr>
<h2 id="postgresql-16-成为默认版本">PostgreSQL 16 成为默认版本</h2>
<p>最后一个值得一提的特性是，在 Pigsty v2.6 中，PostgreSQL 16 (16.2) 正式取代先前的 PostgreSQL 15，成为默认的数据库大版本。</p>
<p>在三个月前的 《<a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486540&idx=1&sn=b14725207c993018836c4cf60d936ced&chksm=fe4b3997c93cb08185bb598ab5121238fc7dec371ff3cb0d99c99962f68d478f88a8485bccaa&scene=21#wechat_redirect">Pigsty v2.5.1发布：PG16能打了吗？</a>》 中，我们已经指出 PostgreSQL 的主要扩展插件已经就位，加上第二个小版本发布，可以上生产环境了。</p>
<p>而 Pigsty v2.6 正值 PostgreSQL 16.2 第三个小版本发布，Hydra，PGML，AGE 这几个重要扩展也跟进了 PG 16，所以我们决定，正式将默认的 PG 大版本升级为 16 ，而且将成为开源版唯一支持的 PG 大版本（EL7除外）。</p>
<p>因此，在这个版本中，我们做出的另一个重要的技术决策是：在开源版中移除了默认囊括的 PG 12 - 15 软件包与扩展。Pigsty 并非不支持 PG 12 - 15，只需要稍微调整配置文件，就可以轻松使用老版本的 PostgreSQL 扩展插件，只是我们不会再针对这些版本启用集成测试了（虽然在老版本的 Pigsty 里已经测试的很充分了）。</p>
<p><img alt="pg16.jpg" src="/zh/blog/releases/v2.6.0/pg16.jpg"></p>
<p>同理，我们也将开源版本的支持范围进一步收窄，缩小到 EL 8 / EL 9 与 Ubuntu 22.04 这三个使用范围最广的操作系统发行版上来。因为在 Pigsty 2.5 的时候，我们支持的是 PG 12 - 16 五个大版本乘以七个操作系统发行版，共 34 种排列组合，加上后续的 ARM 适配支持，给测试带来了很大压力。</p>
<p>让开源版聚焦于一个核心PG大版本与三个主流操作系统大版本，可以更好的利用研发带宽，满足最广大开源用户的使用需求。同理，这并不意味着 Pigsty 不能在老系统上用了，你依然可以在 EL7，Ubuntu 20.04，Debian 11/12 上丝滑运行，但我们不会为这些操作系统提供离线软件包，冒烟测试与支持了。</p>
<p>对于小众冷门操作系统系统与过时大版本的支持，并不是占总体绝大多数用户所需要的，却需要耗费许多额外的精力与成本，因此纳入了我们的付费商业支持中。</p>
<hr>
<h2 id="开源版与专业版划分">开源版与专业版划分</h2>
<p>有一些开源用户反馈 —— 我并不需要那些和 PostgreSQL 关系不大的东西来拖慢下载安装速度并增加管理复杂度 —— 什么 Redis, MinIO, Docker, K8S，Supabase 之类的，虽然你觉得这些东西能给 PG 打辅助，但花里胡哨的东西只会拖慢我出刀的速度。</p>
<p>具体的功能切割方式还没有确定与落地，因此 2.6 也许是最后一个全功能的 Pigsty 开源版本。但基本原则是，开源版将保留所有的核心功能模块与PG扩展插件（PGSQL, INFRA, NODE, ETCD），而与 PostgreSQL 关系没有那么紧密的模块，在后续可能会作为专业版的内容提供。</p>
<p><img alt="pro.jpg" src="/zh/blog/releases/v2.6.0/pro.jpg"></p>
<p>在后面，Pigsty 开源版将专注于做好一件事 —— 提供可靠，高可用，可扩展的本地 PostgreSQL RDS 服务，当然像 Docker 模板这样的实用特性可能还是会留开源版中。</p>
<p>并不是说这些功能在开源版 Pigsty 里就没有了，我相信开源老师傅还是可以很轻松的仅仅通过修改配置文件就把它们重新弄出来，但这些功能不会成为开源版本的默认组成部分了。</p>
<hr>
<h2 id="商业订阅服务">商业订阅服务</h2>
<p>开源是用爱发电的情怀事业，但要想让这条路走得更长，还需要商业的利益来浇灌。在这个版本中，我们正式推出了商业版本的 Pigsty，为有需要的用户提供更丰富的支持选项。</p>
<p>除了提供额外功能模块支持，Pigsty 专业订阅 还提供了咨询答疑与兜底服务。并且支持更为宽泛的操作系统与数据库版本，如下表所示：</p>
<p><img alt="svc.jpg" src="/zh/blog/releases/v2.6.0/svc.jpg"></p>
<p>尽管 Pigsty 本身的宗旨便是让用户拥有开箱即用的数据库服务，甚至还带有硬件故障自愈的 HA 和为软件/人为失误兜底的时间点恢复PITR。也许你拉起了它，一年、两年、三年都没有遇到任何问题 —— 从概率上讲这蛮正常的。</p>
<p>但数据库出了问题，通常都是大问题。用不好数据库，也容易发展成大问题。所以我们也会为付费用户提供专家咨询与服务，作为最终的疑难杂症兜底。（例子：我们<a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486234&idx=1&sn=d1273152e624fb31bf7be2c8f3991315&chksm=fe4b3ec1c93cb7d7ffd84c438746f3379fab6dc5b2ed98ae37d40538a4d064d6fefcb4e458a4&scene=21#wechat_redirect">抢救过一个烤糊的，没有备份的 Gitlab 数据库</a>）。与此同时，我们也可以提供<a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486903&idx=1&sn=01c57499f41e8f51045bb8dd52586595&chksm=fe4b386cc93cb17a2d2fad903e809107162cc1e67e8ad7c8bfdd51de657c97f32f912cabe550&scene=21#wechat_redirect">专业 PostgreSQL DBA 的咨询服务</a>。提供备份、安全、合规建议，管理开发最佳实践，性能评估与优化，设计建议与答疑解惑。</p>
<p><img alt="sub.jpg" src="/zh/blog/releases/v2.6.0/sub.jpg"></p>
<p>许多时候，化腐朽为神奇，能带来几个数量级改善的秘密就是专家的一句话。对于以可扩展性作为灵魂，扩展生态极度繁荣的 PostgreSQL 来说更是如此。我们的服务可以确保您的每一分钱都花得物有所值，并花在真正的刀刃上。</p>
<hr>
<h2 id="展望未来">展望未来</h2>
<p>Pigsty 的下一个大版本计划升级到 v3 ，将会正式落地开源版与专业版的功能划分。我们会在 Ubuntu / Debian 系操作系统中补完缺失的扩展 Deb 包，并提供一个命令行工具来封装管理操作。也许会将 Pigsty 本身打成一个 RPM / Deb 包提供，我们还计划提供 MYSQL 监控部署的 Beta 支持。</p>
<p>在监控系统上，我们会针对 PG 16 提供的 IO 指标重新调整 PostgreSQL 监控面板的样式。提供对 MySQL 的监控能力，尝试使用 Vector 作为日志收集组件 Promtail 的备选替换。我们已经有了针对<a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486169&idx=1&sn=697ab3c172fe6cc28e12cff7297bb343&chksm=fe4b3f02c93cb614bbd1d5075120e074cebb5214d3a1a516363582bcee294e02bf5fd0e051ee&scene=21#wechat_redirect">阿里云 RDS PG 与 PolarDB 的监控</a>，我们也计划在 v3.0 中提供对 AWS RDS 与 Aurora 的监控支持。</p>
<p>在基础设施建设上，我们会选择放弃“便宜”<a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247485363&idx=1&sn=8622b25fd2309d4fc969d22964a04129&chksm=fe4b3268c93cbb7efb8757e876574bebf5d615bdd3c4ceb76e48b2bd907d78faeb450ca1e825&scene=21#wechat_redirect">腾讯云 CDN</a>，全面拥抱更可靠更快速且更便宜的 Cloudflare，为全球用户提供服务。腾讯云 CDN 也许可以作为国内的镜像站点，提供专业版的加速服务。</p>
<p>Pigsty 的产品与接口在 v2.6 和 v3.0 将会固化收敛，因为在产品与技术上，它已经做的足够好了！甚至在某些方面已经远超 RDS 了（比如扩展支持与监控系统！）所以接下来的工作终点会转移到营销与销售上来。开源项目的持续运营离不开用户与客户的支持，如果 Pigsty 帮助到了您，欢迎考虑赞助我们，或采购我们的服务订阅～。</p>
<hr>
<h2 id="v260">v2.6.0</h2>
<p><strong>亮点特性</strong></p>
<ul>
<li>现已将 PostgreSQL 16 作为默认主要版本（16.2）</li>
<li>新增 <a href="https://www.paradedb.com/">ParadeDB</a> 扩展插件：<code>pg_analytics</code>, <code>pg_bm25</code>, and <code>pg_sparse</code></li>
<li>新增 <a href="https://duckdb.org/">DuckDB</a> 与 <code>duckdb_fdw</code> 插件支持</li>
<li>全球 Cloudflare CDN <a href="https://repo.pigsty.io">https://repo.pigsty.io</a> 与中国大陆CDN <a href="https://repo.pigsty.cc">https://repo.pigsty.cc</a></li>
</ul>
<p><strong>软件配置变更</strong></p>
<ul>
<li>使用 <code>node_repo_modules</code> 替换 <code>node_repo_method</code> 参数，并移除 <code>node_repo_local_urls</code> 参数。</li>
<li>暂时关闭 Grafana 统一告警功能，避免 &ldquo;Database Locked&rdquo; 错误。</li>
<li>新增 <code>node_repo_modules</code> 参数，用于指定在节点上添加的上游仓库源。</li>
<li>移除 <code>node_local_repo_urls</code>，其功能由 <code>node_repo_modules</code> &amp; <code>repo_upstream</code> 替代。</li>
<li>移除 <code>node_repo_method</code> 参数，其功能由 <code>node_repo_modules</code> 替代。</li>
<li>在 <code>repo_upstream</code> 添加新的 <code>local</code> 源，并通过 <code>node_repo_modules</code> 使用，替代 <code>node_local_repo_urls</code> 的功能</li>
<li>重排 <code>node_default_packages</code>，<code>infra_packages</code>，<code>pg_packages</code>，<code>pg_extensions</code> 参数默认值。</li>
<li>在 <code>repo_upstream</code> 中替换 <code>repo_upstream.baseurl</code> 时，如果 EL8/9 PGDG小版本特定的仓库可用，使用 <code>major.minor</code> 而不是 <code>major</code> 替换 $releasever，提高小版本兼容性。</li>
</ul>
<p><strong>软件版本升级</strong></p>
<ul>
<li>Grafana 10.3</li>
<li>Prometheus 2.47</li>
<li>node_exporter 1.7.0</li>
<li>HAProxy 2.9.5</li>
<li>Loki / Promtail 2.9.4</li>
<li>minio-20240216110548 / mcli-20240217011557</li>
<li>etcd 3.5.11</li>
<li>Redis 7.2.4</li>
<li>Bytebase 2.13.2</li>
<li>DuckDB 0.10.0</li>
<li>FerretDB 1.19</li>
<li>Metabase：新Docker应用模板</li>
</ul>
<p><strong>PostgreSQL扩展插件</strong></p>
<ul>
<li>PostgreSQL 小版本升级： 16.2, 15.6, 14.11, 13.14, 12.18</li>
<li>PostgreSQL 16： 现在被提升为默认主版本</li>
<li>pg_exporter 0.6.1：安全修复</li>
<li>Patroni 3.2.2</li>
<li>pgBadger 12.4</li>
<li>pgBackRest 2.50</li>
<li>vip-manager 2.3.0</li>
<li>PostGIS 3.4.2</li>
<li>TimescaleDB 2.14.1</li>
<li>向量扩展 PGVector 0.6.0：新增并行创建 HNSW 索引功能</li>
<li>新增扩展插件 <a href="https://github.com/alitrack/duckdb_fdw">duckdb_fdw</a> v1.1 ，支持读写 DuckDB 数据 v1.1</li>
<li>新增扩展插件 <a href="https://github.com/pramsey/pgsql-gzip">pgsql-gzip</a> ，用于支持 Gzip 压缩解压缩 v1.0.0</li>
<li>新增扩展插件 <a href="https://github.com/paradedb/paradedb/tree/dev/pg_sparse">pg_sparse</a>，高效处理稀疏向量（ParadeDB） v0.5.6</li>
<li>新增扩展插件 <a href="https://github.com/paradedb/paradedb/tree/dev/pg_bm25">pg_bm25</a>，用于支持高质量全文检索 BM25 算法的插件（ParadeDB） v0.5.6</li>
<li>新增扩展插件 <a href="https://github.com/paradedb/paradedb/tree/dev/pg_analytics">pg_analytics</a>，支持 SIMD 与列式存储的PG分析插件（ParadeDB） v0.5.6</li>
<li>升级AIML插件 <a href="https://github.com/postgresml/postgresml">pgml</a> 至 v2.8.1，新增 PG 16 支持。</li>
<li>升级列式存储插件 <a href="https://github.com/hydradatabase/">hydra</a> 版本至 v1.1.1，新增 PG 16 支持。</li>
<li>升级图扩展插件 <a href="https://github.com/apache/age">age</a> 至 v1.5.0，新增 PG 16 支持。</li>
<li>升级GraphQL插件 <a href="https://github.com/supabase/pg_graphql">pg_graphql</a> 版本至 v1.5.0 ，支持 Supabase。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>330e9bc16a2f65d57264965bf98174ff  pigsty-v2.6.0.tgz
</span></span><span style="display:flex;"><span>81abcd0ced798e1198740ab13317c29a  pigsty-pkg-v2.6.0.debian11.x86_64.tgz
</span></span><span style="display:flex;"><span>7304f4458c9abd3a14245eaf72f4eeb4  pigsty-pkg-v2.6.0.debian12.x86_64.tgz
</span></span><span style="display:flex;"><span>f914fbb12f90dffc4e29f183753736bb  pigsty-pkg-v2.6.0.el7.x86_64.tgz
</span></span><span style="display:flex;"><span>fc23d122d0743d1c1cb871ca686449c0  pigsty-pkg-v2.6.0.el8.x86_64.tgz
</span></span><span style="display:flex;"><span>9d258dbcecefd232f3a18bcce512b75e  pigsty-pkg-v2.6.0.el9.x86_64.tgz
</span></span><span style="display:flex;"><span>901ee668621682f99799de8932fb716c  pigsty-pkg-v2.6.0.ubuntu20.x86_64.tgz
</span></span><span style="display:flex;"><span>39872cf774c1fe22697c428be2fc2c22  pigsty-pkg-v2.6.0.ubuntu22.x86_64.tgz
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-877785c5632b343eb253c95e8f53bb0d">v2.5：Ubuntu &amp; PG16</h1>
	<div class="lead">Pigsty v2.5 提供了 Ubuntu/Debian 支持：bullseye, bookworm, jammy, focal，新扩展，监控改进</div>
	<div class="td-byline mb-4">
		By <b>Ruohang Feng（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2023-10-24" class="text-muted">2023年10月24日</time>
        
	</div>
	<p>时值 1024 程序员节，Pigsty v2.5.0 发布了 🎉，这个版本添加了对 <strong>Ubuntu</strong> 与 <strong>Debian</strong> 系操作系统的支持，加上原有的 <strong>EL7/8/9</strong> 支持，可谓实现了主流 Linux 操作系统大满贯。</p>
<p>此外，Pigsty 正式支持了自托管的 Supabase 与 PostgresML，以及列式存储插件 <code>hydra</code>，激光雷达点云支持插件 <code>pointcloud</code>，图像相似度计算插件 <code>imgsmlr</code>，扩展距离函数包 <code>pg_similarity</code> 以及多语言模糊检索插件 <code>pg_bigm</code>。</p>
<p>在监控上，Pigsty 优化了 PostgreSQL 监控面板体验，新增了 Patroni &amp; Exporter 监控面板，根据查询宏观优化方法论重新设计了 PGSQL Query 监控面板。</p>
<hr>
<h3 id="关于pigsty">关于Pigsty</h3>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486135&idx=1&sn=7d9c4920e94efba5d0e0b6af467f596c&chksm=fe4b3f6cc93cb67ac570d5280b37328aed392598b13df88545ff0a06f99630801fc999db8de5&scene=21#wechat_redirect"><strong>Pigsty</strong></a> 是一个开箱即用的 <a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247485933&idx=3&sn=ea360aa7a59a4cd23ad5f9a9f415a0a0&chksm=fe4b3c36c93cb520bda4596136e927d7cf92c597a76c04077c256588b2428202bdb7f004c08b&scene=21#wechat_redirect"><strong>PostgreSQL</strong></a> 发行版 、提供本地优先的 RDS PG 开源替代。让用户用云数据库 RDS 几分之一的纯硬件成本，自助运行更好的企业级 PostgreSQL 数据库服务。更多介绍，请访问 <strong><a href="https://pigsty.cc">https://pigsty.cc</a></strong> 。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.5.0/640-20240929143830209"></p>
<hr>
<h2 id="ubuntudebian支持">Ubuntu/Debian支持</h2>
<p>在《<a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486263&idx=1&sn=4288450c04a6fdbaf5e4fae385d42bd9&chksm=fe4b3eecc93cb7faf32a8c30ab78870f8ca607ad572e9d6725ac9f64c1549071c3d33a802019&scene=21#wechat_redirect">临水照花看Ubuntu与Debian：Pigsty v2.5</a>》中，我们已经预告了对 Ubuntu / Debian 系操作系统的支持（以下简称 Deb 支持）。从两年前 0.x 版本的时代，就有用户提出想要 Ubuntu 和 Debian 操作系统支持了，所以我觉得这是一件非常正确且重要的事情。</p>
<p>作为一个选择构建于<strong>裸操作系统上</strong>的数据库发行版，支持一种新操作系统并不像容器化数据库打个镜像那么简单。有许多的适配工作需要去做。首当其冲的就是包不齐的问题，好比 Prometheus 就没有官方提供的 DEB 源，不得不自己维护打包并提供一个软件仓库。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.5.0/640-20240929143834887"></p>
<blockquote>
<p>Pigsty 维护的 APT/YUM 源</p>
</blockquote>
<p>包管理的巨大差别，要求你针对DEB系重写整个 bootstrap / 构建本地软件源的逻辑。发行版的 FHS ，习惯规约差异需要你一个一个去适配处理。你要解决的不仅是 PostgreSQL 内核和一百多个扩展的完整性兼容性问题，还有 etcd / minio / redis / grafana / prometheus / haproxy 等各种组件的问题。好在 Pigsty 克服了这些问题，让 Ubuntu / Debian 也有了和 EL 7-9 一样完整的丝滑体验。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.5.0/640-20240929143836437"></p>
<blockquote>
<p>一键安装 Pigsty</p>
</blockquote>
<p>在使用体验上，Deb系 支持的功能集与EL系几乎完全相同，唯一的例外是 supabase 及其使用的几个专用扩展还没有完成移植。除此之外， Deb 系还有一些独有的扩展插件，例如化学分子式扩展 <code>RDKit</code>，激光雷达点云数据扩展 <code>pointcloud</code> / 扩展距离函数包 <code>pg_similarity</code> （这两个给力扩展反向移植到 EL 了）。想要完整发挥 PostgresML + CUDA 的实力，更是非 Ubuntu 不可。</p>
<p>Pigsty 在自动配置过程中添加了 Debian / Ubuntu 系统的识别，单机安装时会自动使用对应的配置模板。Deb系的模板相比 EL系只有 8 个参数的默认值有区别 —— 因为两种发行版的包名是不一样的，所以像 <code>xx_packages</code> 的参数肯定是需要调整的。除此之外需要就只有 上游源 <code>repo_upstream</code> ，本地源 <code>node_repo_local_urls</code> ，以及默认的 <code>pg_dbsu_uid</code> 了（DEB包没有分配固定UID）。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.5.0/640-20240929143838408"></p>
<blockquote>
<p>Ubuntu 系统的声明式配置文件</p>
</blockquote>
<p>这些参数通常都不需要用户来调整，所以在 Pigsty 使用流程上，Deb系可以说几乎没有任何区别了：实际上 Pigsty 的离线软件包构建模版就是这么工作的：一次性在七种不同的操作系统上完成完整的 Pigsty 安装，无需任何特殊处理。</p>
<hr>
<h2 id="新的扩展插件">新的扩展插件</h2>
<p>Pigsty v2.5 收纳了几款用户呼声比较高的扩展插件。首当其冲的便是 <strong>PostgresML</strong>。尽管在上一个版本中，Pigsty 已经提供了在 EL8 / EL9 上使用 PostgresML 的能力，但搞 AI 的操作系统基本上都是清一色的 Ubuntu，最起码 CUDA 驱动装起来方便啊。</p>
<p>所以 Pigsty v2.5 中，您可以在 Ubuntu 上运行原生的 PostgresML 集群了。你不需要折腾什么 <strong>NVIDIA Docker</strong> 之类的东西，pip 安装好 python 依赖，直接起飞就可以。使用 SQL 训练模型，调用模型，让你的整个 AI 工作流都在数据库中完成！</p>
<p><img alt="图片" src="/zh/blog/releases/v2.5.0/640-20240929143840571"></p>
<p>第二个值得一提的扩展插件是 <code>pointcloud</code>[1]。因为地理空间扩展 PostGIS 的存在，PostgreSQL 一直是自动驾驶/电车公司的心头好。而 PointCloud 则将 PostgreSQL 与 PostGIS 的力量推广到一个新的边界。激光雷达会不断扫描周围并生成所谓 “点云” 数据。<code>pointcloud</code>插件提供了 PcPoint &amp; PcPatch 两种数据类型与四十个功能函数，允许您对超高维度的点集进行高效存储、检索与运算。这个插件在 PGDG APT 源中原生提供，而 Pigsty 将其移植到了 EL 系统上，让所有系统的用户都可以用上。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.5.0/640-20240929143842526"></p>
<p><code>imgsmlr</code>[2] 则是一个以图搜图的插件。尽管现在已经有许多 AI 模型可以将图片编码成高维向量，使用 <code>pgvector</code> 进行语义搜索以图搜图。但 <code>imgsmlr</code> 最有趣的地方在于，它不需要任何外部依赖，可以直接在数据库内完成所有功能。用作者的说法是：我做这个插件的目的不是提供最先进的图像搜索方法，而是告诉你们如何编写一个 PostgreSQL 扩展，来干甚至是图像处理这种非典型的数据库任务。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.5.0/640-20240929143844710"></p>
<p>首先将 PNG/JPG 图片使用 Haar小波变换的方式处理为 16K 大小的模式与64字节的摘要签名，然后利用 GiST 索引检索摘要的方式来高效实现以图搜图。使用 <code>imgsmlr</code> 从4亿随机图片中召回最相似的10张大约耗时 600ms 。”</p>
<p>另一个有趣的扩展 <code>pg_similarity</code>[3] 默认在 Ubuntu/Debian 的 APT 源中提供，Pigsty 将其移植到了 EL 上。它提供了 17 种文本距离度量函数的高效 C 语言实现，极大丰富了检索排序的能力。另一个相关的插件是 <code>pg_bigm</code>，它类似 PG 自带的 <code>pg_trgm</code>，唯一的区别是用二字组替代三字组实现模糊检索，对中日韩语言的全文检索支持效果更好。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.5.0/640-20240929143848147"></p>
<p>除此之外，我们还将 Supabase 的支持更新到最新版本：<code>20231013070755</code>。您可以在 EL8/EL9 系统上使用 Pigsty 提供的 PostgreSQL 数据库来自托管 Supabase。</p>
<p>算上 PostgreSQL 自带的扩展，Pigsty 2.5 支持的扩展插件已经达到了 150+。尽管有这么多的插件，但请注意，它们全都是<strong>选装项</strong>。Pigsty 为所有 PostgreSQL 大版本都提供了 <code>pg_repack</code>，<code>wal2json</code>，<code>passwordcheck_cracklib</code> （EL）这几个重要的扩展，默认安装的三方扩展只有在线治理膨胀的 <code>pg_repack</code>。其他的扩展如果不安装，对现有系统不会产生任何额外的影响和负担。</p>
<hr>
<h2 id="监控系统调整">监控系统调整</h2>
<p>Pigsty v2.5 在监控系统上也进行了调整，将两年没升级的 <code>pg_exporter</code> 更新至了 <code>v0.6.0</code>，新增了TLS支持，修复了两个依赖组件的安全问题，打好了 ARM64 软件包并使用最新的指标定义文件。同时，在 <code>pg_query</code> 指标收集器中添加了与共享缓冲区 I/O 有关的四个指标，进一步丰富了 PGSQL Query 中提供的信息。</p>
<p>首先是新增的监控面板：PGSQL Patroni  ，提供了一个集群高可用状态的完整视图。对于分析历史服务健康状态，主从切换原因都大有帮助。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.5.0/640-20240929143852359"></p>
<p>然后是 PGSQL Exporter，提供了 PG Exporter 和 Pgbouncer Exporter 自我监控的详细指标与日志。可以用于优化调整监控系统本身的性能。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.5.0/640-20240929143854285"></p>
<p>在各种监控大盘的组件导航面板中，都可以点击 Patroni Exporter 的指示块直接跳转到这些组件的详情页中：</p>
<p><img alt="图片" src="/zh/blog/releases/v2.5.0/640-20240929143856406"></p>
<p>PGSQL Query 监控面板现在分为五栏：Overview 概览， 核心指标 QPS/RT，对时间微分指标，对调用次数的微分指标，百分比指标。遵循了宏观查询优化的方法论进行优化。</p>
<p><strong>减少资源消耗</strong>：降低资源饱和的风险，优化CPU/内存/IO，通常以查询总耗时/总IO作为优化目标。使用 <code>dM/dt</code> ：指标 <code>M</code> 基于时间的微分，即每秒的增量。</p>
<p><strong>改善用户体验</strong>：最常见的优化目标，在OLTP系统中，通常以降低查询平均响应时间作为优化目标。使用<code>dM/dc</code>：指标 <code>M</code> 基于调用次数的微分，即每次调用的增量。</p>
<p><strong>平衡工作负载</strong>：确保不同查询组之间的资源使用/性能表现的比例关系得当。使用 <code>M%</code>，即某一类查询指标占总数的比例。</p>
<p>PGSQL 首屏是最核心的查询性能指标：QPS 与 RT —— 以及它们的 1分钟，5分钟，15分钟均值，抖动情况与分布范围。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.5.0/640-20240929143858713"></p>
<p>接下来，便是用于优化用户体验的 <code>dM/dc</code>类指标，这里的M指标包括：</p>
<ul>
<li>每次查询平均返回的行数</li>
<li>每次查询的平均执行时长</li>
<li>每次查询平均产生的WAL大小</li>
<li>每次查询平均耗费的 I/O 时间</li>
<li>每次查询平均读写的缓冲区块大小</li>
<li>每次平均访问/写脏的缓冲区块大小</li>
</ul>
<p><img alt="图片" src="/zh/blog/releases/v2.5.0/640-20240929143901043"></p>
<p>随后是用于<strong>减少资源消耗</strong>的 <code>dM/dt</code>类指标，这里的M指标基本同上，不同之处在于它是针对时间的微分而不是针对调用次数的微分：</p>
<p><img alt="图片" src="/zh/blog/releases/v2.5.0/640-20240929143903190"></p>
<p>最后一栏中，我们展示了用于平衡工作负载的 %M 类指标。用于揭示这个特定查询组在整个工作负载中的比例与相对位置，标黑加粗显示，点击特定查询可以原地跳转查看另一组查询的性能表现，非常方便。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.5.0/640-20240929143905125"></p>
<p>除了上面三个 Dashboard 之外，Pigsty 也对许多其他面板进行了优化改进与问题修复。许多面板的信息栏现在会提供更详细的信息：这个面板展现了什么指标，用于解决什么问题，等等等。我们也引入了三个新的 Grafana 插件用于支持 CSV/JSON 数据源，以及变量面板。</p>
<hr>
<h2 id="下个版本做点啥">下个版本做点啥？</h2>
<p>Pigsty 的下一个版本是 v2.6.0 ，除了进一步巩固 Ubuntu/Debian 的支持成熟度，这个版本的关注焦点将会关注两件事：MySQL 支持与命令行工具。</p>
<p>Pigsty 将提供基本的（主从，但没有HA） MySQL 安装部署支持，并提供基于 Grafana / Prometheus / MysqldExporter 的监控。因为 MySQL 5.7 将于本月 EOL，相信这样的能力会让更多的 MySQL 用户接触 PostgreSQL 并方便地迁移上来。</p>
<p>此外，我们还会进一步探索 Infra 组件容器化，调研使用 VictoriaMetrics 默认替换 Prometheus，或者使用 Vector 与 VictoriaLogs 替代 Loki与Promtail 的可行性。并设计一个更加好用的管控命令行工具 pigsty-cli，对 Greenplum 7.0 的部署提供正式支持，当这些任务都完成后，Pigsty 就将迎来第三个大版本 v3 了。</p>
<hr>
<h2 id="发布注记">发布注记</h2>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486215&idx=1&sn=52ce37a537336a6d07448f35c7bc4cfd&chksm=fe4b3edcc93cb7ca2dc87602430c2beb09ae5e7dcb568158541a1bd026e305d69d94cea81da4&scene=21#wechat_redirect">PGSQL x Pigsty: 数据库全能王来了</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486169&idx=1&sn=697ab3c172fe6cc28e12cff7297bb343&chksm=fe4b3f02c93cb614bbd1d5075120e074cebb5214d3a1a516363582bcee294e02bf5fd0e051ee&scene=21#wechat_redirect">如何用Pigsty监控现有PostgreSQL (RDS/PolarDB/自建)？</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486135&idx=1&sn=7d9c4920e94efba5d0e0b6af467f596c&chksm=fe4b3f6cc93cb67ac570d5280b37328aed392598b13df88545ff0a06f99630801fc999db8de5&scene=21#wechat_redirect">Pigsty 特性与快速上手</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486256&idx=1&sn=15dd3001e9890e11144b42a84636d2e9&chksm=fe4b3eebc93cb7fd6f7710e84e8dc0daf7d0c05baf151aa1d24c6939915061ee1c58b0f54375&scene=21#wechat_redirect">EL系操作系统发行版哪家强？</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486263&idx=1&sn=4288450c04a6fdbaf5e4fae385d42bd9&chksm=fe4b3eecc93cb7faf32a8c30ab78870f8ca607ad572e9d6725ac9f64c1549071c3d33a802019&scene=21#wechat_redirect">临水照花看Ubuntu与Debian：Pigsty v2.5</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247485933&idx=3&sn=ea360aa7a59a4cd23ad5f9a9f415a0a0&chksm=fe4b3c36c93cb520bda4596136e927d7cf92c597a76c04077c256588b2428202bdb7f004c08b&scene=21#wechat_redirect">PostgreSQL：世界上最成功的数据库</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486118&idx=1&sn=5b67544e104fc4fbda1a18198252377b&chksm=fe4b3f7dc93cb66b1e075585e0c40da03813222f24c6877bedde334647aabdbe28918014360f&scene=21#wechat_redirect">Pigsty 2.4：PG16支持，RDS监控与新扩展！</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486079&idx=1&sn=61e3010f6d717f042e91e06f3c8eeb4d&chksm=fe4b3fa4c93cb6b2732e5caf3524d8c7ff8d53e34e9400800a06b1d655e39ec40f69fe82ea70&scene=21#wechat_redirect">Pigsty v2.3.1：HNSW版PGVECTOR来了！</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247486053&idx=1&sn=854966c3c4e2c96298173baaa2915535&chksm=fe4b3fbec93cb6a88669c698f7299bd4d38e9a691122831e72b9204fd35f94f4d0ac304812a6&scene=21#wechat_redirect">Pigsty v2.3 发布：应用生态丰富</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247485827&idx=1&sn=9b13273b559fa63e96d4ac77268bd00a&chksm=fe4b3c58c93cb54e87b062c6db4b3a712037e25dbfbe69aa50ad9b79abf2c97967b625fe1a7f&scene=21#wechat_redirect">Pigsty v2.2 发布 —— 监控系统大升级</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247485612&idx=1&sn=ce76d9439ed4f2ed10ee28c7aceb19cd&chksm=fe4b3d77c93cb46196eb97f7e04cbab1b2f2dee51324050ffc17583c22415f41a3656834fdcb&scene=21#wechat_redirect">Pigsty v2.1 发布：向量扩展 / PG12-16 支持</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247485327&idx=1&sn=0d02f5e504266e5dd436c64d23844735&chksm=fe4b3254c93cbb427598322952d654c3383bfe8858ec7ffaee2b9ca0c84bebe6f763748a356f&scene=21#wechat_redirect">Pigsty v2.0.2 更好的开源RDS替代：Pigsty</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247485349&idx=1&sn=96fde26dd9efd399ef7ae11e52e05843&chksm=fe4b327ec93cbb688e2708ff4e709a7ba32eee2be9d8637e9b941f47e6600dc7fcd2710a42c4&scene=21#wechat_redirect">Pigsty v2.0 发布，炮打 RDS</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247485327&idx=1&sn=0d02f5e504266e5dd436c64d23844735&chksm=fe4b3254c93cbb427598322952d654c3383bfe8858ec7ffaee2b9ca0c84bebe6f763748a356f&scene=21#wechat_redirect">Pigsty v2 正式发布：更好的RDS PG开源替代</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247485155&idx=1&sn=9e8bfff6fab8967923a1603a0b55111f&chksm=fe4b3338c93cba2e9ac96e048e272265aca81fa30ba792fe5ad5a57f59e127e6eb19ea4d1286&scene=21#wechat_redirect">Pigsty v1.5.1发布</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247485125&idx=1&sn=d06a14013aa02ecd1da307b4b3038054&chksm=fe4b331ec93cba08624adb70e626e4b45ede9ea5d8ae01fad779e82687ff0064c56bf9b42187&scene=21#wechat_redirect">Pigsty v1.5 发布与新特性</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247484935&idx=1&sn=b904584f2df752e1cb603486f96d173f&chksm=fe4b33dcc93cbacabc130669ae52edf547e0cdf684bdd9910267f6be541fe54488ce90853b83&scene=21#wechat_redirect">Pigsty v1.4 正式发布！</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247484904&idx=1&sn=5331785190ce704399295a7212e19989&chksm=fe4b3033c93cb925513b6192312be01d2065493d112b58682dda242e9fd0466d3b9bd473b28c&scene=21#wechat_redirect">Pigsty v1.4 前瞻</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247484847&idx=1&sn=c37f3c402cc9133ea616c295aa5482cf&chksm=fe4b3074c93cb9621876b7dc3a7906d2b217bcb1b0f44c09fb69fedc0a581a191465e9681bb1&scene=21#wechat_redirect">Pigsty v1.3.1 安装教程</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247484821&idx=1&sn=56e34b33f37b2555336591ad532ac7e7&chksm=fe4b304ec93cb9589c2bca821e5aaa1034c7dd5b9c580dec4b09ebe3b1ed20bb48df9dfd29ce&scene=21#wechat_redirect">开箱即用的Redis发行版 —— Pigsty v1.3</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247484799&idx=1&sn=bb4a87eba481c6851582899ae9955f10&chksm=fe4b30a4c93cb9b2ad9d68d837763bb1dd547c81d6ec04684ef98072ead8271695b9abba78d1&scene=21#wechat_redirect">Pigsty v1.2 发布</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247484774&idx=1&sn=8b9e8f5bec8fb8492ebce3ebc6b60d88&chksm=fe4b30bdc93cb9ab1dfcaed066a1a90919027f6c72d63003b3b839eb9ba2871ec663db7469f1&scene=21#wechat_redirect">Pigsty v1.1 发布/新功能介绍</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247484729&idx=1&sn=179c470fe4a80b22a8c2e96a3e191e6e&chksm=fe4b30e2c93cb9f4db6bb5e379b6fd5a489539e8e5db1e0080a1e7946d6f4eb83ad7647ce11d&scene=21#wechat_redirect">Pigsty v1正式发布：开箱即用的PostgreSQL开源发行版</a></p>
<h3 id="references">References</h3>
<p><code>[1]</code> <code>pointcloud</code>: <em><a href="https://github.com/pgpointcloud/pointcloud">https://github.com/pgpointcloud/pointcloud</a></em>
<code>[2]</code> <code>imgsmlr</code>: <em><a href="https://github.com/postgrespro/imgsmlr">https://github.com/postgrespro/imgsmlr</a></em>
<code>[3]</code> <code>pg_similarity</code>: <em><a href="https://github.com/eulerto/pg_similarity">https://github.com/eulerto/pg_similarity</a></em>
<code>[4]</code> Ubuntu: <em><a href="https://github.com/Vonng/pigsty/blob/master/files/pigsty/ubuntu.yml">https://github.com/Vonng/pigsty/blob/master/files/pigsty/ubuntu.yml</a></em>
<code>[5]</code> Debian: <em><a href="https://github.com/Vonng/pigsty/blob/master/files/pigsty/debian.yml">https://github.com/Vonng/pigsty/blob/master/files/pigsty/debian.yml</a></em>
<code>[6]</code> <code>ubuntu.yml</code>: <em><a href="https://github.com/Vonng/pigsty/blob/master/files/pigsty/ubuntu.yml">https://github.com/Vonng/pigsty/blob/master/files/pigsty/ubuntu.yml</a></em></p>
<hr>
<h2 id="v250">v2.5.0</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl https://get.pigsty.cc/latest <span style="color:#000;font-weight:bold">|</span> bash
</span></span></code></pre></div><p><strong>亮点特性</strong></p>
<ul>
<li>
<p><a href="https://github.com/Vonng/pigsty/blob/master/files/pigsty/ubuntu.yml">Ubuntu</a> / <a href="https://github.com/Vonng/pigsty/blob/master/files/pigsty/debian.yml">Debian</a>  支持： bullseye, bookworm, jammy, focal</p>
</li>
<li>
<p>使用CDN <code>repo.pigsty.cc</code> 软件源，提供 rpm/deb 软件包下载。</p>
</li>
<li>
<p>Anolis 操作系统支持（ 兼容 EL 8.8 ）。</p>
</li>
<li>
<p>使用 PostgreSQL 16 替代 PostgreSQL 14 作为备选主要支持版本</p>
</li>
<li>
<p>新增了 PGSQL Exporter / PGSQL Patroni 监控面板，重做 PGSQL Query 面板</p>
</li>
<li>
<p>扩展更新：</p>
<ul>
<li>PostGIS 版本至 3.4（ EL8/EL9 ），EL7 仍使用 PostGIS 3.3</li>
<li>移除 <code>pg_embedding</code>，因为开发者不再对其进行维护，建议使用 <code>pgvector</code> 替换。</li>
<li>新扩展（EL）：点云插件 <code>pointcloud</code> 支持，Ubuntu原生带有此扩展。</li>
<li>新扩展（EL）： <code>imgsmlr</code>， <code>pg_similarity</code>，<code>pg_bigm</code> 用于搜索。</li>
<li>重新编译 <code>pg_filedump</code> 为 PG 大版本无关的软件包。。</li>
<li>新收纳 <code>hydra</code> 列存储扩展，不再默认安装 <code>citus</code> 扩展。</li>
</ul>
</li>
<li>
<p>软件更新：</p>
<ul>
<li>Grafana 更新至 v10.1.5</li>
<li>Prometheus 更新至 v2.47</li>
<li>Promtail/Loki 更新至 v2.9.1</li>
<li>Node Exporter 更新至 v1.6.1</li>
<li>Bytebase 更新至 v2.10.0</li>
<li>patroni 更新至 v3.1.2</li>
<li>pgbouncer 更新至 v1.21.0</li>
<li>pg_exporter 更新至 v0.6.0</li>
<li>pgbackrest 更新至 v2.48.0</li>
<li>pgbadger 更新至 v12.2</li>
<li>pg_graphql 更新至 v1.4.0</li>
<li>pg_net 更新至 v0.7.3</li>
<li>ferretdb 更新至 v0.12.1</li>
<li>sealos 更新至 4.3.5</li>
<li>Supabase 支持更新至 <code>20231013070755</code></li>
</ul>
</li>
</ul>
<p><strong>Ubuntu 支持说明</strong></p>
<p>Pigsty 支持了 Ubuntu 22.04 (jammy) 与 20.04 (focal) 两个 LTS 版本，并提供相应的离线软件安装包。</p>
<p>相比 EL 系操作系统，一些参数的默认值需要显式指定调整，详情请参考 <a href="https://github.com/Vonng/pigsty/blob/master/files/pigsty/ubuntu.yml"><code>ubuntu.yml</code></a></p>
<ul>
<li><code>repo_upstream</code>：按照 Ubuntu/Debian 的包名进行了调整</li>
<li><code>repo_packages</code>：按照 Ubuntu/Debian 的包名进行了调整</li>
<li><code>node_repo_local_urls</code>：默认值为 <code>['deb [trusted=yes] http://${admin_ip}/pigsty ./']</code></li>
<li><code>node_default_packages</code> ：
<ul>
<li><code>zlib</code> -&gt; <code>zlib1g</code>, <code>readline</code> -&gt; <code>libreadline-dev</code></li>
<li><code>vim-minimal</code> -&gt; <code>vim-tiny</code>, <code>bind-utils</code> -&gt; <code>dnsutils</code>, <code>perf</code> -&gt; <code>linux-tools-generic</code>,</li>
<li>新增软件包 <code>acl</code>，确保 Ansible 权限设置正常工作</li>
</ul>
</li>
<li><code>infra_packages</code>：所有含 <code>_</code> 的包要替换为 <code>-</code> 版本，此外 <code>postgresql-client-16</code> 用于替换 <code>postgresql16</code></li>
<li><code>pg_packages</code>：Ubuntu 下惯用 <code>-</code> 替代 <code>_</code>，不需要手工安装 <code>patroni-etcd</code> 包。</li>
<li><code>pg_extensions</code>：扩展名称与EL系不太一样，Ubuntu下缺少 <code>passwordcheck_cracklib</code> 扩展。</li>
<li><code>pg_dbsu_uid</code>： Ubuntu 下 Deb 包不显式指定uid，需要手动指定，Pigsty 默认分配为 <code>543</code></li>
</ul>
<p><strong>API变更</strong></p>
<p>默认值变化：</p>
<ul>
<li>
<p><code>repo_modules</code> 现在的默认值为 <code>infra,node,pgsql,redis,minio</code>，启用所有上游源</p>
</li>
<li>
<p><code>repo_upstream</code> 发生变化，现在添加了 Pigsty Infra/MinIO/Redis/PGSQL 模块化软件源</p>
</li>
<li>
<p><code>repo_packages</code> 发生变化，移除未使用的 <code>karma,mtail,dellhw_exporter</code>，移除了 PG14 主要扩展，新增了 PG16 主要扩展，添加了 virtualenv 包。</p>
</li>
<li>
<p><code>node_default_packages</code> 发生变化，默认安装 <code>python3-pip</code> 组件。</p>
</li>
<li>
<p><code>pg_libs</code>: <code>timescaledb</code> 从 shared_preload_libraries 中移除，现在默认不自动启用。</p>
</li>
<li>
<p><code>pg_extensions</code> 发生变化，不再默认安装 Citus 扩展，默认安装 <code>passwordcheck_cracklib</code> 扩展，EL8,9 PostGIS 默认版本升级至 3.4</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#000">pg_repack_${pg_version}* wal2json_${pg_version}* passwordcheck_cracklib_${pg_version}*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">postgis34_${pg_version}* timescaledb-2-postgresql-${pg_version}* pgvector_${pg_version}*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>Patroni 所有模板默认移除 <code>wal_keep_size</code> 参数，避免触发 Patroni 3.1.1 的错误，其功能由 <code>min_wal_size</code> 覆盖。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>87e0be2edc35b18709d7722976e305b0  pigsty-pkg-v2.5.0.el7.x86_64.tgz
</span></span><span style="display:flex;"><span>e71304d6f53ea6c0f8e2231f238e8204  pigsty-pkg-v2.5.0.el8.x86_64.tgz
</span></span><span style="display:flex;"><span>39728496c134e4352436d69b02226ee8  pigsty-pkg-v2.5.0.el9.x86_64.tgz
</span></span><span style="display:flex;"><span>e3f548a6c7961af6107ffeee3eabc9a7  pigsty-pkg-v2.5.0.debian11.x86_64.tgz
</span></span><span style="display:flex;"><span>1e469cc86a19702e48d7c1a37e2f14f9  pigsty-pkg-v2.5.0.debian12.x86_64.tgz
</span></span><span style="display:flex;"><span>cc3af3b7c12f98969d3c6962f7c4bd8f  pigsty-pkg-v2.5.0.ubuntu20.x86_64.tgz
</span></span><span style="display:flex;"><span>c5b2b1a4867eee624e57aed58ac65a80  pigsty-pkg-v2.5.0.ubuntu22.x86_64.tgz
</span></span></code></pre></div><hr>
<h2 id="v251">v2.5.1</h2>
<p>跟进 PostgreSQL v16.1, v15.5, 14.10, 13.13, 12.17, 11.22 小版本例行更新。</p>
<p>现在 PostgreSQL 16 的所有重要扩展已经就位（新增 <code>pg_repack</code> 与 <code>timescaledb</code> 支持）</p>
<ul>
<li>软件更新：
<ul>
<li>PostgreSQL to v16.1, v15.5, 14.10, 13.13, 12.17, 11.22</li>
<li>Patroni v3.2.0</li>
<li>PgBackrest v2.49</li>
<li>Citus 12.1</li>
<li>TimescaleDB 2.13</li>
<li>Grafana v10.2.0</li>
<li>FerretDB 1.15</li>
<li>SealOS 4.3.7</li>
<li>Bytebase 2.11.1</li>
</ul>
</li>
</ul>
<ul>
<li>移除  PGCAT 监控面板中查询对 <code>monitor</code> 模式前缀（允许用户将 <code>pg_stat_statements</code> 扩展装到别的地方）</li>
<li>新的配置模板 <code>wool.yml</code>，为阿里云免费99 ECS 单机针对设计。</li>
<li>为 EL9 新增 <code>python3-jmespath</code> 软件包，解决 Ansible 依赖更新后 bootstrap 缺少 jmespath 的问题</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>31ee48df1007151009c060e0edbd74de  pigsty-pkg-v2.5.1.el7.x86_64.tgz
</span></span><span style="display:flex;"><span>a40f1b864ae8a19d9431bcd8e74fa116  pigsty-pkg-v2.5.1.el8.x86_64.tgz
</span></span><span style="display:flex;"><span>c976cd4431fc70367124fda4e2eac0a7  pigsty-pkg-v2.5.1.el9.x86_64.tgz
</span></span><span style="display:flex;"><span>7fc1b5bdd3afa267a5fc1d7cb1f3c9a7  pigsty-pkg-v2.5.1.debian11.x86_64.tgz
</span></span><span style="display:flex;"><span>add0731dc7ed37f134d3cb5b6646624e  pigsty-pkg-v2.5.1.debian12.x86_64.tgz
</span></span><span style="display:flex;"><span>99048d09fa75ccb8db8e22e2a3b41f28  pigsty-pkg-v2.5.1.ubuntu20.x86_64.tgz
</span></span><span style="display:flex;"><span>431668425f8ce19388d38e5bfa3a948c  pigsty-pkg-v2.5.1.ubuntu22.x86_64.tgz
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-cec3476d5ea1563fac8cc4175e0fe4b1">v2.4：监控云数据库</h1>
	<div class="lead">PG16，监控RDS，服务咨询支持，新扩展：中文分词全文检索/图/HTTP/嵌入等</div>
	<div class="td-byline mb-4">
		By <b>Ruohang Feng（<a href="https://vonng.com/en/">@Vonng</a>） | <a href="https://mp.weixin.qq.com/s/HaYNKSmBEC04JwqMjMLcqQ">微信公众号</a></b> |
        
		<time datetime="2023-09-14" class="text-muted">2023年09月14日</time>
        
	</div>
	<p>PostgreSQL 今天发布了新的大版本 16，带来了一系列改进。Pigsty在发布后的1小时内便立即跟进了全新版本 Pigsty v2.4 ，提供了对 PostgreSQL 16 正式版的完整支持。此外在 v2.4 中，还对监控已有PG实例，特别是 RDS for PostgreSQL 与 PolarDB 提供了额外的支持。Redis 监控基于 7.x 进行了改进，提供了自动化的基于 Sentinel 的高可用配置。</p>
<p>Pigsty v2.4 目前仍为 Beta 状态，可以使用以下命令快速上手。<strong>文档修缮完成后，将正式发布</strong>。</p>
<p><code>bash -c &quot;$(curl -fsSL https://get.pigsty.cc/beta)&quot;</code></p>
<p><img alt="图片" src="/zh/blog/releases/v2.4.0/640.png"></p>
<hr>
<h2 id="亮点特性">亮点特性</h2>
<p>•PostgreSQL 16 正式发布，Pigsty在发布后1小时内提供支持。•可以监控云数据库，RDS for PostgreSQL，以及 PolarDB，提供全新的 PGRDS 监控面板•正式提供<strong>商业支持与咨询服务</strong>。并发布首个 LTS 版本，为订阅客户提供最长5年的支持。•新扩展插件: <strong>Apache AGE</strong> ，在 PostgreSQL 上提供图数据库查询能力•新扩展插件: <strong>zhparser</strong>，中文分词，用于支持中文全文检索功能•新扩展插件: <strong>pg_roaringbitmap</strong>，高效实现 RoaringBitmap 位图功能•新扩展插件: <strong>pg_embedding</strong>，另一种基于 HNSW 索引的向量数据库插件hnsw alternative to pgvector•新扩展插件: <strong>pg_tle</strong>，由 AWS 出品的可信语言存储过程管理/发布/打包扩展•新扩展插件: <strong>pgsql-http</strong>，在数据库中使用 SQL 接口直接发送HTTP请求处理响应。•其他新增插件：<strong>pg_auth_mon，pg_checksums，pg_failover_slots，pg_readonly，postgresql-unit pg_store_plans，pg_uuidv7，set_user</strong>•Redis改进：支持 Redis 哨兵监控，配置主从集群的自动高可用。</p>
<p><strong>API变化</strong></p>
<p>•新增参数，<code>REDIS</code>.<code>redis_sentinel_monitor</code>，用于指定 Sentinel 集群监控的主库列表</p>
<hr>
<h2 id="pg16支持">PG16支持</h2>
<p>Pigsty 也许是最早提供 PostgreSQL 16 支持的发行版，从 16 beta1 就开始，因此当 PostgreSQL 16 发布后一个小时，Pigsty 即完成了对正式版本的支持。你已经可以拉起 PostgreSQL 16 的高可用集群，尽管有个别重要扩展还没有在官方的 PGDG 仓库提供，例如 Citus 与 TimescaleDB。但其他一些扩展已经可用：包括 postgis34，pgvector， pg_squeeze，wal2json，pg_cron，以及由 Pigsty 所维护打包的扩展插件：zhparser，roaringbitmap，pg_embedding， pgsql-http 等。</p>
<p>PostgreSQL 16 有一些比较实用的新功能：从库逻辑解码与逻辑复制，针对I/O的新统计视图，全连接的并行执行，更好的冻结性能，符合 SQL/JSON 标准的新函数集，以及在HBA认证中使用正则表达式等等。</p>
<p>不过要注意的是，PGDG 官方仓库目前决定在 PostgreSQL 16 中放弃对 EL7 的支持，所以 PG16 仅在 EL8 与 EL9 及其兼容操作系统发行版中可用。</p>
<hr>
<h2 id="监控rds与polardb">监控RDS与PolarDB</h2>
<p>Pigsty v2.4 提供了对 RDS 监控的支持。特别是还添加了对 PolarDB 云数据库的监控支持。当您只有一个远程 PostgreSQL 连接串时，可以使用这种方式将其纳入 Pigsty 监控。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.4.0/640-20240929143953200.png"></p>
<p>样例：监控一个一主一从的 PolarDB RDS 集群</p>
<p>Pigsty v2.4 提供了对 RDS 监控的支持。特别是还添加了对 PolarDB 云数据库的监控支持。当您只有一个远程 PostgreSQL 连接串时，可以使用这种方式将其纳入 Pigsty 监控中。Pigsty 提供了两个全新 Dashboard：PGRDS Cluster 与 PGINS Cluster，用于呈现 RDS PG 的完整指标。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.4.0/640-20240929143954254.png"></p>
<p><img alt="图片" src="/zh/blog/releases/v2.4.0/640-20240929143956073.png"></p>
<p><img alt="图片" src="/zh/blog/releases/v2.4.0/640-20240929143957677.png"></p>
<hr>
<h2 id="商业支持">商业支持</h2>
<p>Pigsty v2.4 是第一个 LTS 版本，将为企业订阅用户提供3年的长时间支持。同时，我们将正式开始对外提供订阅与支持服务，欢迎有需求的用户联系我们采购。</p>
<p><strong><a href="https://pigsty.cc/zh/docs/support/">https://pigsty.cc/zh/docs/support/</a></strong></p>
<p><img alt="图片" src="/zh/blog/releases/v2.4.0/640-20240929144008464.png"></p>
<hr>
<h2 id="redis高可用">REDIS高可用</h2>
<p>Pigsty v2.4 中，我们提供了一个新的参数 redis_sentinel_monitor ，用于自动配置经典主从 Redis 集群的高可用。该参数只能在 Sentinel 集群上定义，定义中的主库将会自动被哨兵集群所纳管</p>
<p><img alt="图片" src="/zh/blog/releases/v2.4.0/640-20240929144011024.png"></p>
<p>与此同时，我们也在 Redis 监控中添加了 Sentinel 相关指标与面板，并针对 Redis 7.x 的新特性进行了适配。</p>
<hr>
<h2 id="新扩展">新扩展</h2>
<p>Pigsty v2.4 提供了一系列的新扩展插件，包括尚未收录在 PGDG 官方仓库中的重要扩展。例如，图数据库插件 Apache AGE，中文分词全文检索插件 zhparser，HTTP插件pgsql-http，可信扩展打包插件 pg_tle ，位图插件 pg_roaringbitmap，以及向量数据库插件 PGVector 的另一种替代实现 pg_embedding ，等等等等。</p>
<p>所有插件都在 EL7 - EL9 上针对 PostgreSQL 12 至 PostgreSQL 16 进行编译打包，不过 EL7 因为编译器版本问题，尚未支持 pg_tle 与 pg_embedding 。这些 RPM 包将由 Pigsty 维护，并放置于 Pigsty 自己的 Yum 源中。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.4.0/640-20240929144012923.png"></p>
<p>例如，您可以使用 AGE 为 PostgreSQL 加装图数据库能力，创建 Graph，并使用 Cypher 查询语言与 SQL 语言一起探索图数据，实现 Neo4j 的效果。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.4.0/640-20240929144015337.png"></p>
<p>再比如，您可以使用 zhparser 中文分词插件，将中文文本与查询拆分为关键词，使用 PostgreSQL 经典的全文检索能力，实现搜索引擎与 ElasticSearch 的效果。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.4.0/640-20240929144017334.png"></p>
<p>更有甚者，你还可以使用 pgsql-http 插件，使用 SQL 接口来发送 HTTP 请求，处理 HTTP 响应。这让数据库可以与外部系统深度集成与交互，打开无尽的想象空间：</p>
<p><img alt="图片" src="/zh/blog/releases/v2.4.0/640-20240929144019793.png"></p>
<p>您还可以使用 roaringbitmap ，使用极少的资源，高效地进行计数统计：</p>
<p><img alt="图片" src="/zh/blog/releases/v2.4.0/640-20240929144024663.png"></p>
<p>具体细节就不在此展开了，后面我们会专门出一些文章，介绍这些强力扩展的使用方式。</p>
<p>欢迎大家使用 Pigsty 并提出反馈意见，加讨论群请微信搜索 Pigsty 小助手：pigsty-cc 。</p>
<hr>
<h2 id="v240">v2.4.0</h2>
<p>使用 <code>bash -c &quot;$(curl -fsSL https://get.pigsty.cc/latest)&quot;</code> 快速上手。</p>
<p><strong>最新特性</strong></p>
<ul>
<li>PostgreSQL 16 正式发布，Pigsty提供支持。</li>
<li>可以监控云数据库，RDS for PostgreSQL，以及 PolarDB，提供全新的 PGRDS 监控面板</li>
<li>正式提供商业支持与咨询服务。并发布首个 LTS 版本，为订阅客户提供最长5年的支持。</li>
<li>新扩展插件: Apache AGE, openCypher graph query engine on PostgreSQL</li>
<li>新扩展插件: zhparser, full text search for Chinese language</li>
<li>新扩展插件: pg_roaringbitmap, roaring bitmap for PostgreSQL</li>
<li>新扩展插件: pg_embedding, hnsw alternative to pgvector</li>
<li>新扩展插件: pg_tle, admin / manage stored procedure extensions</li>
<li>新扩展插件: pgsql-http, issue http request with SQL interface</li>
<li>新增插件： pg_auth_mon pg_checksums pg_failover_slots pg_readonly postgresql-unit pg_store_plans pg_uuidv7 set_user</li>
<li>Redis改进：支持 Redis 哨兵监控，配置主从集群的自动高可用。</li>
</ul>
<p><strong>API变化</strong></p>
<ul>
<li>新增参数，<code>REDIS</code>.<code>redis_sentinel_monitor</code>，用于指定 Sentinel 集群监控的主库列表</li>
</ul>
<p><strong>问题修复</strong></p>
<ul>
<li>修复 Grafana 10.1 注册数据源时缺少 <code>uid</code> 的问题</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>MD5 (pigsty-pkg-v2.4.0.el7.x86_64.tgz) = 257443e3c171439914cbfad8e9f72b17
</span></span><span style="display:flex;"><span>MD5 (pigsty-pkg-v2.4.0.el8.x86_64.tgz) = 41ad8007ffbfe7d5e8ba5c4b51ff2adc
</span></span><span style="display:flex;"><span>MD5 (pigsty-pkg-v2.4.0.el9.x86_64.tgz) = 9a950aed77a6df90b0265a6fa6029250
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-66e10e82bb6e5a34062744a4d5f34ea1">v2.3：丰富应用生态</h1>
	<div class="lead">PGSQL/REDIS升级，NODE集群可绑VIP，Mongo初步支持与MySQL存根</div>
	<div class="td-byline mb-4">
		By <b>Ruohang Feng（<a href="https://vonng.com/en/">@Vonng</a>）| <a href="https://mp.weixin.qq.com/s/p5sP42xsAxKPhWb_T7DqSA">微信公众号</a></b> |
        
		<time datetime="2023-08-20" class="text-muted">2023年08月20日</time>
        
	</div>
	<p>Pigsty v2.3 发布了 🎉，在这个版本中进一步完善了监控系统、应用生态、并跟进 PostgreSQL 例行的小版本更新（CVE修复）。</p>
<p>Pigsty v2.3 跟随 PostgreSQL 主干小版本进行更新，包括 15.4, 14.9, 13.12, 12.16 以及 16.beta3，此更新修复了一个 CVE 安全漏洞。此外高可用管控 Patroni 也升级到 3.1 版本，解决了一些 BUG 。</p>
<p>v2.3 提供了对 FerretDB 的支持，它是一个构建在 PostgreSQL 之上，真正开源的 MongoDB 替代。用户可以使用 MongoDB 客户端访问它，但是真正的数据都存储在底层的 PostgreSQL 里。</p>
<p>v2.3 还默认添加了一款名为 NocoDB 的开源应用：这是 AirTable 的开源替代：这是一个数据库-电子表格的混合体，可以用低代码的方式快速打造一个多人在线协作应用。</p>
<p>Pigsty v2.3 新增了为主机节点集群绑定一个 <strong>L2 VIP</strong> 的功能，使用 VRRP 协议确保全链路上没有单点，并提供了完整的监控：keepalived_exporter 被用于收集监控数据。而且每一个 Node VIP （keepalived）与 PGSQL VIP （vip-manager）都会添加到 blackbox_exporter 的 ICMP / PING 监控列表中。</p>
<p>在监控系统上，Pigsty v2.3 在 v2.2 的基础上进行了打磨优化：新增了 VIP 监控，VIP 与节点 PING 指标被加入到 NODE / PGSQL 监控的醒目位置；PGSQL 监控新增了锁等待树视图；REDIS 监控进行了风格优化；MinIO 监控适配的新的监控指标名称；MySQL / MongoDB 监控新增了实现存根，为后续实现奠定基础。</p>
<p>顺带一提，PGSQL x Pigsty 交流群新开3群了，对 PostgreSQL 与 Pigsty 感兴趣的朋友可以直接扫码加入（仅限前200人），如果加入不了请微信搜索 pigsty-cc 小助手加入。</p>
<h2 id="mongodb-支持">MongoDB 支持？</h2>
<p>MongoDB 是一个很受欢迎的 NoSQL 文档数据库。但由于开源协议问题（SSPL），与软件定位问题（Postgres发型版），Pigsty 决定使用 FerretDB 来提供对 MongoDB 的支持。FerretDB 是一个有趣的开源项目：<strong>它让 PostgreSQL 可以提供 MongoDB 的能力</strong>。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.3.0/640-20240929144054088"></p>
<p>MongoDB 与 PostgreSQL 是两个非常不同的数据库系统：MongoDB 使用文档模型，使用专用的查询语言进行交互 。但是鉴于 PostgreSQL 也提供了完整的 JSON/JSONB/GIN 功能支持，所以这么做在理论上也是完全可行的：FerretDB 负责将您的 SON 查询转换为 SQL 查询：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>use test-- CREATE SCHEMA test;
</span></span><span style="display:flex;"><span>db.dropDatabase()-- DROP DATABASE test;
</span></span><span style="display:flex;"><span>db.createCollection(&#39;posts&#39;)-- CREATE TABLE posts(_data JSONB,...)
</span></span><span style="display:flex;"><span>db.posts.insert({title: &#39;Post One&#39;,body: &#39;Body of post one&#39;,category: &#39;News&#39;,tags: [&#39;news&#39;, &#39;events&#39;],user: {name: &#39;John Doe&#39;,status: &#39;author&#39;},date: Date()})-- INSERT INTO posts VALUES(...);
</span></span><span style="display:flex;"><span>db.posts.find().limit(2).pretty()-- SELECT * FROM posts LIMIT 2;
</span></span><span style="display:flex;"><span>db.posts.createIndex({ title: 1 })-- CREATE INDEX ON posts(_data-&gt;&gt;&#39;title&#39;);
</span></span></code></pre></div><p>在 Pigsty 定义一个 FerretDB 集群与其他类型的数据库并无二致，您仅需要提供核心的身份参数：集群名称与实例号。需要关注的是 mongo_pgurl 参数，它指定了 FerretDB 底层使用的 PostgreSQL 地址。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#000">ferret</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">hosts</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#0000cf;font-weight:bold">10.10</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">10.45</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">mongo_seq</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">}</span>    <span style="color:#0000cf;font-weight:bold">10.10</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">10.46</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">mongo_seq</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">}</span>    <span style="color:#0000cf;font-weight:bold">10.10</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">10.47</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">mongo_seq</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000;font-weight:bold">}</span>  <span style="color:#000">vars</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">mongo_cluster</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">ferret</span>    <span style="color:#000">mongo_pgurl</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;postgres://test:test@10.10.10.3:5436/test&#39;</span>
</span></span></code></pre></div><p>您可以直接填入一个已由 Pigsty 创建的任意 PostgreSQL 服务地址。数据库不需要预先配置什么，你只需要确保所使用的用户具有 DDL 权限即可。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.3.0/640-20240929144058034"></p>
<p>配置完成后，使用 ./mongo.yml -l ferret 即可完成安装。当然，如果您更喜欢使用容器，也可以直接 cd pigsty/app/ferretdb; make 使用 docker-compose 拉起 FerretDB 使用。安装完成后，您可以使用任何 MongoDB Client 访问 FerretDB，例如 MongoSH：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>mongosh &#39;mongodb://test:test@10.10.10.45:27017/test?authMechanism=PLAIN&#39;
</span></span></code></pre></div><p>对于那些希望从 MongoDB 迁移到 PostgreSQL 的用户来说，这是一种改造成本极小的折衷手段。Pigsty 同样提供了另一种支持方式 MongoFDW：在 PostgreSQL 中使用 SQL 查询现有的 MongoDB 集群。</p>
<h2 id="新应用nocodb">新应用：NocoDB</h2>
<p>在 Pigsty v2.3 中，添加了对 NocoDB 的内置支持，您可以使用默认的 Docker Compose 模板，一键拉起 NocoDB 并使用内置的 PostgreSQL 作为存储。</p>
<p>NocoDB 是 Airtable 的开源替代品，那 AirTable 又是什么呢？其实有点类似于 Google Docs / 腾讯云文档。但是提供了非常丰富的接口，钩子，可以用来实现一些非常强大的功能。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.3.0/640-20240929144100061"></p>
<p>NocoDB 可以让各种关系型数据库变身成为 Excel ，运行你自己的本地云文档软件。它也可以让用户用低代码的方式实现一些需求：比如你可以把自动生成的表单发送给别人填写，将结果自动整理成为实时共享、可协作、可编程的多维表格。</p>
<p>在 Pigsty 中，拉起 NocoDB 非常容易，只需要一行命令即可。您可以修改 .env 中的 DATABASE_URL 参数来使用不同的数据库。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>cd ~/pigsty/app/nocodb; make up
</span></span></code></pre></div><h2 id="node-vip-支持">Node VIP 支持</h2>
<p>Pigsty v2.3 新增了为主机节点集群绑定一个 <strong>L2 VIP</strong> 的功能，使用 VRRP 协议确保全链路上没有单点，并提供了完整的监控。</p>
<p>在古早的 Pigsty 版本中（0.5前），曾经提供过基于 Keepalived 的 L2 VIP 功能实现。但随后被 HAProxy + VIP-Manager 所取代：HAProxy 不挑网络，可以进行灵活的健康检查、流量分发，更是提供了一个简单易用的管控界面。而 VIP Manager 则可以将一个 L2 VIP 绑定在数据库集群主库上。</p>
<p>但通用的 L2 VIP 需求仍然是存在的，例如，如果用户选择使用 HAProxy 集群接入，那么 HAProxy 本身的可靠性如何保证？尽管您可以使用 DNS LB 的方式进行切换，但 VRRP 在可靠性与易用性上显然更胜一筹。此外，MinIO / ETCD ，Prometheus 这些组件，有时也会有这样的需求。</p>
<p>想要为集群绑定一个 L2 VIP 其实很简单，只需要启用 vip_enabled，分配一个 VLAN 中唯一的 VirtualRouterID 号与 VIP 地址就可以了。默认情况下，所有集群成员使用 BACKUP 初始状态以非抢占模式工作。你可以通过设置 vip_role 与 vip_preempt 来改变这一行为。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.3.0/640-20240929144103275"></p>
<p>L2 VIP 会自动被纳入监控中。当 MASTER 宕机后， BACKUP 会立即进行接管。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.3.0/640-20240929144104844"></p>
<h2 id="监控系统改进">监控系统改进</h2>
<p>Pigsty v2.2 基于 Grafana 10 对监控系统进行了<a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247485827&idx=1&sn=9b13273b559fa63e96d4ac77268bd00a&chksm=fe4b3c58c93cb54e87b062c6db4b3a712037e25dbfbe69aa50ad9b79abf2c97967b625fe1a7f&scene=21#wechat_redirect">彻底的翻新重制</a>。v2.3 在 v2.2 的基础上进行了更多优化。</p>
<p>例如，新增的 NODE VIP 监控面板用于展示一个 VIP 的状态：所属集群/成员，网络RT，KA的状态等等等等。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.3.0/640-20240929144106718"></p>
<p>上图展示了一个 L2 VIP 自动故障转移的现场监控：绑定在 3 节点集群 MinIO 上。当原本的 Master （.27）宕机后，（.26）立即完成接管。</p>
<p>同样的信息也被展示在 NODE 与 PGSQL 监控面板的关键位置：例如，Overview 的实例列表中，现在就会添加 VIP 的快速导航（紫色）：</p>
<p><img alt="图片" src="/zh/blog/releases/v2.3.0/640-20240929144108694"></p>
<p><img alt="图片" src="/zh/blog/releases/v2.3.0/640-20240929144110494"></p>
<p>同理，在 NODE Cluster 与 PGSQL Cluster 中也会在醒目处列出 VIP 与所有成员的 ICMP 可达性状态（Ping 网络延迟）。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.3.0/640-20240929144112049"></p>
<p><img alt="图片" src="/zh/blog/releases/v2.3.0/640-20240929144117429"></p>
<p>此外，在 PGCAT 中新增了默认 1s 刷新的 PGCAT Locks 监控面板，可以直观的观察数据库当前活跃的情况，以及锁等待的情况。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.3.0/640-20240929144119471"></p>
<p>锁等待会组织成一棵等待树，用 Level 与缩进标识层次。您可以选择不同的刷新率，最快每秒 10 次。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.3.0/640.gif"></p>
<p>在 REDIS 监控上，相关的监控面板也统一按照 PGSQL 与 NODE 的风格进行适配与调整：</p>
<p><img alt="图片" src="/zh/blog/releases/v2.3.0/640-20240929144123541"></p>
<h2 id="更丝滑的构建流程">更丝滑的构建流程</h2>
<p>Pigsty v2.2 提供了官方 Yum 源，在 v2.3 中则默认启用了全站 HTTPS。所有</p>
<p>当您选择直接从互联网下载 Pigsty 所需的软件时，可能会遭遇到功夫网的烦恼。例如，默认的 Grafana / Prometheus Yum 源下载速度极慢。除此之外，还有一些零散的 RPM 包需要通过 Web URL 的方式，而不是 repotrack RPM 的方式进行下载。</p>
<p>在 Pigsty v2.2 中，解决了这个问题。Pigsty 提供了一个官方的 yum 源：http://get.pigsty.cc ，并配置为默认的上游源之一。所有零散的 RPM，需要翻墙的 RPM 都放置其中，可以有效加快在线安装/构建速度。</p>
<p>此外， Pigsty 还在 v2.2 中提供了对信创操作系统，统信 UOS 1050e uel20 的支持，满足一些特殊客户的特殊需求。Pigsty 针对这些系统重新编译了 PG相关的 RPM 包，为有需求的客户提供支持。</p>
<h2 id="安装">安装</h2>
<p>Pigsty v2.3 的安装命令为：</p>
<p><strong>bash -c &ldquo;$(curl -fsSL <a href="https://get.pigsty.cc/latest%29%22">https://get.pigsty.cc/latest)"</a></strong></p>
<p>一行命令，即可在全新机器上完整安装 Pigsty. 如果您想要尝鲜 beta 版本，将 latest 换为 beta 即可。对于没有互联网访问的特殊环境，您也可以使用以下链接下载 Pigsty，以及打包了所有软件的离线安装包：</p>
<p><img alt="图片" src="/zh/blog/releases/v2.3.0/640-20240929144126329"></p>
<p><a href="https://get.pigsty.cc/v2.3.0/pigsty-v2.3.0.tgz">https://get.pigsty.cc/v2.3.0/pigsty-v2.3.0.tgz</a>
<a href="https://get.pigsty.cc/v2.3.0/pigsty-pkg-v2.3.0.el7.x86_64.tgz">https://get.pigsty.cc/v2.3.0/pigsty-pkg-v2.3.0.el7.x86_64.tgz</a>
<a href="https://get.pigsty.cc/v2.3.0/pigsty-pkg-v2.3.0.el8.x86_64.tgz">https://get.pigsty.cc/v2.3.0/pigsty-pkg-v2.3.0.el8.x86_64.tgz</a>
<a href="https://get.pigsty.cc/v2.3.0/pigsty-pkg-v2.3.0.el9.x86_64.tgz">https://get.pigsty.cc/v2.3.0/pigsty-pkg-v2.3.0.el9.x86_64.tgz</a></p>
<p>以上，就是 Pigsty v2.3 带来的变化。</p>
<p>更多细节，请参考 Pigsty 官方文档：https://vonng.github.io/pigsty/ 与 Github Release Note： <a href="https://github.com/Vonng/pigsty/releases/tag/v2.3.0">https://github.com/Vonng/pigsty/releases/tag/v2.3.0</a></p>
<hr>
<h2 id="v230">v2.3.0</h2>
<p>相关文章：《<a href="https://mp.weixin.qq.com/s/p5sP42xsAxKPhWb_T7DqSA">Pigsty v2.3 发布：应用生态丰富</a>》</p>
<p>发布注记：https://github.com/Vonng/pigsty/releases/tag/v2.3.0</p>
<p>使用 <code>bash -c &quot;$(curl -fsSL https://get.pigsty.cc/latest)&quot;</code> 快速开始。</p>
<p><strong>亮点特性</strong></p>
<ul>
<li>INFRA: 添加了对 NODE/PGSQL VIP 的监控支持</li>
<li>PGSQL: 通过小版本升级修复了 PostgreSQL <a href="https://www.postgresql.org/about/news/postgresql-154-149-1312-1216-1121-and-postgresql-16-beta-3-released-2689/">CVE-2023-39417</a>： 15.4, 14.9, 13.12, 12.16，以及 Patroni v3.1.0</li>
<li>NODE:  允许用户使用 <code>keepalived</code> 为一个节点集群绑定 L2 VIP</li>
<li>REPO: Pigsty 专用 yum 源优化精简，全站默认使用 HTTPS： <a href="https://get.pigsty.cc"><code>get.pigsty.cc</code></a> 与 <a href="https://demo.pigsty.cc"><code>demo.pigsty.cc</code></a></li>
<li>APP:  升级 <code>app/bytebase</code> 版本至 v2.6.0， <code>app/ferretdb</code> 版本至 v1.8；添加新的应用模板：<a href="https://nocodb.com/">nocodb</a>，开源的 Airtable。</li>
<li>REDIS: 升级版本至 v7.2，并重制了 Redis 监控面板。</li>
<li>MONGO: 添加基于 <a href="https://www.ferretdb.io/">FerretDB</a> 1.8 实现的基本支持。</li>
<li>MYSQL: 添加了 Prometheus / Grafana / CA 中的代码存根，便于后续纳管。</li>
</ul>
<p><strong>API变化</strong></p>
<p>新增一个新的参数组 <code>NODE</code>.<code>NODE_VIP</code>：包含 8 个新参数</p>
<ul>
<li><code>NODE</code>.<code>VIP</code>.<code>vip_enabled</code>：在此节点集群上启用 vip 吗？</li>
<li><code>NODE</code>.<code>VIP</code>.<code>vip_address</code>：ipv4 格式的节点 vip 地址，如果启用了 vip，则必需</li>
<li><code>NODE</code>.<code>VIP</code>.<code>vip_vrid</code>：必需，整数，1-255 在相同 VLAN 中应该是唯一的</li>
<li><code>NODE</code>.<code>VIP</code>.<code>vip_role</code>：master/backup，默认为备份，用作初始角色</li>
<li><code>NODE</code>.<code>VIP</code>.<code>vip_preempt</code>：可选，true/false，默认为 false，启用 vip 抢占</li>
<li><code>NODE</code>.<code>VIP</code>.<code>vip_interface</code>：节点 vip 网络接口监听，eth0 默认</li>
<li><code>NODE</code>.<code>VIP</code>.<code>vip_dns_suffix</code>：节点 vip dns 名称后缀，默认为 .vip</li>
<li><code>NODE</code>.<code>VIP</code>.<code>vip_exporter_port</code>：keepalived 导出器监听端口，默认为 9650</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>MD5 (pigsty-pkg-v2.3.0.el7.x86_64.tgz) = 81db95f1c591008725175d280ad23615
</span></span><span style="display:flex;"><span>MD5 (pigsty-pkg-v2.3.0.el8.x86_64.tgz) = 6f4d169b36f6ec4aa33bfd5901c9abbe
</span></span><span style="display:flex;"><span>MD5 (pigsty-pkg-v2.3.0.el9.x86_64.tgz) = 4bc9ae920e7de6dd8988ca7ee681459d
</span></span></code></pre></div><hr>
<h2 id="v231">v2.3.1</h2>
<p>使用 <code>bash -c &quot;$(curl -fsSL https://get.pigsty.cc/latest)&quot;</code> 快速开始。</p>
<p><strong>最新特性</strong></p>
<ul>
<li><code>pgvector</code> 更新至 0.5，添加 hnsw 算法支持。</li>
<li>支持 PostgreSQL 16 RC1 (el8/el9)</li>
<li>默认包中添加了 SealOS 用于快速部署Kubernetes集群。</li>
</ul>
<p><strong>问题修复</strong></p>
<ul>
<li>修复了 <code>infra</code>.<code>repo</code>.<code>repo_pkg</code> 任务：当 <code>repo_packages</code> 中包名包含 <code>*</code> 时，下载可能会受到 <code>/www/pigsty</code> 现有内容的影响。</li>
<li>将 <code>vip_dns_suffix</code> 的默认值由 <code>.vip</code> 调整为空字符串，即集群本身的名称将默认作为节点集群的 L2 VIP</li>
<li><code>modprobe watchdog</code> and <code>chown watchdog</code> if <code>patroni_watchdog_mode</code> is <code>required</code></li>
<li>当 <code>pg_dbsu_sudo</code> = <code>limit</code> and <code>patroni_watchdog_mode</code> = <code>required</code> 时，授予数据库 dbsu 以下命令的 sudo 执行权限
<ul>
<li><code>/usr/bin/sudo /sbin/modprobe softdog</code>：在启动 Patroni 服务时确保 softdog 内核模块启用</li>
<li><code>/usr/bin/sudo /bin/chown {{ pg_dbsu }} /dev/watchdog</code>: 在启动 Patroni 服务时，确保 watchdog 属主正确</li>
</ul>
</li>
</ul>
<p><strong>文档更新</strong></p>
<ul>
<li>向英文文档中添加了更新内容。</li>
<li>添加了简体中文版本的内置文档，修复了 pigsty.cc 文档站的中文文档。</li>
</ul>
<p><strong>软件更新</strong></p>
<ul>
<li>PostgreSQL 16 RC1 for EL8/EL9</li>
<li>PGVector 0.5.0，支持 hnsw 索引</li>
<li>TimescaleDB 2.11.2</li>
<li>grafana 10.1.0</li>
<li>loki &amp; promtail 2.8.4</li>
<li>redis-stack 7.2 on el7/8</li>
<li>mcli-20230829225506 / minio-20230829230735</li>
<li>ferretdb 1.9</li>
<li>sealos 4.3.3</li>
<li>pgbadger 1.12.2</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ce69791eb622fa87c543096cdf11f970  pigsty-pkg-v2.3.1.el7.x86_64.tgz
</span></span><span style="display:flex;"><span>495aba9d6d18ce1ebed6271e6c96b63a  pigsty-pkg-v2.3.1.el8.x86_64.tgz
</span></span><span style="display:flex;"><span>38b45582cbc337ff363144980d0d7b64  pigsty-pkg-v2.3.1.el9.x86_64.tgz
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-64a3297ad799d4639405ad1f505ddbaa">v2.2：监控全面翻新</h1>
	<div class="lead">监控面板 &amp; 沙箱置备重做，构建流程优化，UOS兼容性</div>
	<div class="td-byline mb-4">
		By <b>Ruohang Feng（<a href="https://vonng.com/en/">@Vonng</a>）| <a href="https://mp.weixin.qq.com/s/NfQEL6fM8FA-ErijucXJ4g">微信公众号</a></b> |
        
		<time datetime="2023-08-04" class="text-muted">2023年08月04日</time>
        
	</div>
	<p>Pigsty v2.2 发布了 🎉，欢迎大家尝鲜！ 地表最强 PostgreSQL 监控系统迎来史诗级重大升级，基于 Grafana v10 彻底重制，将 PG 可观测性拔高到一个全新阶段，带来了全新的用户体验。<strong>Demo</strong>: <strong><a href="http://demo.pigsty.cc">http://demo.pigsty.cc</a></strong> 。</p>
<p>此外 Pigsty v2.2 还提供了一个 <strong>42</strong> 节点的生产仿真环境沙箱模板，支持了 Citus 12，PG 16beta2，提供了使用KVM虚拟机的vagrant模板，为零散/墙外RPM包提供了专用的 Pigsty Yum 源，并支持了国产信创操作系统统信UOS20。</p>
<p>欢迎大家试用尝鲜，提出反馈意见。加 PG x Pigsty 微信讨论群请搜 pigsty-cc 小助手。</p>
<p>另外：8月9号晚7点开源中国出品的直播 《 PostgreSQL vs MySQL》以及8月16号的DTCC 2023，我将代表 PG 一方出战与 MySQL 对喷：谁才是数据库一哥，欢迎大家收看。</p>
<hr>
<h2 id="监控系统重制视觉配色">监控系统重制：视觉配色</h2>
<p>Pigsty v2.2 中，对监控面板进行了彻底的重制，充分利用 Grafana v10 的新特性，为用户带来耳目一新的可视化体验。</p>
<p>最直观的变化是色彩。Pigsty v2.2 采用了全新的配色方案.以 PGSQL Overview 面板为例，新配色方案降低了饱和度，整体视觉体验比旧版本更加协调美观。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144136190.png"></p>
<blockquote>
<p>Pigsty v2.0 使用Grafana默认的高饱和配色</p>
</blockquote>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144137647.png"></p>
<blockquote>
<p>Pigsty v2.2：失效实例标黑，点击可直达故障现场</p>
</blockquote>
<p>在 Pigsty v2.2 的监控面板中使用了 PG蓝，Nginx绿，Redis红，Python黄，Grafana橙等颜色作为基准，这套配色方案的灵感来自这篇文章：SCI，但《天气之子》~当SCI论文插图遇上新海诚天气之子配色 <a href="https://zhuanlan.zhihu.com/p/619556088">https://zhuanlan.zhihu.com/p/619556088</a> 。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640.jpeg"></p>
<hr>
<h2 id="监控系统重制集群导航">监控系统重制：集群导航</h2>
<p>当然除了配色，v2.2 也在内容编排和布局上重新进行了设计。例如，使用 Stats 色块统计替代了大量表格式导航，让有问题的服务能够在首屏即可一目了然。点击异常色块即可直达故障现场。</p>
<p>当然，老式的导航表格可以提供更丰富的信息，也并没有移除，而是移动到了专门的 Instances / Members 分栏中去。让我们以最常用的 PGSQL Cluster 面板为例：</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144141745.png"></p>
<p>首屏是基于色块的图元导航，展现了集群组件存活状态与服务可用性，核心指标，负载水平与告警事件图。且提供了到集群内部资源 —— 实例，连接池，负载均衡器，服务，数据库的快速导航</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144143736.png"></p>
<p>PGSQL Cluster 的表格式导航</p>
<p>具体的集群资源表，则是在第二栏中，以备查阅详情。配合后面的 指标栏与日志栏，完整的呈现了一个 PostgreSQL 数据库集群的核心状态。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144145679.png"></p>
<hr>
<h2 id="监控系统重制实例">监控系统重制：实例</h2>
<p>PGSQL Instance 展现了一个实例的详细状态，在 v2.2 中也进行了重制。最基本的设计原则就是：不是蓝/绿色的状态才需要关注。这样通过颜色视觉编码，用户可以在事故分析时快速定位一个数据库实例的故障根因。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144149770.png"></p>
<p>其他的实例，主机节点，ETCD，MinIO，Redis，也都使用了类似的设计，例如 Node Instance 的首屏就是这样的。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144151086.png"></p>
<p>Node Instance 的指标部分基本保持不变，但首屏概览部分进行了重制。MinIO Overview 亦然。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144153067.png"></p>
<p>Etcd Overview 则使用 State Timeline 来可视化 DCS 服务的可用性状态。例如下图展现了一个模拟 etcd 故障的现场：在一个5节点的 ETCD 集群中依次关闭各个实例，集群可以容忍两个节点故障，但3个节点故障将导致 ETCD 服务整体不可用（黄色的条转为暗蓝色，代表 ETCD 服务整体不可用）。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144154911.png"></p>
<p>当 DCS 出现故障时，依赖 ETCD 进行高可用的 PostgreSQL 集群默认会启用 FailSafeMode：在确认所有集群成员可达，不是自身而是DCS故障的前提下，可以避免出现主库降级的故障。而这一点，也会在 PG 的监控中体现出来</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144156623.png"></p>
<hr>
<h2 id="监控系统重制服务">监控系统重制：服务</h2>
<p>另一个进行重新设计的部分是 Service 与 Proxy 。Service 面板现在添加了关于服务的重要信息：SLI ，通过条状的 Statetimeline，用户可以直观的看出服务中断情况，获取服务可用性指标，并理解负载均衡器与后端真实数据库服务器的状态。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144158652.png"></p>
<p>本例中，对 pg-test 集群的四个 HAProxy，分别进行了 排干，设置维护状态操作，然后关闭后端数据库服务器。只有当一个集群的全部实例都下线后， pg-test-replica 这个只读服务才会进入不可用状态。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144200905.png"></p>
<p>这是 pg-test 集群 1 号 HAProxy 负载均衡器的监控面板，每一个由其承载的服务都会列于其中，展示后端服务器状态并计算 SLI。HAProxy 本身的状态与监控放置在 Node Haproxy 监控面板中。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144202990.png"></p>
<p>在全局总览中，可以看到 Pigsty 中所有数据库服务的整体状态时间线与 SLI 指标。</p>
<hr>
<h2 id="监控系统重制数据库统计">监控系统重制：数据库统计</h2>
<p>在 Pigsty 中，除了会对数据库服务器进行监控外，也会对数据库服务器所承载的逻辑对象 —— 数据库，表，查询，索引等逻辑。</p>
<p>PGSQL Databases 展示了集群层面的数据库统计指标。例如，在 pg-test 集群中有4个数据库实例，与一个数据库 test ，而这里就展示出了这4个实例数据库指标的水平对比。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144205965.png"></p>
<p>用户可以进一步下钻到<strong>单个</strong>数据库实例内部的统计，也就是 PGSQL Database 面板。这个面板提供了一些关于数据库与连接池的关键指标，但最重要的是，PGSQL Database 面板提供了对数据库内最活跃醒目的<strong>表</strong>与<strong>查询</strong>的索引 —— 这是两类最为重要的库内对象。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144209081.png"></p>
<p>用户可以进一步下钻到<strong>单个</strong>数据库实例内部的统计，也就是 PGSQL Database 面板。这个面板提供了一些关于数据库与连接池的关键指标，但最重要的是，PGSQL Database 面板提供了对数据库内最活跃醒目的<strong>表</strong>与<strong>查询</strong>的索引 —— 这是两类最为重要的库内对象。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144211398.png"></p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144213280.png"></p>
<hr>
<h2 id="监控系统重制系统目录">监控系统重制：系统目录</h2>
<p>在 Pigsty 中，除了使用 pg exporter 采集到的指标数据之外，还会使用另外一类<strong>可选</strong>的重要补充数据 —— 系统目录。这也是 PGCAT 系列 Dashboard 所做的事情。PGCAT Instance 将直接访问数据库系统目录（使用最多8条监控只读连接），获取并呈现所需的信息。</p>
<p>例如，您可以获取数据库当前正在运行的活动，按照各种指标对数据库中的慢查询，无用索引，全表扫描进行定位与分析。查阅数据库的角色，会话，复制情况，配置修改状态，内存使用详情，备份与持久化的具体细节。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144215142.png"></p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144217092.png"></p>
<p>如果说 PGCAT Instance 关注的是数据库服务器本身，那么 PGCAT Database 就更关注单个数据库内部的对象细节：例如 Schema，Table，Index，膨胀，Top SQL， Top Table，等等。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144218743.png"></p>
<p>每一个 Schema，Table ，Index 都可以点击下钻，进入更详细的专用面板中。例如 PGCAT Schema，就进一步展现了一个架构模式内的对象细节。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144220552.png"></p>
<p>数据库内的查询，也按照执行计划进行聚合，便于用户找到问题 SQL，快速定位慢查询问题。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144223083.png"></p>
<hr>
<h2 id="监控系统重制表与查询">监控系统重制：表与查询</h2>
<p>在 Pigsty 中，您可以查阅一张表的方方面面。PGCAT Table 面板可以让您查看表的元数据，上面的索引，每一列的统计信息，以及相关的查询。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144225138.png"></p>
<p>当然，您也可以使用 PGSQL Table 面板，从指标的维度，查阅一张表在任意历史时间段上的关键指标。点击表名即可轻松在两个视角进行切换。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144229980.png"></p>
<p>相应地，您也可以获取（具有相同执行计划）的同一类 SQL 的详细信息。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144232326.png"></p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144234393.png"></p>
<p>在 Pigsty 中，还有许多关于特定主题的 Dashboard。限于篇幅，关于监控系统的介绍就是这些。最直观的体验方式，就是访问 Pigsty 提供的公开 Demo：http://demo.pigsty.cc ，亲自上手把玩一番。虽然这只是一个4台1C虚拟机的简陋环境，但用来展示Pigsty最基本的监控系统能力已经是足够了。</p>
<hr>
<h2 id="大号仿真环境">大号仿真环境</h2>
<p>Pigsty 提供了一个基于 Vagrant 与 Virtualbox 的沙箱环境，可以跑在你的笔记本电脑/Mac上，有一个 1 节点的最小版本，和一个4节点的完整版本，用与演示与学习，而现在 v2.2 中又多了一个 <strong>42</strong> 节点的生产仿真版本沙箱。</p>
<p>生产沙箱的所有细节都由 prod.yml 这个五百行不到的配置文件描述，它可以轻松跑在一台普通的服务器物理机上，而拉起它过程与4节点并无二致：make prod install 即可完工。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144236407.png"></p>
<p>Pigsty v2.2 提供了基于 libvirt 的 Vagrantfile 模板，您只需要调整上面配置中的机器清单，即可一键创建出所需的虚拟机来。所有东西都可以轻松跑在一台 Dell R730 48C 256G 物理机上，二手价不到三千元。当然，您依然可以使用 Pigsty Terraform 模板一键在云厂商上拉起虚拟机。</p>
<p>安装完成后环境如下所示，包含两节点的监控基础设施，一主一备。5节点的专用 etcd 集群，3 节点的样例 MinIO 集群提供对象存储服务存放 PG 备份，还有一个两节点的专用 HAProxy 集群，可以统一为数据库服务提供负载均衡。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.2.0/640-20240929144238822.png"></p>
<p>在此之上，还有3套Redis数据库集群与10套规格各异的 PostgreSQL 数据库集群与，其中还包括一套开箱即用的 5 分片的 Citus 12 分布式 PostgreSQL 集群。</p>
<p>![图片](data:image/svg+xml,%3C%3Fxml version=&lsquo;1.0&rsquo; encoding=&lsquo;UTF-8&rsquo;%3F%3E%3Csvg width=&lsquo;1px&rsquo; height=&lsquo;1px&rsquo; viewBox=&lsquo;0 0 1 1&rsquo; version=&lsquo;1.1&rsquo; xmlns=&lsquo;<a href="http://www.w3.org/2000/svg'">http://www.w3.org/2000/svg'</a> xmlns:xlink=&lsquo;<a href="http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg">http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg</a> stroke=&lsquo;none&rsquo; stroke-width=&lsquo;1&rsquo; fill=&lsquo;none&rsquo; fill-rule=&lsquo;evenodd&rsquo; fill-opacity=&lsquo;0&rsquo;%3E%3Cg transform=&lsquo;translate(-249.000000, -126.000000)&rsquo; fill=&rsquo;%23FFFFFF&rsquo;%3E%3Crect x=&lsquo;249&rsquo; y=&lsquo;126&rsquo; width=&lsquo;1&rsquo; height=&lsquo;1&rsquo;%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)</p>
<p>这个配置是中大型企业运行管理大规模数据库集群的参考样例，而您可以在单台物理服务器上用半个小时完整一键拉起。</p>
<hr>
<h2 id="更丝滑的构建流程">更丝滑的构建流程</h2>
<p>当您选择直接从互联网下载 Pigsty 所需的软件时，可能会遭遇到功夫网的烦恼。例如，默认的 Grafana / Prometheus Yum 源下载速度极慢。除此之外，还有一些零散的 RPM 包需要通过 Web URL 的方式，而不是 repotrack RPM 的方式进行下载。</p>
<p>在 Pigsty v2.2 中，解决了这个问题。Pigsty 提供了一个官方的 yum 源：http://get.pigsty.cc ，并配置为默认的上游源之一。所有零散的 RPM，需要翻墙的 RPM 都放置其中，可以有效加快在线安装/构建速度。</p>
<p>此外， Pigsty 还在 v2.2 中提供了对信创操作系统，统信 UOS 1050e uel20 的支持，满足一些特殊客户的特殊需求。Pigsty 针对这些系统重新编译了 PG相关的 RPM 包，为有需求的客户提供支持。</p>
<hr>
<h2 id="安装">安装</h2>
<p>从 v2.2 开始，Pigsty 的安装命令变为：</p>
<p><strong>bash -c &ldquo;$(curl -fsSL <a href="http://get.pigsty.cc/latest%29%22">http://get.pigsty.cc/latest)"</a></strong></p>
<p>一行命令，即可在全新机器上完整安装 Pigsty. 如果您想要尝鲜 beta 版本，将 latest 换为 beta 即可。对于没有互联网访问的特殊环境，您也可以使用以下链接下载 Pigsty，以及打包了所有软件的离线安装包：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http://get.pigsty.cc/v2.2.0/pigsty-v2.2.0.tgz
</span></span><span style="display:flex;"><span>http://get.pigsty.cc/v2.2.0/pigsty-pkg-v2.2.0.el7.x86_64.tgz
</span></span><span style="display:flex;"><span>http://get.pigsty.cc/v2.2.0/pigsty-pkg-v2.2.0.el8.x86_64.tgz
</span></span><span style="display:flex;"><span>http://get.pigsty.cc/v2.2.0/pigsty-pkg-v2.2.0.el9.x86_64.tgz
</span></span></code></pre></div><p>以上，就是 Pigsty v2.2 带来的变化。</p>
<p>更多细节，请参考 Pigsty 官方文档：https://vonng.github.io/pigsty/ 与 Github Release Note： <a href="https://github.com/Vonng/pigsty/releases/tag/v2.2.0">https://github.com/Vonng/pigsty/releases/tag/v2.2.0</a></p>
<hr>
<h2 id="v220">v2.2.0</h2>
<p>相关文章：《<a href="https://mp.weixin.qq.com/s/NfQEL6fM8FA-ErijucXJ4g">Pigsty v2.2 发布 —— 监控系统大升级</a>》</p>
<p>发布注记：https://github.com/Vonng/pigsty/releases/tag/v2.2.0</p>
<p>快速开始： <code>bash -c &quot;$(curl -fsSL https://get.pigsty.cc/latest)&quot;</code></p>
<p><strong>亮点特性</strong></p>
<ul>
<li>监控面板重做: <a href="https://demo.pigsty.cc">https://demo.pigsty.cc</a></li>
<li>Vagrant沙箱重做: 支持 libvirt 与新的配置模板</li>
<li>Pigsty EL Yum 仓库: 统一收纳零碎 RPM，简化安装构建流程。</li>
<li>操作系统兼容性: 新增信创操作系统 UOS-v20-1050e 支持</li>
<li>新的配置模板：42 节点的生产仿真配置</li>
<li>统一使用官方 PGDG citus 软件包（el7）</li>
</ul>
<p><strong>软件升级</strong></p>
<ul>
<li>PostgreSQL 16 beta2</li>
<li>Citus 12 / PostGIS 3.3.3 / TimescaleDB 2.11.1 / PGVector 0.44</li>
<li>patroni 3.0.4 / pgbackrest 2.47 / pgbouncer 1.20</li>
<li>grafana 10.0.3 / loki/promtail/logcli 2.8.3</li>
<li>etcd 3.5.9 / haproxy v2.8.1 / redis v7.0.12</li>
<li>minio 20230711212934 / mcli 20230711233044</li>
</ul>
<p><strong>Bug修复</strong></p>
<ul>
<li>修复了 Docker 组权限的问题 [29434bd]https://github.com/Vonng/pigsty/commit/29434bdd39548d95d80a236de9099874ed564f9b</li>
<li>将 <code>infra</code> 操作系统用户组作为额外的组，而不是首要用户组。</li>
<li>修复了 Redis Sentinel Systemd 服务的自动启用状态 <a href="https://github.com/Vonng/pigsty/commit/5c96feb598ad6e44daa7a595e34c87e67952777b">5c96feb</a></li>
<li>放宽了 <code>bootstrap</code> &amp; <code>configure</code> 的检查，特别是当 <code>/etc/redhat-release</code> 不存在的时候。</li>
<li>升级到 Grafana 10，修复了 Grafana 9.x <a href="https://grafana.com/blog/2023/03/22/grafana-security-release-new-versions-with-security-fixes-for-cve-2023-1410/">CVE-2023-1410</a></li>
<li>在 CMDB <code>pglog</code> 模式中添加了 PG 14 - 16 的 command tags 与 错误代码。</li>
</ul>
<p><strong>API变化</strong></p>
<p>新增1个变量</p>
<ul>
<li><code>INFRA</code>.<code>NGINX</code>.<code>nginx_exporter_enabled</code>: 现在用户可以通过设置这个参数来禁用 nginx_exporter 。</li>
</ul>
<p>默认值变化:</p>
<ul>
<li><code>repo_modules</code>: <code>node,pgsql,infra</code> : redis 现在由 pigsty-el 仓库提供，不再需要 <code>redis</code> 模块。</li>
<li><code>repo_upstream</code>:
<ul>
<li>新增 <code>pigsty-el</code>: 与具体EL版本无关的RPM: 例如 grafana, minio, pg_exporter, 等等……</li>
<li>新增 <code>pigsty-misc</code>: 与具体EL版本有关的RPM: 例如 redis, prometheus 全家桶，等等……</li>
<li>移除 <code>citus</code>: 现在 PGDG 中有完整的 EL7 - EL9 citus 12 支持</li>
<li>移除 <code>remi</code>: redis 现在由 pigsty-el 仓库提供，不再需要 <code>redis</code> 模块。</li>
</ul>
</li>
<li><code>repo_packages</code>:
<ul>
<li>ansible python3 python3-pip python3-requests python3.11-jmespath dnf-utils modulemd-tools # el7: python36-requests python36-idna yum-utils</li>
<li>grafana loki logcli promtail prometheus2 alertmanager karma pushgateway node_exporter blackbox_exporter nginx_exporter redis_exporter</li>
<li>redis etcd minio mcli haproxy vip-manager pg_exporter nginx createrepo_c sshpass chrony dnsmasq docker-ce docker-compose-plugin flamegraph</li>
<li>lz4 unzip bzip2 zlib yum pv jq git ncdu make patch bash lsof wget uuid tuned perf nvme-cli numactl grubby sysstat iotop htop rsync tcpdump</li>
<li>netcat socat ftp lrzsz net-tools ipvsadm bind-utils telnet audit ca-certificates openssl openssh-clients readline vim-minimal</li>
<li>postgresql13* wal2json_13* pg_repack_13* passwordcheck_cracklib_13* postgresql12* wal2json_12* pg_repack_12* passwordcheck_cracklib_12* postgresql16* timescaledb-tools</li>
<li>postgresql15 postgresql15* citus_15* pglogical_15* wal2json_15* pg_repack_15* pgvector_15* timescaledb-2-postgresql-15* postgis33_15* passwordcheck_cracklib_15* pg_cron_15*</li>
<li>postgresql14 postgresql14* citus_14* pglogical_14* wal2json_14* pg_repack_14* pgvector_14* timescaledb-2-postgresql-14* postgis33_14* passwordcheck_cracklib_14* pg_cron_14*</li>
<li>patroni patroni-etcd pgbouncer pgbadger pgbackrest pgloader pg_activity pg_partman_15 pg_permissions_15 pgaudit17_15 pgexportdoc_15 pgimportdoc_15 pg_statement_rollback_15*</li>
<li>orafce_15* mysqlcompat_15 mongo_fdw_15* tds_fdw_15* mysql_fdw_15 hdfs_fdw_15 sqlite_fdw_15 pgbouncer_fdw_15 multicorn2_15* powa_15* pg_stat_kcache_15* pg_stat_monitor_15* pg_qualstats_15 pg_track_settings_15 pg_wait_sampling_15 system_stats_15</li>
<li>plprofiler_15* plproxy_15 plsh_15* pldebugger_15 plpgsql_check_15*  pgtt_15 pgq_15* pgsql_tweaks_15 count_distinct_15 hypopg_15 timestamp9_15* semver_15* prefix_15* rum_15 geoip_15 periods_15 ip4r_15 tdigest_15 hll_15 pgmp_15 extra_window_functions_15 topn_15</li>
<li>pg_background_15 e-maj_15 pg_catcheck_15 pg_prioritize_15 pgcopydb_15 pg_filedump_15 pgcryptokey_15 logerrors_15 pg_top_15 pg_comparator_15 pg_ivm_15* pgsodium_15* pgfincore_15* ddlx_15 credcheck_15 safeupdate_15 pg_squeeze_15* pg_fkpart_15 pg_jobmon_15</li>
</ul>
</li>
<li><code>repo_url_packages</code>:
<ul>
<li><a href="https://get.pigsty.cc/rpm/pev.html">https://get.pigsty.cc/rpm/pev.html</a></li>
<li><a href="https://get.pigsty.cc/rpm/chart.tgz">https://get.pigsty.cc/rpm/chart.tgz</a></li>
</ul>
</li>
<li><code>node_default_packages</code>:
<ul>
<li>lz4,unzip,bzip2,zlib,yum,pv,jq,git,ncdu,make,patch,bash,lsof,wget,uuid,tuned,nvme-cli,numactl,grubby,sysstat,iotop,htop,rsync,tcpdump</li>
<li>netcat,socat,ftp,lrzsz,net-tools,ipvsadm,bind-utils,telnet,audit,ca-certificates,openssl,readline,vim-minimal,node_exporter,etcd,haproxy,python3,python3-pip</li>
</ul>
</li>
<li><code>infra_packages</code>
<ul>
<li>grafana,loki,logcli,promtail,prometheus2,alertmanager,karma,pushgateway</li>
<li>node_exporter,blackbox_exporter,nginx_exporter,redis_exporter,pg_exporter</li>
<li>nginx,dnsmasq,ansible,postgresql15,redis,mcli,python3-requests</li>
</ul>
</li>
<li><code>PGSERVICE</code> in <code>.pigsty</code> 被移除了，取而代之的是 <code>PGDATABASE=postgres</code>，这用户只需 IP 地址就可以从管理节点访问特定实例。</li>
</ul>
<p>目录结构变化:</p>
<ul>
<li><code>bin/dns</code> and <code>bin/ssh</code> 现在被移动到 <code>vagrant/</code> 目录中。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>MD5 <span style="color:#ce5c00;font-weight:bold">(</span>pigsty-pkg-v2.2.0.el7.x86_64.tgz<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> 5fb6a449a234e36c0d895a35c76add3c
</span></span><span style="display:flex;"><span>MD5 <span style="color:#ce5c00;font-weight:bold">(</span>pigsty-pkg-v2.2.0.el8.x86_64.tgz<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> c7211730998d3b32671234e91f529fd0
</span></span><span style="display:flex;"><span>MD5 <span style="color:#ce5c00;font-weight:bold">(</span>pigsty-pkg-v2.2.0.el9.x86_64.tgz<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> 385432fe86ee0f8cbccbbc9454472fdd
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-1faf1f211dddb5c08bd00bf6bd5453e2">v2.1：向量&#43;PG全系支持！</h1>
	<div class="lead">Pigsty v2.1 提供了对 PostgreSQL 12 ~ 16 的支持</div>
	<div class="td-byline mb-4">
		By <b>Ruohang Feng（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2023-06-09" class="text-muted">2023年06月09日</time>
        
	</div>
	<p>随着 PostgreSQL 夏季小版本例行更新，与 16 Beta 的发布，Pigsty 也紧随PG社区发布了 <strong>v2.1</strong> 版本，这次更新支持了 16 Beta1 的高可用与新监控指标，也提供了 PG 12 - 15 版本的支持。同时，AI 向量扩展插件 PGVector 也于 2.0.2 正式进入 Pigsty 中并默认启用。</p>
<p><a href="https://github.com/Vonng/pigsty/releases/tag/v2.1.0">https://github.com/Vonng/pigsty/releases/tag/v2.1.0</a></p>
<h3 id="向量数据库扩展-pgvector">向量数据库扩展 PGVector</h3>
<p>最近向量数据库非常火爆，市面上有许多专用向量数据库产品，商业的有 Pinecone，Zilliz，开源的有 Milvus，Qdrant 等。在所有现有向量数据库中，<strong>pgvector</strong> 是一个独特的存在 —— 它选择了在现有的世界上最强大的开源关系型数据库 PostgreSQL 上以插件的形式添砖加瓦，而不是另起炉灶做成另一个专用的“数据库”。毕竟从零开始做好一个TP数据库还是非常难的。</p>
<p><strong>pgvector</strong> 有着优雅简单易用的接口，不俗的性能表现，更是继承了PG生态的超能力集合。在以前，PGVECTOR 需要自行下载编译安装，所以我提了一个 Issue 把它加入到 PostgreSQL 全球开发组的官方仓库中。你只需要正常使用 PGDG 源即可直接 <code>yum install pgvector_15</code> 完成安装。在安装了 <code>pgvector</code> 的数据库实例中使用 <code>CREATE EXTENSION vector</code> 即可启用此扩展。</p>
<p>但是使用 Pigsty，你甚至都不需要这个过程。在3月底发布的 Pigsty v2.0.2 中，就已经默认集成并安装了 PGVector 扩展。你只需要 <code>CREATE EXTENSION vector</code> 即可开箱即用。PGVector 的使用方式，应用场景案例，工作原理，请参考本号前一篇文章：《<a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247485589&idx=1&sn=931f2d794e9b8486f623f746db9f00cd&chksm=fe4b3d4ec93cb4584c9bb44b1f347189868b6c8367d8c3f8dd8703d1a906786a55c900c23761&scene=21#wechat_redirect">AI大模型与向量数据库 PGVECTOR</a>》。</p>
<p>同时透露一下，我们正在制作一个功能、性能、易用性更好的 PGVector 实现，将于后续版本纳入 Pigsty 中，敬请期待。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.1.0/640-20240929144300754"></p>
<h3 id="pg16支持与可观测性">PG16支持与可观测性</h3>
<p>Pigsty 也许是最快提供 PostgreSQL 16 支持的发行版 —— 尽管目前仍然处于 Beta 状态，一些功能扩展仍然没有跟进，但你已经可以拉起 PostgreSQL 16 的高可用集群体验测试起来。PostgreSQL 16 有一些比较实用的新功能：从库逻辑解码与逻辑复制，针对I/O的新统计视图，全连接的并行执行，更好的冻结性能，符合 SQL/JSON 标准的新函数集，以及在HBA认证中使用正则表达式。</p>
<p>Pigsty 特别关注 PostgreSQL 16 中的可观测性改进，新的 <code>pg_stat_io</code> 视图，让用户可以直接从数据库内访问到重要的 I/O 统计指标，对于性能优化，故障分析具有非常重要的意义。在以前，用户只能在数据库/BGWriter上看到有限的统计指标，想要更精细的统计数据，只能关联操作系统层面的I/O指标进行分析。现在，你可以从后端进程类型/关系类型/操作类型三个维度，对读/写/追加/回刷/Fsync/命中/逐出等行为进行深入的洞察。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.1.0/640-20240929144302137"></p>
<p>另外一个非常有价值的可观测性改进点是，<code>pg_stat_all_tables</code> 与 <code>pg_stat_all_indexes</code> 会记录最后一次顺序扫描 / 索引扫描的时间。尽管这个功能在 Pigsty 的监控系统中可以通过扫描统计图表实现，但官方提供直接的支持肯定更好：用户可以直观地得出一些结论：比如某一个索引是不是没用上可以考虑移除。此外，<code>n_tup_newpage_upd</code> 指标可以告诉我们表上有多少行在更新时不是在页内原地更新，而是移动到了一个新的页面上，这个指标对于优化 UPDATE 性能，调整表填充因子具有重要的参考价值。</p>
<h3 id="pgsql-12---15-支持">PGSQL 12 - 15 支持</h3>
<p>Pigsty 从 PostgreSQL 10 开始提供支持，但一直紧跟社区主干的最新版本。但用户确实会有使用旧版本的需求 —— 有的是外部组件最高就支持某个版本，有的是对最新的大版本有所顾虑希望谨慎升级，有的是因为想要从现有的低版本集群创建一个由 Pigsty 托管的 Standby Cluster 完成迁移。不管怎么样，对于较低版本的 PostgreSQL 支持是一个来自用户侧的真实需求。因此我们在 2.1 中，加入了 PG 12 -14 三个大版本的支持，并默认纳入离线软件包中。</p>
<p>每个大版本除了核心的软件包，也包括了相应版本的重要扩展插件：地理空间插件 PostGIS，时序数据库插件 <strong>TimescaleDB</strong>，分布式数据库插件 <strong>citus</strong>，向量数据库插件 <strong>PGVector</strong>，在线垃圾清理插件 <strong>pg_repack</strong>，CDC逻辑解码插件 <strong>wal2json</strong> 与 <strong>pglogical</strong>，定时任务插件 <strong>pg_cron</strong>，以及强制检查密码强度的插件 <strong>passwordcheck_cracklib</strong> ，确保每个大版本都可以享受到 PostgreSQL 生态的核心能力。</p>
<p><img alt="图片" src="https://mmbiz.qpic.cn/mmbiz_png/Wkpr3rA9wF2x7uWVvRRWtoD8z1o2SArPsPHf3F2auz2O9k86GuibzhYjyNDp6v6UWYDvPNsQ84yapIAVicrJYTSA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1"></p>
<p>PostgreSQL 11 其实也可以支持，但因为有一些扩展缺失，加之即将进入 EOL，所以就排除在本次更新中。对于新尝试 PostgreSQL 的用户，我们始终建议从最新的稳定大版本（目前为15）开始使用。如果您真的希望使用 10 或 11，也可以参照教程调整仓库中的软件包版本自行构建。</p>
<h3 id="grafana监控系统改进">Grafana监控系统改进</h3>
<p>随着 Grafana 版本升级至 v9.5.3 ， 全新的导航栏，面板布局让 Pigsty 的监控系统 UI 也随之焕然一新。所有监控面板都根据新 UI 的特性进行了微调与适配，一些不和谐的样式问题也得到了修正。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.1.0/640-20240929144304062"></p>
<p>在 Pigsty 2.1 中引入了4个来自 <code>volkovlabs</code> 的 Grafana 扩展插件。使用 Grafana + Echarts 进行数据可视化与分析一直是 Pigsty 所倡导和支持的一个功能亮点，奈何作者精力有限，难以在这个方向投入资源。</p>
<p>在 v2.1 发布前，我很高兴看到一个由专人维护的 Apache Echarts 面板插件 —— 终于可以松一口气，让自己维护的 echarts panel 退休了。有一个专业的创业团队选择这个方向进行拓展，并开发出一系列实用的扩展插件。可以使用后端数据渲染 SVG 与文本的动态文本插件，提供表单提交功能的 Form 插件，动态数据日历插件，等等等等。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.1.0/640-20240929144306335"></p>
<p>此外，Pigsty 还专门添加了 <code>echarts-gl</code> 的扩展资源，放置于 Grafana <code>public/chart</code> 目录下，允许用户使用 Pigsty 自带的 Grafana，无需互联网访问即可实现出 Apache Echarts 官方文档库中炫酷的三维地球等面板。</p>
<h3 id="其他便利工具的改进">其他便利工具的改进</h3>
<p>在 Pigsty 2.1 中，添加了 3 个便利命令，<code>profile</code>，<code>validate</code>，<code>repo-add</code>。</p>
<p><code>bin/validate</code> 命令接受一个配置文件路径作为输入，它用来检查验证 Pigsty 配置文件的正确性。常见的问题，例如在不同集群里错误写入了同一个 IP，一些配置项的名称，类型错误，都可以自动检查抛出，更不用说最常见的YAML缩进格式错误了。用户修改配置之后，可以使用 <code>bin/validate</code> 确保自己的修改是有效合法的。</p>
<p><code>bin/repo-add</code> 命令用于手工调整节点上的 YUM 仓库。当用户想要往本地软件仓库添加一些新的软件包时，经常需要使用 Ansible 剧本的子任务来进行管理，较为不便，现在您可以使用包装的命令行工具来完成这一点：比如，<code>bin/repo-add infra node,pgsql</code> 就会向 <code>infra</code> 分组的节点上添加分类为 <code>node</code> 与 <code>pgsql</code> 的软件源。</p>
<p><code>bin/profile</code> 命令可以便捷地针对某个 IP 地址上特定 PID 的进程进行 <code>perf</code> 采样1分钟，并在 Pigsty Web服务器目录生成火焰图，用户可以直接从网页界面打开浏览，这个功能对于分析数据库内部的故障与性能瓶颈尤为有用。</p>
<hr>
<h2 id="v210">v2.1.0</h2>
<p>相关文章：<a href="https://mp.weixin.qq.com/s/Wu9kWEFSI3oGUr8t3hrz_w">Pigsty v2.1 发布：向量扩展 / PG12-16 支持</a></p>
<p>发布注记：https://github.com/Vonng/pigsty/releases/tag/v2.1.0</p>
<p><strong>Highlight</strong></p>
<ul>
<li>PostgreSQL 16 beta 支持, 以及 12 ~ 15 的支持.</li>
<li>为 PG 12 - 15 新增了 PGVector 扩展支持，用于存储 AI 嵌入。</li>
<li>为 Grafana 添加了额外6个默认的扩展面板/数据源插件。</li>
<li>添加 <code>bin/profile</code> 脚本用于执行远程 Profiling ，生成火焰图。</li>
<li>添加 <code>bin/validate</code> 用于校验 <code>pigsty.yml</code> 配置文件合法性。</li>
<li>添加 <code>bin/repo-add</code> 用于快速向节点添加 Yum 源定义。</li>
<li>PostgreSQL 16 可观测性：添加了 <code>pg_stat_io</code> 支持与相关监控面板</li>
</ul>
<p><strong>软件升级</strong></p>
<ul>
<li>PostgreSQL 15.3 , 14.8, 13.11, 12.15, 11.20, and 16 beta1</li>
<li>pgBackRest 2.46 / pgbouncer 1.19</li>
<li>Redis 7.0.11</li>
<li>Grafana v9.5.3</li>
<li>Loki / Promtail / Logcli 2.8.2</li>
<li>Prometheus 2.44</li>
<li>TimescaleDB 2.11.0</li>
<li>minio-20230518000536 / mcli-20230518165900</li>
<li>Bytebase v2.2.0</li>
</ul>
<p><strong>改进增强</strong></p>
<ul>
<li>当添加本地用户的公钥时，所有的 <code>id*.pub</code> 都会被添加到远程机器上（例如椭圆曲线算法生成的密钥文件）</li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-27acbe2d482c252f88c15bd84c664282">v2.0：开源RDS PG替代</h1>
	<div class="lead">Pigsty v2.0 在安全性，兼容性，功能整合上进行了大量工作，真正成为 RDS 的本地开源替代品。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2023-02-26" class="text-muted">2023年02月26日</time>
        
	</div>
	<p><strong>2023/02/28</strong>，<strong>Pigsty  v2.0.0 正式发布</strong>，带来了一系列重大的功能更新。</p>
<p>现在 <strong>PIGSTY</strong> 是 &ldquo;<strong>P</strong>ostgreSQL <strong>I</strong>n <strong>G</strong>reat <strong>STY</strong>le&quot;的首字母缩写，即&rdquo;<strong>全盛状态的 PostgreSQL</strong>&quot;。而 Pigsty 的定位也不再是 “<strong>开箱即用的PostgreSQL数据库发行版</strong>”，变成了 “<strong>Me Better</strong> <strong>开源 RDS PG 替代</strong>”。</p>
<p>明人不说暗话，这是一个很有野心的目标：<strong>推翻云数据库垄断，砸烂****RDS的饭碗！<strong><strong>详见：《</strong></strong><a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247485269&idx=1&sn=a46b8b218331ece956c336b5c2a8df79&chksm=fe4b328ec93cbb98434b258ed1bfa6c63aecd0f3675002db75520edd21456eb39e97455fe995&scene=21#wechat_redirect">云数据库是不是智商税？</a>》</strong></p>
<p><img alt="图片" src="/zh/blog/releases/v2.0.0/640-20240929144324026"></p>
<h1 id="20-新特性">2.0 新特性</h1>
<p>Pigsty 是一个<strong>更好的、****本地优先</strong>的，<strong>开源</strong> <strong>RDS for PostgreSQL</strong> <strong>替代。</strong></p>
<p><img alt="图片" src="/zh/blog/releases/v2.0.0/640-20240929144327954"></p>
<h2 id="强力的发行版">强力的发行版</h2>
<p><strong>彻底释放世界上最先进的关系型数据库的力量!</strong></p>
<p>PostgreSQL 是一个足够完美的数据库内核，但它需要更多工具与系统的配合，才能成为一个足够好的数据库服务（RDS），而 Pigsty 帮助 PostgreSQL 完成这一步飞跃。</p>
<p>Pigsty 深度整合了 PostgreSQL 生态的三大核心扩展插件 <strong>PostGIS</strong>，<strong>TimescaleDB</strong>，<strong>Citus</strong>，并确保它们可以协同工作，提供分布式的时序地理空间数据库能力。Pigsty 还提供了运行企业级 RDS 服务的所需软件，打包所有依赖为离线软件包，所有组件均可在无需互联网访问的情况下一键完成安装部署，进入生产可用状态。</p>
<p>在 Pigsty 中功能组件被抽象 <strong>模块</strong>，可以自由组合以应对多变的需求场景。<strong><code>INFRA</code></strong> 模块带有完整的现代监控技术栈，而 <code>NODE</code> 模块则将节点调谐至指定状态并纳入监控。在多个节点上安装 <strong><code>PGSQL</code></strong> 模块会自动组建出一个基于主从复制的高可用数据库集群，而同样的 <strong><code>ETCD</code></strong> 模块则为数据库高可用提供共识与元数据存储。可选的 <strong><code>MINIO</code><strong>模块可以用作图像视频等大文件存储并可选用为数据库备份仓库。与 PG 有着极佳相性的 <strong><code>REDIS</code></strong> 亦为 Pigsty 所支持，更多的模块（如</strong><code>GPSQL</code></strong>, <strong><code>MYSQL</code></strong>, <strong><code>KAFKA</code></strong>）将会在后续加入，你也可以开发自己的模块并自行扩展 Pigsty 的能力。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.0.0/640-20240929144329525"></p>
<h2 id="惊艳的观测能力">惊艳的观测能力</h2>
<p><strong>使用现代开源可观测性技术栈，提供无与伦比的监控最佳实践！</strong></p>
<p>Pigsty 提供了基于开源的 Grafana / Prometheus 可观测性技术栈做监控的最佳实践：Prometheus 用于收集监控指标，Grafana 负责可视化呈现，Loki 用于日志收集与查询，Alertmanager 用于告警通知。PushGateway 用于批处理任务监控，Blackbox Exporter 负责检查服务可用性。整套系统同样被设计为一键拉起，开箱即用的 INFRA 模块。</p>
<p>Pigsty 所管理的任何组件都会被自动纳入监控之中，包括主机节点，负载均衡 HAProxy，数据库 Postgres，连接池 Pgbouncer，元数据库 ETCD，KV缓存 Redis，对象存储 MinIO，……，以及整套监控基础设施本身。大量的 Grafana 监控面板与预置告警规则会让你的系统观测能力有质的提升，当然，这套系统也可以被复用于您的应用监控基础设施，或者监控已有的数据库实例或 RDS。</p>
<p>无论是故障分析还是慢查询优化、无论是水位评估还是资源规划，Pigsty 为您提供全面的数据支撑，真正做到数据驱动。在 Pigsty 中，超过三千类监控指标被用于描述整个系统的方方面面，并被进一步加工、聚合、处理、分析、提炼并以符合直觉的可视化模式呈现在您的面前。从全局大盘总揽，到某个数据库实例中单个对象（表，索引，函数）的增删改查详情都能一览无余。您可以随意上卷下钻横向跳转，浏览系统现状与历史趋势，并预测未来的演变。详见公开演示：<strong><a href="http://demo.pigsty.cc">http://demo.pigsty.cc</a></strong>。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.0.0/640-20240929144331337"></p>
<h2 id="久经考验的可靠性">久经考验的可靠性</h2>
<p><strong>开箱即用的高可用与时间点恢复能力，确保你的数据库坚如磐石！</strong></p>
<p>对于软件缺陷或人为误操作造成的删表删库，Pigsty 提供了开箱即用的 PITR 时间点恢复能力，无需额外配置即默认启用。只要存储空间管够，基于 <code>pgBackRest</code> 的基础备份与 WAL 归档让您拥有快速回到过去任意时间点的能力。您可以使用本地目录/磁盘，亦或专用的 <strong>MinIO</strong> 集群或 <strong>S3</strong> 对象存储服务保留更长的回溯期限，丰俭由人。</p>
<p>更重要的是，Pigsty 让高可用与故障自愈成为 PostgreSQL 集群的标配，基于 <code>patroni</code>, <code>etcd</code>, 与 <code>haproxy</code> 打造的故障自愈架构，让您在面对硬件故障时游刃有余：主库故障自动切换的 <strong>RTO &lt; 30s</strong>，一致性优先模式下确保数据零损失 <strong>RPO = 0</strong>。只要集群中有任意实例存活，集群就可以对外提供完整的服务，而客户端只要连接至集群中的任意节点，即可获得完整的服务。</p>
<p>Pigsty 内置了 HAProxy 负载均衡器用于自动流量切换，提供 DNS/VIP/LVS 等多种接入方式供客户端选用。故障切换与主动切换对业务侧除零星闪断外几乎无感知，应用不需要修改连接串重启。极小的维护窗口需求带来了极大的灵活便利：您完全可以在无需应用配合的情况下滚动维护升级整个集群。硬件故障可以等到第二天再抽空善后处置的特性，让研发，运维与 DBA 都能安心睡个好觉。许多大型组织与核心机构已经在生产环境中长时间使用 Pigsty ，最大的部署有 <strong>25K CPU</strong> 核心与 200+ PostgreSQL 实例，在这一部署案例中， Pigsty 在三年内经历了数十次硬件故障与各类事故，但依然可以保持 <strong>99.999%</strong> 以上的整体可用性。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.0.0/640-20240929144333209"></p>
<h2 id="简单易用可维护">简单易用可维护</h2>
<p><strong>Infra as Code, 数据库即代码，声明式的API将数据库管理的复杂度来封装。</strong></p>
<p>Pigsty 使用声明式的接口对外提供服务，将系统的可控制性拔高到一个全新水平：用户通过配置清单告诉 Pigsty “我想要什么样的数据库集群”，而不用去操心到底需要怎样去做。从效果上讲，这类似于 K8S 中的 CRD 与 Operator，但 Pigsty 可用于任何节点上的数据库与基础设施：不论是容器，虚拟机，还是物理机。</p>
<p>无论是创建/销毁集群，添加/移除从库，还是新增数据库/用户/服务/扩展/黑白名单规则，您只需要修改配置清单并运行 Pigsty 提供的幂等剧本，而 Pigsty 负责将系统调整到您期望的状态。用户无需操心配置的细节，Pigsty将自动根据机器的硬件配置进行调优，您只需要关心诸如集群叫什么名字，有几个实例放在哪几台机器上，使用什么配置模版：事务/分析/核心/微型，这些基础信息，研发也可以自助服务。但如果您愿意跳入兔子洞中，Pigsty 也提供了丰富且精细的控制参数，满足最龟毛 DBA 的苛刻定制需求。</p>
<p>除此之外，Pigsty 本身的安装部署也是一键傻瓜式的，所有依赖被预先打包，在安装时可以无需互联网访问。而安装所需的机器资源，也可以通过 Vagrant 或 Terraform 模板自动获取，让您在十几分钟内就可以从零在本地笔记本或云端虚拟机上拉起一套完整的 Pigsty 部署。本地沙箱环境可以跑在1核2G的微型虚拟机中，提供与生产环境完全一致的功能模拟，可以用于开发、测试、演示与学习。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.0.0/640-20240929144335228"></p>
<h2 id="扎实的安全性">扎实的安全性</h2>
<p><strong>加密备份一应俱全，只要硬件与密钥安全，您无需操心数据库的安全性。</strong></p>
<p>每套 Pigsty 部署都会创建一套自签名的 CA 用于证书签发，所有的网络通信都可以使用 SSL 加密。数据库密码使用合规的 <code>scram-sha-256</code> 算法加密存储，远端备份会使用 <code>AES-256</code> 算法加密。此外还针对 PGSQL 提供了一套开箱即用的的访问控制体系，足以应对绝大多数应用场景下的安全需求。</p>
<p>Pigsty 针对 PostgreSQL 提供了一套开箱即用，简单易用，精炼灵活的，便于扩展的访问控制体系，包括职能分离的四类默认角色：读(DQL) / 写(DML) / 管理(DDL) / 离线(ETL) ，与四个默认用户：dbsu / replicator / monitor / admin。所有数据库模板都针对这些角色与用户配置有合理的默认权限，而任何新建的数据库对象也会自动遵循这套权限体系，而客户端的访问则受到一套基于最小权限原则的设计的 HBA 规则组限制，任何敏感操作都会记入日志审计。</p>
<p>任何网络通信都可以使用 SSL 加密，需要保护的敏感管理页面与API端点都受到多重保护：使用用户名与密码进行认证，限制从管理节点/基础设施节点IP地址/网段访问，要求使用 HTTPS 加密网络流量。Patroni API 与 Pgbouncer 因为性能因素默认不启用 SSL ，但亦提供安全开关便于您在需要时开启。合理配置的系统通过等保三级毫无问题，只要您遵循安全性最佳实践，内网部署并合理配置安全组与防火墙，数据库安全性将不再是您的痛点。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.0.0/640-20240929144337073"></p>
<h2 id="广泛的应用场景">广泛的应用场景</h2>
<p><strong>使用预置的Docker模板，一键拉起使用PostgreSQL的海量软件！</strong></p>
<p>在各类数据密集型应用中，数据库往往是最为棘手的部分。例如 Gitlab 企业版与社区版的核心区别就是底层 PostgreSQL 数据库的监控与高可用，如果您已经有了足够好的本地 <strong>PG RDS</strong>，又为什么要为软件自带的土法手造数据库掏钱？</p>
<p>Pigsty 提供了 Docker 模块与大量开箱即用的 Compose 模板。您可以使用 Pigsty 管理的高可用 PostgreSQL （以及 Redis 与 MinIO ）作为后端存储，以无状态的模式一键拉起这些软件：Gitlab、Gitea、Wiki.js、Odoo、Jira、Confluence、Habour、Mastodon、Discourse、KeyCloak 等等。如果您的应用需要一个靠谱的 PostgreSQL 数据库， Pigsty 也许是最简单的获取方案。</p>
<p>Pigsty 也提供了与 PostgreSQL 紧密联系的应用开发工具集：PGAdmin4、PGWeb、ByteBase、PostgREST、Kong、以及 EdgeDB、FerretDB、Supabase 这些使用 PostgreSQL 作为存储的&quot;上层数据库&quot;。更奇妙的是，您完全可以基于 Pigsty 内置了的 Grafana 与 Postgres ，以低代码的方式快速搭建起一个交互式的数据应用来，甚至还可以使用 Pigsty 内置的 ECharts 面板创造更有表现力的交互可视化作品。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.0.0/640-20240929144338845"></p>
<h2 id="开源免费的自由软件">开源免费的自由软件</h2>
<p><strong>Pigsty是基于 AGPLv3 开源的自由软件，由热爱 PostgreSQL 的社区成员用热情浇灌</strong></p>
<p>Pigsty 是完全开源免费的自由软件，它允许您在缺乏数据库专家的情况下，用几乎接近纯硬件的成本来运行企业级的 PostgreSQL 数据库服务。作为对比，公有云厂商提供的 RDS 会收取底层硬件资源几倍到十几倍不等的溢价作为 “服务费”。</p>
<p>（ 参考阅读：<a href="http://mp.weixin.qq.com/s?__biz=MzU5ODAyNTM5Ng==&mid=2247485292&idx=1&sn=4f650c3f5c3fb5207c55ff67e44d7d8a&chksm=fe4b32b7c93cbba190e60d477061d19a165e1f9b074beb00b132ae1369a9fd2c7d10ed77a013&scene=21#wechat_redirect">为什么说云数据库是杀猪盘</a> ）</p>
<p>很多用户选择上云，正是因为自己搞不定数据库；很多用户使用 RDS，是因为别无他选。我们将打破云厂商的垄断，为用户提供一个云中立的，更好的 RDS 开源替代：Pigsty 紧跟 PostgreSQL 上游主干，不会有供应商锁定，不会有恼人的 “授权费”，不会有节点数量限制，不会收集您的任何数据。您的所有的核心资产 —— 数据，都能&quot;自主可控&quot;，掌握在自己手中。</p>
<p>Pigsty 本身旨在用数据库自动驾驶软件，替代大量无趣的人肉数据库运维工作，但再好的软件也没法解决所有的问题。总会有一些的冷门低频疑难杂症需要专家介入处理。这也是为什么我们也提供专业的订阅服务，来为有需要的企业级用户使用 PostgreSQL 提供兜底。几万块的订阅咨询费不到顶尖 DBA 每年工资的几十分之一，让您彻底免除后顾之忧，把成本真正花在刀刃上。当然对于社区用户，我们亦用爱发电，提供免费的支持与日常答疑。</p>
<p><img alt="图片" src="/zh/blog/releases/v2.0.0/640-20240929144340886"></p>
<h2 id="heading"></h2>
<h1 id="20-快速上手">2.0 快速上手</h1>
<p>Pigsty 2.0 的安装依然是一条命令搞定所有：</p>
<p>curl -fsSL <a href="http://download.pigsty.cc/get">http://download.pigsty.cc/get</a>) | bash</p>
<p><img alt="图片" src="/zh/blog/releases/v2.0.0/640-20240929144342750"></p>
<p>如果互联网访问受限，您可以提前从 Github 或 CDN 下载对应操作系统的离线软件包进行离线安装。监控系统部分提供公开的 Demo：<strong><a href="http://demo.pigsty.cc">http://demo.pigsty.cc</a> 。</strong></p>
<p><img alt="图片" src="/zh/blog/releases/v2.0.0/640-20240929144344362"></p>
<hr>
<h2 id="v200">v2.0.0</h2>
<p>相关文章：</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/-E_-HZ7LvOze5lmzy3QbQA">更好的开源RDS替代：Pigsty</a></li>
<li><a href="https://mp.weixin.qq.com/s/WsR-c64OJfkMql7zX7XmDA">炮打 RDS，Pigsty v2.0 发布</a></li>
<li><a href="https://mp.weixin.qq.com/s/9lceZdyUZU9AzsqlAcpjTA">Pigsty v2 正式发布：更好的RDS PG开源替代</a></li>
<li><a href="https://mp.weixin.qq.com/s/g-ZPWqBwjzaxZKxyjVmFig">Pigsty 2.0 展望</a></li>
</ul>
<p>Pigsty <a href="https://github.com/Vonng/pigsty/releases/tag/v2.0.0">v2.0.0</a> 正式发布！</p>
<p>从v2.0.0开始，PIGSTY 现在是 &ldquo;PostgreSQL In Great STYle&quot;的首字母缩写，即&quot;全盛状态的PostgreSQL&rdquo;。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -fsSL http://download.pigsty.cc/get <span style="color:#000;font-weight:bold">|</span> bash
</span></span></code></pre></div><details><summary>Download directly from GitHub Release</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bash -c <span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>curl -fsSL https://raw.githubusercontent.com/Vonng/pigsty/master/bin/get<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># or download tarball directly with curl (EL9)</span>
</span></span><span style="display:flex;"><span>curl -L https://github.com/Vonng/pigsty/releases/download/v2.0.0/pigsty-v2.0.0.tgz -o ~/pigsty.tgz
</span></span><span style="display:flex;"><span>curl -L https://github.com/Vonng/pigsty/releases/download/v2.0.0/pigsty-pkg-v2.0.0.el9.x86_64.tgz  -o /tmp/pkg.tgz
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># EL7: https://github.com/Vonng/pigsty/releases/download/v2.0.0/pigsty-pkg-v2.0.0.el7.x86_64.tgz</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># EL8: https://github.com/Vonng/pigsty/releases/download/v2.0.0/pigsty-pkg-v2.0.0.el8.x86_64.tgz</span>
</span></span></code></pre></div></details>
<h2 id="亮点">亮点</h2>
<ul>
<li>完美整合 PostgreSQL 15, PostGIS 3.3, Citus 11.2, TimescaleDB 2.10，分布式地理时序超融合数据库。</li>
<li>OS兼容性大幅增强：支持 EL7，8，9，以及 RHEL, CentOS, Rocky, OracleLinux, AlmaLinux等兼容发行版。</li>
<li>安全性改进：自签名CA，全局网络流量SSL加密，密码scram-sha-256认证，备份采用AES加密，重制的HBA规则系统。</li>
<li>Patroni升级至3.0，提供原生的高可用 Citus 分布式集群支持，默认启用FailSafe模式，无惧DCS故障致全局主库瘫痪。</li>
<li>提供基于 pgBackRest 的开箱即用的时间点恢复 PITR 支持，默认支持本地文件系统与专用MinIO/S3集群备份。</li>
<li>新模块 <code>ETCD</code>，可独立部署，简易扩缩容，自带监控高可用，彻底取代 Consul 作为高可用 PG 的 DCS。</li>
<li>新模块 <code>MINIO</code>，可独立部署，支持多盘多节点部署，用作S3本地替代，亦用于集中式 PostgreSQL 备份仓库。</li>
<li>大幅精简配置文件参数，无需默认值即可使用；模板自动根据机器规格调整主机与PG参数，HBA/服务的定义更简洁泛用。</li>
<li>受 Grafana 与 MinIO 影响，软件协议由 Apache License 2.0 变更为 AGPL 3.0</li>
</ul>
<h2 id="兼容性">兼容性</h2>
<ul>
<li>支持 EL7, EL8, EL9 三个大版本，并提供三个版本对应的离线软件包，默认开发测试环境由EL7升级至EL9。</li>
<li>支持更多EL兼容Linux发行版：RHEL, CentOS, RockyLinux, AlmaLinux, OracleLinux等…</li>
<li>源码包与离线软件包的命名规则发生改变，现在版本号，操作系统版本号，架构都会体现在包名中。</li>
<li><code>PGSQL</code>: PostgreSQL 15.2, PostGIS 3.3, Citus 11.2, TimescaleDB 2.10 现可同时使用，协同工作。</li>
<li><code>PGSQL</code>: Patroni 升级至 3.0 版本，作为 PGSQL 的高可用组件。
<ul>
<li>默认使用 ETCD 作为 DCS，取代 Consul，减少一个 Consul Agent 失效点。</li>
<li>因为 vip-manager 升级至 2.1 并使用 ETCDv3 API，彻底弃用 ETCDv2 API，Patroni同理</li>
<li>提供原生的高可用 Citus 分布式集群支持。使用完全开源所有功能的 Citus 11.2。</li>
<li>默认启用FailSafe模式，无惧DCS故障致全局主库瘫痪。</li>
</ul>
</li>
<li><code>PGSQL</code>: 引入 pgBackrest v2.44 提供开箱即用的 PostgreSQL 时间点恢复 PITR 功能
<ul>
<li>默认使用主库上的备份目录创建备份仓库，滚动保留两天的恢复窗口。</li>
<li>默认备选备份仓库为专用 MinIO/S3 集群，滚动保留两周的恢复窗口，本地使用需要启用 MinIO 模块。</li>
</ul>
</li>
<li><code>ETCD</code> 现在作为一个独立部署的模块，带有完整的扩容/缩容方案与监控。</li>
<li><code>MINIO</code> 现在成为一个独立部署的模块，支持多盘多节点部署，用作S3本地替代，亦可用作集中式备份仓库。</li>
<li><code>NODE</code> 模块现在包含 <code>haproxy</code>, <code>docker</code>, <code>node_exporter</code>, <code>promtail</code> 功能组件
<ul>
<li><code>chronyd</code> 现在取代 <code>ntpd</code> 成为所有节点默认的 NTP 服务。</li>
<li>HAPROXY 现从属于 <code>NODE</code> 的一部分，而不再是 <code>PGSQL</code> 专属，可以 NodePort 的方式对外暴露服务。</li>
<li>现在 <code>PGSQL</code> 模块可以使用专用的集中式 HAPROXY 集群统一对外提供服务。</li>
</ul>
</li>
<li><code>INFRA</code> 模块现在包含 <code>dnsmasq</code>, <code>nginx</code>, <code>prometheus</code>, <code>grafana</code>, <code>loki</code> 等组件
<ul>
<li>Infra 模块中的 DNSMASQ 服务器默认启用，并添加为所有节点的默认 DNS 服务器之一。</li>
<li>添加了 <code>blackbox_exporter</code> 用于主机 PING 探测，<code>pushgateway</code> 用于批处理任务指标。</li>
<li><code>loki</code> 与 <code>promtail</code> 现在使用 Grafana 默认的软件包，使用官方的 Grafana Echarts 面板插件</li>
<li>提供针对 PostgreSQL 15 的新增可观测性位点的监控支持，添加 Patroni 监控</li>
</ul>
</li>
<li>软件版本升级
<ul>
<li>PostgreSQL 15.2 / PostGIS 3.3 / TimescaleDB 2.10 / Citus 11.2</li>
<li>Patroni 3.0 / Pgbouncer 1.18 / pgBackRest 2.44 / vip-manager 2.1</li>
<li>HAProxy 2.7 / Etcd 3.5 / MinIO 20230131022419 / mcli 20230128202938</li>
<li>Prometheus 2.42 / Grafana 9.3 / Loki &amp; Promtail 2.7 / Node Exporter 1.5</li>
</ul>
</li>
</ul>
<h2 id="安全性">安全性</h2>
<ul>
<li>启用了一个完整的本地自签名CA：<code>pigsty-ca</code>，用于签发内网组件所使用的证书。</li>
<li>创建用户/修改密码的操作将不再会在日志文件中留下痕迹。</li>
<li>Nginx 默认启用 SSL 支持（如需HTTPS，您需要在系统中信任<code>pigsty-ca</code>，或使用Chrome <code>thisisunsafe</code>）</li>
<li>ETCD 全面启用 SSL 加密客户端与服务端对等通信</li>
<li>PostgreSQL 添加并默认启用了 SSL 支持，管理链接默认都使用SSL访问。</li>
<li>Pgbouncer 添加了 SSL 支持，出于性能考虑默认不启用。</li>
<li>Patroni 添加了 SSL 支持，并默认限制了管理 API 只能从本机与管理节点使用密码认证方可访问。</li>
<li>PostgreSQL 的默认密码认证方式由 <code>md5</code> 改为 <code>scram-sha-256</code>。</li>
<li>Pgbouncer添加了认证查询支持，可以动态管理连接池用户。</li>
<li>pgBackRest 使用远端集中备份存储仓库时，默认使用 <code>AES-256-CBC</code> 加密备份数据。</li>
<li>提供高安全等级配置模板：强制使用全局 SSL，并要求使用管理员证书登陆。</li>
<li>所有默认HBA规则现在全部在配置文件中显式定义。</li>
</ul>
<h2 id="可维护性">可维护性</h2>
<ul>
<li>现有的配置模板可根据机器规格（CPU/内存/存储）自动调整优化。</li>
<li>现在可以动态配置 Postgres/Pgbouncer/Patroni/pgBackRest 的日志目录：默认为：<code>/pg/log/&lt;type&gt;/</code></li>
<li>原有的 IP 地址占位符 <code>10.10.10.10</code> 被替换为一个专用变量：<code>${admin_ip}</code>，可在多处引用，便于切换备用管理节点。</li>
<li>您可以指定 <code>region</code> 来使用不同地区的上游镜像源，以加快软件包的下载速度。</li>
<li>现在允许用户定义更细粒度的上游源地址，您可以根据不同的EL版本、架构，以及地区，使用不同的上游源。</li>
<li>提供了阿里云与AWS中国地区的 Terraform 模板，可用于一键拉起所需的 EC2 虚拟机。</li>
<li>提供了多种不同规格的 Vagrant 沙箱模板：<code>meta</code>, <code>full</code>, <code>el7/8/9</code>, <code>minio</code>, <code>build</code>, <code>citus</code></li>
<li>添加了新的专用剧本：<code>pgsql-monitor.yml</code> 用于监控现有的 Postgres 实例或 RDS。</li>
<li>添加了新的专用剧本：<code>pgsql-migration.yml</code> ，使用逻辑复制无缝迁移现有实例至 Pigsty管理的集群。</li>
<li>添加了一系列专用 Shell 实用命令，封装常见运维操作，方便用户使用。</li>
<li>优化了所有 Ansible Role 的实现，使其更加简洁、易读、易维护，无需默认参数即可使用。</li>
<li>允许在业务数据库/用户的层次上定义额外的 Pgbouncer 参数。</li>
</ul>
<h2 id="api变更">API变更</h2>
<p>Pigsty v2.0 进行了大量变更，新增64个参数，移除13个参数，重命名17个参数。</p>
<p><strong>新增的参数</strong></p>
<ul>
<li><code>INFRA</code>.<code>META</code>.<code>admin_ip</code> : 主元节点 IP 地址</li>
<li><code>INFRA</code>.<code>META</code>.<code>region</code> : 上游镜像区域：default|china|europe</li>
<li><code>INFRA</code>.<code>META</code>.<code>os_version</code> : 企业版 Linux 发行版本：7,8,9</li>
<li><code>INFRA</code>.<code>CA</code>.<code>ca_cn</code> : CA 通用名称，默认为 pigsty-ca</li>
<li><code>INFRA</code>.<code>CA</code>.<code>cert_validity</code> : 证书有效期，默认为 20 年</li>
<li><code>INFRA</code>.<code>REPO</code>.<code>repo_enabled</code> : 在 infra 节点上构建本地 yum 仓库吗？</li>
<li><code>INFRA</code>.<code>REPO</code>.<code>repo_upstream</code> : 上游 yum 仓库定义列表</li>
<li><code>INFRA</code>.<code>REPO</code>.<code>repo_home</code> : 本地 yum 仓库的主目录，通常与 nginx_home &lsquo;/www&rsquo; 相同</li>
<li><code>INFRA</code>.<code>NGINX</code>.<code>nginx_ssl_port</code> : https 监听端口</li>
<li><code>INFRA</code>.<code>NGINX</code>.<code>nginx_ssl_enabled</code> : 启用 nginx https 吗？</li>
<li><code>INFRA</code>.<code>PROMTETHEUS</code>.<code>alertmanager_endpoint</code> : altermanager 端点（ip|domain）：端口格式</li>
<li><code>NODE</code>.<code>NODE_TUNE</code>.<code>node_hugepage_ratio</code> : 内存 hugepage 比率，默认禁用，值为 0</li>
<li><code>NODE</code>.<code>HAPROXY</code>.<code>haproxy_service</code> : 要公开的 haproxy 服务列表</li>
<li><code>PGSQL</code>.<code>PG_ID</code>.<code>pg_mode</code> : pgsql 集群模式：pgsql,citus,gpsql</li>
<li><code>PGSQL</code>.<code>PG_BUSINESS</code>.<code>pg_dbsu_password</code> : dbsu 密码，默认为空字符串表示没有 dbsu 密码</li>
<li><code>PGSQL</code>.<code>PG_INSTALL</code>.<code>pg_log_dir</code> : postgres 日志目录，默认为 <code>/pg/data/log</code></li>
<li><code>PGSQL</code>.<code>PG_BOOTSTRAP</code>.<code>pg_storage_type</code> : SSD|HDD，默认为 SSD</li>
<li><code>PGSQL</code>.<code>PG_BOOTSTRAP</code>.<code>patroni_log_dir</code> : patroni 日志目录，默认为 <code>/pg/log</code></li>
<li><code>PGSQL</code>.<code>PG_BOOTSTRAP</code>.<code>patroni_ssl_enabled</code> : 使用 SSL 保护 patroni RestAPI 通信？</li>
<li><code>PGSQL</code>.<code>PG_BOOTSTRAP</code>.<code>patroni_username</code> : patroni rest api 用户名</li>
<li><code>PGSQL</code>.<code>PG_BOOTSTRAP</code>.<code>patroni_password</code> : patroni rest api 密码（重要：请更改此密码）</li>
<li><code>PGSQL</code>.<code>PG_BOOTSTRAP</code>.<code>patroni_citus_db</code> : 由 patroni 管理的 citus 数据库，默认为 postgres</li>
<li><code>PGSQL</code>.<code>PG_BOOTSTRAP</code>.<code>pg_max_conn</code> : postgres 最大连接数，<code>auto</code> 将使用推荐值</li>
<li><code>PGSQL</code>.<code>PG_BOOTSTRAP</code>.<code>pg_shmem_ratio</code> : postgres 共享内存比率，默认为 0.25，范围 0.1~0.4</li>
<li><code>PGSQL</code>.<code>PG_BOOTSTRAP</code>.<code>pg_rto</code> : 恢复时间目标，故障转移的 ttl，默认为 30s</li>
<li><code>PGSQL</code>.<code>PG_BOOTSTRAP</code>.<code>pg_rpo</code> : 恢复点目标，默认最多丢失 1MB 数据</li>
<li><code>PGSQL</code>.<code>PG_BOOTSTRAP</code>.<code>pg_pwd_enc</code> : 密码加密算法：md5|scram-sha-256</li>
<li><code>PGSQL</code>.<code>PG_BOOTSTRAP</code>.<code>pgbouncer_log_dir</code> : pgbouncer 日志目录，默认为 <code>/var/log/pgbouncer</code></li>
<li><code>PGSQL</code>.<code>PG_BOOTSTRAP</code>.<code>pgbouncer_auth_query</code> : 如果启用，查询 pg_authid 表以检索 biz 用户，而不是填充用户列表</li>
<li><code>PGSQL</code>.<code>PG_BOOTSTRAP</code>.<code>pgbouncer_sslmode</code> : pgbouncer 客户端的 SSL：disable|allow|prefer|require|verify-ca|verify-full</li>
<li><code>PGSQL</code>.<code>PG_BOOTSTRAP</code>.<code>pg_service_provider</code> : 专用的 haproxy 节点组名称，或者默认为本地节点的空字符串</li>
<li><code>PGSQL</code>.<code>PG_BOOTSTRAP</code>.<code>pg_default_service_dest</code> : 如果 svc.dest=&lsquo;default&rsquo;，则为默认服务目标</li>
<li><code>PGSQL</code>.<code>PG_BACKUP</code>.<code>pgbackrest_enabled</code> : 启用 pgbackrest 吗？</li>
<li><code>PGSQL</code>.<code>PG_BACKUP</code>.<code>pgbackrest_clean</code> : 初始化期间删除 pgbackrest 数据吗？</li>
<li><code>PGSQL</code>.<code>PG_BACKUP</code>.<code>pgbackrest_log_dir</code> : pgbackrest 日志目录，默认为 <code>/pg/log</code></li>
<li><code>PGSQL</code>.<code>PG_BACKUP</code>.<code>pgbackrest_method</code> : pgbackrest 备份仓库方法，local 或 minio</li>
<li><code>PGSQL</code>.<code>PG_BACKUP</code>.<code>pgbackrest_repo</code> : pgbackrest 备份仓库配置</li>
<li><code>PGSQL</code>.<code>PG_DNS</code>.<code>pg_dns_suffix</code> : pgsql dns 后缀，默认为空字符串</li>
<li><code>PGSQL</code>.<code>PG_DNS</code>.<code>pg_dns_target</code> : auto, primary, vip, none 或 ad hoc ip</li>
<li><code>ETCD</code>.<code>etcd_seq</code> : etcd 实例标识符，必需</li>
<li><code>ETCD</code>.<code>etcd_cluster</code> : etcd 集群和组名称，默认为 etcd</li>
<li><code>ETCD</code>.<code>etcd_safeguard</code> : 防止清除正在运行的 etcd 实例吗？</li>
<li><code>ETCD</code>.<code>etcd_clean</code> : 在初始化期间清除现有的 etcd 吗？</li>
<li><code>ETCD</code>.<code>etcd_data</code> : etcd 数据目录，默认为 /data/etcd</li>
<li><code>ETCD</code>.<code>etcd_port</code> : etcd 客户端端口，默认为 2379</li>
<li><code>ETCD</code>.<code>etcd_peer_port</code> : etcd 对等端口，默认为 2380</li>
<li><code>ETCD</code>.<code>etcd_init</code> : etcd 初始集群状态，新建或已存在</li>
<li><code>ETCD</code>.<code>etcd_election_timeout</code> : etcd 选举超时，默认为 1000ms</li>
<li><code>ETCD</code>.<code>etcd_heartbeat_interval</code> : etcd 心跳间隔，默认为 100ms</li>
<li><code>MINIO</code>.<code>minio_seq</code> : minio 实例标识符，必须参数</li>
<li><code>MINIO</code>.<code>minio_cluster</code> : minio 集群名称，默认为 minio</li>
<li><code>MINIO</code>.<code>minio_clean</code> : 初始化时清理 minio 吗？默认为 false</li>
<li><code>MINIO</code>.<code>minio_user</code> : minio 操作系统用户，默认为 <code>minio</code></li>
<li><code>MINIO</code>.<code>minio_node</code> : minio 节点名模式</li>
<li><code>MINIO</code>.<code>minio_data</code> : minio 数据目录，使用 {x&hellip;y} 来指定多个驱动器</li>
<li><code>MINIO</code>.<code>minio_domain</code> : minio 外部域名，默认为 <code>sss.pigsty</code></li>
<li><code>MINIO</code>.<code>minio_port</code> : minio 服务端口，默认为 9000</li>
<li><code>MINIO</code>.<code>minio_admin_port</code> : minio 控制台端口，默认为 9001</li>
<li><code>MINIO</code>.<code>minio_access_key</code> : 根访问密钥，默认为 <code>minioadmin</code></li>
<li><code>MINIO</code>.<code>minio_secret_key</code> : 根秘密密钥，默认为 <code>minioadmin</code></li>
<li><code>MINIO</code>.<code>minio_extra_vars</code> : minio 服务器的额外环境变量</li>
<li><code>MINIO</code>.<code>minio_alias</code> : 本地 minio 部署的别名</li>
<li><code>MINIO</code>.<code>minio_buckets</code> : 待创建的 minio 存储桶列表</li>
<li><code>MINIO</code>.<code>minio_users</code> : 待创建的 minio 用户列表</li>
</ul>
<p><strong>移除的参数</strong></p>
<ul>
<li><code>INFRA</code>.<code>CA</code>.<code>ca_homedir</code> : CA 主目录，现在固定为 <code>/etc/pki/</code></li>
<li><code>INFRA</code>.<code>CA</code>.<code>ca_cert</code> : CA 证书文件名，现在固定为 <code>ca.key</code></li>
<li><code>INFRA</code>.<code>CA</code>.<code>ca_key</code> : CA 密钥文件名，现在固定为 <code>ca.key</code></li>
<li><code>INFRA</code>.<code>REPO</code>.<code>repo_upstreams</code> : 已被 <code>repo_upstream</code> 替代</li>
<li><code>PGSQL</code>.<code>PG_INSTALL</code>.<code>pgdg_repo</code> : 现在由节点 playbooks 负责</li>
<li><code>PGSQL</code>.<code>PG_INSTALL</code>.<code>pg_add_repo</code> : 现在由节点 playbooks 负责</li>
<li><code>PGSQL</code>.<code>PG_IDENTITY</code>.<code>pg_backup</code> : 未使用且与部分名称冲突</li>
<li><code>PGSQL</code>.<code>PG_IDENTITY</code>.<code>pg_preflight_skip</code> : 不再使用，由 <code>pg_id</code> 替代</li>
<li><code>DCS</code>.<code>dcs_name</code> : 由于使用 etcd 而被移除</li>
<li><code>DCS</code>.<code>dcs_servers</code> : 被 ad hoc 组 <code>etcd</code> 替代</li>
<li><code>DCS</code>.<code>dcs_registry</code> : 由于使用 etcd 而被移除</li>
<li><code>DCS</code>.<code>dcs_safeguard</code> : 被 <code>etcd_safeguard</code> 替代</li>
<li><code>DCS</code>.<code>dcs_clean</code> : 被 <code>etcd_clean</code> 替代</li>
</ul>
<p><strong>重命名的参数</strong></p>
<ul>
<li><code>nginx_upstream</code>            -&gt; <code>infra_portal</code></li>
<li><code>repo_address</code>              -&gt; <code>repo_endpoint</code></li>
<li><code>pg_hostname</code>               -&gt; <code>node_id_from_pg</code></li>
<li><code>pg_sindex</code>                 -&gt; <code>pg_group</code></li>
<li><code>pg_services</code>               -&gt; <code>pg_default_services</code></li>
<li><code>pg_services_extra</code>         -&gt; <code>pg_services</code></li>
<li><code>pg_hba_rules_extra</code>        -&gt; <code>pg_hba_rules</code></li>
<li><code>pg_hba_rules</code>              -&gt; <code>pg_default_hba_rules</code></li>
<li><code>pgbouncer_hba_rules_extra</code> -&gt; <code>pgb_hba_rules</code></li>
<li><code>pgbouncer_hba_rules</code>       -&gt; <code>pgb_default_hba_rules</code></li>
<li><code>vip_mode</code>                  -&gt; <code>pg_vip_enabled</code></li>
<li><code>vip_address</code>               -&gt; <code>pg_vip_address</code></li>
<li><code>vip_interface</code>             -&gt; <code>pg_vip_interface</code></li>
<li><code>node_packages_default</code>     -&gt; <code>node_default_packages</code></li>
<li><code>node_packages_meta</code>        -&gt; <code>infra_packages</code></li>
<li><code>node_packages_meta_pip</code>    -&gt; <code>infra_packages_pip</code></li>
<li><code>node_data_dir</code>             -&gt; <code>node_data</code></li>
</ul>
<p><strong>Checksums</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>MD5 (pigsty-pkg-v2.0.0-rc1.el7.x86_64.tgz) = af4b5db9dc38c860de609956a8f1f0d3
</span></span><span style="display:flex;"><span>MD5 (pigsty-pkg-v2.0.0-rc1.el8.x86_64.tgz) = 5b7152e142df3e3cbc06de30bd70e433
</span></span><span style="display:flex;"><span>MD5 (pigsty-pkg-v2.0.0-rc1.el9.x86_64.tgz) = 1362e2a5680fc1a3a014cc4f304100bd
</span></span></code></pre></div><p>特别感谢意大利用户 @alemacci 在 SSL加密，备份，多操作系统发行版适配与自适应参数模版上的贡献！</p>
<hr>
<h2 id="v201">v2.0.1</h2>
<p><a href="https://github.com/Vonng/pigsty/releases/tag/v2.0.1">https://github.com/Vonng/pigsty/releases/tag/v2.0.1</a></p>
<p>安全性改进，与对 <a href="https://github.com/Vonng/pigsty/releases/tag/v2.0.0">v2.0.0</a> 的 BUG 修复。</p>
<p><strong>改进</strong></p>
<ul>
<li>更换猪头 logo 以符合 PostgreSQL 商标政策。</li>
<li>将 grafana 版本升级至 v9.4，界面更佳且修复了 bug。</li>
<li>将 patroni 版本升级至 v3.0.1，其中包含了一些 bug 修复。</li>
<li>修改：将 grafana systemd 服务文件回滚到 rpm 默认的版本。</li>
<li>使用缓慢的 <code>copy</code> 代替 <code>rsync</code> 来复制 grafana 仪表板，更加可靠。</li>
<li>增强：bootstrap 执行后会添加回默认 repo 文件。</li>
<li>添加 asciinema 视频，用于各种管理任务。</li>
<li>安全增强模式：限制监控用户权限。</li>
<li>新的配置模板：<code>dual.yml</code>，用于双节点部署。</li>
<li>在 <code>crit.yml</code> 模板中启用 <code>log_connections</code> 和 <code>log_disconnections</code>。</li>
<li>在 <code>crit.yml</code> 模板中的 <code>pg_libs</code> 中启用 <code>$lib/passwordcheck</code>。</li>
<li>明确授予 <code>pg_monitor</code> 角色监视视图权限。</li>
<li>从 <code>dbuser_monitor</code> 中移除默认的 <code>dbrole_readonly</code> 以限制监控用户的权限</li>
<li>现在 patroni 监听在 <code>{{ inventory_hostname }}</code> 而不是 <code>0.0.0.0</code></li>
<li>现在你可以使用 <code>pg_listen</code> 控制 postgres/pgbouncer 监听的地址</li>
<li>现在你可以在 <code>pg_listen</code> 中使用 <code>${ip}</code>, <code>${lo}</code>, <code>${vip}</code> 占位符</li>
<li>将 Aliyun terraform 镜像从 centos 7.9 提升到 rocky Linux 9</li>
<li>将 bytebase 版本升级到 v1.14.0</li>
</ul>
<p><strong>BUG修复</strong></p>
<ul>
<li>为 alertmanager 添加缺失的 advertise 地址。</li>
<li>解决使用 <code>bin/pgsql-user</code> 创建数据库用户时，<code>pg_mode</code> 变量缺失问题。</li>
<li>在 <code>redis.yml</code> 中为 Redis 集群加入任务添加 <code>-a password</code> 选项。</li>
<li>在 <code>infra-rm.yml</code>.<code>remove infra data</code> 任务中补充缺失的默认值。</li>
<li>修复 prometheus 监控对象定义文件的属主为 <code>prometheus</code> 用户。</li>
<li>使用 管理员用户 而不是 root 去删除 DCS 中的元数据。</li>
<li>修复了由 grafana 9.4 bug 导致的问题：Meta数据源缺失。</li>
</ul>
<p><strong>注意事项</strong></p>
<p>EL8 pgdg 上游官方源处于依赖破损状态，请小心使用。涉及到的软件包: <code>postgis33_15, pgloader, postgresql_anonymizer_15*, postgresql_faker_15</code></p>
<p><strong>如何升级？</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty<span style="color:#000;font-weight:bold">;</span> tar -zcf /tmp/files.tgz files<span style="color:#000;font-weight:bold">;</span> rm -rf ~/pigsty    <span style="color:#8f5902;font-style:italic"># backup files dir and remove</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~<span style="color:#000;font-weight:bold">;</span> bash -c <span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>curl -fsSL https://get.pigsty.cc/latest<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#34;</span>      <span style="color:#8f5902;font-style:italic"># get latest pigsty source</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty<span style="color:#000;font-weight:bold">;</span> rm -rf files<span style="color:#000;font-weight:bold">;</span> tar -xf /tmp/files.tgz -C ~/pigsty  <span style="color:#8f5902;font-style:italic"># restore files dir</span>
</span></span></code></pre></div><p><strong>Checksums</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>MD5 <span style="color:#ce5c00;font-weight:bold">(</span>pigsty-pkg-v2.0.1.el7.x86_64.tgz<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> 5cfbe98fd9706b9e0f15c1065971b3f6
</span></span><span style="display:flex;"><span>MD5 <span style="color:#ce5c00;font-weight:bold">(</span>pigsty-pkg-v2.0.1.el8.x86_64.tgz<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> c34aa460925ae7548866bf51b8b8759c
</span></span><span style="display:flex;"><span>MD5 <span style="color:#ce5c00;font-weight:bold">(</span>pigsty-pkg-v2.0.1.el9.x86_64.tgz<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> 055057cebd93c473a67fb63bcde22d33
</span></span></code></pre></div><p>特别感谢 <a href="https://github.com/cocoonkid">@cocoonkid</a> 提供的反馈。</p>
<hr>
<h2 id="v202">v2.0.2</h2>
<p><a href="https://github.com/Vonng/pigsty/releases/tag/v2.0.2">https://github.com/Vonng/pigsty/releases/tag/v2.0.2</a></p>
<p><strong>亮点</strong></p>
<p>使用开箱即用的 <a href="https://github.com/pgvector/pgvector"><code>pgvector</code></a> 存储 AI Embedding、索引、检索向量。</p>
<ul>
<li>新扩展 <a href="https://github.com/Vonng/pigsty/issues/267"><code>pgvector</code></a></li>
<li><a href="https://github.com/Vonng/pigsty/issues/265">MinIO CVE-2023-28432</a> 问题修复</li>
</ul>
<p><strong>变更</strong></p>
<ul>
<li>新扩展插件 <a href="https://github.com/Vonng/pigsty/issues/267"><code>pgvector</code></a> 用于存储 AI 嵌入，并执行向量相似度搜索。</li>
<li>修复 <a href="https://github.com/Vonng/pigsty/issues/265">MinIO CVE-2023-28432</a> ，使用 20230324 新提供的 policy API.</li>
<li>为 DNSMASQ systemd 服务添加动态重载命令</li>
<li>更新 PEV 版本至 v1.8</li>
<li>更新 grafana 版本至 v9.4.7</li>
<li>更新 MinIO 与 MCLI 版本至 20230324</li>
<li>更新 bytebase 版本至 v1.15.0</li>
<li>更新监控面板并修复死链接</li>
<li>更新了阿里云 Terraform 模板，默认使用 RockyLinux 9</li>
<li>使用 Grafana v9.4 的 Provisioning API</li>
<li>为众多管理任务添加了 asciinema 视频</li>
<li>修复了 EL8 PostgreSQL 的破损依赖：移除 anonymizer_15 faker_15 pgloader</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>MD5 <span style="color:#ce5c00;font-weight:bold">(</span>pigsty-pkg-v2.0.2.el7.x86_64.tgz<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> d46440a115d741386d29d6de646acfe2
</span></span><span style="display:flex;"><span>MD5 <span style="color:#ce5c00;font-weight:bold">(</span>pigsty-pkg-v2.0.2.el8.x86_64.tgz<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> 5fa268b5545ac96b40c444210157e1e1
</span></span><span style="display:flex;"><span>MD5 <span style="color:#ce5c00;font-weight:bold">(</span>pigsty-pkg-v2.0.2.el9.x86_64.tgz<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> c8b113d57c769ee86a22579fc98e8345
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-81dacd29684b0b4454631f9f21450afb">v1.5.0 发布注记</h1>
	<div class="lead">v1.5添加了Docker支持，ETCD作为DCS的能力，基础设施自我监控与CMDB改进</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2022-05-17" class="text-muted">2022年05月17日</time>
        
	</div>
	<hr>
<h2 id="v150">v1.5.0</h2>
<h2 id="亮点概述">亮点概述</h2>
<ul>
<li>完善的Docker支持：在管理节点上默认启用并提供诸多开箱即用的软件模板：bytebase, pgadmin, pgweb, postgrest, minio等。</li>
<li>基础设施自我监控：Nginx， ETCD， Consul， Prometheus， Grafana， Loki 自我监控</li>
<li>CMDB升级：兼容性改善，支持Redis集群/Greenplum集群元数据，配置文件可视化。</li>
<li>服务发现改进：可以使用Consul自动发现所有待监控对象，并纳入Prometheus中。</li>
<li>更好的冷备份支持：默认定时备份任务，添加<code>pg_probackup</code>备份工具，一键创建延时从库。</li>
<li>ETCD现在可以用作PostgreSQL/Patroni的DCS服务，作为Consul的备选项。</li>
<li>Redis剧本/角色改善：现在允许对单个Redis实例，而非整个Redis节点进行初始化与移除。</li>
</ul>
<h2 id="详细变更列表">详细变更列表</h2>
<h3 id="监控系统">监控系统</h3>
<p><strong>监控面板</strong></p>
<ul>
<li>CMDB Overview：可视化Pigsty CMDB Inventory。</li>
<li>DCS Overview：查阅Consul与ETCD集群的监控指标。</li>
<li>Nginx Overview：查阅Pigsty Web访问指标与访问日志。</li>
<li>Grafana Overview：Grafana自我监控</li>
<li>Prometheus Overview：Prometheus自我监控</li>
<li>INFRA Dashboard进行重制，反映基础设施整体状态</li>
</ul>
<p><strong>监控架构</strong></p>
<ul>
<li>现在允许使用 Consul 进行服务发现（当所有服务注册至Consul时）</li>
<li>现在所有的Infra组件会启用自我监控，并通过<code>infra_register</code>角色注册至Prometheus与Consul中。</li>
<li>指标收集器 pg_exporter 更新至 v0.5.0，添加新功能，<code>scale</code> 与 <code>default</code>，允许为指标指定一个倍乘因子，以及指定默认值。</li>
<li><code>pg_bgwriter</code>, <code>pg_wal</code>, <code>pg_query</code>, <code>pg_db</code>, <code>pgbouncer_stat</code> 关于时间的指标，单位由默认的毫秒或微秒统一缩放至秒。</li>
<li><code>pg_table</code> 中的相关计数器指标，现在配置有默认值 <code>0</code>，替代原有的<code>NaN</code>。</li>
<li><code>pg_class</code>指标收集器默认移除，相关指标添加至 <code>pg_table</code> 与 <code>pg_index</code> 收集器中。</li>
<li><code>pg_table_size</code> 指标收集器现在默认启用，默认设置有300秒的缓存时间。</li>
</ul>
<h3 id="部署方案">部署方案</h3>
<ul>
<li>
<p>新增可选软件包 <code>docker.tgz</code>，带有常用应用镜像：Pgadmin, Pgweb, Postgrest, ByteBase, Kong, Minio等。</p>
</li>
<li>
<p>新增角色ETCD，可以在DCS Servers指定的节点上自动部署ETCD服务，并自动纳入监控。</p>
</li>
<li>
<p>允许通过 <code>pg_dcs_type</code> 指定PG高可用使用的DCS服务，Consul（默认），ETCD（备选）</p>
</li>
<li>
<p>允许通过 <code>node_crontab</code> 参数，为节点配置定时任务，例如数据库备份、VACUUM，统计收集等。</p>
</li>
<li>
<p>新增了 <code>pg_checksum</code>  选项，启用时，数据库集群将启用数据校验和（此前只有<code>crit</code>模板默认启用）</p>
</li>
<li>
<p>新增了<code>pg_delay</code>选项，当实例为Standby Cluster Leader时，此参数可以用于配置一个<strong>延迟从库</strong></p>
</li>
<li>
<p>新增了软件包 <code>pg_probackup</code>，默认角色<code>replicator</code>现在默认赋予了备份相关函数所需的权限。</p>
</li>
<li>
<p>Redis部署现在拆分为两个部分：Redis节点与Redis实例，通过<code>redis_port</code>参数可以精确控制一个具体实例。</p>
</li>
<li>
<p>Loki 与 Promtail 现在使用 <code>frpm</code> 制作的 RPM软件包进行安装。</p>
</li>
<li>
<p>DCS3配置模板现在使用一个3节点的<code>pg-meta</code>集群，与一个单节点的延迟从库。</p>
</li>
</ul>
<h3 id="软件升级">软件升级</h3>
<ul>
<li>升级 PostgreSQL 至 14.3</li>
<li>升级 Redis 至 6.2.7</li>
<li>升级 PG Exporter 至 0.5.0</li>
<li>升级 Consul 至 1.12.0</li>
<li>升级 vip-manager 至 v1.0.2</li>
<li>升级 Grafana 至 v8.5.2</li>
<li>升级 Loki &amp; Promtail 至 v2.5.0，使用frpm打包。</li>
</ul>
<h3 id="问题修复">问题修复</h3>
<ul>
<li>修复了Loki 与 Promtail 默认配置文件名的问题</li>
<li>修复了Loki 与 Promtail 环境变量无法正确展开的问题</li>
<li>对英文文档进行了一次完整的翻译与修缮，文档依赖的JS资源现在直接从本地获取，无需互联网访问。</li>
</ul>
<h2 id="api变化">API变化</h2>
<p><strong>新参数</strong></p>
<ul>
<li><code>node_data_dir</code> : 主要的数据挂载路径，如果不存在会被创建。</li>
<li><code>node_crontab_overwrite</code> : 覆盖 <code>/etc/crontab</code> 而非追加内容。</li>
<li><code>node_crontab</code>: 要被追加或覆盖的 node crontab 内容。</li>
<li><code>nameserver_enabled</code>: 在这个基础设施节节点上启用 nameserver 吗？</li>
<li><code>prometheus_enabled</code>: 在这个基础设施节节点上启用 prometheus 吗？</li>
<li><code>grafana_enabled</code>: 在这个基础设施节节点上启用 grafana 吗？</li>
<li><code>loki_enabled</code>: 在这个基础设施节节点上启用 loki 吗？</li>
<li><code>docker_enable</code>: 在这个基础设施节点上启用 docker 吗？</li>
<li><code>consul_enable</code>: 启用 consul 服务器/代理吗？</li>
<li><code>etcd_enable</code>: 启用 etcd 服务器/客户端吗？</li>
<li><code>pg_checksum</code>: 启用 pg 集群数据校验和吗？</li>
<li><code>pg_delay</code>: 备份集群主库复制重放时的应用延迟。</li>
</ul>
<p><strong>参数重制</strong></p>
<p>现在 <code>*_clean</code> 是布尔类型的参数，用于在初始化期间清除现有实例。</p>
<p><code>*_safeguard</code> 也是布尔类型的参数，用于在执行任何剧本时，避免清除正在运行的实例。</p>
<ul>
<li><code>pg_exists_action</code> -&gt; <code>pg_clean</code></li>
<li><code>pg_disable_purge</code> -&gt; <code>pg_safeguard</code></li>
<li><code>dcs_exists_action</code> -&gt; <code>dcs_clean</code></li>
<li><code>dcs_disable_purge</code> -&gt; <code>dcs_safeguard</code></li>
</ul>
<p><strong>参数重命名</strong></p>
<ul>
<li><code>node_ntp_config</code> -&gt; <code>node_ntp_enabled</code></li>
<li><code>node_admin_setup</code> -&gt; <code>node_admin_enabled</code></li>
<li><code>node_admin_pks</code> -&gt; <code>node_admin_pk_list</code></li>
<li><code>node_dns_hosts</code> -&gt; <code>node_etc_hosts_default</code></li>
<li><code>node_dns_hosts_extra</code> -&gt; <code>node_etc_hosts</code></li>
<li><code>node_dns_server</code> -&gt; <code>node_dns_method</code></li>
<li><code>node_local_repo_url</code> -&gt; <code>node_repo_local_urls</code></li>
<li><code>node_packages</code> -&gt; <code>node_packages_default</code></li>
<li><code>node_extra_packages</code> -&gt; <code>node_packages</code></li>
<li><code>node_packages_meta</code> -&gt; <code>node_packages_meta</code></li>
<li><code>node_meta_pip_install</code> -&gt; <code>node_packages_meta_pip</code></li>
<li><code>node_sysctl_params</code> -&gt; <code>node_tune_params</code></li>
<li><code>app_list</code> -&gt; <code>nginx_indexes</code></li>
<li><code>grafana_plugin</code> -&gt; <code>grafana_plugin_method</code></li>
<li><code>grafana_cache</code> -&gt; <code>grafana_plugin_cache</code></li>
<li><code>grafana_plugins</code> -&gt; <code>grafana_plugin_list</code></li>
<li><code>grafana_git_plugin_git</code> -&gt; <code>grafana_plugin_git</code></li>
<li><code>haproxy_admin_auth_enabled</code> -&gt; <code>haproxy_auth_enabled</code></li>
<li><code>pg_shared_libraries</code> -&gt; <code>pg_libs</code></li>
<li><code>dcs_type</code> -&gt; <code>pg_dcs_type</code></li>
</ul>
<hr>
<h2 id="v151">v1.5.1</h2>
<h2 id="亮点">亮点</h2>
<p>重要：修复了PG14.0-14.3中 <code>CREATE INDEX|REINDEX CONCURRENTLY</code> 可能导致索引数据损坏的问题。</p>
<p>Pigsty v1.5.1 升级默认PostgreSQL版本至 14.4 强烈建议尽快更新。</p>
<h3 id="软件升级-1">软件升级</h3>
<ul>
<li>postgres 升级至 to 14.4</li>
<li>haproxy 升级至 to 2.6.0</li>
<li>grafana 升级至 to 9.0.0</li>
<li>prometheus 升级至 2.36.0</li>
<li>patroni 升级至 2.1.4</li>
</ul>
<h3 id="问题修复-1">问题修复</h3>
<ul>
<li>修复了<code>pgsql-migration.yml</code>中的TYPO</li>
<li>移除了HAProxy配置文件中的PID配置项</li>
<li>移除了默认软件包中的 i686 软件包</li>
<li>默认启用所有Systemd Redis Service</li>
<li>默认启用所有Systemd Patroni Service</li>
</ul>
<h3 id="api变更">API变更</h3>
<ul>
<li><code>grafana_database</code> 与 <code>grafana_pgurl</code> 被标记为过时API，将从后续版本移除</li>
</ul>
<h3 id="new-apps">New Apps</h3>
<ul>
<li>wiki.js : 使用Postgres搭建本地维基百科</li>
<li>FerretDB ： 使用Postgres提供MongoDB API</li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-434178e5fe8c53371b4d97db657374b7">v1.4.0 发布注记</h1>
	<div class="lead">Pigsty v1.4 添加了时序数据仓库 YMatrixDB 支持</div>
	<div class="td-byline mb-4">
		By <b>Ruohang Feng（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2022-03-31" class="text-muted">2022年03月31日</time>
        
	</div>
	<hr>
<h2 id="v140">v1.4.0</h2>
<p><strong>架构</strong></p>
<ul>
<li>将系统解耦为4大类别：<code>INFRA</code>、<code>NODES</code>、<code>PGSQL</code>、<code>REDIS</code>，这使得pigsty更加清晰、更易于扩展。</li>
<li>单节点部署 = <code>INFRA</code> + <code>NODES</code> + <code>PGSQL</code></li>
<li>部署pgsql集群 = <code>NODES</code> + <code>PGSQL</code></li>
<li>部署redis集群 = <code>NODES</code> + <code>REDIS</code></li>
<li>部署其他数据库 = <code>NODES</code> + xxx（例如 <code>MONGO</code>、<code>KAFKA</code>&hellip;待定）</li>
</ul>
<p><strong>可访问性</strong></p>
<ul>
<li>为中国大陆提供CDN。</li>
<li>使用 <code>bash -c &quot;$(curl -fsSL http://get.pigsty.cc/latest)&quot;</code> 获取最新源代码。</li>
<li>使用新的 <code>download</code> 脚本下载并提取包。</li>
</ul>
<p><strong>监控增强</strong></p>
<ul>
<li>将监控系统分为5大类别：<code>INFRA</code>、<code>NODES</code>、<code>REDIS</code>、<code>PGSQL</code>、<code>APP</code></li>
<li>默认启用日志记录
<ul>
<li>现在默认启用<code>loki</code>和<code>promtail</code>，带有预构建的 <a href="https://github.com/Vonng/loki-rpm">loki-rpm</a>。</li>
</ul>
</li>
<li>模型和标签
<ul>
<li>为所有仪表板添加了一个隐藏的<code>ds</code> prometheus数据源变量，因此您只需选择一个新的数据源而不是修改Grafana数据源和仪表板。</li>
<li>为所有指标添加了一个<code>ip</code>标签，并将其用作数据库指标和节点指标之间的连接键。</li>
</ul>
</li>
<li>INFRA监控
<ul>
<li>Infra主仪表板：INFRA概览</li>
<li>添加日志仪表板：日志实例</li>
<li>PGLOG分析和PGLOG会话现在被视为一个示例Pigsty APP。</li>
</ul>
</li>
<li>NODES监控应用
<ul>
<li>如果您完全不关心数据库，现在可以单独使用Pigsty作为主机监控软件！</li>
<li>包括4个核心仪表板：节点概览 &amp; 节点集群 &amp; 节点实例 &amp; 节点警报</li>
<li>为节点引入新的身份变量：<code>node_cluster</code> 和 <code>nodename</code></li>
<li>变量<code>pg_hostname</code>现在意味着将主机名设置为与postgres实例名相同，以保持向后兼容性</li>
<li>变量<code>nodename_overwrite</code> 控制是否用nodename覆盖节点的主机名</li>
<li>变量<code>nodename_exchange</code> 将nodename写入彼此的<code>/etc/hosts</code></li>
<li>所有节点指标引用都经过修订，通过<code>ip</code>连接</li>
<li>节点监控目标在<code>/etc/prometheus/targets/nodes</code>下单独管理</li>
</ul>
</li>
<li>PGSQL监控增强
<ul>
<li>完全新的PGSQL集群，简化并专注于集群中的重要内容。</li>
<li>新仪表板PGSQL数据库是集群级对象监控。例如整个集群而不是单个实例的表和查询。</li>
<li>PGSQL警报仪表板现在只关注pgsql警报。</li>
<li>PGSQL Shard已添加到PGSQL中。</li>
</ul>
</li>
<li>Redis监控增强
<ul>
<li>为所有redis仪表板添加节点监控。</li>
</ul>
</li>
</ul>
<p><strong>MatrixDB支持</strong></p>
<ul>
<li>通过<code>pigsty-matrix.yml</code> playbook可以部署MatrixDB（Greenplum 7）</li>
<li>MatrixDB监控仪表板：PGSQL MatrixDB</li>
<li>添加示例配置：<code>pigsty-mxdb.yml</code></li>
</ul>
<p><strong>监控增强</strong></p>
<ul>
<li>将监控系统分为5大类别：<code>INFRA</code>、<code>NODES</code>、<code>REDIS</code>、<code>PGSQL</code>、<code>APP</code></li>
<li>默认启用日志记录
<ul>
<li>现在默认启用<code>loki</code>和<code>promtail</code>，带有预构建的 <a href="https://github.com/Vonng/loki-rpm">loki-rpm</a>。</li>
</ul>
</li>
<li>模型和标签
<ul>
<li>为所有仪表板添加了一个隐藏的<code>ds</code> prometheus数据源变量，因此您只需选择一个新的数据源而不是修改Grafana数据源和仪表板。</li>
<li>为所有指标添加了一个<code>ip</code>标签，并将其用作数据库指标和节点指标之间的连接键。</li>
</ul>
</li>
<li>INFRA监控
<ul>
<li>Infra主仪表板：INFRA概览</li>
<li>添加日志仪表板：日志实例</li>
<li>PGLOG分析和PGLOG会话现在被视为一个示例Pigsty APP。</li>
</ul>
</li>
<li>NODES监控应用
<ul>
<li>如果您完全不关心数据库，现在可以单独使用Pigsty作为主机监控软件！</li>
<li>包括4个核心仪表板：节点概览 &amp; 节点集群 &amp; 节点实例 &amp; 节点警报</li>
<li>为节点引入新的身份变量：<code>node_cluster</code> 和 <code>nodename</code></li>
<li>变量<code>pg_hostname</code>现在意味着将主机名设置为与postgres实例名相同，以保持向后兼容性</li>
<li>变量<code>nodename_overwrite</code> 控制是否用nodename覆盖节点的主机名</li>
<li>变量<code>nodename_exchange</code> 将nodename写入彼此的<code>/etc/hosts</code></li>
<li>所有节点指标引用都经过修订，通过<code>ip</code>连接</li>
<li>节点监控目标在<code>/etc/prometheus/targets/nodes</code>下单独管理</li>
</ul>
</li>
<li>PGSQL监控增强
<ul>
<li>完全新的PGSQL集群，简化并专注于集群中的重要内容。</li>
<li>新仪表板PGSQL数据库是集群级对象监控。例如整个集群而不是单个实例的表和查询。</li>
<li>PGSQL警报仪表板现在只关注pgsql警报。</li>
<li>PGSQL Shard已添加到PGSQL中。</li>
</ul>
</li>
<li>Redis监控增强
<ul>
<li>为所有redis仪表板添加节点监控。</li>
</ul>
</li>
</ul>
<p><strong>MatrixDB支持</strong></p>
<ul>
<li>通过<code>pigsty-matrix.yml</code> playbook可以部署MatrixDB（Greenplum 7）</li>
<li>MatrixDB监控仪表板：PGSQL MatrixDB</li>
<li>添加示例配置：<code>pigsty-mxdb.yml</code></li>
</ul>
<p><strong>置备改进</strong></p>
<p>现在 pigsty 的工作流如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span> <span style="color:#000">infra</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">yml</span> <span style="color:#ce5c00;font-weight:bold">---&gt;</span> <span style="color:#a40000">在单一的元节点上安装</span> <span style="color:#000">pigsty</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">|</span>          <span style="color:#a40000">然后将更多节点加入</span> <span style="color:#000">pigsty</span> <span style="color:#a40000">的管理下</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span> <span style="color:#000">nodes</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">yml</span> <span style="color:#ce5c00;font-weight:bold">---&gt;</span> <span style="color:#a40000">为</span> <span style="color:#000">pigsty</span> <span style="color:#a40000">准备节点（节点设置、</span><span style="color:#000">dcs</span><span style="color:#a40000">、</span><span style="color:#000">node_exporter</span><span style="color:#a40000">、</span><span style="color:#000">promtail</span><span style="color:#a40000">）</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">|</span>          <span style="color:#a40000">然后选择一个</span> <span style="color:#000">playbook</span> <span style="color:#a40000">在这些节点上部署数据库集群</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">^--&gt;</span> <span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">yml</span>   <span style="color:#a40000">在已准备好的节点上安装</span> <span style="color:#000">postgres</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">^--&gt;</span> <span style="color:#000">redis</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">yml</span>   <span style="color:#a40000">在已准备好的节点上安装</span> <span style="color:#000">redis</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">infra</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">demo</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">yml</span> <span style="color:#ce5c00;font-weight:bold">=</span> 
</span></span><span style="display:flex;"><span>           <span style="color:#000">infra</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">yml</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">l</span> <span style="color:#000">meta</span>     <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>           <span style="color:#000">nodes</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">yml</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">l</span> <span style="color:#000">pg</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">test</span>  <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>           <span style="color:#000">pgsql</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">yml</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">l</span> <span style="color:#000">pg</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">test</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>           <span style="color:#000">infra</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">loki</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">yml</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">infra</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">jupyter</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">yml</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">infra</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">pgweb</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">yml</span>
</span></span></code></pre></div><ul>
<li><code>nodes.yml</code>：用于设置和准备 pigsty 的节点，</li>
<li>在节点上设置 node、node_exporter、consul agent</li>
<li><code>node-remove.yml</code> 用于节点注销</li>
<li><code>pgsql.yml</code>：现在只在已准备好的节点上工作</li>
<li><code>pgsql-remove</code> 现在只负责 postgres 本身（dcs 和节点监控由 <code>node.yml</code> 负责）</li>
<li>添加一系列新选项以在 greenplum/matrixdb 中重用 <code>postgres</code> 角色</li>
<li><code>redis.yml</code>：现在在已准备好的节点上工作</li>
<li>而 <code>redis-remove.yml</code> 现在从节点上移除 redis。</li>
<li><code>pgsql-matrix.yml</code> 现在在已准备好的节点上安装 matrixdb（Greenplum 7）。</li>
</ul>
<p><strong>软件升级</strong></p>
<ul>
<li>PostgreSQL 14.2</li>
<li>PostGIS 3.2</li>
<li>TimescaleDB 2.6</li>
<li>Patroni 2.1.3 (Prometheus 指标 + 故障转移插槽)</li>
<li>HAProxy 2.5.5 (修复统计错误，更多指标)</li>
<li>PG 导出器 0.4.1 (超时参数等)</li>
<li>Grafana 8.4.4</li>
<li>Prometheus 2.33.4</li>
<li>Greenplum 6.19.4 / MatrixDB 4.4.0</li>
<li>Loki 现在作为 rpm 包提供，而不是 zip 存档。</li>
</ul>
<p><strong>错误修复</strong></p>
<ul>
<li>删除 patroni 的 consul 依赖，这使其更容易迁移到新的 consul 集群</li>
<li>修复 prometheus bin/new 脚本的默认数据目录路径：从 <code>/export/prometheus</code> 更改为 <code>/data/prometheus</code></li>
<li>在 vip-manager systemd 服务中添加重新启动秒数</li>
<li>修复错别字和任务</li>
</ul>
<p><strong>API 变更</strong></p>
<p><strong>新增变量</strong></p>
<ul>
<li><code>node_cluster</code>：节点集群的身份变量</li>
<li><code>nodename_overwrite</code>：如果设置，则 nodename 将设置为节点的主机名</li>
<li><code>nodename_exchange</code>：交换 play 主机之间的节点主机名（在 <code>/etc/hosts</code> 中）</li>
<li><code>node_dns_hosts_extra</code>：可以通过单个实例/集群轻松覆盖的额外静态 dns 记录</li>
<li><code>patroni_enabled</code>：如果禁用，postgres &amp; patroni 的引导过程不会在 <code>postgres</code> 角色期间执行</li>
<li><code>pgbouncer_enabled</code>：如果禁用，pgbouncer 在 <code>postgres</code> 角色期间不会启动</li>
<li><code>pg_exporter_params</code>：生成监控目标 url 时为 pg_exporter 提供的额外 url 参数。</li>
<li><code>pg_provision</code>：布尔值变量，表示是否执行 <code>postgres</code> 角色的资源配置部分（模板，数据库，用户）</li>
<li><code>no_cmdb</code>：用于 <code>infra.yml</code> 和 <code>infra-demo.yml</code> 播放书，不会在元节点上创建 cmdb。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>MD5 (app.tgz) = f887313767982b31a2b094e5589a75ea
</span></span><span style="display:flex;"><span>MD5 (matrix.tgz) = 3d063437c482d94bd7e35df1a08bbc84
</span></span><span style="display:flex;"><span>MD5 (pigsty.tgz) = e143b88ebea1474f9ebaffddc6072c49
</span></span><span style="display:flex;"><span>MD5 (pkg.tgz) = 73e8f5ce995b1f1760cb63c1904fb91b
</span></span></code></pre></div><hr>
<h2 id="v141">v1.4.1</h2>
<p>日常错误修复 / Docker 支持 / 英文文档</p>
<p>现在，默认在元节点上启用 docker。您可以使用它启动海量的各类软件</p>
<p>现在提供英文文档。</p>
<ul>
<li><a href="https://github.com/Vonng/pigsty/commit/68f8c8da0576e043686137aca47bad01dd4e82c0">将 docker 添加到默认包列表</a></li>
<li><a href="https://github.com/Vonng/pigsty/commit/765077744836d8600a8703dce8623182784d65a7">将 docker-compose 添加到默认包列表</a></li>
<li><a href="https://github.com/Vonng/pigsty/commit/9b8b7c5209d09049716318b624001de3b567452a">默认禁用 nameserver &amp; 默认启用 docker 角色</a></li>
</ul>
<p><strong>Bug 修复</strong></p>
<ul>
<li><a href="https://github.com/Vonng/pigsty/commit/100f31842d473001f946200d9b8e2e3e89add35a">修复 promtail &amp; loki 配置变量问题</a></li>
<li>修复 grafana 旧版警报。</li>
<li>默认禁用 nameserver</li>
<li>为 patroni 快捷方式重命名 pg-alias.sh</li>
<li><a href="https://github.com/Vonng/pigsty/commit/62d74f15f8c164e5971d9d1d1215869359267b53">为所有仪表板禁用 exemplars 查询</a></li>
<li><a href="https://github.com/Vonng/pigsty/commit/b277f488b7ed0fd0a7eeeb995e2efd75a048e0ef">修复 loki 数据目录问题</a> <a href="https://github.com/Vonng/pigsty/issues/100">https://github.com/Vonng/pigsty/issues/100</a></li>
<li><a href="https://github.com/Vonng/pigsty/commit/1690b490205af24d5f0394aba99007c0d9ebc49d">将 autovacuum_freeze_max_age 从 100000000 更改为 1000000000</a></li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-a0fb8b384cade6ec407c2453f1e2d292">v1.3.0 发布注记</h1>
	<div class="lead">Pigsty v1.3.0 更新了 PGCAT 重整 &amp; PGSQL 增强 &amp; Redis Beta支持</div>
	<div class="td-byline mb-4">
		By <b>Ruohang Feng（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2021-11-30" class="text-muted">2021年11月30日</time>
        
	</div>
	<hr>
<h2 id="130">1.3.0</h2>
<ul>
<li>【功能增强】Redis 部署（集群、哨兵、主从）</li>
<li>【功能增强】Redis 监控
<ul>
<li>Redis 总览仪表盘</li>
<li>Redis 集群仪表盘</li>
<li>Redis 实例仪表盘
-【功能增强】 监控：PGCAT 大修</li>
<li>新仪表盘：PGCAT 实例</li>
<li>新仪表盘：PGCAT 数据库仪表盘</li>
<li>重做仪表盘：PGCAT 表格</li>
</ul>
</li>
<li>【功能增强】 监控：PGSQL 增强
<ul>
<li>新面板：PGSQL 集群，添加 10 个关键指标面板（默认切换）</li>
<li>新面板：PGSQL 实例，添加 10 个关键指标面板（默认切换）</li>
<li>简化 &amp; 重新设计：PGSQL 服务</li>
<li>在 PGCAT &amp; PGSL 仪表盘之间添加交叉引用
-【功能增强】 监控部署</li>
<li>现在 grafana 数据源在仅监控部署期间自动注册
-【功能增强】 软件升级</li>
<li>将 PostgreSQL 13 添加到默认包列表</li>
<li>默认升级到 PostgreSQL 14.1</li>
<li>添加 greenplum rpm 和依赖项</li>
<li>添加 redis rpm &amp; 源代码包</li>
<li>将 perf 添加为默认包</li>
</ul>
</li>
</ul>
<hr>
<h2 id="v131">v1.3.1</h2>
<p><strong>监控</strong></p>
<ul>
<li>PGSQL &amp; PGCAT 仪表盘改进</li>
<li>优化 pgcat 实例 &amp; pgcat 数据库的布局</li>
<li>在 pgsql 实例仪表盘中添加关键指标面板，与 pgsql 集群保持一致</li>
<li>在 pgcat 数据库中添加表/索引膨胀面板，移除 pgcat 膨胀仪表盘</li>
<li>在 pgcat 数据库仪表盘中添加索引信息</li>
<li>修复在 grafana 8.3 中的损坏面板</li>
<li>在 nginx 主页中添加 redis 索引</li>
</ul>
<p><strong>部署</strong></p>
<ul>
<li>新的 <code>infra-demo.yml</code> 剧本用于一次性引导</li>
<li>使用 <code>infra-jupyter.yml</code> 剧本部署可选的 jupyter lab 服务器</li>
<li>使用 <code>infra-pgweb.yml</code> 剧本部署可选的 pgweb 服务器</li>
<li>在 meta 节点上新的 <code>pg</code> 别名，可以从 admin 用户启动 postgres 集群（除了 postgres）</li>
<li>根据 <code>timescaledb-tune</code> 的建议调整所有 patroni 配置模板中的 <code>max_locks_per_transactions</code></li>
<li>在配置模板中添加 <code>citus.node_conninfo: 'sslmode=prefer'</code> 以便在没有 SSL 的情况下使用 citus</li>
<li>在 pgdg14 包列表中添加所有扩展（除了 pgrouting）</li>
<li>将 node_exporter 升级到 v1.3.1</li>
<li>将 PostgREST v9.0.0 添加到包列表。从 postgres 模式生成 API。</li>
</ul>
<p><strong>错误修复</strong></p>
<ul>
<li>Grafana 的安全漏洞（升级到 v8.3.1 <a href="https://grafana.com/blog/2021/12/07/grafana-8.3.1-8.2.7-8.1.8-and-8.0.7-released-with-high-severity-security-fix/">问题</a>)</li>
<li>修复 <code>pg_instance</code> &amp; <code>pg_service</code> 在 <code>register</code> 角色中从剧本的中间开始时的问题</li>
<li>修复在没有 <code>pg_cluster</code> 变量存在的主机上 nginx 主页渲染问题</li>
<li>在升级到 grafana 8.3.1 时修复样式问题</li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-d2b8bcedf0eac31226e2b7f3dcba7d8a">v1.2.0 发布注记</h1>
	<div class="lead">Redis Support, PGCAT Overhaul</div>
	<div class="td-byline mb-4">
		By <b>Ruohang Feng（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2021-11-03" class="text-muted">2021年11月03日</time>
        
	</div>
	<hr>
<h2 id="v120">v1.2.0</h2>
<ul>
<li>【功能增强】默认使用 PostgreSQL 14 版本</li>
<li>【功能增强】默认使用 TimescaleDB 2.5 扩展
<ul>
<li>现在 timescaledb 和 postgis 默认在 cmdb 中启用</li>
</ul>
</li>
<li>【功能增强】 新增仅监控模式：
<ul>
<li>仅通过可连接的 URL，您可以使用 pigsty 监控现有的 pg 实例</li>
<li>pg_exporter 将在本地的 meta 节点上部署</li>
<li>新仪表板 PGSQL Cluster Monly 用于远程集群</li>
</ul>
</li>
<li>【功能增强】软件升级
<ul>
<li>grafana 升级到 8.2.2</li>
<li>pev2 升级到 v0.11.9</li>
<li>promscale 升级到 0.6.2</li>
<li>pgweb 升级到 0.11.9</li>
<li>新增扩展：pglogical、pg_stat_monitor、orafce
-【功能增强】自动检测机器规格并使用适当的 <code>node_tune</code> 和 <code>pg_conf</code> 模板
-【功能增强】重做与膨胀相关的视图，现在公开更多信息
-【功能增强】删除 timescale 和 citus 的内部监控
-【功能增强】新剧本 <code>pgsql-audit.yml</code> 用于创建审计报告
-【BUG修复】现在 pgbouncer_exporter 资源所有者是 {{ pg_dbsu }} 而不是 postgres
-【BUG修复】 修复在执行 <code>REINDEX TABLE CONCURRENTLY</code> 时 pg_exporter 在 pg_table pg_index 上的重复指标
-【功能增强】现在所有配置模板都减少到两个：auto 和 demo。(已删除：<code>pub4, pg14, demo4, tiny, oltp</code>)</li>
<li>如果 <code>vagrant</code> 是默认用户，则配置 <code>pigsty-demo</code>，否则使用 <code>pigsty-auto</code>。</li>
</ul>
</li>
</ul>
<p><strong>如何从 v1.1.1 升级</strong></p>
<p>在 1.2.0 中没有 API 变更。您仍然可以使用旧的 <code>pigsty.yml</code> 配置文件 (PG13)。
对于基础设施部分，重新执行 <code>repo</code> 将完成大部分工作。</p>
<p>至于数据库，您仍然可以使用现有的 PG13 实例。就地升级在涉及到像 PostGIS 和 Timescale 这样的扩展时非常棘手。我强烈推荐使用逻辑复制进行数据库迁移。
新的剧本 <code>pgsql-migration.yml</code> 将使这一过程变得容易得多。它将创建一系列的脚本，帮助您近乎零停机时间地迁移您的集群。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-854c111b55099c9d05d054f2e73a5cbf">v1.1.0 发布注记</h1>
	<div class="lead">Pigsty v1.1.0 更新了主页设计, JupyterLab, PGWEB, Pev2 &amp; pgbadger 支持</div>
	<div class="td-byline mb-4">
		By <b>Ruohang Feng（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2021-10-12" class="text-muted">2021年10月12日</time>
        
	</div>
	<hr>
<h2 id="v110">v1.1.0</h2>
<ul>
<li>【增强功能】 增加 <code>pg_dummy_filesize</code> 以创建文件系统空间占位符</li>
<li>【增强功能】 主页大改版</li>
<li>【增强功能】 增加 Jupyter Lab 整合</li>
<li>【增强功能】 增加 pgweb 控制台整合</li>
<li>【增强功能】 增加 pgbadger 支持</li>
<li>【增强功能】 增加 pev2 支持，解释可视化工具</li>
<li>【增强功能】 增加 pglog 工具</li>
<li>【增强功能】 更新默认的 pkg.tgz 软件版本：
<ul>
<li>PostgreSQL 升级至 v13.4（支持官方的 pg14）</li>
<li>pgbouncer 升级至 v1.16（指标定义更新）</li>
<li>Grafana 升级至 v8.1.4</li>
<li>Prometheus 升级至 v2.2.29</li>
<li>node_exporter 升级至 v1.2.2</li>
<li>haproxy 升级至 v2.1.1</li>
<li>consul 升级至 v1.10.2</li>
<li>vip-manager 升级至 v1.0.1</li>
</ul>
</li>
</ul>
<p><strong>API 变更</strong></p>
<ul>
<li><code>nginx_upstream</code> 现在持有不同的结构。（不兼容）</li>
<li>新的配置条目：<code>app_list</code>，渲染至主页的导航条目</li>
<li>新的配置条目：<code>docs_enabled</code>，在默认服务器上设置本地文档</li>
<li>新的配置条目：<code>pev2_enabled</code>，设置本地的 pev2 工具</li>
<li>新的配置条目：<code>pgbadger_enabled</code>，创建日志概要/报告目录</li>
<li>新的配置条目：<code>jupyter_enabled</code>，在元节点上启用 Jupyter Lab 服务器</li>
<li>新的配置条目：<code>jupyter_username</code>，指定运行 Jupyter Lab 的用户</li>
<li>新的配置条目：<code>jupyter_password</code>，指定 Jupyter Lab 的默认密码</li>
<li>新的配置条目：<code>pgweb_enabled</code>，在元节点上启用 pgweb 服务器</li>
<li>新的配置条目：<code>pgweb_username</code>，指定运行 pgweb 的用户</li>
<li>将内部标记 <code>repo_exist</code> 重命名为 <code>repo_exists</code></li>
<li>现在 <code>repo_address</code> 的默认值为 <code>pigsty</code> 而非 <code>yum.pigsty</code></li>
<li>现在 haproxy 的访问点为 <code>http://pigsty</code> 而非 <code>http://h.pigsty</code></li>
</ul>
<hr>
<h2 id="v111">v1.1.1</h2>
<ul>
<li>【功能增强】 用 <code>timescale</code> 版本替换 timescaledb 的 <code>apache</code> 版本</li>
<li>【功能增强】 升级 prometheus 到 2.30</li>
<li>【BUG修复】 现在 pg_exporter 配置目录的属主是 <code>{{ pg_dbsu }}</code>，而不再是 <code>prometheus</code></li>
</ul>
<p><strong>如何从v1.1.0升级？</strong></p>
<p>这个版本的主要变动是 TimescaleDB，使用 TimescaleDB License （TSL）的官方版本替代了 PGDG 仓库中的 Apache License v2 的版本。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>stop/pause postgres instance with timescaledb
</span></span><span style="display:flex;"><span>yum remove -y timescaledb_13
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>timescale_timescaledb<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">=</span>timescale_timescaledb
</span></span><span style="display:flex;"><span><span style="color:#000">baseurl</span><span style="color:#ce5c00;font-weight:bold">=</span>https://packagecloud.io/timescale/timescaledb/el/7/<span style="color:#000">$basearch</span>
</span></span><span style="display:flex;"><span><span style="color:#000">repo_gpgcheck</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000">gpgcheck</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000">enabled</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>yum install timescaledb-2-postgresql13 
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-794b5d90dc8a76efe53cd1189faf34ff">v1.0.0 发布注记</h1>
	<div class="lead">v1.0.0 Release</div>
	<div class="td-byline mb-4">
		By <b>Ruohang Feng（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2021-07-26" class="text-muted">2021年07月26日</time>
        
	</div>
	<hr>
<h2 id="v100">v1.0.0</h2>
<p>v1 正式发布，监控系统全面改进</p>
<h2 id="亮点"><strong>亮点</strong></h2>
<ul>
<li><strong>监控系统全面改进</strong>
<ul>
<li>在 Grafana 8.0 上新增仪表盘</li>
<li>新的度量定义，增加 PG14 支持</li>
<li>简化的标签系统：静态标签集：(job, cls, ins)</li>
<li>新的警报规则与衍生度量</li>
<li>同时监控多个数据库</li>
<li>实时日志搜索 &amp; csvlog 分析</li>
<li>链接丰富的仪表盘，点击图形元素进行深入|汇总</li>
</ul>
</li>
<li><strong>架构变更</strong>
<ul>
<li>将 citus 和 timescaledb 加入默认安装部分</li>
<li>增加对 PostgreSQL 14beta2 的支持</li>
<li>简化 haproxy 管理页面索引</li>
<li>通过添加新的角色 <code>register</code> 来解耦基础设施和 pgsql</li>
<li>添加新角色 <code>loki</code> 和 <code>promtail</code> 用于日志记录</li>
<li>为管理员节点上的管理员用户添加新角色 <code>environ</code> 以设置环境</li>
<li>默认使用 <code>static</code> 服务发现用于 prometheus（而不是 <code>consul</code>）</li>
<li>添加新角色 <code>remove</code> 以优雅地移除集群和实例</li>
<li>升级 prometheus 和 grafana 的配置逻辑</li>
<li>升级到 vip-manager 1.0，node_exporter 1.2，pg_exporter 0.4，grafana 8.0</li>
<li>现在，每个实例上的每个数据库都可以自动注册为 grafana 数据源</li>
<li>将 consul 注册任务移到 <code>register</code> 角色，更改 consul 服务标签</li>
<li>添加 cmdb.sql 作为 pg-meta 基线定义（CMDB &amp; PGLOG）</li>
</ul>
</li>
<li><strong>应用框架</strong>
<ul>
<li>可扩展框架用于新功能</li>
<li>核心应用：PostgreSQL 监控系统：<code>pgsql</code></li>
<li>核心应用：PostgreSQL 目录浏览器：<code>pgcat</code></li>
<li>核心应用：PostgreSQL Csvlog 分析器：<code>pglog</code></li>
<li>添加示例应用 <code>covid</code> 用于可视化 covid-19 数据</li>
<li>添加示例应用 <code>isd</code> 用于可视化 isd 数据</li>
</ul>
</li>
<li><strong>其他</strong>
<ul>
<li>添加 jupyterlab，为数据科学提供完整的 python 环境</li>
<li>添加 <code>vonng-echarts-panel</code> 以恢复对 Echarts 的支持</li>
<li>添加 wrap 脚本 <code>createpg</code>，<code>createdb</code>，<code>createuser</code></li>
<li>添加 cmdb 动态库存脚本：<code>load_conf.py</code>，<code>inventory_cmdb</code>，<code>inventory_conf</code></li>
<li>移除过时的剧本：<code>pgsql-monitor</code>，<code>pgsql-service</code>，<code>node-remove</code> 等&hellip;.</li>
</ul>
</li>
</ul>
<h2 id="api-变更"><strong>API 变更</strong></h2>
<ul>
<li>新变量: <code>node_meta_pip_install</code></li>
<li>新变量: <code>grafana_admin_username</code></li>
<li>新变量: <code>grafana_database</code></li>
<li>新变量: <code>grafana_pgurl</code></li>
<li>新变量: <code>pg_shared_libraries</code></li>
<li>新变量: <code>pg_exporter_auto_discovery</code></li>
<li>新变量: <code>pg_exporter_exclude_database</code></li>
<li>新变量: <code>pg_exporter_include_database</code></li>
<li>变量重命名: <code>grafana_url</code> 为 <a href="http://doc.pigsty.cc/#/zh-cn/v-meta?id=grafana_endpoint"><code>grafana_endpoint</code></a></li>
</ul>
<h2 id="bug-修复"><strong>Bug 修复</strong></h2>
<ul>
<li>修复默认时区 Asia/Shanghai (CST) 问题</li>
<li>修复 pgbouncer &amp; patroni 的 nofile 限制</li>
<li>当执行标签 <code>pgbouncer</code> 时，pgbouncer 的用户列表和数据库列表将会被生成</li>
</ul>
<hr>
<h2 id="v101">v1.0.1</h2>
<p>2021-09-14</p>
<ul>
<li>文档更新
<ul>
<li>现已支持中文文档</li>
<li>现已支持机器翻译的英文文档</li>
</ul>
</li>
<li>错误修复：<code>pgsql-remove</code> 不会移除主实例</li>
<li>错误修复：用 pg_cluster + pg_seq 替换 pg_instance
<ul>
<li>Start-At-Task 可能因为 pg_instance 未定义而失败</li>
</ul>
</li>
<li>错误修复：从默认共享预加载库中移除 citus
<ul>
<li>citus 会强制 max_prepared_transaction 的值为非零</li>
</ul>
</li>
<li>错误修复：在 <code>configure</code> 中进行 ssh sudo 检查：
<ul>
<li>现在使用 <code>ssh -t sudo -n ls</code> 进行权限检查</li>
</ul>
</li>
<li>笔误修复：<code>pg-backup</code> 脚本的笔误</li>
<li>警报调整：移除 NTP 合理性检查警报（与 ClockSkew 重复）</li>
<li>导出器调整：移除 collector.systemd 以减少开销</li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-53940fb31dd185924dcbf98876521bbc">v0.9.0 发布注记</h1>
	<div class="lead">Pigsty v0.9极大简化了安装流程，进行了大量日志相关改进，开发了命令行工具（Beta），并修复了一系列问题。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2021-05-01" class="text-muted">2021年05月01日</time>
        
	</div>
	<hr>
<h2 id="v090">v0.9.0</h2>
<h3 id="新功能">新功能</h3>
<ul>
<li>
<p>一键安装模式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/bin/bash -c <span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>curl -fsSL https://pigsty.cc/install<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>开发命令行工具 <code>pigsty-cli</code>封装常用Ansible命令，目前pigsty-cli处于Beta状态</p>
</li>
<li>
<p>使用Loki与Promtail收集日志：</p>
<ul>
<li>默认收集Postgres，Pgbouncer，Patroni日志</li>
<li>新增部署脚本<code>infra-loki.yml</code> 与 <code>pgsql-promtail.yml</code></li>
<li>定义基于日志的监控指标</li>
<li>使用Grafana制作日志相关可视化面板。</li>
</ul>
</li>
<li>
<p>监控组件可以使用二进制安装，使用<code>files/get_bin.sh</code>下载监控二进制组件。</p>
</li>
<li>
<p>飞升模式：</p>
<p>当集群元节点初始化完成后，可以使用<code>bin/upgrade</code>升级为动态Inventory</p>
<p>使用pg-meta上的数据库代替YAML配置文件。</p>
</li>
</ul>
<h3 id="问题修复">问题修复</h3>
<ul>
<li>
<p>集中修复日志相关问题：</p>
<ul>
<li>修复了HAProxy健康检查造成PG日志中大量 <code>connection reset by peer</code>的问题。</li>
<li>修复了HAProxy健康检查造成Patroni日志中大量出现<code>Connect Reset</code> Exception的问题</li>
<li>修复了Patroni日志时间戳格式，去除毫秒时间戳，附加完整时区信息。</li>
<li>为<code>dbuser_monitor</code>配置1秒的<code>log_min_duration_statement</code>，避免监控查询出现在日志中。</li>
</ul>
</li>
<li>
<p>重构Grafana角色</p>
<ul>
<li>在保持API不变的前提下重构Grafana角色。</li>
<li>使用CDN下载预打包的Grafana插件，加速插件下载</li>
</ul>
</li>
<li>
<p>其他问题修复</p>
<ul>
<li>修复了<code>pgbouncer-create-user</code> 未能正确处理 md5 密码的问题。</li>
<li>完善了数据库与用户创建SQL模版中参数空置检查。</li>
<li>修复了 NODE DNS配置时如果手工中断执行，DNS配置可能出错的问题。</li>
<li>重构了Makefile快捷方式 Makefile 中的错别字</li>
</ul>
</li>
</ul>
<h3 id="参数变更">参数变更</h3>
<ul>
<li><code>node_disable_swap</code> 默认为 False，默认不会关闭SWAP。</li>
<li><code>node_sysctl_params</code> 不再有默认修改的系统参数。</li>
<li><code>grafana_plugin</code> 的默认值<code>install</code> 现在意味着当插件缓存不存在时，从CDN下载。</li>
<li><code>repo_url_packages</code> 现在从 Pigsty CDN 下载额外的RPM包，解决墙内无法访问的问题。</li>
<li><code>proxy_env.no_proxy</code>现在将Pigsty CDN加入到NOPROXY列表中。</li>
<li><code>grafana_customize</code> 现在默认为<code>false</code>，启用意味着安装Pigsty Pro版UI（默认不开源所以不要启用）</li>
<li><code>node_admin_pk_current</code>，新增选项，启用后会将当前用户的<code>~/.ssh/id_rsa.pub</code>添加至管理员的Key中</li>
<li><code>loki_clean</code>：新增选项，安装Loki时是否清除现有数据</li>
<li><code>loki_data_dir</code>：新增选项，指明安装Loki时的数据目录</li>
<li><code>promtail_enabled</code> 是否启用Promtail日志收集服务？</li>
<li><code>promtail_clean</code> 是否在安装promtail时移除已有状态信息？</li>
<li><code>promtail_port</code> promtail使用的默认端口，默认为9080</li>
<li><code>promtail_status_file</code> 保存Promtail状态信息的文件位置</li>
<li><code>promtail_send_url</code> 用于接收日志的loki服务endpoint</li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-1c0e38dfb9d42ffaff8ca7937ecd2e21">v0.8.0 发布注记</h1>
	<div class="lead">Pigsty v0.8 重做了服务供给部分，提供了集成外部负载均衡器的扩展接口。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2021-03-16" class="text-muted">2021年03月16日</time>
        
	</div>
	<hr>
<h2 id="v080">v0.8.0</h2>
<p>v0.8 针对 <strong>服务（Service）</strong> 接入部分进行了彻底的重做。现在除了默认的<code>primary</code>, <code>replica</code>服务外，用户可以自行定义新的服务。服务的接口可以支持多种不同的实现，例如L4 DPKG VIP可作为Haproxy的替代品与Pigsty集成。同时，针对用户反馈的一些问题进行了集中处理与改进。</p>
<h3 id="改动内容">改动内容</h3>
<p>v0.8是供给方案定稿版本，此后供给系统的API将保持稳定。</p>
<h4 id="api变更">API变更</h4>
<p>原有<code>vip</code>与<code>haproxy</code>角色的所有配置项，现在迁移至<code>service</code>角色中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#------------------------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># SERVICE PROVISION</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#------------------------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_weight</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic"># default load balance weight (instance level)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># - service - #</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#8f5902;font-style:italic"># how to expose postgres service in cluster?</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># primary service will route {ip|name}:5433 to primary pgbouncer (5433-&gt;6432 rw)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># service name {{ pg_cluster }}_primary</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">src_ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">src_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5433</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">dst_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbouncer    </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 5433 route to pgbouncer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">check_url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/primary    </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># primary health check, success when instance is primary</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># select all instance as primary service candidate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># replica service will route {ip|name}:5434 to replica pgbouncer (5434-&gt;6432 ro)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># service name {{ pg_cluster }}_replica</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">src_ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">src_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5434</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">dst_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbouncer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">check_url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/read-only  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># read-only health check. (including primary)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># select all instance as replica service candidate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selector_backup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `primary`]&#34;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># primary are used as backup server in replica service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># default service will route {ip|name}:5436 to primary postgres (5436-&gt;5432 primary)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># service&#39;s actual name is {{ pg_cluster }}-{{ service.name }}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">src_ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># service bind ip address, * for all, vip for cluster virtual ip address</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">src_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5436</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># bind port, mandatory</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">dst_port: postgres      # target port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres|pgbouncer|port_number , pgbouncer(6432) by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">check_method: http      # health check method</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">only http is available for now</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">check_port: patroni     # health check port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">patroni|pg_exporter|port_number , patroni by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">check_url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/primary    </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># health check url path, / as default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">check_code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># health check http code, 200 as default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># instance selector</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">haproxy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># haproxy specific fields</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">maxconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># default front-end connection</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">balance</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">roundrobin  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># load balance algorithm (roundrobin by default)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">default_server_options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># offline service will route {ip|name}:5438 to offline postgres (5438-&gt;5432 offline)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">offline          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># service name {{ pg_cluster }}_replica</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">src_ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">src_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5438</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">dst_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">check_url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/replica    </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># offline MUST be a replica</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># instances with pg_role == &#39;offline&#39; or instance marked with &#39;pg_offline_query == true&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selector_backup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># replica are used as backup server in offline service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_services_extra</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># extra services to be added</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># - haproxy - #</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">haproxy_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#8f5902;font-style:italic"># enable haproxy among every cluster members</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">haproxy_reload</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># reload haproxy after config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">haproxy_policy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">roundrobin                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># roundrobin, leastconn</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">haproxy_admin_auth_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># enable authentication for haproxy admin?</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">haproxy_admin_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin                </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># default haproxy admin username</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">haproxy_admin_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin                </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># default haproxy admin password</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">haproxy_exporter_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9101</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># default admin/exporter port</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">haproxy_client_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">3h                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># client side connection timeout</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">haproxy_server_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">3h                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># server side connection timeout</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># - vip - #</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">vip_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">none                               </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># none | l2 | l4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">vip_reload</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                              </span><span style="color:#8f5902;font-style:italic"># whether reload service after config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># vip_address: 127.0.0.1                      # virtual ip address ip (l2 or l4)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># vip_cidrmask: 24                            # virtual ip address cidr mask (l2 only)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># vip_interface: eth0                         # virtual ip network interface (l2 only)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>新增选项</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># - localization - #</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_encoding</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UTF8                            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># default to UTF8</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_locale</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">C                                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># default to C</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_lc_collate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">C                             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># default to C</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_lc_ctype</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">en_US.UTF8                      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># default to en_US.UTF8</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_reload</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#8f5902;font-style:italic"># reload postgres after hba changes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">vip_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">none                               </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># none | l2 | l4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">vip_reload</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                              </span><span style="color:#8f5902;font-style:italic"># whether reload service after config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>移除选项</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>haproxy_check_port                            <span style="color:#8f5902;font-style:italic"># Haproxy相关参数已经被Service定义覆盖</span>
</span></span><span style="display:flex;"><span>haproxy_primary_port
</span></span><span style="display:flex;"><span>haproxy_replica_port
</span></span><span style="display:flex;"><span>haproxy_backend_port
</span></span><span style="display:flex;"><span>haproxy_weight
</span></span><span style="display:flex;"><span>haproxy_weight_fallback
</span></span><span style="display:flex;"><span>vip_enabled                                   <span style="color:#8f5902;font-style:italic"># vip_enabled参数被vip_mode覆盖</span>
</span></span></code></pre></div><h4 id="服务管理">服务管理</h4>
<p><code>pg_services</code> 与 <code>pg_services_extra</code> 定义了集群中的<strong>服务</strong>，每一个服务的定义结构如下例所示：</p>
<p>一个服务必须指定以下内容：</p>
<ul>
<li>
<p><strong>名称</strong>：服务的完整名称以数据库集群名为前缀，以<code>service.name</code>为后缀，通过<code>-</code>连接。例如在<code>pg-test</code>集群中<code>name=primary</code>的服务，其完整服务名称为<code>pg-test-primary</code>。</p>
</li>
<li>
<p><strong>端口</strong>：在Pigsty中，服务默认采用NodePort的形式对外暴露，因此暴露端口为必选项。但如果使用外部负载均衡服务接入方案，您也可以通过其他的方式区分服务。</p>
</li>
<li>
<p><strong>选择器</strong>：选择器指定了服务的成员，采用JMESPath的形式，从所有集群实例成员中筛选变量。默认的<code>[]</code>选择器会选取所有的集群成员。</p>
<p>此外<code>selector_backup</code>会选择或标记用于backup的实例列表（当集群中所有其他成员失效时方才接管服务）</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># default service will route {ip|name}:5436 to primary postgres (5436-&gt;5432 primary)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># service&#39;s actual name is {{ pg_cluster }}-{{ service.name }}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">src_ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># service bind ip address, * for all, vip for cluster virtual ip address</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">src_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5436</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># bind port, mandatory</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">dst_port: postgres      # target port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres|pgbouncer|port_number , pgbouncer(6432) by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">check_method: http      # health check method</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">only http is available for now</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">check_port: patroni     # health check port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">patroni|pg_exporter|port_number , patroni by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">check_url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/primary    </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># health check url path, / as default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">check_code</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># health check http code, 200 as default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># instance selector</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">haproxy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># haproxy specific fields</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">maxconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># default front-end connection</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">balance</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">roundrobin  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># load balance algorithm (roundrobin by default)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">default_server_options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="数据库管理">数据库管理</h3>
<p>数据库现在可以对locale的细分选项：<code>lc_ctype</code>与<code>lc_collate</code>分别进行指定。支持这一功能的主要原因是PG的扩展插件<code>pg_trgm</code>需要在<code>lc_ctype!=C</code>的环境中才能正常支持中文。</p>
<h4 id="旧接口定义">旧接口定义</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta                     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># name is the only required field for a database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres                </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, database owner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">template1            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, template1 by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">encoding</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UTF8                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, UTF8 by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">locale</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">C                      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, C by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">allowconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># optional, true by default, false disable connect at all</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">revokeconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic"># optional, false by default, true revoke connect from public # (only default user and owner have connect privilege on database)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">tablespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_default         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, &#39;pg_default&#39; is the default tablespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># optional, connection limit, -1 or none disable limit (default)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># optional, extension name and where to create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: postgis, schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">public}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># optional, extra parameters with ALTER DATABASE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">enable_partitionwise_join</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pgbouncer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># optional, add this database to pgbouncer list? true by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty meta database  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, comment string for database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h4 id="新的接口定义">新的接口定义</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta                     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># name is the only required field for a database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># owner: postgres                 # optional, database owner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># template: template1             # optional, template1 by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># encoding: UTF8                # optional, UTF8 by default , must same as template database, leave blank to set to db default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># locale: C                     # optional, C by default , must same as template database, leave blank to set to db default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># lc_collate: C                 # optional, C by default , must same as template database, leave blank to set to db default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># lc_ctype: C                   # optional, C by default , must same as template database, leave blank to set to db default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">allowconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># optional, true by default, false disable connect at all</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">revokeconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic"># optional, false by default, true revoke connect from public # (only default user and owner have connect privilege on database)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># tablespace: pg_default          # optional, &#39;pg_default&#39; is the default tablespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># optional, connection limit, -1 or none disable limit (default)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># optional, extension name and where to create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: postgis, schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">public}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># optional, extra parameters with ALTER DATABASE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">enable_partitionwise_join</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pgbouncer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># optional, add this database to pgbouncer list? true by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty meta database  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, comment string for database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-a757729041ec674785eddd6b2c1694e2">v0.7.0 发布注记</h1>
	<div class="lead">Pigsty v0.7 新增了仅监控部署模式，改进了数据库与用户的供给接口。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2021-03-01" class="text-muted">2021年03月01日</time>
        
	</div>
	<hr>
<h2 id="v070">v0.7.0</h2>
<p>v0.7 针对<strong>接入已有数据库实例</strong>进行了改进，现在用户可以采用 <strong>仅监控部署（Monly Deployment）</strong> 模式使用Pigsty。同时新增了专用于管理数据库与用户、以及单独部署监控的剧本，并对数据库与用户的定义进行改进。</p>
<h3 id="改动内容">改动内容</h3>
<h4 id="features">Features</h4>
<ul>
<li><a href="https://github.com/Vonng/pigsty/issues/25">Monitor Only Deployment Support #25</a></li>
<li><a href="https://github.com/Vonng/pigsty/issues/36">Split monolith static monitor target file into per-cluster conf #36</a></li>
<li><a href="https://github.com/Vonng/pigsty/issues/29">Add create user playbook #29</a></li>
<li><a href="https://github.com/Vonng/pigsty/issues/28">Add create database playbook #28</a></li>
<li><a href="https://github.com/Vonng/pigsty/issues/33">Database provisioning interface enhancement #33</a></li>
<li><a href="https://github.com/Vonng/pigsty/issues/34">User provisioning interface enhancement #34</a></li>
</ul>
<h4 id="bug-fix">Bug Fix</h4>
<ul>
<li><a href="https://github.com/Vonng/pigsty/issues/32">Create extension with schema typo #32</a></li>
<li><a href="https://github.com/Vonng/pigsty/issues/35">pgbouncer reload with systemctl not work #35</a></li>
</ul>
<h4 id="api变更">API变更</h4>
<p><strong>新增选项</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">prometheus_sd_target</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">batch                  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># batch|single    监控目标定义文件采用单体还是每个实例一个</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">exporter_install</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">none                       </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># none|yum|binary 监控Exporter的安装模式</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">exporter_repo_url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#8f5902;font-style:italic"># 如果设置，这里的REPO连接会加入目标的Yum源中</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">node_exporter_options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;--no-collector.softnet --collector.systemd --collector.ntp --collector.tcpstat --collector.processes&#39;</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># Node Exporter默认的命令行选项</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_exporter_url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#8f5902;font-style:italic"># 可选，PG Exporter监控对象的URL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgbouncer_exporter_url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#8f5902;font-style:italic"># 可选，PGBOUNCER EXPORTER监控对象的URL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>移除选项</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">exporter_binary_install</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># 功能被 exporter_install 覆盖</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>定义结构变更</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">pg_default_roles                              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 变化细节参考 用户管理。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">pg_users                                      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 变化细节参考 用户管理。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">pg_databases                                  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 变化细节参考 数据库管理。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>重命名选项</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#000">pg_default_privilegs -&gt; pg_default_privileges</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 很明显这是一个错别字</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="仅监控模式">仅监控模式</h2>
<p>有时用户不希望使用Pigsty供给方案，只希望使用Pigsty监控系统管理现有PostgreSQL实例。</p>
<p>Pigsty提供了 <a href="https://pigsty.cc/zh/docs/deploy/integration/"><strong>仅监控部署（monly, monitor-only）</strong></a> 模式，剥离供给方案部分，可用于监控现有PostgreSQL集群。</p>
<p>仅监控模式的部署流程与标准模式大体上保持一致，但省略了很多步骤</p>
<ul>
<li>在<strong>元节点</strong>上完成<a href="/zh/docs/deploy/playbook/pgsql-provision/">基础设施初始化</a>的部分与标准流程保持一致，仍然通过<code>./infra.yml</code>完成。</li>
<li>不需要在<strong>数据库节点</strong>上完成 <strong>基础设施初始化</strong>。</li>
<li>不需要在<strong>数据库节点</strong>上执行<a href="/zh/docs/deploy/playbook/pgsql-provision/">数据库初始化</a>的绝大多数任务，而是通过专用的<code>./pgsql-monitor.yml</code> 完成仅监控系统部署。</li>
<li>实际使用的配置项大大减少，只保留基础设施相关变量，与 <a href="/zh/docs/deploy/config/9-monitor/">监控系统</a> 相关的少量变量。</li>
</ul>
<h2 id="数据库管理">数据库管理</h2>
<p><a href="https://github.com/Vonng/pigsty/issues/33">Database provisioning interface enhancement #33</a></p>
<h3 id="旧接口定义">旧接口定义</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#8f5902;font-style:italic"># create a business database &#39;meta&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">schemas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">meta]                </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># create extra schema named &#39;meta&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgis}]  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># create extra extension postgis</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># overwrite database meta&#39;s default search_path</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">search_path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">public, monitor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="新的接口定义">新的接口定义</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta                     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># name is the only required field for a database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres                </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, database owner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">template1            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, template1 by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">encoding</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UTF8                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, UTF8 by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">locale</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">C                      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, C by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">allowconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># optional, true by default, false disable connect at all</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">revokeconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic"># optional, false by default, true revoke connect from public # (only default user and owner have connect privilege on database)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">tablespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_default         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, &#39;pg_default&#39; is the default tablespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># optional, connection limit, -1 or none disable limit (default)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># optional, extension name and where to create</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: postgis, schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">public}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># optional, extra parameters with ALTER DATABASE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">enable_partitionwise_join</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pgbouncer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># optional, add this database to pgbouncer list? true by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty meta database  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, comment string for database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="接口变更">接口变更</h3>
<ul>
<li>Add new options: <code>template</code> , <code>encoding</code>, <code>locale</code>, <code>allowconn</code>, <code>tablespace</code>, <code>connlimit</code></li>
<li>Add new option <code>revokeconn</code>, which revoke connect privileges from public for this database</li>
<li>Add <code>comment</code> field for database</li>
</ul>
<h3 id="数据库变更">数据库变更</h3>
<p>在运行中集群中创建新数据库可以使用<code>pgsql-createdb.yml</code>剧本，在配置中定义完新数据库后，执行以下剧本。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql-createdb.yml -e <span style="color:#000">pg_database</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;your_new_database_name&gt;
</span></span></code></pre></div><p>通过<code>-e pg_datbase=</code>告知需要创建的数据库名称，则该数据库即会被创建（或修改）。具体执行的命令参见集群主库<code>/pg/tmp/pg-db-{{ database.name}}.sql</code>文件。</p>
<h2 id="用户管理">用户管理</h2>
<p><a href="https://github.com/Vonng/pigsty/issues/34">User provisioning interface enhancement #34</a></p>
<h3 id="旧接口定义-1">旧接口定义</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># example production user have read-write access</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># example user&#39;s password</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LOGIN                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># extra options</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">groups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_readwrite ]   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># dborole_admin|dbrole_readwrite|dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default test user for production usage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pgbouncer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># add to pgbouncer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="新接口定义">新接口定义</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># complete example of user/role definition for production user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_meta              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># example production user have read-write access</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Meta          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># example user&#39;s password, can be encrypted</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">login</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># can login, true by default (should be false for role)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">superuser</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># is superuser? false by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">createdb</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># can create database? false by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">createrole</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic"># can create role? false by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">inherit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># can this role use inherited privileges?</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">replication</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic"># can this role do replication? false by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">bypassrls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># can this role bypass row level security? false by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># connection limit, -1 disable limit</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">expire_at</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;2030-12-31&#39;</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># &#39;timestamp&#39; when this role is expired</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">expire_in</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">365</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># now + n days when this role is expired (OVERWRITE expire_at)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">dbrole_readwrite]      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># dborole_admin|dbrole_readwrite|dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pgbouncer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># add this user to pgbouncer? false by default (true for production user)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># user&#39;s default search path</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">search_path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">public</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="接口变更-1">接口变更</h3>
<ul>
<li>
<p><code>username</code> field rename to <code>name</code></p>
</li>
<li>
<p><code>groups</code> field rename to <code>roles</code></p>
</li>
<li>
<p><code>options</code> now split into separated configration entries:</p>
<p><code>login</code>, <code>superuser</code>, <code>createdb</code>, <code>createrole</code>, <code>inherit</code>, <code>replication</code>,<code>bypassrls</code>,<code>connlimit</code></p>
</li>
<li>
<p><code>expire_at</code> and <code>expire_in</code> options</p>
</li>
<li>
<p><code>pgbouncer</code> option for user is now <code>false</code> by default</p>
</li>
</ul>
<h3 id="用户管理-1">用户管理</h3>
<p>在运行中集群中创建新数据库可以使用<code>pgsql-createuser.yml</code>剧本，在配置中定义完新数据库后，执行以下剧本。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql-createuser.yml -e <span style="color:#000">pg_user</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;your_new_user_name&gt;
</span></span></code></pre></div><p>通过<code>-e pg_user=</code>告知需要创建的数据库名称，则该数据库即会被创建（或修改）。具体执行的命令参见集群主库<code>/pg/tmp/pg-user-{{ user.name}}.sql</code>文件。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-9d3157a4b85f04c552b9dc4e0605e241">v0.6.0 发布注记</h1>
	<div class="lead">Pigsty v0.6 对数据库供给方案进行了大量改进</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2021-02-19" class="text-muted">2021年02月19日</time>
        
	</div>
	<hr>
<h2 id="v060">v0.6.0</h2>
<p>v0.6 对数据库供给方案进行了修改与调整，根据用户的反馈添加了一系列实用功能与修正。针对监控系统的移植性进行优化，便于与其他外部数据库供给方案对接，例如阿里云MyBase。</p>
<h3 id="bug修复">BUG修复</h3>
<ul>
<li>修复了新版本Patroni重启后会重置PG HBA的问题</li>
<li>修复了PG Overview Dashboard标题中的别字</li>
<li>修复了沙箱集群<code>pg-test</code>的默认主库，原来为<code>pg-test-2</code>，应当为<code>pg-test-1</code></li>
<li>修复了过时代码注释</li>
</ul>
<h3 id="功能改进">功能改进</h3>
<ul>
<li>改造Prometheus与监控供给方式
<ul>
<li>允许在无基础设施的情况下对已有PG集群进行监控部署，便于监控系统与其他供给方案集成。<a href="https://github.com/Vonng/pigsty/issues/11">#11</a></li>
<li>基于Inventory渲染所有监控对象的静态列表，用于静态服务发现。<a href="https://github.com/Vonng/pigsty/issues/11">#11</a></li>
<li>Prometheus添加了静态对象模式，用于替代动态服务发现，集中进行身份管理<a href="https://github.com/Vonng/pigsty/issues/11">#11</a></li>
<li>监控Exporter现在添加了<code>service_registry</code>选项，Consul服务注册变为可选项 <a href="https://github.com/Vonng/pigsty/issues/13">#13</a></li>
<li>Exporter现在可以通过拷贝二进制的方式直接安装：<code>exporter_binary_install</code>，<a href="https://github.com/Vonng/pigsty/issues">#14</a></li>
<li>Exporter现在具有<code>xxx_enabled</code>选项，控制是否启用该组件。</li>
</ul>
</li>
<li>Haproxy供给重构与改进  <a href="https://github.com/Vonng/pigsty/issues/8">#8</a>
<ul>
<li>新增了全局HAProxy管理界面导航，默认域名<code>h.pigsty</code></li>
<li>允许将主库加入只读服务集中，当集群中所有从库宕机时自动承接读流量。 <a href="https://github.com/Vonng/pigsty/issues/8">#8</a></li>
<li>允许位Haproxy实例管理界面启用认证 <code>haproxy_admin_auth_enabled</code></li>
<li>允许通过配置项调整每个服务对应后端的流量权重. <a href="https://github.com/Vonng/pigsty/issues/10">#10</a></li>
</ul>
</li>
<li>访问控制模型改进。<a href="https://github.com/Vonng/pigsty/issues/7">#7</a>
<ul>
<li>添加了默认角色<code>dbrole_offline</code>，用于慢查询，ETL，交互式查询场景。</li>
<li>修改默认HBA规则，允许<code>dbrole_offline</code>分组的用户访问<code>pg_role == 'offline'</code>及<code>pg_offline_query == true</code>的实例。</li>
</ul>
</li>
<li>软件更新 Release v0.6
<ul>
<li>PostgreSQL 13.2</li>
<li>Prometheus 2.25</li>
<li>PG Exporter 0.3.2</li>
<li>Node Exporter 1.1</li>
<li>Consul 1.9.3</li>
<li>更新默认PG源：PostgreSQL现在默认使用浙江大学的镜像，加速下载安装</li>
</ul>
</li>
</ul>
<h3 id="接口变更"><strong>接口变更</strong></h3>
<p><strong>新增选项</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">service_registry</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">consul                     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 服务注册机制：none | consul | etcd | both</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">prometheus_options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;--storage.tsdb.retention=30d&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># prometheus命令行选项</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">prometheus_sd_method</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">consul                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Prometheus使用的服务发现机制：static|consul</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">prometheus_sd_interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">2s                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Prometheus服务发现刷新间隔</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_offline_query</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#8f5902;font-style:italic"># 设置后将允许dbrole_offline角色连接与查询该实例</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">node_exporter_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># 设置后将安装配置Node Exporter</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_exporter_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># 设置后将安装配置PG Exporter</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgbouncer_exporter_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic"># 设置后将安装配置Pgbouncer Exporter</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">dcs_disable_purge</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#8f5902;font-style:italic"># 双保险，强制 dcs_exists_action = abort 避免误删除DCS实例</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_disable_purge</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#8f5902;font-style:italic"># 双保险，强制 pg_exists_action = abort 避免误删除数据库实例</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">haproxy_weight</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#8f5902;font-style:italic"># 配置实例的相对负载均衡权重</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">haproxy_weight_fallback</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#8f5902;font-style:italic"># 配置集群主库在只读服务中的相对权重</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>移除选项</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">prometheus_metrics_path                      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 与 exporter_metrics_path 重复</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">prometheus_retention                         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 功能被 prometheus_options 覆盖</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-a31bec40c01f539af16d13999ac7c1ab">v0.5.0 发布注记</h1>
	<div class="lead">Pigsty v0.5.0 对数据库内部的定制模板进行了大幅改进。</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2020-12-26" class="text-muted">2020年12月26日</time>
        
	</div>
	<hr>
<h2 id="v050">v0.5.0</h2>
<h3 id="大纲">大纲</h3>
<ul>
<li>Pigsty官方<a href="http://pigsty.cc/">文档站</a>正式上线！</li>
<li>添加了数据库模板的定制支持，用户可以通过配置文件定制所需的数据库内部对象。</li>
<li>对默认<a href="/zh/docs/deploy/privileges/">访问控制</a>模型进行了改进</li>
<li>重构了HBA管理的逻辑，现在将由Pigsty替代Patroni直接负责生成HBA</li>
<li>将Grafana监控系统的供给方案从sqlite改为JSON文件静态Provision</li>
<li>将<code>pg-cluster-replication</code>面板加入Pigsty开源免费套餐。</li>
<li>最新的经过测试的离线安装包：<a href="https://github.com/Vonng/pigsty/releases/download/v0.5.0/pkg.tgz">pkg.tgz</a> (v0.5)</li>
</ul>
<h3 id="定制数据库">定制数据库</h3>
<p>您是否烦恼过单实例多租户的问题？比如总有研发拿着PostgreSQL当MySQL使，明明是一个Schema就能解决的问题，非要创建一个新的数据库出来，在一个实例中创建出几十个不同的DB。
不要忧伤，不要心急。Pigsty已经提供数据库内部对象的Provision方案，您可以轻松地在配置文件中指定所需的数据库内对象，包括：</p>
<ul>
<li>角色
<ul>
<li>用户/角色名</li>
<li>密码</li>
<li>用户属性</li>
<li>用户备注</li>
<li>用户所属的权限组</li>
</ul>
</li>
<li>数据库
<ul>
<li>属主</li>
<li>额外的模式</li>
<li>额外的扩展插件</li>
<li>数据库级的自定义配置参数</li>
</ul>
</li>
<li>数据库
<ul>
<li>属主</li>
<li>额外的模式</li>
<li>额外的扩展插件</li>
<li>数据库级的自定义配置参数</li>
</ul>
</li>
<li>默认权限
<ul>
<li>默认情况下这里配置的权限会应用至所有由 超级用户 和 管理员用户创建的对象上。</li>
</ul>
</li>
<li>默认扩展
<ul>
<li>所有新创建的业务数据库都会安装有这些默认扩展</li>
</ul>
</li>
<li>默认模式
<ul>
<li>所有新创建的业务数据库都会创建有这些默认的模式</li>
</ul>
</li>
</ul>
<p>配置样例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通常是每个DB集群配置的变量</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default test user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">groups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_readwrite ]   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># dborole_admin|dbrole_readwrite|dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#8f5902;font-style:italic"># create a business database &#39;test&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgis}]  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># create extra extension postgis</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># overwrite database meta&#39;s default search_path</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">search_path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">public,monitor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 通常是整个环境统一配置的全局变量</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># - system roles - #</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_replication_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replicator          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># system replication user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_replication_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Replicator   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># system replication password</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_monitor_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># system monitor user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_monitor_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Monitor          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># system monitor password</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_admin_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_admin              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># system admin user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_admin_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Admin              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># system admin password</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># - default roles - #</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_default_roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">dbrole_readonly                 # sample user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NOLOGIN                         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># role can not login</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for readonly access        </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># comment string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">username: dbrole_readwrite                # sample user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">one object for each user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NOLOGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for read-write access</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">groups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_readonly ]              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># read-write includes read-only access</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">username: dbrole_admin                    # sample user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">one object for each user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NOLOGIN BYPASSRLS               </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># admin can bypass row level security</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for object creation</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">groups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">dbrole_readwrite,pg_monitor,pg_signal_backend]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># NOTE: replicator, monitor, admin password are overwritten by separated config entry</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres                       </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># reset dbsu password to NULL (if dbsu is not postgres)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SUPERUSER LOGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system superuser</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replicator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REPLICATION LOGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">groups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pg_monitor, dbrole_readonly]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system replicator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LOGIN CONNECTION LIMIT 10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system monitor user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">groups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pg_monitor, dbrole_readonly]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LOGIN BYPASSRLS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system admin user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">groups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">dbrole_admin]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_stats</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Stats</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LOGIN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">business read-only user for statistics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">groups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">dbrole_readonly]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># object created by dbsu and admin will have their privileges properly set</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_default_privilegs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">GRANT USAGE                         ON SCHEMAS   TO dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">GRANT SELECT                        ON TABLES    TO dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">GRANT SELECT                        ON SEQUENCES TO dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">GRANT EXECUTE                       ON FUNCTIONS TO dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">GRANT INSERT, UPDATE, DELETE        ON TABLES    TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">GRANT USAGE,  UPDATE                ON SEQUENCES TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">GRANT TRUNCATE, REFERENCES, TRIGGER ON TABLES    TO dbrole_admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">GRANT CREATE                        ON SCHEMAS   TO dbrole_admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">GRANT USAGE                         ON TYPES     TO dbrole_admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># schemas</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_default_schemas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">monitor]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># extension</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_default_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: &#39;pg_stat_statements&#39;,  schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: &#39;pgstattuple&#39;,         schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: &#39;pg_qualstats&#39;,        schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: &#39;pg_buffercache&#39;,      schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: &#39;pageinspect&#39;,         schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: &#39;pg_prewarm&#39;,          schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: &#39;pg_visibility&#39;,       schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: &#39;pg_freespacemap&#39;,     schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: &#39;pg_repack&#39;,           schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres_fdw</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">file_fdw</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree_gist</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">btree_gin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_trgm</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">intagg</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">intarray</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># postgres host-based authentication rules</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow meta node password access</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">common</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">host    all     all                         10.10.10.10/32      md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow intranet admin password access</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">common</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">host    all     +dbrole_admin               10.0.0.0/8          md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">host    all     +dbrole_admin               172.16.0.0/12       md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">host    all     +dbrole_admin               192.168.0.0/16      md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow intranet password access</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">common</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">host    all             all                 10.0.0.0/8          md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">host    all             all                 172.16.0.0/12       md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">host    all             all                 192.168.0.0/16      md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow local read-write access (local production user via pgbouncer)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">common</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">local   all     +dbrole_readwrite                               md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">host    all     +dbrole_readwrite           127.0.0.1/32        md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow read-only user (stats, personal) password directly access</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">local   all     +dbrole_readonly                               md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">host    all     +dbrole_readonly           127.0.0.1/32        md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_hba_rules_extra</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pgbouncer host-based authentication rules</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgbouncer_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">local password access</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">common</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">local  all          all                                     md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">host   all          all                     127.0.0.1/32    md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">intranet password access</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">common</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">host   all          all                     10.0.0.0/8      md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">host   all          all                     172.16.0.0/12   md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">host   all          all                     192.168.0.0/16  md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgbouncer_hba_rules_extra</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="数据库模板">数据库模板</h3>
<ul>
<li><a href="https://github.com/Vonng/pigsty/blob/master/roles/postgres/templates/pg-init-template.sql">pg-init-template.sql</a> 用于初始化<code>template1</code>数据的脚本模板</li>
<li><a href="https://github.com/Vonng/pigsty/blob/master/roles/postgres/templates/pg-init-business.sql">pg-init-business.sql</a> 用于初始化其他业务数据库的脚本模板</li>
</ul>
<h3 id="权限模型">权限模型</h3>
<p>v0.5 改善了默认的权限模型，主要是针对单实例多租户的场景进行优化，并收紧权限控制。</p>
<ul>
<li>撤回了普通业务用户对非所属数据库的默认<code>CONNECT</code>权限</li>
<li>撤回了非管理员用户对所属数据库的默认<code>CREATE</code>权限</li>
<li>撤回了所有用户在<code>public</code>模式下的默认创建权限。</li>
</ul>
<h2 id="供给方式">供给方式</h2>
<p>原先Pigsty采用直接拷贝Grafana自带的grafana.db的方式完成监控系统的初始化。
这种方式虽然简单粗暴管用，但不适合进行精细化的版本控制管理。在v0.5中，Pigsty采用了Grafana API完成了监控系统面板供给的工作。
您所需的就是在<code>grafana_url</code>中填入带有用户名密码的Grafana URL。
因此，监控系统可以背方便地添加至已有的Grafana中。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-b5d77a188caf8e3a09a3d3b5b8acaa94">v0.4.0 发布注记</h1>
	<div class="lead">Pigsty 第二个公开测试版v0.4现已正式发行</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2020-12-14" class="text-muted">2020年12月14日</time>
        
	</div>
	<hr>
<h2 id="v040">v0.4.0</h2>
<p>第二个公开测试版v0.4现已正式发行</p>
<p>Pigsty v0.4对监控系统进行了整体升级改造，精心挑选了10个面板作为标准的Pigsty开源内容。同时，针对Grafana 7.3的不兼容升级进行了大量适配改造工作。使用升级的<code>pg_exporter v0.3.1</code>作为默认指标导出器，调整了监控报警规则的监控面板连接。</p>
<h3 id="pigsty开源版">Pigsty开源版</h3>
<p>Pigsty开源版选定了以下10个Dashboard作为开源内容。其他Dashboard作为可选的商业支持内容提供。</p>
<ul>
<li>PG Overview</li>
<li>PG Cluster</li>
<li>PG Service</li>
<li>PG Instance</li>
<li>PG Database</li>
<li>PG Query</li>
<li>PG Table</li>
<li>PG Table Catalog</li>
<li>PG Table Detail</li>
<li>Node</li>
</ul>
<p>尽管进行了少量阉割，这10个监控面板所涵盖的内容仍然可以吊打所有同类软件。</p>
<h3 id="软件升级">软件升级</h3>
<p>Pigsty v0.4进行了大量软件适配工作，包括：</p>
<ul>
<li>Upgrade to PostgreSQL 13.1, Patroni 2.0.1-4, add citus to repo.</li>
<li>Upgrade to <a href="https://github.com/Vonng/pg_exporter/releases/tag/v0.3.1"><code>pg_exporter 0.3.1</code></a></li>
<li>Upgrade to Grafana 7.3, Ton&rsquo;s of compatibility work</li>
<li>Upgrade to prometheus 2.23, with new UI as default</li>
<li>Upgrade to consul 1.9</li>
</ul>
<h3 id="其他改进">其他改进</h3>
<ul>
<li>Update prometheus alert rules</li>
<li>Fix alertmanager info links</li>
<li>Fix bugs and typos.</li>
<li>add a simple backup script</li>
</ul>
<h3 id="离线安装包">离线安装包</h3>
<ul>
<li>v0.4的离线安装包（CentOS 7.8）已经可以从Github下载：<a href="https://github.com/Vonng/pigsty/releases/download/v0.4.0/pkg.tgz">pkg.tgz</a></li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-7df560570ddd6f526d521202261d0bf9">v0.3.0 发布注记</h1>
	<div class="lead">Pigsty v0.3.0 第一个公开的试用版本现已释出！</div>
	<div class="td-byline mb-4">
		By <b><a href="https://vonng.com">冯若航</a>（<a href="https://vonng.com/en/">@Vonng</a>）</b> |
        
		<time datetime="2020-10-24" class="text-muted">2020年10月24日</time>
        
	</div>
	<hr>
<h2 id="v030">v0.3.0</h2>
<p>首个Pigsty公开测试版本现在已经释出！</p>
<h2 id="监控系统">监控系统</h2>
<p>Pigsty v0.3 包含以下8个监控面板作为开源内容：</p>
<ul>
<li>PG Overview</li>
<li>PG Cluster</li>
<li>PG Service</li>
<li>PG Instance</li>
<li>PG Database</li>
<li>PG Table Overview</li>
<li>PG Table Catalog</li>
<li>Node</li>
</ul>
<h2 id="离线安装包">离线安装包</h2>
<ul>
<li>v0.3 离线安装包（CentOS 7.8）已经可以从Github下载：<a href="https://github.com/Vonng/pigsty/releases/download/v0.3.0/pkg.tgz">pkg.tgz</a></li>
</ul>

</div>





    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Mail" aria-label="Mail">
    <a target="_blank" rel="noopener" href="mailto:rh@vonng.com" aria-label="Mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Vonng/pigsty" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://twitter.com/GobeUncleWang" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="WeChat" aria-label="WeChat">
    <a target="_blank" rel="noopener" href="/img/pigsty/pigsty-cc.jpg" aria-label="WeChat">
      <i class="fa fa-comment"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Discord" aria-label="Discord">
    <a target="_blank" rel="noopener" href="https://discord.gg/wDzt5VyWEz" aria-label="Discord">
      <i class="fab fa-discord"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Telegram" aria-label="Telegram">
    <a target="_blank" rel="noopener" href="https://t.me/joinchat/gV9zfZraNPM3YjFh" aria-label="Telegram">
      <i class="fab fa-telegram"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2018&ndash;2025
    <span class="td-footer__authors">Ruohang Feng</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span></span><span class="ms-2"><a href="https://vonng.com/en/" target="_blank" rel="noopener">@Vonng</a></span>
<br><span>Pigsty® distributed under <a href="/docs/about/license" target="_blank" rel="noopener">AGPLv3</a></span>
<br><span class="ms-2"><a href="/docs/about/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
<span><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">浙ICP备15016890号</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.248655eb216150e39da254c2f7aa5357805d0ec66bdb741b591cd35fb5f629ab.js" integrity="sha256-JIZV6yFhUOOdolTC96pTV4BdDsZr23QbWRzTX7X2Kas=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
