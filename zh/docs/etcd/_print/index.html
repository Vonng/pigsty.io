<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="/zh/docs/etcd/">
<link rel="alternate" type="application/rss&#43;xml" href="/zh/docs/etcd/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>模块：ETCD | Pigsty</title>
<meta name="description" content="Pigsty 内置了 etcd 支持，这是一个可靠的分布式配置存储数据库，作为 DCS 为 PostgreSQL 高可用提供支持。">
<meta property="og:title" content="模块：ETCD" />
<meta property="og:description" content="Pigsty 内置了 etcd 支持，这是一个可靠的分布式配置存储数据库，作为 DCS 为 PostgreSQL 高可用提供支持。" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/zh/docs/etcd/" />

<meta itemprop="name" content="模块：ETCD">
<meta itemprop="description" content="Pigsty 内置了 etcd 支持，这是一个可靠的分布式配置存储数据库，作为 DCS 为 PostgreSQL 高可用提供支持。"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="模块：ETCD"/>
<meta name="twitter:description" content="Pigsty 内置了 etcd 支持，这是一个可靠的分布式配置存储数据库，作为 DCS 为 PostgreSQL 高可用提供支持。"/>




<link rel="preload" href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" as="style">
<link href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="/js/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LG1V9WTKGE');
}
</script>
  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/zh/"><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class="navbar-brand__name">Pigsty</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/zh/docs/"><i class='fa-solid fa-book'></i><span>文档</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/zh/blog/"><i class="fas fa-blog"></i><span>博客</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/Vonng/pigsty/" target="_blank" rel="noopener"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Link</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/docs/">v3 Docs</a></li>
    <li><a class="dropdown-item" href="https://demo.pigsty.cc">Public Demo</a></li>
    <li><a class="dropdown-item" href="https://ext.pigsty.io">Extension Repo</a></li>
    <li><a class="dropdown-item" href="https://pigsty.cc/zh/docs">pigsty.cc</a></li>
    <li><a class="dropdown-item" href="https://pigsty.cc/zh/blog">ZH Blog</a></li>
    </ul>
</div></li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-language"></i>中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/docs/etcd/">English</a></li>
    </ul>
</div>
</li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.4254d9d640516c9dc82343a43641b8bc.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/zh/docs/etcd/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">模块：ETCD</h1>
<div class="lead">Pigsty 内置了 etcd 支持，这是一个可靠的分布式配置存储数据库，作为 DCS 为 PostgreSQL 高可用提供支持。</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-b3c7d25a96ae732f6a6be2d1fd4d5ec6">集群配置</a></li>


    
  
    
    
	
<li>2: <a href="#pg-0bac52423651fcf771f1cdaad4f4c67b">参数列表</a></li>


    
  
    
    
	
<li>3: <a href="#pg-f7e866452f3057b5647d06b72632819e">预置剧本</a></li>


    
  
    
    
	
<li>4: <a href="#pg-e2a09cf50caf28a3c5a85194967a50bc">管理预案</a></li>


    
  
    
    
	
<li>5: <a href="#pg-e584a5e6bb1de156a6ab3580a5451148">监控告警</a></li>


    
  
    
    
	
<li>6: <a href="#pg-b4db80f8234d7db0cbf16b40530478bd">指标列表</a></li>


    
  
    
    
	
<li>7: <a href="#pg-bfaeae9f961d15c2f4a30d7af548af0c">常见问题</a></li>


    
  

    </ul>


<div class="content">
      <blockquote>
<p>ETCD 是一个分布式的、可靠的键-值存储，用于存放系统中最为关键的配置数据。</p>
</blockquote>
<p>Pigsty 使用 <a href="https://etcd.io/"><strong>etcd</strong></a> 作为 <a href="https://patroni.readthedocs.io/en/latest/dcs_failsafe_mode.html"><strong>DCS</strong></a>：分布式配置存储（或称为分布式共识服务）。这对于 PostgreSQL 的高可用性与自动故障转移至关重要。</p>
<p>在安装 <a href="/zh/docs/etcd"><code>ETCD</code></a> 模块之前，需要安装 <a href="/zh/docs/node"><code>NODE</code></a> 模块将节点纳管。
此外，除非您决定使用外部的现有 etcd 集群，否则在部署任何 <a href="/zh/docs/pgsql"><code>PGSQL</code></a> 集群之前，你必须先安装 <a href="/zh/docs/etcd"><code>ETCD</code></a> 模块，因为 <code>patroni</code> 和 <code>vip-manager</code> 会依赖 etcd 模块实现高可用与L2 VIP绑定。</p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b3c7d25a96ae732f6a6be2d1fd4d5ec6">1 - 集群配置</h1>
    <div class="lead">根据需求场景选择合适的 Etcd 集群规模，并对外提供可靠的接入。</div>
	<p>在部署 Etcd 之前，你需要在 <a href="/zh/docs/setup/config">配置清单</a> 中定义一个 Etcd 集群，通常来说，你可以选择：</p>
<ul>
<li><a href="/zh/docs/etcd/config/#单节点">单节点</a>，没有高可用性，适用于开发、测试、演示，或者依赖外部S3备份进行PITR的无高可用单机部署。</li>
<li><a href="/zh/docs/etcd/config/#三节点">三节点</a>，具有基本的高可用性，可以容忍一个节点的故障，适用于中小规模的生产环境</li>
<li><a href="/zh/docs/etcd/config/#五节点">五节点</a>，具有更好的高可用性，可以容忍两个节点的故障，适用于大规模生产环境。</li>
</ul>
<p>偶数节点的 Etcd 集群没有意义，超过五节点的 Etcd 集群并不常见，因此通常使用的规格就是单节点，三节点，五节点。</p>
<hr>
<h2 id="单节点">单节点</h2>
<p>在 Pigsty 中，定义一个单例 Etcd 实例非常简单，只需要一行配置即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq: 1 } }, vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在 Pigsty 提供的所有单机配置模板中，都有这样一项，其中的占位 IP 地址：<code>10.10.10.10</code> 默认会被替换为当前管理节点的 IP。</p>
<p>除了 IP 地址外，这里唯一必要的参数是 <a href="/zh/docs/etcd/param/#etcd_seq"><code>etcd_seq</code></a> 和 <a href="/zh/docs/etcd/param/#etcd_cluster"><code>etcd_cluster</code></a>，它们会唯一标识每一个 Etcd 实例。</p>
<hr>
<h2 id="三节点">三节点</h2>
<p>三节点的 Etcd 集群最为常见，它可以容忍一个节点的故障，适用于中小规模的生产环境。</p>
<p>例如，Pigsty 的三节点模板：<a href="/zh/docs/conf/trio"><code>trio</code></a> 和 <a href="/zh/docs/conf/safe"><code>safe</code></a> 就使用了三节点的 Etcd 集群，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># etcd_seq （etcd实例号）是必须指定的身份参数</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 实例号是正整数，一般从 0 或 1 开始依次分配</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 实例号应当终生不可变，一旦分配就不再回收使用。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 集群层面的参数</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 默认情况下，etcd集群名就叫 etcd， 除非您想要部署多套 etcd 集群，否则不要改这个名字</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd_safeguard</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 是否打开 etcd 的防误删安全保险？ 在生产环境初始化完成后，可以考虑打开这个选项，避免误删。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd_clean</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># 在初始化过程中，是否强制移除现有的 etcd 实例？测试的时候可以打开，这样剧本就是真正幂等的。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="五节点">五节点</h2>
<p>五节点的 Etcd 集群可以容忍两个节点的故障，适用于大规模生产环境。</p>
<p>例如，Pigsty 的生产仿真模板：<a href="/zh/docs/conf/prod"><code>prod</code></a> 中就使用了一个五节点的 Etcd 集群：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.21 </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.22 </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.23 </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.24 </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.25 </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd    }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="使用etcd的服务">使用Etcd的服务</h2>
<p>目前使用 Etcd 的服务有：</p>
<ul>
<li>patroni: 用于 PostgreSQL 高可用，Etcd 的配置将填入 Patroni 配置文件。</li>
<li>vip-manager: 用于在 PostgreSQL 集群上绑定一个可选的 L2 VIP，会从 Etcd 中读取集群的领导者信息。</li>
</ul>
<p>当 etcd 集群的成员信息发生永久性变更时，您应当 <a href="/zh/docs/etcd/admin/#重载配置">重载相关服务的配置</a>，以确保服务能够正确访问 Etcd 集群。</p>
<p>在 <code>patroni</code> 上更新 etcd 端点引用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_conf                            <span style="color:#8f5902;font-style:italic"># 重新生成 patroni 配置</span>
</span></span><span style="display:flex;"><span>ansible all -f <span style="color:#0000cf;font-weight:bold">1</span> -b -a <span style="color:#4e9a06">&#39;systemctl reload patroni&#39;</span> <span style="color:#8f5902;font-style:italic"># 重新加载 patroni 配置</span>
</span></span></code></pre></div><p>在 <code>vip-manager</code> 上更新 etcd 端点引用（如果你正在使用 PGSQL L2 VIP 才需要执行此操作）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_vip_config                           <span style="color:#8f5902;font-style:italic"># 重新生成 vip-manager 配置</span>
</span></span><span style="display:flex;"><span>ansible all -f <span style="color:#0000cf;font-weight:bold">1</span> -b -a <span style="color:#4e9a06">&#39;systemctl restart vip-manager&#39;</span> <span style="color:#8f5902;font-style:italic"># 重启 vip-manager 以使用新配置 </span>
</span></span></code></pre></div><br>
<hr>
<br>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0bac52423651fcf771f1cdaad4f4c67b">2 - 参数列表</h1>
    <div class="lead">Etcd 模块提供了 10 个相关配置参数，用于定制所需的 Etcd 集群。</div>
	<p>ETCD 是一个分布式的、可靠的键-值存储，用于存放系统中最为关键的数据。在 Pigsty 中，etcd 作为高可用组件 Patroni 使用的 DCS，它对于 PG 的高可用非常重要。</p>
<p>Pigsty 为 etcd 集群使用一个硬编码的默认集群组名 <code>etcd</code>，它可以是一套现有的外部 etcd 集群，或者是默认由 Pigsty 使用 <a href="/zh/docs/etcd/playbook/#etcdyml">etcd.yml</a> 剧本部署创建的新etcd集群。</p>
<hr>
<h2 id="参数列表">参数列表</h2>
<p>ETCD 模块有 10 个相关参数：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">级别</th>
<th>注释</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="/zh/docs/etcd/param/#etcd_seq"><code>etcd_seq</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">I</td>
<td>etcd 实例标识符，必填</td>
</tr>
<tr>
<td><a href="/zh/docs/etcd/param/#etcd_cluster"><code>etcd_cluster</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>etcd 集群名，默认固定为 etcd</td>
</tr>
<tr>
<td><a href="/zh/docs/etcd/param/#etcd_safeguard"><code>etcd_safeguard</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">G/C/A</td>
<td>etcd 防误删保险，阻止清除正在运行的 etcd 实例？</td>
</tr>
<tr>
<td><a href="/zh/docs/etcd/param/#etcd_clean"><code>etcd_clean</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">G/C/A</td>
<td>etcd 清除指令：在初始化时清除现有的 etcd 实例？</td>
</tr>
<tr>
<td><a href="/zh/docs/etcd/param/#etcd_data"><code>etcd_data</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>etcd 数据目录，默认为 /data/etcd</td>
</tr>
<tr>
<td><a href="/zh/docs/etcd/param/#etcd_port"><code>etcd_port</code></a></td>
<td style="text-align:center">port</td>
<td style="text-align:center">C</td>
<td>etcd 客户端端口，默认为 2379</td>
</tr>
<tr>
<td><a href="/zh/docs/etcd/param/#etcd_peer_port"><code>etcd_peer_port</code></a></td>
<td style="text-align:center">port</td>
<td style="text-align:center">C</td>
<td>etcd 同伴端口，默认为 2380</td>
</tr>
<tr>
<td><a href="/zh/docs/etcd/param/#etcd_init"><code>etcd_init</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>etcd 初始集群状态，新建或已存在</td>
</tr>
<tr>
<td><a href="/zh/docs/etcd/param/#etcd_election_timeout"><code>etcd_election_timeout</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">C</td>
<td>etcd 选举超时，默认为 1000ms</td>
</tr>
<tr>
<td><a href="/zh/docs/etcd/param/#etcd_heartbeat_interval"><code>etcd_heartbeat_interval</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">C</td>
<td>etcd 心跳间隔，默认为 100ms</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#etcd_seq: 1                      # etcd 实例标识符，必填</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#etcd_cluster: etcd               # etcd 集群名，默认固定为 etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_safeguard</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># etcd 防误删保险，阻止清除正在运行的 etcd 实例？</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_clean</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># etcd 清除指令：在初始化时清除现有的 etcd 实例？</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/data/etcd            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># etcd 数据目录，默认为 /data/etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2379</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># etcd 客户端端口，默认为 2379</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_peer_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2380</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic"># etcd 同伴端口，默认为 2380</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_init</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># etcd 初始集群状态，新建或已存在</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_election_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># etcd 选举超时，默认为 1000ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_heartbeat_interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># etcd 心跳间隔，默认为 100ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="默认参数">默认参数</h2>
<p>Etcd 模块的默认参数定义于 <a href="https://github.com/Vonng/pigsty/blob/main/roles/etcd/defaults/main.yml"><code>roles/etcd/defaults/main.yml</code></a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#etcd_seq: 1                      # etcd instance identifier, explicitly required</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd               </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># etcd cluster &amp; group name, etcd by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_safeguard</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># prevent purging running etcd instance?</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_clean</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># purging existing etcd during initialization?</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/data/etcd            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># etcd data directory, /data/etcd by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2379</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># etcd client port, 2379 by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_peer_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2380</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic"># etcd peer port, 2380 by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_init</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># etcd initial cluster state, new or existing</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_election_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># etcd election timeout, 1000ms by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_heartbeat_interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># etcd heartbeat interval, 100ms by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="etcd_seq"><code>etcd_seq</code></h2>
<p>参数名称： <code>etcd_seq</code>， 类型： <code>int</code>， 层次：<code>I</code></p>
<p>etcd 实例标号， 这是必选参数，必须为每一个 etcd 实例指定一个唯一的标号。</p>
<p>以下是一个3节点etcd集群的示例，分配了 1 ～ 3 三个标号。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># dcs service for postgres/patroni ha consensus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 1 node for testing, 3 or 5 for production</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># etcd_seq required</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># assign from 1 ~ n</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># odd number please</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># cluster level parameter override roles/etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># mark etcd cluster name etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd_safeguard</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># safeguard against purging</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd_clean</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># purge etcd during init process</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="etcd_cluster"><code>etcd_cluster</code></h2>
<p>参数名称： <code>etcd_cluster</code>， 类型： <code>string</code>， 层次：<code>C</code></p>
<p>etcd 集群 &amp; 分组名称，默认值为硬编码值 <code>etcd</code>。</p>
<p>当您想要部署另外的 etcd 集群备用时，可以修改此参数并使用其他集群名。</p>
<hr>
<h2 id="etcd_safeguard"><code>etcd_safeguard</code></h2>
<p>参数名称： <code>etcd_safeguard</code>， 类型： <code>bool</code>， 层次：<code>G/C/A</code></p>
<p>安全保险参数，防止清除正在运行的etcd实例？默认值为 <code>false</code>。</p>
<p>如果启用安全保险，<a href="/zh/docs/etcd/playbook/#etcdyml">etcd.yml</a> 剧本不会清除正在运行的etcd实例。</p>
<hr>
<h2 id="etcd_clean"><code>etcd_clean</code></h2>
<p>参数名称： <code>etcd_clean</code>， 类型： <code>bool</code>， 层次：<code>G/C/A</code></p>
<p>在初始化时清除现有的 etcd ？默认值为<code>true</code>。</p>
<p>如果启用，<a href="/zh/docs/etcd/playbook/#etcdyml"><code>etcd.yml</code></a> 剧本将清除正在运行的 etcd 实例，这将使其成为一个真正幂等的剧本（总是抹除现有集群）。</p>
<p>但是如果启用了<a href="/zh/docs/etcd/param/#etcd_safeguard"><code>etcd_safeguard</code></a>，即使设置了此参数，剧本依然会在遇到运行中的 etcd 实例时中止，避免误删。</p>
<hr>
<h2 id="etcd_data"><code>etcd_data</code></h2>
<p>参数名称： <code>etcd_data</code>， 类型： <code>path</code>， 层次：<code>C</code></p>
<p>etcd 数据目录，默认为<code>/data/etcd</code> 。</p>
<hr>
<h2 id="etcd_port"><code>etcd_port</code></h2>
<p>参数名称： <code>etcd_port</code>， 类型： <code>port</code>， 层次：<code>C</code></p>
<p>etcd 客户端端口号，默认为<code>2379</code>。</p>
<hr>
<h2 id="etcd_peer_port"><code>etcd_peer_port</code></h2>
<p>参数名称： <code>etcd_peer_port</code>， 类型： <code>port</code>， 层次：<code>C</code></p>
<p>etcd peer 端口，默认为 <code>2380</code> 。</p>
<hr>
<h2 id="etcd_init"><code>etcd_init</code></h2>
<p>参数名称： <code>etcd_init</code>， 类型： <code>enum</code>， 层次：<code>C</code></p>
<p>etcd初始集群状态，可以是<code>new</code>或<code>existing</code>，默认值：<code>new</code>。</p>
<p>默认将创建一个独立的新etcd集群，当尝试向现有etcd集群 <a href="/zh/docs/etcd/admin/#添加成员"><strong>添加新成员</strong></a> 时，应当使用 <code>existing</code>。</p>
<hr>
<h2 id="etcd_election_timeout"><code>etcd_election_timeout</code></h2>
<p>参数名称： <code>etcd_election_timeout</code>， 类型： <code>int</code>， 层次：<code>C</code></p>
<p>etcd 选举超时，默认为 <code>1000</code> (毫秒)，也就是 1 秒。</p>
<hr>
<h2 id="etcd_heartbeat_interval"><code>etcd_heartbeat_interval</code></h2>
<p>参数名称： <code>etcd_heartbeat_interval</code>， 类型： <code>int</code>， 层次：<code>C</code></p>
<p>etcd心跳间隔，默认为 <code>100</code> (毫秒)。</p>
<br>
<hr>
<br>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f7e866452f3057b5647d06b72632819e">3 - 预置剧本</h1>
    <div class="lead">如何使用预置的 ansible 剧本来管理 Etcd 集群，常用管理命令速查。</div>
	<p>Etcd 模块提供了一个默认的剧本 <a href="/zh/docs/etcd/playbook/#etcdyml"><code>etcd.yml</code></a> ，用于安装 Etcd 集群。</p>
<hr>
<h2 id="etcdyml"><code>etcd.yml</code></h2>
<p>ETCD 模块提供了一个内置的 playbook： <a href="https://github.com/Vonng/pigsty/blob/main/etcd.yml"><code>etcd.yml</code></a>，用于安装 etcd 集群。但首先你需要 <a href="/zh/docs/etcd/config/">定义</a>它。</p>
<h3 id="etcdyml-1"><code>etcd.yml</code></h3>
<p>在 <a href="https://github.com/Vonng/pigsty/blob/main/etcd.yml"><code>etcd.yml</code></a> 中，提供了以下是可用的任务子集：</p>
<ul>
<li><code>etcd_assert</code>  ：生成 etcd 身份</li>
<li><code>etcd_install</code> ：安装 etcd rpm 包</li>
<li><code>etcd_clean</code>   ：清理现有的 etcd 实例
<ul>
<li><code>etcd_check</code> ：检查 etcd 实例是否在运行</li>
<li><code>etcd_purge</code> ：删除正在运行的 etcd 实例和数据</li>
</ul>
</li>
<li><code>etcd_dir</code>     ：创建 etcd 数据和配置目录</li>
<li><code>etcd_config</code>  ：生成 etcd 配置
<ul>
<li><code>etcd_conf</code>  ：生成 etcd 主配置</li>
<li><code>etcd_cert</code>  ：生成 etcd ssl 证书</li>
</ul>
</li>
<li><code>etcd_launch</code>  ：启动 etcd 服务</li>
<li><code>etcd_register</code> ： 将 etcd 注册到 prometheus</li>
</ul>
<p>Etcd 模块没有提供专门的卸载剧本，如果您需要卸载 Etcd，可以使用 <code>etcd_</code></p>
<p><a href="https://asciinema.org/a/566414"><img alt="asciicast" src="https://asciinema.org/a/566414.svg"></a></p>
<hr>
<h2 id="命令速查">命令速查</h2>
<p>Etcd 剧本与快捷方式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml                                      <span style="color:#8f5902;font-style:italic"># 初始化 etcd 集群 </span>
</span></span><span style="display:flex;"><span>./etcd.yml -t etcd_launch                       <span style="color:#8f5902;font-style:italic"># 重启整个 etcd 集群</span>
</span></span><span style="display:flex;"><span>./etcd.yml -t etcd_clean                        <span style="color:#8f5902;font-style:italic"># 移除整个集群，会检查现有实例是否存在，根据安全保险判断是否执行</span>
</span></span><span style="display:flex;"><span>./etcd.yml -t etcd_purge                        <span style="color:#8f5902;font-style:italic"># 强制移除整个集群，根本不管安全保险是否启用。</span>
</span></span><span style="display:flex;"><span>./etcd.yml -t etcd_conf                         <span style="color:#8f5902;font-style:italic"># 使用最新状态刷新 /etc/etcd/etcd.conf</span>
</span></span><span style="display:flex;"><span>./etcd.yml -l 10.10.10.12 -e <span style="color:#000">etcd_init</span><span style="color:#ce5c00;font-weight:bold">=</span>existing <span style="color:#8f5902;font-style:italic"># 扩容节点：一定要添加 existing 参数，命令行或配置文件均可</span>
</span></span><span style="display:flex;"><span>./etcd.yml -l 10.10.10.12 -t etcd_purge         <span style="color:#8f5902;font-style:italic"># 删除节点</span>
</span></span></code></pre></div><hr>
<h2 id="保护机制">保护机制</h2>
<p>出于防止误删的目的，Pigsty 的 ETCD 模块提供了防误删保险，由以下参数控制：</p>
<ul>
<li><a href="/zh/docs/etcd/param/#etcd_clean"><code>etcd_clean</code></a> 默认为 <code>true</code>，即，默认在初始化时清理现有实例。</li>
<li><a href="/zh/docs/etcd/param/#etcd_safeguard"><code>etcd_safeguard</code></a>: 默认为 <code>false</code>，即默认不打开防误删保护。</li>
</ul>
<p>默认配置使得您可以使用剧本重置 etcd 集群的状态，这对于开发、测试和生产环境中紧急重建 etcd 集群非常有用。</p>
<p>如果您希望在初始化时清理现有实例，请修改配置文件，显式关闭此保险，或者在执行时使用命令行参数 <code>-e etcd_clean=true</code> 进行覆盖。</p>
<p>如果您单纯希望清理现有实例，而不安装新实例，直接执行 <code>etcd_clean</code> 子任务即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml -l &lt;cls&gt; -e <span style="color:#000">etcd_clean</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> -t etcd_clean
</span></span></code></pre></div><p>如果您确定要摧毁这个 etcd 集群，更简单暴力直接的方式是：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml -l &lt;cls&gt; -t etcd_purge
</span></span></code></pre></div><hr>
<h2 id="执行演示">执行演示</h2>
<p><a href="https://asciinema.org/a/566415"><img alt="asciicast" src="https://asciinema.org/a/566415.svg"></a></p>
<br>
<hr>
<br>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e2a09cf50caf28a3c5a85194967a50bc">4 - 管理预案</h1>
    <div class="lead">Etcd 集群管理 SOP，创建，销毁，扩容，缩容的详细说明</div>
	<p>以下是一些常见的 etcd 管理任务 SOP（预案）：</p>
<ul>
<li><a href="/zh/docs/etcd/admin/#创建集群">创建集群</a>：如何初始化 etcd 集群？</li>
<li><a href="/zh/docs/etcd/admin/#销毁集群">销毁集群</a>：如何销毁 etcd 集群？</li>
<li><a href="/zh/docs/etcd/admin/#环境变量">环境变量</a>：如何配置 etcd 客户端，以访问 etcd 服务器集群？</li>
<li><a href="/zh/docs/etcd/admin/#重载配置">重载配置</a>：如何更新客户端使用的 etcd 服务器成员列表？</li>
<li><a href="/zh/docs/etcd/admin/#添加成员">添加成员</a>：如何向现有 etcd 集群添加新成员？</li>
<li><a href="/zh/docs/etcd/admin/#移除成员">移除成员</a>：如何从 etcd 集群移除老成员？</li>
</ul>
<p>更多问题请参考 <a href="/zh/docs/etcd/faq/">FAQ：ETCD</a>。</p>
<hr>
<h2 id="创建集群">创建集群</h2>
<p>要创建一个集群，首先需要在 <a href="/zh/docs/setup/config#%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95"><strong>配置清单</strong></a> 中定义 <code>etcd</code> 集群：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>执行 <a href="/zh/docs/etcd/playbook/#etcdyml"><code>etcd.yml</code></a> 剧本即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml  <span style="color:#8f5902;font-style:italic"># 初始化 etcd 集群 </span>
</span></span></code></pre></div><p>注意，Pigsty 的 etcd 模块提供了防误删保护机制。在默认配置下， <a href="/zh/docs/etcd/param/#etcd_clean"><code>etcd_clean</code></a> 配置打开，且 <a href="/zh/docs/etcd/param/#etcd_safeguard"><code>etcd_safeguard</code></a> 配置关闭，
那么执行此剧本的过程中即使遇到存活的etcd实例，也会强制移除，在这种情况下 <code>etcd.yml</code> 剧本是真正幂等的。这种配置对于开发，测试，以及生产环境紧急强制重建 etcd 集群来说是有用的。</p>
<p>对于生产环境已经初始化好的 etcd 集群，可以打开防误删保护，避免误删现有的 etcd 实例。此时当剧本检测到存活 etcd 实例时会主动中止，避免误删现有 etcd 实例，您可以使用命令行参数来覆盖这一行为。</p>
<hr>
<h2 id="销毁集群">销毁集群</h2>
<p>要销毁一个 etcd 集群，只需使用 <a href="/zh/docs/etcd/playbook/#etcdyml"><code>etcd.yml</code></a> 剧本的 <code>etcd_clean</code> 子任务即可。执行此命令前请务必三思！</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml -t etcd_clean  <span style="color:#8f5902;font-style:italic"># 移除整个集群，会检查现有实例是否存在，根据安全保险判断是否执行</span>
</span></span><span style="display:flex;"><span>./etcd.yml -t etcd_purge  <span style="color:#8f5902;font-style:italic"># 强制移除整个集群，根本不管安全保险是否启用。</span>
</span></span></code></pre></div><p>使用 <code>etcd_clean</code> 子任务会尊重 <a href="/zh/docs/etcd/param/#etcd_safeguard"><code>etcd_safeguard</code></a> 防误删保险的配置，使用 <code>etcd_purge</code> 子任务则会无视一切清理现有 etcd 集群。</p>
<hr>
<h2 id="环境变量">环境变量</h2>
<p>Pigsty 默认使用 etcd v3 API，以下是etcd客户端配置环境变量的示例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;etcdctl&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">em</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;etcdctl member&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ETCDCTL_ENDPOINTS</span><span style="color:#ce5c00;font-weight:bold">=</span>https://10.10.10.10:2379
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ETCDCTL_CACERT</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/pki/ca.crt
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ETCDCTL_CERT</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/server.crt
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ETCDCTL_KEY</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/server.key
</span></span></code></pre></div><p>配置好客户端环境变量后，你可以使用以下命令进行 etcd CRUD 操作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>e put a <span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#000;font-weight:bold">;</span> e get a<span style="color:#000;font-weight:bold">;</span> e del a <span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic"># V3 API</span>
</span></span></code></pre></div><hr>
<h2 id="重载配置">重载配置</h2>
<p>如果 etcd 集群的成员发生变化，我们需要刷新对 etcd 服务端点的引用，目前 Pigsty 中有四处 etcd 引用：</p>
<ul>
<li>现有 etcd 实例成员的配置文件</li>
<li>etcdctl 客户端环境变量（<a href="/zh/docs/node#infra%E8%8A%82%E7%82%B9">infra节点</a>上）</li>
<li>patroni DCS 端点配置（<a href="/zh/docs/node#pgsql%E8%8A%82%E7%82%B9">pgsql节点</a>上）</li>
<li>vip-manager DCS 端点配置（可选）</li>
</ul>
<p>要在现有etcd成员上刷新 etcd 配置文件 <code>/etc/etcd/etcd.conf</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml -t etcd_conf                           <span style="color:#8f5902;font-style:italic"># 使用最新状态刷新 /etc/etcd/etcd.conf</span>
</span></span><span style="display:flex;"><span>ansible etcd -f <span style="color:#0000cf;font-weight:bold">1</span> -b -a <span style="color:#4e9a06">&#39;systemctl restart etcd&#39;</span>  <span style="color:#8f5902;font-style:italic"># 可选操作：重启 etcd </span>
</span></span></code></pre></div><p>刷新 <code>etcdctl</code> 客户端环境变量：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./etcd.yml -t etcd_env                          <span style="color:#8f5902;font-style:italic"># 刷新 /etc/profile.d/etcdctl.sh （管理节点）</span>
</span></span></code></pre></div><p>在 <code>patroni</code> 上更新 etcd 端点引用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_conf                            <span style="color:#8f5902;font-style:italic"># 重新生成 patroni 配置</span>
</span></span><span style="display:flex;"><span>ansible all -f <span style="color:#0000cf;font-weight:bold">1</span> -b -a <span style="color:#4e9a06">&#39;systemctl reload patroni&#39;</span> <span style="color:#8f5902;font-style:italic"># 重新加载 patroni 配置</span>
</span></span></code></pre></div><p>在 <code>vip-manager</code> 上更新 etcd 端点引用（如果你正在使用 PGSQL L2 VIP 才需要执行此操作）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_vip_config                           <span style="color:#8f5902;font-style:italic"># 重新生成 vip-manager 配置</span>
</span></span><span style="display:flex;"><span>ansible all -f <span style="color:#0000cf;font-weight:bold">1</span> -b -a <span style="color:#4e9a06">&#39;systemctl restart vip-manager&#39;</span> <span style="color:#8f5902;font-style:italic"># 重启 vip-manager 以使用新配置 </span>
</span></span></code></pre></div><hr>
<h2 id="添加成员">添加成员</h2>
<p>ETCD 参考: <a href="https://etcd.io/docs/v3.5/op-guide/runtime-configuration/#add-a-new-member">添加成员</a></p>
<p>向现有的 etcd 集群添加新成员通常需要五个步骤：</p>
<p><strong>简短版本</strong></p>
<ol>
<li>执行 <code>etcdctl member add</code> 命令，通知现有集群即将有新成员加入（使用学习者模式）</li>
<li>更新配置清单，将新实例写入配置文件 <code>etcd</code> 组中。</li>
<li>使用 <code>etcd_init=existing</code> 的方式初始化新的 etcd 实例，使其加入现有集群而不是创建一个新集群（<strong>非常重要</strong>）</li>
<li>将新成员从学习者提升为追随者，正式成为集群中具有投票权的一员。</li>
<li><a href="/zh/docs/etcd/admin/#重载配置">重载配置</a> 以更新客户端使用的 etcd 服务端点。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl member add &lt;etcd-?&gt; --learner<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --peer-urls<span style="color:#ce5c00;font-weight:bold">=</span>https://&lt;new_ins_ip&gt;:2380  <span style="color:#8f5902;font-style:italic"># 通知集群</span>
</span></span><span style="display:flex;"><span>./etcd.yml -l &lt;new_ins_ip&gt; -e <span style="color:#000">etcd_init</span><span style="color:#ce5c00;font-weight:bold">=</span>existing                                  <span style="color:#8f5902;font-style:italic"># 初始化新实例</span>
</span></span><span style="display:flex;"><span>etcdctl member promote &lt;new_ins_server_id&gt;                                        <span style="color:#8f5902;font-style:italic"># 提升实例为追随者</span>
</span></span></code></pre></div><details><summary>详细步骤：向etcd集群添加成员</summary>
<p>下面是具体操作的详细细节，让我们从一个单实例 etcd 集群开始：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- 集群中原本存在的唯一实例</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- 将此新成员定义添加到清单中</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>使用 <code>etcd member add</code> 向现有 etcd 集群宣告新的学习者实例 <code>etcd-2</code> 即将到来：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ etcdctl member add etcd-2 --learner<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --peer-urls<span style="color:#ce5c00;font-weight:bold">=</span>https://10.10.10.11:2380
</span></span><span style="display:flex;"><span>Member 33631ba6ced84cf8 added to cluster 6646fbcf5debc68f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;etcd-2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_INITIAL_CLUSTER</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;etcd-2=https://10.10.10.11:2380,etcd-1=https://10.10.10.10:2380&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://10.10.10.11:2380&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_INITIAL_CLUSTER_STATE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;existing&#34;</span>
</span></span></code></pre></div><p>使用 <code>etcdctl member list</code>（或 <code>em list</code>）检查成员列表，我们可以看到一个 <code>unstarted</code> 新成员：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>33631ba6ced84cf8, unstarted, , https://10.10.10.11:2380, , <span style="color:#204a87">true</span>       <span style="color:#8f5902;font-style:italic"># 这里有一个未启动的新成员</span>
</span></span><span style="display:flex;"><span>429ee12c7fbab5c1, started, etcd-1, https://10.10.10.10:2380, https://10.10.10.10:2379, <span style="color:#204a87">false</span>
</span></span></code></pre></div><p>接下来使用 <code>etcd.yml</code> 剧本初始化新的 etcd 实例 <code>etcd-2</code>，完成后，我们可以看到新成员已经启动：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./etcd.yml -l 10.10.10.11 -e <span style="color:#000">etcd_init</span><span style="color:#ce5c00;font-weight:bold">=</span>existing    <span style="color:#8f5902;font-style:italic"># 一定要添加 existing 参数，命令行或配置文件均可</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>33631ba6ced84cf8, started, etcd-2, https://10.10.10.11:2380, https://10.10.10.11:2379, <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>429ee12c7fbab5c1, started, etcd-1, https://10.10.10.10:2380, https://10.10.10.10:2379, <span style="color:#204a87">false</span>
</span></span></code></pre></div><p>新成员初始化完成并稳定运行后，可以将新成员从学习者提升为追随者：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ etcdctl member promote 33631ba6ced84cf8   <span style="color:#8f5902;font-style:italic"># 将学习者提升为追随者，这里需要使用 etcd 实例的 ID</span>
</span></span><span style="display:flex;"><span>Member 33631ba6ced84cf8 promoted in cluster 6646fbcf5debc68f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ em list                <span style="color:#8f5902;font-style:italic"># check again, the new member is started</span>
</span></span><span style="display:flex;"><span>33631ba6ced84cf8, started, etcd-2, https://10.10.10.11:2380, https://10.10.10.11:2379, <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>429ee12c7fbab5c1, started, etcd-1, https://10.10.10.10:2380, https://10.10.10.10:2379, fals
</span></span></code></pre></div><p>新成员添加完成，请不要忘记 <a href="/zh/docs/etcd/admin/#重载配置">重载配置</a> ，让所有客户端也知道新成员的存在。</p>
<p>重复以上步骤，可以添加更多成员。记住，生产环境中至少要使用 3 个成员。</p>
</details>
<hr>
<h2 id="移除成员">移除成员</h2>
<p>要从 etcd 集群中删除一个成员实例，通常需要以下三个步骤：</p>
<ol>
<li>从配置清单中注释/屏蔽/删除该实例，并<a href="/zh/docs/etcd/admin/#重载配置">重载配置</a>，让客户端不再使用该实例。</li>
<li>使用 <code>etcdctl member remove &lt;server_id&gt;</code> 命令将它从集群中踢除</li>
<li>将该实例临时添加回配置清单，使用剧本彻底移除下线该实例，然后永久从配置中删除</li>
</ol>
<details><summary>详细步骤：从etcd集群移除成员</summary>
<p>让我们以一个 3 节点的 etcd 集群为例，从中移除 3 号实例。</p>
<p>为了刷新配置，您需要 <strong>注释</strong> 要待删除的成员，然后 <a href="/zh/docs/etcd/admin/#重载配置">重载配置</a>，让所有客户端都不要再使用此实例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># &lt;---- 首先注释掉这个成员，然后重载配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>然后，您需要使用 <code>etcdctl member remove</code> 命令，将它从集群中踢出去：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ etcdctl member list 
</span></span><span style="display:flex;"><span>429ee12c7fbab5c1, started, etcd-1, https://10.10.10.10:2380, https://10.10.10.10:2379, <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>33631ba6ced84cf8, started, etcd-2, https://10.10.10.11:2380, https://10.10.10.11:2379, <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>93fcf23b220473fb, started, etcd-3, https://10.10.10.12:2380, https://10.10.10.12:2379, <span style="color:#204a87">false</span>  <span style="color:#8f5902;font-style:italic"># &lt;--- 移除这个</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ etcdctl member remove 93fcf23b220473fb  <span style="color:#8f5902;font-style:italic"># kick it from cluster</span>
</span></span><span style="display:flex;"><span>Member 93fcf23b220473fb removed from cluster 6646fbcf5debc68f
</span></span></code></pre></div><p>最后，您要将该成员临时添加回配置清单中以便运行下线任务，将实例彻底关停移除。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml -t etcd_purge -l 10.10.10.12   <span style="color:#8f5902;font-style:italic"># 下线该实例（注意：执行这个命令要求这个实例的定义还在配置清单里）</span>
</span></span></code></pre></div><p>执行完毕后，您可以将其从配置清单中永久删除，移除成员至此完成。</p>
<p>重复以上步骤，可以移除更多成员，与<a href="/zh/docs/etcd/admin/#添加成员">添加成员</a>配合使用，可以对 etcd 集群进行滚动升级搬迁。</p>
</details>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e584a5e6bb1de156a6ab3580a5451148">5 - 监控告警</h1>
    <div class="lead">如何监控 Etcd？有哪些告警规则值得关注？</div>
	<hr>
<h2 id="监控面板">监控面板</h2>
<p>ETCD 模块提供了一个监控面板：Etcd Overview。</p>
<h3 id="etcd-overview-dashboard">ETCD Overview Dashboard</h3>
<p><a href="https://demo.pigsty.cc/d/etcd-overview">ETCD Overview</a>：ETCD 集群概览</p>
<p>这个监控面板提供了 ETCD 状态的关键信息：最值得关注的是 ETCD Aliveness，它显示了 ETCD 集群整体的服务状态。</p>
<p>红色的条带标识着实例不可用的时间段，而底下蓝灰色的条带标识着整个集群处于不可用的时间段。</p>
<p><a href="https://demo.pigsty.cc/d/etcd-overview"><img alt="etcd-overview.jpg" src="/img/dashboard/etcd-overview.jpg"></a></p>
<hr>
<h2 id="告警规则">告警规则</h2>
<p>Pigsty 针对 Etcd 提供了以下五条预置告警规则，定义于 <a href="https://github.com/Vonng/pigsty/blob/main/files/prometheus/rules/etcd.yml"><code>files/prometheus/rules/etcd.yml</code></a></p>
<ul>
<li><code>EtcdServerDown</code>：Etcd 节点宕机，严重警报</li>
<li><code>EtcdNoLeader</code>：Etcd 集群没有领导者，严重警报</li>
<li><code>EtcdQuotaFull</code>：Etcd 配额使用超过 90%，警告</li>
<li><code>EtcdNetworkPeerRTSlow</code>：Etcd 网络时延缓慢，提醒</li>
<li><code>EtcdWalFsyncSlow</code>：Etcd 磁盘刷盘缓慢，提醒</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#==============================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                         Aliveness                            #</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#==============================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># etcd server instance down</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">alert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EtcdServerDown</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd_up &lt; 1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">level: 0, severity: CRIT, category</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">summary</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;CRIT EtcdServerDown {{ $labels.ins }}@{{ $labels.instance }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">description</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      etcd_up[ins={{ $labels.ins }}, instance={{ $labels.instance }}] = {{ $value }} &lt; 1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      http://g.pigsty/d/etcd-overview</span><span style="color:#f8f8f8;text-decoration:underline">      
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#==============================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                         Error                                #</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#==============================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Etcd no Leader triggers a P0 alert immediately</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># if dcs_failsafe mode is not enabled, this may lead to global outage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">alert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EtcdNoLeader</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">min(etcd_server_has_leader) by (cls) &lt; 1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">15s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">level: 0, severity: CRIT, category</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">summary</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;CRIT EtcdNoLeader: {{ $labels.cls }} {{ $value }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">description</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      etcd_server_has_leader[cls={{ $labels.cls }}] = {{ $value }} &lt; 1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      http://g.pigsty/d/etcd-overview?from=now-5m&amp;to=now&amp;var-cls={{$labels.cls}}</span><span style="color:#f8f8f8;text-decoration:underline">      
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#==============================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                        Saturation                            #</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#==============================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">alert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EtcdQuotaFull</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd:cls:quota_usage &gt; 0.90</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">level: 1, severity: WARN, category</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">summary</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;WARN EtcdQuotaFull: {{ $labels.cls }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">description</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      etcd:cls:quota_usage[cls={{ $labels.cls }}] = {{ $value | printf &#34;%.3f&#34; }} &gt; 90%</span><span style="color:#f8f8f8;text-decoration:underline">      
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#==============================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                         Latency                              #</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#==============================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># etcd network peer rt p95 &gt; 200ms for 1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">alert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EtcdNetworkPeerRTSlow</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd:ins:network_peer_rt_p95_5m &gt; 0.200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">level: 2, severity: INFO, category</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">summary</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;INFO EtcdNetworkPeerRTSlow: {{ $labels.cls }} {{ $labels.ins }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">description</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      etcd:ins:network_peer_rt_p95_5m[cls={{ $labels.cls }}, ins={{ $labels.ins }}] = {{ $value }} &gt; 200ms
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      http://g.pigsty/d/etcd-instance?from=now-10m&amp;to=now&amp;var-cls={{ $labels.cls }}</span><span style="color:#f8f8f8;text-decoration:underline">      
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Etcd wal fsync rt p95 &gt; 50ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">alert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EtcdWalFsyncSlow</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd:ins:wal_fsync_rt_p95_5m &gt; 0.050</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">level: 2, severity: INFO, category</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">summary</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;INFO EtcdWalFsyncSlow: {{ $labels.cls }} {{ $labels.ins }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">description</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      etcd:ins:wal_fsync_rt_p95_5m[cls={{ $labels.cls }}, ins={{ $labels.ins }}] = {{ $value }} &gt; 50ms
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      http://g.pigsty/d/etcd-instance?from=now-10m&amp;to=now&amp;var-cls={{ $labels.cls }}</span><span style="color:#f8f8f8;text-decoration:underline">      
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b4db80f8234d7db0cbf16b40530478bd">6 - 指标列表</h1>
    <div class="lead">Pigsty ETCD 模块提供的完整监控指标列表与释义</div>
	<p><a href="/zh/docs/etcd"><strong><code>ETCD</code></strong></a> 模块包含有 177 类可用监控指标。</p>
<table>
<thead>
<tr>
<th>Metric Name</th>
<th>Type</th>
<th>Labels</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>etcd:ins:backend_commit_rt_p99_5m</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd:ins:disk_fsync_rt_p99_5m</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd:ins:network_peer_rt_p99_1m</td>
<td>Unknown</td>
<td><code>cls</code>, <code>To</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_cluster_version</td>
<td>gauge</td>
<td><code>cls</code>, <code>cluster_version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Which version is running. 1 for &lsquo;cluster_version&rsquo; label with current cluster version</td>
</tr>
<tr>
<td>etcd_debugging_auth_revision</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The current revision of auth store.</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_rebalance_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_rebalance_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_spill_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_spill_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_spill_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_write_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_write_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_write_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_lease_granted_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of granted leases.</td>
</tr>
<tr>
<td>etcd_debugging_lease_renewed_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The number of renewed leases seen by the leader.</td>
</tr>
<tr>
<td>etcd_debugging_lease_revoked_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of revoked leases.</td>
</tr>
<tr>
<td>etcd_debugging_lease_ttl_total_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_lease_ttl_total_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_lease_ttl_total_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_compact_revision</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The revision of the last compaction in store.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_current_revision</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The current revision of store.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_db_compaction_keys_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of db keys compacted.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_db_compaction_last</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The unix time of the last db compaction. Resets to 0 on start.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_db_compaction_pause_duration_milliseconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_db_compaction_pause_duration_milliseconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_db_compaction_pause_duration_milliseconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_db_compaction_total_duration_milliseconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_db_compaction_total_duration_milliseconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_db_compaction_total_duration_milliseconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_events_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of events sent by this member.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_index_compaction_pause_duration_milliseconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_index_compaction_pause_duration_milliseconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_index_compaction_pause_duration_milliseconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_keys_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of keys.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_pending_events_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of pending events to be sent.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_range_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of ranges seen by this member.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_slow_watcher_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of unsynced slow watchers.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_total_put_size_in_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total size of put kv pairs seen by this member.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_watch_stream_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of watch streams.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_watcher_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of watchers.</td>
</tr>
<tr>
<td>etcd_debugging_server_lease_expired_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of expired leases.</td>
</tr>
<tr>
<td>etcd_debugging_snap_save_marshalling_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_snap_save_marshalling_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_snap_save_marshalling_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_snap_save_total_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_snap_save_total_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_snap_save_total_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_store_expires_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of expired keys.</td>
</tr>
<tr>
<td>etcd_debugging_store_reads_total</td>
<td>counter</td>
<td><code>cls</code>, <code>action</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of reads action by (get/getRecursive), local to this member.</td>
</tr>
<tr>
<td>etcd_debugging_store_watch_requests_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of incoming watch requests (new or reestablished).</td>
</tr>
<tr>
<td>etcd_debugging_store_watchers</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Count of currently active watchers.</td>
</tr>
<tr>
<td>etcd_debugging_store_writes_total</td>
<td>counter</td>
<td><code>cls</code>, <code>action</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of writes (e.g. set/compareAndDelete) seen by this member.</td>
</tr>
<tr>
<td>etcd_disk_backend_commit_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_backend_commit_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_backend_commit_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_backend_defrag_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_backend_defrag_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_backend_defrag_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_backend_snapshot_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_backend_snapshot_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_backend_snapshot_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_defrag_inflight</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Whether or not defrag is active on the member. 1 means active, 0 means not.</td>
</tr>
<tr>
<td>etcd_disk_wal_fsync_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_wal_fsync_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_wal_fsync_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_wal_write_bytes_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of bytes written in WAL.</td>
</tr>
<tr>
<td>etcd_grpc_proxy_cache_hits_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of cache hits</td>
</tr>
<tr>
<td>etcd_grpc_proxy_cache_keys_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of keys/ranges cached</td>
</tr>
<tr>
<td>etcd_grpc_proxy_cache_misses_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of cache misses</td>
</tr>
<tr>
<td>etcd_grpc_proxy_events_coalescing_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of events coalescing</td>
</tr>
<tr>
<td>etcd_grpc_proxy_watchers_coalescing_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of current watchers coalescing</td>
</tr>
<tr>
<td>etcd_mvcc_db_open_read_transactions</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The number of currently open read transactions</td>
</tr>
<tr>
<td>etcd_mvcc_db_total_size_in_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total size of the underlying database physically allocated in bytes.</td>
</tr>
<tr>
<td>etcd_mvcc_db_total_size_in_use_in_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total size of the underlying database logically in use in bytes.</td>
</tr>
<tr>
<td>etcd_mvcc_delete_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of deletes seen by this member.</td>
</tr>
<tr>
<td>etcd_mvcc_hash_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_mvcc_hash_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_mvcc_hash_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_mvcc_hash_rev_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_mvcc_hash_rev_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_mvcc_hash_rev_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_mvcc_put_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of puts seen by this member.</td>
</tr>
<tr>
<td>etcd_mvcc_range_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of ranges seen by this member.</td>
</tr>
<tr>
<td>etcd_mvcc_txn_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of txns seen by this member.</td>
</tr>
<tr>
<td>etcd_network_active_peers</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>Local</code>, <code>instance</code>, <code>job</code>, <code>ip</code>, <code>Remote</code></td>
<td>The current number of active peer connections.</td>
</tr>
<tr>
<td>etcd_network_client_grpc_received_bytes_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of bytes received from grpc clients.</td>
</tr>
<tr>
<td>etcd_network_client_grpc_sent_bytes_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of bytes sent to grpc clients.</td>
</tr>
<tr>
<td>etcd_network_peer_received_bytes_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code>, <code>From</code></td>
<td>The total number of bytes received from peers.</td>
</tr>
<tr>
<td>etcd_network_peer_round_trip_time_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>To</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_network_peer_round_trip_time_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>To</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_network_peer_round_trip_time_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>To</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_network_peer_sent_bytes_total</td>
<td>counter</td>
<td><code>cls</code>, <code>To</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of bytes sent to peers.</td>
</tr>
<tr>
<td>etcd_server_apply_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>success</code>, <code>ip</code>, <code>op</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_server_apply_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>success</code>, <code>ip</code>, <code>op</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_server_apply_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>success</code>, <code>ip</code>, <code>op</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_server_client_requests_total</td>
<td>counter</td>
<td><code>client_api_version</code>, <code>cls</code>, <code>ins</code>, <code>instance</code>, <code>type</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of client requests per client version.</td>
</tr>
<tr>
<td>etcd_server_go_version</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>server_go_version</code>, <code>ip</code></td>
<td>Which Go version server is running with. 1 for &lsquo;server_go_version&rsquo; label with current version.</td>
</tr>
<tr>
<td>etcd_server_has_leader</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Whether or not a leader exists. 1 is existence, 0 is not.</td>
</tr>
<tr>
<td>etcd_server_health_failures</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of failed health checks</td>
</tr>
<tr>
<td>etcd_server_health_success</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of successful health checks</td>
</tr>
<tr>
<td>etcd_server_heartbeat_send_failures_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of leader heartbeat send failures (likely overloaded from slow disk).</td>
</tr>
<tr>
<td>etcd_server_id</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>server_id</code>, <code>ip</code></td>
<td>Server or member ID in hexadecimal format. 1 for &lsquo;server_id&rsquo; label with current ID.</td>
</tr>
<tr>
<td>etcd_server_is_leader</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Whether or not this member is a leader. 1 if is, 0 otherwise.</td>
</tr>
<tr>
<td>etcd_server_is_learner</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Whether or not this member is a learner. 1 if is, 0 otherwise.</td>
</tr>
<tr>
<td>etcd_server_leader_changes_seen_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The number of leader changes seen.</td>
</tr>
<tr>
<td>etcd_server_learner_promote_successes</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of successful learner promotions while this member is leader.</td>
</tr>
<tr>
<td>etcd_server_proposals_applied_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of consensus proposals applied.</td>
</tr>
<tr>
<td>etcd_server_proposals_committed_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of consensus proposals committed.</td>
</tr>
<tr>
<td>etcd_server_proposals_failed_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of failed proposals seen.</td>
</tr>
<tr>
<td>etcd_server_proposals_pending</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The current number of pending proposals to commit.</td>
</tr>
<tr>
<td>etcd_server_quota_backend_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Current backend storage quota size in bytes.</td>
</tr>
<tr>
<td>etcd_server_read_indexes_failed_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of failed read indexes seen.</td>
</tr>
<tr>
<td>etcd_server_slow_apply_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of slow apply requests (likely overloaded from slow disk).</td>
</tr>
<tr>
<td>etcd_server_slow_read_indexes_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of pending read indexes not in sync with leader&rsquo;s or timed out read index requests.</td>
</tr>
<tr>
<td>etcd_server_snapshot_apply_in_progress_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>1 if the server is applying the incoming snapshot. 0 if none.</td>
</tr>
<tr>
<td>etcd_server_version</td>
<td>gauge</td>
<td><code>cls</code>, <code>server_version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Which version is running. 1 for &lsquo;server_version&rsquo; label with current version.</td>
</tr>
<tr>
<td>etcd_snap_db_fsync_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_snap_db_fsync_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_snap_db_fsync_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_snap_db_save_total_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_snap_db_save_total_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_snap_db_save_total_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_snap_fsync_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_snap_fsync_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_snap_fsync_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_up</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>go_gc_duration_seconds</td>
<td>summary</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>quantile</code>, <code>job</code>, <code>ip</code></td>
<td>A summary of the pause duration of garbage collection cycles.</td>
</tr>
<tr>
<td>go_gc_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>go_gc_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>go_goroutines</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of goroutines that currently exist.</td>
</tr>
<tr>
<td>go_info</td>
<td>gauge</td>
<td><code>cls</code>, <code>version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Information about the Go environment.</td>
</tr>
<tr>
<td>go_memstats_alloc_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes allocated and still in use.</td>
</tr>
<tr>
<td>go_memstats_alloc_bytes_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of bytes allocated, even if freed.</td>
</tr>
<tr>
<td>go_memstats_buck_hash_sys_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes used by the profiling bucket hash table.</td>
</tr>
<tr>
<td>go_memstats_frees_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of frees.</td>
</tr>
<tr>
<td>go_memstats_gc_cpu_fraction</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The fraction of this program&rsquo;s available CPU time used by the GC since the program started.</td>
</tr>
<tr>
<td>go_memstats_gc_sys_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes used for garbage collection system metadata.</td>
</tr>
<tr>
<td>go_memstats_heap_alloc_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of heap bytes allocated and still in use.</td>
</tr>
<tr>
<td>go_memstats_heap_idle_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of heap bytes waiting to be used.</td>
</tr>
<tr>
<td>go_memstats_heap_inuse_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of heap bytes that are in use.</td>
</tr>
<tr>
<td>go_memstats_heap_objects</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of allocated objects.</td>
</tr>
<tr>
<td>go_memstats_heap_released_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of heap bytes released to OS.</td>
</tr>
<tr>
<td>go_memstats_heap_sys_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of heap bytes obtained from system.</td>
</tr>
<tr>
<td>go_memstats_last_gc_time_seconds</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of seconds since 1970 of last garbage collection.</td>
</tr>
<tr>
<td>go_memstats_lookups_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of pointer lookups.</td>
</tr>
<tr>
<td>go_memstats_mallocs_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of mallocs.</td>
</tr>
<tr>
<td>go_memstats_mcache_inuse_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes in use by mcache structures.</td>
</tr>
<tr>
<td>go_memstats_mcache_sys_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes used for mcache structures obtained from system.</td>
</tr>
<tr>
<td>go_memstats_mspan_inuse_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes in use by mspan structures.</td>
</tr>
<tr>
<td>go_memstats_mspan_sys_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes used for mspan structures obtained from system.</td>
</tr>
<tr>
<td>go_memstats_next_gc_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of heap bytes when next garbage collection will take place.</td>
</tr>
<tr>
<td>go_memstats_other_sys_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes used for other system allocations.</td>
</tr>
<tr>
<td>go_memstats_stack_inuse_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes in use by the stack allocator.</td>
</tr>
<tr>
<td>go_memstats_stack_sys_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes obtained from system for stack allocator.</td>
</tr>
<tr>
<td>go_memstats_sys_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes obtained from system.</td>
</tr>
<tr>
<td>go_threads</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of OS threads created.</td>
</tr>
<tr>
<td>grpc_server_handled_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>grpc_code</code>, <code>job</code>, <code>grpc_method</code>, <code>grpc_type</code>, <code>ip</code>, <code>grpc_service</code></td>
<td>Total number of RPCs completed on the server, regardless of success or failure.</td>
</tr>
<tr>
<td>grpc_server_msg_received_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>grpc_type</code>, <code>grpc_method</code>, <code>ip</code>, <code>grpc_service</code></td>
<td>Total number of RPC stream messages received on the server.</td>
</tr>
<tr>
<td>grpc_server_msg_sent_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>grpc_type</code>, <code>grpc_method</code>, <code>ip</code>, <code>grpc_service</code></td>
<td>Total number of gRPC stream messages sent by the server.</td>
</tr>
<tr>
<td>grpc_server_started_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>grpc_type</code>, <code>grpc_method</code>, <code>ip</code>, <code>grpc_service</code></td>
<td>Total number of RPCs started on the server.</td>
</tr>
<tr>
<td>os_fd_limit</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The file descriptor limit.</td>
</tr>
<tr>
<td>os_fd_used</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The number of used file descriptors.</td>
</tr>
<tr>
<td>process_cpu_seconds_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total user and system CPU time spent in seconds.</td>
</tr>
<tr>
<td>process_max_fds</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Maximum number of open file descriptors.</td>
</tr>
<tr>
<td>process_open_fds</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of open file descriptors.</td>
</tr>
<tr>
<td>process_resident_memory_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Resident memory size in bytes.</td>
</tr>
<tr>
<td>process_start_time_seconds</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Start time of the process since unix epoch in seconds.</td>
</tr>
<tr>
<td>process_virtual_memory_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Virtual memory size in bytes.</td>
</tr>
<tr>
<td>process_virtual_memory_max_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Maximum amount of virtual memory available in bytes.</td>
</tr>
<tr>
<td>promhttp_metric_handler_requests_in_flight</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Current number of scrapes being served.</td>
</tr>
<tr>
<td>promhttp_metric_handler_requests_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code>, <code>code</code></td>
<td>Total number of scrapes by HTTP status code.</td>
</tr>
<tr>
<td>scrape_duration_seconds</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>scrape_samples_post_metric_relabeling</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>scrape_samples_scraped</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>scrape_series_added</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>up</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bfaeae9f961d15c2f4a30d7af548af0c">7 - 常见问题</h1>
    <div class="lead">Pigsty etcd 模块常见问题答疑</div>
	<hr>
<h2 id="etcd集群起什么作用">etcd集群起什么作用？</h2>
<p>etcd 是一个分布式的、可靠的键-值存储，用于存放系统中最为关键的数据，Pigsty 使用 etcd 作为 Patroni 的 DCS（分布式配置存储）服务，用于存储 PostgreSQL 集群的高可用状态信息。</p>
<p>Patroni 将通过 etcd，实现集群故障检测、自动故障转移、主从切换，集群配置管理等功能。</p>
<p>etcd 对于 PostgreSQL 集群的高可用至关重要，而 etcd 本身的可用性与容灾，是通过使用多个分布式的节点来保证的。</p>
<hr>
<h2 id="etcd集群使用多大规模合适">etcd集群使用多大规模合适？</h2>
<p>如果超过集群成员数一半（包括正好一半）的 etcd 实例不可用，那么 etcd 集群将进入不可用状态，拒绝对外提供服务。</p>
<p>例如：使用 3 节点的 etcd 集群允许最多一个节点宕机，而其他两个节点仍然可以正常工作；而使用 5 节点的 etcd 集群则可以容忍 2 节点失效。</p>
<p>请注意，etcd 集群中的 <strong>学习者</strong>（Learner）实例不计入成员数，因此在 3 节点 etcd 集群中，如果有一个学习者实例，那么实际上成员数量为 2，不能容忍任一节点失效。</p>
<p>在生产环境中，我们建议使用奇数个 etcd 实例，对于生产环境，建议使用 3 节点或 5 节点的 etcd 集群部署以确保足够的可靠性。</p>
<hr>
<h2 id="etcd集群不可用会有什么影响">etcd集群不可用会有什么影响？</h2>
<p>如果 etcd 集群不可用，那么会影响 PostgreSQL 的管控平面，但不会影响数据平面 —— 现有的 PostgreSQL 集群将继续运行，但通过 Patroni 进行的管理操作将无法执行。</p>
<p>etcd 故障期间，PostgreSQL 高可用将无法实现自动故障转移，您也无法使用 <code>patronictl</code> 对 PostgreSQL 集群发起管理操作，例如修改配置，执行手动故障转移等。
通过 Ansible 发起的管理命令不受 etcd 故障影响：例如创建数据库，创建用户，刷新 HBA 与 Service 配置等，etcd 故障期间，您依然可以直接操作 PostgreSQL 集群来实现这些功能。</p>
<p>请注意，以上描述的行为仅适用于较新版本的 Patroni (&gt;=3.0，对应 Pigsty &gt;= 2.0)。如果您使用的是较老版本的 Patroni (&lt;3.0，对应 Pigsty 版本为 1.x)，则 etcd / consul 故障会引发极为严重的全局性影响：
所有 PostgreSQL 集群将发生降级：主库将降级为从库，拒绝写请求，etcd 故障将放大为全局性 PostgreSQL 故障。在 Patroni 3.0 引入 DCS Failsafe 功能后，这种情况得到了显著改善。</p>
<hr>
<h2 id="etcd集群中存储着什么数据">etcd集群中存储着什么数据？</h2>
<p>在 Pigsty 中，etcd 仅用于 PostgreSQL 高可用，并不会用于存储任何其他配置或状态数据。</p>
<p>而 PG 高可用组件 Patroni 会自动生成并管理 etcd 中的数据，当这些数据在 etcd 中丢失时，Patroni 会自动重建。</p>
<p>因此默认情况下，Pigsty 中的 <strong>etcd</strong> 可以视作 “无状态服务”，可以进行销毁与重建，这为维护工作带来了极大的便利。</p>
<p>如果您将 etcd 用于其他目的，例如作为 Kubernetes 的元数据存储，或自行存储其他数据，那么您需要自行备份 etcd 数据，并在 etcd 集群恢复后进行数据恢复。</p>
<hr>
<h2 id="如何从etcd故障中恢复">如何从etcd故障中恢复？</h2>
<p>因为 Pigsty 中的 etcd 只用于 PostgreSQL 高可用，本质上是可销毁、可重建的 “无状态服务”，因此在出现故障时，您可以通过 “重启” / “重置” 来进行快速止血。</p>
<p>要 <strong>重启</strong> etcd 集群，您可以使用以下 Ansible 命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml -t etcd_launch
</span></span></code></pre></div><p>要 <strong>重置</strong> etcd 集群，您可以直接执行以下剧本，实现覆盖抹除式重装：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml
</span></span></code></pre></div><p>如果您自行使用 etcd 存储了其他数据，那么通常需要备份 etcd 数据，并在 etcd 集群恢复后进行数据恢复。</p>
<hr>
<h2 id="维护etcd有什么注意事项">维护etcd有什么注意事项？</h2>
<p>简单的版本是：<strong>不要写爆 etcd 就好</strong>。</p>
<p>etcd 默认设置了一个 2GB 的数据库容量上限，如果您的 etcd 数据库容量超过了这个限制，etcd 将会拒绝写入请求，这可能导致依赖 etcd 的 PostgreSQL 高可用机制无法正常工作。
与此同时，etcd 的<a href="https://etcd.io/docs/v3.5/learning/data_model/">数据模型</a> 使得每一次写入都会产生一个新的版本，因此如果您的 etcd 集群频繁写入，即使只有极个别的 Key， etcd 数据库的大小也可能会不断增长，并在达到容量上限时出现故障。</p>
<p>您可以通过 <strong>启动自动压实</strong>，<strong>手工压实</strong>，<strong>碎片整理</strong>与<strong>提高配额</strong>等方式实现这一点，详情请阅读 etcd <a href="https://etcd.io/docs/v3.5/op-guide/maintenance/">官方文档维护指南</a>。</p>
<p>Pigsty 在 v2.6 之后默认启用了 etcd 自动压实（Auto Compact），通常无需担心写满 etcd 的问题。对于 v2.6 之前的版本，我们 <strong>强烈建议您</strong> 在生产环境中启用 etcd 的自动压实功能</p>


<div class="alert alert-danger" role="alert">
<h4 class="alert-heading">写爆 etcd 可能导致 etcd 集群不可用与 PostgreSQL 高可用故障！</h4>

    请 Pigsty v2.0 - v2.5 用户尽快升级到较新版本，或参照下面的说明启用 etcd 自动垃圾回收

</div>

<hr>
<h2 id="如何启动etcd自动垃圾回收">如何启动etcd自动垃圾回收？</h2>
<p>如果您使用的早先版本的 Pigsty （v2.0 - v2.5），我们强烈建议您通过以下步骤，在生产环境中启用 etcd 的自动压实功能，从而避免 etcd 容量配额写满导致的 etcd 不可用故障。</p>
<p>在 Pigsty 源码目录中，编辑 etcd 配置文件模板：<a href="https://github.com/Vonng/pigsty/blob/main/roles/etcd/templates/etcd.conf.j2#L30"><code>roles/etcd/templates/etcd.conf.j2</code></a>，添加以下三条配置项：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">auto-compaction-mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">periodic</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">auto-compaction-retention</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;24h&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">quota-backend-bytes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">17179869184</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>然后将所有相关 PostgreSQL 集群设置为 <a href="/zh/docs/pgsql/admin"><strong>维护模式</strong></a> 后，重新使用 <code>./etcd.yml</code> 覆盖部署 etcd 集群即可。</p>
<p>该配置会将 etcd 默认的容量配额从 2 GiB 提高到 16 GiB，并确保只保留最近一天的写入历史版本，从而避免了 etcd 数据库大小的无限增长。</p>
<hr>
<h2 id="etcd中的postgresql高可用数据存储在哪里">etcd中的PostgreSQL高可用数据存储在哪里？</h2>
<p>默认情况下，Patroni 使用 <a href="/zh/docs/reference/param#pg_namespace"><strong><code>pg_namespace</code></strong></a> 指定的前缀（默认为 <code>/pg</code>）作为所有元数据键的前缀，随后是 PostgreSQL 集群名称，例如，名为 <code>pg-meta</code> 的 PG 集群，其元数据键将存储在 <code>/pg/pg-meta</code> 下。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl get /pg/pg-meta --prefix
</span></span></code></pre></div><p>其中的数据样本如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/pg/pg-meta/config
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;ttl&#34;</span>:30,<span style="color:#4e9a06">&#34;loop_wait&#34;</span>:10,<span style="color:#4e9a06">&#34;retry_timeout&#34;</span>:10,<span style="color:#4e9a06">&#34;primary_start_timeout&#34;</span>:10,<span style="color:#4e9a06">&#34;maximum_lag_on_failover&#34;</span>:1048576,<span style="color:#4e9a06">&#34;maximum_lag_on_syncnode&#34;</span>:-1,<span style="color:#4e9a06">&#34;primary_stop_timeout&#34;</span>:30,<span style="color:#4e9a06">&#34;synchronous_mode&#34;</span>:false,<span style="color:#4e9a06">&#34;synchronous_mode_strict&#34;</span>:false,<span style="color:#4e9a06">&#34;failsafe_mode&#34;</span>:true,<span style="color:#4e9a06">&#34;pg_version&#34;</span>:16,<span style="color:#4e9a06">&#34;pg_cluster&#34;</span>:<span style="color:#4e9a06">&#34;pg-meta&#34;</span>,<span style="color:#4e9a06">&#34;pg_shard&#34;</span>:<span style="color:#4e9a06">&#34;pg-meta&#34;</span>,<span style="color:#4e9a06">&#34;pg_group&#34;</span>:0,<span style="color:#4e9a06">&#34;postgresql&#34;</span>:<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;use_slots&#34;</span>:true,<span style="color:#4e9a06">&#34;use_pg_rewind&#34;</span>:true,<span style="color:#4e9a06">&#34;remove_data_directory_on_rewind_failure&#34;</span>:true,<span style="color:#4e9a06">&#34;parameters&#34;</span>:<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;max_connections&#34;</span>:100,<span style="color:#4e9a06">&#34;superuser_reserved_connections&#34;</span>:10,<span style="color:#4e9a06">&#34;max_locks_per_transaction&#34;</span>:200,<span style="color:#4e9a06">&#34;max_prepared_transactions&#34;</span>:0,<span style="color:#4e9a06">&#34;track_commit_timestamp&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;wal_level&#34;</span>:<span style="color:#4e9a06">&#34;logical&#34;</span>,<span style="color:#4e9a06">&#34;wal_log_hints&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;max_worker_processes&#34;</span>:16,<span style="color:#4e9a06">&#34;max_wal_senders&#34;</span>:50,<span style="color:#4e9a06">&#34;max_replication_slots&#34;</span>:50,<span style="color:#4e9a06">&#34;password_encryption&#34;</span>:<span style="color:#4e9a06">&#34;scram-sha-256&#34;</span>,<span style="color:#4e9a06">&#34;ssl&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;ssl_cert_file&#34;</span>:<span style="color:#4e9a06">&#34;/pg/cert/server.crt&#34;</span>,<span style="color:#4e9a06">&#34;ssl_key_file&#34;</span>:<span style="color:#4e9a06">&#34;/pg/cert/server.key&#34;</span>,<span style="color:#4e9a06">&#34;ssl_ca_file&#34;</span>:<span style="color:#4e9a06">&#34;/pg/cert/ca.crt&#34;</span>,<span style="color:#4e9a06">&#34;shared_buffers&#34;</span>:<span style="color:#4e9a06">&#34;7969MB&#34;</span>,<span style="color:#4e9a06">&#34;maintenance_work_mem&#34;</span>:<span style="color:#4e9a06">&#34;1993MB&#34;</span>,<span style="color:#4e9a06">&#34;work_mem&#34;</span>:<span style="color:#4e9a06">&#34;79MB&#34;</span>,<span style="color:#4e9a06">&#34;max_parallel_workers&#34;</span>:8,<span style="color:#4e9a06">&#34;max_parallel_maintenance_workers&#34;</span>:2,<span style="color:#4e9a06">&#34;max_parallel_workers_per_gather&#34;</span>:0,<span style="color:#4e9a06">&#34;hash_mem_multiplier&#34;</span>:8.0,<span style="color:#4e9a06">&#34;huge_pages&#34;</span>:<span style="color:#4e9a06">&#34;try&#34;</span>,<span style="color:#4e9a06">&#34;temp_file_limit&#34;</span>:<span style="color:#4e9a06">&#34;7GB&#34;</span>,<span style="color:#4e9a06">&#34;vacuum_cost_delay&#34;</span>:<span style="color:#4e9a06">&#34;20ms&#34;</span>,<span style="color:#4e9a06">&#34;vacuum_cost_limit&#34;</span>:2000,<span style="color:#4e9a06">&#34;bgwriter_delay&#34;</span>:<span style="color:#4e9a06">&#34;10ms&#34;</span>,<span style="color:#4e9a06">&#34;bgwriter_lru_maxpages&#34;</span>:800,<span style="color:#4e9a06">&#34;bgwriter_lru_multiplier&#34;</span>:5.0,<span style="color:#4e9a06">&#34;min_wal_size&#34;</span>:<span style="color:#4e9a06">&#34;7GB&#34;</span>,<span style="color:#4e9a06">&#34;max_wal_size&#34;</span>:<span style="color:#4e9a06">&#34;28GB&#34;</span>,<span style="color:#4e9a06">&#34;max_slot_wal_keep_size&#34;</span>:<span style="color:#4e9a06">&#34;42GB&#34;</span>,<span style="color:#4e9a06">&#34;wal_buffers&#34;</span>:<span style="color:#4e9a06">&#34;16MB&#34;</span>,<span style="color:#4e9a06">&#34;wal_writer_delay&#34;</span>:<span style="color:#4e9a06">&#34;20ms&#34;</span>,<span style="color:#4e9a06">&#34;wal_writer_flush_after&#34;</span>:<span style="color:#4e9a06">&#34;1MB&#34;</span>,<span style="color:#4e9a06">&#34;commit_delay&#34;</span>:20,<span style="color:#4e9a06">&#34;commit_siblings&#34;</span>:10,<span style="color:#4e9a06">&#34;checkpoint_timeout&#34;</span>:<span style="color:#4e9a06">&#34;15min&#34;</span>,<span style="color:#4e9a06">&#34;checkpoint_completion_target&#34;</span>:0.8,<span style="color:#4e9a06">&#34;archive_mode&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;archive_timeout&#34;</span>:300,<span style="color:#4e9a06">&#34;archive_command&#34;</span>:<span style="color:#4e9a06">&#34;pgbackrest --stanza=pg-meta archive-push %p&#34;</span>,<span style="color:#4e9a06">&#34;max_standby_archive_delay&#34;</span>:<span style="color:#4e9a06">&#34;10min&#34;</span>,<span style="color:#4e9a06">&#34;max_standby_streaming_delay&#34;</span>:<span style="color:#4e9a06">&#34;3min&#34;</span>,<span style="color:#4e9a06">&#34;wal_receiver_status_interval&#34;</span>:<span style="color:#4e9a06">&#34;1s&#34;</span>,<span style="color:#4e9a06">&#34;hot_standby_feedback&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;wal_receiver_timeout&#34;</span>:<span style="color:#4e9a06">&#34;60s&#34;</span>,<span style="color:#4e9a06">&#34;max_logical_replication_workers&#34;</span>:8,<span style="color:#4e9a06">&#34;max_sync_workers_per_subscription&#34;</span>:6,<span style="color:#4e9a06">&#34;random_page_cost&#34;</span>:1.1,<span style="color:#4e9a06">&#34;effective_io_concurrency&#34;</span>:1000,<span style="color:#4e9a06">&#34;effective_cache_size&#34;</span>:<span style="color:#4e9a06">&#34;23907MB&#34;</span>,<span style="color:#4e9a06">&#34;default_statistics_target&#34;</span>:200,<span style="color:#4e9a06">&#34;log_destination&#34;</span>:<span style="color:#4e9a06">&#34;csvlog&#34;</span>,<span style="color:#4e9a06">&#34;logging_collector&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;log_directory&#34;</span>:<span style="color:#4e9a06">&#34;/pg/log/postgres&#34;</span>,<span style="color:#4e9a06">&#34;log_filename&#34;</span>:<span style="color:#4e9a06">&#34;postgresql-%Y-%m-%d.log&#34;</span>,<span style="color:#4e9a06">&#34;log_checkpoints&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;log_lock_waits&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;log_replication_commands&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;log_statement&#34;</span>:<span style="color:#4e9a06">&#34;ddl&#34;</span>,<span style="color:#4e9a06">&#34;log_min_duration_statement&#34;</span>:100,<span style="color:#4e9a06">&#34;track_io_timing&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;track_functions&#34;</span>:<span style="color:#4e9a06">&#34;all&#34;</span>,<span style="color:#4e9a06">&#34;track_activity_query_size&#34;</span>:8192,<span style="color:#4e9a06">&#34;log_autovacuum_min_duration&#34;</span>:<span style="color:#4e9a06">&#34;1s&#34;</span>,<span style="color:#4e9a06">&#34;autovacuum_max_workers&#34;</span>:2,<span style="color:#4e9a06">&#34;autovacuum_naptime&#34;</span>:<span style="color:#4e9a06">&#34;1min&#34;</span>,<span style="color:#4e9a06">&#34;autovacuum_vacuum_cost_delay&#34;</span>:-1,<span style="color:#4e9a06">&#34;autovacuum_vacuum_cost_limit&#34;</span>:-1,<span style="color:#4e9a06">&#34;autovacuum_freeze_max_age&#34;</span>:1000000000,<span style="color:#4e9a06">&#34;deadlock_timeout&#34;</span>:<span style="color:#4e9a06">&#34;50ms&#34;</span>,<span style="color:#4e9a06">&#34;idle_in_transaction_session_timeout&#34;</span>:<span style="color:#4e9a06">&#34;10min&#34;</span>,<span style="color:#4e9a06">&#34;shared_preload_libraries&#34;</span>:<span style="color:#4e9a06">&#34;timescaledb, pg_stat_statements, auto_explain&#34;</span>,<span style="color:#4e9a06">&#34;auto_explain.log_min_duration&#34;</span>:<span style="color:#4e9a06">&#34;1s&#34;</span>,<span style="color:#4e9a06">&#34;auto_explain.log_analyze&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;auto_explain.log_verbose&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;auto_explain.log_timing&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;auto_explain.log_nested_statements&#34;</span>:true,<span style="color:#4e9a06">&#34;pg_stat_statements.max&#34;</span>:5000,<span style="color:#4e9a06">&#34;pg_stat_statements.track&#34;</span>:<span style="color:#4e9a06">&#34;all&#34;</span>,<span style="color:#4e9a06">&#34;pg_stat_statements.track_utility&#34;</span>:<span style="color:#4e9a06">&#34;off&#34;</span>,<span style="color:#4e9a06">&#34;pg_stat_statements.track_planning&#34;</span>:<span style="color:#4e9a06">&#34;off&#34;</span>,<span style="color:#4e9a06">&#34;timescaledb.telemetry_level&#34;</span>:<span style="color:#4e9a06">&#34;off&#34;</span>,<span style="color:#4e9a06">&#34;timescaledb.max_background_workers&#34;</span>:8,<span style="color:#4e9a06">&#34;citus.node_conninfo&#34;</span>:<span style="color:#4e9a06">&#34;sslm
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ode=prefer&#34;</span><span style="color:#ce5c00;font-weight:bold">}}}</span>
</span></span><span style="display:flex;"><span>/pg/pg-meta/failsafe
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;pg-meta-2&#34;</span>:<span style="color:#4e9a06">&#34;http://10.10.10.11:8008/patroni&#34;</span>,<span style="color:#4e9a06">&#34;pg-meta-1&#34;</span>:<span style="color:#4e9a06">&#34;http://10.10.10.10:8008/patroni&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>/pg/pg-meta/initialize
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">7418384210787662172</span>
</span></span><span style="display:flex;"><span>/pg/pg-meta/leader
</span></span><span style="display:flex;"><span>pg-meta-1
</span></span><span style="display:flex;"><span>/pg/pg-meta/members/pg-meta-1
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;conn_url&#34;</span>:<span style="color:#4e9a06">&#34;postgres://10.10.10.10:5432/postgres&#34;</span>,<span style="color:#4e9a06">&#34;api_url&#34;</span>:<span style="color:#4e9a06">&#34;http://10.10.10.10:8008/patroni&#34;</span>,<span style="color:#4e9a06">&#34;state&#34;</span>:<span style="color:#4e9a06">&#34;running&#34;</span>,<span style="color:#4e9a06">&#34;role&#34;</span>:<span style="color:#4e9a06">&#34;primary&#34;</span>,<span style="color:#4e9a06">&#34;version&#34;</span>:<span style="color:#4e9a06">&#34;4.0.1&#34;</span>,<span style="color:#4e9a06">&#34;tags&#34;</span>:<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;clonefrom&#34;</span>:true,<span style="color:#4e9a06">&#34;version&#34;</span>:<span style="color:#4e9a06">&#34;16&#34;</span>,<span style="color:#4e9a06">&#34;spec&#34;</span>:<span style="color:#4e9a06">&#34;8C.32G.125G&#34;</span>,<span style="color:#4e9a06">&#34;conf&#34;</span>:<span style="color:#4e9a06">&#34;tiny.yml&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>,<span style="color:#4e9a06">&#34;xlog_location&#34;</span>:184549376,<span style="color:#4e9a06">&#34;timeline&#34;</span>:1<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>/pg/pg-meta/members/pg-meta-2
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;conn_url&#34;</span>:<span style="color:#4e9a06">&#34;postgres://10.10.10.11:5432/postgres&#34;</span>,<span style="color:#4e9a06">&#34;api_url&#34;</span>:<span style="color:#4e9a06">&#34;http://10.10.10.11:8008/patroni&#34;</span>,<span style="color:#4e9a06">&#34;state&#34;</span>:<span style="color:#4e9a06">&#34;running&#34;</span>,<span style="color:#4e9a06">&#34;role&#34;</span>:<span style="color:#4e9a06">&#34;replica&#34;</span>,<span style="color:#4e9a06">&#34;version&#34;</span>:<span style="color:#4e9a06">&#34;4.0.1&#34;</span>,<span style="color:#4e9a06">&#34;tags&#34;</span>:<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;clonefrom&#34;</span>:true,<span style="color:#4e9a06">&#34;version&#34;</span>:<span style="color:#4e9a06">&#34;16&#34;</span>,<span style="color:#4e9a06">&#34;spec&#34;</span>:<span style="color:#4e9a06">&#34;8C.32G.125G&#34;</span>,<span style="color:#4e9a06">&#34;conf&#34;</span>:<span style="color:#4e9a06">&#34;tiny.yml&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>,<span style="color:#4e9a06">&#34;xlog_location&#34;</span>:184549376,<span style="color:#4e9a06">&#34;replication_state&#34;</span>:<span style="color:#4e9a06">&#34;streaming&#34;</span>,<span style="color:#4e9a06">&#34;timeline&#34;</span>:1<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>/pg/pg-meta/status
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;optime&#34;</span>:184549376,<span style="color:#4e9a06">&#34;slots&#34;</span>:<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;pg_meta_2&#34;</span>:184549376,<span style="color:#4e9a06">&#34;pg_meta_1&#34;</span>:184549376<span style="color:#ce5c00;font-weight:bold">}</span>,<span style="color:#4e9a06">&#34;retain_slots&#34;</span>:<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;pg_meta_1&#34;</span>,<span style="color:#4e9a06">&#34;pg_meta_2&#34;</span><span style="color:#ce5c00;font-weight:bold">]}</span>
</span></span></code></pre></div><hr>
<h2 id="如何使用一个外部的已经存在的-etcd-集群">如何使用一个外部的已经存在的 etcd 集群？</h2>
<p>配置清单中硬编码了所使用 etcd 的分组名为 <code>etcd</code>，这个分组里的成员将被用作 PGSQL 的 DCS 服务器。您可以使用 <code>etcd.yml</code> 对它们进行初始化，或直接假设它是一个已存在的外部 etcd 集群。</p>
<p>要使用现有的外部 etcd 集群，只要像往常一样定义它们即可，您可以跳过 <code>etcd.yml</code> 剧本的执行，因为集群已经存在，不需要部署。</p>
<p>但用户必须确保 <strong>现有 etcd 集群证书是由 Pigsty 使用的相同 CA 签名颁发的</strong>。否则客户端无法使用 Pigsty 自签名 CA 颁发的证书来访问外部的 etcd 集群。</p>
<hr>
<h2 id="如何向现有etcd集群添加新的成员">如何向现有etcd集群添加新的成员？</h2>
<blockquote>
<p>详细过程，请参考<a href="/zh/docs/etcd#%E6%B7%BB%E5%8A%A0%E6%88%90%E5%91%98">向 etcd 集群添加成员</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl member add &lt;etcd-?&gt; --learner<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --peer-urls<span style="color:#ce5c00;font-weight:bold">=</span>https://&lt;new_ins_ip&gt;:2380 <span style="color:#8f5902;font-style:italic"># 在管理节点上宣告新成员加入</span>
</span></span><span style="display:flex;"><span>./etcd.yml -l &lt;new_ins_ip&gt; -e <span style="color:#000">etcd_init</span><span style="color:#ce5c00;font-weight:bold">=</span>existing                                 <span style="color:#8f5902;font-style:italic"># 真正初始化新 etcd 成员</span>
</span></span><span style="display:flex;"><span>etcdctl member promote &lt;new_ins_server_id&gt;                                       <span style="color:#8f5902;font-style:italic"># 在管理节点上提升新成员为正式成员</span>
</span></span></code></pre></div><hr>
<h2 id="如何从现有etcd集群中移除成员">如何从现有etcd集群中移除成员？</h2>
<blockquote>
<p>详细过程，请参考<a href="/zh/docs/etcd#%E7%A7%BB%E9%99%A4%E6%88%90%E5%91%98">从 etcd 集群中移除成员</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl member remove &lt;etcd_server_id&gt;   <span style="color:#8f5902;font-style:italic"># 在管理节点上从集群中踢出成员</span>
</span></span><span style="display:flex;"><span>./etcd.yml -l &lt;ins_ip&gt; -t etcd_purge     <span style="color:#8f5902;font-style:italic"># 真正清除下线 etcd 实例</span>
</span></span></code></pre></div>
</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Mail" aria-label="Mail">
    <a target="_blank" rel="noopener" href="mailto:rh@vonng.com" aria-label="Mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Vonng/pigsty" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://twitter.com/GobeUncleWang" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="WeChat" aria-label="WeChat">
    <a target="_blank" rel="noopener" href="/img/pigsty/pigsty-cc.jpg" aria-label="WeChat">
      <i class="fa fa-comment"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Discord" aria-label="Discord">
    <a target="_blank" rel="noopener" href="https://discord.gg/wDzt5VyWEz" aria-label="Discord">
      <i class="fab fa-discord"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Telegram" aria-label="Telegram">
    <a target="_blank" rel="noopener" href="https://t.me/joinchat/gV9zfZraNPM3YjFh" aria-label="Telegram">
      <i class="fab fa-telegram"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2018&ndash;2024
    <span class="td-footer__authors">Ruohang Feng</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span></span><span class="ms-2"><a href="https://vonng.com/en/" target="_blank" rel="noopener">@Vonng</a></span>
<br><span>Pigsty® distributed under <a href="/docs/about/license" target="_blank" rel="noopener">AGPLv3</a></span>
<br><span class="ms-2"><a href="/docs/about/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
<span><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">浙ICP备15016890号</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.248655eb216150e39da254c2f7aa5357805d0ec66bdb741b591cd35fb5f629ab.js" integrity="sha256-JIZV6yFhUOOdolTC96pTV4BdDsZr23QbWRzTX7X2Kas=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
