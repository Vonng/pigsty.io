<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="/zh/docs/pgsql/">
<link rel="alternate" type="application/rss&#43;xml" href="/zh/docs/pgsql/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>模块：PGSQL | Pigsty</title>
<meta name="description" content="如何使用 Pigsty 部署并管理世界上最先进的开源关系型数据库 —— PostgreSQL，按需定制，开箱即用！
">
<meta property="og:title" content="模块：PGSQL" />
<meta property="og:description" content="如何使用 Pigsty 部署并管理世界上最先进的开源关系型数据库 —— PostgreSQL，按需定制，开箱即用！
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/zh/docs/pgsql/" />

<meta itemprop="name" content="模块：PGSQL">
<meta itemprop="description" content="如何使用 Pigsty 部署并管理世界上最先进的开源关系型数据库 —— PostgreSQL，按需定制，开箱即用！
"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="模块：PGSQL"/>
<meta name="twitter:description" content="如何使用 Pigsty 部署并管理世界上最先进的开源关系型数据库 —— PostgreSQL，按需定制，开箱即用！
"/>




<link rel="preload" href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" as="style">
<link href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="/js/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LG1V9WTKGE');
}
</script>
  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/zh/"><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class="navbar-brand__name">Pigsty</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/zh/docs/"><i class='fa-solid fa-book'></i><span>文档</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/zh/blog/"><i class="fas fa-blog"></i><span>博客</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/Vonng/pigsty/" target="_blank" rel="noopener"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-language"></i>中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/docs/pgsql/">English</a></li>
    </ul>
</div>
</li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.842323c008a7c646d7905856380c7fd9.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/zh/docs/pgsql/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">模块：PGSQL</h1>
<div class="lead">如何使用 Pigsty 部署并管理世界上最先进的开源关系型数据库 —— PostgreSQL，按需定制，开箱即用！</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-e568caeba7bea980f92135e0b27b60d5">核心概念</a></li>


    
  
    
    
	
<li>2: <a href="#pg-ea3ddc89f231393b38923a59f1c6d742">系统架构</a></li>


    
  
    
    
	
<li>3: <a href="#pg-85b6224145fe3fe5038c58a93cf9de21">用户/角色</a></li>


    
  
    
    
	
<li>4: <a href="#pg-77da146645a70d6fc90b1213d22e52d5">数据库</a></li>


    
  
    
    
	
<li>5: <a href="#pg-d9b0c31dfa75886b76d79a64b11591aa">服务/接入</a></li>


    
  
    
    
	
<li>6: <a href="#pg-07d77c313c9a2410ca022115a263dafc">扩展插件</a></li>


    
  
    
    
	
<li>7: <a href="#pg-d353f8b723fb78c622e9dd520898a3dd">认证 / HBA</a></li>


    
  
    
    
	
<li>8: <a href="#pg-61c2dced240f3df23a0a7e039b04b7d6">集群配置</a></li>


    
  
    
    
	
<li>9: <a href="#pg-091b9f18681382583303e1ac5c7cea55">预置剧本</a></li>


    
  
    
    
	
<li>10: <a href="#pg-7002dbf9503f9bb5f791aa73eb5fabe9">管理预案</a></li>


    
  
    
    
	
<li>11: <a href="#pg-54447441a605cf594e517be7f37ae788">访问控制</a></li>


    
  
    
    
	
<li>12: <a href="#pg-cd0c200c9f6515f7a7ac9cc0f4b856bf">备份恢复</a></li>


    
  
    
    
	
<li>13: <a href="#pg-9df6c956772e8cb04fe4f58165034338">迁移</a></li>


    
  
    
    
	
<li>14: <a href="#pg-d62cf100c93be858ce7b3c37726c8061">监控接入</a></li>


    
  
    
    
	
<li>15: <a href="#pg-0ce334f57e9d6869b53659cc6bab754e">监控面板</a></li>


    
  
    
    
	
<li>16: <a href="#pg-1f69b3f46163cb973f38581bf88a88a8">指标列表</a></li>


    
  
    
    
	
<li>17: <a href="#pg-06a73ab7adbd73b0e635c3d9403cab4e">常见问题</a></li>


    
  

    </ul>


<div class="content">
      <blockquote>
<p><strong>世界上最先进的开源关系型数据库！</strong></p>
<p>而 Pigsty 帮它进入全盛状态：开箱即用、可靠、可观测、可维护、可伸缩！ <a href="/zh/docs/pgsql/config">配置</a> | <a href="/zh/docs/pgsql/admin">管理</a> | <a href="/zh/docs/pgsql/playbook">剧本</a> | <a href="/zh/docs/pgsql/dashboard">监控</a> | <a href="/zh/docs/pgsql/#参数">参数</a></p>
</blockquote>
<hr>
<h2 id="概览">概览</h2>
<blockquote>
<p>了解关于 PostgreSQL 的重要主题与概念。</p>
</blockquote>
<ul>
<li><a href="/zh/docs/pgsql/arch">系统架构</a></li>
<li><a href="/zh/docs/pgsql/config">集群配置</a></li>
<li><a href="/zh/docs/reference/extension">扩展插件</a></li>
<li><a href="/zh/docs/pgsql/user">用户/角色</a></li>
<li><a href="/zh/docs/pgsql/db">数据库</a></li>
<li><a href="/zh/docs/pgsql/svc">服务/接入</a></li>
<li><a href="/zh/docs/pgsql/hba">认证/HBA</a></li>
<li><a href="/zh/docs/pgsql/acl">访问控制</a></li>
<li><a href="/zh/docs/pgsql/admin">管理预案</a></li>
<li><a href="/zh/docs/pgsql/pitr">备份恢复</a></li>
<li><a href="/zh/docs/pgsql/monitor">监控接入</a></li>
<li><a href="/zh/docs/pgsql/migration">集群迁移</a></li>
<li><a href="/zh/docs/pgsql/dashboard">仪表盘</a></li>
</ul>
<hr>
<h2 id="配置">配置</h2>
<blockquote>
<p><a href="/zh/docs/pgsql/config">描述</a> 你想要的 PostgreSQL 集群</p>
</blockquote>
<ul>
<li><a href="/zh/docs/pgsql/arch#%E8%BA%AB%E4%BB%BD%E5%8F%82%E6%95%B0">身份参数</a>：定义PostgreSQL集群的身份参数</li>
<li><a href="/zh/docs/pgsql/config#%E8%AF%BB%E5%86%99%E4%B8%BB%E5%BA%93">读写主库</a>：创建由单一主库构成的单实例“集群“</li>
<li><a href="/zh/docs/pgsql/config#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93">只读从库</a>：创建一主一从的两节点基础高可用集群</li>
<li><a href="/zh/docs/pgsql/config#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93">离线从库</a>：创建专用于OLAP/ETL/交互式查询的特殊只读实例</li>
<li><a href="/zh/docs/pgsql/config#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93">同步备库</a>：启用同步提交，以确保没有数据丢失</li>
<li><a href="/zh/docs/pgsql/config#%E6%B3%95%E5%AE%9A%E4%BA%BA%E6%95%B0%E6%8F%90%E4%BA%A4">法定人数</a>：使用法定人数同步提交以获得更高的一致性级别</li>
<li><a href="/zh/docs/pgsql/config#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4">备份集群</a>：克隆现有集群，并保持同步（异地灾备集群）</li>
<li><a href="/zh/docs/pgsql/config#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4">延迟集群</a>：克隆现有集群，并延迟重放，用于紧急数据恢复</li>
<li><a href="/zh/docs/pgsql/config#citus%E9%9B%86%E7%BE%A4">Citus集群</a>：定义并创建 Citus 水平分布式数据库集群</li>
<li><a href="/zh/docs/pgsql/config#%E5%A4%A7%E7%89%88%E6%9C%AC%E5%88%87%E6%8D%A2">大版本切换</a>：使用不同的PostgreSQL大版本部署集群</li>
</ul>
<hr>
<h2 id="管理">管理</h2>
<blockquote>
<p><a href="/zh/docs/pgsql/admin">管理</a> 您所创建的 PostgreSQL 集群。</p>
</blockquote>
<ul>
<li><a href="/zh/docs/pgsql/admin#%E5%91%BD%E4%BB%A4%E9%80%9F%E6%9F%A5">命令速查</a></li>
<li><a href="/zh/docs/pgsql/admin#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4">创建集群</a></li>
<li><a href="/zh/docs/pgsql/admin#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7">创建用户</a></li>
<li><a href="/zh/docs/pgsql/admin#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93">创建数据库</a></li>
<li><a href="/zh/docs/pgsql/admin#%E9%87%8D%E8%BD%BD%E6%9C%8D%E5%8A%A1">重载服务</a></li>
<li><a href="/zh/docs/pgsql/admin#%E9%87%8D%E8%BD%BDhba">重载HBA</a></li>
<li><a href="/zh/docs/pgsql/admin#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4">配置集群</a></li>
<li><a href="/zh/docs/pgsql/admin#%E6%B7%BB%E5%8A%A0%E5%AE%9E%E4%BE%8B">添加实例</a></li>
<li><a href="/zh/docs/pgsql/admin#%E7%A7%BB%E9%99%A4%E5%AE%9E%E4%BE%8B">移除实例</a></li>
<li><a href="/zh/docs/pgsql/admin#%E4%B8%8B%E7%BA%BF%E9%9B%86%E7%BE%A4">下线集群</a></li>
<li><a href="/zh/docs/pgsql/admin#%E4%B8%BB%E5%8A%A8%E5%88%87%E6%8D%A2">主动切换</a></li>
<li><a href="/zh/docs/pgsql/admin#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4">备份集群</a></li>
<li><a href="/zh/docs/pgsql/admin#%E6%81%A2%E5%A4%8D%E9%9B%86%E7%BE%A4">恢复集群</a></li>
<li><a href="/zh/docs/pgsql/faq/">疑难杂症</a></li>
</ul>
<hr>
<h2 id="剧本">剧本</h2>
<blockquote>
<p>使用幂等的<a href="/zh/docs/pgsql/playbook">剧本</a>，将您的描述变为现实。</p>
</blockquote>
<ul>
<li><a href="/zh/docs/pgsql/playbook#pgsqlyml"><code>pgsql.yml</code></a> ：初始化PostgreSQL集群或添加新的从库。</li>
<li><a href="/zh/docs/pgsql/playbook#pgsql-rmyml"><code>pgsql-rm.yml</code></a> ：移除PostgreSQL集群，或移除某个实例</li>
<li><a href="/zh/docs/pgsql/playbook#pgsql-useryml"><code>pgsql-user.yml</code></a> ：在现有的PostgreSQL集群中添加新的业务用户</li>
<li><a href="/zh/docs/pgsql/playbook#pgsql-dbyml"><code>pgsql-db.yml</code></a> ：在现有的PostgreSQL集群中添加新的业务数据库</li>
<li><a href="/zh/docs/pgsql/playbook#pgsql-monitoryml"><code>pgsql-monitor.yml</code></a> ：将远程postgres实例纳入监控中</li>
<li><a href="/zh/docs/pgsql/playbook#pgsql-migrationyml"><code>pgsql-migration.yml</code></a> ：为现有的PostgreSQL集群生成迁移手册和脚本</li>
</ul>
<details><summary>样例：安装 PGSQL 模块</summary>
<p><a href="https://asciinema.org/a/566417"><img alt="asciicast" src="https://asciinema.org/a/566417.svg"></a></p>
</details>
<details><summary>样例：移除 PGSQL 模块</summary>
<p><a href="https://asciinema.org/a/566418"><img alt="asciicast" src="https://asciinema.org/a/566418.svg"></a></p>
</details>
<hr>
<h2 id="监控">监控</h2>
<blockquote>
<p>在 Grafana <a href="/zh/docs/pgsql/dashboard">仪表盘</a> 中查阅 PostgreSQL 的详情状态。</p>
</blockquote>
<p>在 Pigsty 中共有 26 个与 PostgreSQL 相关的监控面板：</p>
<table>
<thead>
<tr>
<th style="text-align:center">总览</th>
<th style="text-align:center">集群</th>
<th style="text-align:center">实例</th>
<th style="text-align:center">数据库</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-overview">PGSQL Overview</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-cluster">PGSQL Cluster</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-instance">PGSQL Instance</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-database">PGSQL Database</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-alert">PGSQL Alert</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgrds-cluster">PGRDS Cluster</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgrds-instance">PGRDS Instance</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-database">PGCAT Database</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-shard">PGSQL Shard</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-activity">PGSQL Activity</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-instance">PGCAT Instance</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-tables">PGSQL Tables</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-replication">PGSQL Replication</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-persist">PGSQL Persist</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-table">PGSQL Table</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-service">PGSQL Service</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-proxy">PGSQL Proxy</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-table">PGCAT Table</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-databases">PGSQL Databases</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-pgbouncer">PGSQL Pgbouncer</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-query">PGSQL Query</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-patroni">PGSQL Patroni</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-session">PGSQL Session</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-query">PGCAT Query</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-pitr">PGSQL PITR</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-xacts">PGSQL Xacts</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-locks">PGCAT Locks</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-exporter">PGSQL Exporter</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-schema">PGCAT Schema</a></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="参数">参数</h2>
<blockquote>
<p><a href="/zh/docs/reference/param#pgsql">PGSQL</a> 模块的配置参数列表</p>
</blockquote>
<ul>
<li><a href="/zh/docs/reference/param#pg_id"><code>PG_ID</code></a> : 计算和校验 PostgreSQL 实例身份</li>
<li><a href="/zh/docs/reference/param#pg_business"><code>PG_BUSINESS</code></a> : PostgreSQL业务对象定义</li>
<li><a href="/zh/docs/reference/param#pg_install"><code>PG_INSTALL</code></a> : 安装 PostgreSQL 内核，支持软件包与扩展插件</li>
<li><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a> : 使用 Patroni 初始化高可用 PostgreSQL 集群</li>
<li><a href="/zh/docs/reference/param#pg_provision"><code>PG_PROVISION</code></a> : 创建 PostgreSQL 用户、数据库和其他数据库内对象</li>
<li><a href="/zh/docs/reference/param#pg_backup"><code>PG_BACKUP</code></a> : 使用 pgbackrest 设置备份仓库</li>
<li><a href="/zh/docs/reference/param#pg_service"><code>PG_SERVICE</code></a> : 暴露 PostgreSQL 服务，绑定 VIP （可选），以及注册DNS</li>
<li><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a> : 为 PostgreSQL 实例添加监控，并注册至基础设施中。</li>
</ul>
<details><summary>完整参数列表</summary>
<table>
<thead>
<tr>
<th>参数</th>
<th>参数组</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">级别</th>
<th>说明</th>
<th>中文说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="/zh/docs/reference/param#pg_mode"><code>pg_mode</code></a></td>
<td><a href="/zh/docs/reference/param#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>pgsql cluster mode: pgsql,citus,gpsql</td>
<td>pgsql 集群模式: pgsql,citus,gpsql</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_cluster"><code>pg_cluster</code></a></td>
<td><a href="/zh/docs/reference/param#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>pgsql cluster name, REQUIRED identity parameter</td>
<td>pgsql 集群名称, 必选身份参数</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_seq"><code>pg_seq</code></a></td>
<td><a href="/zh/docs/reference/param#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">I</td>
<td>pgsql instance seq number, REQUIRED identity parameter</td>
<td>pgsql 实例号, 必选身份参数</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_role"><code>pg_role</code></a></td>
<td><a href="/zh/docs/reference/param#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">I</td>
<td>pgsql role, REQUIRED, could be primary,replica,offline</td>
<td>pgsql 实例角色, 必选身份参数, 可为 primary，replica，offline</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_instances"><code>pg_instances</code></a></td>
<td><a href="/zh/docs/reference/param#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">dict</td>
<td style="text-align:center">I</td>
<td>define multiple pg instances on node in <code>{port:ins_vars}</code> format</td>
<td>在一个节点上定义多个 pg 实例，使用 <code>{port:ins_vars}</code> 格式</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_upstream"><code>pg_upstream</code></a></td>
<td><a href="/zh/docs/reference/param#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">ip</td>
<td style="text-align:center">I</td>
<td>repl upstream ip addr for standby cluster or cascade replica</td>
<td>级联从库或备份集群或的复制上游节点IP地址</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_shard"><code>pg_shard</code></a></td>
<td><a href="/zh/docs/reference/param#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>pgsql shard name, optional identity for sharding clusters</td>
<td>pgsql 分片名，对 citus 与 gpsql 等水平分片集群为必选身份参数</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_group"><code>pg_group</code></a></td>
<td><a href="/zh/docs/reference/param#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">C</td>
<td>pgsql shard index number, optional identity for sharding clusters</td>
<td>pgsql 分片号，正整数，对 citus 与 gpsql 等水平分片集群为必选身份参数</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#gp_role"><code>gp_role</code></a></td>
<td><a href="/zh/docs/reference/param#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>greenplum role of this cluster, could be master or segment</td>
<td>这个集群的 greenplum 角色，可以是 master 或 segment</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_exporters"><code>pg_exporters</code></a></td>
<td><a href="/zh/docs/reference/param#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">dict</td>
<td style="text-align:center">C</td>
<td>additional pg_exporters to monitor remote postgres instances</td>
<td>在该节点上设置额外的 pg_exporters 用于监控远程 postgres 实例</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_offline_query"><code>pg_offline_query</code></a></td>
<td><a href="/zh/docs/reference/param#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">I</td>
<td>set to true to enable offline query on this instance</td>
<td>设置为 true 将此只读实例标记为特殊的离线从库，承载 Offline 服务，允许离线查询</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_users"><code>pg_users</code></a></td>
<td><a href="/zh/docs/reference/param#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">user[]</td>
<td style="text-align:center">C</td>
<td>postgres business users</td>
<td>postgres 业务用户</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_databases"><code>pg_databases</code></a></td>
<td><a href="/zh/docs/reference/param#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">database[]</td>
<td style="text-align:center">C</td>
<td>postgres business databases</td>
<td>postgres 业务数据库</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_services"><code>pg_services</code></a></td>
<td><a href="/zh/docs/reference/param#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">service[]</td>
<td style="text-align:center">C</td>
<td>postgres business services</td>
<td>postgres 业务服务</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_hba_rules"><code>pg_hba_rules</code></a></td>
<td><a href="/zh/docs/reference/param#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">hba[]</td>
<td style="text-align:center">C</td>
<td>business hba rules for postgres</td>
<td>postgres 的业务 hba 规则</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgb_hba_rules"><code>pgb_hba_rules</code></a></td>
<td><a href="/zh/docs/reference/param#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">hba[]</td>
<td style="text-align:center">C</td>
<td>business hba rules for pgbouncer</td>
<td>pgbouncer 的业务 hba 规则</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_replication_username"><code>pg_replication_username</code></a></td>
<td><a href="/zh/docs/reference/param#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">username</td>
<td style="text-align:center">G</td>
<td>postgres replication username, <code>replicator</code> by default</td>
<td>postgres 复制用户名，默认为 <code>replicator</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_replication_password"><code>pg_replication_password</code></a></td>
<td><a href="/zh/docs/reference/param#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">password</td>
<td style="text-align:center">G</td>
<td>postgres replication password, <code>DBUser.Replicator</code> by default</td>
<td>postgres 复制密码，默认为 <code>DBUser.Replicator</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_admin_username"><code>pg_admin_username</code></a></td>
<td><a href="/zh/docs/reference/param#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">username</td>
<td style="text-align:center">G</td>
<td>postgres admin username, <code>dbuser_dba</code> by default</td>
<td>postgres 管理员用户名，默认为 <code>dbuser_dba</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_admin_password"><code>pg_admin_password</code></a></td>
<td><a href="/zh/docs/reference/param#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">password</td>
<td style="text-align:center">G</td>
<td>postgres admin password in plain text, <code>DBUser.DBA</code> by default</td>
<td>postgres 管理员明文密码，默认为 <code>DBUser.DBA</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_monitor_username"><code>pg_monitor_username</code></a></td>
<td><a href="/zh/docs/reference/param#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">username</td>
<td style="text-align:center">G</td>
<td>postgres monitor username, <code>dbuser_monitor</code> by default</td>
<td>postgres 监控用户名，默认为 <code>dbuser_monitor</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_monitor_password"><code>pg_monitor_password</code></a></td>
<td><a href="/zh/docs/reference/param#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">password</td>
<td style="text-align:center">G</td>
<td>postgres monitor password, <code>DBUser.Monitor</code> by default</td>
<td>postgres 监控密码，默认为 <code>DBUser.Monitor</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_dbsu_password"><code>pg_dbsu_password</code></a></td>
<td><a href="/zh/docs/reference/param#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">password</td>
<td style="text-align:center">G/C</td>
<td>dbsu password, empty string means no dbsu password by default</td>
<td>dbsu 密码，默认为空字符串意味着不设置 dbsu 密码，最好不要设置。</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_dbsu"><code>pg_dbsu</code></a></td>
<td><a href="/zh/docs/reference/param#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">username</td>
<td style="text-align:center">C</td>
<td>os dbsu name, postgres by default, better not change it</td>
<td>操作系统 dbsu 名称，默认为 postgres，最好不要更改</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_dbsu_uid"><code>pg_dbsu_uid</code></a></td>
<td><a href="/zh/docs/reference/param#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">C</td>
<td>os dbsu uid and gid, 26 for default postgres users and groups</td>
<td>操作系统 dbsu uid 和 gid，对于默认的 postgres 用户和组为 26</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_dbsu_sudo"><code>pg_dbsu_sudo</code></a></td>
<td><a href="/zh/docs/reference/param#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>dbsu sudo privilege, none,limit,all,nopass. limit by default</td>
<td>dbsu sudo 权限, none,limit,all,nopass，默认为 limit，有限sudo权限</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_dbsu_home"><code>pg_dbsu_home</code></a></td>
<td><a href="/zh/docs/reference/param#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>postgresql home directory, <code>/var/lib/pgsql</code> by default</td>
<td>postgresql 主目录，默认为 <code>/var/lib/pgsql</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_dbsu_ssh_exchange"><code>pg_dbsu_ssh_exchange</code></a></td>
<td><a href="/zh/docs/reference/param#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>exchange postgres dbsu ssh key among same pgsql cluster</td>
<td>在 pgsql 集群之间交换 postgres dbsu ssh 密钥</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_version"><code>pg_version</code></a></td>
<td><a href="/zh/docs/reference/param#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>postgres major version to be installed, 15 by default</td>
<td>要安装的 postgres 主版本，默认为 15</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_bin_dir"><code>pg_bin_dir</code></a></td>
<td><a href="/zh/docs/reference/param#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>postgres binary dir, <code>/usr/pgsql/bin</code> by default</td>
<td>postgres 二进制目录，默认为 <code>/usr/pgsql/bin</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_log_dir"><code>pg_log_dir</code></a></td>
<td><a href="/zh/docs/reference/param#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>postgres log dir, <code>/pg/log/postgres</code> by default</td>
<td>postgres 日志目录，默认为 <code>/pg/log/postgres</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_packages"><code>pg_packages</code></a></td>
<td><a href="/zh/docs/reference/param#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">string[]</td>
<td style="text-align:center">C</td>
<td>pg packages to be installed, <code>${pg_version}</code> will be replaced</td>
<td>要安装的 pg 包，<code>${pg_version}</code> 将被替换为实际主版本号</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_extensions"><code>pg_extensions</code></a></td>
<td><a href="/zh/docs/reference/param#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">string[]</td>
<td style="text-align:center">C</td>
<td>pg extensions to be installed, <code>${pg_version}</code> will be replaced</td>
<td>要安装的 pg 扩展，<code>${pg_version}</code> 将被替换为实际主版本号</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_safeguard"><code>pg_safeguard</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">G/C/A</td>
<td>prevent purging running postgres instance? false by default</td>
<td>防误删保险，禁止清除正在运行的 postgres 实例？默认为 false</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_clean"><code>pg_clean</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">G/C/A</td>
<td>purging existing postgres during pgsql init? true by default</td>
<td>在 pgsql 初始化期间清除现有的 postgres？默认为 true</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_data"><code>pg_data</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>postgres data directory, <code>/pg/data</code> by default</td>
<td>postgres 数据目录，默认为 <code>/pg/data</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_fs_main"><code>pg_fs_main</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>mountpoint/path for postgres main data, <code>/data</code> by default</td>
<td>postgres 主数据的挂载点/路径，默认为 <code>/data</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_fs_bkup"><code>pg_fs_bkup</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>mountpoint/path for pg backup data, <code>/data/backup</code> by default</td>
<td>pg 备份数据的挂载点/路径，默认为 <code>/data/backup</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_storage_type"><code>pg_storage_type</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>storage type for pg main data, SSD,HDD, SSD by default</td>
<td>pg 主数据的存储类型，SSD、HDD，默认为 SSD，影响自动优化的参数。</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_dummy_filesize"><code>pg_dummy_filesize</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">size</td>
<td style="text-align:center">C</td>
<td>size of <code>/pg/dummy</code>, hold 64MB disk space for emergency use</td>
<td><code>/pg/dummy</code> 的大小，默认保留 64MB 磁盘空间用于紧急抢修</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_listen"><code>pg_listen</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">ip(s)</td>
<td style="text-align:center">C/I</td>
<td>postgres/pgbouncer listen addresses, comma separated list</td>
<td>postgres/pgbouncer 的监听地址，用逗号分隔的IP列表，默认为 <code>0.0.0.0</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_port"><code>pg_port</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">port</td>
<td style="text-align:center">C</td>
<td>postgres listen port, 5432 by default</td>
<td>postgres 监听端口，默认为 5432</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_localhost"><code>pg_localhost</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>postgres unix socket dir for localhost connection</td>
<td>postgres 的 Unix 套接字目录，用于本地连接</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_namespace"><code>pg_namespace</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>top level key namespace in etcd, used by patroni &amp; vip</td>
<td>在 etcd 中的顶级键命名空间，被 patroni &amp; vip 用于高可用管理</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#patroni_enabled"><code>patroni_enabled</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>if disabled, no postgres cluster will be created during init</td>
<td>如果禁用，初始化期间不会创建 postgres 集群</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#patroni_mode"><code>patroni_mode</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>patroni working mode: default,pause,remove</td>
<td>patroni 工作模式：default,pause,remove</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#patroni_port"><code>patroni_port</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">port</td>
<td style="text-align:center">C</td>
<td>patroni listen port, 8008 by default</td>
<td>patroni 监听端口，默认为 8008</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#patroni_log_dir"><code>patroni_log_dir</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>patroni log dir, <code>/pg/log/patroni</code> by default</td>
<td>patroni 日志目录，默认为 <code>/pg/log/patroni</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#patroni_ssl_enabled"><code>patroni_ssl_enabled</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">G</td>
<td>secure patroni RestAPI communications with SSL?</td>
<td>使用 SSL 保护 patroni RestAPI 通信？</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#patroni_watchdog_mode"><code>patroni_watchdog_mode</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>patroni watchdog mode: automatic,required,off. off by default</td>
<td>patroni 看门狗模式：automatic,required,off，默认为 off</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#patroni_username"><code>patroni_username</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">username</td>
<td style="text-align:center">C</td>
<td>patroni restapi username, <code>postgres</code> by default</td>
<td>patroni restapi 用户名，默认为 <code>postgres</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#patroni_password"><code>patroni_password</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">password</td>
<td style="text-align:center">C</td>
<td>patroni restapi password, <code>Patroni.API</code> by default</td>
<td>patroni restapi 密码，默认为 <code>Patroni.API</code></td>
</tr>
<tr>
<td><a href="/zh/docs/pgsql/#pg_primary_db"><code>pg_primary_db</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>指定集群中首要使用的数据库名，Citus等模式会用到，默认为 <code>postgres</code></td>
<td></td>
</tr>
<tr>
<td><a href="/zh/docs/pgsql/#pg_parameters"><code>pg_parameters</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">dict</td>
<td style="text-align:center">C</td>
<td>覆盖 postgresql.auto.conf 中的 PostgreSQL 参数</td>
<td></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_conf"><code>pg_conf</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>config template: oltp,olap,crit,tiny. <code>oltp.yml</code> by default</td>
<td>配置模板：oltp,olap,crit,tiny，默认为 <code>oltp.yml</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_max_conn"><code>pg_max_conn</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">C</td>
<td>postgres max connections, <code>auto</code> will use recommended value</td>
<td>postgres 最大连接数，<code>auto</code> 将使用推荐值</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_shared_buffer_ratio"><code>pg_shared_buffer_ratio</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">float</td>
<td style="text-align:center">C</td>
<td>postgres shared buffer memory ratio, 0.25 by default, 0.1~0.4</td>
<td>postgres 共享缓冲区内存比率，默认为 0.25，范围 0.1~0.4</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_rto"><code>pg_rto</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">C</td>
<td>recovery time objective in seconds, <code>30s</code> by default</td>
<td>恢复时间目标（秒），默认为 <code>30s</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_rpo"><code>pg_rpo</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">C</td>
<td>recovery point objective in bytes, <code>1MiB</code> at most by default</td>
<td>恢复点目标（字节），默认为 <code>1MiB</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_libs"><code>pg_libs</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>preloaded libraries, <code>timescaledb,pg_stat_statements,auto_explain</code> by default</td>
<td>预加载的库，默认为 <code>timescaledb,pg_stat_statements,auto_explain</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_delay"><code>pg_delay</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">interval</td>
<td style="text-align:center">I</td>
<td>replication apply delay for standby cluster leader</td>
<td>备份集群主库的WAL重放应用延迟，用于制备延迟从库</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_checksum"><code>pg_checksum</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>enable data checksum for postgres cluster?</td>
<td>为 postgres 集群启用数据校验和？</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_pwd_enc"><code>pg_pwd_enc</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>passwords encryption algorithm: md5,scram-sha-256</td>
<td>密码加密算法：md5,scram-sha-256</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_encoding"><code>pg_encoding</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>database cluster encoding, <code>UTF8</code> by default</td>
<td>数据库集群编码，默认为 <code>UTF8</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_locale"><code>pg_locale</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>database cluster local, <code>C</code> by default</td>
<td>数据库集群本地化设置，默认为 <code>C</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_lc_collate"><code>pg_lc_collate</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>database cluster collate, <code>C</code> by default</td>
<td>数据库集群排序，默认为 <code>C</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_lc_ctype"><code>pg_lc_ctype</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>database character type, <code>en_US.UTF8</code> by default</td>
<td>数据库字符类型，默认为 <code>en_US.UTF8</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgbouncer_enabled"><code>pgbouncer_enabled</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>if disabled, pgbouncer will not be launched on pgsql host</td>
<td>如果禁用，则不会配置 pgbouncer 连接池</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgbouncer_port"><code>pgbouncer_port</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">port</td>
<td style="text-align:center">C</td>
<td>pgbouncer listen port, 6432 by default</td>
<td>pgbouncer 监听端口，默认为 6432</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgbouncer_log_dir"><code>pgbouncer_log_dir</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>pgbouncer log dir, <code>/pg/log/pgbouncer</code> by default</td>
<td>pgbouncer 日志目录，默认为 <code>/pg/log/pgbouncer</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgbouncer_auth_query"><code>pgbouncer_auth_query</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>query postgres to retrieve unlisted business users?</td>
<td>使用 AuthQuery 来从 postgres 获取未列出的业务用户？</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgbouncer_poolmode"><code>pgbouncer_poolmode</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>pooling mode: transaction,session,statement, transaction by default</td>
<td>池化模式：transaction,session,statement，默认为 transaction</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgbouncer_sslmode"><code>pgbouncer_sslmode</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>pgbouncer client ssl mode, disable by default</td>
<td>pgbouncer 客户端 SSL 模式，默认为禁用</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_provision"><code>pg_provision</code></a></td>
<td><a href="/zh/docs/reference/param#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>provision postgres cluster after bootstrap</td>
<td>在引导后置备 postgres 集群内部的业务对象？</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_init"><code>pg_init</code></a></td>
<td><a href="/zh/docs/reference/param#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">G/C</td>
<td>provision init script for cluster template, <code>pg-init</code> by default</td>
<td>为集群模板提供初始化脚本，默认为 <code>pg-init</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_default_roles"><code>pg_default_roles</code></a></td>
<td><a href="/zh/docs/reference/param#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">role[]</td>
<td style="text-align:center">G/C</td>
<td>default roles and users in postgres cluster</td>
<td>postgres 集群中的默认预定义角色和系统用户</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_default_privileges"><code>pg_default_privileges</code></a></td>
<td><a href="/zh/docs/reference/param#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">string[]</td>
<td style="text-align:center">G/C</td>
<td>default privileges when created by admin user</td>
<td>由管理员用户创建数据库内对象时的默认权限</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_default_schemas"><code>pg_default_schemas</code></a></td>
<td><a href="/zh/docs/reference/param#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">string[]</td>
<td style="text-align:center">G/C</td>
<td>default schemas to be created</td>
<td>要创建的默认模式列表</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_default_extensions"><code>pg_default_extensions</code></a></td>
<td><a href="/zh/docs/reference/param#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">extension[]</td>
<td style="text-align:center">G/C</td>
<td>default extensions to be created</td>
<td>要创建的默认扩展列表</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_reload"><code>pg_reload</code></a></td>
<td><a href="/zh/docs/reference/param#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">A</td>
<td>reload postgres after hba changes</td>
<td>更改HBA后，是否立即重载 postgres 配置</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_default_hba_rules"><code>pg_default_hba_rules</code></a></td>
<td><a href="/zh/docs/reference/param#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">hba[]</td>
<td style="text-align:center">G/C</td>
<td>postgres default host-based authentication rules</td>
<td>postgres 基于主机的认证规则，全局PG默认HBA</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgb_default_hba_rules"><code>pgb_default_hba_rules</code></a></td>
<td><a href="/zh/docs/reference/param#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">hba[]</td>
<td style="text-align:center">G/C</td>
<td>pgbouncer default host-based authentication rules</td>
<td>pgbouncer 默认的基于主机的认证规则，全局PGB默认HBA</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgbackrest_enabled"><code>pgbackrest_enabled</code></a></td>
<td><a href="/zh/docs/reference/param#pg_backup"><code>PG_BACKUP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>enable pgbackrest on pgsql host?</td>
<td>在 pgsql 主机上启用 pgbackrest？</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgbackrest_clean"><code>pgbackrest_clean</code></a></td>
<td><a href="/zh/docs/reference/param#pg_backup"><code>PG_BACKUP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>remove pg backup data during init?</td>
<td>在初始化时删除以前的 pg 备份数据？</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgbackrest_log_dir"><code>pgbackrest_log_dir</code></a></td>
<td><a href="/zh/docs/reference/param#pg_backup"><code>PG_BACKUP</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>pgbackrest log dir, <code>/pg/log/pgbackrest</code> by default</td>
<td>pgbackrest 日志目录，默认为 <code>/pg/log/pgbackrest</code></td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgbackrest_method"><code>pgbackrest_method</code></a></td>
<td><a href="/zh/docs/reference/param#pg_backup"><code>PG_BACKUP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>pgbackrest repo method: local,minio,etc&hellip;</td>
<td>pgbackrest 使用的仓库：local,minio,等&hellip;</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgbackrest_repo"><code>pgbackrest_repo</code></a></td>
<td><a href="/zh/docs/reference/param#pg_backup"><code>PG_BACKUP</code></a></td>
<td style="text-align:center">dict</td>
<td style="text-align:center">G/C</td>
<td>pgbackrest repo: <a href="https://pgbackrest.org/configuration.html#section-repository">https://pgbackrest.org/configuration.html#section-repository</a></td>
<td>pgbackrest 仓库定义：https://pgbackrest.org/configuration.html#section-repository</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_weight"><code>pg_weight</code></a></td>
<td><a href="/zh/docs/reference/param#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">I</td>
<td>relative load balance weight in service, 100 by default, 0-255</td>
<td>在服务中的相对负载均衡权重，默认为 100，范围 0-255</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_service_provider"><code>pg_service_provider</code></a></td>
<td><a href="/zh/docs/reference/param#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">G/C</td>
<td>dedicate haproxy node group name, or empty string for local nodes by default</td>
<td>专用的 haproxy 节点组名称，或默认空字符，使用本地节点上的 haproxy</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_default_service_dest"><code>pg_default_service_dest</code></a></td>
<td><a href="/zh/docs/reference/param#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">G/C</td>
<td>default service destination if svc.dest=&lsquo;default&rsquo;</td>
<td>如果 svc.dest=&lsquo;default&rsquo;，默认服务指向哪里？postgres 或 pgbouncer，默认指向 pgbouncer</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_default_services"><code>pg_default_services</code></a></td>
<td><a href="/zh/docs/reference/param#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">service[]</td>
<td style="text-align:center">G/C</td>
<td>postgres default service definitions</td>
<td>postgres 默认服务定义列表，全局共用。</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_vip_enabled"><code>pg_vip_enabled</code></a></td>
<td><a href="/zh/docs/reference/param#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>enable a l2 vip for pgsql primary? false by default</td>
<td>是否为 pgsql 主节点启用 L2 VIP？默认不启用</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_vip_address"><code>pg_vip_address</code></a></td>
<td><a href="/zh/docs/reference/param#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">cidr4</td>
<td style="text-align:center">C</td>
<td>vip address in <code>&lt;ipv4&gt;/&lt;mask&gt;</code> format, require if vip is enabled</td>
<td>vip 地址的格式为 <ipv4>/<mask>，启用 vip 时为必选参数</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_vip_interface"><code>pg_vip_interface</code></a></td>
<td><a href="/zh/docs/reference/param#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C/I</td>
<td>vip network interface to listen, eth0 by default</td>
<td>监听的 vip 网络接口，默认为 eth0</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_dns_suffix"><code>pg_dns_suffix</code></a></td>
<td><a href="/zh/docs/reference/param#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>pgsql dns suffix, &rsquo;&rsquo; by default</td>
<td>pgsql dns 后缀，默认为空</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_dns_target"><code>pg_dns_target</code></a></td>
<td><a href="/zh/docs/reference/param#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>auto, primary, vip, none, or ad hoc ip</td>
<td>PG DNS 解析到哪里？auto、primary、vip、none 或者特定的 IP 地址</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_exporter_enabled"><code>pg_exporter_enabled</code></a></td>
<td><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>enable pg_exporter on pgsql hosts?</td>
<td>在 pgsql 主机上启用 pg_exporter 吗？</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_exporter_config"><code>pg_exporter_config</code></a></td>
<td><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>pg_exporter configuration file name</td>
<td>pg_exporter 配置文件/模板名称</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_exporter_cache_ttls"><code>pg_exporter_cache_ttls</code></a></td>
<td><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>pg_exporter collector ttl stage in seconds, &lsquo;1,10,60,300&rsquo; by default</td>
<td>pg_exporter 收集器阶梯TTL配置，默认为4个由逗号分隔的秒数：&lsquo;1,10,60,300&rsquo;</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_exporter_port"><code>pg_exporter_port</code></a></td>
<td><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">port</td>
<td style="text-align:center">C</td>
<td>pg_exporter listen port, 9630 by default</td>
<td>pg_exporter 监听端口，默认为 9630</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_exporter_params"><code>pg_exporter_params</code></a></td>
<td><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>extra url parameters for pg_exporter dsn</td>
<td>pg_exporter dsn 中传入的额外 URL 参数</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_exporter_url"><code>pg_exporter_url</code></a></td>
<td><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">pgurl</td>
<td style="text-align:center">C</td>
<td>overwrite auto-generate pg dsn if specified</td>
<td>如果指定，则覆盖自动生成的 postgres DSN 连接串</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_exporter_auto_discovery"><code>pg_exporter_auto_discovery</code></a></td>
<td><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>enable auto database discovery? enabled by default</td>
<td>监控是否启用自动数据库发现？默认启用</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_exporter_exclude_database"><code>pg_exporter_exclude_database</code></a></td>
<td><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>csv of database that WILL NOT be monitored during auto-discovery</td>
<td>启用自动发现时，排除在外的数据库名称列表，用逗号分隔</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_exporter_include_database"><code>pg_exporter_include_database</code></a></td>
<td><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>csv of database that WILL BE monitored during auto-discovery</td>
<td>启用自动发现时，只监控这个列表中的数据库，名称用逗号分隔</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_exporter_connect_timeout"><code>pg_exporter_connect_timeout</code></a></td>
<td><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">C</td>
<td>pg_exporter connect timeout in ms, 200 by default</td>
<td>pg_exporter 连接超时，单位毫秒，默认为 200</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pg_exporter_options"><code>pg_exporter_options</code></a></td>
<td><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">arg</td>
<td style="text-align:center">C</td>
<td>overwrite extra options for pg_exporter</td>
<td>pg_exporter 的额外命令行参数选项</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgbouncer_exporter_enabled"><code>pgbouncer_exporter_enabled</code></a></td>
<td><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>enable pgbouncer_exporter on pgsql hosts?</td>
<td>在 pgsql 主机上启用 pgbouncer_exporter 吗？</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgbouncer_exporter_port"><code>pgbouncer_exporter_port</code></a></td>
<td><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">port</td>
<td style="text-align:center">C</td>
<td>pgbouncer_exporter listen port, 9631 by default</td>
<td>pgbouncer_exporter 监听端口，默认为 9631</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgbouncer_exporter_url"><code>pgbouncer_exporter_url</code></a></td>
<td><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">pgurl</td>
<td style="text-align:center">C</td>
<td>overwrite auto-generate pgbouncer dsn if specified</td>
<td>如果指定，则覆盖自动生成的 pgbouncer dsn 连接串</td>
</tr>
<tr>
<td><a href="/zh/docs/reference/param#pgbouncer_exporter_options"><code>pgbouncer_exporter_options</code></a></td>
<td><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">arg</td>
<td style="text-align:center">C</td>
<td>overwrite extra options for pgbouncer_exporter</td>
<td>pgbouncer_exporter 的额外命令行参数选项</td>
</tr>
</tbody>
</table>
</details>
<hr>
<h2 id="教程">教程</h2>
<blockquote>
<p>一些使用/管理 Pigsty中 PostgreSQL 数据库的教程。</p>
</blockquote>
<ul>
<li>克隆一套现有的 PostgreSQL 集群</li>
<li>创建一套现有 PostgreSQL 集群的在线备份集群。</li>
<li>创建一套现有 PostgreSQL 集群的延迟备份集群</li>
<li>监控一个已有的 postgres 实例？</li>
<li>使用逻辑复制从外部 PostgreSQL 迁移至 Pigsty 托管的 PostgreSQL 实例？</li>
<li>使用 MinIO 作为集中的 pgBackRest 备份仓库。</li>
<li>使用专门的 etcd 集群作为 PostgreSQL / Patroni 的 DCS ？</li>
<li>使用专用的 haproxy 负载均衡器集群对外暴露暴露 PostgreSQL 服务。</li>
<li>使用 pg-meta CMDB 替代 pigsty.yml 作为配置清单源。</li>
<li>使用 PostgreSQL 作为 Grafana 的后端存储数据库？</li>
<li>使用 PostgreSQL 作为 Prometheus 后端存储数据库？</li>
</ul>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e568caeba7bea980f92135e0b27b60d5">1 - 核心概念</h1>
    <div class="lead">介绍 PostgreSQL 集群的中涉及到的重要概念</div>
	<blockquote>
<p>PGSQL 模块总览：关键概念与架构细节</p>
</blockquote>
<p>PGSQL模块在生产环境中以<strong>集群</strong>的形式组织，这些<strong>集群</strong>是由一组由<strong>主-备</strong>关联的数据库<strong>实例</strong>组成的<strong>逻辑实体</strong>。
每个<strong>数据库集群</strong>都是一个<strong>自治</strong>的业务服务单元，由至少一个 <strong>数据库（主库）实例</strong> 组成。</p>
<hr>
<h2 id="实体概念图">实体概念图</h2>
<p>让我们从ER图开始。在Pigsty的PGSQL模块中，有四种核心实体：</p>
<ul>
<li><strong>集群</strong>（Cluster）：自治的PostgreSQL业务单元，用作其他实体的顶级命名空间。</li>
<li><strong>服务</strong>（Service）：集群能力的命名抽象，路由流量，并使用节点端口暴露postgres服务。</li>
<li><strong>实例</strong>（Instance）：一个在单个节点上的运行进程和数据库文件组成的单一postgres服务器。</li>
<li><strong>节点</strong>（Node）：硬件资源的抽象，可以是裸金属、虚拟机或甚至是k8s pods。</li>
</ul>
<p><img alt="pigsty-er.jpg" src="/img/pigsty/er.jpg"></p>
<p><strong>命名约定</strong></p>
<ul>
<li>集群名应为有效的 DNS 域名，不包含任何点号，正则表达式为：<code>[a-zA-Z0-9-]+</code></li>
<li>服务名应以集群名为前缀，并以特定单词作为后缀：<code>primary</code>、<code>replica</code>、<code>offline</code>、<code>delayed</code>，中间用<code>-</code>连接。</li>
<li>实例名以集群名为前缀，以正整数实例号为后缀，用<code>-</code>连接，例如<code>${cluster}-${seq}</code>。</li>
<li>节点由其首要内网IP地址标识，因为PGSQL模块中数据库与主机1:1部署，所以主机名通常与实例名相同。</li>
</ul>
<hr>
<h2 id="身份参数">身份参数</h2>
<p>Pigsty使用<strong>身份参数</strong>来识别实体：<a href="/zh/docs/reference/param#pg_id"><code>PG_ID</code></a>。</p>
<p>除了节点IP地址，<a href="/zh/docs/reference/param#pg_cluster"><code>pg_cluster</code></a>、<a href="/zh/docs/reference/param#pg_role"><code>pg_role</code></a>和<a href="/zh/docs/reference/param#pg_seq"><code>pg_seq</code></a>三个参数是定义postgres集群所必需的最小参数集。
以<a href="/zh/docs/setup/provision#%E6%B2%99%E7%AE%B1%E7%8E%AF%E5%A2%83">沙箱环境</a>测试集群<code>pg-test</code>为例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 3, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>集群的三个成员如下所示：</p>
<table>
<thead>
<tr>
<th style="text-align:center">集群</th>
<th style="text-align:center">序号</th>
<th style="text-align:center">角色</th>
<th style="text-align:center">主机 / IP</th>
<th style="text-align:center">实例</th>
<th style="text-align:center">服务</th>
<th style="text-align:center">节点名</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>pg-test</code></td>
<td style="text-align:center"><code>1</code></td>
<td style="text-align:center"><code>primary</code></td>
<td style="text-align:center"><code>10.10.10.11</code></td>
<td style="text-align:center"><code>pg-test-1</code></td>
<td style="text-align:center"><code>pg-test-primary</code></td>
<td style="text-align:center"><code>pg-test-1</code></td>
</tr>
<tr>
<td style="text-align:center"><code>pg-test</code></td>
<td style="text-align:center"><code>2</code></td>
<td style="text-align:center"><code>replica</code></td>
<td style="text-align:center"><code>10.10.10.12</code></td>
<td style="text-align:center"><code>pg-test-2</code></td>
<td style="text-align:center"><code>pg-test-replica</code></td>
<td style="text-align:center"><code>pg-test-2</code></td>
</tr>
<tr>
<td style="text-align:center"><code>pg-test</code></td>
<td style="text-align:center"><code>3</code></td>
<td style="text-align:center"><code>replica</code></td>
<td style="text-align:center"><code>10.10.10.13</code></td>
<td style="text-align:center"><code>pg-test-3</code></td>
<td style="text-align:center"><code>pg-test-replica</code></td>
<td style="text-align:center"><code>pg-test-3</code></td>
</tr>
</tbody>
</table>
<p>这里包含了：</p>
<ul>
<li>一个集群：该集群命名为<code>pg-test</code>。</li>
<li>两种角色：<code>primary</code>和<code>replica</code>。</li>
<li>三个实例：集群由三个实例组成：<code>pg-test-1</code>、<code>pg-test-2</code>、<code>pg-test-3</code>。</li>
<li>三个节点：集群部署在三个节点上：<code>10.10.10.11</code>、<code>10.10.10.12</code>和<code>10.10.10.13</code>。</li>
<li>四个服务：
<ul>
<li>读写服务：<a href="/zh/docs/pgsql/svc#primary%E6%9C%8D%E5%8A%A1"><code>pg-test-primary</code></a></li>
<li>只读服务：<a href="/zh/docs/pgsql/svc#replica%E6%9C%8D%E5%8A%A1"><code>pg-test-replica</code></a></li>
<li>直接连接的管理服务：<a href="/zh/docs/pgsql/svc#default%E6%9C%8D%E5%8A%A1"><code>pg-test-default</code></a></li>
<li>离线读服务：<a href="/zh/docs/pgsql/svc#offline%E6%9C%8D%E5%8A%A1"><code>pg-test-offline</code></a></li>
</ul>
</li>
</ul>
<p>在监控系统（Prometheus/Grafana/Loki）中，相应的指标将会使用这些身份参数进行标记：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">pg_up{cls=&#34;pg-meta&#34;, ins=&#34;pg-meta-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;pgsql&#34;}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">pg_up{cls=&#34;pg-test&#34;, ins=&#34;pg-test-1&#34;, ip=&#34;10.10.10.11&#34;, job=&#34;pgsql&#34;}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">pg_up{cls=&#34;pg-test&#34;, ins=&#34;pg-test-2&#34;, ip=&#34;10.10.10.12&#34;, job=&#34;pgsql&#34;}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">pg_up{cls=&#34;pg-test&#34;, ins=&#34;pg-test-3&#34;, ip=&#34;10.10.10.13&#34;, job=&#34;pgsql&#34;}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="组件概览">组件概览</h2>
<p>以下是 PostgreSQL 模块组件及其相互作用的详细描述，从上至下分别为：</p>
<ul>
<li>集群 DNS 由 infra 节点上的 DNSMASQ 负责解析</li>
<li>集群 VIP 由 <code>vip-manager</code> 组件管理，它负责将 <a href="/zh/docs/reference/param#pg_vip_address"><code>pg_vip_address</code></a> 绑定到集群主库节点上。
<ul>
<li><code>vip-manager</code> 从 <code>etcd</code> 集群获取由 <code>patroni</code> 写入的集群领导者信息</li>
</ul>
</li>
<li>集群服务由节点上的 Haproxy 对外暴露，不同服务通过节点的不同端口（543x）区分。
<ul>
<li>Haproxy 端口 9101：监控指标 &amp; 统计 &amp; 管理页面</li>
<li>Haproxy 端口 5433：默认路由至主 pgbouncer：<a href="/zh/docs/pgsql/svc#primary%E6%9C%8D%E5%8A%A1">读写服务</a></li>
<li>Haproxy 端口 5434：默认路由至从库 pgbouncer：<a href="/zh/docs/pgsql/svc#replica%E6%9C%8D%E5%8A%A1">只读服务</a></li>
<li>Haproxy 端口 5436：默认路由至主 postgres：<a href="/zh/docs/pgsql/svc#default%E6%9C%8D%E5%8A%A1">默认服务</a></li>
<li>Haproxy 端口 5438：默认路由至离线 postgres：<a href="/zh/docs/pgsql/svc#offline%E6%9C%8D%E5%8A%A1">离线服务</a></li>
<li>HAProxy 将根据 <code>patroni</code> 提供的健康检查信息路由流量。</li>
</ul>
</li>
<li>Pgbouncer 是一个连接池中间件，默认监听6432端口，可以缓冲连接、暴露额外的指标，并提供额外的灵活性。
<ul>
<li>Pgbouncer 是无状态的，并通过本地 Unix 套接字以 1:1 的方式与 Postgres 服务器部署。</li>
<li>生产流量（主/从）将默认通过 pgbouncer（可以通过<a href="/zh/docs/reference/param#pg_default_service_dest"><code>pg_default_service_dest</code></a>指定跳过）</li>
<li>默认/离线服务将始终绕过 pgbouncer ，并直接连接到目标 Postgres。</li>
</ul>
</li>
<li>PostgreSQL 监听5432端口，提供关系型数据库服务
<ul>
<li>在多个节点上安装 PGSQL 模块，并使用同一集群名，将自动基于流式复制组成高可用集群</li>
<li>PostgreSQL 进程默认由 <code>patroni</code> 管理。</li>
</ul>
</li>
<li>Patroni 默认监听端口 8008，监管着 PostgreSQL 服务器进程
<ul>
<li>Patroni 将 Postgres 服务器作为子进程启动</li>
<li>Patroni 使用 <code>etcd</code> 作为 DCS：存储配置、故障检测和领导者选举。</li>
<li>Patroni 通过健康检查提供 Postgres 信息（比如主/从），HAProxy 通过健康检查使用该信息分发服务流量</li>
<li>Patroni 指标将被 infra 节点上的 Prometheus 抓取</li>
</ul>
</li>
<li>PG Exporter 在 9630 端口对外暴露 postgres 架空指标
<ul>
<li>PostgreSQL 指标将被 infra 节点上的 Prometheus 抓取</li>
</ul>
</li>
<li>Pgbouncer Exporter 在端口 9631 暴露 pgbouncer 指标
<ul>
<li>Pgbouncer 指标将被 infra 节点上的 Prometheus 抓取</li>
</ul>
</li>
<li>pgBackRest 默认在使用本地备份仓库 （<code>pgbackrest_method</code> = <code>local</code>）
<ul>
<li>如果使用 <code>local</code>（默认）作为备份仓库，pgBackRest 将在主库节点的<a href="/zh/docs/reference/param#pg_fs_bkup"><code>pg_fs_bkup</code></a> 下创建本地仓库</li>
<li>如果使用 <code>minio</code> 作为备份仓库，pgBackRest 将在专用的 MinIO 集群上创建备份仓库：<a href="/zh/docs/reference/param#pgbackrest_repo"><code>pgbackrest_repo</code>.<code>minio</code></a></li>
</ul>
</li>
<li>Postgres 相关日志（postgres, pgbouncer, patroni, pgbackrest）由 promtail 负责收集
<ul>
<li>Promtail 监听 9080 端口，也对 infra 节点上的 Prometheus 暴露自身的监控指标</li>
<li>Promtail 将日志发送至 infra 节点上的 Loki</li>
</ul>
</li>
</ul>
<p><a href="/zh/docs/infra/"><img alt="pigsty-arch.jpg" src="/img/pigsty/arch.jpg"></a></p>
<hr>
<h2 id="高可用">高可用</h2>
<blockquote>
<p>主库故障恢复时间目标 (RTO) ≈ 30s，数据恢复点目标 (RPO) &lt; 1MB，从库故障 RTO ≈ 0 (重置当前连接)</p>
</blockquote>
<p>Pigsty 的 PostgreSQL 集群带有开箱即用的高可用方案，由 <a href="https://patroni.readthedocs.io/en/latest/">patroni</a>、<a href="https://etcd.io/">etcd</a> 和 <a href="http://www.haproxy.org/">haproxy</a> 强力驱动。</p>
<p><img alt="pigsty-ha.png" src="/img/pigsty/ha.png"></p>
<p>当主库故障时，将触发新一轮领导者竞选，集群中最为健康的从库将胜出，并被提升为新的主库。读写流量将立即路由至新的主库。主库故障影响是：默认情况下写入查询将被阻塞 15 ~ 40s，直到选出新的领导者来。</p>
<p>当从库故障时，只读流量将路由至其他从库，如果所有从库都故障，只读流量才会最终由主库承载。从库故障的影响非常小：查询闪断：该从库上正在运行查询将由于连接重置而中止。</p>
<p>故障检测由 <code>patroni</code> 和 <code>etcd</code> 完成，集群领导者将持有一个租约，如果它因为故障而没有及时续租（10s），租约将会被释放，新一轮集群选举会被触发。</p>
<p>您可以使用 <a href="/zh/docs/reference/param#pg_rto"><code>pg_rto</code></a> 参数调整集群的 TTL，默认 RTO 配置为 30s，增大它将导致更长的故障转移等待时间，而减少它将增加误报故障转移率（例如，网络抖动）。</p>
<p>Pigsty 默认使用<strong>可用性优先</strong>模式，这意味着当主库故障时，它将尽快进行故障转移，尚未复制到从库的数据可能会丢失（常规万兆网络下，复制延迟在通常在几KB到100KB）。</p>
<p>最大潜在数据丢失由 <a href="/zh/docs/reference/param#pg_rpo"><code>pg_rpo</code></a> 控制，默认为 1MB，减小这个值将会减少故障恢复时的可能数据损失，但也会增加故障时因为从库不够健康（落后太久）而拒绝自动切换的概率。</p>
<p>RTO 与 RPO 是高可用集群设计时需要仔细权衡的两个参数，您应当根据您的硬件水平，网络质量，业务需求来合理调整它们。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ea3ddc89f231393b38923a59f1c6d742">2 - 系统架构</h1>
    <div class="lead">介绍 PostgreSQL 集群的整体架构与实现细节。</div>
	<blockquote>
<p>PGSQL 模块总览：关键概念与架构细节</p>
</blockquote>
<hr>
<h2 id="组件概览">组件概览</h2>
<p>以下是 PostgreSQL 模块组件及其相互作用的详细描述，从上至下分别为：</p>
<ul>
<li>集群 DNS 由 infra 节点上的 DNSMASQ 负责解析</li>
<li>集群 VIP 由 <code>vip-manager</code> 组件管理，它负责将 <a href="/zh/docs/reference/param#pg_vip_address"><code>pg_vip_address</code></a> 绑定到集群主库节点上。
<ul>
<li><code>vip-manager</code> 从 <code>etcd</code> 集群获取由 <code>patroni</code> 写入的集群领导者信息</li>
</ul>
</li>
<li>集群服务由节点上的 Haproxy 对外暴露，不同服务通过节点的不同端口（543x）区分。
<ul>
<li>Haproxy 端口 9101：监控指标 &amp; 统计 &amp; 管理页面</li>
<li>Haproxy 端口 5433：默认路由至主 pgbouncer：<a href="/zh/docs/pgsql/svc#primary%E6%9C%8D%E5%8A%A1">读写服务</a></li>
<li>Haproxy 端口 5434：默认路由至从库 pgbouncer：<a href="/zh/docs/pgsql/svc#replica%E6%9C%8D%E5%8A%A1">只读服务</a></li>
<li>Haproxy 端口 5436：默认路由至主 postgres：<a href="/zh/docs/pgsql/svc#default%E6%9C%8D%E5%8A%A1">默认服务</a></li>
<li>Haproxy 端口 5438：默认路由至离线 postgres：<a href="/zh/docs/pgsql/svc#offline%E6%9C%8D%E5%8A%A1">离线服务</a></li>
<li>HAProxy 将根据 <code>patroni</code> 提供的健康检查信息路由流量。</li>
</ul>
</li>
<li>Pgbouncer 是一个连接池中间件，默认监听6432端口，可以缓冲连接、暴露额外的指标，并提供额外的灵活性。
<ul>
<li>Pgbouncer 是无状态的，并通过本地 Unix 套接字以 1:1 的方式与 Postgres 服务器部署。</li>
<li>生产流量（主/从）将默认通过 pgbouncer（可以通过<a href="/zh/docs/reference/param#pg_default_service_dest"><code>pg_default_service_dest</code></a>指定跳过）</li>
<li>默认/离线服务将始终绕过 pgbouncer ，并直接连接到目标 Postgres。</li>
</ul>
</li>
<li>PostgreSQL 监听5432端口，提供关系型数据库服务
<ul>
<li>在多个节点上安装 PGSQL 模块，并使用同一集群名，将自动基于流式复制组成高可用集群</li>
<li>PostgreSQL 进程默认由 <code>patroni</code> 管理。</li>
</ul>
</li>
<li>Patroni 默认监听端口 8008，监管着 PostgreSQL 服务器进程
<ul>
<li>Patroni 将 Postgres 服务器作为子进程启动</li>
<li>Patroni 使用 <code>etcd</code> 作为 DCS：存储配置、故障检测和领导者选举。</li>
<li>Patroni 通过健康检查提供 Postgres 信息（比如主/从），HAProxy 通过健康检查使用该信息分发服务流量</li>
<li>Patroni 指标将被 infra 节点上的 Prometheus 抓取</li>
</ul>
</li>
<li>PG Exporter 在 9630 端口对外暴露 postgres 架空指标
<ul>
<li>PostgreSQL 指标将被 infra 节点上的 Prometheus 抓取</li>
</ul>
</li>
<li>Pgbouncer Exporter 在端口 9631 暴露 pgbouncer 指标
<ul>
<li>Pgbouncer 指标将被 infra 节点上的 Prometheus 抓取</li>
</ul>
</li>
<li>pgBackRest 默认在使用本地备份仓库 （<code>pgbackrest_method</code> = <code>local</code>）
<ul>
<li>如果使用 <code>local</code>（默认）作为备份仓库，pgBackRest 将在主库节点的<a href="/zh/docs/reference/param#pg_fs_bkup"><code>pg_fs_bkup</code></a> 下创建本地仓库</li>
<li>如果使用 <code>minio</code> 作为备份仓库，pgBackRest 将在专用的 MinIO 集群上创建备份仓库：<a href="/zh/docs/reference/param#pgbackrest_repo"><code>pgbackrest_repo</code>.<code>minio</code></a></li>
</ul>
</li>
<li>Postgres 相关日志（postgres, pgbouncer, patroni, pgbackrest）由 promtail 负责收集
<ul>
<li>Promtail 监听 9080 端口，也对 infra 节点上的 Prometheus 暴露自身的监控指标</li>
<li>Promtail 将日志发送至 infra 节点上的 Loki</li>
</ul>
</li>
</ul>
<p><a href="/zh/docs/infra/"><img alt="pigsty-arch.jpg" src="/img/pigsty/arch.jpg"></a></p>
<hr>
<h2 id="高可用">高可用</h2>
<blockquote>
<p>主库故障恢复时间目标 (RTO) ≈ 30s，数据恢复点目标 (RPO) &lt; 1MB，从库故障 RTO ≈ 0 (重置当前连接)</p>
</blockquote>
<p>Pigsty 的 PostgreSQL 集群带有开箱即用的高可用方案，由 <a href="https://patroni.readthedocs.io/en/latest/">patroni</a>、<a href="https://etcd.io/">etcd</a> 和 <a href="http://www.haproxy.org/">haproxy</a> 强力驱动。</p>
<p><img alt="pigsty-ha.png" src="/img/pigsty/ha.png"></p>
<p>当主库故障时，将触发新一轮领导者竞选，集群中最为健康的从库将胜出，并被提升为新的主库。读写流量将立即路由至新的主库。主库故障影响是：默认情况下写入查询将被阻塞 15 ~ 40s，直到选出新的领导者来。</p>
<p>当从库故障时，只读流量将路由至其他从库，如果所有从库都故障，只读流量才会最终由主库承载。从库故障的影响非常小：查询闪断：该从库上正在运行查询将由于连接重置而中止。</p>
<p>故障检测由 <code>patroni</code> 和 <code>etcd</code> 完成，集群领导者将持有一个租约，如果它因为故障而没有及时续租（10s），租约将会被释放，新一轮集群选举会被触发。</p>
<p>您可以使用 <a href="/zh/docs/reference/param#pg_rto"><code>pg_rto</code></a> 参数调整集群的 TTL，默认 RTO 配置为 30s，增大它将导致更长的故障转移等待时间，而减少它将增加误报故障转移率（例如，网络抖动）。</p>
<p>Pigsty 默认使用<strong>可用性优先</strong>模式，这意味着当主库故障时，它将尽快进行故障转移，尚未复制到从库的数据可能会丢失（常规万兆网络下，复制延迟在通常在几KB到100KB）。</p>
<p>最大潜在数据丢失由 <a href="/zh/docs/reference/param#pg_rpo"><code>pg_rpo</code></a> 控制，默认为 1MB，减小这个值将会减少故障恢复时的可能数据损失，但也会增加故障时因为从库不够健康（落后太久）而拒绝自动切换的概率。</p>
<p>RTO 与 RPO 是高可用集群设计时需要仔细权衡的两个参数，您应当根据您的硬件水平，网络质量，业务需求来合理调整它们。</p>
<hr>
<h2 id="时间点恢复">时间点恢复</h2>
<blockquote>
<p>您可以将集群恢复回滚至过去任意时刻，避免软件缺陷与人为失误导致的数据损失。</p>
</blockquote>
<p>Pigsty 的 PostgreSQL 集群带有自动配置的时间点恢复（PITR）方案，基于 <a href="https://pgbackrest.org/">pgBackRest</a> 与可选的 <a href="https://min.io/">MinIO</a>。</p>
<p>高可用可以解决硬件故障，软件缺陷与人为失误导致的数据删除/覆盖写入却无能为力：因为变更操作会立即同步至从库应用。时间点恢复（Point in Time Recovery, PITR）可以解决这个问题。此外当您只有单个实例时，PITR也可以代替高可用，为最坏的情况兜底。</p>
<p>如果想将集群恢复至某个备份，用户需要提前定期做好基础备份，如果想将集群恢复至任意时间点，用户还需要从备份时刻迄今的 WAL归档。这两项工作 Pigsty 为您自动进行了兜底配置。
Pigsty 使用 pgBackRest 管理备份，接受WAL归档，执行PITR。备份仓库可以进行灵活配置（<a href="/zh/docs/reference/param#pgbackrest_repo"><code>pgbackrest_repo</code></a>）：默认使用主库本地文件系统（<code>local</code>），但也可以使用其他磁盘路径，或使用自带的可选 <a href="/zh/docs/minio">MinIO</a> 服务（<code>minio</code>）与云上 S3 服务。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pgbackrest_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># 在 pgsql 主机上启用 pgBackRest 吗？</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgbackrest_clean</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># 初始化时删除 pg 备份数据？</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgbackrest_log_dir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/pg/log/pgbackrest</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pgbackrest 日志目录，默认为 `/pg/log/pgbackrest`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgbackrest_method</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">local         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pgbackrest 仓库方法：local, minio, [用户定义...]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgbackrest_repo</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># pgbackrest 仓库：https://pgbackrest.org/configuration.html#section-repository</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">local</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># 默认使用本地 posix 文件系统的 pgbackrest 仓库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/pg/backup             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 本地备份目录，默认为 `/pg/backup`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">retention_full_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">count   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 按计数保留完整备份</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">retention_full</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># 使用本地文件系统仓库时，最多保留 3 个完整备份，至少保留 2 个</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">minio</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># pgbackrest 的可选 minio 仓库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3                     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio 是与 s3 兼容的，所以使用 s3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sss.pigsty      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio 端点域名，默认为 `sss.pigsty`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">us-east-1         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio 区域，默认为 us-east-1，对 minio 无效</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_bucket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio 桶名称，默认为 `pgsql`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbackrest           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pgbackrest 的 minio 用户访问密钥</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_key_secret</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">S3User.Backup </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pgbackrest 的 minio 用户秘密密钥</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_uri_style</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 对 minio 使用路径风格的 uri，而不是主机风格</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/pgbackrest            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio 备份路径，默认为 `/pgbackrest`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">storage_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9000</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># minio 端口，默认为 9000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">storage_ca_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/pki/ca.crt </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio ca 文件路径，默认为 `/etc/pki/ca.crt`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">bundle</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">y</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># 将小文件打包成一个文件</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">cipher_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aes-256-cbc     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 为远程备份仓库启用 AES 加密</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">cipher_pass</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgBackRest      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># AES 加密密码，默认为 &#39;pgBackRest&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">retention_full_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">time    </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 在 minio 仓库上按时间保留完整备份</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">retention_full</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># 保留过去 14 天的完整备份</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>默认情况下，Pigsty提供了两种预置<a href="/zh/docs/pgsql/pitr#%E5%A4%87%E4%BB%BD%E7%AD%96%E7%95%A5">备份策略</a>：默认使用本地文件系统备份仓库，在这种情况下每天进行一次全量备份，确保用户任何时候都能回滚至一天内的任意时间点。备选策略使用专用的 MinIO 集群或S3存储备份，每周一全备，每天一增备，默认保留两周的备份与WAL归档。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-85b6224145fe3fe5038c58a93cf9de21">3 - 用户/角色</h1>
    <div class="lead">用户/角色指的是使用 SQL 命令 <code>CREATE USER/ROLE</code> 创建的，数据库集簇内的逻辑对象。</div>
	<blockquote>
<p>在这里的上下文中，用户指的是使用 SQL 命令 <code>CREATE USER/ROLE</code> 创建的，数据库集簇内的逻辑对象。</p>
</blockquote>
<p>在PostgreSQL中，用户直接隶属于数据库集簇而非某个具体的数据库。因此在创建业务数据库和业务用户时，应当遵循&quot;先用户，后数据库&quot;的原则。</p>
<hr>
<h2 id="定义用户">定义用户</h2>
<p>Pigsty通过两个配置参数定义数据库集群中的角色与用户：</p>
<ul>
<li><a href="/zh/docs/reference/param#pg_default_roles"><code>pg_default_roles</code></a>：定义全局统一使用的角色和用户</li>
<li><a href="/zh/docs/reference/param#pg_users"><code>pg_users</code></a>：在数据库集群层面定义业务用户和角色</li>
</ul>
<p>前者用于定义了整套环境中共用的角色与用户，后者定义单个集群中特有的业务角色与用户。二者形式相同，均为用户定义对象的数组。</p>
<p>你可以定义多个用户/角色，它们会按照先全局，后集群，最后按数组内排序的顺序依次创建，所以后面的用户可以属于前面定义的角色。</p>
<p>下面是 Pigsty 演示环境中默认集群 <code>pg-meta</code> 中的业务用户定义：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_meta     ,password: DBUser.Meta     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">read-only viewer for meta database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_grafana  ,password: DBUser.Grafana  ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for grafana database    }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_bytebase ,password: DBUser.Bytebase ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for bytebase database   }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_kong     ,password: DBUser.Kong     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for kong api gateway    }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_gitea    ,password: DBUser.Gitea    ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for gitea service       }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_wiki     ,password: DBUser.Wiki     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for wiki.js service     }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_noco     ,password: DBUser.Noco     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for nocodb service      }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>每个用户/角色定义都是一个 object，可能包括以下字段，以 <code>dbuser_meta</code> 用户为例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_meta              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 必需，`name` 是用户定义的唯一必选字段</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Meta          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，密码，可以是 scram-sha-256 哈希字符串或明文</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">login</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># 可选，默认情况下可以登录</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">superuser</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># 可选，默认为 false，是超级用户吗？</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">createdb</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># 可选，默认为 false，可以创建数据库吗？</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">createrole</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic"># 可选，默认为 false，可以创建角色吗？</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">inherit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># 可选，默认情况下，此角色可以使用继承的权限吗？</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replication</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic"># 可选，默认为 false，此角色可以进行复制吗？</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bypassrls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># 可选，默认为 false，此角色可以绕过行级安全吗？</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pgbouncer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># 可选，默认为 false，将此用户添加到 pgbouncer 用户列表吗？（使用连接池的生产用户应该显式定义为 true）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># 可选，用户连接限制，默认 -1 禁用限制</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">expire_in</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3650</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># 可选，此角色过期时间：从创建时 + n天计算（优先级比 expire_at 更高）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">expire_at</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;2030-12-31&#39;</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># 可选，此角色过期的时间点，使用 YYYY-MM-DD 格式的字符串指定一个特定日期（优先级没 expire_in 高）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty admin user     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，此用户/角色的说明与备注字符串</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">dbrole_admin]          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，默认角色为：dbrole_{admin,readonly,readwrite,offline}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># 可选，使用 `ALTER ROLE SET` 针对这个角色，配置角色级的数据库参数</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">transaction         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，默认为 transaction 的 pgbouncer 池模式，用户级别</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool_connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic"># 可选，用户级别的最大数据库连接数，默认 -1 禁用限制</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">search_path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">public            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，根据 postgresql 文档的键值配置参数（例如：使用 pigsty 作为默认 search_path）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>唯一必需的字段是 <code>name</code>，它应该是 PostgreSQL 集群中的一个有效且唯一的用户名。</li>
<li>角色不需要 <code>password</code>，但对于可登录的业务用户，通常是需要指定一个密码的。</li>
<li><code>password</code> 可以是明文或 scram-sha-256 / md5 哈希字符串，请最好不要使用明文密码。</li>
<li>用户/角色按数组顺序逐一创建，因此，请确保角色/分组的定义在成员之前。</li>
<li><code>login</code>、<code>superuser</code>、<code>createdb</code>、<code>createrole</code>、<code>inherit</code>、<code>replication</code>、<code>bypassrls</code> 是布尔标志。</li>
<li><code>pgbouncer</code> 默认是禁用的：要将业务用户添加到 pgbouncer 用户列表，您应当显式将其设置为 <code>true</code>。</li>
</ul>
<p><strong>ACL系统</strong></p>
<p>Pigsty 具有一套内置的，开箱即用的访问控制 / <a href="/zh/docs/pgsql/acl#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2">ACL</a> 系统，您只需将以下四个默认角色分配给业务用户即可轻松使用：</p>
<ul>
<li><code>dbrole_readwrite</code>：全局读写访问的角色（主属业务使用的生产账号应当具有数据库读写权限）</li>
<li><code>dbrole_readonly</code>：全局只读访问的角色（如果别的业务想要只读访问，可以使用此角色）</li>
<li><code>dbrole_admin</code>：拥有DDL权限的角色 （业务管理员，需要在应用中建表的场景）</li>
<li><code>dbrole_offline</code>：受限的只读访问角色（只能访问 <a href="/zh/docs/pgsql/config#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93">offline</a> 实例，通常是个人用户）</li>
</ul>
<p>如果您希望重新设计您自己的 ACL 系统，可以考虑定制以下参数和模板：</p>
<ul>
<li><a href="/zh/docs/reference/param#pg_default_roles"><code>pg_default_roles</code></a>：系统范围的角色和全局用户</li>
<li><a href="/zh/docs/reference/param#pg_default_privileges"><code>pg_default_privileges</code></a>：新建对象的默认权限</li>
<li><a href="https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-role.sql"><code>roles/pgsql/templates/pg-init-role.sql</code></a>：角色创建 SQL 模板</li>
<li><a href="https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql"><code>roles/pgsql/templates/pg-init-template.sql</code></a>：权限 SQL 模板</li>
</ul>
<hr>
<h2 id="创建用户">创建用户</h2>
<p>在 <a href="/zh/docs/reference/param#pg_default_roles"><code>pg_default_roles</code></a> 和 <a href="/zh/docs/reference/param#pg_users"><code>pg_users</code></a> 中<a href="/zh/docs/pgsql/user/#定义用户">定义</a>的用户和角色，将在集群初始化的 PROVISION 阶段中自动逐一创建。
如果您希望在现有的集群上<a href="/zh/docs/pgsql/admin#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7">创建用户</a>，可以使用 <code>bin/pgsql-user</code> 工具。
将新用户/角色定义添加到 <code>all.children.&lt;cls&gt;.pg_users</code>，并使用以下方法创建该数据库：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;    <span style="color:#8f5902;font-style:italic"># pgsql-user.yml -l &lt;cls&gt; -e username=&lt;username&gt;</span>
</span></span></code></pre></div><p>不同于数据库，创建用户的剧本总是幂等的。当目标用户已经存在时，Pigsty会修改目标用户的属性使其符合配置。所以在现有集群上重复运行它通常不会有问题。</p>


<div class="alert alert-secondary" role="alert">
<h4 class="alert-heading">请使用剧本创建用户</h4>

    我们不建议您手工创建新的业务用户，特别当您想要创建的用户使用默认的 pgbouncer 连接池时：除非您愿意手工负责维护 Pgbouncer 中的用户列表并与 PostgreSQL 保持一致。
使用 <strong><code>bin/pgsql-user</code></strong> 工具或 <a href="/zh/docs/pgsql/playbook#pgsql-useryml"><strong><code>pgsql-user.yml</code></strong></a> 剧本创建新数据库时，会将此数据库一并添加到  <a href="/zh/docs/pgsql/user/#pgbouncer用户">Pgbouncer用户</a> 列表中。

</div>

<hr>
<h2 id="修改用户">修改用户</h2>
<p>修改 PostgreSQL 用户的属性的方式与 <a href="/zh/docs/pgsql/user/#创建用户"><strong>创建用户</strong></a> 相同。</p>
<p>首先，调整您的用户定义，修改需要调整的属性，然后执行以下命令应用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;    <span style="color:#8f5902;font-style:italic"># pgsql-user.yml -l &lt;cls&gt; -e username=&lt;username&gt;</span>
</span></span></code></pre></div><p>请注意，修改用户不会删除用户，而是通过 <code>ALTER USER</code> 命令修改用户属性；也不会回收用户的权限与分组，并使用 <code>GRANT</code> 命令授予新的角色。</p>
<hr>
<h2 id="pgbouncer用户">Pgbouncer用户</h2>
<p>默认情况下启用 Pgbouncer，并作为连接池中间件，其用户默认被管理。</p>
<p>Pigsty 默认将 <a href="/zh/docs/reference/param#pg_users"><code>pg_users</code></a> 中显式带有 <code>pgbouncer: true</code> 标志的所有用户添加到 pgbouncer 用户列表中。</p>
<p>Pgbouncer 连接池中的用户在 <code>/etc/pgbouncer/userlist.txt</code> 中列出：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">&#34;postgres&#34; &#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_wiki&#34; &#34;SCRAM-SHA-256$4096:+77dyhrPeFDT/TptHs7/7Q</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$KeatuohpKIYzHPCt/tqBu85vI11o9mar/by0hHYM2W8=:X9gig4JtjoS8Y/o1vQsIX/gY1Fns8ynTXkbWOjUfbRQ=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_view&#34; &#34;SCRAM-SHA-256$4096:DFoZHU/DXsHL8MJ8regdEw</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$gx9sUGgpVpdSM4o6A2R9PKAUkAsRPLhLoBDLBUYtKS0=:MujSgKe6rxcIUMv4GnyXJmV0YNbf39uFRZv724+X1FE=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_monitor&#34; &#34;SCRAM-SHA-256$4096:fwU97ZMO/KR0ScHO5+UuBg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$CrNsmGrx1DkIGrtrD1Wjexb/aygzqQdirTO1oBZROPY=:L8+dJ+fqlMQh7y4PmVR/gbAOvYWOr+KINjeMZ8LlFww=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_meta&#34; &#34;SCRAM-SHA-256$4096:leB2RQPcw1OIiRnPnOMUEg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$eyC+NIMKeoTxshJu314+BmbMFpCcspzI3UFZ1RYfNyU=:fJgXcykVPvOfro2MWNkl5q38oz21nSl1dTtM65uYR1Q=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_kong&#34; &#34;SCRAM-SHA-256$4096:bK8sLXIieMwFDz67/0dqXQ</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$P/tCRgyKx9MC9LH3ErnKsnlOqgNd/nn2RyvThyiK6e4=:CDM8QZNHBdPf97ztusgnE7olaKDNHBN0WeAbP/nzu5A=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_grafana&#34; &#34;SCRAM-SHA-256$4096:HjLdGaGmeIAGdWyn2gDt/Q</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$jgoyOB8ugoce+Wqjr0EwFf8NaIEMtiTuQTg1iEJs9BM=:ed4HUFqLyB4YpRr+y25FBT7KnlFDnan6JPVT9imxzA4=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_gitea&#34; &#34;SCRAM-SHA-256$4096:l1DBGCc4dtircZ8O8Fbzkw</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$tpmGwgLuWPDog8IEKdsaDGtiPAxD16z09slvu+rHE74=:pYuFOSDuWSofpD9OZhG7oWvyAR0PQjJBffgHZLpLHds=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_dba&#34; &#34;SCRAM-SHA-256$4096:zH8niABU7xmtblVUo2QFew</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$Zj7/pq+ICZx7fDcXikiN7GLqkKFA+X5NsvAX6CMshF0=:pqevR2WpizjRecPIQjMZOm+Ap+x0kgPL2Iv5zHZs0+g=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_bytebase&#34; &#34;SCRAM-SHA-256$4096:OMoTM9Zf8QcCCMD0svK5gg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$kMchqbf4iLK1U67pVOfGrERa/fY818AwqfBPhsTShNQ=:6HqWteN+AadrUnrgC0byr5A72noqnPugItQjOLFw0Wk=&#34;</span>
</span></span></code></pre></div><p>而用户级别的连接池参数则是使用另一个单独的文件： <code>/etc/pgbouncer/useropts.txt</code> 进行维护，比如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">dbuser_dba</span>                  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">pool_mode=session max_user_connections=16</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">dbuser_monitor</span>              <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">pool_mode=session max_user_connections=8</span>
</span></span></code></pre></div><p>当您<a href="/zh/docs/pgsql/user/#创建数据库">创建数据库</a>时，Pgbouncer 的数据库列表定义文件将会被刷新，并通过在线重载配置的方式生效，不会影响现有的连接。</p>
<p>Pgbouncer 使用和 PostgreSQL 同样的 <code>dbsu</code> 运行，默认为 <code>postgres</code> 操作系统用户，您可以使用 <code>pgb</code> 别名，使用 dbsu 访问 pgbouncer 管理功能。</p>
<p>Pigsty 还提供了一个实用函数 <code>pgb-route</code> ，可以将 pgbouncer 数据库流量快速切换至集群中的其他节点，用于零停机迁移：</p>
<p>连接池用户配置文件 <code>userlist.txt</code> 与 <code>useropts.txt</code> 会在您<a href="/zh/docs/pgsql/user/#创建用户">创建用户</a>时自动刷新，并通过在线重载配置的方式生效，正常不会影响现有的连接。</p>
<p>请注意，<a href="/zh/docs/reference/param#pgbouncer_auth_query"><code>pgbouncer_auth_query</code></a> 参数允许你使用动态查询来完成连接池用户认证，当您懒得管理连接池中的用户时，这是一种折中的方案。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-77da146645a70d6fc90b1213d22e52d5">4 - 数据库</h1>
    <div class="lead">数据库指的是使用 SQL 命令 <code>CREATE DATABASE</code> 创建的，数据库集簇内的逻辑对象。</div>
	<blockquote>
<p>在这里的上下文中，数据库指的是使用 SQL 命令 <code>CREATE DATABASE</code> 创建的，数据库集簇内的逻辑对象。</p>
</blockquote>
<p>一组 PostgreSQL 服务器可以同时服务于多个 <strong>数据库</strong> （Database）。在 Pigsty 中，你可以在集群配置中<a href="/zh/docs/pgsql/db/#定义数据库">定义</a>好所需的数据库。</p>
<p>Pigsty会对默认模板数据库<code>template1</code>进行修改与定制，创建默认模式，安装默认扩展，配置默认权限，新创建的数据库默认会从<code>template1</code>继承这些设置。</p>
<p>默认情况下，所有业务数据库都会被1:1添加到 Pgbouncer 连接池中；<code>pg_exporter</code> 默认会通过 <strong>自动发现</strong> 机制查找所有业务数据库并进行库内对象监控。</p>
<hr>
<h2 id="定义数据库">定义数据库</h2>
<p>业务数据库定义在数据库集群参数  <a href="/zh/docs/reference/param#pg_databases"><code>pg_databases</code></a> 中，这是一个数据库定义构成的对象数组。
数组内的数据库按照<strong>定义顺序</strong>依次创建，因此后面定义的数据库可以使用先前定义的数据库作为<strong>模板</strong>。</p>
<p>下面是 Pigsty 演示环境中默认集群 <code>pg-meta</code> 中的数据库定义：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#204a87;font-weight:bold">name: postgis, schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">public}, {name: timescaledb}]}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: grafana  ,owner: dbuser_grafana  ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">grafana primary database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: bytebase ,owner: dbuser_bytebase ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bytebase primary database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: kong     ,owner: dbuser_kong     ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kong the api gateway database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: gitea    ,owner: dbuser_gitea    ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gitea meta database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: wiki     ,owner: dbuser_wiki     ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wiki meta database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: noco     ,owner: dbuser_noco     ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nocodb database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>每个数据库定义都是一个 object，可能包括以下字段，以 <code>meta</code> 数据库为例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta                     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 必选，`name` 是数据库定义的唯一必选字段</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">baseline</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cmdb.sql             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，数据库 sql 的基线定义文件路径（ansible 搜索路径中的相对路径，如 files/）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pgbouncer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># 可选，是否将此数据库添加到 pgbouncer 数据库列表？默认为 true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">schemas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pigsty]              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，要创建的附加模式，由模式名称字符串组成的数组</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># 可选，要安装的附加扩展： 扩展对象的数组</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: postgis , schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">public } </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可以指定将扩展安装到某个模式中，也可以不指定（不指定则安装到 search_path 首位模式中）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">timescaledb }              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 例如有的扩展会创建并使用固定的模式，就不需要指定模式。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty meta database  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，数据库的说明与备注信息</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres                </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，数据库所有者，默认为 postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">template1            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，要使用的模板，默认为 template1，目标必须是一个模板数据库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">encoding</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UTF8                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，数据库编码，默认为 UTF8（必须与模板数据库相同）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">locale</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">C                      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，数据库地区设置，默认为 C（必须与模板数据库相同）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">lc_collate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">C                  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，数据库 collate 排序规则，默认为 C（必须与模板数据库相同），没有理由不建议更改。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">lc_ctype</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">C                    </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，数据库 ctype 字符集，默认为 C（必须与模板数据库相同）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">tablespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_default         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，默认表空间，默认为 &#39;pg_default&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">allowconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># 可选，是否允许连接，默认为 true。显式设置 false 将完全禁止连接到此数据库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">revokeconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic"># 可选，撤销公共连接权限。默认为 false，设置为 true 时，属主和管理员之外用户的 CONNECT 权限会被回收</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">register_datasource</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># 可选，是否将此数据库注册到 grafana 数据源？默认为 true，显式设置为 false 会跳过注册</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># 可选，数据库连接限制，默认为 -1 ，不限制，设置为正整数则会限制连接数。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool_auth_user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_meta    </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，连接到此 pgbouncer 数据库的所有连接都将使用此用户进行验证（启用 pgbouncer_auth_query 才有用）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">transaction         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，数据库级别的 pgbouncer 池化模式，默认为 transaction</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># 可选，数据库级别的 pgbouncer 默认池子大小，默认为 64</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool_size_reserve</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># 可选，数据库级别的 pgbouncer 池子保留空间，默认为 32，当默认池子不够用时，最多再申请这么多条突发连接。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool_size_min</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># 可选，数据库级别的 pgbouncer 池的最小大小，默认为 0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool_max_db_conn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># 可选，数据库级别的最大数据库连接数，默认为 100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>唯一必选的字段是 <code>name</code>，它应该是当前 PostgreSQL 集群中有效且唯一的数据库名称，其他参数都有合理的默认值。</p>
<ul>
<li><code>name</code>：数据库名称，<strong>必选项</strong>。</li>
<li><code>baseline</code>：SQL文件路径（Ansible搜索路径，通常位于<code>files</code>），用于初始化数据库内容。</li>
<li><code>owner</code>：数据库属主，默认为<code>postgres</code></li>
<li><code>template</code>：数据库创建时使用的模板，默认为<code>template1</code></li>
<li><code>encoding</code>：数据库默认字符编码，默认为<code>UTF8</code>，默认与实例保持一致。建议不要配置与修改。</li>
<li><code>locale</code>：数据库默认的本地化规则，默认为<code>C</code>，建议不要配置，与实例保持一致。</li>
<li><code>lc_collate</code>：数据库默认的本地化字符串排序规则，默认与实例设置相同，建议不要修改，必须与模板数据库一致。强烈建议不要配置，或配置为<code>C</code>。</li>
<li><code>lc_ctype</code>：数据库默认的LOCALE，默认与实例设置相同，建议不要修改或设置，必须与模板数据库一致。建议配置为C或<code>en_US.UTF8</code>。</li>
<li><code>allowconn</code>：是否允许连接至数据库，默认为<code>true</code>，不建议修改。</li>
<li><code>revokeconn</code>：是否回收连接至数据库的权限？默认为<code>false</code>。如果为<code>true</code>，则数据库上的<code>PUBLIC CONNECT</code>权限会被回收。只有默认用户（<code>dbsu|monitor|admin|replicator|owner</code>）可以连接。此外，<code>admin|owner</code> 会拥有GRANT OPTION，可以赋予其他用户连接权限。</li>
<li><code>tablespace</code>：数据库关联的表空间，默认为<code>pg_default</code>。</li>
<li><code>connlimit</code>：数据库连接数限制，默认为<code>-1</code>，即没有限制。</li>
<li><code>extensions</code>：对象数组 ，每一个对象定义了一个数据库中的<strong>扩展</strong>，以及其安装的<strong>模式</strong>。</li>
<li><code>parameters</code>：KV对象，每一个KV定义了一个需要针对数据库通过<code>ALTER DATABASE</code>修改的参数。</li>
<li><code>pgbouncer</code>：布尔选项，是否将该数据库加入到Pgbouncer中。所有数据库都会加入至Pgbouncer列表，除非显式指定<code>pgbouncer: false</code>。</li>
<li><code>comment</code>：数据库备注信息。</li>
<li><code>pool_auth_user</code>：启用 <a href="/zh/docs/reference/param#pgbouncer_auth_query"><code>pgbouncer_auth_query</code></a> 时，连接到此 pgbouncer 数据库的所有连接都将使用这里指定的用户执行认证查询。你需要使用一个具有访问 <code>pg_shadow</code> 表权限的用户。</li>
<li><code>pool_mode</code>：数据库级别的 pgbouncer 池化模式，默认为 transaction，即事物池化。如果留空，会使用 <a href="/zh/docs/reference/param#pgbouncer_poolmode"><code>pgbouncer_poolmode</code></a> 参数作为默认值。</li>
<li><code>pool_size</code>：数据库级别的 pgbouncer 默认池子大小，默认为 64</li>
<li><code>pool_size_reserve</code>：数据库级别的 pgbouncer 池子保留空间，默认为 32，当默认池子不够用时，最多再申请这么多条突发连接。</li>
<li><code>pool_size_min</code>： 数据库级别的 pgbouncer 池的最小大小，默认为 0</li>
<li><code>pool_max_db_conn</code>： 数据库级别的 pgbouncer 连接池最大数据库连接数，默认为 100</li>
</ul>
<p>新创建的数据库默认会从 <code>template1</code> 数据库 Fork 出来，这个模版数据库会在 <a href="/zh/docs/reference/param#pg_provision"><code>PG_PROVISION</code></a> 阶段进行定制修改：
配置好扩展，模式以及默认权限，因此新创建的数据库也会继承这些配置，除非您显式使用一个其他的数据库作为模板。</p>
<p>关于数据库的访问权限，请参考 <a href="/zh/docs/pgsql/acl#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9D%83%E9%99%90">ACL：数据库权限</a> 一节。</p>
<hr>
<h2 id="创建数据库">创建数据库</h2>
<p>在 <a href="/zh/docs/reference/param#pg_databases"><code>pg_databases</code></a> 中<a href="/zh/docs/pgsql/db/#定义数据库">定义</a>的数据库将在集群初始化时自动创建。
如果您希望在现有集群上<a href="/zh/docs/pgsql/admin#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93">创建数据库</a>，可以使用 <code>bin/pgsql-db</code> 包装脚本。
将新的数据库定义添加到 <code>all.children.&lt;cls&gt;.pg_databases</code> 中，并使用以下命令创建该数据库：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-db &lt;cls&gt; &lt;dbname&gt;    <span style="color:#8f5902;font-style:italic"># pgsql-db.yml -l &lt;cls&gt; -e dbname=&lt;dbname&gt;</span>
</span></span></code></pre></div><p>下面是新建数据库时的一些注意事项：</p>
<p>创建数据库的剧本默认为幂等剧本，不过当您当使用 <code>baseline</code> 脚本时就不一定了：这种情况下，通常不建议在现有数据库上重复执行此操作，除非您确定所提供的 baseline SQL也是幂等的。</p>
<p>我们不建议您手工创建新的数据库，特别当您使用默认的 pgbouncer 连接池时：除非您愿意手工负责维护 Pgbouncer 中的数据库列表并与 PostgreSQL 保持一致。
使用 <code>pgsql-db</code> 工具或 <code>pgsql-db.yml</code> 剧本创建新数据库时，会将此数据库一并添加到 <a href="/zh/docs/pgsql/db/#pgbouncer数据库">Pgbouncer 数据库</a> 列表中。</p>
<p>如果您的数据库定义有一个非常规 <code>owner</code>（默认为 dbsu <code>postgres</code>），那么请确保在创建该数据库前，属主用户已经存在。
最佳实践永远是在创建数据库之前<a href="/zh/docs/pgsql/admin#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7">创建</a> <a href="/zh/docs/pgsql/user">用户</a>。</p>
<hr>
<h2 id="pgbouncer数据库">Pgbouncer数据库</h2>
<p>Pigsty 会默认为 PostgreSQL 实例 1:1 配置启用一个 Pgbouncer 连接池，使用 <code>/var/run/postgresql</code> Unix Socket 通信。</p>
<p>连接池可以优化短连接性能，降低并发征用，以避免过高的连接数冲垮数据库，并在数据库迁移时提供额外的灵活处理空间。</p>
<p>Pigsty 默认将 <a href="/zh/docs/reference/param#pg_databases"><code>pg_databases</code></a> 中的所有数据库都添加到 pgbouncer 的数据库列表中。
您可以通过在数据库<a href="/zh/docs/pgsql/db/#定义数据库">定义</a>中显式设置 <code>pgbouncer: false</code> 来禁用特定数据库的 pgbouncer 连接池支持。</p>
<p>Pgbouncer数据库列表在 <code>/etc/pgbouncer/database.txt</code> 中定义，数据库定义中关于连接池的参数会体现在这里：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">meta                        = host=/var/run/postgresql mode=session</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">grafana                     = host=/var/run/postgresql mode=transaction</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">bytebase                    = host=/var/run/postgresql auth_user=dbuser_meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">kong                        = host=/var/run/postgresql pool_size=32 reserve_pool=64</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">gitea                       = host=/var/run/postgresql min_pool_size=10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">wiki                        = host=/var/run/postgresql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">noco                        = host=/var/run/postgresql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mongo                       = host=/var/run/postgresql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>当您<a href="/zh/docs/pgsql/db/#创建数据库">创建数据库</a>时，Pgbouncer 的数据库列表定义文件将会被刷新，并通过在线重载配置的方式生效，正常不会影响现有的连接。</p>
<p>Pgbouncer 使用和 PostgreSQL 同样的 <code>dbsu</code> 运行，默认为 <code>postgres</code> 操作系统用户，您可以使用 <code>pgb</code> 别名，使用 dbsu 访问 pgbouncer 管理功能。</p>
<p>Pigsty 还提供了一个实用函数 <code>pgb-route</code> ，可以将 pgbouncer 数据库流量快速切换至集群中的其他节点，用于零停机迁移：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># route pgbouncer traffic to another cluster member</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> pgb-route<span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">local</span> <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">1</span><span style="color:#000;font-weight:bold">-</span><span style="color:#4e9a06">&#39;\/var\/run\/postgresql&#39;</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>  sed -ie <span style="color:#4e9a06">&#34;s/host=[^[:space:]]\+/host=</span><span style="color:#4e9a06">${</span><span style="color:#000">ip</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/g&#34;</span> /etc/pgbouncer/pgbouncer.ini
</span></span><span style="display:flex;"><span>  cat /etc/pgbouncer/pgbouncer.ini
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d9b0c31dfa75886b76d79a64b11591aa">5 - 服务/接入</h1>
    <div class="lead">分离读写操作，正确路由流量，稳定可靠地交付 PostgreSQL 集群提供的能力。</div>
	<blockquote>
<p>分离读写操作，正确路由流量，稳定可靠地交付 PostgreSQL 集群提供的能力。</p>
</blockquote>
<p><a href="/zh/docs/pgsql/svc/#服务概述">服务</a>是一种抽象：它是数据库集群对外提供能力的形式，并封装了底层集群的细节。</p>
<p>服务对于生产环境中的<a href="/zh/docs/pgsql/svc/#接入服务">稳定接入</a>至关重要，在<a href="/zh/docs/concept/ha">高可用</a>集群自动故障时方显其价值，<a href="%E5%8D%95%E6%9C%BA%E7%94%A8%E6%88%B7">单机用户</a>通常不需要操心这个概念。</p>
<hr>
<h2 id="单机用户">单机用户</h2>
<p>“服务” 的概念是给生产环境用的，个人用户/单机集群可以不折腾，直接拿实例名/IP地址访问数据库。</p>
<p>例如，Pigsty 默认的单节点 <code>pg-meta</code>.<code>meta</code> 数据库，就可以直接用下面三个不同的用户连接上去。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10/meta     <span style="color:#8f5902;font-style:italic"># 直接用 DBA 超级用户连上去</span>
</span></span><span style="display:flex;"><span>psql postgres://dbuser_meta:DBUser.Meta@10.10.10.10/meta   <span style="color:#8f5902;font-style:italic"># 用默认的业务管理员用户连上去</span>
</span></span><span style="display:flex;"><span>psql postgres://dbuser_view:DBUser.View@pg-meta/meta       <span style="color:#8f5902;font-style:italic"># 用默认的只读用户走实例域名连上去</span>
</span></span></code></pre></div><hr>
<h2 id="服务概述">服务概述</h2>
<p>在真实世界生产环境中，我们会使用基于复制的主从数据库集群。集群中有且仅有一个实例作为领导者（<a href="/zh/docs/pgsql/config#%E8%AF%BB%E5%86%99%E4%B8%BB%E5%BA%93">主库</a>）可以接受写入。
而其他实例（<a href="/zh/docs/pgsql/config#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93">从库</a>）则会从持续从集群领导者获取变更日志，与领导者保持一致。同时，从库还可以承载只读请求，在读多写少的场景下可以显著分担主库的负担，
因此对集群的写入请求与只读请求进行区分，是一种十分常见的实践。</p>
<p>此外对于高频短连接的生产环境，我们还会通过连接池中间件（Pgbouncer）对请求进行池化，减少连接与后端进程的创建开销。但对于ETL与变更执行等场景，我们又需要绕过连接池，直接访问数据库。
同时，高可用集群在故障时会出现故障切换（Failover），故障切换会导致集群的领导者出现变更。因此高可用的数据库方案要求写入流量可以自动适配集群的领导者变化。
这些不同的访问需求（读写分离，池化与直连，故障切换自动适配）最终抽象出 <strong>服务</strong> （Service）的概念。</p>
<p>通常来说，数据库集群都必须提供这种最基础的服务：</p>
<ul>
<li><strong>读写服务（primary）</strong> ：可以读写数据库</li>
</ul>
<p>对于生产数据库集群，至少应当提供这两种服务：</p>
<ul>
<li><strong>读写服务（primary）</strong> ：写入数据：只能由主库所承载。</li>
<li><strong>只读服务（replica）</strong> ：读取数据：可以由从库承载，没有从库时也可由主库承载</li>
</ul>
<p>此外，根据具体的业务场景，可能还会有其他的服务，例如：</p>
<ul>
<li><strong>默认直连服务（default）</strong> ：允许（管理）用户，绕过连接池直接访问数据库的服务</li>
<li><strong>离线从库服务（offline）</strong> ：不承接线上只读流量的专用从库，用于ETL与分析查询</li>
<li><strong>同步从库服务（standby）</strong> ：没有复制延迟的只读服务，由<a href="/zh/docs/pgsql/config#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93">同步备库</a>/主库处理只读查询</li>
<li><strong>延迟从库服务（delayed）</strong> ：访问同一个集群在一段时间之前的旧数据，由<a href="/zh/docs/pgsql/config#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4">延迟从库</a>来处理</li>
</ul>
<hr>
<h2 id="默认服务">默认服务</h2>
<p>Pigsty默认为每个 PostgreSQL 数据库集群提供四种不同的服务，以下是默认服务及其定义：</p>
<table>
<thead>
<tr>
<th>服务</th>
<th>端口</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="/zh/docs/pgsql/svc/#primary服务">primary</a></td>
<td>5433</td>
<td>生产读写，连接到主库连接池（6432）</td>
</tr>
<tr>
<td><a href="/zh/docs/pgsql/svc/#replica服务">replica</a></td>
<td>5434</td>
<td>生产只读，连接到备库连接池（6432）</td>
</tr>
<tr>
<td><a href="/zh/docs/pgsql/svc/#default服务">default</a></td>
<td>5436</td>
<td>管理，ETL写入，直接访问主库（5432）</td>
</tr>
<tr>
<td><a href="/zh/docs/pgsql/svc/#offline服务">offline</a></td>
<td>5438</td>
<td>OLAP、ETL、个人用户、交互式查询</td>
</tr>
</tbody>
</table>
<p>以默认的 <code>pg-meta</code> 集群为例，它提供四种默认服务：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres://dbuser_meta:DBUser.Meta@pg-meta:5433/meta   <span style="color:#8f5902;font-style:italic"># pg-meta-primary : 通过主要的 pgbouncer(6432) 进行生产读写</span>
</span></span><span style="display:flex;"><span>psql postgres://dbuser_meta:DBUser.Meta@pg-meta:5434/meta   <span style="color:#8f5902;font-style:italic"># pg-meta-replica : 通过备份的 pgbouncer(6432) 进行生产只读</span>
</span></span><span style="display:flex;"><span>psql postgres://dbuser_dba:DBUser.DBA@pg-meta:5436/meta     <span style="color:#8f5902;font-style:italic"># pg-meta-default : 通过主要的 postgres(5432) 直接连接</span>
</span></span><span style="display:flex;"><span>psql postgres://dbuser_stats:DBUser.Stats@pg-meta:5438/meta <span style="color:#8f5902;font-style:italic"># pg-meta-offline : 通过离线的 postgres(5432) 直接连接</span>
</span></span></code></pre></div><p>从示例集群<a href="/zh/docs/pgsql/arch">架构图</a>上可以看出这四种服务的工作方式：</p>
<p><a href="/zh/docs/concept/ha"><img alt="pigsty-ha.png" src="/img/pigsty/ha.png"></a></p>
<p>注意在这里<code>pg-meta</code> 域名指向了集群的 L2 VIP，进而指向集群主库上的 haproxy 负载均衡器，它负责将流量路由到不同的实例上，详见<a href="/zh/docs/pgsql/svc/#接入服务">服务接入</a></p>
<hr>
<h2 id="服务实现">服务实现</h2>
<p>在 Pigsty 中，服务使用<a href="/zh/docs/node">节点</a>上的 <a href="/zh/docs/reference/param#haproxy">haproxy</a> 来实现，通过主机节点上的不同端口进行区分。</p>
<p>Pigsty 所纳管的每个节点上都默认启用了 Haproxy 以对外暴露服务，而数据库节点也不例外。
集群中的节点尽管从数据库的视角来看有主从之分，但从服务的视角来看，每个节点都是相同的：
这意味着即使您访问的是从库节点，只要使用正确的服务端口，就依然可以使用到主库读写的服务。
这样的设计可以屏蔽复杂度：所以您只要可以访问 PostgreSQL 集群上的任意一个实例，就可以完整的访问到所有服务。</p>
<p>这样的设计类似于 Kubernetes 中的 NodePort 服务，同样在 Pigsty 中，每一个服务都包括以下两个核心要素：</p>
<ol>
<li>通过 NodePort 暴露的访问端点（端口号，从哪访问？）</li>
<li>通过 Selectors 选择的目标实例（实例列表，谁来承载？）</li>
</ol>
<p>Pigsty的服务交付边界止步于集群的HAProxy，用户可以用各种手段访问这些负载均衡器，请参考<a href="/zh/docs/pgsql/svc/#接入服务">接入服务</a>。</p>
<p>所有的服务都通过配置文件进行声明，例如，PostgreSQL 默认服务就是由 <a href="/zh/docs/reference/param#pg_default_services"><code>pg_default_services</code></a> 参数所定义的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_default_services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">, backup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">, backup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>您也可以在 <a href="/zh/docs/reference/param#pg_services"><code>pg_services</code></a> 中定义额外的服务，参数 <code>pg_default_services</code> 与 <code>pg_services</code> 都是由 <a href="/zh/docs/pgsql/svc/#定义服务">服务定义</a> 对象组成的数组。</p>
<hr>
<h2 id="定义服务">定义服务</h2>
<p>Pigsty 允许您定义自己的服务：</p>
<ul>
<li><a href="/zh/docs/reference/param#pg_default_services"><code>pg_default_services</code></a>：所有 PostgreSQL 集群统一对外暴露的服务，默认有四个。</li>
<li><a href="/zh/docs/reference/param#pg_services"><code>pg_services</code></a>：额外的 PostgreSQL 服务，可以视需求在全局或集群级别定义。</li>
<li><a href="/zh/docs/reference/param#haproxy_services"><code>haproxy_servies</code></a>：直接定制 HAProxy 服务内容，可以用于其他组件的接入</li>
</ul>
<p>对于 PostgreSQL 集群来说，通常只需要关注前两者即可。
每一条服务定义都会在所有相关 HAProxy 实例的配置目录下生成一个新的配置文件：<a href="https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/service.j2"><code>/etc/haproxy/&lt;svcname&gt;.cfg</code></a>
下面是一个自定义的服务样例 <code>standby</code>：当您想要对外提供没有复制延迟的只读服务时，就可以在  <a href="/zh/docs/reference/param#pg_services"><code>pg_services</code></a> 新增这条记录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">standby                  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 必选，服务名称，最终的 svc 名称会使用 `pg_cluster` 作为前缀，例如：pg-meta-standby</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5435</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#8f5902;font-style:italic"># 必选，暴露的服务端口（作为 kubernetes 服务节点端口模式）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#8f5902;font-style:italic"># 可选，服务绑定的 IP 地址，默认情况下为所有 IP 地址</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># 必选，服务成员选择器，使用 JMESPath 来筛选配置清单</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">backup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `primary`]&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 可选，服务成员选择器（备份），也就是当默认选择器选中的实例都宕机后，服务才会由这里选中的实例成员来承载</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dest</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default                  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，目标端口，default|postgres|pgbouncer|&lt;port_number&gt;，默认为 &#39;default&#39;，Default的意思就是使用 pg_default_service_dest 的取值来最终决定</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">check</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/sync                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，健康检查 URL 路径，默认为 /，这里使用 Patroni API：/sync ，只有同步备库和主库才会返回 200 健康状态码 </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">maxconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># 可选，允许的前端连接最大数，默认为5000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">balance</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">roundrobin            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，haproxy 负载均衡算法（默认为 roundrobin，其他选项：leastconn）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>而上面的服务定义，在样例的三节点 <code>pg-test</code> 上将会被转换为 haproxy 配置文件 <code>/etc/haproxy/pg-test-standby.conf</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#---------------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># service: pg-test-standby @ 10.10.10.11:5435</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#---------------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># service instances 10.10.10.11, 10.10.10.13, 10.10.10.12</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># service backups   10.10.10.11</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">listen pg-test-standby</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">bind *:5435           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- 绑定了所有IP地址上的 5435 端口</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">mode tcp              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- 负载均衡器工作在 TCP 协议上</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">maxconn 5000          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- 最大连接数为 5000，可按需调大</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">balance roundrobin    </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- 负载均衡算法为 rr 轮询，还可以使用 leastconn </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">option httpchk        </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- 启用 HTTP 健康检查</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">option http-keep-alive</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- 保持HTTP连接</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">http-check send meth OPTIONS uri /sync  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;---- 这里使用 /sync ，Patroni 健康检查 API ，只有同步备库和主库才会返回 200 健康状态码。 </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">http-check expect status 200            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;---- 健康检查返回代码 200 代表正常</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># servers： # pg-test 集群全部三个实例都被 selector: &#34;[]&#34; 给圈中了，因为没有任何的筛选条件，所以都会作为 pg-test-replica 服务的后端服务器。但是因为还有 /sync 健康检查，所以只有主库和同步备库才能真正承载请求。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">server pg-test-1 10.10.10.11:6432 check port 8008 weight 100 backup </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;----- 唯独主库满足条件 pg_role == `primary`， 被 backup selector 选中。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">server pg-test-3 10.10.10.13:6432 check port 8008 weight 100        </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#        因此作为服务的兜底实例：平时不承载请求，其他从库全部宕机后，才会承载只读请求，从而最大避免了读写服务受到只读服务的影响</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">server pg-test-2 10.10.10.12:6432 check port 8008 weight 100        </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#        </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在这里，<code>pg-test</code> 集群全部三个实例都被 <code>selector: &quot;[]&quot;</code> 给圈中了，渲染进入 <code>pg-test-replica</code> 服务的后端服务器列表中。但是因为还有 <code>/sync</code> 健康检查，Patroni Rest API只有在主库和<a href="/zh/docs/pgsql/config#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93">同步备库</a>上才会返回代表健康的 HTTP 200 状态码，因此只有主库和同步备库才能真正承载请求。
此外，主库因为满足条件 <code>pg_role == primary</code>， 被 backup selector 选中，被标记为了备份服务器，只有当没有其他实例（也就是同步备库）可以满足需求时，才会顶上。</p>
<hr>
<h2 id="primary服务">Primary服务</h2>
<p>Primary服务可能是生产环境中最关键的服务，它在 5433 端口提供对数据库集群的读写能力，服务定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>选择器参数 <code>selector: &quot;[]&quot;</code> 意味着所有集群成员都将被包括在Primary服务中</li>
<li>但只有主库能够通过健康检查（<code>check: /primary</code>），实际承载Primary服务的流量。</li>
<li>目的地参数 <code>dest: default</code> 意味着Primary服务的目的地受到 <a href="/zh/docs/reference/param#pg_default_service_dest"><code>pg_default_service_dest</code></a> 参数的影响</li>
<li><code>dest</code> 默认值 <code>default</code> 会被替换为 <code>pg_default_service_dest</code> 的值，默认为 <code>pgbouncer</code>。</li>
<li>默认情况下 Primary 服务的目的地默认是主库上的连接池，也就是由 <a href="/zh/docs/reference/param#pgbouncer_port"><code>pgbouncer_port</code></a> 指定的端口，默认为 6432</li>
</ul>
<p>如果 <code>pg_default_service_dest</code> 的值为 <code>postgres</code>，那么 primary 服务的目的地就会绕过连接池，直接使用 PostgreSQL 数据库的端口（<a href="/zh/docs/reference/param#pg_port"><code>pg_port</code></a>，默认值 5432），对于一些不希望使用连接池的场景，这个参数非常实用。</p>
<details><summary>示例：pg-test-primary 的 haproxy 配置</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">listen pg-test-primary</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">bind *:5433        </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- primary 服务默认使用 5433 端口</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">mode tcp</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">maxconn 5000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">balance roundrobin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">option httpchk</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">option http-keep-alive</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">http-check send meth OPTIONS uri /primary</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- primary 服务默认使用 Patroni RestAPI /primary 健康检查</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">http-check expect status 200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># servers</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">server pg-test-1 10.10.10.11:6432 check port 8008 weight 100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">server pg-test-3 10.10.10.13:6432 check port 8008 weight 100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">server pg-test-2 10.10.10.12:6432 check port 8008 weight 100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></details>
<p>Patroni 的<a href="/zh/docs/concept/ha">高可用</a>机制确保任何时候最多只会有一个实例的 <code>/primary</code> 健康检查为真，因此Primary服务将始终将流量路由到主实例。</p>
<p>使用 Primary 服务而不是直连数据库的一个好处是，如果集群因为某种情况出现了双主（比如在没有watchdog的情况下kill -9杀死主库 Patroni），Haproxy在这种情况下仍然可以避免脑裂，因为它只会在 Patroni 存活且返回主库状态时才会分发流量。</p>
<hr>
<h2 id="replica服务">Replica服务</h2>
<p>Replica服务在生产环境中的重要性仅次于Primary服务，它在 5434 端口提供对数据库集群的只读能力，服务定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">, backup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>选择器参数 <code>selector: &quot;[]&quot;</code> 意味着所有集群成员都将被包括在Replica服务中</li>
<li>所有实例都能够通过健康检查（<code>check: /read-only</code>），承载Replica服务的流量。</li>
<li>备份选择器：<code>[? pg_role == 'primary' || pg_role == 'offline' ]</code> 将主库和<a href="/zh/docs/pgsql/config#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93">离线从库</a>标注为备份服务器。</li>
<li>只有当所有<a href="/zh/docs/pgsql/config#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93">普通从库</a>都宕机后，Replica服务才会由主库或离线从库来承载。</li>
<li>目的地参数 <code>dest: default</code> 意味着Replica服务的目的地也受到 <a href="/zh/docs/reference/param#pg_default_service_dest"><code>pg_default_service_dest</code></a> 参数的影响</li>
<li><code>dest</code> 默认值 <code>default</code> 会被替换为 <code>pg_default_service_dest</code> 的值，默认为 <code>pgbouncer</code>，这一点和 <a href="/zh/docs/pgsql/svc/#primary服务">Primary服务</a> 相同</li>
<li>默认情况下 Replica 服务的目的地默认是从库上的连接池，也就是由 <a href="/zh/docs/reference/param#pgbouncer_port"><code>pgbouncer_port</code></a> 指定的端口，默认为 6432</li>
</ul>
<details><summary>示例：pg-test-replica 的 haproxy 配置</summary> 
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">listen pg-test-replica</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">bind *:5434</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">mode tcp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">maxconn 5000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">balance roundrobin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">option httpchk</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">option http-keep-alive</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">http-check send meth OPTIONS uri /read-only</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">http-check expect status 200</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># servers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">server pg-test-1 10.10.10.11:6432 check port 8008 weight 100 backup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">server pg-test-3 10.10.10.13:6432 check port 8008 weight 100</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">server pg-test-2 10.10.10.12:6432 check port 8008 weight 100</span>
</span></span></code></pre></div></details>
<p>Replica服务非常灵活：如果有存活的专用 Replica 实例，那么它会优先使用这些实例来承载只读请求，只有当从库实例全部宕机后，才会由主库来兜底只读请求。对于常见的一主一从双节点集群就是：只要从库活着就用从库，从库挂了再用主库。</p>
<p>此外，除非专用只读实例全部宕机，Replica 服务也不会使用专用 Offline 实例，这样就避免了在线快查询与离线慢查询混在一起，相互影响。</p>
<hr>
<h3 id="default服务">Default服务</h3>
<p>Default服务在 5436 端口上提供服务，它是Primary服务的变体。</p>
<p>Default服务总是绕过连接池直接连到主库上的 PostgreSQL，这对于管理连接、ETL写入、CDC数据变更捕获等都很有用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>如果 <code>pg_default_service_dest</code> 被修改为 <code>postgres</code>，那么可以说 Default 服务除了端口和名称内容之外，与 Primary 服务是完全等价的。在这种情况下，您可以考虑将 Default 从默认服务中剔除。</p>
<details><summary>示例：pg-test-default 的 haproxy 配置</summary> 
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">listen pg-test-default</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">bind *:5436         # &lt;--- 除了监听端口/目标端口和服务名，其他配置和 primary 服务一模一样</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">mode tcp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">maxconn 5000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">balance roundrobin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">option httpchk</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">option http-keep-alive</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">http-check send meth OPTIONS uri /primary</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">http-check expect status 200</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># servers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">server pg-test-1 10.10.10.11:5432 check port 8008 weight 100</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">server pg-test-3 10.10.10.13:5432 check port 8008 weight 100</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">server pg-test-2 10.10.10.12:5432 check port 8008 weight 100</span>
</span></span></code></pre></div></details>
<hr>
<h3 id="offline服务">Offline服务</h3>
<p>Default服务在 5438 端口上提供服务，它也绕开连接池直接访问 PostgreSQL 数据库，通常用于慢查询/分析查询/ETL读取/个人用户交互式查询，其服务定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">, backup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Offline服务将流量直接路由到专用的<a href="/zh/docs/pgsql/config#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93">离线从库</a>上，或者带有 <a href="/zh/docs/reference/param#pg_offline_query"><code>pg_offline_query</code></a> 标记的普通<a href="/zh/docs/pgsql/config#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93">只读实例</a>。</p>
<ul>
<li>选择器参数从集群中筛选出了两种实例：<a href="/zh/docs/reference/param#pg_role"><code>pg_role</code></a> = <code>offline</code> 的离线从库，或是带有 <a href="/zh/docs/reference/param#pg_offline_query"><code>pg_offline_query</code></a> = <code>true</code> 标记的普通<a href="/zh/docs/pgsql/config#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93">只读实例</a></li>
<li>专用离线从库和打标记的普通从库主要的区别在于：前者默认不承载 <a href="/zh/docs/pgsql/svc/#replica服务">Replica服务</a> 的请求，避免快慢请求混在一起，而后者默认会承载。</li>
<li>备份选择器参数从集群中筛选出了一种实例：不带 offline 标记的普通从库，这意味着如果离线实例或者带Offline标记的普通从库挂了之后，其他普通的从库可以用来承载Offline服务。</li>
<li>健康检查 <code>/replica</code> 只会针对从库返回 200， 主库会返回错误，因此 Offline服务 永远不会将流量分发到主库实例上去，哪怕集群中只剩这一台主库。</li>
<li>同时，主库实例既不会被选择器圈中，也不会被备份选择器圈中，因此它永远不会承载Offline服务。因此 Offline 服务总是可以避免用户访问主库，从而避免对主库的影响。</li>
</ul>
<details><summary>示例：pg-test-offline 的 haproxy 配置</summary> 
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">listen pg-test-offline</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">bind *:5438</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">mode tcp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">maxconn 5000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">balance roundrobin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">option httpchk</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">option http-keep-alive</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">http-check send meth OPTIONS uri /replica</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">http-check expect status 200</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># servers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">server pg-test-3 10.10.10.13:5432 check port 8008 weight 100</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">server pg-test-2 10.10.10.12:5432 check port 8008 weight 100 backup</span>
</span></span></code></pre></div></details>
<p>Offline服务提供受限的只读服务，通常用于两类查询：交互式查询（个人用户），慢查询长事务（分析/ETL）。</p>
<p>Offline 服务需要额外的维护照顾：当集群发生主从切换或故障自动切换时，集群的实例角色会发生变化，而 Haproxy 的配置却不会自动发生变化。对于有多个从库的集群来说，这通常并不是一个问题。
然而对于一主一从，从库跑Offline查询的精简小集群而言，主从切换意味着从库变成了主库（健康检查失效），原来的主库变成了从库（不在 Offline 后端列表中），于是没有实例可以承载 Offline 服务了，因此需要手动<a href="/zh/docs/pgsql/admin#%E9%87%8D%E8%BD%BD%E6%9C%8D%E5%8A%A1">重载服务</a>以使变更生效。</p>
<p>如果您的业务模型较为简单，您可以考虑剔除 Default 服务与 Offline 服务，使用 Primary 服务与 Replica 服务直连数据库。</p>
<hr>
<h2 id="重载服务">重载服务</h2>
<p>当集群成员发生变化，如添加/删除副本、主备切换或调整相对权重时， 你需要 <a href="/zh/docs/pgsql/admin#%E9%87%8D%E8%BD%BD%E6%9C%8D%E5%8A%A1">重载服务</a> 以使更改生效。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-svc &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>ip...<span style="color:#ce5c00;font-weight:bold">]</span>         <span style="color:#8f5902;font-style:italic"># 为 lb 集群或 lb 实例重载服务</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ./pgsql.yml -t pg_service         # 重载服务的实际 ansible 任务</span>
</span></span></code></pre></div><hr>
<h2 id="接入服务">接入服务</h2>
<p>Pigsty的服务交付边界止步于集群的HAProxy，用户可以用各种手段访问这些负载均衡器。</p>
<p>典型的做法是使用 DNS 或 VIP 接入，将其绑定在集群所有或任意数量的负载均衡器上。</p>
<p><img alt="pigsty-access.jpg" src="/img/pigsty/access.jpg"></p>
<p>你可以使用不同的 主机 &amp; 端口 组合，它们以不同的方式提供 PostgreSQL 服务。</p>
<p><strong>主机</strong></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>样例</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>集群域名</td>
<td><code>pg-test</code></td>
<td>通过集群域名访问（由 dnsmasq @ infra 节点解析）</td>
</tr>
<tr>
<td>集群 VIP 地址</td>
<td><code>10.10.10.3</code></td>
<td>通过由 <code>vip-manager</code> 管理的 L2 VIP 地址访问，绑定到主节点</td>
</tr>
<tr>
<td>实例主机名</td>
<td><code>pg-test-1</code></td>
<td>通过任何实例主机名访问（由 dnsmasq @ infra 节点解析）</td>
</tr>
<tr>
<td>实例 IP 地址</td>
<td><code>10.10.10.11</code></td>
<td>访问任何实例的 IP 地址</td>
</tr>
</tbody>
</table>
<p><strong>端口</strong></p>
<p>Pigsty 使用不同的 <strong>端口</strong> 来区分 <a href="/zh/docs/pgsql/svc/#服务概述">pg services</a></p>
<table>
<thead>
<tr>
<th>端口</th>
<th>服务</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>5432</td>
<td>postgres</td>
<td>数据库</td>
<td>直接访问 postgres 服务器</td>
</tr>
<tr>
<td>6432</td>
<td>pgbouncer</td>
<td>中间件</td>
<td>访问 postgres 前先通过连接池中间件</td>
</tr>
<tr>
<td>5433</td>
<td>primary</td>
<td>服务</td>
<td>访问主 pgbouncer (或 postgres)</td>
</tr>
<tr>
<td>5434</td>
<td>replica</td>
<td>服务</td>
<td>访问备份 pgbouncer (或 postgres)</td>
</tr>
<tr>
<td>5436</td>
<td>default</td>
<td>服务</td>
<td>访问主 postgres</td>
</tr>
<tr>
<td>5438</td>
<td>offline</td>
<td>服务</td>
<td>访问离线 postgres</td>
</tr>
</tbody>
</table>
<p><strong>组合</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过集群域名访问</span>
</span></span><span style="display:flex;"><span>postgres://test@pg-test:5432/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; L2 VIP -&gt; 主直接连接</span>
</span></span><span style="display:flex;"><span>postgres://test@pg-test:6432/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; L2 VIP -&gt; 主连接池 -&gt; 主</span>
</span></span><span style="display:flex;"><span>postgres://test@pg-test:5433/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 主连接池 -&gt; 主</span>
</span></span><span style="display:flex;"><span>postgres://test@pg-test:5434/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 备份连接池 -&gt; 备份</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_dba@pg-test:5436/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 主直接连接 (用于管理员)</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_stats@pg-test:5438/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 离线直接连接 (用于 ETL/个人查询)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过集群 VIP 直接访问</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.3:5432/test <span style="color:#8f5902;font-style:italic"># L2 VIP -&gt; 主直接访问</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.3:6432/test <span style="color:#8f5902;font-style:italic"># L2 VIP -&gt; 主连接池 -&gt; 主</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.3:5433/test <span style="color:#8f5902;font-style:italic"># L2 VIP -&gt; HAProxy -&gt; 主连接池 -&gt; 主</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.3:5434/test <span style="color:#8f5902;font-style:italic"># L2 VIP -&gt; HAProxy -&gt; 备份连接池 -&gt; 备份</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_dba@10.10.10.3:5436/test <span style="color:#8f5902;font-style:italic"># L2 VIP -&gt; HAProxy -&gt; 主直接连接 (用于管理员)</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_stats@10.10.10.3::5438/test <span style="color:#8f5902;font-style:italic"># L2 VIP -&gt; HAProxy -&gt; 离线直接连接 (用于 ETL/个人查询)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 直接指定任何集群实例名</span>
</span></span><span style="display:flex;"><span>postgres://test@pg-test-1:5432/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; 数据库实例直接连接 (单例访问)</span>
</span></span><span style="display:flex;"><span>postgres://test@pg-test-1:6432/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; 连接池 -&gt; 数据库</span>
</span></span><span style="display:flex;"><span>postgres://test@pg-test-1:5433/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; HAProxy -&gt; 连接池 -&gt; 数据库读/写</span>
</span></span><span style="display:flex;"><span>postgres://test@pg-test-1:5434/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; HAProxy -&gt; 连接池 -&gt; 数据库只读</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_dba@pg-test-1:5436/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; HAProxy -&gt; 数据库直接连接</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_stats@pg-test-1:5438/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; HAProxy -&gt; 数据库离线读/写</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 直接指定任何集群实例 IP 访问</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.11:5432/test <span style="color:#8f5902;font-style:italic"># 数据库实例直接连接 (直接指定实例, 没有自动流量分配)</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.11:6432/test <span style="color:#8f5902;font-style:italic"># 连接池 -&gt; 数据库</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.11:5433/test <span style="color:#8f5902;font-style:italic"># HAProxy -&gt; 连接池 -&gt; 数据库读/写</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.11:5434/test <span style="color:#8f5902;font-style:italic"># HAProxy -&gt; 连接池 -&gt; 数据库只读</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_dba@10.10.10.11:5436/test <span style="color:#8f5902;font-style:italic"># HAProxy -&gt; 数据库直接连接</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_stats@10.10.10.11:5438/test <span style="color:#8f5902;font-style:italic"># HAProxy -&gt; 数据库离线读-写</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 智能客户端：自动进行读写分离</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style="color:#ce5c00;font-weight:bold">=</span>primary
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style="color:#ce5c00;font-weight:bold">=</span>prefer-standby
</span></span></code></pre></div><hr>
<h2 id="覆盖服务">覆盖服务</h2>
<p>你可以通过多种方式覆盖默认的服务配置，一种常见的需求是让 <a href="/zh/docs/pgsql/svc/#primary服务">Primary服务</a> 与 <a href="/zh/docs/pgsql/svc/#replica服务">Replica服务</a> 绕过Pgbouncer连接池，直接访问 PostgreSQL 数据库。</p>
<p>为了实现这一点，你可以将 <a href="/zh/docs/reference/param#pg_default_service_dest"><code>pg_default_service_dest</code></a> 更改为 <code>postgres</code>，这样所有服务定义中 <code>svc.dest='default'</code> 的服务都会使用 <code>postgres</code> 而不是默认的 <code>pgbouncer</code> 作为目标。</p>
<p>如果您已经将 <a href="/zh/docs/pgsql/svc/#primary服务">Primary服务</a> 指向了 PostgreSQL，那么 <a href="/zh/docs/pgsql/svc/#default服务">default服务</a> 就会比较多余，可以考虑移除。</p>
<p>如果您不需要区分个人交互式查询，分析/ETL慢查询，可以考虑从默认服务列表 <a href="/zh/docs/reference/param#pg_default_services"><code>pg_default_services</code></a> 中移除<a href="/zh/docs/pgsql/svc/#offline服务">Offline服务</a>。</p>
<p>如果您不需要只读从库来分担在线只读流量，也可以从默认服务列表中移除 <a href="/zh/docs/pgsql/svc/#replica服务">Replica服务</a>。</p>
<hr>
<h2 id="委托服务">委托服务</h2>
<p>Pigsty 通过节点上的 haproxy 暴露 PostgreSQL 服务。整个集群中的所有 haproxy 实例都使用相同的<a href="/zh/docs/pgsql/svc/#定义服务">服务定义</a>进行配置。</p>
<p>但是，你可以将 pg 服务委托给特定的节点分组（例如，专门的 haproxy 负载均衡器集群），而不是 PostgreSQL 集群成员上的 haproxy。</p>
<p>为此，你需要使用 <a href="/zh/docs/reference/param#pg_default_services"><code>pg_default_services</code></a> 覆盖默认的服务定义，并将 <a href="/zh/docs/reference/param#pg_service_provider"><code>pg_service_provider</code></a> 设置为代理组名称。</p>
<p>例如，此配置将在端口 10013 的 <code>proxy</code> haproxy 节点组上公开 pg 集群的主服务。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_service_provider</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">proxy      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 使用端口 10013 上的 `proxy` 组的负载均衡器</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_default_services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: primary ,port: 10013 ,dest: postgres  ,check: /primary   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>用户需要确保每个委托服务的端口，在代理集群中都是<strong>唯一</strong>的。</p>
<p>在 43 节点生产环境仿真<a href="/zh/docs/setup/provision#%E6%B2%99%E7%AE%B1%E7%8E%AF%E5%A2%83">沙箱</a>中提供了一个使用专用负载均衡器集群的例子：<a href="https://github.com/Vonng/pigsty/blob/main/conf/prod.yml#L111">prod.yml</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-07d77c313c9a2410ca022115a263dafc">6 - 扩展插件</h1>
    <div class="lead">定义，创建，安装，启用 PostgreSQL 插件。</div>
	<blockquote>
<p>扩展是 PostgreSQL 的灵魂所在</p>
</blockquote>
<p>Pigsty 收录了 340 个预先编译打包、开箱即用的 PostgreSQL 强力扩展插件，其中包括一些强力扩展：</p>
<ul>
<li><a href="https://postgis.net/"><strong>PostGIS</strong></a>：提供地理空间数据类型与索引支持，GIS 事实标准 （&amp; <a href="https://pgpointcloud.github.io/pointcloud/"><strong>pgPointCloud</strong></a> 点云，<a href="https://pgrouting.org/"><strong>pgRouting</strong></a> 寻路）</li>
<li><a href="https://www.timescale.com/"><strong>TimescaleDB</strong></a>：添加时间序列/持续聚合/分布式/列存储/自动压缩的能力</li>
<li><a href="https://github.com/pgvector/pgvector"><strong>PGVector</strong></a>：添加 AI 向量/嵌入数据类型支持，以及 ivfflat 与 hnsw 向量索引。（&amp; <a href="https://github.com/paradedb/paradedb/tree/dev/pg_sparse"><strong>pg_sparse</strong></a> 稀疏向量支持）</li>
<li><a href="https://www.citusdata.com/"><strong>Citus</strong></a>：将经典的主从PG集群原地改造为水平分片的分布式数据库集群。</li>
<li><a href="https://www.hydra.so/"><strong>Hydra</strong></a>：添加列式存储与分析能力，提供比肩 ClickHouse 的强力分析能力。</li>
<li><a href="https://www.paradedb.com/"><strong>ParadeDB</strong></a>：添加 ElasticSearch 水准的全文搜索能力与混合检索的能力。（&amp; <a href="https://github.com/amutu/zhparser"><strong>zhparser</strong></a> 中文分词）</li>
<li><a href="https://age.apache.org/"><strong>Apache AGE</strong></a>：图数据库扩展，为 PostgreSQL 添加类 Neo4J 的 OpenCypher 查询支持，</li>
<li><a href="https://github.com/supabase/pg_graphql"><strong>PG GraphQL</strong></a>：为 PostgreSQL 添加原生内建的 GraphQL 查询语言支持。</li>
<li><a href="https://github.com/alitrack/duckdb_fdw"><strong>DuckDB FDW</strong></a>：允许您通过 PostgreSQL 直接读写强力的嵌入式分析数据库 <a href="https://github.com/Vonng/pigsty/tree/master/app/duckdb"><strong>DuckDB</strong></a> 文件 （&amp; DuckDB CLI 本体）。</li>
<li><a href="https://github.com/Vonng/pigsty/tree/master/app/supabase"><strong>Supabase</strong></a>：基于 PostgreSQL 的开源的 Firebase 替代，提供完整的应用开发存储解决方案。</li>
<li><a href="https://github.com/Vonng/pigsty/tree/master/app/ferretdb"><strong>FerretDB</strong></a>：基于 PostgreSQL 的开源 MongoDB 替代，兼容 MongoDB API / 驱动协议。</li>
<li><a href="https://github.com/Vonng/pigsty/tree/master/app/pgml"><strong>PostgresML</strong></a>：使用SQL完成经典机器学习算法，调用、部署、训练 AI 模型。</li>
</ul>
<p><a href="/zh/docs/pgsql/extension/#扩展列表"><img alt="pigsty-extension.jpg" src="/img/pigsty/extension.png"></a></p>
<p>绝大部分扩展都是可以并存甚至组合使用的，妙用扩展可以产生 1+1 远大于 2 的协同增幅效应（例外：hydra 与 citus 互斥），实现 PostgreSQL for Everything！</p>
<p>绝大多数插件插件都已经收录放置在基础设施节点上的本地软件源中，可以直接通过 <code>yum</code>/<code>apt</code> 命令安装。您可以通过 Pigsty 配置文件指定需要下载、安装、启用的扩展，并自动完成安装与配置。</p>
<p>此外，有一些“数据库”其实并不是 PostgreSQL 扩展插件，但是基于 PostgreSQL，或与其密切相关。因此也收录在 Pigsty 中提供原生支持，
比如基于 PostgreSQL 提供开源 MongoDB 替代的 <a href="https://github.com/Vonng/pigsty/tree/master/app/ferretdb">FerretDB</a>，提供开源 Airtable 替代的 <a href="https://github.com/Vonng/pigsty/tree/master/app/nocodb">NocoDB</a>，提供交互式分析检视的 <a href="https://github.com/Vonng/pigsty/tree/master/app/metabase">Metabase</a> 等。</p>
<hr>
<h2 id="默认扩展">默认扩展</h2>
<p>当您初始化 PostgreSQL 集群时，列于 <a href="/zh/docs/reference/param#pg_packages"><code>pg_packages</code></a> 与 <a href="/zh/docs/reference/param#pg_extension"><code>pg_extensions</code></a> 中列出的扩展插件将会被安装。</p>
<p>在 EL 系列系统（默认）和 Ubuntu/Debian 系列系统中，包的名称略有不同。但通常包含 <code>pg</code> (el) / <code>postgres</code> (deb)，和 PG 大版本号（目前默认为 16）。</p>
<p>Pigsty 允许在这两个变量中使用 <code>${pg_version}</code> 占位符，它将被自动替换成集群安装的 PG 大版本号。</p>
<p>在 EL / RPM （默认）系统中，默认安装的扩展为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_packages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic"># 这三个扩展插件总是随主干大版本一起安装： pg_repack, wal2json, passwordcheck_cracklib</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">pg_repack_${pg_version}* wal2json_${pg_version}* passwordcheck_cracklib_${pg_version}*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 待安装的 pg 扩展列表，默认安装 postgis，timescaledb，pgvector</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">postgis34_${pg_version}* timescaledb-2-postgresql-${pg_version}* pgvector_${pg_version}*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在 Ubuntu / Debian 系统中，默认安装的扩展为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_packages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 这两个扩展插件总是随主干大版本一起安装： pg_repack, wal2json</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">postgresql-${pg_version}-repack postgresql-${pg_version}-wal2json</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 待安装的 pg 扩展列表，默认安装 postgis，timescaledb，pgvector，citus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">postgresql-${pg_version}-postgis* timescaledb-2-postgresql-${pg_version} postgresql-${pg_version}-pgvector postgresql-${pg_version}-citus-12.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>因此，Pigsty 默认安装的扩展为：</p>
<ul>
<li><code>postgis</code>：地理空间数据库扩展（注意：EL7 的版本为 3.3，Ubuntu20 需要在线安装）</li>
<li><code>timescaledb</code>：时序数据库扩展插件（从 TimescaleDB 独立的仓库下载安装，特殊的包名）</li>
<li><code>pgvector</code>：向量数据类型与IVFFLAT/HNSW索引，向量数据库替代。</li>
<li><code>pg_repack</code>：在线处理表膨胀的维护性扩展：对于维护数据库健康非常重要，默认启用。</li>
<li><code>wal2json</code>：通过逻辑解码抽取JSON格式的变更：对于抽取数据库变更非常实用，无需显式启用。</li>
<li><code>passwordcheck_cracklib</code>：强制用户密码强度/过期策略，此扩展默认安装但可选，仅在EL中可用。</li>
<li><code>citus</code>：默认在 Debian/Ubuntu 中安装，EL系因为与 Fork 出来的列存插件 <code>hydra</code>冲突，用户可以二者择一安装。</li>
</ul>
<p>您也可以在集群初始化完成后再安装新扩展插件，如下一节所示。</p>
<hr>
<h2 id="扩展安装">扩展安装</h2>
<p>当集群已经完成初始化后，如果您需要向集群中安装新扩展，可以向 <a href="/zh/docs/reference/param#pg_extensions"><code>pg_extensions</code></a> 中添加扩展名称，并通过剧本完成安装。</p>
<p>例如，如果您想在 <code>pg-meta</code> 集群中安装用于分析的 <code>hydra</code> 与 <code>pg_lakehouse</code> 扩展，可以在集群配置文件中添加：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1 ,pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># &lt;----- 在数据库中启用这些扩展 (`CREATE EXTENSION`)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: postgis, schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">public }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">timescaledb  }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_lakehouse }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;---- 新增扩展</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">duckdb_fdw   }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;---- 新增扩展</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hydra        }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;---- 新增扩展</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_libs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;timescaledb, pg_cron, pg_stat_statements, auto_explain&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;- 个别扩展需要加载动态库方可运行</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 安装到集群中的扩展列表 (yum/apt install)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">postgis34_${pg_version}* timescaledb-2-postgresql-${pg_version}* pgvector_${pg_version}*         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 默认安装的三个扩展，如果需要，不要忘记保留</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">pg_lakehouse_${pg_version}* duckdb_fdw_${pg_version}* hydra_${pg_version}* #citus_${pg_version}* </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;-----+ 新增扩展</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#- pg_bm25_${pg_version}* pg_sparse_${pg_version}* zhparser_${pg_version}*                          # 其他备选扩展</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#- pg_graphql_${pg_version} pg_net_${pg_version}* pgsql-http_${pg_version}* vault_${pg_version} pgjwt_${pg_version} pg_tle_${pg_version}*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#- pgml_${pg_version}* apache-age_${pg_version}* pg_roaringbitmap_${pg_version}* pointcloud_${pg_version}* pgsql-gzip_${pg_version}* pglogical_${pg_version}* pg_cron_${pg_version}*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#- orafce_${pg_version}* mongo_fdw_${pg_version}* tds_fdw_${pg_version}* mysql_fdw_${pg_version} hdfs_fdw_${pg_version} sqlite_fdw_${pg_version} pgbouncer_fdw_${pg_version} powa_${pg_version}* pg_stat_kcache_${pg_version}* pg_stat_monitor_${pg_version}* pg_qualstats_${pg_version} pg_track_settings_${pg_version} pg_wait_sampling_${pg_version} hll_${pg_version} pgaudit_${pg_version}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#- plprofiler_${pg_version}* plsh_${pg_version}* pldebugger_${pg_version} plpgsql_check_${pg_version}* pgtt_${pg_version} pgq_${pg_version}* pgsql_tweaks_${pg_version} count_distinct_${pg_version} hypopg_${pg_version} timestamp9_${pg_version}* semver_${pg_version}* prefix_${pg_version}* periods_${pg_version} ip4r_${pg_version} tdigest_${pg_version} pgmp_${pg_version} extra_window_functions_${pg_version} topn_${pg_version}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#- pg_background_${pg_version} e-maj_${pg_version} pg_prioritize_${pg_version} pgcryptokey_${pg_version} logerrors_${pg_version} pg_top_${pg_version} pg_comparator_${pg_version} pg_ivm_${pg_version}* pgsodium_${pg_version}* pgfincore_${pg_version}* ddlx_${pg_version} credcheck_${pg_version} safeupdate_${pg_version} pg_squeeze_${pg_version}* pg_fkpart_${pg_version} pg_jobmon_${pg_version}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#- pg_partman_${pg_version} pg_permissions_${pg_version} pgexportdoc_${pg_version} pgimportdoc_${pg_version} pg_statement_rollback_${pg_version}* pg_hint_plan_${pg_version}* pg_auth_mon_${pg_version} pg_checksums_${pg_version} pg_failover_slots_${pg_version} pg_readonly_${pg_version}* pg_uuidv7_${pg_version}* set_user_${pg_version}* rum_${pg_version}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>使用 <a href="/zh/docs/pgsql/playbook#pgsqlyml"><code>pgsql.yml</code></a> 的 <code>pg_extension</code> 子任务，为已经创建好的集群添加扩展：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -l pg-meta -t pg_extension    <span style="color:#8f5902;font-style:italic"># 为集群安装指定的扩展插件</span>
</span></span></code></pre></div><p>您也可以在数据库服务器上使用 <code>yum</code> | <code>apt</code> 命令直接安装扩展软件包，或者使用 Ansible 模块来批量完成安装，但是这样您必须显式指明扩展的大版本号（目前为 16）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty<span style="color:#000;font-weight:bold">;</span>               <span style="color:#8f5902;font-style:italic"># 在管理节点上进入 pigsty 源码目录，为 pg-test 集群安装 pg_analytics 与 hydra 扩展</span>
</span></span><span style="display:flex;"><span>ansible pg-meta -m package -b -a <span style="color:#4e9a06">&#39;name=pg_analytics_16&#39;</span>     <span style="color:#8f5902;font-style:italic"># 扩展的名称通常后缀以 `_&lt;pgmajorversion&gt;`</span>
</span></span><span style="display:flex;"><span>ansible pg-meta -m package -b -a <span style="color:#4e9a06">&#39;name=hydra_16*&#39;</span>           <span style="color:#8f5902;font-style:italic"># 例如，您的数据库大版本为16，那么就应该在扩展yum包之后添加 `_16`</span>
</span></span></code></pre></div><p>请注意，Pigsty 默认只下载 PG 主版本（PG16）上的主流扩展插件，当您使用其他大版本的 PostgreSQL 时，应当调整 <a href="/zh/docs/reference/param#repo_packages"><code>repo_packages</code></a> 中下载的插件名称。</p>
<hr>
<h2 id="扩展启用">扩展启用</h2>
<p>安装 PostgreSQL 扩展后，您可以在 PostgreSQL 的 <code>pg_available_extensions</code> 视图中看到它们。但想要实际启用扩展，通常还需要额外的步骤：</p>
<ol>
<li>一部分扩展要求被添加到 <code>shared_preload_libraries</code> 中动态加载，例如 <code>timescaledb</code>，<code>citus</code> 等。</li>
<li>大部分扩展都需要通过 SQL 语句：<code>CREATE EXTENSION &lt;name&gt;;</code> 启用，极少量扩展不需要，例如 <code>wal2json</code>。</li>
</ol>
<ul>
<li>修改 <code>shared_preload_libraries</code>：
<ul>
<li>在数据库集群初始化前，可以通过 <a href="/zh/docs/reference/param#pg_libs"><code>pg_libs</code></a> 参数手工预先指定；</li>
<li>当数据库已经初始化完毕后，您可以修改<a href="/zh/docs/pgsql/admin#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4">集群配置</a>，直接修改 <code>shared_preload_libraries</code> 参数并应用（无需重启）。</li>
<li>需要动态加载的典型插件：<code>citus</code>, <code>timescaledb</code>, <code>pg_cron</code>, <code>pg_net</code>, <code>pg_tle</code></li>
</ul>
</li>
<li>执行 <code>CREATE EXTENSION</code>：
<ul>
<li>在数据库集群初始化前，可以在 <a href="/zh/docs/reference/param#pg_databases"><code>pg_databases</code></a>.<code>extensions</code> 列表中指定。</li>
<li>当数据库已经初始化完毕后，您可以直接连接数据库执行此 SQL 命令，或使用其他模式变更工具管理扩展。</li>
</ul>
</li>
</ul>
<blockquote>
<p>从原理上讲：PostgreSQL 的扩展通常由 Control文件（元数据，一定存在），SQL文件（SQL语句，可选），So文件（二进制动态连接库，可选）三部分组成。
提供 <code>.so</code> 文件的扩展有可能需要添加到 <code>shared_preload_libraries</code> 才能生效，例如 <code>citus</code> 与 <code>timescaledb</code>，但也有许多扩展不用，例如 <code>postgis</code>，<code>pgvector</code>。
不通过 SQL 接口对外服务的扩展不需要执行 <code>CREATE EXTENSION</code>，例如提供 CDC 抽取能力的 <code>wal2json</code> 扩展。</p>
</blockquote>
<p>在您希望启用扩展的数据库中执行 <code>CREATE EXTENSION</code> SQL 语句，即可完成扩展的创建：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vector</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- 安装向量数据库扩展
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hydra</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- 安装列存数据库扩展
</span></span></span></code></pre></div><hr>
<h2 id="扩展下载">扩展下载</h2>
<p>Pigsty 默认从 PostgreSQL 官方软件源下载扩展插件，如果您希望使用 Pigsty 没有收录的扩展，可以选择直接编译安装，
或者下载 RPM/DEB 包放置于管理节点上的本地软件源中（<code>/www/pigsty</code>），供所有节点使用，详情参考管理SOP-<a href="/zh/docs/pgsql/admin#%E6%B7%BB%E5%8A%A0%E8%BD%AF%E4%BB%B6">添加软件</a>。</p>
<ul>
<li>YUM: <a href="https://download.postgresql.org/pub/repos/yum/16/redhat/">https://download.postgresql.org/pub/repos/yum/16/redhat/</a></li>
<li>APT: <a href="http://apt.postgresql.org/pub/repos/apt/">http://apt.postgresql.org/pub/repos/apt/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d353f8b723fb78c622e9dd520898a3dd">7 - 认证 / HBA</h1>
    <div class="lead">Pigsty 中基于主机的身份认证 HBA（Host-Based Authentication）详解。</div>
	<blockquote>
<p>Pigsty 中基于主机的身份认证 HBA（Host-Based Authentication）详解。</p>
</blockquote>
<p>认证是 <a href="/zh/docs/pgsql/acl">访问控制</a> 与 <a href="/zh/docs/pgsql/acl#%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F">权限系统</a> 的基石，PostgreSQL拥有多种<a href="https://www.postgresql.org/docs/current/client-authentication.html">认证</a>方法。</p>
<p>这里主要介绍 HBA：Host Based Authentication，HBA规则定义了哪些用户能够通过哪些方式从哪些地方访问哪些数据库。</p>
<hr>
<h2 id="客户端认证">客户端认证</h2>
<p>要连接到PostgreSQL数据库，用户必须先经过认证（默认使用密码）。</p>
<p>您可以在连接字符串中提供密码（不安全）或使用<code>PGPASSWORD</code>环境变量或<code>.pgpass</code>文件传递密码。参考<a href="https://www.postgresql.org/docs/current/app-psql.html#usage"><code>psql</code></a>文档和<a href="https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING">PostgreSQL连接字符串</a>以获取更多详细信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql <span style="color:#4e9a06">&#39;host=&lt;host&gt; port=&lt;port&gt; dbname=&lt;dbname&gt; user=&lt;username&gt; password=&lt;password&gt;&#39;</span>
</span></span><span style="display:flex;"><span>psql postgres://&lt;username&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;dbname&gt;
</span></span><span style="display:flex;"><span><span style="color:#000">PGPASSWORD</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;password&gt;<span style="color:#000;font-weight:bold">;</span> psql -U &lt;username&gt; -h &lt;host&gt; -p &lt;port&gt; -d &lt;dbname&gt;
</span></span></code></pre></div><p>例如，连接 Pigsty 默认的 <code>meta</code> 数据库，可以使用以下连接串：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql <span style="color:#4e9a06">&#39;host=10.10.10.10 port=5432 dbname=meta user=dbuser_dba password=DBUser.DBA&#39;</span>
</span></span><span style="display:flex;"><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta
</span></span><span style="display:flex;"><span><span style="color:#000">PGPASSWORD</span><span style="color:#ce5c00;font-weight:bold">=</span>DBUser.DBA<span style="color:#000;font-weight:bold">;</span> psql -U dbuser_dba -h 10.10.10.10 -p <span style="color:#0000cf;font-weight:bold">5432</span> -d meta
</span></span></code></pre></div><p>默认配置下，Pigsty会启用服务端 SSL 加密，但不验证客户端 SSL 证书。要使用客户端SSL证书连接，你可以使用<code>PGSSLCERT</code>和<code>PGSSLKEY</code>环境变量或<code>sslkey</code>和<code>sslcert</code>参数提供客户端参数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql <span style="color:#4e9a06">&#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta?sslkey=/path/to/dbuser_dba.key&amp;sslcert=/path/to/dbuser_dba.crt&#39;</span>
</span></span></code></pre></div><p>客户端证书（<code>CN</code> = 用户名）可以使用本地CA与<a href="https://github.com/Vonng/pigsty/blob/main/cert.yml"><code>cert.yml</code></a>剧本签发。</p>
<hr>
<h2 id="定义hba">定义HBA</h2>
<p>在Pigsty中，有四个与HBA规则有关的参数：</p>
<ul>
<li><a href="/zh/docs/reference/param#pg_hba_rules"><code>pg_hba_rules</code></a>：postgres HBA规则</li>
<li><a href="/zh/docs/reference/param#pg_default_hba_rules"><code>pg_default_hba_rules</code></a>：postgres 全局默认HBA规则</li>
<li><a href="/zh/docs/reference/param#pgb_hba_rules"><code>pgb_hba_rules</code></a>：pgbouncer HBA规则</li>
<li><a href="/zh/docs/reference/param#pgb_default_hba_rules"><code>pgb_default_hba_rules</code></a>：pgbouncer 全局默认HBA规则</li>
</ul>
<p>这些都是 HBA 规则对象的数组，每个HBA规则都是以下两种形式之一的对象：</p>
<h3 id="1-原始形式">1. 原始形式</h3>
<p>原始形式的 HBA 与 PostgreSQL <code>pg_hba.conf</code> 的格式几乎完全相同：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow intranet password access</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">common</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">host   all  all  10.0.0.0/8      md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">host   all  all  172.16.0.0/12   md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">host   all  all  192.168.0.0/16  md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在这种形式中，<code>rules</code> 字段是字符串数组，每一行都是条原始形式的 <a href="https://www.postgresql.org/docs/current/auth-pg-hba-conf.html">HBA规则</a>。<code>title</code> 字段会被渲染为一条注释，解释下面规则的作用。</p>
<p><code>role</code> 字段用于说明该规则适用于哪些实例角色，当实例的<a href="/zh/docs/reference/param#pg_role"><code>pg_role</code></a>与<code>role</code>相同时，HBA规则将被添加到这台实例的 HBA 中。</p>
<ul>
<li><code>role: common</code>的HBA规则将被添加到所有实例上。</li>
<li><code>role: primary</code> 的 HBA 规则只会添加到主库实例上。</li>
<li><code>role: replica</code> 的 HBA 规则只会添加到从库实例上。</li>
<li><code>role: offline</code>的HBA规则将被添加到离线实例上（ <a href="/zh/docs/reference/param#pg_role"><code>pg_role</code></a> = <code>offline</code>或<a href="/zh/docs/reference/param#pg_offline_query"><code>pg_offline_query</code></a> = <code>true</code>）</li>
</ul>
<h3 id="2-别名形式">2. 别名形式</h3>
<p>别名形式允许您用更简单清晰便捷的方式维护 HBA 规则：它用<code>addr</code>、<code>auth</code>、<code>user</code>和<code>db</code> 字段替换了 <code>rules</code>。 <code>title</code> 和 <code>role</code> 字段则仍然生效。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">addr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;intra&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># world|intra|infra|admin|local|localhost|cluster|&lt;cidr&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">auth</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># trust|pwd|ssl|cert|deny|&lt;official auth method&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all&#39;</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># all|${dbsu}|${repl}|${admin}|${monitor}|&lt;user&gt;|&lt;group&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">db</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all&#39;</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># all|replication|....</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># raw hba string precedence over above all</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow intranet password access</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li><code>addr</code>: <strong>where</strong> 哪些IP地址段受本条规则影响？
<ul>
<li><code>world</code>: 所有的IP地址</li>
<li><code>intra</code>: 所有的内网IP地址段： <code>'10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16'</code></li>
<li><code>infra</code>: Infra节点的IP地址</li>
<li><code>admin</code>: <code>admin_ip</code> 管理节点的IP地址</li>
<li><code>local</code>: 本地 Unix Socket</li>
<li><code>localhost</code>: 本地 Unix Socket 以及TCP 127.0.0.1/32 环回地址</li>
<li><code>cluster</code>: 同一个 PostgresQL 集群所有成员的IP地址</li>
<li><code>&lt;cidr&gt;</code>: 一个特定的 CIDR 地址块或IP地址</li>
</ul>
</li>
<li><code>auth</code>: <strong>how</strong> 本条规则指定的认证方式？
<ul>
<li><code>deny</code>: 拒绝访问</li>
<li><code>trust</code>: 直接信任，不需要认证</li>
<li><code>pwd</code>: 密码认证，根据 <a href="/zh/docs/reference/param#pg_pwd_enc"><code>pg_pwd_enc</code></a> 参数选用 <code>md5</code> 或 <code>scram-sha-256</code> 认证</li>
<li><code>sha</code>/<code>scram-sha-256</code>：强制使用 <code>scram-sha-256</code> 密码认证方式。</li>
<li><code>md5</code>: <code>md5</code> 密码认证方式，但也可以兼容  <code>scram-sha-256</code> 认证，不建议使用。</li>
<li><code>ssl</code>: 在密码认证 <code>pwd</code> 的基础上，强制要求启用SSL</li>
<li><code>ssl-md5</code>: 在密码认证 <code>md5</code> 的基础上，强制要求启用SSL</li>
<li><code>ssl-sha</code>: 在密码认证 <code>sha</code> 的基础上，强制要求启用SSL</li>
<li><code>os</code>/<code>ident</code>: 使用操作系统用户的身份进行 <code>ident</code> 认证</li>
<li><code>peer</code>: 使用 <code>peer</code> 认证方式，类似于 <code>os ident</code></li>
<li><code>cert</code>: 使用基于客户端SSL证书的认证方式，证书CN为用户名</li>
</ul>
</li>
<li><code>user</code>: <strong>who</strong>：哪些用户受本条规则影响？
<ul>
<li><code>all</code>: 所有用户</li>
<li><code>${dbsu}</code>: 默认数据库超级用户 <a href="/zh/docs/reference/param#pg_dbsu"><code>pg_dbsu</code></a></li>
<li><code>${repl}</code>: 默认数据库复制用户 <a href="/zh/docs/reference/param#pg_replication_username"><code>pg_replication_username</code></a></li>
<li><code>${admin}</code>: 默认数据库管理用户 <a href="/zh/docs/reference/param#pg_admin_username"><code>pg_admin_username</code></a></li>
<li><code>${monitor}</code>: 默认数据库监控用户 <a href="/zh/docs/reference/param#pg_monitor_username"><code>pg_monitor_username</code></a></li>
<li>其他特定的用户或者角色</li>
</ul>
</li>
<li><code>db</code>: <strong>which</strong>：哪些数据库受本条规则影响？
<ul>
<li><code>all</code>: 所有数据库</li>
<li><code>replication</code>: 允许建立复制连接（不指定特定数据库）</li>
<li>某个特定的数据库</li>
</ul>
</li>
</ul>
<h3 id="3-定义位置">3. 定义位置</h3>
<p>通常，全局的HBA定义在 <code>all.vars</code> 中，如果您想要修改全局默认的HBA规则，可以从 <a href="https://github.com/Vonng/pigsty/blob/main/conf/full.yml#L690"><code>full.yml</code></a> 模板中复制一份到 <code>all.vars</code> 中进行修改。</p>
<ul>
<li><a href="/zh/docs/reference/param#pg_default_hba_rules"><code>pg_default_hba_rules</code></a>：postgres 全局默认HBA规则</li>
<li><a href="/zh/docs/reference/param#pgb_default_hba_rules"><code>pgb_default_hba_rules</code></a>：pgbouncer 全局默认HBA规则</li>
</ul>
<p>而集群特定的 HBA 规则定义在数据库的集群级配置中：</p>
<ul>
<li><a href="/zh/docs/reference/param#pg_hba_rules"><code>pg_hba_rules</code></a>：postgres HBA规则</li>
<li><a href="/zh/docs/reference/param#pgb_hba_rules"><code>pgb_hba_rules</code></a>：pgbouncer HBA规则</li>
</ul>
<p>下面是一些集群HBA规则的定义例子：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user: dbuser_view ,db: all    ,addr: infra        ,auth: pwd  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;允许 dbuser_view 从基础设施节点密码访问所有库&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user: all         ,db: all    ,addr: 100.0.0.0/8  ,auth: pwd  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;允许所有用户从K8S网段密码访问所有库&#39;</span><span style="color:#f8f8f8;text-decoration:underline">          </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">,db: world  ,addr: 0.0.0.0/0    ,auth: cert ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;允许管理员用户从任何地方用客户端证书登陆&#39;</span><span style="color:#f8f8f8;text-decoration:underline">       </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="重载hba">重载HBA</h2>
<p>HBA 是一个静态的规则配置文件，修改后需要重载才能生效。默认的 HBA 规则集合因为不涉及 Role 与集群成员，所以通常不需要重载。</p>
<p>如果您设计的 HBA 使用了特定的实例角色限制，或者集群成员限制，那么当集群实例成员发生变化（新增/下线/主从切换），一部分HBA规则的生效条件/涉及范围发生变化，通常也需要<a href="/zh/docs/pgsql/admin#%E9%87%8D%E8%BD%BDhba">重载HBA</a>以反映最新变化。</p>
<p>要重新加载 postgres/pgbouncer 的 hba 规则：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-hba &lt;cls&gt;                 <span style="color:#8f5902;font-style:italic"># 重新加载集群 `&lt;cls&gt;` 的 hba 规则</span>
</span></span><span style="display:flex;"><span>bin/pgsql-hba &lt;cls&gt; ip1 ip2...      <span style="color:#8f5902;font-style:italic"># 重新加载特定实例的 hba 规则</span>
</span></span></code></pre></div><p>底层实际执行的 Ansible 剧本命令为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -l &lt;cls&gt; -e <span style="color:#000">pg_reload</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> -t pg_hba,pg_reload
</span></span><span style="display:flex;"><span>./pgsql.yml -l &lt;cls&gt; -e <span style="color:#000">pg_reload</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> -t pgbouncer_hba,pgbouncer_reload
</span></span></code></pre></div><hr>
<h2 id="默认hba">默认HBA</h2>
<p>Pigsty 有一套默认的 HBA 规则，对于绝大多数场景来说，它已经足够安全了。这些规则使用别名形式，因此基本可以自我解释。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_default_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># postgres 全局默认的HBA规则 </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: local     ,auth: ident ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu access via local os user ident&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: local     ,auth: ident ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu replication from local os ident&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator replication from localhost&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator replication from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: postgres    ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator postgres db from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor from localhost with password&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: infra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor from infra host with password&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin @ infra nodes with pwd &amp; ssl&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: world     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin @ everywhere with ssl &amp; pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pgbouncer read/write via local socket&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;read/write biz user via password&#39;</span><span style="color:#f8f8f8;text-decoration:underline">     </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow etl offline tasks from intranet&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgb_default_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># pgbouncer 全局默认的HBA规则 </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: pgbouncer   ,addr: local     ,auth: peer  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu local admin access with os ident&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow all user local access with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: pgbouncer   ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor access via intranet with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: world     ,auth: deny  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;reject all other monitor access addr&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin access via intranet with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: world     ,auth: deny  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;reject all other admin access addr&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow all user intra access with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><details><summary>示例：渲染 pg_hba.conf</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#==============================================================#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># File      :   pg_hba.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Desc      :   Postgres HBA Rules for pg-meta-1 [primary]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Time      :   2023-01-11 15:19</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Host      :   pg-meta-1 @ 10.10.10.10:5432</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Path      :   /pg/data/pg_hba.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note      :   ANSIBLE MANAGED, DO NOT CHANGE!</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Author    :   Ruohang Feng (rh@vonng.com)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># License   :   AGPLv3</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#==============================================================#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># addr alias</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># local     : /var/run/postgresql</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># admin     : 10.10.10.10</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># infra     : 10.10.10.10</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># intra     : 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># user alias</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dbsu    :  postgres</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># repl    :  replicator</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># monitor :  dbuser_monitor</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># admin   :  dbuser_dba</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dbsu access via local os user ident [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">local    all                postgres                              ident</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dbsu replication from local os ident [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">local    replication        postgres                              ident</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># replicator replication from localhost [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">local    replication        replicator                            scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     replication        replicator         127.0.0.1/32       scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># replicator replication from intranet [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     replication        replicator         10.0.0.0/8         scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     replication        replicator         172.16.0.0/12      scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     replication        replicator         192.168.0.0/16     scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># replicator postgres db from intranet [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     postgres           replicator         10.0.0.0/8         scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     postgres           replicator         172.16.0.0/12      scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     postgres           replicator         192.168.0.0/16     scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># monitor from localhost with password [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">local    all                dbuser_monitor                        scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                dbuser_monitor     127.0.0.1/32       scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># monitor from infra host with password [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                dbuser_monitor     10.10.10.10/32     scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># admin @ infra nodes with pwd &amp; ssl [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">hostssl  all                dbuser_dba         10.10.10.10/32     scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># admin @ everywhere with ssl &amp; pwd [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">hostssl  all                dbuser_dba         0.0.0.0/0          scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pgbouncer read/write via local socket [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">local    all                +dbrole_readonly                      scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                +dbrole_readonly   127.0.0.1/32       scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># read/write biz user via password [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                +dbrole_readonly   10.0.0.0/8         scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                +dbrole_readonly   172.16.0.0/12      scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                +dbrole_readonly   192.168.0.0/16     scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allow etl offline tasks from intranet [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                +dbrole_offline    10.0.0.0/8         scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                +dbrole_offline    172.16.0.0/12      scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                +dbrole_offline    192.168.0.0/16     scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allow application database intranet access [common] [DISABLED]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#host    kong            dbuser_kong         10.0.0.0/8          md5</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#host    bytebase        dbuser_bytebase     10.0.0.0/8          md5</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#host    grafana         dbuser_grafana      10.0.0.0/8          md5</span>
</span></span></code></pre></div></details>
<details><summary>示例: 渲染 pgb_hba.conf</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#==============================================================#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># File      :   pgb_hba.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Desc      :   Pgbouncer HBA Rules for pg-meta-1 [primary]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Time      :   2023-01-11 15:28</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Host      :   pg-meta-1 @ 10.10.10.10:5432</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Path      :   /etc/pgbouncer/pgb_hba.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note      :   ANSIBLE MANAGED, DO NOT CHANGE!</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Author    :   Ruohang Feng (rh@vonng.com)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># License   :   AGPLv3</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#==============================================================#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># PGBOUNCER HBA RULES FOR pg-meta-1 @ 10.10.10.10:6432</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ansible managed: 2023-01-11 14:30:58</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># addr alias</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># local     : /var/run/postgresql</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># admin     : 10.10.10.10</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># infra     : 10.10.10.10</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># intra     : 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># user alias</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dbsu    :  postgres</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># repl    :  replicator</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># monitor :  dbuser_monitor</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># admin   :  dbuser_dba</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dbsu local admin access with os ident [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">local    pgbouncer          postgres                              peer</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allow all user local access with pwd [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">local    all                all                                   scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                all                127.0.0.1/32       scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># monitor access via intranet with pwd [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     pgbouncer          dbuser_monitor     10.0.0.0/8         scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     pgbouncer          dbuser_monitor     172.16.0.0/12      scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     pgbouncer          dbuser_monitor     192.168.0.0/16     scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># reject all other monitor access addr [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                dbuser_monitor     0.0.0.0/0          reject</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># admin access via intranet with pwd [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                dbuser_dba         10.0.0.0/8         scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                dbuser_dba         172.16.0.0/12      scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                dbuser_dba         192.168.0.0/16     scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># reject all other admin access addr [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                dbuser_dba         0.0.0.0/0          reject</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allow all user intra access with pwd [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                all                10.0.0.0/8         scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                all                172.16.0.0/12      scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                all                192.168.0.0/16     scram-sha-256</span>
</span></span></code></pre></div></details>
<hr>
<h2 id="安全加固">安全加固</h2>
<p>对于那些需要更高安全性的场合，我们提供了一个安全加固的配置模板 <a href="https://github.com/Vonng/pigsty/blob/main/conf/safe.yml">security.yml</a>，使用了以下的默认 HBA 规则集：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_default_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># postgres host-based auth rules by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: local     ,auth: ident ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu access via local os user ident&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: local     ,auth: ident ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu replication from local os ident&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: localhost ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator replication from localhost&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator replication from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: postgres    ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator postgres db from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor from localhost with password&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor from infra host with password&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin @ infra nodes with pwd &amp; ssl&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: world     ,auth: cert  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin @ everywhere with ssl &amp; cert&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pgbouncer read/write via local socket&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;read/write biz user via password&#39;</span><span style="color:#f8f8f8;text-decoration:underline">     </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow etl offline tasks from intranet&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgb_default_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># pgbouncer host-based authentication rules</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: pgbouncer   ,addr: local     ,auth: peer  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu local admin access with os ident&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow all user local access with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: pgbouncer   ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor access via intranet with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: world     ,auth: deny  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;reject all other monitor access addr&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin access via intranet with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: world     ,auth: deny  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;reject all other admin access addr&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow all user intra access with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>更多信息，请参考<a href="/zh/docs/setup/security">安全加固</a>一节。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-61c2dced240f3df23a0a7e039b04b7d6">8 - 集群配置</h1>
    <div class="lead">根据需求场景选择合适的实例与集群类型，配置出满足需求的 PostgreSQL 数据库集群。</div>
	<blockquote>
<p>根据需求场景选择合适的实例与集群类型，配置出满足需求的 PostgreSQL 数据库集群。</p>
</blockquote>
<p>您可以定义不同类型的实例和集群，下面是 Pigsty 中常见的几种 PostgreSQL 实例/集群类型：</p>
<ul>
<li><a href="/zh/docs/pgsql/config/#读写主库">读写主库</a>：定义单一实例集群。</li>
<li><a href="/zh/docs/pgsql/config/#只读从库">只读从库</a>：定义具有一个主库和一个副本的基本HA集群。</li>
<li><a href="/zh/docs/pgsql/config/#离线从库">离线从库</a>：定义专用于OLAP/ETL/交互式查询的实例</li>
<li><a href="/zh/docs/pgsql/config/#同步备库">同步备库</a>：启用同步提交以确保没有数据丢失。</li>
<li><a href="/zh/docs/pgsql/config/#法定人数提交">法定人数提交</a>：使用多数同步提交获得更高的一致性级别。</li>
<li><a href="/zh/docs/pgsql/config/#备份集群">备份集群</a>：克隆现有集群并跟随它</li>
<li><a href="/zh/docs/pgsql/config/#延迟集群">延迟集群</a>：克隆现有集群用于紧急数据恢复</li>
<li><a href="/zh/docs/pgsql/config/#citus集群">Citus集群</a>：定义一个Citus分布式数据库集群</li>
<li><a href="/zh/docs/pgsql/config/#大版本切换">大版本切换</a>：使用不同的PostgreSQL大版本</li>
</ul>
<hr>
<h2 id="读写主库">读写主库</h2>
<p>我们从最简单的情况开始：由一个主库（Primary）组成的单实例集群：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这段配置言简意赅，仅由<a href="/zh/docs/pgsql/arch#%E8%BA%AB%E4%BB%BD%E5%8F%82%E6%95%B0">身份参数</a>构成。</p>
<p>使用以下命令在节点 <code>10.10.10.11</code> 上创建一个主库实例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-add pg-test
</span></span></code></pre></div><p>Demo展示，开发测试，承载临时需求，进行无关紧要的计算分析任务时，使用单一数据库实例可能并没有太大问题。但这样的单机集群没有<a href="/zh/docs/concept/ha">高可用</a>，当出现硬件故障时，您需要使用 <a href="/zh/docs/concept/pitr">PITR</a> 或其他恢复手段来确保集群的 RTO / RPO。为此，您可以考虑为集群添加若干个<a href="/zh/docs/pgsql/config/#只读从库">只读从库</a></p>
<hr>
<h2 id="只读从库">只读从库</h2>
<p>要添加一台只读从库（Replica）实例，您可以在 <code>pg-test</code> 中添加一个新节点，并将其 <a href="/zh/docs/reference/param#pg_role"><code>pg_role</code></a> 设置为<code>replica</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica } </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- 新添加的从库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>如果整个集群不存在，您可以直接<a href="/zh/docs/pgsql/admin#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4">创建</a>这个完整的集群。 如果集群主库已经初始化好了，那么您可以向现有集群<a href="/zh/docs/pgsql/admin#%E6%B7%BB%E5%8A%A0%E5%AE%9E%E4%BE%8B">添加</a>一个从库：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-add pg-test               <span style="color:#8f5902;font-style:italic"># 一次性初始化整个集群</span>
</span></span><span style="display:flex;"><span>bin/pgsql-add pg-test 10.10.10.12   <span style="color:#8f5902;font-style:italic"># 添加从库到现有的集群</span>
</span></span></code></pre></div><p>当集群主库出现故障时，只读实例（Replica）可以在高可用系统的帮助下接管主库的工作。除此之外，只读实例还可以用于执行只读查询：许多业务的读请求要比写请求多很多，而大部分只读查询负载都可以由从库实例承担。</p>
<hr>
<h2 id="离线从库">离线从库</h2>
<p>离线实例（Offline）是专门用于服务慢查询、ETL、OLAP流量和交互式查询等的专用只读从库。慢查询/长事务对在线业务的性能与稳定性有不利影响，因此最好将它们与在线业务隔离开来。</p>
<p>要添加离线实例，请为其分配一个新实例，并将<a href="/zh/docs/reference/param#pg_role"><code>pg_role</code></a>设置为<code>offline</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 3, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">offline } </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- 新添加的离线从库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>专用离线实例的工作方式与常见的从库实例类似，但它在 <code>pg-test-replica</code> 服务中用作备份服务器。 也就是说，只有当所有<code>replica</code>实例都宕机时，离线和主实例才会提供此项只读服务。</p>
<p>许多情况下，数据库资源有限，单独使用一台服务器作为离线实例是不经济的做法。作为折中，您可以选择一台现有的从库实例，打上 <a href="/zh/docs/reference/param#pg_offline_query"><code>pg_offline_query</code></a> 标记，将其标记为一台可以承载“离线查询”的实例。在这种情况下，这台只读从库会同时承担在线只读请求与离线类查询。您可以使用 <a href="/zh/docs/reference/param#pg_default_hba_rules"><code>pg_default_hba_rules</code></a>和<a href="/zh/docs/reference/param#pg_hba_rules"><code>pg_hba_rules</code></a> 对离线实例进行额外的访问控制。</p>
<hr>
<h2 id="同步备库">同步备库</h2>
<p>当启用同步备库（Sync Standby）时，PostgreSQL 将选择一个从库作为<strong>同步备库</strong>，其他所有从库作为<strong>候选者</strong>。 主数据库会等待备库实例刷新到磁盘，然后才确认提交，备库实例始终拥有最新的数据，没有复制延迟，主从切换至同步备库不会有数据丢失。</p>
<p>PostgreSQL 默认使用异步流复制，这可能会有小的复制延迟（10KB / 10ms 数量级）。当主库失败时，可能会有一个小的数据丢失窗口（可以使用<a href="/zh/docs/reference/param#pg_rpo"><code>pg_rpo</code></a>来控制），但对于大多数场景来说，这是可以接受的。</p>
<p>但在某些关键场景中（例如，金融交易），数据丢失是完全不可接受的，或者，读取复制延迟是不可接受的。在这种情况下，您可以使用同步提交来解决这个问题。 要启用同步备库模式，您可以简单地使用<a href="/zh/docs/reference/param#pg_conf"><code>pg_conf</code></a>中的<code>crit.yml</code>模板。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 3, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_conf</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">crit.yml  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- 使用 crit 模板</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>要在现有集群上启用同步备库，请<a href="/zh/docs/pgsql/admin#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4">配置集群</a>并启用 <code>synchronous_mode</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg edit-config pg-test    <span style="color:#8f5902;font-style:italic"># 在管理员节点以管理员用户身份运行</span>
</span></span><span style="display:flex;"><span>+++
</span></span><span style="display:flex;"><span>-synchronous_mode: <span style="color:#204a87">false</span>    <span style="color:#8f5902;font-style:italic"># &lt;--- 旧值</span>
</span></span><span style="display:flex;"><span>+synchronous_mode: <span style="color:#204a87">true</span>     <span style="color:#8f5902;font-style:italic"># &lt;--- 新值</span>
</span></span><span style="display:flex;"><span> synchronous_mode_strict: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>应用这些更改？<span style="color:#ce5c00;font-weight:bold">[</span>y/N<span style="color:#ce5c00;font-weight:bold">]</span>: y
</span></span></code></pre></div><p>在这种情况下，PostgreSQL 配置项 <a href="https://www.postgresql.org/docs/current/runtime-config-replication.html#synchronous_standby_names"><code>synchronous_standby_names</code></a> 由 Patroni 自动管理。
一台从库将被选拔为同步从库，它的 <code>application_name</code> 将被写入 PostgreSQL 主库配置文件中并应用生效。</p>
<hr>
<h2 id="法定人数提交">法定人数提交</h2>
<p>法定人数提交（Quorum Commit）提供了比同步备库更强大的控制能力：特别是当您有多个从库时，您可以设定提交成功的标准，实现更高/更低的一致性级别（以及可用性之间的权衡）。</p>
<p>如果想要<strong>最少两个从</strong>库来确认提交，可以通过 Patroni <a href="/zh/docs/pgsql/admin#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4">配置集群</a>，调整参数 <a href="https://patroni.readthedocs.io/en/latest/replication_modes.html#synchronous-replication-factor"><code>synchronous_node_count</code></a> 并应用生效</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">synchronous_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># 确保同步提交已经启用</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">synchronous_node_count</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># 指定“至少”有多少个从库提交成功，才算提交成功</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>如果你想要使用更多的同步从库，修改 <code>synchronous_node_count</code> 的取值即可。当集群的规模发生变化时，您应当确保这里的配置仍然是有效的，以避免服务不可用。</p>
<p>在这种情况下，PostgreSQL 配置项 <a href="https://www.postgresql.org/docs/current/runtime-config-replication.html#synchronous_standby_names"><code>synchronous_standby_names</code></a> 由 Patroni 自动管理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">synchronous_standby_names = &#39;2 (&#34;pg-test-3&#34;,&#34;pg-test-2&#34;)&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><details><summary>示例：使用多个同步从库</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg edit-config pg-test
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>+synchronous_node_count: <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Apply these changes? <span style="color:#ce5c00;font-weight:bold">[</span>y/N<span style="color:#ce5c00;font-weight:bold">]</span>: y
</span></span></code></pre></div><p>应用配置后，出现两个同步备库。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>+ Cluster: pg-test <span style="color:#ce5c00;font-weight:bold">(</span>7080814403632534854<span style="color:#ce5c00;font-weight:bold">)</span> +---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> Member    <span style="color:#000;font-weight:bold">|</span> Host        <span style="color:#000;font-weight:bold">|</span> Role         <span style="color:#000;font-weight:bold">|</span> State   <span style="color:#000;font-weight:bold">|</span> TL <span style="color:#000;font-weight:bold">|</span> Lag in MB <span style="color:#000;font-weight:bold">|</span> Tags            <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+--------------+---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-1 <span style="color:#000;font-weight:bold">|</span> 10.10.10.10 <span style="color:#000;font-weight:bold">|</span> Leader       <span style="color:#000;font-weight:bold">|</span> running <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-2 <span style="color:#000;font-weight:bold">|</span> 10.10.10.11 <span style="color:#000;font-weight:bold">|</span> Sync Standby <span style="color:#000;font-weight:bold">|</span> running <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-3 <span style="color:#000;font-weight:bold">|</span> 10.10.10.12 <span style="color:#000;font-weight:bold">|</span> Sync Standby <span style="color:#000;font-weight:bold">|</span> running <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+--------------+---------+----+-----------+-----------------+
</span></span></code></pre></div></details>
<p>另一种情景是，使用 <strong>任意n个</strong> 从库来确认提交。在这种情况下，配置的方式略有不同，例如，假设我们只需要任意一个从库确认提交：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">synchronous_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">quorum       </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 使用法定人数提交</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">postgresql</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># 修改 PostgreSQL 的配置参数 synchronous_standby_names ，使用 `ANY n ()` 语法</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">synchronous_standby_names</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;ANY 1 (*)&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 你可以指定具体的从库列表，或直接使用 * 通配所有从库。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><details><summary>示例：启用ANY法定人数提交</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg edit-config pg-test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>+    synchronous_standby_names: <span style="color:#4e9a06">&#39;ANY 1 (*)&#39;</span> <span style="color:#8f5902;font-style:italic"># 在 ANY 模式下，需要使用此参数</span>
</span></span><span style="display:flex;"><span>- synchronous_node_count: <span style="color:#0000cf;font-weight:bold">2</span>  <span style="color:#8f5902;font-style:italic"># 在 ANY 模式下， 不需要使用此参数</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Apply these changes? <span style="color:#ce5c00;font-weight:bold">[</span>y/N<span style="color:#ce5c00;font-weight:bold">]</span>: y
</span></span></code></pre></div><p>应用后，配置生效，所有备库在 Patroni 中变为普通的 replica。但是在 <code>pg_stat_replication</code> 中可以看到 <code>sync_state</code> 会变为 <code>quorum</code>。</p>
</details>
<hr>
<h2 id="备份集群">备份集群</h2>
<p>您可以克隆现有的集群，并创建一个备份集群（Standby Cluster），用于数据迁移、水平拆分、多区域部署，或灾难恢复。</p>
<p>在正常情况下，备份集群将追随上游集群并保持内容同步，您可以将备份集群提升，作为真正地独立集群。</p>
<p>备份集群的定义方式与正常集群的定义基本相同，除了在主库上额外定义了 <a href="/zh/docs/reference/param#pg_upstream"><code>pg_upstream</code></a> 参数，备份集群的主库被称为 <strong>备份集群领导者</strong> （Standby Leader）。</p>
<p>例如，下面定义了一个<code>pg-test</code>集群，以及其备份集群<code>pg-test2</code>，其配置清单可能如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pg-test 是原始集群</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg-test2 是 pg-test 的备份集群</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-test2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role: primary , pg_upstream</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.11</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- pg_upstream 在这里定义</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test2 }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>而 <code>pg-test2</code> 集群的主节点 <code>pg-test2-1</code> 将是 <code>pg-test</code> 的下游从库，并在<code>pg-test2</code>集群中充当备份集群领导者（<strong>Standby Leader</strong>）。</p>
<p>只需确保备份集群的主节点上配置了<a href="/zh/docs/reference/param#pg_upstream"><code>pg_upstream</code></a>参数，以便自动从原始上游拉取备份。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-add pg-test     <span style="color:#8f5902;font-style:italic"># 创建原始集群</span>
</span></span><span style="display:flex;"><span>bin/pgsql-add pg-test2    <span style="color:#8f5902;font-style:italic"># 创建备份集群</span>
</span></span></code></pre></div><details><summary>示例：更改复制上游</summary>
<p>如有必要（例如，上游发生主从切换/故障转移），您可以通过<a href="/zh/docs/pgsql/admin#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4">配置集群</a>更改备份集群的复制上游。</p>
<p>要这样做，只需将<code>standby_cluster.host</code>更改为新的上游IP地址并应用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg edit-config pg-test2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> standby_cluster:
</span></span><span style="display:flex;"><span>   create_replica_methods:
</span></span><span style="display:flex;"><span>   - basebackup
</span></span><span style="display:flex;"><span>-  host: 10.10.10.13     <span style="color:#8f5902;font-style:italic"># &lt;--- 旧的上游</span>
</span></span><span style="display:flex;"><span>+  host: 10.10.10.12     <span style="color:#8f5902;font-style:italic"># &lt;--- 新的上游</span>
</span></span><span style="display:flex;"><span>   port: <span style="color:#0000cf;font-weight:bold">5432</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> Apply these changes? <span style="color:#ce5c00;font-weight:bold">[</span>y/N<span style="color:#ce5c00;font-weight:bold">]</span>: y
</span></span></code></pre></div></details>
<details><summary>示例：提升备份集群</summary>
<p>你可以随时将备份集群提升为独立集群，这样该集群就可以独立承载写入请求，并与原集群分叉。</p>
<p>为此，你必须<a href="/zh/docs/pgsql/admin#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4">配置</a>该集群并完全擦除<code>standby_cluster</code>部分，然后应用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg edit-config pg-test2
</span></span><span style="display:flex;"><span>-standby_cluster:
</span></span><span style="display:flex;"><span>-  create_replica_methods:
</span></span><span style="display:flex;"><span>-  - basebackup
</span></span><span style="display:flex;"><span>-  host: 10.10.10.11
</span></span><span style="display:flex;"><span>-  port: <span style="color:#0000cf;font-weight:bold">5432</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Apply these changes? <span style="color:#ce5c00;font-weight:bold">[</span>y/N<span style="color:#ce5c00;font-weight:bold">]</span>: y
</span></span></code></pre></div></details>
 <details><summary>示例：级联复制</summary>
<p>如果您在一台从库上指定了 <a href="/zh/docs/reference/param#pg_upstream"><code>pg_upstream</code></a>，而不是主库。那么可以配置集群的 <strong>级联复制</strong>（Cascade Replication）</p>
<p>在配置级联复制时，您必须使用集群中某一个实例的IP地址作为参数的值，否则初始化会报错。该从库从特定的实例进行流复制，而不是主库。</p>
<p>这台充当 WAL 中继器的实例被称为 <strong>桥接实例</strong>（Bridge Instance）。使用桥接实例可以分担主库发送 WAL 的负担，当您有几十台从库时，使用桥接实例级联复制是一个不错的注意。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pg-test-1 ---&gt; pg-test-2 ---&gt; pg-test-3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- 桥接实例</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 3, pg_role: replica, pg_upstream</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.12</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># ^--- 从 pg-test-2 (桥接)复制，而不是从 pg-test-1 (主节点) </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></details>
<hr>
<h2 id="延迟集群">延迟集群</h2>
<p>延迟集群（Delayed Cluster）是一种特殊类型的<a href="%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4">备份集群</a>，用于尽快恢复“意外删除”的数据。</p>
<p>例如，如果你希望有一个名为 <code>pg-testdelay</code> 的集群，其数据内容与一小时前的 <code>pg-test</code> 集群相同：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pg-test 是原始集群</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg-testdelay 是 pg-test 的延迟集群</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-testdelay</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role: primary , pg_upstream: 10.10.10.11, pg_delay</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1d }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test2 }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>你还可以在现有的<a href="/zh/docs/pgsql/config/#备份集群">备份集群</a>上<a href="/zh/docs/pgsql/admin#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4">配置</a>一个“复制延迟”。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg edit-config pg-testdelay
</span></span><span style="display:flex;"><span> standby_cluster:
</span></span><span style="display:flex;"><span>   create_replica_methods:
</span></span><span style="display:flex;"><span>   - basebackup
</span></span><span style="display:flex;"><span>   host: 10.10.10.11
</span></span><span style="display:flex;"><span>   port: <span style="color:#0000cf;font-weight:bold">5432</span>
</span></span><span style="display:flex;"><span>+  recovery_min_apply_delay: 1h    <span style="color:#8f5902;font-style:italic"># &lt;--- 在此处添加延迟时长，例如1小时</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Apply these changes? <span style="color:#ce5c00;font-weight:bold">[</span>y/N<span style="color:#ce5c00;font-weight:bold">]</span>: y
</span></span></code></pre></div><p>当某些元组和表格被意外删除时，你可以通过修改此参数的方式，将此延迟集群推进到适当的时间点，并从中读取数据，快速修复原始集群。</p>
<p>延迟集群需要额外的资源，但比起 <a href="/zh/docs/concept/pitr#%E6%81%A2%E5%A4%8D">PITR</a> 要快得多，并且对系统的影响也小得多，对于非常关键的集群，可以考虑搭建延迟集群。</p>
<hr>
<h2 id="citus集群">Citus集群</h2>
<p>Pigsty 原生支持 Citus。可以参考 <a href="https://github.com/Vonng/pigsty/blob/main/conf/citus.yml"><code>files/pigsty/citus.yml</code></a> 与 <a href="https://github.com/Vonng/pigsty/blob/main/conf/prod.yml#L298"><code>prod.yml</code></a> 作为样例。</p>
<p>要定义一个 citus 集群，您需要指定以下参数：</p>
<ul>
<li><a href="/zh/docs/reference/param#pg_mode"><code>pg_mode</code></a> 必须设置为 <code>citus</code>，而不是默认的 <code>pgsql</code></li>
<li>在每个分片集群上都必须定义分片名 <a href="/zh/docs/reference/param#pg_shard"><code>pg_shard</code></a> 和分片号 <a href="/zh/docs/reference/param#pg_group"><code>pg_group</code></a></li>
<li>必须定义 <a href="/zh/docs/reference/param#patroni_citus_db"><code>patroni_citus_db</code></a> 来指定由 Patroni 管理的数据库。</li>
<li>如果您想使用 <a href="/zh/docs/reference/param#pg_dbsu"><code>pg_dbsu</code></a> 的 <code>postgres</code> 而不是默认的 <a href="/zh/docs/reference/param#pg_admin_username"><code>pg_admin_username</code></a> 来执行管理命令，那么 <a href="/zh/docs/reference/param#pg_dbsu_password"><code>pg_dbsu_password</code></a> 必须设置为非空的纯文本密码</li>
</ul>
<p>此外，还需要额外的 hba 规则，允许从本地和其他数据节点进行 SSL 访问。如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">all</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">children</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-citus0</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus 0号分片</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-citus0 , pg_group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-citus1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus 1号分片</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-citus1 , pg_group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-citus2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus 2号分片</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-citus2 , pg_group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-citus3</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus 3号分片</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">10.10.10.14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-citus3 , pg_group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#8f5902;font-style:italic"># 所有 Citus 集群的全局参数</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">citus                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pgsql 集群模式需要设置为： citus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_shard</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-citus               </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus 水平分片名称： pg-citus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">patroni_citus_db</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus 数据库名称：meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_dbsu_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Postgres</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 如果使用 dbsu ，那么需要为其配置一个密码</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_meta ,password: DBUser.Meta ,pgbouncer: true ,roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_admin ] } ]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: meta ,extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">citus }, { name: postgis }, { name: timescaledb } ] } ]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32 ,auth: ssl ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all user ssl access from localhost&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user: &#39;all&#39; ,db: all  ,addr: intra        ,auth: ssl ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all user ssl access from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在协调者节点上，您可以创建分布式表和引用表，并从任何数据节点查询它们。从 11.2 开始，任何 Citus 数据库节点都可以扮演协调者的角色了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SELECT create_distributed_table<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pgbench_accounts&#39;</span>, <span style="color:#4e9a06">&#39;aid&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span> SELECT truncate_local_data_after_distributing_table<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">$$</span>public.pgbench_accounts<span style="color:#000">$$</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>SELECT create_reference_table<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pgbench_branches&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#000;font-weight:bold">;</span> SELECT truncate_local_data_after_distributing_table<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">$$</span>public.pgbench_branches<span style="color:#000">$$</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>SELECT create_reference_table<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pgbench_history&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>          <span style="color:#000;font-weight:bold">;</span> SELECT truncate_local_data_after_distributing_table<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">$$</span>public.pgbench_history<span style="color:#000">$$</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>SELECT create_reference_table<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pgbench_tellers&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>          <span style="color:#000;font-weight:bold">;</span> SELECT truncate_local_data_after_distributing_table<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">$$</span>public.pgbench_tellers<span style="color:#000">$$</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><hr>
<h2 id="大版本切换">大版本切换</h2>
<p>Pigsty 从 PostgreSQL 10 开始提供支持，不过目前预打包的离线软件包中仅包含 12 - 16 版本。</p>
<p>Pigsty 对不同大版本的支持力度不同，如下表所示：</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>说明</th>
<th>软件包支持程度</th>
</tr>
</thead>
<tbody>
<tr>
<td>16</td>
<td>刚发布的新版本，支持重要扩展</td>
<td>Core, L1, L2</td>
</tr>
<tr>
<td>15</td>
<td>稳定的主版本，支持全部扩展（默认）</td>
<td>Core, L1, L2, L3</td>
</tr>
<tr>
<td>14</td>
<td>旧的稳定主版本，支持 L1、L2 扩展</td>
<td>Core, L1</td>
</tr>
<tr>
<td>13</td>
<td>更旧的主版本，仅支持 L1 扩展</td>
<td>Core, L1</td>
</tr>
<tr>
<td>12</td>
<td>更旧的主版本，仅支持 L1 扩展</td>
<td>Core, L1</td>
</tr>
</tbody>
</table>
<ul>
<li>内核: <code>postgresql*</code>，提供 12 - 16 支持</li>
<li>1类扩展: <code>wal2json</code>，<code>pg_repack</code>，<code>passwordcheck_cracklib</code> (在 PG 12 - 16 中提供)</li>
<li>2类扩展: <code>postgis</code>， <code>citus</code>， <code>timescaledb</code>， <code>pgvector</code> (在 PG 15,16 中提供)</li>
<li>3类扩展: 其他扩展 (目前只在 PG 15 提供)</li>
</ul>
<p>除了 PG15 之外，其他大版本上可能会有一些扩展不可用，您可能需要更改 <a href="/zh/docs/reference/param#pg_extensions"><code>pg_extensions</code></a> 和 <a href="/zh/docs/reference/param#pg_libs"><code>pg_libs</code></a> 以满足您的需求。</p>
<p>如果您确实希望在较老的大版本上使用这些扩展，可以参考<a href="/zh/docs/pgsql/admin#%E6%B7%BB%E5%8A%A0%E8%BD%AF%E4%BB%B6">添加软件</a>和<a href="/zh/docs/pgsql/admin#%E5%AE%89%E8%A3%85%E6%89%A9%E5%B1%95">安装扩展</a>的说明，手工从PGDG源下载并安装。</p>
<p>这里有一些不同大版本集群的配置样例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-v12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1 ,pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-v12</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_libs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pg_stat_statements, auto_explain&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;wal2json_12* pg_repack_12* passwordcheck_cracklib_12*&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-v13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1 ,pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-v13</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_libs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pg_stat_statements, auto_explain&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;wal2json_13* pg_repack_13* passwordcheck_cracklib_13*&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-v14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1 ,pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-v14</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-v15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1 ,pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-v15</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-v16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1 ,pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-v16</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-091b9f18681382583303e1ac5c7cea55">9 - 预置剧本</h1>
    <div class="lead">如何使用 ansible 剧本来管理 PostgreSQL 集群</div>
	<h1 id="postgresql-剧本">PostgreSQL 剧本</h1>
<blockquote>
<p>Pigsty提供了一系列剧本，用于集群上下线扩缩容，用户/数据库管理，监控或迁移已有实例。</p>
</blockquote>
<ul>
<li><a href="/zh/docs/pgsql/playbook/#pgsqlyml"><code>pgsql.yml</code></a> ：初始化PostgreSQL集群或添加新的从库。</li>
<li><a href="/zh/docs/pgsql/playbook/#pgsql-rmyml"><code>pgsql-rm.yml</code></a> ：移除PostgreSQL集群，或移除某个实例</li>
<li><a href="/zh/docs/pgsql/playbook/#pgsql-useryml"><code>pgsql-user.yml</code></a> ：在现有的PostgreSQL集群中添加新的业务用户</li>
<li><a href="/zh/docs/pgsql/playbook/#pgsql-dbyml"><code>pgsql-db.yml</code></a> ：在现有的PostgreSQL集群中添加新的业务数据库</li>
<li><a href="/zh/docs/pgsql/playbook/#pgsql-monitoryml"><code>pgsql-monitor.yml</code></a> ：将远程postgres实例纳入监控中</li>
<li><a href="/zh/docs/pgsql/playbook/#pgsql-migrationyml"><code>pgsql-migration.yml</code></a> ：为现有的PostgreSQL集群生成迁移手册和脚本</li>
</ul>
<hr>
<h3 id="保护机制">保护机制</h3>
<p>使用 <a href="/zh/docs/pgsql"><code>PGSQL</code></a> 剧本时需要<strong>特别注意</strong>，剧本 <a href="/zh/docs/pgsql/playbook/#pgsqlyml"><code>pgsql.yml</code></a> 与 <a href="/zh/docs/pgsql/playbook/#pgsql-rmyml"><code>pgsql-rm.yml</code></a> 使用不当会有误删数据库的风险！</p>
<ul>
<li>在使用<code>pgsql.yml</code>时，请再三检查<code>--tags|-t</code> 与 <code>--limit|-l</code> 参数是否正确。</li>
<li>强烈建议在执行时添加<code>-l</code>参数，限制命令执行的对象范围，并确保自己在正确的目标上执行正确的任务。</li>
<li>限制范围通常以一个数据库集群为宜，使用不带参数的<code>pgsql.yml</code>在生产环境中是一个高危操作，务必三思而后行。</li>
</ul>
<p>出于防止误删的目的，Pigsty 的 PGSQL 模块提供了<a href="/zh/docs/pgsql/playbook/#保护机制">防误删保险</a>，由以下两个参数控制：</p>
<ul>
<li><a href="/zh/docs/reference/param#pg_safeguard"><code>pg_safeguard</code></a> 默认为 <code>false</code>，不打开。</li>
<li><a href="/zh/docs/reference/param#pg_clean"><code>pg_clean</code></a> 默认为 <code>true</code>，默认清理已有实例。</li>
</ul>
<p><strong>对初始化剧本的影响</strong></p>
<p>当 <a href="/zh/docs/pgsql/playbook/#pgsqlyml"><code>pgsql.yml</code></a> 剧本执行中遭遇配置相同的运行中现存实例时，会有以下行为表现：</p>
<table>
<thead>
<tr>
<th style="text-align:center"><code>pg_safeguard</code> / <code>pg_clean</code></th>
<th style="text-align:center"><code>pg_clean=true</code></th>
<th style="text-align:center"><code>pg_clean=false</code></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>pg_safeguard=false</code></td>
<td style="text-align:center"><strong>抹除实例</strong></td>
<td style="text-align:center">中止执行</td>
</tr>
<tr>
<td style="text-align:center"><code>pg_safeguard=true</code></td>
<td style="text-align:center">中止执行</td>
<td style="text-align:center">中止执行</td>
</tr>
</tbody>
</table>
<ul>
<li>如果 <a href="/zh/docs/reference/param#pg_safeguard"><code>pg_safeguard</code></a> 启用，那么该剧本会中止执行，避免误删。</li>
<li>如果没有启用，那么会进一步根据 <a href="/zh/docs/reference/param#pg_clean"><code>pg_clean</code></a> 的取值，来决定是否移除现有的实例。
<ul>
<li>如果 <code>pg_clean</code> 为 <code>true</code>，该剧本会直接清理现有实例，为新实例腾出空间。这是默认行为。</li>
<li>如果 <code>pg_clean</code> 为 <code>false</code>，该剧本会中止执行，这需要显式配置。</li>
</ul>
</li>
</ul>
<p><strong>对下线剧本的影响</strong></p>
<p>当 <a href="/zh/docs/pgsql/playbook/#pgsql-rmyml"><code>pgsql-rm.yml</code></a> 剧本执行中遭遇配置相同的运行中现存实例时，会有以下行为表现：</p>
<table>
<thead>
<tr>
<th style="text-align:center"><code>pg_safeguard</code> / <code>pg_clean</code></th>
<th style="text-align:center"><code>pg_clean=true</code></th>
<th style="text-align:center"><code>pg_clean=false</code></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>pg_safeguard=false</code></td>
<td style="text-align:center"><strong>抹除实例与数据</strong></td>
<td style="text-align:center"><strong>抹除实例</strong></td>
</tr>
<tr>
<td style="text-align:center"><code>pg_safeguard=true</code></td>
<td style="text-align:center">中止执行</td>
<td style="text-align:center">中止执行</td>
</tr>
</tbody>
</table>
<ul>
<li>如果 <a href="/zh/docs/reference/param#pg_safeguard"><code>pg_safeguard</code></a> 启用，那么该剧本会中止执行，避免误删。</li>
<li>如果没有启用，那么会继续抹除实例，同时 <a href="/zh/docs/reference/param#pg_clean"><code>pg_clean</code></a> 在本剧本中会被解释为：是否移除数据目录。
<ul>
<li>如果 <code>pg_clean</code> 为 <code>true</code>，该剧本会直接一并清理 PostgreSQL 数据目录，即所谓“删库”，这是默认行为。</li>
<li>如果 <code>pg_clean</code> 为 <code>false</code>，该剧本保留数据目录，继续完成其他清理工作，这需要显式配置。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="pgsqlyml"><code>pgsql.yml</code></h2>
<p>剧本 <a href="https://github.com/vonng/pigsty/blob/main/pgsql.yml"><code>pgsql.yml</code></a> 用于初始化PostgreSQL集群或添加新的从库。</p>
<p>下面是使用此剧本初始化沙箱环境中 PostgreSQL 集群的过程：</p>
<p><a href="https://asciinema.org/a/566417"><img alt="asciicast" src="https://asciinema.org/a/566417.svg"></a></p>
<p>本剧本包含以下子任务：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pg_clean      : 清理现有的 postgres（如有必要）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_dbsu       : 为 postgres dbsu 设置操作系统用户sudo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_install    : 安装 postgres 包和扩展</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_pkg              : 安装 postgres 相关包</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_extension        : 仅安装 postgres 扩展</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_path             : 将 pgsql 版本 bin 链接到 /usr/pgsql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_env              : 将 pgsql bin 添加到系统路径</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_dir        : 创建 postgres 目录并设置 fhs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_util       : 复制工具脚本，设置别名和环境</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_bin              : 同步 postgres 工具脚本 /pg/bin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_alias            : 写入 /etc/profile.d/pg-alias.sh</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_psql             : 为 psql 创建 psqlrc 文件</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_dummy            : 创建 dummy 占位文件</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># patroni       : 使用 patroni 引导 postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_config           : 生成 postgres 配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_conf           : 生成 patroni 配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_systemd        : 生成 patroni systemd 配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pgbackrest_config : 生成 pgbackrest 配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   -  pg_cert            : 为 postgres 签发证书</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   -  pg_launch          : 启动 postgres 主服务器和副本</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_watchdog       : 授予 postgres watchdog 权限</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_primary        : 启动 patroni/postgres 主服务器</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_init           : 使用角色/模板初始化 pg 集群</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_pass           : 将 .pgpass 文件写入 pg 主目录</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_replica        : 启动 patroni/postgres 副本</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_hba            : 生成 pg HBA 规则</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - patroni_reload    : 重新加载 patroni 配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_patroni        : 必要时暂停或删除 patroni</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_user       : 配置 postgres 业务用户</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_user_config      : 渲染创建用户的 sql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_user_create      : 在 postgres 上创建用户</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_db         : 配置 postgres 业务数据库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_db_config        : 渲染创建数据库的 sql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_db_create        : 在 postgres 上创建数据库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_backup               : 初始化 pgbackrest 仓库和基础备份</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pgbackrest_init     : 初始化 pgbackrest 仓库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pgbackrest_backup   : 引导后进行初始备份</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pgbouncer     : 与 postgres 一起部署 pgbouncer 边车</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pgbouncer_clean     : 清理现有的 pgbouncer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pgbouncer_dir       : 创建 pgbouncer 目录</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pgbouncer_config    : 生成 pgbouncer 配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#       -  pgbouncer_svc    : 生成 pgbouncer systemd 配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#       -  pgbouncer_ini    : 生成 pgbouncer 主配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#       -  pgbouncer_hba    : 生成 pgbouncer hba 配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#       -  pgbouncer_db     : 生成 pgbouncer 数据库配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#       -  pgbouncer_user   : 生成 pgbouncer 用户配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   -  pgbouncer_launch   : 启动 pgbouncer 池化服务</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   -  pgbouncer_reload   : 重新加载 pgbouncer 配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_vip        : 使用 vip-manager 将 vip 绑定到 pgsql 主服务器</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_vip_config       : 为 vip-manager 生成配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_vip_launch       : 启动 vip-manager 绑定 vip</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_dns        : 将 dns 名称注册到 infra dnsmasq</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_dns_ins          : 注册 pg 实例名称</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_dns_cls          : 注册 pg 集群名称</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_service    : 使用 haproxy 公开 pgsql 服务</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_service_config   : 为 pg 服务生成本地 haproxy 配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_service_reload   : 使用 haproxy 公开 postgres 服务</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_exporter   : 使用 haproxy 公开 pgsql 服务</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_exporter_config  : 配置 pg_exporter 和 pgbouncer_exporter</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_exporter_launch  : 启动 pg_exporter</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pgbouncer_exporter_launch : 启动 pgbouncer 导出器</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_register   : 将 postgres 注册到 pigsty 基础设施</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - register_prometheus : 将 pg 注册为 prometheus 监控目标</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - register_grafana    : 将 pg 数据库注册为 grafana 数据源</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>以下管理任务使用到了此剧本</strong></p>
<ul>
<li><a href="/zh/docs/pgsql/admin#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4">创建集群</a></li>
<li><a href="/zh/docs/pgsql/admin#%E6%B7%BB%E5%8A%A0%E5%AE%9E%E4%BE%8B">添加实例</a></li>
<li><a href="/zh/docs/pgsql/admin#%E9%87%8D%E8%BD%BD%E6%9C%8D%E5%8A%A1">重载服务</a></li>
<li><a href="/zh/docs/pgsql/admin#%E9%87%8D%E8%BD%BDhba">重载HBA</a></li>
</ul>
<p><strong>一些关于本剧本的注意事项</strong></p>
<p>单独针对某一集群从库执行此剧本时，用户应当确保 <strong>集群主库已经完成初始化！</strong></p>
<ul>
<li>扩容完成后，您需要<a href="/zh/docs/pgsql/admin#%E9%87%8D%E8%BD%BD%E6%9C%8D%E5%8A%A1">重载服务</a>与<a href="/zh/docs/pgsql/admin#%E9%87%8D%E8%BD%BDhba">重载HBA</a>，包装脚本 <code>pgsql-add</code> 会完成这些任务。</li>
<li>详情请参考管理 SOP： <a href="/zh/docs/pgsql/admin#%E6%B7%BB%E5%8A%A0%E5%AE%9E%E4%BE%8B">添加实例</a></li>
</ul>
<p>集群扩容时，如果<code>Patroni</code>拉起从库的时间过长，Ansible剧本可能会因为超时而中止。</p>
<ul>
<li>典型错误信息为：<code>wait for postgres/patroni replica</code> 任务执行很长时间后中止</li>
<li>但制作从库的进程会继续，例如制作从库需超过1天的场景，后续处理请参考 <a href="/zh/docs/pgsql/faq">FAQ</a>：制作从库失败。</li>
</ul>
<hr>
<h2 id="pgsql-rmyml"><code>pgsql-rm.yml</code></h2>
<p>剧本 <a href="https://github.com/vonng/pigsty/blob/main/pgsql-rm.yml"><code>pgsql-rm.yml</code></a> 用于移除PostgreSQL集群，或移除某个实例。</p>
<p>下面是使用此剧本移除沙箱环境中 PostgreSQL 集群的过程：</p>
<p><a href="https://asciinema.org/a/566418"><img alt="asciicast" src="https://asciinema.org/a/566418.svg"></a></p>
<p><strong>本剧本包含以下子任务</strong>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># register       : 在 prometheus、grafana、nginx 中移除注册</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - prometheus : 从 prometheus 移除监控目标</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - grafana    : 从 grafana 移除数据源</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># dns            : 移除 INFRA节点上 DNSMASQ 的 pg dns 记录</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># vip            : 移除 vip-manager，与绑定在集群主库上的 VIP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_service     : 从 haproxy 上移除 PostgreSQL 服务定义并重载生效</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_exporter    : 移除 pg_exporter 和 pgbouncer_exporter 监控组件</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pgbouncer      : 移除 pgbouncer 连接池中间件</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># postgres       : 移除 postgres 实例数据库实例</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_replica : 移除所有从库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_primary : 最后移除主库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - dcs        : 从 dcs:etcd 移除元数据</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_data        : 移除 PostgreSQL 数据目录（使用 `pg_clean=false` 禁用）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pgbackrest     : 移除主实例时，一并移除 PostgreSQL 备份（使用 `pgbackrest_clean=false` 禁用）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_pkg         : 移除 PostgreSQL 软件包（使用 `pg_uninstall=true` 启用）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>本剧本可以使用一些命令行参数影响其行为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql-rm.yml -l pg-test     <span style="color:#8f5902;font-style:italic"># 移除集群 `pg-test`</span>
</span></span><span style="display:flex;"><span>    -e <span style="color:#000">pg_clean</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>          <span style="color:#8f5902;font-style:italic"># 是否一并移除 PostgreSQL 数据库目录？默认移除数据目录。</span>
</span></span><span style="display:flex;"><span>    -e <span style="color:#000">pgbackrest_clean</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>  <span style="color:#8f5902;font-style:italic"># 是否一并移除 PostgreSQL 备份？（只针对主库执行时生效），默认移除备份数据。</span>
</span></span><span style="display:flex;"><span>    -e <span style="color:#000">pg_uninstall</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span>     <span style="color:#8f5902;font-style:italic"># 默认不会卸载 PostgreSQL 软件包，需要显式指定此参数才会卸载。</span>
</span></span><span style="display:flex;"><span>    -e <span style="color:#000">pg_safeguard</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span>     <span style="color:#8f5902;font-style:italic"># 防误删保险默认不打开，如果打开，可以在这里用命令行参数强行覆盖。</span>
</span></span></code></pre></div><p><strong>以下管理任务使用到了此剧本</strong></p>
<ul>
<li><a href="/zh/docs/pgsql/admin#%E7%A7%BB%E9%99%A4%E5%AE%9E%E4%BE%8B">移除实例</a></li>
<li><a href="/zh/docs/pgsql/admin#%E4%B8%8B%E7%BA%BF%E9%9B%86%E7%BE%A4">下线集群</a></li>
</ul>
<p><strong>一些关于本剧本的注意事项</strong></p>
<p><strong>请不要直接对还有从库的集群主库单独直接执行此剧本</strong></p>
<ul>
<li>否则抹除主库后，其余从库会自动触发高可用自动故障切换。</li>
<li>总是先下线所有从库后，再下线主库，当一次性下线整个集群时不需要操心此问题。</li>
</ul>
<p><strong>实例下线后请刷新集群服务</strong></p>
<ul>
<li>当您从集群中下线掉某一个从库实例时，它仍然存留于在负载均衡器的配置文件中。</li>
<li>因为任何健康检查都无法通过，所以下线后的实例不会对集群产生影响。</li>
<li>但您应当在恰当的时间点 <a href="/zh/docs/pgsql/admin#%E9%87%8D%E8%BD%BD%E6%9C%8D%E5%8A%A1">重载服务</a>，确保生产环境与配置清单的一致性。</li>
</ul>
<hr>
<h2 id="pgsql-useryml"><code>pgsql-user.yml</code></h2>
<p>剧本 <a href="https://github.com/vonng/pigsty/blob/main/pgsql-user.yml"><code>pgsql-user.yml</code></a> 用于在现有的PostgreSQL集群中添加新的业务用户</p>
<p>详情请参考：<a href="/zh/docs/pgsql/admin#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7">管理SOP：创建用户</a></p>
<hr>
<h2 id="pgsql-dbyml"><code>pgsql-db.yml</code></h2>
<p>剧本 <a href="https://github.com/vonng/pigsty/blob/main/pgsql-db.yml"><code>pgsql-db.yml</code></a> 用于在现有的PostgreSQL集群中添加新的业务数据库</p>
<p>详情请参考：<a href="/zh/docs/pgsql/admin#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93">管理SOP：创建数据库</a></p>
<hr>
<h2 id="pgsql-monitoryml"><code>pgsql-monitor.yml</code></h2>
<p>剧本 <a href="https://github.com/vonng/pigsty/blob/main/pgsql-monitor.yml"><code>pgsql-monitor.yml</code></a> 用于将远程postgres实例纳入监控中</p>
<p>详情请参考：<a href="/zh/docs/pgsql/monitor#%E7%9B%91%E6%8E%A7rds">管理SOP：监控现有PG</a></p>
<hr>
<h2 id="pgsql-migrationyml"><code>pgsql-migration.yml</code></h2>
<p>剧本 <a href="https://github.com/vonng/pigsty/blob/main/pgsql-migration.yml"><code>pgsql-migration.yml</code></a> 用于为现有的PostgreSQL集群生成迁移手册和脚本</p>
<p>详情请参考：<a href="/zh/docs/pgsql/migration">管理SOP：迁移数据库集群</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7002dbf9503f9bb5f791aa73eb5fabe9">10 - 管理预案</h1>
    <div class="lead">Pigsty 中常用的 PostgreSQL 管理预案，用于维护生产环境中的数据库集群。</div>
	<blockquote>
<p>本文整理了 Pigsty 中常用的 PostgreSQL 管理预案，用于维护生产环境中的数据库集群。</p>
</blockquote>
<p>这里是一些常见 PostgreSQL 管理任务的 SOP 预案：</p>
<ul>
<li>案例1：  <a href="/zh/docs/pgsql/admin/#创建集群">创建集群</a></li>
<li>案例2：  <a href="/zh/docs/pgsql/admin/#创建用户">创建用户</a></li>
<li>案例3：  <a href="/zh/docs/pgsql/admin/#创建数据库">创建数据库</a></li>
<li>案例4：  <a href="/zh/docs/pgsql/admin/#重载服务">重载服务</a></li>
<li>案例5：  <a href="/zh/docs/pgsql/admin/#重载HBA">重载HBA</a></li>
<li>案例6：  <a href="/zh/docs/pgsql/admin/#配置集群">配置集群</a></li>
<li>案例7：  <a href="/zh/docs/pgsql/admin/#添加实例">添加实例</a></li>
<li>案例8：  <a href="/zh/docs/pgsql/admin/#移除实例">移除实例</a></li>
<li>案例9：  <a href="/zh/docs/pgsql/admin/#下线集群">下线集群</a></li>
<li>案例10： <a href="/zh/docs/pgsql/admin/#主动切换">主动切换</a></li>
<li>案例11： <a href="/zh/docs/pgsql/admin/#备份集群">备份集群</a></li>
<li>案例12： <a href="/zh/docs/pgsql/admin/#恢复集群">恢复集群</a></li>
<li>案例13： <a href="/zh/docs/pgsql/admin/#添加软件">添加软件</a></li>
<li>案例14： <a href="/zh/docs/pgsql/admin/#安装扩展">安装扩展</a></li>
<li>案例15： <a href="/zh/docs/pgsql/admin/#小版本升级">小版本升级</a></li>
<li>案例16： <a href="/zh/docs/pgsql/admin/#大版本升级">大版本升级</a></li>
</ul>
<hr>
<h2 id="命令速查">命令速查</h2>
<p>PGSQL 剧本与快捷方式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-add   &lt;cls&gt;                   <span style="color:#8f5902;font-style:italic"># 创建 pgsql 集群 &lt;cls&gt;</span>
</span></span><span style="display:flex;"><span>bin/pgsql-user  &lt;cls&gt; &lt;username&gt;        <span style="color:#8f5902;font-style:italic"># 在 &lt;cls&gt; 上创建 pg 用户 &lt;username&gt;</span>
</span></span><span style="display:flex;"><span>bin/pgsql-db    &lt;cls&gt; &lt;dbname&gt;          <span style="color:#8f5902;font-style:italic"># 在 &lt;cls&gt; 上创建 pg 数据库 &lt;dbname&gt;</span>
</span></span><span style="display:flex;"><span>bin/pgsql-svc   &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>...ip<span style="color:#ce5c00;font-weight:bold">]</span>           <span style="color:#8f5902;font-style:italic"># 重新加载集群 &lt;cls&gt; 的 pg 服务</span>
</span></span><span style="display:flex;"><span>bin/pgsql-hba   &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>...ip<span style="color:#ce5c00;font-weight:bold">]</span>           <span style="color:#8f5902;font-style:italic"># 重新加载集群 &lt;cls&gt; 的 postgres/pgbouncer HBA 规则</span>
</span></span><span style="display:flex;"><span>bin/pgsql-add   &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>...ip<span style="color:#ce5c00;font-weight:bold">]</span>           <span style="color:#8f5902;font-style:italic"># 为集群 &lt;cls&gt; 添加从库副本</span>
</span></span><span style="display:flex;"><span>bin/pgsql-rm    &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>...ip<span style="color:#ce5c00;font-weight:bold">]</span>           <span style="color:#8f5902;font-style:italic"># 从集群 &lt;cls&gt; 移除实例</span>
</span></span><span style="display:flex;"><span>bin/pgsql-rm    &lt;cls&gt;                   <span style="color:#8f5902;font-style:italic"># 删除 pgsql 集群 &lt;cls&gt;</span>
</span></span></code></pre></div><p>Patroni 管理命令与快捷方式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg list        &lt;cls&gt;                    <span style="color:#8f5902;font-style:italic"># 打印集群信息</span>
</span></span><span style="display:flex;"><span>pg edit-config &lt;cls&gt;                    <span style="color:#8f5902;font-style:italic"># 编辑集群配置</span>
</span></span><span style="display:flex;"><span>pg reload      &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>ins<span style="color:#ce5c00;font-weight:bold">]</span>              <span style="color:#8f5902;font-style:italic"># 重新加载集群配置</span>
</span></span><span style="display:flex;"><span>pg restart     &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>ins<span style="color:#ce5c00;font-weight:bold">]</span>              <span style="color:#8f5902;font-style:italic"># 重启 PostgreSQL 集群</span>
</span></span><span style="display:flex;"><span>pg reinit      &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>ins<span style="color:#ce5c00;font-weight:bold">]</span>              <span style="color:#8f5902;font-style:italic"># 重新初始化集群成员</span>
</span></span><span style="display:flex;"><span>pg pause       &lt;cls&gt;                    <span style="color:#8f5902;font-style:italic"># 进入维护模式（自动故障转移暂停）</span>
</span></span><span style="display:flex;"><span>pg resume      &lt;cls&gt;                    <span style="color:#8f5902;font-style:italic"># 退出维护模式</span>
</span></span><span style="display:flex;"><span>pg switchover  &lt;cls&gt;                    <span style="color:#8f5902;font-style:italic"># 在集群 &lt;cls&gt; 上进行主动主从切换（主库健康）</span>
</span></span><span style="display:flex;"><span>pg failover    &lt;cls&gt;                    <span style="color:#8f5902;font-style:italic"># 在集群 &lt;cls&gt; 上进行故障转移（主库故障）</span>
</span></span></code></pre></div><p>pgBackRest 备份/恢复命令与快捷方式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pb info                                 <span style="color:#8f5902;font-style:italic"># 打印 pgbackrest 备份仓库信息</span>
</span></span><span style="display:flex;"><span>pg-backup                               <span style="color:#8f5902;font-style:italic"># 进行备份，默认进行增量备份，如果没有完整备份过就做全量备份</span>
</span></span><span style="display:flex;"><span>pg-backup full                          <span style="color:#8f5902;font-style:italic"># 进行全量备份</span>
</span></span><span style="display:flex;"><span>pg-backup diff                          <span style="color:#8f5902;font-style:italic"># 进行差异备份</span>
</span></span><span style="display:flex;"><span>pg-backup incr                          <span style="color:#8f5902;font-style:italic"># 进行增量备份</span>
</span></span><span style="display:flex;"><span>pg-pitr -i                              <span style="color:#8f5902;font-style:italic"># 恢复到最近备份完成的时间（不常用）</span>
</span></span><span style="display:flex;"><span>pg-pitr --time<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2022-12-30 14:44:44+08&#34;</span> <span style="color:#8f5902;font-style:italic"># 恢复到特定时间点（如在删除数据库或表的情况下）</span>
</span></span><span style="display:flex;"><span>pg-pitr --name<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;my-restore-point&#34;</span>       <span style="color:#8f5902;font-style:italic"># 恢复到由 pg_create_restore_point 创建的命名还原点</span>
</span></span><span style="display:flex;"><span>pg-pitr --lsn<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;0/7C82CB8&#34;</span> -X            <span style="color:#8f5902;font-style:italic"># 恢复到 LSN 之前</span>
</span></span><span style="display:flex;"><span>pg-pitr --xid<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;1234567&#34;</span> -X -P           <span style="color:#8f5902;font-style:italic"># 恢复到特定的事务ID之前，然后将其提升为主库</span>
</span></span><span style="display:flex;"><span>pg-pitr --backup<span style="color:#ce5c00;font-weight:bold">=</span>latest                 <span style="color:#8f5902;font-style:italic"># 恢复到最新的备份集</span>
</span></span><span style="display:flex;"><span>pg-pitr --backup<span style="color:#ce5c00;font-weight:bold">=</span>20221108-105325        <span style="color:#8f5902;font-style:italic"># 恢复到特定的备份集，使用名称指定，可以使用 pgbackrest info 进行检查</span>
</span></span></code></pre></div><p>使用 Systemd 管理系统组件的命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl stop patroni                  <span style="color:#8f5902;font-style:italic"># 启动 停止 重启 重载</span>
</span></span><span style="display:flex;"><span>systemctl stop pgbouncer                <span style="color:#8f5902;font-style:italic"># 启动 停止 重启 重载</span>
</span></span><span style="display:flex;"><span>systemctl stop pg_exporter              <span style="color:#8f5902;font-style:italic"># 启动 停止 重启 重载</span>
</span></span><span style="display:flex;"><span>systemctl stop pgbouncer_exporter       <span style="color:#8f5902;font-style:italic"># 启动 停止 重启 重载</span>
</span></span><span style="display:flex;"><span>systemctl stop node_exporter            <span style="color:#8f5902;font-style:italic"># 启动 停止 重启</span>
</span></span><span style="display:flex;"><span>systemctl stop haproxy                  <span style="color:#8f5902;font-style:italic"># 启动 停止 重启 重载</span>
</span></span><span style="display:flex;"><span>systemctl stop vip-manager              <span style="color:#8f5902;font-style:italic"># 启动 停止 重启 重载</span>
</span></span><span style="display:flex;"><span>systemctl stop postgres                 <span style="color:#8f5902;font-style:italic"># 仅当 patroni_mode == &#39;remove&#39; 时使用这个服务</span>
</span></span></code></pre></div><hr>
<h2 id="创建集群">创建集群</h2>
<p>要创建一个新的Postgres集群，请首先在配置清单中定义，然后进行初始化：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/node-add &lt;cls&gt;                <span style="color:#8f5902;font-style:italic"># 为集群 &lt;cls&gt; 初始化节点                  # ./node.yml  -l &lt;cls&gt; </span>
</span></span><span style="display:flex;"><span>bin/pgsql-add &lt;cls&gt;               <span style="color:#8f5902;font-style:italic"># 初始化集群 &lt;cls&gt; 的pgsql实例             # ./pgsql.yml -l &lt;cls&gt;</span>
</span></span></code></pre></div><blockquote>
<p>请注意，PGSQL 模块需要在 Pigsty 纳管的节点上安装，请先使用 <code>bin/node-add</code> 纳管节点。</p>
</blockquote>
<details><summary>示例：创建集群</summary>
<p><a href="https://asciinema.org/a/568810"><img alt="asciicast" src="https://asciinema.org/a/568810.svg"></a></p>
</details>
<hr>
<h2 id="创建用户">创建用户</h2>
<p>要在现有的Postgres集群上创建一个新的业务用户，请将用户定义添加到 <code>all.children.&lt;cls&gt;.pg_users</code>，然后使用以下命令将其创建：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;   <span style="color:#8f5902;font-style:italic"># ./pgsql-user.yml -l &lt;cls&gt; -e username=&lt;username&gt;</span>
</span></span></code></pre></div><details><summary>示例：创建业务用户</summary>
<p><a href="https://asciinema.org/a/568789"><img alt="asciicast" src="https://asciinema.org/a/568789.svg"></a></p>
</details>
<hr>
<h2 id="创建数据库">创建数据库</h2>
<p>要在现有的Postgres集群上创建一个新的数据库用户，请将数据库定义添加到 <code>all.children.&lt;cls&gt;.pg_databases</code>，然后按照以下方式创建数据库：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-db &lt;cls&gt; &lt;dbname&gt;       <span style="color:#8f5902;font-style:italic"># ./pgsql-db.yml -l &lt;cls&gt; -e dbname=&lt;dbname&gt;</span>
</span></span></code></pre></div><p>注意：如果数据库指定了一个非默认的属主，该属主用户应当已存在，否则您必须先<a href="/zh/docs/pgsql/admin/#创建用户">创建用户</a>。</p>
<details><summary>示例：创建业务数据库</summary>
<p><a href="https://asciinema.org/a/568790"><img alt="asciicast" src="https://asciinema.org/a/568790.svg"></a></p>
</details>
<hr>
<h2 id="重载服务">重载服务</h2>
<p><a href="/zh/docs/pgsql/svc">服务</a>是 PostgreSQL 对外提供能力的访问点（PGURL可达），由主机节点上的 HAProxy 对外暴露。</p>
<p>当集群成员发生变化时使用此任务，例如：<a href="/zh/docs/pgsql/admin/#添加实例">添加</a>／<a href="/zh/docs/pgsql/admin/#移除实例">移除</a>副本，<a href="/zh/docs/pgsql/admin/#主动切换">主从切换</a>／故障转移 / 暴露新服务，或更新现有服务的配置（例如，LB权重）</p>
<p>要在整个代理集群，或特定实例上创建新服务或重新加载现有服务：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-svc &lt;cls&gt;               <span style="color:#8f5902;font-style:italic"># pgsql.yml -l &lt;cls&gt; -t pg_service -e pg_reload=true</span>
</span></span><span style="display:flex;"><span>bin/pgsql-svc &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>ip...<span style="color:#ce5c00;font-weight:bold">]</span>       <span style="color:#8f5902;font-style:italic"># pgsql.yml -l ip... -t pg_service -e pg_reload=true</span>
</span></span></code></pre></div><details><summary>示例：重载PG服务以踢除一个实例</summary>
<p><a href="https://asciinema.org/a/568815"><img alt="asciicast" src="https://asciinema.org/a/568815.svg"></a></p>
</details>
<hr>
<h2 id="重载hba">重载HBA</h2>
<p>当您的 Postgres/Pgbouncer HBA 规则发生更改时，您 <em>可能</em> 需要重载 HBA 以应用更改。</p>
<p>如果您有任何特定于角色的 HBA 规则，或者在IP地址段中引用了集群成员的别名，那么当主从切换/集群扩缩容后也可能需要重载HBA。</p>
<p>要在整个集群或特定实例上重新加载 postgres 和 pgbouncer 的 HBA 规则：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-hba &lt;cls&gt;               <span style="color:#8f5902;font-style:italic"># pgsql.yml -l &lt;cls&gt; -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e pg_reload=true</span>
</span></span><span style="display:flex;"><span>bin/pgsql-hba &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>ip...<span style="color:#ce5c00;font-weight:bold">]</span>       <span style="color:#8f5902;font-style:italic"># pgsql.yml -l ip... -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e pg_reload=true</span>
</span></span></code></pre></div><details><summary>示例：重载集群 HBA 规则</summary>
<p><a href="https://asciinema.org/a/568794"><img alt="asciicast" src="https://asciinema.org/a/568794.svg"></a></p>
</details>
<hr>
<h2 id="配置集群">配置集群</h2>
<p>要更改现有的 Postgres 集群配置，您需要在<strong>管理节点</strong>上使用<strong>管理员用户</strong>（安装Pigsty的用户，nopass ssh/sudo）发起控制命令：</p>
<p>另一种方式是在数据库集群中的任何节点上，使用 <code>dbsu</code> （默认为 postgres） ，也可以执行管理命令，但只能管理本集群。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg edit-config &lt;cls&gt;              <span style="color:#8f5902;font-style:italic"># interactive config a cluster with patronictl</span>
</span></span></code></pre></div><p>更改 patroni 参数和 <code>postgresql.parameters</code>，根据提示保存并应用更改即可。</p>
<details><summary>示例：非交互式方式配置集群</summary>
<p>您可以跳过交互模式，并使用 <code>-p</code> 选项覆盖 postgres 参数，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg edit-config -p <span style="color:#000">log_min_duration_statement</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1000</span> pg-test
</span></span><span style="display:flex;"><span>pg edit-config --force -p <span style="color:#000">shared_preload_libraries</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;timescaledb, pg_cron, pg_stat_statements, auto_explain&#39;</span>
</span></span></code></pre></div></details>
<details><summary>示例：使用 Patroni REST API 更改集群配置</summary>
<p>您还可以使用 <a href="https://patroni.readthedocs.io/en/latest/rest_api.html">Patroni REST API</a> 以非交互式方式更改配置，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -s 10.10.10.11:8008/config <span style="color:#000;font-weight:bold">|</span> jq .  <span style="color:#8f5902;font-style:italic"># get current config</span>
</span></span><span style="display:flex;"><span>$ curl -u <span style="color:#4e9a06">&#39;postgres:Patroni.API&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>        -d <span style="color:#4e9a06">&#39;{&#34;postgresql&#34;:{&#34;parameters&#34;: {&#34;log_min_duration_statement&#34;:200}}}&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>        -s -X PATCH http://10.10.10.11:8008/config <span style="color:#000;font-weight:bold">|</span> jq .
</span></span></code></pre></div><p>注意：Patroni 敏感API（例如重启等） 访问仅限于从基础设施/管理节点发起，并且有 HTTP 基本认证（用户名/密码）以及可选的 HTTPS 保护。</p>
</details>
<details><summary>示例：使用 patronictl 配置集群</summary>
<p><a href="https://asciinema.org/a/568799"><img alt="asciicast" src="https://asciinema.org/a/568799.svg"></a></p>
</details>
<hr>
<h2 id="添加实例">添加实例</h2>
<p>若要将新从库添加到现有的 PostgreSQL 集群中，您需要将其定义添加到配置清单：<code>all.children.&lt;cls&gt;.hosts</code> 中，然后：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/node-add &lt;ip&gt;                 <span style="color:#8f5902;font-style:italic"># 将节点 &lt;ip&gt; 纳入 Pigsty 管理                </span>
</span></span><span style="display:flex;"><span>bin/pgsql-add &lt;cls&gt; &lt;ip&gt;          <span style="color:#8f5902;font-style:italic"># 初始化 &lt;ip&gt; ，作为集群 &lt;cls&gt; 的新从库</span>
</span></span></code></pre></div><p>这将会把节点 <code>&lt;ip&gt;</code> 添加到 pigsty 并将其初始化为集群 <code>&lt;cls&gt;</code> 的一个副本。</p>
<p>集群服务将会<a href="/zh/docs/pgsql/admin/#重载服务">重新加载</a>以接纳新成员。</p>
<details><summary>示例：为 pg-test 添加从库</summary>
<p><a href="https://asciinema.org/a/566421"><img alt="asciicast" src="https://asciinema.org/a/566421.svg"></a></p>
<p>例如，如果您想将 <code>pg-test-3 / 10.10.10.13</code> 添加到现有的集群 <code>pg-test</code>，您首先需要更新配置清单：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg-test:
</span></span><span style="display:flex;"><span>  hosts:
</span></span><span style="display:flex;"><span>    10.10.10.11: <span style="color:#ce5c00;font-weight:bold">{</span> pg_seq: 1, pg_role: primary <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#8f5902;font-style:italic"># 已存在的成员</span>
</span></span><span style="display:flex;"><span>    10.10.10.12: <span style="color:#ce5c00;font-weight:bold">{</span> pg_seq: 2, pg_role: replica <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#8f5902;font-style:italic"># 已存在的成员</span>
</span></span><span style="display:flex;"><span>    10.10.10.13: <span style="color:#ce5c00;font-weight:bold">{</span> pg_seq: 3, pg_role: replica <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#8f5902;font-style:italic"># &lt;--- 新成员</span>
</span></span><span style="display:flex;"><span>  vars: <span style="color:#ce5c00;font-weight:bold">{</span> pg_cluster: pg-test <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>然后按如下方式应用更改：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/node-add          10.10.10.13   <span style="color:#8f5902;font-style:italic"># 将节点添加到 pigsty</span>
</span></span><span style="display:flex;"><span>bin/pgsql-add pg-test 10.10.10.13   <span style="color:#8f5902;font-style:italic"># 在 10.10.10.13 上为集群 pg-test 初始化新的副本</span>
</span></span></code></pre></div><p>这与集群初始化相似，但只在单个实例上工作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> 初始化实例  10.10.10.11 到 pgsql 集群 <span style="color:#4e9a06">&#39;pg-test&#39;</span> 中:
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span>   提醒：先将节点添加到 pigsty 中，然后再安装模块 <span style="color:#4e9a06">&#39;pgsql&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>HINT<span style="color:#ce5c00;font-weight:bold">]</span>     $ bin/node-add  10.10.10.11  <span style="color:#8f5902;font-style:italic"># 除 infra 节点外，先运行此命令</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span>   从集群初始化实例：
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span>     $ ./pgsql.yml -l <span style="color:#4e9a06">&#39;10.10.10.11,&amp;pg-test&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span>   重新加载现有实例上的 pg_service：
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span>     $ ./pgsql.yml -l <span style="color:#4e9a06">&#39;pg-test,!10.10.10.11&#39;</span> -t pg_service
</span></span></code></pre></div></details>
<hr>
<h2 id="移除实例">移除实例</h2>
<p>若要从现有的 PostgreSQL 集群中移除副本：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-rm &lt;cls&gt; &lt;ip...&gt;        <span style="color:#8f5902;font-style:italic"># ./pgsql-rm.yml -l &lt;ip&gt;</span>
</span></span></code></pre></div><p>这将从集群 <code>&lt;cls&gt;</code> 中移除实例 <code>&lt;ip&gt;</code>。 集群服务将会<a href="/zh/docs/pgsql/admin/#重载服务">重新加载</a>以从负载均衡器中踢除已移除的实例。</p>
<details><summary>示例：从 pg-test 移除从库</summary>
<p><a href="https://asciinema.org/a/566419"><img alt="asciicast" src="https://asciinema.org/a/566419.svg"></a></p>
<p>例如，如果您想从现有的集群 <code>pg-test</code> 中移除 <code>pg-test-3 / 10.10.10.13</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-rm pg-test 10.10.10.13  <span style="color:#8f5902;font-style:italic"># 从 pg-test 中移除 pgsql 实例 10.10.10.13</span>
</span></span><span style="display:flex;"><span>bin/node-rm  10.10.10.13          <span style="color:#8f5902;font-style:italic"># 从 pigsty 中移除该节点（可选）</span>
</span></span><span style="display:flex;"><span>vi pigsty.yml                     <span style="color:#8f5902;font-style:italic"># 从目录中移除实例定义</span>
</span></span><span style="display:flex;"><span>bin/pgsql-svc pg-test             <span style="color:#8f5902;font-style:italic"># 刷新现有实例上的 pg_service，以从负载均衡器中踢除已移除的实例</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> 从 <span style="color:#4e9a06">&#39;pg-test&#39;</span> 移除 10.10.10.13 的 pgsql 实例：
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span>   从集群中移除实例：
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span>     $ ./pgsql-rm.yml -l <span style="color:#4e9a06">&#39;10.10.10.13,&amp;pg-test&#39;</span>
</span></span></code></pre></div><p>并从配置清单中移除实例定义：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 3, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- 执行后移除此行</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>最后，您可以<a href="/zh/docs/pgsql/admin/#重载服务">重载PG服务</a>并从负载均衡器中踢除已移除的实例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-svc pg-test             <span style="color:#8f5902;font-style:italic"># 重载 pg-test 上的服务</span>
</span></span></code></pre></div></details>
<hr>
<h2 id="下线集群">下线集群</h2>
<p>要移除整个 Postgres 集群，只需运行：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-rm &lt;cls&gt;                <span style="color:#8f5902;font-style:italic"># ./pgsql-rm.yml -l &lt;cls&gt;</span>
</span></span></code></pre></div><details><summary>示例：移除集群</summary>
<p><a href="https://asciinema.org/a/566418"><img alt="asciicast" src="https://asciinema.org/a/566418.svg"></a></p>
</details>
<details><summary>示例：强制移除集群</summary>
<p>注意：如果为这个集群配置了<a href="/zh/docs/reference/param#pg_safeguard"><code>pg_safeguard</code></a>（或全局设置为 <code>true</code>），<code>pgsql-rm.yml</code> 将中止，以避免意外移除集群。</p>
<p>您可以使用 playbook 命令行参数明确地覆盖它，以强制执行清除：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql-rm.yml -l pg-meta -e <span style="color:#000">pg_safeguard</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span>    <span style="color:#8f5902;font-style:italic"># 强制移除 pg 集群 pg-meta</span>
</span></span></code></pre></div></details>
<hr>
<h2 id="主动切换">主动切换</h2>
<p>您可以使用 patroni 命令行工具执行 PostgreSQL 集群的切换操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg switchover &lt;cls&gt;   <span style="color:#8f5902;font-style:italic"># 交互模式，您可以使用下面的参数组合直接跳过此交互向导</span>
</span></span><span style="display:flex;"><span>pg switchover --leader pg-test-1 --candidate<span style="color:#ce5c00;font-weight:bold">=</span>pg-test-2 --scheduled<span style="color:#ce5c00;font-weight:bold">=</span>now --force pg-test
</span></span></code></pre></div><details><summary>示例：pg-test 主从切换</summary>
<p><a href="https://asciinema.org/a/566248"><img alt="asciicast" src="https://asciinema.org/a/566248.svg"></a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg switchover pg-test
</span></span><span style="display:flex;"><span>Master <span style="color:#ce5c00;font-weight:bold">[</span>pg-test-1<span style="color:#ce5c00;font-weight:bold">]</span>:
</span></span><span style="display:flex;"><span>Candidate <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#39;pg-test-2&#39;</span>, <span style="color:#4e9a06">&#39;pg-test-3&#39;</span><span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[]</span>: pg-test-2
</span></span><span style="display:flex;"><span>When should the switchover take place <span style="color:#ce5c00;font-weight:bold">(</span>e.g. 2022-12-26T07:39 <span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#ce5c00;font-weight:bold">[</span>now<span style="color:#ce5c00;font-weight:bold">]</span>: now
</span></span><span style="display:flex;"><span>Current cluster topology
</span></span><span style="display:flex;"><span>+ Cluster: pg-test <span style="color:#ce5c00;font-weight:bold">(</span>7181325041648035869<span style="color:#ce5c00;font-weight:bold">)</span> -----+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> Member    <span style="color:#000;font-weight:bold">|</span> Host        <span style="color:#000;font-weight:bold">|</span> Role    <span style="color:#000;font-weight:bold">|</span> State   <span style="color:#000;font-weight:bold">|</span> TL <span style="color:#000;font-weight:bold">|</span> Lag in MB <span style="color:#000;font-weight:bold">|</span> Tags            <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+---------+---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-1 <span style="color:#000;font-weight:bold">|</span> 10.10.10.11 <span style="color:#000;font-weight:bold">|</span> Leader  <span style="color:#000;font-weight:bold">|</span> running <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> conf: tiny.yml  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> spec: 1C.2G.50G <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> version: <span style="color:#4e9a06">&#39;15&#39;</span>   <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+---------+---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-2 <span style="color:#000;font-weight:bold">|</span> 10.10.10.12 <span style="color:#000;font-weight:bold">|</span> Replica <span style="color:#000;font-weight:bold">|</span> running <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> conf: tiny.yml  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> spec: 1C.2G.50G <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> version: <span style="color:#4e9a06">&#39;15&#39;</span>   <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+---------+---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-3 <span style="color:#000;font-weight:bold">|</span> 10.10.10.13 <span style="color:#000;font-weight:bold">|</span> Replica <span style="color:#000;font-weight:bold">|</span> running <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> conf: tiny.yml  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> spec: 1C.2G.50G <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> version: <span style="color:#4e9a06">&#39;15&#39;</span>   <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+---------+---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span>Are you sure you want to switchover cluster pg-test, demoting current master pg-test-1? <span style="color:#ce5c00;font-weight:bold">[</span>y/N<span style="color:#ce5c00;font-weight:bold">]</span>: y
</span></span><span style="display:flex;"><span>2022-12-26 06:39:58.02468 Successfully switched over to <span style="color:#4e9a06">&#34;pg-test-2&#34;</span>
</span></span><span style="display:flex;"><span>+ Cluster: pg-test <span style="color:#ce5c00;font-weight:bold">(</span>7181325041648035869<span style="color:#ce5c00;font-weight:bold">)</span> -----+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> Member    <span style="color:#000;font-weight:bold">|</span> Host        <span style="color:#000;font-weight:bold">|</span> Role    <span style="color:#000;font-weight:bold">|</span> State   <span style="color:#000;font-weight:bold">|</span> TL <span style="color:#000;font-weight:bold">|</span> Lag in MB <span style="color:#000;font-weight:bold">|</span> Tags            <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+---------+---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-1 <span style="color:#000;font-weight:bold">|</span> 10.10.10.11 <span style="color:#000;font-weight:bold">|</span> Replica <span style="color:#000;font-weight:bold">|</span> stopped <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>   unknown <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> conf: tiny.yml  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> spec: 1C.2G.50G <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> version: <span style="color:#4e9a06">&#39;15&#39;</span>   <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+---------+---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-2 <span style="color:#000;font-weight:bold">|</span> 10.10.10.12 <span style="color:#000;font-weight:bold">|</span> Leader  <span style="color:#000;font-weight:bold">|</span> running <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> conf: tiny.yml  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> spec: 1C.2G.50G <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> version: <span style="color:#4e9a06">&#39;15&#39;</span>   <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+---------+---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-3 <span style="color:#000;font-weight:bold">|</span> 10.10.10.13 <span style="color:#000;font-weight:bold">|</span> Replica <span style="color:#000;font-weight:bold">|</span> running <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> conf: tiny.yml  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> spec: 1C.2G.50G <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> version: <span style="color:#4e9a06">&#39;15&#39;</span>   <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+---------+---------+----+-----------+-----------------+
</span></span></code></pre></div><p>要通过 Patroni API 来执行此操作（例如，在指定时间将主库从 2号实例 切换到 1号实例）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -u <span style="color:#4e9a06">&#39;postgres:Patroni.API&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -d <span style="color:#4e9a06">&#39;{&#34;leader&#34;:&#34;pg-test-2&#34;, &#34;candidate&#34;: &#34;pg-test-1&#34;,&#34;scheduled_at&#34;:&#34;2022-12-26T14:47+08&#34;}&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -s -X POST http://10.10.10.11:8008/switchover
</span></span></code></pre></div></details>
<p>无论是主动切换还是故障切换，您都需要在集群成员身份发生变化后，重新刷新服务与HBA规则。您应当在变更发生后及时（例如几个小时，一天内），完成此操作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-svc &lt;cls&gt;
</span></span><span style="display:flex;"><span>bin/pgsql-hba &lt;cls&gt;
</span></span></code></pre></div><hr>
<h2 id="备份集群">备份集群</h2>
<p>使用 pgBackRest 创建备份，需要以本地 dbsu （默认为 <code>postgres</code>）的身份运行以下命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg-backup       <span style="color:#8f5902;font-style:italic"># 执行备份，如有必要，执行增量或全量备份</span>
</span></span><span style="display:flex;"><span>pg-backup full  <span style="color:#8f5902;font-style:italic"># 执行全量备份</span>
</span></span><span style="display:flex;"><span>pg-backup diff  <span style="color:#8f5902;font-style:italic"># 执行差异备份</span>
</span></span><span style="display:flex;"><span>pg-backup incr  <span style="color:#8f5902;font-style:italic"># 执行增量备份</span>
</span></span><span style="display:flex;"><span>pb info         <span style="color:#8f5902;font-style:italic"># 打印备份信息 （pgbackrest info）</span>
</span></span></code></pre></div><p>参阅<a href="/zh/docs/pgsql/pitr#%E5%A4%87%E4%BB%BD">备份恢复</a>获取更多信息。</p>
<details><summary>示例：创建备份</summary>
<p><a href="https://asciinema.org/a/568813"><img alt="asciicast" src="https://asciinema.org/a/568813.svg"></a></p>
</details>
<details><summary>示例：创建定时备份任务</summary>
<p>您可以将 crontab 添加到 <a href="/zh/docs/reference/param#node_crontab"><code>node_crontab</code></a> 以指定您的备份策略。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 每天凌晨1点做一次全备份</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#4e9a06">&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 周一凌晨1点进全量备份，其他工作日进行增量备份</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#4e9a06">&#39;00 01 * * 1 postgres /pg/bin/pg-backup full&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#4e9a06">&#39;00 01 * * 2,3,4,5,6,7 postgres /pg/bin/pg-backup&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></details>
<hr>
<h2 id="恢复集群">恢复集群</h2>
<p>要将集群恢复到先前的时间点 (PITR)，请以本地 dbsu 用户（默认为<code>postgres</code>）运行 Pigsty 提供的辅助脚本 <code>pg-pitr</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg-pitr -i                              <span style="color:#8f5902;font-style:italic"># 恢复到最近备份完成的时间（不常用）</span>
</span></span><span style="display:flex;"><span>pg-pitr --time<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2022-12-30 14:44:44+08&#34;</span> <span style="color:#8f5902;font-style:italic"># 恢复到指定的时间点（在删除数据库或表的情况下使用）</span>
</span></span><span style="display:flex;"><span>pg-pitr --name<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;my-restore-point&#34;</span>       <span style="color:#8f5902;font-style:italic"># 恢复到使用 pg_create_restore_point 创建的命名恢复点</span>
</span></span><span style="display:flex;"><span>pg-pitr --lsn<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;0/7C82CB8&#34;</span> -X            <span style="color:#8f5902;font-style:italic"># 在LSN之前立即恢复</span>
</span></span><span style="display:flex;"><span>pg-pitr --xid<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;1234567&#34;</span> -X -P           <span style="color:#8f5902;font-style:italic"># 在指定的事务ID之前立即恢复，然后将集群直接提升为主库</span>
</span></span><span style="display:flex;"><span>pg-pitr --backup<span style="color:#ce5c00;font-weight:bold">=</span>latest                 <span style="color:#8f5902;font-style:italic"># 恢复到最新的备份集</span>
</span></span><span style="display:flex;"><span>pg-pitr --backup<span style="color:#ce5c00;font-weight:bold">=</span>20221108-105325        <span style="color:#8f5902;font-style:italic"># 恢复到特定备份集，备份集可以使用 pgbackrest info 列出</span>
</span></span></code></pre></div><p>该命令会输出操作手册，请按照说明进行操作。查看<a href="/zh/docs/pgsql/pitr#%E6%81%A2%E5%A4%8D">备份恢复-PITR</a>获取详细信息。</p>
<details><summary>示例：使用原始pgBackRest命令进行 PITR</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 恢复到最新可用的点（例如硬件故障）</span>
</span></span><span style="display:flex;"><span>pgbackrest --stanza<span style="color:#ce5c00;font-weight:bold">=</span>pg-meta restore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># PITR 到特定的时间点（例如意外删除表）</span>
</span></span><span style="display:flex;"><span>pgbackrest --stanza<span style="color:#ce5c00;font-weight:bold">=</span>pg-meta --type<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">time</span> --target<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2022-11-08 10:58:48&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>   --target-action<span style="color:#ce5c00;font-weight:bold">=</span>promote restore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 恢复特定的备份点，然后提升（或暂停|关闭）</span>
</span></span><span style="display:flex;"><span>pgbackrest --stanza<span style="color:#ce5c00;font-weight:bold">=</span>pg-meta --type<span style="color:#ce5c00;font-weight:bold">=</span>immediate --target-action<span style="color:#ce5c00;font-weight:bold">=</span>promote <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --set<span style="color:#ce5c00;font-weight:bold">=</span>20221108-105325F_20221108-105938I restore
</span></span></code></pre></div></details>
<hr>
<h2 id="添加软件">添加软件</h2>
<p>要添加新版本的 RPM 包，你需要将它们加入到 <a href="/zh/docs/reference/param#repo_packages"><code>repo_packages</code></a> 和 <a href="/zh/docs/reference/param#repo_url_packages"><code>repo_url_packages</code></a> 中。</p>
<p>使用 <code>./infra.yml -t repo_build</code> 子任务在 Infra 节点上重新构建本地软件仓库。然后，你可以使用 <code>ansible</code> 的 <code>package</code> 模块安装这些包：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible pg-test -b -m package -a <span style="color:#4e9a06">&#34;name=pg_cron_15,topn_15,pg_stat_monitor_15*&#34;</span>  <span style="color:#8f5902;font-style:italic"># 使用 ansible 安装一些包</span>
</span></span></code></pre></div><details><summary>示例：手动更本地新软件源中的包</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在基础设施/管理节点上添加上游软件仓库，然后手工下载所需的软件包</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty<span style="color:#000;font-weight:bold">;</span> ./infra.yml -t repo_upstream,repo_cache <span style="color:#8f5902;font-style:italic"># 添加上游仓库（互联网）</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> /www/pigsty<span style="color:#000;font-weight:bold">;</span>  repotrack <span style="color:#4e9a06">&#34;some_new_package_name&#34;</span>   <span style="color:#8f5902;font-style:italic"># 下载最新的 RPM 包</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 更新本地软件仓库元数据</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty<span style="color:#000;font-weight:bold">;</span> ./infra.yml -t repo_create              <span style="color:#8f5902;font-style:italic"># 重新创建本地软件仓库</span>
</span></span><span style="display:flex;"><span>./node.yml -t node_repo                              <span style="color:#8f5902;font-style:italic"># 刷新所有节点上的 YUM/APT 缓存</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 也可以使用 Ansible 手工刷新节点上的 YUM/APT 缓存</span>
</span></span><span style="display:flex;"><span>ansible all -b -a <span style="color:#4e9a06">&#39;yum clean all&#39;</span>                    <span style="color:#8f5902;font-style:italic"># 清理节点软件仓库缓存</span>
</span></span><span style="display:flex;"><span>ansible all -b -a <span style="color:#4e9a06">&#39;yum makecache&#39;</span>                    <span style="color:#8f5902;font-style:italic"># 从新的仓库重建yum/apt缓存</span>
</span></span><span style="display:flex;"><span>ansible all -b -a <span style="color:#4e9a06">&#39;apt clean&#39;</span>                        <span style="color:#8f5902;font-style:italic"># 清理 APT 缓存（Ubuntu/Debian）</span>
</span></span><span style="display:flex;"><span>ansible all -b -a <span style="color:#4e9a06">&#39;apt update&#39;</span>                       <span style="color:#8f5902;font-style:italic"># 重建 APT 缓存（Ubuntu/Debian）</span>
</span></span></code></pre></div><p>例如，你可以使用以下方式安装或升级包：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible pg-test -b -m package -a <span style="color:#4e9a06">&#34;name=postgresql15* state=latest&#34;</span>
</span></span></code></pre></div></details>
<hr>
<h2 id="安装扩展">安装扩展</h2>
<p>如果你想在 PostgreSQL 集群上安装扩展，请将它们加入到 <a href="/zh/docs/reference/param#pg_extensions"><code>pg_extensions</code></a> 中，并执行：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_extension     <span style="color:#8f5902;font-style:italic"># 安装扩展</span>
</span></span></code></pre></div><p>一部分扩展需要在 <code>shared_preload_libraries</code> 中加载后才能生效。你可以将它们加入到 <a href="/zh/docs/reference/param#pg_libs"><code>pg_libs</code></a> 中，或者<a href="/zh/docs/pgsql/admin/#配置集群">配置</a>一个已有的集群。</p>
<p>最后，在集群的主库上执行 <code>CREATE EXTENSION &lt;extname&gt;;</code> 来完成扩展的安装。</p>
<details><summary>示例：在 pg-test 集群上安装 pg_cron 扩展</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible pg-test -b -m package -a <span style="color:#4e9a06">&#34;name=pg_cron_15&#34;</span>          <span style="color:#8f5902;font-style:italic"># 在所有节点上安装 pg_cron 包</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将 pg_cron 添加到 shared_preload_libraries 中</span>
</span></span><span style="display:flex;"><span>pg edit-config --force -p <span style="color:#000">shared_preload_libraries</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;timescaledb, pg_cron, pg_stat_statements, auto_explain&#39;</span>
</span></span><span style="display:flex;"><span>pg restart --force pg-test                                  <span style="color:#8f5902;font-style:italic"># 重新启动集群</span>
</span></span><span style="display:flex;"><span>psql -h pg-test -d postgres -c <span style="color:#4e9a06">&#39;CREATE EXTENSION pg_cron;&#39;</span>  <span style="color:#8f5902;font-style:italic"># 在主库上安装 pg_cron</span>
</span></span></code></pre></div></details>
<p>更多细节，请参考<a href="/zh/docs/reference/extension#%E6%89%A9%E5%B1%95%E5%AE%89%E8%A3%85">PGSQL扩展安装</a>。</p>
<hr>
<h2 id="小版本升级">小版本升级</h2>
<p>要执行小版本的服务器升级/降级，您首先需要在本地软件仓库中<a href="/zh/docs/pgsql/admin/#添加软件">添加软件</a>：最新的PG小版本 RPM/DEB。</p>
<p>首先对所有从库执行滚动升级/降级，然后执行集群<a href="/zh/docs/pgsql/admin/#主动切换">主从切换</a>以升级/降级主库。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible &lt;cls&gt; -b -a <span style="color:#4e9a06">&#34;yum upgrade/downgrade -y &lt;pkg&gt;&#34;</span>    <span style="color:#8f5902;font-style:italic"># 升级/降级软件包</span>
</span></span><span style="display:flex;"><span>pg restart --force &lt;cls&gt;                                <span style="color:#8f5902;font-style:italic"># 重启集群</span>
</span></span></code></pre></div><details><summary>示例：将PostgreSQL 15.2降级到15.1</summary>
<p>将15.1的包添加到软件仓库并刷新节点的 yum/apt 缓存：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty<span style="color:#000;font-weight:bold">;</span> ./infra.yml -t repo_upstream               <span style="color:#8f5902;font-style:italic"># 添加上游仓库</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> /www/pigsty<span style="color:#000;font-weight:bold">;</span> repotrack postgresql15-*-15.1           <span style="color:#8f5902;font-style:italic"># 将15.1的包添加到yum仓库</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty<span style="color:#000;font-weight:bold">;</span> ./infra.yml -t repo_create                 <span style="color:#8f5902;font-style:italic"># 重建仓库元数据</span>
</span></span><span style="display:flex;"><span>ansible pg-test -b -a <span style="color:#4e9a06">&#39;yum clean all&#39;</span>                   <span style="color:#8f5902;font-style:italic"># 清理节点仓库缓存</span>
</span></span><span style="display:flex;"><span>ansible pg-test -b -a <span style="color:#4e9a06">&#39;yum makecache&#39;</span>                   <span style="color:#8f5902;font-style:italic"># 从新仓库重新生成yum缓存</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 对于 Ubutnu/Debian 用户，使用 apt 替换 yum</span>
</span></span><span style="display:flex;"><span>ansible pg-test -b -a <span style="color:#4e9a06">&#39;apt clean&#39;</span>                       <span style="color:#8f5902;font-style:italic"># 清理节点仓库缓存</span>
</span></span><span style="display:flex;"><span>ansible pg-test -b -a <span style="color:#4e9a06">&#39;apt update&#39;</span>                      <span style="color:#8f5902;font-style:italic"># 从新仓库重新生成apt缓存</span>
</span></span></code></pre></div><p>执行降级并重启集群：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible pg-test -b -a <span style="color:#4e9a06">&#34;yum downgrade -y postgresql15*&#34;</span>  <span style="color:#8f5902;font-style:italic"># 降级软件包）</span>
</span></span><span style="display:flex;"><span>pg restart --force pg-test                              <span style="color:#8f5902;font-style:italic"># 重启整个集群以完成升级</span>
</span></span></code></pre></div></details>
<details><summary>示例：将PostgreSQL 15.1升级回15.2</summary>
<p>这次我们采用滚动方式升级：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible pg-test -b -a <span style="color:#4e9a06">&#34;yum upgrade -y postgresql15*&#34;</span>    <span style="color:#8f5902;font-style:italic"># 升级软件包（或 apt upgrade）</span>
</span></span><span style="display:flex;"><span>ansible pg-test -b -a <span style="color:#4e9a06">&#39;/usr/pgsql/bin/pg_ctl --version&#39;</span> <span style="color:#8f5902;font-style:italic"># 检查二进制版本是否为15.2</span>
</span></span><span style="display:flex;"><span>pg restart --role replica --force pg-test               <span style="color:#8f5902;font-style:italic"># 重启从库</span>
</span></span><span style="display:flex;"><span>pg switchover --leader pg-test-1 --candidate<span style="color:#ce5c00;font-weight:bold">=</span>pg-test-2 --scheduled<span style="color:#ce5c00;font-weight:bold">=</span>now --force pg-test    <span style="color:#8f5902;font-style:italic"># 切换主从</span>
</span></span><span style="display:flex;"><span>pg restart --role primary --force pg-test               <span style="color:#8f5902;font-style:italic"># 重启主库</span>
</span></span></code></pre></div></details>
<hr>
<h2 id="大版本升级">大版本升级</h2>
<p>实现大版本升级的最简单办法是：创建一个使用新版本的新集群，然后通过逻辑复制，蓝绿部署，并进行<a href="/zh/docs/pgsql/migration">在线迁移</a>。</p>
<p>您也可以进行原地大版本升级，当您只使用数据库内核本身时，这并不复杂，使用 PostgreSQL 自带的 <code>pg_upgrade</code> 即可：</p>
<p>假设您想将 PostgreSQL 大版本从 14 升级到 15，您首先需要在仓库中<a href="/zh/docs/pgsql/admin/#添加软件">添加软件</a>，并确保两个大版本两侧安装的核心扩展插件也具有相同的版本号。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_pkg -e <span style="color:#000">pg_version</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">15</span>                         <span style="color:#8f5902;font-style:italic"># 安装pg 15的包</span>
</span></span><span style="display:flex;"><span>sudo su - postgres<span style="color:#000;font-weight:bold">;</span> mkdir -p /data/postgres/pg-meta-15/data/   <span style="color:#8f5902;font-style:italic"># 为15准备目录</span>
</span></span><span style="display:flex;"><span>pg_upgrade -b /usr/pgsql-14/bin/ -B /usr/pgsql-15/bin/ -d /data/postgres/pg-meta-14/data/ -D /data/postgres/pg-meta-15/data/ -v -c <span style="color:#8f5902;font-style:italic"># 预检</span>
</span></span><span style="display:flex;"><span>pg_upgrade -b /usr/pgsql-14/bin/ -B /usr/pgsql-15/bin/ -d /data/postgres/pg-meta-14/data/ -D /data/postgres/pg-meta-15/data/ --link -j8 -v -c
</span></span><span style="display:flex;"><span>rm -rf /usr/pgsql<span style="color:#000;font-weight:bold">;</span> ln -s /usr/pgsql-15 /usr/pgsql<span style="color:#000;font-weight:bold">;</span>             <span style="color:#8f5902;font-style:italic"># 修复二进制链接</span>
</span></span><span style="display:flex;"><span>mv /data/postgres/pg-meta-14 /data/postgres/pg-meta-15         <span style="color:#8f5902;font-style:italic"># 重命名数据目录</span>
</span></span><span style="display:flex;"><span>rm -rf /pg<span style="color:#000;font-weight:bold">;</span> ln -s /data/postgres/pg-meta-15 /pg                <span style="color:#8f5902;font-style:italic"># 修复数据目录链接</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-54447441a605cf594e517be7f37ae788">11 - 访问控制</h1>
    <div class="lead">Pigsty 提供的默认角色系统与权限模型</div>
	<blockquote>
<p>Pigsty 提供了一套开箱即用的，基于<a href="/zh/docs/pgsql/acl/#角色系统">角色系统</a>和<a href="/zh/docs/pgsql/acl/#权限系统">权限系统</a>的访问控制模型。</p>
</blockquote>
<p>权限控制很重要，但很多用户做不好。因此 Pigsty 提供了一套开箱即用的精简访问控制模型，为您的集群安全性提供一个兜底。</p>
<hr>
<h2 id="角色系统">角色系统</h2>
<p>Pigsty 默认的角色系统包含四个<a href="/zh/docs/pgsql/acl/#默认角色">默认角色</a>和四个<a href="/zh/docs/pgsql/acl/#默认用户">默认用户</a>：</p>
<table>
<thead>
<tr>
<th>角色名称</th>
<th>属性</th>
<th>所属</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dbrole_readonly</code></td>
<td><code>NOLOGIN</code></td>
<td></td>
<td>角色：全局只读访问</td>
</tr>
<tr>
<td><code>dbrole_readwrite</code></td>
<td><code>NOLOGIN</code></td>
<td>dbrole_readonly</td>
<td>角色：全局读写访问</td>
</tr>
<tr>
<td><code>dbrole_admin</code></td>
<td><code>NOLOGIN</code></td>
<td>pg_monitor,dbrole_readwrite</td>
<td>角色：管理员/对象创建</td>
</tr>
<tr>
<td><code>dbrole_offline</code></td>
<td><code>NOLOGIN</code></td>
<td></td>
<td>角色：受限的只读访问</td>
</tr>
<tr>
<td><code>postgres</code></td>
<td><code>SUPERUSER</code></td>
<td></td>
<td>系统超级用户</td>
</tr>
<tr>
<td><code>replicator</code></td>
<td><code>REPLICATION</code></td>
<td>pg_monitor,dbrole_readonly</td>
<td>系统复制用户</td>
</tr>
<tr>
<td><code>dbuser_dba</code></td>
<td><code>SUPERUSER</code></td>
<td>dbrole_admin</td>
<td>pgsql 管理用户</td>
</tr>
<tr>
<td><code>dbuser_monitor</code></td>
<td></td>
<td>pg_monitor</td>
<td>pgsql 监控用户</td>
</tr>
</tbody>
</table>
<p>这些<a href="/zh/docs/pgsql/user#%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7">角色与用户</a>的详细定义如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_default_roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># 全局默认的角色与系统用户</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_readonly  ,login: false ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for global read-only access     }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_offline   ,login: false ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for restricted read-only access }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for global read-write access }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for object creation }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: postgres     ,superuser: true  ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system superuser }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system replicator }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_monitor ,roles: [pg_monitor] ,pgbouncer: true ,parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql monitor user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="默认角色">默认角色</h2>
<p>Pigsty 中有四个默认角色：</p>
<ul>
<li>业务只读 (<code>dbrole_readonly</code>): 用于全局只读访问的角色。如果别的业务想要此库只读访问权限，可以使用此角色。</li>
<li>业务读写 (<code>dbrole_readwrite</code>): 用于全局读写访问的角色，主属业务使用的生产账号应当具有数据库读写权限</li>
<li>业务管理员 (<code>dbrole_admin</code>): 拥有DDL权限的角色，通常用于业务管理员，或者需要在应用中建表的场景（比如各种业务软件）</li>
<li>离线只读访问 (<code>dbrole_offline</code>): 受限的只读访问角色（只能访问 <a href="/zh/docs/pgsql/config#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93">offline</a> 实例，通常是个人用户，ETL工具账号）</li>
</ul>
<p>默认角色在 <a href="/zh/docs/reference/param#pg_default_roles"><code>pg_default_roles</code></a> 中定义，除非您确实知道自己在干什么，建议不要更改默认角色的名称。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_readonly  , login: false , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for global read-only access  }                           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 生产环境的只读角色</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_offline ,   login: false , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for restricted read-only access (offline instance) }     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 受限的只读角色</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_readwrite , login: false , roles: [dbrole_readonly], comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for global read-write access } </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 生产环境的读写角色</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_admin , login: false , roles: [pg_monitor, dbrole_readwrite] , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for object creation }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 生产环境的 DDL 更改角色</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="默认用户">默认用户</h2>
<p>Pigsty 也有四个默认用户（系统用户）：</p>
<ul>
<li>超级用户 (<code>postgres</code>)，集群的所有者和创建者，与操作系统 dbsu 名称相同。</li>
<li>复制用户 (<code>replicator</code>)，用于主-从复制的系统用户。</li>
<li>监控用户 (<code>dbuser_monitor</code>)，用于监控数据库和连接池指标的用户。</li>
<li>管理用户 (<code>dbuser_dba</code>)，执行日常操作和数据库更改的管理员用户。</li>
</ul>
<p>这4个默认用户的用户名/密码通过4对专用参数进行定义，并在很多地方引用：</p>
<ul>
<li><a href="/zh/docs/reference/param#pg_dbsu"><code>pg_dbsu</code></a>：操作系统 dbsu 名称，默认为 postgres，最好不要更改它</li>
<li><a href="/zh/docs/reference/param#pg_dbsu_password"><code>pg_dbsu_password</code></a>：dbsu 密码，默认为空字符串意味着不设置 dbsu 密码，最好不要设置。</li>
<li><a href="/zh/docs/reference/param#pg_replication_username"><code>pg_replication_username</code></a>：postgres 复制用户名，默认为 <code>replicator</code></li>
<li><a href="/zh/docs/reference/param#pg_replication_password"><code>pg_replication_password</code></a>：postgres 复制密码，默认为 <code>DBUser.Replicator</code></li>
<li><a href="/zh/docs/reference/param#pg_admin_username"><code>pg_admin_username</code></a>：postgres 管理员用户名，默认为 <code>dbuser_dba</code></li>
<li><a href="/zh/docs/reference/param#pg_admin_password"><code>pg_admin_password</code></a>：postgres 管理员密码的明文，默认为 <code>DBUser.DBA</code></li>
<li><a href="/zh/docs/reference/param#pg_monitor_username"><code>pg_monitor_username</code></a>：postgres 监控用户名，默认为 <code>dbuser_monitor</code></li>
<li><a href="/zh/docs/reference/param#pg_monitor_password"><code>pg_monitor_password</code></a>：postgres 监控密码，默认为 <code>DBUser.Monitor</code></li>
</ul>
<blockquote>
<p><strong>在生产部署中记得更改这些密码，不要使用默认值！</strong></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_dbsu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres                            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 数据库超级用户名，这个用户名建议不要修改。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_dbsu_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># 数据库超级用户密码，这个密码建议留空！禁止dbsu密码登陆。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_replication_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replicator          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 系统复制用户名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_replication_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Replicator   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 系统复制密码，请务必修改此密码！</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_monitor_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 系统监控用户名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_monitor_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Monitor          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 系统监控密码，请务必修改此密码！</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_admin_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_dba                </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 系统管理用户名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_admin_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.DBA                </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 系统管理密码，请务必修改此密码！</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>如果您修改默认用户的参数，在 <a href="/zh/docs/reference/param#pg_default_roles"><code>pg_default_roles</code></a> 中修改相应的角色<a href="/zh/docs/pgsql/user#%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7">定义</a>即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: postgres     ,superuser: true                                          ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system superuser }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system replicator }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_monitor   ,roles: [pg_monitor, dbrole_readonly] ,pgbouncer: true ,parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql monitor user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="权限系统">权限系统</h2>
<p>Pigsty 拥有一套开箱即用的权限模型，该模型与<a href="/zh/docs/pgsql/acl/#default-roles">默认角色</a>一起配合工作。</p>
<ul>
<li>所有用户都可以访问所有模式。</li>
<li>只读用户（<code>dbrole_readonly</code>）可以从所有表中读取数据。（SELECT，EXECUTE）</li>
<li>读写用户（<code>dbrole_readwrite</code>）可以向所有表中写入数据并运行 DML。（INSERT，UPDATE，DELETE）。</li>
<li>管理员用户（<code>dbrole_admin</code>）可以创建对象并运行 DDL（CREATE，USAGE，TRUNCATE，REFERENCES，TRIGGER）。</li>
<li>离线用户（<code>dbrole_offline</code>）类似只读用户，但访问受到限制，只允许访问<a href="/zh/docs/pgsql/config#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93">离线实例</a>（<code>pg_role = 'offline'</code> 或 <code>pg_offline_query = true</code>）</li>
<li>由管理员用户创建的对象将具有正确的权限。</li>
<li>所有数据库上都配置了默认权限，包括模板数据库。</li>
<li>数据库连接权限由数据库<a href="/zh/docs/pgsql/db#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93">定义</a>管理。</li>
<li>默认撤销<code>PUBLIC</code>在数据库和<code>public</code>模式下的<code>CREATE</code>权限。</li>
</ul>
<hr>
<h2 id="对象权限">对象权限</h2>
<p>数据库中新建对象的默认权限由参数 <a href="/zh/docs/reference/param#pg_default_privileges"><code>pg_default_privileges</code></a> 所控制：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#000">GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>由管理员<strong>新创建</strong>的对象，默认将会上述权限。使用 <code>\ddp+</code> 可以查看这些默认权限：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>访问权限</th>
</tr>
</thead>
<tbody>
<tr>
<td>函数</td>
<td>=X</td>
</tr>
<tr>
<td></td>
<td>dbrole_readonly=X</td>
</tr>
<tr>
<td></td>
<td>dbrole_offline=X</td>
</tr>
<tr>
<td></td>
<td>dbrole_admin=X</td>
</tr>
<tr>
<td>模式</td>
<td>dbrole_readonly=U</td>
</tr>
<tr>
<td></td>
<td>dbrole_offline=U</td>
</tr>
<tr>
<td></td>
<td>dbrole_admin=UC</td>
</tr>
<tr>
<td>序列号</td>
<td>dbrole_readonly=r</td>
</tr>
<tr>
<td></td>
<td>dbrole_offline=r</td>
</tr>
<tr>
<td></td>
<td>dbrole_readwrite=wU</td>
</tr>
<tr>
<td></td>
<td>dbrole_admin=rwU</td>
</tr>
<tr>
<td>表</td>
<td>dbrole_readonly=r</td>
</tr>
<tr>
<td></td>
<td>dbrole_offline=r</td>
</tr>
<tr>
<td></td>
<td>dbrole_readwrite=awd</td>
</tr>
<tr>
<td></td>
<td>dbrole_admin=arwdDxt</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="默认权限">默认权限</h2>
<p><a href="https://www.postgresql.org/docs/current/sql-alterdefaultprivileges.html"><code>ALTER DEFAULT PRIVILEGES</code></a> 允许您设置将来创建的对象的权限。 它不会影响已经存在对象的权限，也不会影响非管理员用户创建的对象。</p>
<p>在 Pigsty 中，默认权限针对三个角色进行定义：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_default_privileges</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIVILEGES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_dbsu</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}}</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">endfor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_default_privileges</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIVILEGES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_admin_username</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}}</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">endfor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 对于其他业务管理员而言，它们应当在执行 DDL 前执行 SET ROLE dbrole_admin，从而使用对应的默认权限配置。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_default_privileges</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIVILEGES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;dbrole_admin&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}}</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">endfor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这些内容将会被 PG集群初始化模板 <a href="https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql"><code>pg-init-template.sql</code></a> 所使用，在集群初始化的过程中渲染并输出至 <code>/pg/tmp/pg-init-template.sql</code>。
该命令会在 <code>template1</code> 与 <code>postgres</code> 数据库中执行，新创建的数据库会通过模板 <code>template1</code> 继承这些默认权限配置。</p>
<p>也就是说，为了维持正确的对象权限，您必须用<strong>管理员用户</strong>来执行 DDL，它们可以是：</p>
<ol>
<li><a href="/zh/docs/reference/param#pg_dbsu"><code>{{ pg_dbsu }}</code></a>，默认为 <code>postgres</code></li>
<li><a href="/zh/docs/reference/param#pg_admin_username"><code>{{ pg_admin_username }}</code></a>，默认为 <code>dbuser_dba</code></li>
<li>授予了 <code>dbrole_admin</code> 角色的业务管理员用户（通过 <code>SET ROLE</code> 切换为 <code>dbrole_admin</code> 身份）。</li>
</ol>
<p>使用 <code>postgres</code> 作为全局对象所有者是明智的。如果您希望以业务管理员用户身份创建对象，创建之前必须使用 <code>SET ROLE dbrole_admin</code> 来维护正确的权限。</p>
<p>当然，您也可以在数据库中通过 <code>ALTER DEFAULT PRIVILEGE FOR ROLE &lt;some_biz_admin&gt; XXX</code> 来显式对业务管理员授予默认权限。</p>
<hr>
<h2 id="数据库权限">数据库权限</h2>
<p>在 Pigsty 中，数据库（Database）层面的权限在<a href="/zh/docs/pgsql/acl/#定义数据库">数据库定义</a>中被涵盖。</p>
<p>数据库有三个级别的权限：<code>CONNECT</code>、<code>CREATE</code>、<code>TEMP</code>，以及一个特殊的&rsquo;权限&rsquo;：<code>OWNERSHIP</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta        </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 必选，`name` 是数据库定义中唯一的必选字段</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，数据库所有者，默认为 postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">allowconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 可选，是否允许连接，默认为 true。显式设置 false 将完全禁止连接到此数据库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">revokeconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 可选，撤销公共连接权限。默认为 false，设置为 true 时，属主和管理员之外用户的 CONNECT 权限会被回收</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>如果 <code>owner</code> 参数存在，它作为数据库属主，替代默认的 <a href="/zh/docs/reference/param#pg_dbsu"><code>{{ pg_dbsu }}</code></a>（通常也就是<code>postgres</code>）</li>
<li>如果 <code>revokeconn</code> 为 <code>false</code>，所有用户都有数据库的 <code>CONNECT</code> 权限，这是默认的行为。</li>
<li>如果显式设置了 <code>revokeconn</code> 为 <code>true</code>：
<ul>
<li>数据库的 <code>CONNECT</code> 权限将从 <code>PUBLIC</code> 中撤销：普通用户无法连接上此数据库</li>
<li><code>CONNECT</code> 权限将被显式授予 <code>{{ pg_replication_username }}</code>、<code>{{ pg_monitor_username }}</code> 和 <code>{{ pg_admin_username }}</code></li>
<li><code>CONNECT</code> 权限将 <code>GRANT OPTION</code> 被授予数据库属主，数据库属主用户可以自行授权其他用户连接权限。</li>
</ul>
</li>
<li><code>revokeconn</code> 选项可用于在同一个集群间隔离跨数据库访问，您可以为每个数据库创建不同的业务用户作为属主，并为它们设置 <code>revokeconn</code> 选项。</li>
</ul>
<details><summary>示例：数据库隔离</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-infra</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.40</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.41</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role: replica , pg_offline_query</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-infra</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_confluence, password: mc2iohos , pgbouncer: true, roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_admin ] }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_gitlab, password: sdf23g22sfdd , pgbouncer: true, roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_readwrite ] }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_jira, password: sdpijfsfdsfdfs , pgbouncer: true, roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_admin ] }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: confluence , revokeconn: true, owner: dbuser_confluence , connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: gitlab , revokeconn: true, owner: dbuser_gitlab, connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: jira , revokeconn: true, owner: dbuser_jira , connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></details>
<hr>
<h2 id="create权限">CREATE权限</h2>
<p>出于安全考虑，Pigsty 默认从 <code>PUBLIC</code> 撤销数据库上的 <code>CREATE</code> 权限，从 PostgreSQL 15 开始这也是默认行为。</p>
<p>数据库属主总是可以根据实际需要，来自行调整 CREATE 权限。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cd0c200c9f6515f7a7ac9cc0f4b856bf">12 - 备份恢复</h1>
    <div class="lead">如何使用 pgBackRest 备份/恢复/PITR PostgreSQL 数据库集群</div>
	<blockquote>
<p>Pigsty 使用 <a href="https://pgbackrest.org/">pgBackRest</a> 进行 PITR 备份和恢复。</p>
</blockquote>
<p>对于硬件故障来说，基于物理复制的高可用故障切换可能会是最佳选择。而对于数据损坏（无论是机器还是人为错误），时间点恢复（PITR）则更为合适：它提供了对最坏情况的兜底。</p>
<hr>
<h2 id="备份">备份</h2>
<p>使用以下命令<a href="https://pgbackrest.org/command.html#command-backup">备份</a> PostgreSQL 数据库集群：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># stanza 是 pgbackrest 在同一个存储库中区别不同的集群的标识，默认 stanza 名称 = {{ pg_cluster }}</span>
</span></span><span style="display:flex;"><span>pgbackrest --stanza<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">stanza</span><span style="color:#4e9a06">}</span> --type<span style="color:#ce5c00;font-weight:bold">=</span>full<span style="color:#000;font-weight:bold">|</span>diff<span style="color:#000;font-weight:bold">|</span>incr backup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 你也可以在 pigsty 中使用 dbsu 执行以下命令 (/pg/bin/pg-backup) 进行备份</span>
</span></span><span style="display:flex;"><span>pg-backup       <span style="color:#8f5902;font-style:italic"># 执行备份，如有必要，执行增量或全量备份</span>
</span></span><span style="display:flex;"><span>pg-backup full  <span style="color:#8f5902;font-style:italic"># 执行全量备份</span>
</span></span><span style="display:flex;"><span>pg-backup diff  <span style="color:#8f5902;font-style:italic"># 执行差异备份</span>
</span></span><span style="display:flex;"><span>pg-backup incr  <span style="color:#8f5902;font-style:italic"># 执行增量备份</span>
</span></span></code></pre></div><p>使用以下命令打印备份信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pb info   <span style="color:#8f5902;font-style:italic"># pgbackrest info 打印备份信息</span>
</span></span></code></pre></div><details><summary>备份信息示例</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pb info
</span></span><span style="display:flex;"><span>stanza: pg-meta
</span></span><span style="display:flex;"><span>    status: ok
</span></span><span style="display:flex;"><span>    cipher: none
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    db <span style="color:#ce5c00;font-weight:bold">(</span>current<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        wal archive min/max <span style="color:#ce5c00;font-weight:bold">(</span>14<span style="color:#ce5c00;font-weight:bold">)</span>: 000000010000000000000001/000000010000000000000023
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        full backup: 20221108-105325F
</span></span><span style="display:flex;"><span>            timestamp start/stop: 2022-11-08 10:53:25 / 2022-11-08 10:53:29
</span></span><span style="display:flex;"><span>            wal start/stop: <span style="color:#0000cf;font-weight:bold">000000010000000000000004</span> / <span style="color:#0000cf;font-weight:bold">000000010000000000000004</span>
</span></span><span style="display:flex;"><span>            database size: 96.6MB, database backup size: 96.6MB
</span></span><span style="display:flex;"><span>            repo1: backup <span style="color:#204a87">set</span> size: 18.9MB, backup size: 18.9MB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        incr backup: 20221108-105325F_20221108-105938I
</span></span><span style="display:flex;"><span>            timestamp start/stop: 2022-11-08 10:59:38 / 2022-11-08 10:59:41
</span></span><span style="display:flex;"><span>            wal start/stop: 00000001000000000000000F / 00000001000000000000000F
</span></span><span style="display:flex;"><span>            database size: 246.7MB, database backup size: 167.3MB
</span></span><span style="display:flex;"><span>            repo1: backup <span style="color:#204a87">set</span> size: 35.4MB, backup size: 20.4MB
</span></span><span style="display:flex;"><span>            backup reference list: 20221108-105325F
</span></span></code></pre></div></details>
<p>您也可以从监控系统查阅备份信息：<a href="https://demo.pigsty.cc/d/pgcat-instance/pgcat-instance?viewPanel=158">PGCAT 实例 - 备份</a></p>
<hr>
<h2 id="恢复">恢复</h2>
<p>以下命令可以用于 PostgreSQL 数据库集群的 <a href="https://pgbackrest.org/command.html#command-restore">恢复</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pg-pitr                                 # 恢复到WAL存档流的结束位置（例如在整个数据中心故障的情况下使用）
</span></span><span style="display:flex;"><span>pg-pitr -i                              # 恢复到最近备份完成的时间（不常用）
</span></span><span style="display:flex;"><span>pg-pitr --time=&#34;2022-12-30 14:44:44+08&#34; # 恢复到指定的时间点（在删除数据库或表的情况下使用）
</span></span><span style="display:flex;"><span>pg-pitr --name=&#34;my-restore-point&#34;       # 恢复到使用 pg_create_restore_point 创建的命名恢复点
</span></span><span style="display:flex;"><span>pg-pitr --lsn=&#34;0/7C82CB8&#34; -X            # 在LSN之前立即恢复
</span></span><span style="display:flex;"><span>pg-pitr --xid=&#34;1234567&#34; -X -P           # 在指定的事务ID之前立即恢复，然后将集群直接提升为主库
</span></span><span style="display:flex;"><span>pg-pitr --backup=latest                 # 恢复到最新的备份集
</span></span><span style="display:flex;"><span>pg-pitr --backup=20221108-105325        # 恢复到特定备份集，备份集可以使用 pgbackrest info 列出
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pg-pitr                                 # pgbackrest --stanza=pg-meta restore
</span></span><span style="display:flex;"><span>pg-pitr -i                              # pgbackrest --stanza=pg-meta --type=immediate restore
</span></span><span style="display:flex;"><span>pg-pitr -t &#34;2022-12-30 14:44:44+08&#34;     # pgbackrest --stanza=pg-meta --type=time --target=&#34;2022-12-30 14:44:44+08&#34; restore
</span></span><span style="display:flex;"><span>pg-pitr -n &#34;my-restore-point&#34;           # pgbackrest --stanza=pg-meta --type=name --target=my-restore-point restore
</span></span><span style="display:flex;"><span>pg-pitr -b 20221108-105325F             # pgbackrest --stanza=pg-meta --type=name --set=20221230-120101F restore
</span></span><span style="display:flex;"><span>pg-pitr -l &#34;0/7C82CB8&#34; -X               # pgbackrest --stanza=pg-meta --type=lsn --target=&#34;0/7C82CB8&#34; --target-exclusive restore
</span></span><span style="display:flex;"><span>pg-pitr -x 1234567 -X -P                # pgbackrest --stanza=pg-meta --type=xid --target=&#34;0/7C82CB8&#34; --target-exclusive --target-action=promote restore
</span></span></code></pre></div><p>Pigsty 提供的 <code>pg-pitr</code> 脚本会帮助您生成进行 PITR 指令，例如，如果您希望将当前集群状态回滚至 <code>&quot;2023-02-07 12:38:00+08&quot;</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg-pitr -t <span style="color:#4e9a06">&#34;2023-02-07 12:38:00+08&#34;</span>
</span></span><span style="display:flex;"><span>pgbackrest --stanza<span style="color:#ce5c00;font-weight:bold">=</span>pg-meta --type<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">time</span> --target<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;2023-02-07 12:38:00+08&#39;</span> restore
</span></span><span style="display:flex;"><span>执行pg-meta时间点恢复
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>1. 停止PostgreSQL<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span><span style="display:flex;"><span>   1.1 暂停Patroni（如果有任何副本）
</span></span><span style="display:flex;"><span>       $ pg pause &lt;cls&gt;  <span style="color:#8f5902;font-style:italic"># 暂停patroni自动故障转移</span>
</span></span><span style="display:flex;"><span>   1.2 关闭Patroni
</span></span><span style="display:flex;"><span>       $ pt-stop         <span style="color:#8f5902;font-style:italic"># sudo systemctl stop patroni</span>
</span></span><span style="display:flex;"><span>   1.3 关闭Postgres
</span></span><span style="display:flex;"><span>       $ pg-stop         <span style="color:#8f5902;font-style:italic"># pg_ctl -D /pg/data stop -m fast</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>2. 执行PITR<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span><span style="display:flex;"><span>   2.1 恢复备份
</span></span><span style="display:flex;"><span>       $ pgbackrest --stanza<span style="color:#ce5c00;font-weight:bold">=</span>pg-meta --type<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">time</span> --target<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;2023-02-07 12:38:00+08&#39;</span> restore
</span></span><span style="display:flex;"><span>   2.2 启动PG以重放WAL
</span></span><span style="display:flex;"><span>       $ pg-start        <span style="color:#8f5902;font-style:italic"># pg_ctl -D /pg/data start</span>
</span></span><span style="display:flex;"><span>   2.3 验证并提升
</span></span><span style="display:flex;"><span>     - 如果数据库内容正确，提升它以完成恢复，否则转到2.1
</span></span><span style="display:flex;"><span>       $ pg-promote      <span style="color:#8f5902;font-style:italic"># pg_ctl -D /pg/data promote</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>3. 重启Patroni<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span><span style="display:flex;"><span>   3.1 启动Patroni
</span></span><span style="display:flex;"><span>       $ pt-start<span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic"># sudo systemctl start patroni</span>
</span></span><span style="display:flex;"><span>   3.2 再次启用归档
</span></span><span style="display:flex;"><span>       $ psql -c <span style="color:#4e9a06">&#39;ALTER SYSTEM SET archive_mode = on; SELECT pg_reload_conf();&#39;</span>
</span></span><span style="display:flex;"><span>   3.3 重启Patroni
</span></span><span style="display:flex;"><span>       $ pt-restart      <span style="color:#8f5902;font-style:italic"># sudo systemctl start patroni</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>4. 恢复集群<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span><span style="display:flex;"><span>   3.1 重新初始化所有副本（如果有任何副本）
</span></span><span style="display:flex;"><span>       $ pg reinit &lt;cls&gt; &lt;ins&gt;
</span></span><span style="display:flex;"><span>   3.2 恢复Patroni
</span></span><span style="display:flex;"><span>       $ pg resume &lt;cls&gt; <span style="color:#8f5902;font-style:italic"># 恢复patroni自动故障转移</span>
</span></span><span style="display:flex;"><span>   3.2 完整备份（可选）
</span></span><span style="display:flex;"><span>       $ pg-backup full  <span style="color:#8f5902;font-style:italic"># pgbackrest --stanza=pg-meta backup --type=full</span>
</span></span></code></pre></div><p>安装说明依次操作，即可完成集群的恢复。</p>
<hr>
<h2 id="备份策略">备份策略</h2>
<p>您可以使用<a href="/zh/docs/reference/param#node_crontab"><code>node_crontab</code></a> 和 <a href="/zh/docs/reference/param#pgbackrest_repo"><code>pgbackrest_repo</code></a>自定义备份策略。</p>
<ul>
<li>使用<a href="/zh/docs/reference/param#node_crontab"><code>node_crontab</code></a>设置定时备份任务</li>
<li>使用<a href="/zh/docs/reference/param#pgbackrest_repo"><code>pgbackrest_repo</code></a>设置备份保留策略</li>
</ul>
<p><strong>本地备份仓库</strong></p>
<p>例如，默认的<code>pg-meta</code>将每天凌晨1点进行一次全量备份。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>node_crontab:  <span style="color:#8f5902;font-style:italic"># 每天凌晨1点进行全量备份</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#4e9a06">&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span>
</span></span></code></pre></div><p>使用默认的本地备份仓库保留策略，它最多保留两个完整备份，在备份过程中临时允许第三个备份存在。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pgbackrest_repo:                  # pgbackrest 仓库定义</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://pgbackrest.org/configuration.html#section-repository</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">local</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># 默认使用本地文件系统的 pgbackrest 备份仓库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/pg/backup             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 本地备份目录，默认为`/pg/backup`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">retention_full_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">count   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 指定全量备份保留数量：2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">retention_full</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># 使用本地文件系统仓库时，最多保留2个完整备份，备份时临时允许3个</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>您的备份磁盘存储空间至少应该能放下最近三个数据库全量备份文件，以及这段期间（3天）内的WAL归档文件。</p>
<p><strong>MinIO备份仓库</strong></p>
<p>使用MinIO时，存储容量通常不是问题。您可以按需保留备份。例如，默认的 <code>pg-test</code> 样例集群将在星期一进行全量备份，其他工作日进行增量备份。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">node_crontab</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 周一凌晨1点进全量备份，其他工作日进行增量备份</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#39;00 01 * * 1 postgres /pg/bin/pg-backup full&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#39;00 01 * * 2,3,4,5,6,7 postgres /pg/bin/pg-backup&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>MinIO备份仓库可以使用14天的时间保留策略，这将保留最近两周内的备份。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pgbackrest_repo:                  # pgbackrest 仓库</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://pgbackrest.org/configuration.html#section-repository=</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">minio</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># pgbackrest 的可选minio仓库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3                     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio 是s3兼容的，因此使用s3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sss.pigsty      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio终端域名，默认为`sss.pigsty`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">us-east-1         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio区域，默认为us-east-1，对minio来说没有用</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_bucket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio桶名，默认为`pgsql`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbackrest           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pgbackrest的minio用户访问密钥</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_key_secret</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">S3User.Backup </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pgbackrest的minio用户密钥，这里请按实际情况填写密码，最好不要使用默认密码。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_uri_style</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 使用路径风格的uri，而不是主机风格的uri</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/pgbackrest            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio备份路径，默认为`/pgbackrest`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">storage_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9000</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># minio端口，默认为9000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">storage_ca_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/pki/ca.crt </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio的ca文件路径，默认为`/etc/pki/ca.crt`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">bundle</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">y</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># 将小文件打包成一个文件</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">cipher_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aes-256-cbc     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 为远程备份仓库启用AES加密</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">cipher_pass</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgBackRest      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># AES加密密码，默认为&#39;pgBackRest&#39;，这里最好按需修改以下</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">retention_full_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">time    </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 在minio仓库上按时间保留完整备份</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">retention_full</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># 保留过去14天的完整备份</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9df6c956772e8cb04fe4f58165034338">13 - 迁移</h1>
    <div class="lead">如何将现有的 PostgreSQL 集群以最小的停机时间迁移至新的、由Pigsty管理的 PostgreSQL 集群？</div>
	<p>Pigsty 内置了一个剧本 <a href="https://github.com/Vonng/pigsty/blob/main/pgsql-migration.yml"><code>pgsql-migration.yml</code></a> ，基于逻辑复制来实现在线数据库迁移。</p>
<p>通过预生成的自动化脚本，应用停机时间可以缩减到几秒内。但请注意，逻辑复制需要 PostgreSQL 10 以上的版本才能工作。</p>
<p>当然如果您有充足的停机时间预算，那么总是可以使用 <code>pg_dump | psql</code> 的方式进行停机迁移。</p>
<hr>
<h2 id="定义迁移任务">定义迁移任务</h2>
<p>想要使用Pigsty提供的在线迁移剧本，您需要创建一个定义文件，来描述迁移任务的细节。</p>
<p>请查看任务定义文件示例作为参考： <a href="https://github.com/Vonng/pigsty/blob/main/files/migration/pg-meta.yml"><code>files/migration/pg-meta.yml</code></a> 。</p>
<p>这个迁移任务要将 <code>pg-meta.meta</code> 在线迁移到 <code>pg-test.test</code>，前者称为 <strong>源集群（SRC）</strong>， 后者称为 <strong>宿集群（DST）</strong>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pg-meta-1	10.10.10.10  --&gt; pg-test-1	10.10.10.11 (10.10.10.12,10.10.10.13)
</span></span></code></pre></div><p>基于逻辑复制的迁移以数据库为单位，您需要指定需要迁移的数据库名称，以及数据库源宿集群主节点的 IP 地址，以及超级用户的连接信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># PG_MIGRATION</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">context_dir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">~/migration </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 迁移手册 &amp; 脚本的放置目录</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># SRC Cluster (旧集群)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">src_cls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 源集群名称                  &lt;必填&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">src_db</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 源数据库名称                &lt;必填&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">src_ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 源集群主 IP                &lt;必填&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#src_pg: &#39;&#39;            # 如果定义，使用此作为源 dbsu pgurl 代替：</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                      # postgres://{{ pg_admin_username }}@{{ src_ip }}/{{ src_db }}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                      # 例如: &#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#sub_conn: &#39;&#39;          # 如果定义，使用此作为订阅连接字符串代替：</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                      # host={{ src_ip }} dbname={{ src_db }} user={{ pg_replication_username }}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                      # 例如: &#39;host=10.10.10.10 dbname=meta user=replicator password=DBUser.Replicator&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># DST Cluster (新集群)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">dst_cls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 宿集群名称                  &lt;必填&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">dst_db</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 宿数据库名称                 &lt;必填&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">dst_ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.11</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 宿集群主 IP                &lt;必填&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#dst_pg: &#39;&#39;            # 如果定义，使用此作为目标 dbsu pgurl 代替：</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                      # postgres://{{ pg_admin_username }}@{{ dst_ip }}/{{ dst_db }}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                      # 例如: &#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.11:5432/test&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># PGSQL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_dbsu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_replication_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replicator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_replication_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Replicator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_admin_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_dba</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_admin_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.DBA</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_monitor_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_monitor_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Monitor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>默认情况下，源宿集群两侧的超级用户连接串会使用全局的管理员用户和各自主库的 IP 地址拼接而成，但您总是可以通过 <code>src_pg</code> 和 <code>dst_pg</code> 参数来覆盖这些默认值。
同理，您也可以通过 <code>sub_conn</code> 参数来覆盖订阅连接串的默认值。</p>
<hr>
<h2 id="生成迁移计划">生成迁移计划</h2>
<p>此剧本不会主动完成集群的迁移工作，但它会生成迁移所需的操作手册与自动化脚本。</p>
<p>默认情况下，你会在 <code>~/migration/pg-meta.meta</code> 下找到迁移上下文目录。
按照 <code>README.md</code> 的说明，依次执行这些脚本，你就可以完成数据库迁移了！</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 激活迁移上下文：启用相关环境变量</span>
</span></span><span style="display:flex;"><span>. ~/migration/pg-meta.meta/activate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这些脚本用于检查 src 集群状态，并帮助在 pigsty 中生成新的集群定义</span>
</span></span><span style="display:flex;"><span>./check-user     <span style="color:#8f5902;font-style:italic"># 检查 src 用户</span>
</span></span><span style="display:flex;"><span>./check-db       <span style="color:#8f5902;font-style:italic"># 检查 src 数据库</span>
</span></span><span style="display:flex;"><span>./check-hba      <span style="color:#8f5902;font-style:italic"># 检查 src hba 规则</span>
</span></span><span style="display:flex;"><span>./check-repl     <span style="color:#8f5902;font-style:italic"># 检查 src 复制身份</span>
</span></span><span style="display:flex;"><span>./check-misc     <span style="color:#8f5902;font-style:italic"># 检查 src 特殊对象</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这些脚本用于在现有的 src 集群和由 pigsty 管理的 dst 集群之间建立逻辑复制，除序列外的数据将实时同步</span>
</span></span><span style="display:flex;"><span>./copy-schema    <span style="color:#8f5902;font-style:italic"># 将模式复制到目标</span>
</span></span><span style="display:flex;"><span>./create-pub     <span style="color:#8f5902;font-style:italic"># 在 src 上创建发布</span>
</span></span><span style="display:flex;"><span>./create-sub     <span style="color:#8f5902;font-style:italic"># 在 dst 上创建订阅</span>
</span></span><span style="display:flex;"><span>./copy-progress  <span style="color:#8f5902;font-style:italic"># 打印逻辑复制进度</span>
</span></span><span style="display:flex;"><span>./copy-diff      <span style="color:#8f5902;font-style:italic"># 通过计数表快速比较 src 和 dst 的差异</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这些脚本将在在线迁移中运行，该迁移将停止 src 集群，复制序列号（逻辑复制不复制序列号！）</span>
</span></span><span style="display:flex;"><span>./copy-seq <span style="color:#ce5c00;font-weight:bold">[</span>n<span style="color:#ce5c00;font-weight:bold">]</span>   <span style="color:#8f5902;font-style:italic"># 同步序列号，如果给出了 n，则会应用额外的偏移</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 你必须根据你的访问方式（dns,vip,haproxy,pgbouncer等），将应用流量切换至新的集群！</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#./disable-src   # 将 src 集群访问限制为管理节点和新集群（你的实现）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#./re-routing    # 从 SRC 到 DST 重新路由应用流量！（你的实现）</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 然后进行清理以删除订阅和发布</span>
</span></span><span style="display:flex;"><span>./drop-sub       <span style="color:#8f5902;font-style:italic"># 迁移后在 dst 上删除订阅</span>
</span></span><span style="display:flex;"><span>./drop-pub       <span style="color:#8f5902;font-style:italic"># 迁移后在 src 上删除发布</span>
</span></span></code></pre></div><p><strong>注意事项</strong></p>
<p>如果担心拷贝序列号时出现主键冲突，您可以在拷贝时将所有序列号向前推进一段距离，例如 +1000 ，你可以使用 <code>./copy-seq</code> 加一个参数 <code>1000</code> 来实现这一点。</p>
<p>你必须实现自己的 <code>./re-routing</code> 脚本，以将你的应用流量从 src 路由到 dst。 因为我们不知道你的流量是如何路由的（例如 dns, VIP, haproxy 或 pgbouncer）。 当然，您也可以手动完成这项操作&hellip;</p>
<p>你可以实现一个 <code>./disable-src</code> 脚本来限制应用对 src 集群的访问，这是可选的：如果你能确保所有应用流量都在 <code>./re-routing</code> 中干净利落地切完，其实不用这一步。</p>
<p>但如果您有未知来源的各种访问无法梳理干净，那么最好使用更为彻底的方式：更改 HBA 规则并重新加载来实现（推荐），或者只是简单粗暴地关停源主库上的 postgres、pgbouncer 或 haproxy 进程。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d62cf100c93be858ce7b3c37726c8061">14 - 监控接入</h1>
    <div class="lead">Pigsty监控系统架构概览，以及如何监控现存的 PostgreSQL 实例？</div>
	<p>本文介绍了 Pigsty 的监控系统架构，包括监控指标，日志，与目标管理的方式。以及如何<a href="/zh/docs/pgsql/monitor/#监控现有集群">监控现有PG集群</a>与远程 <a href="/zh/docs/pgsql/monitor/#监控rds">RDS服务</a>。</p>
<hr>
<h2 id="监控概览">监控概览</h2>
<p>Pigsty使用现代的可观测技术栈对 PostgreSQL 进行监控：</p>
<ul>
<li>使用 Grafana 进行指标可视化和 PostgreSQL 数据源。</li>
<li>使用 Prometheus 来采集 PostgreSQL / Pgbouncer / Patroni / HAProxy / Node 的指标</li>
<li>使用 Loki 来记录 PostgreSQL / Pgbouncer / Patroni / pgBackRest 以及主机组件的日志</li>
<li>Pigsty 提供了开箱即用的 Grafana <a href="/zh/docs/pgsql/dashboard">仪表盘</a>，展示与 PostgreSQL 有关的方方面面。</li>
</ul>
<p><strong>监控指标</strong></p>
<p>PostgreSQL 本身的监控指标完全由 pg_exporter 配置文件所定义：<a href="https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg_exporter.yml"><code>pg_exporter.yml</code></a>
它将进一步被 Prometheus 记录规则和告警规则进行加工处理：<a href="https://github.com/Vonng/pigsty/blob/main/files/prometheus/rules/pgsql.yml"><code>files/prometheus/rules/pgsql.yml</code></a>。</p>
<p>Pigsty使用三个身份标签：<code>cls</code>、<code>ins</code>、<code>ip</code>，它们将附加到所有指标和日志上。此外，Pgbouncer的监控指标，主机节点 NODE，与负载均衡器的监控指标也会被 Pigsty 所使用，并尽可能地使用相同的标签以便于关联分析。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cls: pg-meta, ins: pg-meta-1, ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cls: pg-meta, ins: pg-test-1, ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.11</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cls: pg-meta, ins: pg-test-2, ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.12</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cls: pg-meta, ins: pg-test-3, ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.13</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>日志</strong></p>
<p>与 PostgreSQL 有关的日志由 promtail 负责收集，并发送至 infra 节点上的 Loki 日志存储/查询服务。</p>
<ul>
<li><a href="/zh/docs/reference/param#pg_log_dir"><code>pg_log_dir</code></a> : postgres日志目录，默认为<code>/pg/log/postgres</code></li>
<li><a href="/zh/docs/reference/param#pgbouncer_log_dir"><code>pgbouncer_log_dir</code></a> : pgbouncer日志目录，默认为<code>/pg/log/pgbouncer</code></li>
<li><a href="/zh/docs/reference/param#patroni_log_dir"><code>patroni_log_dir</code></a> : patroni日志目录，默认为<code>/pg/log/patroni</code></li>
<li><a href="/zh/docs/reference/param#pgbackrest_log_dir"><code>pgbackrest_log_dir</code></a> : pgbackrest日志目录，默认为<code>/pg/log/pgbackrest</code></li>
</ul>
<p><strong>目标管理</strong></p>
<p>Prometheus的监控目标在 <code>/etc/prometheus/targets/pgsql/</code> 下的静态文件中定义，每个实例都有一个相应的文件。以 <code>pg-meta-1</code> 为例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pg-meta-1 [primary] @ 10.10.10.10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cls: pg-meta, ins: pg-meta-1, ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">targets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9630</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># &lt;--- pg_exporter 用于PostgreSQL指标</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9631</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># &lt;--- pg_exporter 用于pgbouncer指标</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">8008</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># &lt;--- patroni指标（未启用 API SSL 时）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>当全局标志 <a href="/zh/docs/reference/param#patroni_ssl_enabled"><code>patroni_ssl_enabled</code></a> 被设置时，patroni目标将被移动到单独的文件 <code>/etc/prometheus/targets/patroni/&lt;ins&gt;.yml</code>。 因为此时使用的是 https 抓取端点。当您<a href="/zh/docs/pgsql/monitor/#监控rds">监控RDS</a>实例时，监控目标会被单独放置于： <code>/etc/prometheus/targets/pgrds/</code> 目录下，并以<strong>集群</strong>为单位进行管理。</p>
<p>当使用 <code>bin/pgsql-rm</code> 或 <code>pgsql-rm.yml</code> 移除集群时，Prometheus监控目标将被移除。您也可以手动移除它，或使用剧本里的子任务：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgmon-rm &lt;cls<span style="color:#000;font-weight:bold">|</span>ins&gt;    <span style="color:#8f5902;font-style:italic"># 从所有infra节点中移除 prometheus 监控目标</span>
</span></span></code></pre></div><p>远程 RDS 监控目标会被放置于 <code>/etc/prometheus/targets/pgrds/&lt;cls&gt;.yml</code>，它们是由 <a href="/zh/docs/pgsql/playbook#pgsql-monitor"><code>pgsql-monitor.yml</code></a> 剧本或 <code>bin/pgmon-add</code> 脚本所创建的。</p>
<hr>
<h2 id="监控模式">监控模式</h2>
<p>Pigsty 提供三种监控模式，以适应不同的监控需求。</p>
<table>
<thead>
<tr>
<th style="text-align:center">事项\等级</th>
<th style="text-align:center">L1</th>
<th style="text-align:center">L2</th>
<th style="text-align:center">L3</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">名称</td>
<td style="text-align:center"><a href="/zh/docs/pgsql/monitor/#监控rds">基础部署</a></td>
<td style="text-align:center"><a href="/zh/docs/pgsql/monitor/#监控现有集群">托管部署</a></td>
<td style="text-align:center"><strong>标准部署</strong></td>
</tr>
<tr>
<td style="text-align:center">英文</td>
<td style="text-align:center"><strong>RDS</strong></td>
<td style="text-align:center"><strong>MANAGED</strong></td>
<td style="text-align:center"><strong>FULL</strong></td>
</tr>
<tr>
<td style="text-align:center">场景</td>
<td style="text-align:center">只有连接串，例如RDS</td>
<td style="text-align:center">DB已存在，节点可管理</td>
<td style="text-align:center">实例由 Pigsty 创建</td>
</tr>
<tr>
<td style="text-align:center">PGCAT功能</td>
<td style="text-align:center">✅ 完整可用</td>
<td style="text-align:center">✅ 完整可用</td>
<td style="text-align:center">✅ 完整可用</td>
</tr>
<tr>
<td style="text-align:center">PGSQL功能</td>
<td style="text-align:center">✅ 限PG指标</td>
<td style="text-align:center">✅ 限PG与节点指标</td>
<td style="text-align:center">✅ 完整功能</td>
</tr>
<tr>
<td style="text-align:center">连接池指标</td>
<td style="text-align:center">❌ 不可用</td>
<td style="text-align:center">⚠️ 选装</td>
<td style="text-align:center">✅ 预装项</td>
</tr>
<tr>
<td style="text-align:center">负载均衡器指标</td>
<td style="text-align:center">❌ 不可用</td>
<td style="text-align:center">⚠️ 选装</td>
<td style="text-align:center">✅ 预装项</td>
</tr>
<tr>
<td style="text-align:center">PGLOG功能</td>
<td style="text-align:center">❌ 不可用</td>
<td style="text-align:center">⚠️ 选装</td>
<td style="text-align:center">✅ 预装项</td>
</tr>
<tr>
<td style="text-align:center">PG Exporter</td>
<td style="text-align:center">⚠️ 部署于Infra节点</td>
<td style="text-align:center">✅ 部署于DB节点</td>
<td style="text-align:center">✅ 部署于DB节点</td>
</tr>
<tr>
<td style="text-align:center">Node Exporter</td>
<td style="text-align:center">❌ 不部署</td>
<td style="text-align:center">✅ 部署于DB节点</td>
<td style="text-align:center">✅ 部署于DB节点</td>
</tr>
<tr>
<td style="text-align:center">侵入DB节点</td>
<td style="text-align:center">✅ 无侵入</td>
<td style="text-align:center">⚠️ 安装Exporter</td>
<td style="text-align:center">⚠️ 完全由Pigsty管理</td>
</tr>
<tr>
<td style="text-align:center">监控现有实例</td>
<td style="text-align:center">✅ 可支持</td>
<td style="text-align:center">✅ 可支持</td>
<td style="text-align:center">❌ 仅用于Pigsty托管实例</td>
</tr>
<tr>
<td style="text-align:center">监控用户与视图</td>
<td style="text-align:center">人工创建</td>
<td style="text-align:center">人工创建</td>
<td style="text-align:center">Pigsty自动创建</td>
</tr>
<tr>
<td style="text-align:center">部署使用剧本</td>
<td style="text-align:center"><code>bin/pgmon-add &lt;cls&gt;</code></td>
<td style="text-align:center">部分执行 <code>pgsql.ym</code>/<code>node.yml</code></td>
<td style="text-align:center"><code>pgsql.yml</code></td>
</tr>
<tr>
<td style="text-align:center">所需权限</td>
<td style="text-align:center">Infra 节点可达的 PGURL</td>
<td style="text-align:center">DB节点ssh与sudo权限</td>
<td style="text-align:center">DB节点ssh与sudo权限</td>
</tr>
<tr>
<td style="text-align:center">功能概述</td>
<td style="text-align:center">PGCAT + PGRDS</td>
<td style="text-align:center">大部分功能</td>
<td style="text-align:center">完整功能</td>
</tr>
</tbody>
</table>
<p>由Pigsty完全管理的数据库会自动纳入监控，并拥有最好的监控支持，通常不需要任何配置。对于现有的 PostgreSQL 集群或者 RDS 服务，如果如果目标DB节点<strong>可以被Pigsty所管理</strong>（ssh可达，sudo可用），那么您可以考虑 <a href="/zh/docs/pgsql/monitor/#监控现有集群">托管部署</a>，实现与 Pigsty 基本类似的监控管理体验。如果您<strong>只能通过PGURL</strong>（数据库连接串）的方式访问目标数据库，例如远程的RDS服务，则可以考虑使用 <a href="/zh/docs/pgsql/monitor/#监控rds">精简模式</a> 监控目标数据库。</p>
<hr>
<h2 id="监控现有集群">监控现有集群</h2>
<p><strong>如果目标DB节点可以被Pigsty所管理</strong>（<code>ssh</code>可达且<code>sudo</code>可用），那么您可以使用 <a href="/zh/docs/pgsql/playbook#pgsqlyml"><code>pgsql.yml</code></a> 剧本中的<code>pg_exporter</code>任务，
使用与标准部署相同的的方式，在目标节点上部署监控组件：PG Exporter。您也可以使用该剧本的 <code>pgbouncer</code>，<code>pgbouncer_exporter</code> 任务在已有实例节点上部署连接池及其监控。此外，您也可以使用 <a href="/zh/docs/node#nodeyml"><code>node.yml</code></a> 中的 <code>node_exporter</code>， <code>haproxy</code>， <code>promtail</code> 部署主机监控，负载均衡，日志收集组件。从而获得与原生Pigsty数据库实例完全一致的使用体验。</p>
<p>现有集群的定义方式与 Pigsty 所管理的集群定义方式完全相同，您只是选择性执行 <code>pgsql.yml</code> 剧本中的部分任务，而不是执行整个剧本。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./node.yml  -l &lt;cls&gt; -t node_repo,node_pkg           <span style="color:#8f5902;font-style:italic"># 在主机节点上添加 INFRA节点的 YUM 源并安装软件包。</span>
</span></span><span style="display:flex;"><span>./node.yml  -l &lt;cls&gt; -t node_exporter,node_register  <span style="color:#8f5902;font-style:italic"># 配置主机监控，并加入 Prometheus</span>
</span></span><span style="display:flex;"><span>./node.yml  -l &lt;cls&gt; -t promtail                     <span style="color:#8f5902;font-style:italic"># 配置主机日志采集，并发送至 Loki</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -l &lt;cls&gt; -t pg_exporter,pg_register      <span style="color:#8f5902;font-style:italic"># 配置 PostgreSQL 监控，并注册至 Prometheus/Grafana</span>
</span></span></code></pre></div><p>因为目标数据库集群已存在，所以您需要手工在目标数据库集群上<a href="/zh/docs/pgsql/monitor/#监控对象配置">创建监控用户、模式与扩展</a>。</p>
<hr>
<h2 id="监控rds">监控RDS</h2>
<p>如果您<strong>只能通过PGURL</strong>（数据库连接串）的方式访问目标数据库，那么可以参照这里的说明进行配置。在这种模式下，Pigsty 在 <a href="/zh/docs/node#infra%E8%8A%82%E7%82%B9">INFRA节点</a> 上部署对应的 PG Exporter，抓取远端数据库指标信息。如下图所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">------</span> <span style="color:#000">infra</span> <span style="color:#ce5c00;font-weight:bold">------</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>                 <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>   <span style="color:#000">prometheus</span>    <span style="color:#ce5c00;font-weight:bold">|</span>            <span style="color:#000">v</span><span style="color:#ce5c00;font-weight:bold">----</span> <span style="color:#000">pg</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">----</span><span style="color:#000">v</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>       <span style="color:#ce5c00;font-weight:bold">^</span>         <span style="color:#ce5c00;font-weight:bold">|</span>  <span style="color:#000">metrics</span>   <span style="color:#ce5c00;font-weight:bold">|</span>         <span style="color:#ce5c00;font-weight:bold">^</span>        <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>   <span style="color:#000">pg_exporter</span> <span style="color:#ce5c00;font-weight:bold">&lt;-|------------|----</span>  <span style="color:#000">postgres</span>    <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">(</span><span style="color:#000">port</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">20001</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">|</span>            <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">10.10</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">5432</span> <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>       <span style="color:#ce5c00;font-weight:bold">^</span>         <span style="color:#ce5c00;font-weight:bold">|</span>            <span style="color:#ce5c00;font-weight:bold">^------------------^</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>       <span style="color:#ce5c00;font-weight:bold">^</span>         <span style="color:#ce5c00;font-weight:bold">|</span>                      <span style="color:#ce5c00;font-weight:bold">^</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>       <span style="color:#ce5c00;font-weight:bold">^</span>         <span style="color:#ce5c00;font-weight:bold">|</span>            <span style="color:#000">v</span><span style="color:#ce5c00;font-weight:bold">----</span> <span style="color:#000">pg</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">----</span><span style="color:#000">v</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>       <span style="color:#ce5c00;font-weight:bold">^</span>         <span style="color:#ce5c00;font-weight:bold">|</span>  <span style="color:#000">metrics</span>   <span style="color:#ce5c00;font-weight:bold">|</span>         <span style="color:#ce5c00;font-weight:bold">^</span>        <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>   <span style="color:#000">pg_exporter</span> <span style="color:#ce5c00;font-weight:bold">&lt;-|------------|----</span>  <span style="color:#000">postgres</span>    <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">(</span><span style="color:#000">port</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">20002</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">|</span>            <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">10.10</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">5433</span> <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">-------------------</span>            <span style="color:#ce5c00;font-weight:bold">^------------------^</span>
</span></span></code></pre></div><p>在这种模式下，监控系统不会有主机，连接池，负载均衡器，高可用组件的相关指标，但数据库本身，以及数据目录（Catalog）中的实时状态信息仍然可用。Pigsty提供了两个专用的监控面板，专注于 PostgreSQL 本身的监控指标： <a href="https://demo.pigsty.cc/d/pgrds-cluster">PGRDS Cluster</a> 与 <a href="https://demo.pigsty.cc/d/pgrds-instance">PGRDS Instance</a>，总览与数据库内监控则复用现有监控面板。因为Pigsty不能管理您的RDS，所以用户需要在目标数据库上提前<a href="/zh/docs/pgsql/monitor/#监控对象配置">配置好监控对象</a>。</p>


<div class="alert alert-secondary" role="alert">
<h4 class="alert-heading">监控外部 Postgres 实例时的局限性</h4>

    <ul>
<li>pgBoucner 连接池指标不可用</li>
<li>Patroni 高可用组件指标不可用</li>
<li>主机节点监控指标不可用，以及节点 HAProxy，Keepalived 指标亦不可用。</li>
<li>日志收集与日志衍生指标不可用</li>
</ul>


</div>

<p>下面我们使用沙箱环境作为示例：现在我们假设 <code>pg-meta</code> 集群是一个有待监控的 RDS 实例 <code>pg-foo-1</code>，而 <code>pg-test</code> 集群则是一个有待监控的RDS集群 <code>pg-bar</code>：</p>
<ol>
<li>
<p>在目标上创建监控模式、用户和权限。详情请参考<a href="/zh/docs/pgsql/monitor/#监控对象配置">监控对象配置</a></p>
</li>
<li>
<p>在配置清单中声明集群。例如，假设我们想要监控“远端”的 <code>pg-meta</code> &amp; <code>pg-test</code> 集群：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">infra</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># 代理、监控、警报等的infra集群..</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">infra_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># 在组&#39;infra&#39;上为远程postgres RDS安装pg_exporter</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_exporters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 在此列出所有远程实例，为k分配一个唯一的未使用的本地端口</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20001</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-foo, pg_seq: 1, pg_host: 10.10.10.10 , pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta }] }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 注册 meta 数据库为 Grafana 数据源</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20002</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-bar, pg_seq: 1, pg_host: 10.10.10.11 , pg_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5432</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 几种不同的连接串拼接方法</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20003</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-bar, pg_seq: 2, pg_host: 10.10.10.12 , pg_exporter_url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;postgres://dbuser_monitor:DBUser.Monitor@10.10.10.12:5432/postgres?sslmode=disable&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20004</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-bar, pg_seq: 3, pg_host: 10.10.10.13 , pg_monitor_username: dbuser_monitor, pg_monitor_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Monitor }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>其中， <code>pg_databases</code> 字段中所列出的数据库，将会被注册至 Grafana 中，成为一个 PostgreSQL 数据源，为 PGCAT 监控面板提供数据支持。如果您不想使用PGCAT，将注册数据库到Grafana中，只需要将 <code>pg_databases</code> 设置为空数组或直接留空即可。</p>
<p><img alt="pigsty-monitor.jpg" src="/img/pigsty/monitor.jpg"></p>
</li>
<li>
<p>执行添加监控命令：<code>bin/pgmon-add &lt;clsname&gt;</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgmon-add pg-foo  <span style="color:#8f5902;font-style:italic"># 将 pg-foo 集群纳入监控</span>
</span></span><span style="display:flex;"><span>bin/pgmon-add pg-bar  <span style="color:#8f5902;font-style:italic"># 将 pg-bar 集群纳入监控</span>
</span></span></code></pre></div></li>
<li>
<p>要删除远程集群的监控目标，可以使用 <code>bin/pgmon-rm &lt;clsname&gt;</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgmon-rm pg-foo  <span style="color:#8f5902;font-style:italic"># 将 pg-foo 从 Pigsty 监控中移除</span>
</span></span><span style="display:flex;"><span>bin/pgmon-rm pg-bar  <span style="color:#8f5902;font-style:italic"># 将 pg-bar 从 Pigsty 监控中移除</span>
</span></span></code></pre></div></li>
</ol>
<p>您可以使用更多的参数来覆盖默认 <code>pg_exporter</code> 的选项，下面是一个使用 Pigsty 监控阿里云 RDS 与 PolarDB 的配置样例：</p>
<details><summary>示例：监控阿里云 RDS for PostgreSQL 与 PolarDB</summary>
<p>详情请参考：<a href="https://github.com/Vonng/pigsty/blob/main/conf/demo/remote.yml">remote.yml</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">infra</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># 代理、监控、警报等的infra集群..</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">infra_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_exporters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 在此列出所有待监控的远程 RDS PG 实例</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20001</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># 分配一个唯一的未使用的本地端口，供本地监控 Agent 使用，这里是一个 PolarDB 的主库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-polar                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># RDS 集群名 （身份参数，手工指定分配监控系统内名称）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">                             </span><span style="color:#8f5902;font-style:italic"># RDS 实例号 （身份参数，手工指定分配监控系统内名称）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pc-2ze379wb1d4irc18x.polardbpg.rds.aliyuncs.com</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># RDS 主机地址</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1921</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#8f5902;font-style:italic"># RDS 端口（从控制台连接信息获取）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_exporter_auto_discovery</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># 禁用新数据库自动发现功能</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_exporter_include_database</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;test&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 仅监控这个列表中的数据库（多个数据库用逗号分隔）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_monitor_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 监控用的用户名，覆盖全局配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_monitor_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser_Monitor  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 监控用的密码，覆盖全局配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test }]       </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 希望启用PGCAT的数据库列表，只要name字段即可，register_datasource设置为false则不注册。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20002</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># 这是一个 PolarDB  从库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-polar                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># RDS 集群名 （身份参数，手工指定分配监控系统内名称）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">                             </span><span style="color:#8f5902;font-style:italic"># RDS 实例号 （身份参数，手工指定分配监控系统内名称）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pe-2ze7tg620e317ufj4.polarpgmxs.rds.aliyuncs.com</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># RDS 主机地址</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1521</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#8f5902;font-style:italic"># RDS 端口（从控制台连接信息获取）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_exporter_auto_discovery</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># 禁用新数据库自动发现功能</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_exporter_include_database</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;test,postgres&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 仅监控这个列表中的数据库（多个数据库用逗号分隔）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_monitor_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 监控用的用户名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_monitor_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser_Monitor  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 监控用的密码</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test } ]       </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 希望启用PGCAT的数据库列表，只要name字段即可，register_datasource设置为false则不注册。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20004</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 这是一个基础版的单节点 RDS for PostgreSQL 实例</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-rds                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># RDS 集群名 （身份参数，手工指定分配监控系统内名称）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">                             </span><span style="color:#8f5902;font-style:italic"># RDS 实例号 （身份参数，手工指定分配监控系统内名称）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgm-2zern3d323fe9ewk.pg.rds.aliyuncs.com </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># RDS 主机地址</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5432</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#8f5902;font-style:italic"># RDS 端口（从控制台连接信息获取）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_exporter_auto_discovery</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># 禁用新数据库自动发现功能</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_exporter_include_database</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;rds&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 仅监控这个列表中的数据库（多个数据库用逗号分隔）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_monitor_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 监控用的用户名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_monitor_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser_Monitor  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 监控用的密码</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rds } ]      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 希望启用PGCAT的数据库列表，只要name字段即可，register_datasource设置为false则不注册。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20005</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 这是一个高可用版的 RDS for PostgreSQL 集群主库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-rdsha                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># RDS 集群名 （身份参数，手工指定分配监控系统内名称）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">                             </span><span style="color:#8f5902;font-style:italic"># RDS 实例号 （身份参数，手工指定分配监控系统内名称）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgm-2ze3d35d27bq08wu.pg.rds.aliyuncs.com </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># RDS 主机地址</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5432</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#8f5902;font-style:italic"># RDS 端口（从控制台连接信息获取）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_exporter_include_database</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;rds&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 仅监控这个列表中的数据库（多个数据库用逗号分隔）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rds }, {name : test} ] </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 将这两个数据库纳入 PGCAT 管理，注册为 Grafana 数据源</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20006</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 这是一个高可用版的 RDS for PostgreSQL 集群只读实例（从库）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-rdsha                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># RDS 集群名 （身份参数，手工指定分配监控系统内名称）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">                             </span><span style="color:#8f5902;font-style:italic"># RDS 实例号 （身份参数，手工指定分配监控系统内名称）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgr-2zexqxalk7d37edt.pg.rds.aliyuncs.com </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># RDS 主机地址</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5432</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#8f5902;font-style:italic"># RDS 端口（从控制台连接信息获取）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_exporter_include_database</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;rds&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 仅监控这个列表中的数据库（多个数据库用逗号分隔）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rds }, {name : test} ] </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 将这两个数据库纳入 PGCAT 管理，注册为 Grafana 数据源</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></details>
<hr>
<h2 id="监控对象配置">监控对象配置</h2>
<p>当您想要监控现有实例时，不论是 RDS，还是自建的 PostgreSQL 实例，您都需要在目标数据库上进行一些配置，以便 Pigsty 可以访问它们。</p>
<p>为了将外部现存PostgreSQL实例纳入监控，您需要有一个可用于访问该实例/集群的连接串。任何可达连接串（业务用户，超级用户）均可使用，但我们建议使用一个专用监控用户以避免权限泄漏。</p>
<ul>
<li><input disabled="" type="checkbox"> <a href="/zh/docs/pgsql/monitor/#监控用户">监控用户</a>：默认使用的用户名为 <code>dbuser_monitor</code>， 该用户属于 <code>pg_monitor</code> 角色组，或确保具有相关视图访问权限。</li>
<li><input disabled="" type="checkbox"> <a href="/zh/docs/pgsql/monitor/#监控认证">监控认证</a>：默认使用密码访问，您需要确保HBA策略允许监控用户从管理机或DB节点本地访问数据库。</li>
<li><input disabled="" type="checkbox"> <a href="/zh/docs/pgsql/monitor/#监控模式">监控模式</a>：固定使用名称 <code>monitor</code>，用于安装额外的<strong>监控视图</strong>与扩展插件，非必选，但建议创建。</li>
<li><input disabled="" type="checkbox"> <a href="/zh/docs/pgsql/monitor/#监控扩展">监控扩展</a>：<strong>强烈建议</strong>启用PG自带的监控扩展 <code>pg_stat_statements</code>。</li>
<li><input disabled="" type="checkbox"> <a href="/zh/docs/pgsql/monitor/#监控视图">监控视图</a>：监控视图是可选项，可以提供更多的监控指标支持。</li>
</ul>
<h3 id="监控用户">监控用户</h3>
<p>以Pigsty默认使用的监控用户<code>dbuser_monitor</code>为例，在目标数据库集群创建以下用户。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic">-- 创建监控用户
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;system monitor user&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic">-- 监控用户备注
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#8f5902;font-style:italic">-- 授予监控用户 pg_monitor 权限，否则一些指标将无法采集
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;DBUser.Monitor&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic">-- 按需修改监控用户密码（强烈建议修改！但请与Pigsty配置一致）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">log_min_duration_statement</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- 建议设置此参数，避免日志塞满监控慢查询
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">search_path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic">-- 建议设置此参数，避免 pg_stat_statements 扩展无法生效
</span></span></span></code></pre></div><p>请注意，这里创建的监控用户与密码需要与 <a href="/zh/docs/reference/param#pg_monitor_username"><code>pg_monitor_username</code></a> 与 <a href="/zh/docs/reference/param#pg_monitor_password"><code>pg_monitor_password</code></a> 保持一致。</p>
<hr>
<h3 id="监控认证">监控认证</h3>
<p>配置数据库 <code>pg_hba.conf</code> 文件，添加以下规则以允许监控用户从本地，以及管理机使用密码访问所有数据库。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allow local role monitor with password</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">local   all  dbuser_monitor                    md5</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host    all  dbuser_monitor  127.0.0.1/32      md5</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host    all  dbuser_monitor  &lt;管理机器IP地址&gt;/32 md5</span>
</span></span></code></pre></div><p>如果您的 RDS 不支持定义 HBA，那么把安装 Pigsty 机器的内网 IP 地址开白即可。</p>
<hr>
<h3 id="监控模式-1">监控模式</h3>
<p>监控模式<strong>可选项</strong>，即使没有，Pigsty监控系统的主体也可以正常工作，但我们强烈建议设置此模式。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SCHEMA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic">-- 创建监控专用模式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SCHEMA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- 允许监控用户使用
</span></span></span></code></pre></div><hr>
<h3 id="监控扩展">监控扩展</h3>
<p>监控扩展是可选项，但我们强烈建议启用 <code>pg_stat_statements</code> 扩展该扩展提供了关于查询性能的重要数据。</p>
<p>注意：该扩展必须列入数据库参数 <code>shared_preload_libraries</code> 中方可生效，而修改该参数需要重启数据库。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;pg_stat_statements&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SCHEMA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;monitor&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>请注意，您应当在默认的管理数据库 <code>postgres</code> 中安装此扩展。有些时候，RDS不允许您在 <code>postgres</code> 数据库中创建监控模式，
在这种情况下，您可以将 <code>pg_stat_statements</code> 插件安装到默认的 <code>public</code> 下，只要确保监控用户的 search_path 按照上面的配置，能够找到 <code>pg_stat_statements</code> 视图即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;pg_stat_statements&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">search_path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 建议设置此参数，避免 pg_stat_statements 扩展无法生效
</span></span></span></code></pre></div><hr>
<h3 id="监控视图">监控视图</h3>
<p>监控视图提供了若干常用的预处理结果，并对某些需要高权限的监控指标进行权限封装（例如共享内存分配），便于查询与使用。强烈建议在所有需要监控的数据库中创建</p>
<details><summary>监控模式与监控视图定义</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- Table bloat estimate : monitor.pg_table_bloat
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CURRENT_CATALOG</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bs</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">est_tblpages_ff</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tblpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">est_tblpages_ff</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">tblpages</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ceil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">reltuples</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bs</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">page_hdr</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">fillfactor</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tpl_size</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ceil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toasttuples</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">est_tblpages_ff</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#000">tblpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fillfactor</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bs</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">is_na</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tpl_hdr_size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tpl_data_size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tpl_hdr_size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tpl_hdr_size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ceil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tpl_data_size</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">INT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ceil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tpl_data_size</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">INT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tpl_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">heappages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toastpages</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">heappages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#000">toastpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toasttuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bs</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">page_hdr</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fillfactor</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">is_na</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ns</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">heappages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">toast</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toastpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">toast</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toasttuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">array_to_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reloptions</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39; &#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;fillfactor=([0-9]+)&#39;</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">smallint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fillfactor</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#000">current_setting</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;block_size&#39;</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">numeric</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bs</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#4e9a06">&#39;mingw32&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#4e9a06">&#39;64-bit|x86_64|ppc64|ia64|amd64&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">page_hdr</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#0000cf;font-weight:bold">23</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">MAX</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">null_frac</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">int</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                   </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bool_or</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">att</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;oid&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">att</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attnum</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tpl_hdr_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">null_frac</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">avg_width</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tpl_data_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#000">bool_or</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">att</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">atttypid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pg_catalog.name&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">regtype</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                   </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">att</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attnum</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">is_na</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_attribute</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">att</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">att</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_namespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ns</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ns</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#204a87;font-weight:bold">LEFT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schemaname</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">ns</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">inherited</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">att</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#204a87;font-weight:bold">LEFT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">toast</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltoastrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">toast</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">att</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attisdropped</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relkind</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;r&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pg_catalog&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;information_schema&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">is_na</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;postgres table bloat estimate&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- Index bloat estimate : monitor.pg_index_bloat
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CURRENT_CATALOG</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idxname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idxid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">BIGINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bs</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">COALESCE</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">relpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">reltuples</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_tuple_hdr</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_tuple_hdr</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                               </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nulldatawidth</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nulldatawidth</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nulldatawidth</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bs</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pagehdr</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">idxname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">indrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idxid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#000">current_setting</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;block_size&#39;</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline">                                                               </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bs</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;mingw32&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;64-bit|x86_64|ppc64|ia64|amd64&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#f8f8f8;text-decoration:underline">                                                                                                   </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pagehdr</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">COALESCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">null_frac</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_tuple_hdr</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">COALESCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">null_frac</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">COALESCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">avg_width</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">))::</span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline">                                                     </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nulldatawidth</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_attribute</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_namespace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">ic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline">                                                   </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idxname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">ic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">ic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indrelid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">tc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline">                                                   </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">regexp_split_to_table</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indkey</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39; &#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">attnum</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline">                                          </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_index</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ic</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tc</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_namespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_namespace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_am</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relam</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_am</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_am</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">amname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;btree&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pg_catalog&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;information_schema&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attnum</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attnum</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schemaname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_get_indexdef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attrelid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attnum</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">idxname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attnum</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">est</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;postgres index bloat estimate (btree-only)&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- Relation Bloat : monitor.pg_bloat
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                                                   </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                                                   </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                                                       </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">RegClass</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#f8f8f8;text-decoration:underline">                                                                            </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratio</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_ratio</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratio</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">NUMERIC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">BIGINT</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">idxid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline">                                                    </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idxname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#f8f8f8;text-decoration:underline">                                                                            </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratio</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_ratio</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratio</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">NUMERIC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">BIGINT</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_wasted</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ib</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">FULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OUTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tblid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;postgres relation bloat detail&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- monitor.pg_index_bloat_human
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat_human</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat_human</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idxname</span><span style="color:#f8f8f8;text-decoration:underline">                            </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">tblname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">idx_wasted</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx_size</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_ratio</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_ratio</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx_wasted</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl_size</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_ratio</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_ratio</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl_wasted</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_wasted</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_bloat</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idxname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat_human</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;postgres index bloat info in human-readable format&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat_human</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- monitor.pg_table_bloat_human
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat_human</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat_human</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblname</span><span style="color:#f8f8f8;text-decoration:underline">                                          </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">idx_wasted</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_wasted</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx_wasted</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_wasted</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">all_wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl_wasted</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl_size</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">tbl_ratio</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx_wasted</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx_size</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx_wasted</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">NUMERIC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_ratio</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">tblname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl_wasted</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl_size</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl_ratio</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_ratio</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx_wasted</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx_size</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_size</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_bloat</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat_human</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;postgres table bloat info in human-readable format&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat_human</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- Activity Overview: monitor.pg_session
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_session</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_session</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbackends</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">active</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idle</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ixact</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_duration</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_tx_duration</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_conn_duration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                                         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbackends</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FILTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">state</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;active&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">active</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FILTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">state</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;idle&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idle</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FILTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">state</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;idle in transaction&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">state</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;idle in transaction (aborted)&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ixact</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">extract</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">epoch</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">state_change</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#000">FILTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">state</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;active&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_duration</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">extract</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">epoch</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">xact_start</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_tx_duration</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">extract</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">epoch</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">backend_start</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_conn_duration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stat_activity</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">backend_type</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;client backend&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_backend_pid</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROLLUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NULLS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FIRST</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_session</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;postgres activity group by session&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_session</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- Sequential Scan: monitor.pg_seq_scan
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_seq_scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_seq_scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">schemaname</span><span style="color:#f8f8f8;text-decoration:underline">                                                        </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">seq_scan</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">seq_tup_read</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">seq_tup_read</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">seq_scan</span><span style="color:#f8f8f8;text-decoration:underline">                                           </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">seq_tup_avg</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">idx_scan</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">n_live_tup</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n_dead_tup</span><span style="color:#f8f8f8;text-decoration:underline">                                           </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n_live_tup</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">NUMERIC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n_live_tup</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n_dead_tup</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">live_ratio</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stat_user_tables</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">seq_scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n_live_tup</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n_dead_tup</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">seq_scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_seq_scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;table that have seq scan&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_seq_scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></details>
<details><summary>查看共享内存分配的函数（PG13以上可用）</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_shmem</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_shmem</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SETOF</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">pg_shmem_allocations</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_shmem_allocations</span><span style="color:#000;font-weight:bold">;</span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SQL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SECURITY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFINER</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_shmem</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;security wrapper for system view pg_shmem&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">REVOKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_shmem</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PUBLIC</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXECUTE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_shmem</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></details>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0ce334f57e9d6869b53659cc6bab754e">15 - 监控面板</h1>
    <div class="lead">Pigsty 为 PostgreSQL 提供了诸多开箱即用的 Grafana 监控仪表盘</div>
	<blockquote>
<p>Pigsty 为 PostgreSQL 提供了诸多开箱即用的 Grafana 监控仪表盘： <a href="https://demo.pigsty.cc/d/pgsql-overview">Demo</a> &amp; <a href="https://github.com/Vonng/pigsty/wiki/Gallery">Gallery</a>。</p>
</blockquote>
<p>在 Pigsty 中共有 26 个与 PostgreSQL 相关的监控面板，按照层次分为 总览，集群，实例，数据库四大类，按照数据来源又分为 <a href="/zh/docs/pgsql/dashboard/#总览">PGSQL</a>，<a href="/zh/docs/pgsql/dashboard/#pgcat">PGCAT</a>，<a href="/zh/docs/pgsql/dashboard/#pglog">PGLOG</a> 三大类。</p>
<p><img alt="pigsty-dashboard.jpg" src="/img/pigsty/dashboard.jpg"></p>
<hr>
<h2 id="总览">总览</h2>
<table>
<thead>
<tr>
<th style="text-align:center">总览</th>
<th style="text-align:center">集群</th>
<th style="text-align:center">实例</th>
<th style="text-align:center">数据库</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-overview">PGSQL Overview</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-cluster">PGSQL Cluster</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-instance">PGSQL Instance</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-database">PGSQL Database</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-alert">PGSQL Alert</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgrds-cluster">PGRDS Cluster</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgrds-instance">PGRDS Instance</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-database">PGCAT Database</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-shard">PGSQL Shard</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-activity">PGSQL Activity</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-instance">PGCAT Instance</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-tables">PGSQL Tables</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-replication">PGSQL Replication</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-persist">PGSQL Persist</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-table">PGSQL Table</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-service">PGSQL Service</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-proxy">PGSQL Proxy</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-table">PGCAT Table</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-databases">PGSQL Databases</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-pgbouncer">PGSQL Pgbouncer</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-query">PGSQL Query</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-patroni">PGSQL Patroni</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-session">PGSQL Session</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-query">PGCAT Query</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-pitr">PGSQL PITR</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-xacts">PGSQL Xacts</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-locks">PGCAT Locks</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-exporter">PGSQL Exporter</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-schema">PGCAT Schema</a></td>
</tr>
</tbody>
</table>
<p><strong>概览</strong></p>
<ul>
<li><a href="https://demo.pigsty.cc/d/pgsql-overview">pgsql-overview</a> : PGSQL模块的主仪表板</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-alert">pgsql-alert</a> : PGSQL的全局关键指标和警报事件</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-shard">pgsql-shard</a> : 关于水平分片的PGSQL集群的概览，例如 citus / gpsql 集群</li>
</ul>
<p><strong>集群</strong></p>
<ul>
<li><a href="https://demo.pigsty.cc/d/pgsql-cluster">pgsql-cluster</a>: 一个PGSQL集群的主仪表板</li>
<li><a href="https://demo.pigsty.cc/d/pgrds-cluster">pgrds-cluster</a>: PGSQL Cluster 的RDS版本，专注于所有 PostgreSQL 本身的指标</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-activity">pgsql-activity</a>: 关注PGSQL集群的会话/负载/QPS/TPS/锁定情况</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-replication">pgsql-replication</a>: 关注PGSQL集群复制、插槽和发布/订阅</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-service">pgsql-service</a>: 关注PGSQL集群服务、代理、路由和负载均衡</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-databases">pgsql-databases</a>: 关注所有实例的数据库CRUD、慢查询和表统计信息</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-patroni">pgsql-patroni</a>: 关注集群高可用状态，Patroni组件状态</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-pitr">pgsql-pitr</a>: 关注集群 PITR 过程的上下文，用于辅助时间点恢复</li>
</ul>
<p><strong>实例</strong></p>
<ul>
<li><a href="https://demo.pigsty.cc/d/pgsql-instance">pgsql-instance</a>: 单个PGSQL实例的主仪表板</li>
<li><a href="https://demo.pigsty.cc/d/pgrds-instance">pgrds-instance</a>: PGSQL Instance 的RDS版本，专注于所有 PostgreSQL 本身的指标</li>
<li><a href="https://demo.pigsty.cc/d/pgcat-instance">pgcat-instance</a>: 直接从数据库目录获取的实例信息</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-proxy">pgsql-proxy</a>: 单个haproxy负载均衡器的详细指标</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-pgbouncer">pgsql-pgbouncer</a>: 单个Pgbouncer连接池实例中的指标总览</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-persist">pgsql-persist</a>: 持久性指标：WAL、XID、检查点、存档、IO</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-session">pgsql-session</a>: 单个实例中的会话和活动/空闲时间的指标</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-xacts">pgsql-xacts</a>: 关于事务、锁、TPS/QPS相关的指标</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-exporter">pgsql-exporter</a>: Postgres 与 Pgbouncer 监控组件自我监控指标</li>
</ul>
<p><strong>数据库</strong></p>
<ul>
<li><a href="https://demo.pigsty.cc/d/pgsql-database">pgsql-database</a>: 单个PGSQL数据库的主仪表板</li>
<li><a href="https://demo.pigsty.cc/d/pgcat-database">pgcat-database</a>: 直接从数据库目录获取的数据库信息</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-tables">pgsql-tables</a> : 单个数据库内的表/索引访问指标</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-table">pgsql-table</a>: 单个表的详细信息（QPS/RT/索引/序列&hellip;）</li>
<li><a href="https://demo.pigsty.cc/d/pgcat-table">pgcat-table</a>: 直接从数据库目录获取的单个表的详细信息（统计/膨胀&hellip;）</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-query">pgsql-query</a>: 单个查询的详细信息（QPS/RT）</li>
<li><a href="https://demo.pigsty.cc/d/pgcat-query">pgcat-query</a>: 直接从数据库目录获取的单个查询的详细信息（SQL/统计）</li>
<li><a href="https://demo.pigsty.cc/d/pgcat-schema">pgcat-schema</a>: 直接从数据库目录获取关于模式的信息（表/索引/序列&hellip;）</li>
<li><a href="https://demo.pigsty.cc/d/pgcat-locks">pgcat-locks</a>: 直接从数据库目录获取的关于活动与锁等待的信息</li>
</ul>
<hr>
<h2 id="总览-1">总览</h2>
<p><a href="https://demo.pigsty.cc/d/pgsql-overview">PGSQL Overview</a>：PGSQL模块的主仪表板</p>
<details><summary>PGSQL Overview</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-overview"><img alt="pgsql-overview.jpg" src="/img/dashboard/pgsql-overview.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-alert">PGSQL Alert</a>：PGSQL 全局核心指标总览与告警事件一览</p>
<details><summary>PGSQL Alert</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-alert"><img alt="pgsql-alert.jpg" src="/img/dashboard/pgsql-alert.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-shard">PGSQL Shard</a>：展示一个PGSQL 水平分片集群内的横向指标对比：例如 CITUS / GPSQL 集群。</p>
<details><summary>PGSQL Shard</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-shard"><img alt="pgsql-shard.jpg" src="/img/dashboard/pgsql-shard.jpg"></a></p>
</details>
<hr>
<h2 id="集群">集群</h2>
<p><a href="https://demo.pigsty.cc/d/pgsql-cluster">PGSQL Cluster</a>：一个PGSQL集群的主仪表板</p>
<details><summary>PGSQL Cluster</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-cluster"><img alt="pgsql-cluster.jpg" src="/img/dashboard/pgsql-cluster.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgrds-cluster">PGRDS Cluster</a>：PGSQL Cluster 的RDS版本，专注于所有 PostgreSQL 本身的指标</p>
<details><summary>PGRDS Cluster</summary>
<p><a href="https://demo.pigsty.cc/d/pgrds-cluster"><img alt="pgrds-cluster.jpg" src="/img/dashboard/pgrds-cluster.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-service">PGSQL Service</a>：关注PGSQL集群服务、代理、路由和负载均衡。</p>
<details><summary>PGSQL Service</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-service"><img alt="pgsql-service.jpg" src="/img/dashboard/pgsql-service.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-activity">PGSQL Activity</a>：关注PGSQL集群的会话/负载/QPS/TPS/锁定情况</p>
<details><summary>PGSQL Activity</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-activity"><img alt="pgsql-activity.jpg" src="/img/dashboard/pgsql-activity.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-replication">PGSQL Replication</a>：关注PGSQL集群复制、插槽和发布/订阅。</p>
<details><summary>PGSQL Replication</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-replication"><img alt="pgsql-replication.jpg" src="/img/dashboard/pgsql-replication.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-databases">PGSQL Databases</a>：关注所有实例的数据库CRUD、慢查询和表统计信息。</p>
<details><summary>PGSQL Databases</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-databases"><img alt="pgsql-databases.jpg" src="/img/dashboard/pgsql-databases.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-patroni">PGSQL Patroni</a>：关注集群高可用状态，Patroni组件状态</p>
<details><summary>PGSQL Patroni</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-patroni"><img alt="pgsql-patroni.jpg" src="/img/dashboard/pgsql-patroni.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-pitr">PGSQL PITR</a>：关注集群 PITR 过程的上下文，用于辅助时间点恢复</p>
<details><summary>PGSQL PITR</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-pitr"><img alt="pgsql-patroni.jpg" src="/img/dashboard/pgsql-pitr.jpg"></a></p>
</details>
<hr>
<h2 id="实例">实例</h2>
<p><a href="https://demo.pigsty.cc/d/pgsql-instance">PGSQL Instance</a>：单个PGSQL实例的主仪表板</p>
<details><summary>PGSQL Instance</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-instance"><img alt="pgsql-instance.jpg" src="/img/dashboard/pgsql-instance.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgrds-instance">PGRDS Instance</a>：PGSQL Instance 的RDS版本，专注于所有 PostgreSQL 本身的指标</p>
<details><summary>PGRDS Instance</summary>
<p><a href="https://demo.pigsty.cc/d/pgrds-instance"><img alt="pgrds-instance.jpg" src="/img/dashboard/pgrds-instance.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-proxy">PGSQL Proxy</a>：单个haproxy负载均衡器的详细指标</p>
<details><summary>PGSQL Proxy</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-proxy"><img alt="pgsql-proxy.jpg" src="/img/dashboard/pgsql-proxy.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-pgbouncer">PGSQL Pgbouncer</a>：单个Pgbouncer连接池实例中的指标总览</p>
<details><summary>PGSQL Pgbouncer</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-pgbouncer"><img alt="pgsql-pgbouncer.jpg" src="/img/dashboard/pgsql-pgbouncer.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-persist">PGSQL Persist</a>：持久性指标：WAL、XID、检查点、存档、IO</p>
<details><summary>PGSQL Persist</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-persist"><img alt="pgsql-persist.jpg" src="/img/dashboard/pgsql-persist.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-xacts">PGSQL Xacts</a>：关于事务、锁、TPS/QPS相关的指标</p>
<details><summary>PGSQL Xacts</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-xacts"><img alt="pgsql-xacts.jpg" src="/img/dashboard/pgsql-xacts.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-session">PGSQL Session</a>：单个实例中的会话和活动/空闲时间的指标</p>
<details><summary>PGSQL Session</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-session"><img alt="pgsql-session.jpg" src="/img/dashboard/pgsql-session.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-exporter">PGSQL Exporter</a>：Postgres/Pgbouncer 监控组件自我监控指标</p>
<details><summary>PGSQL Exporter</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-exporter"><img alt="pgsql-exporter.jpg" src="/img/dashboard/pgsql-exporter.jpg"></a></p>
</details>
<hr>
<h2 id="数据库">数据库</h2>
<p><a href="https://demo.pigsty.cc/d/pgsql-database">PGSQL Database</a>：单个PGSQL数据库的主仪表板</p>
<details><summary>PGSQL Database</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-database"><img alt="pgsql-database.jpg" src="/img/dashboard/pgsql-database.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-tables">PGSQL Tables</a>：单个数据库内的表/索引访问指标</p>
<details><summary>PGSQL Tables</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-tables"><img alt="pgsql-tables.jpg" src="/img/dashboard/pgsql-tables.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-table">PGSQL Table</a>：单个表的详细信息（QPS/RT/索引/序列&hellip;）</p>
<details><summary>PGSQL Table</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-table"><img alt="pgsql-table.jpg" src="/img/dashboard/pgsql-table.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-query">PGSQL Query</a>：单类查询的详细信息（QPS/RT）</p>
<details><summary>PGSQL Query</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-query"><img alt="pgsql-query.jpg" src="/img/dashboard/pgsql-query.jpg"></a></p>
</details>
<hr>
<h2 id="pgcat">PGCAT</h2>
<p><a href="https://demo.pigsty.cc/d/pgcat-instance">PGCAT Instance</a>：直接从数据库目录获取的实例信息</p>
<details><summary>PGCAT Instance</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-instance"><img alt="pgcat-instance.jpg" src="/img/dashboard/pgcat-instance.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgcat-database">PGCAT Database</a>：直接从数据库目录获取的数据库信息</p>
<details><summary>PGCAT Database</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-database"><img alt="pgcat-database.jpg" src="/img/dashboard/pgcat-database.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgcat-schema">PGCAT Schema</a>：直接从数据库目录获取关于模式的信息（表/索引/序列&hellip;）</p>
<details><summary>PGCAT Schema</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-schema"><img alt="pgcat-schema.jpg" src="/img/dashboard/pgcat-schema.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgcat-table">PGCAT Table</a>：直接从数据库目录获取的单个表的详细信息（统计/膨胀&hellip;）</p>
<details><summary>PGCAT Table</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-table"><img alt="pgcat-table.jpg" src="/img/dashboard/pgcat-table.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgcat-query">PGCAT Query</a>：直接从数据库目录获取的单类查询的详细信息（SQL/统计）</p>
<details><summary>PGCAT Query</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-query"><img alt="pgcat-query.jpg" src="/img/dashboard/pgcat-query.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgcat-locks">PGCAT Locks</a>：直接从数据库目录获取的关于活动与锁等待的信息</p>
<details><summary>PGCAT Locks</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-locks"><img alt="pgcat-locks.jpg" src="/img/dashboard/pgcat-locks.jpg"></a></p>
</details>
<hr>
<h2 id="pglog">PGLOG</h2>
<p><a href="https://demo.pigsty.cc/d/pglog-overview">PGLOG Overview</a>：总览 Pigsty CMDB 中的CSV日志样本</p>
<details><summary>PGLOG Overview</summary>
<p><a href="https://demo.pigsty.cc/d/pglog-overview"><img alt="pglog-overview.jpg" src="/img/dashboard/pglog-overview.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pglog-overview">PGLOG Overview</a>：Pigsty CMDB 中的CSV日志样本中某一条会话的日志详情</p>
<details><summary>PGLOG Session</summary>
<p><a href="https://demo.pigsty.cc/d/pglog-session"><img alt="pglog-session.jpg" src="/img/dashboard/pglog-session.jpg"></a></p>
</details>
<hr>
<h2 id="画廊">画廊</h2>
<p>详情请参考 <a href="https://github.com/Vonng/pigsty/wiki/Gallery">pigsty/wiki/gallery</a>。</p>
<details><summary>PGSQL Overview</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-overview"><img alt="pgsql-overview.jpg" src="/img/dashboard/pgsql-overview.jpg"></a></p>
</details>
<details><summary>PGSQL Shard</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-shard"><img alt="pgsql-shard.jpg" src="/img/dashboard/pgsql-shard.jpg"></a></p>
</details>
<details><summary>PGSQL Cluster</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-cluster"><img alt="pgsql-cluster.jpg" src="/img/dashboard/pgsql-cluster.jpg"></a></p>
</details>
<details><summary>PGSQL Service</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-service"><img alt="pgsql-service.jpg" src="/img/dashboard/pgsql-service.jpg"></a></p>
</details>
<details><summary>PGSQL Activity</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-activity"><img alt="pgsql-activity.jpg" src="/img/dashboard/pgsql-activity.jpg"></a></p>
</details>
<details><summary>PGSQL Replication</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-replication"><img alt="pgsql-replication.jpg" src="/img/dashboard/pgsql-replication.jpg"></a></p>
</details>
<details><summary>PGSQL Databases</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-databases"><img alt="pgsql-databases.jpg" src="/img/dashboard/pgsql-databases.jpg"></a></p>
</details>
<details><summary>PGSQL Instance</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-instance"><img alt="pgsql-instance.jpg" src="/img/dashboard/pgsql-instance.jpg"></a></p>
</details>
<details><summary>PGSQL Proxy</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-proxy"><img alt="pgsql-proxy.jpg" src="/img/dashboard/pgsql-proxy.jpg"></a></p>
</details>
<details><summary>PGSQL Pgbouncer</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-pgbouncer"><img alt="pgsql-pgbouncer.jpg" src="/img/dashboard/pgsql-pgbouncer.jpg"></a></p>
</details>
<details><summary>PGSQL Session</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-session"><img alt="pgsql-session.jpg" src="/img/dashboard/pgsql-session.jpg"></a></p>
</details>
<details><summary>PGSQL Xacts</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-xacts"><img alt="pgsql-xacts.jpg" src="/img/dashboard/pgsql-xacts.jpg"></a></p>
</details>
<details><summary>PGSQL Persist</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-persist"><img alt="pgsql-persist.jpg" src="/img/dashboard/pgsql-persist.jpg"></a></p>
</details>
<details><summary>PGSQL Database</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-database"><img alt="pgsql-database.jpg" src="/img/dashboard/pgsql-database.jpg"></a></p>
</details>
<details><summary>PGSQL Tables</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-tables"><img alt="pgsql-tables.jpg" src="/img/dashboard/pgsql-tables.jpg"></a></p>
</details>
<details><summary>PGSQL Table</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-table"><img alt="pgsql-table.jpg" src="/img/dashboard/pgsql-table.jpg"></a></p>
</details>
<details><summary>PGSQL Query</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-query"><img alt="pgsql-query.jpg" src="/img/dashboard/pgsql-query.jpg"></a></p>
</details>
<details><summary>PGCAT Instance</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-instance"><img alt="pgcat-instance.jpg" src="/img/dashboard/pgcat-instance.jpg"></a></p>
</details>
<details><summary>PGCAT Database</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-database"><img alt="pgcat-database.jpg" src="/img/dashboard/pgcat-database.jpg"></a></p>
</details>
<details><summary>PGCAT Schema</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-schema"><img alt="pgcat-schema.jpg" src="/img/dashboard/pgcat-schema.jpg"></a></p>
</details>
<details><summary>PGCAT Table</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-table"><img alt="pgcat-table.jpg" src="/img/dashboard/pgcat-table.jpg"></a></p>
</details>
<details><summary>PGCAT Lock</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-locks"><img alt="pgcat-locks.jpg" src="/img/dashboard/pgcat-locks.jpg"></a></p>
</details>
<details><summary>PGCAT Query</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-query"><img alt="pgcat-query.jpg" src="/img/dashboard/pgcat-query.jpg"></a></p>
</details>
<details><summary>PGLOG Overview</summary>
<p><a href="https://demo.pigsty.cc/d/pglog-overview"><img alt="pglog-overview.jpg" src="/img/dashboard/pglog-overview.jpg"></a></p>
</details>
<details><summary>PGLOG Session</summary>
<p><a href="https://demo.pigsty.cc/d/pglog-session"><img alt="pglog-session.jpg" src="/img/dashboard/pglog-session.jpg"></a></p>
</details>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1f69b3f46163cb973f38581bf88a88a8">16 - 指标列表</h1>
    <div class="lead">Pigsty PGSQL 模块提供的完整监控指标列表与释义</div>
	<p><a href="/zh/docs/pgsql"><strong><code>PGSQL</code></strong></a> 模块包含有 638 类可用监控指标。</p>
<table>
<thead>
<tr>
<th>Metric Name</th>
<th>Type</th>
<th>Labels</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ALERTS</td>
<td>Unknown</td>
<td><code>category</code>, <code>job</code>, <code>level</code>, <code>ins</code>, <code>severity</code>, <code>ip</code>, <code>alertname</code>, <code>alertstate</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>ALERTS_FOR_STATE</td>
<td>Unknown</td>
<td><code>category</code>, <code>job</code>, <code>level</code>, <code>ins</code>, <code>severity</code>, <code>ip</code>, <code>alertname</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>cls:pressure1</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>cls:pressure15</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>cls:pressure5</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>go_gc_duration_seconds</td>
<td>summary</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>quantile</code>, <code>cls</code></td>
<td>A summary of the pause duration of garbage collection cycles.</td>
</tr>
<tr>
<td>go_gc_duration_seconds_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>go_gc_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>go_goroutines</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of goroutines that currently exist.</td>
</tr>
<tr>
<td>go_info</td>
<td>gauge</td>
<td><code>version</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Information about the Go environment.</td>
</tr>
<tr>
<td>go_memstats_alloc_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes allocated and still in use.</td>
</tr>
<tr>
<td>go_memstats_alloc_bytes_total</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of bytes allocated, even if freed.</td>
</tr>
<tr>
<td>go_memstats_buck_hash_sys_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes used by the profiling bucket hash table.</td>
</tr>
<tr>
<td>go_memstats_frees_total</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of frees.</td>
</tr>
<tr>
<td>go_memstats_gc_sys_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes used for garbage collection system metadata.</td>
</tr>
<tr>
<td>go_memstats_heap_alloc_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of heap bytes allocated and still in use.</td>
</tr>
<tr>
<td>go_memstats_heap_idle_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of heap bytes waiting to be used.</td>
</tr>
<tr>
<td>go_memstats_heap_inuse_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of heap bytes that are in use.</td>
</tr>
<tr>
<td>go_memstats_heap_objects</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of allocated objects.</td>
</tr>
<tr>
<td>go_memstats_heap_released_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of heap bytes released to OS.</td>
</tr>
<tr>
<td>go_memstats_heap_sys_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of heap bytes obtained from system.</td>
</tr>
<tr>
<td>go_memstats_last_gc_time_seconds</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of seconds since 1970 of last garbage collection.</td>
</tr>
<tr>
<td>go_memstats_lookups_total</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of pointer lookups.</td>
</tr>
<tr>
<td>go_memstats_mallocs_total</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of mallocs.</td>
</tr>
<tr>
<td>go_memstats_mcache_inuse_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes in use by mcache structures.</td>
</tr>
<tr>
<td>go_memstats_mcache_sys_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes used for mcache structures obtained from system.</td>
</tr>
<tr>
<td>go_memstats_mspan_inuse_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes in use by mspan structures.</td>
</tr>
<tr>
<td>go_memstats_mspan_sys_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes used for mspan structures obtained from system.</td>
</tr>
<tr>
<td>go_memstats_next_gc_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of heap bytes when next garbage collection will take place.</td>
</tr>
<tr>
<td>go_memstats_other_sys_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes used for other system allocations.</td>
</tr>
<tr>
<td>go_memstats_stack_inuse_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes in use by the stack allocator.</td>
</tr>
<tr>
<td>go_memstats_stack_sys_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes obtained from system for stack allocator.</td>
</tr>
<tr>
<td>go_memstats_sys_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes obtained from system.</td>
</tr>
<tr>
<td>go_threads</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of OS threads created.</td>
</tr>
<tr>
<td>ins:pressure1</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>ins:pressure15</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>ins:pressure5</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>patroni_cluster_unlocked</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if the cluster is unlocked, 0 if locked.</td>
</tr>
<tr>
<td>patroni_dcs_last_seen</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Epoch timestamp when DCS was last contacted successfully by Patroni.</td>
</tr>
<tr>
<td>patroni_failsafe_mode_is_active</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if failsafe mode is active, 0 if inactive.</td>
</tr>
<tr>
<td>patroni_is_paused</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if auto failover is disabled, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_master</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if this node is the leader, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_pending_restart</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if the node needs a restart, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_postgres_in_archive_recovery</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if Postgres is replicating from archive, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_postgres_running</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if Postgres is running, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_postgres_server_version</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Version of Postgres (if running), 0 otherwise.</td>
</tr>
<tr>
<td>patroni_postgres_streaming</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if Postgres is streaming, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_postgres_timeline</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Postgres timeline of this node (if running), 0 otherwise.</td>
</tr>
<tr>
<td>patroni_postmaster_start_time</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Epoch seconds since Postgres started.</td>
</tr>
<tr>
<td>patroni_primary</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if this node is the leader, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_replica</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if this node is a replica, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_standby_leader</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if this node is the standby_leader, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_sync_standby</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if this node is a sync standby replica, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_up</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>patroni_version</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Patroni semver without periods.</td>
</tr>
<tr>
<td>patroni_xlog_location</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Current location of the Postgres transaction log, 0 if this node is not the leader.</td>
</tr>
<tr>
<td>patroni_xlog_paused</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if the Postgres xlog is paused, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_xlog_received_location</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Current location of the received Postgres transaction log, 0 if this node is not a replica.</td>
</tr>
<tr>
<td>patroni_xlog_replayed_location</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Current location of the replayed Postgres transaction log, 0 if this node is not a replica.</td>
</tr>
<tr>
<td>patroni_xlog_replayed_timestamp</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Current timestamp of the replayed Postgres transaction log, 0 if null.</td>
</tr>
<tr>
<td>pg:cls:active_backends</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:active_time_rate15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:active_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:active_time_rate5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:age</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:buf_alloc_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:buf_clean_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:buf_flush_backend_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:buf_flush_checkpoint_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:cpu_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:cpu_usage</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:cpu_usage_15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:cpu_usage_1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:cpu_usage_5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:db_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:file_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:ixact_backends</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:ixact_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:lag_bytes</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:lag_seconds</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:leader</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:load1</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:load15</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:load5</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:lock_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:locks</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code>, <code>mode</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:log_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:lsn_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:members</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:num_backends</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:partition</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:receiver</td>
<td>Unknown</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>appname</code>, <code>ip</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:rlock_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:saturation1</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:saturation15</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:saturation5</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:sender</td>
<td>Unknown</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:session_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:size</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:slot_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:slot_retained_bytes</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:standby_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:sync_state</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:timeline</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:tup_deleted_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:tup_fetched_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:tup_inserted_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:tup_modified_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:tup_returned_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:wal_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_commit_rate15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_commit_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_commit_rate5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_rollback_rate15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_rollback_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_rollback_rate5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_total_rate15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_total_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_total_sigma15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xlock_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:active_backends</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:active_time_rate15m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:active_time_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:active_time_rate5m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:age</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:age_deriv1h</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:age_exhaust</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:blk_io_time_seconds_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:blk_read_time_seconds_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:blk_write_time_seconds_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:blks_access_1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:blks_hit_1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:blks_hit_ratio1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:blks_read_1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:conn_limit</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:conn_usage</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:db_size</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:ixact_backends</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:ixact_time_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:lock_count</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:num_backends</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:rlock_count</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:session_time_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:temp_bytes_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:temp_files_1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:tup_deleted_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:tup_fetched_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:tup_inserted_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:tup_modified_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:tup_returned_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:wlock_count</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_commit_rate15m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_commit_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_commit_rate5m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_rollback_rate15m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_rollback_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_rollback_rate5m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_total_rate15m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_total_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_total_rate5m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_total_sigma15m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xlock_count</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:active_backends</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:active_time_rate15m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:active_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:active_time_rate5m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:age</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:cpu_count</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:cpu_usage</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:cpu_usage_15m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:cpu_usage_1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:cpu_usage_5m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:ixact_backends</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:ixact_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:lag_bytes</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:lag_seconds</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:lsn_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:session_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:tup_deleted_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:tup_fetched_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:tup_inserted_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:tup_modified_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:tup_returned_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_commit_rate15m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_commit_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_commit_rate5m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_rollback_rate15m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_rollback_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_rollback_rate5m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_total_rate15m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_total_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_total_sigma15m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:active_backends</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:active_time_rate15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:active_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:active_time_rate5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:age</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:blks_hit_ratio1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:buf_alloc_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:buf_clean_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:buf_flush_backend_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:buf_flush_checkpoint_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:ckpt_1h</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:ckpt_req_1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:ckpt_timed_1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:conn_limit</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:conn_usage</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:cpu_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:cpu_usage</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:cpu_usage_15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:cpu_usage_1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:cpu_usage_5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:db_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:file_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:fs_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:is_leader</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:ixact_backends</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:ixact_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:lag_bytes</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:lag_seconds</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:load1</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:load15</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:load5</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:lock_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:locks</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>mode</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:log_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:lsn_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:mem_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:num_backends</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:rlock_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:saturation1</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:saturation15</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:saturation5</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:session_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:slot_retained_bytes</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:space_usage</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:status</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:sync_state</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:target_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code>, <code>ins</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:timeline</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:tup_deleted_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:tup_fetched_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:tup_inserted_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:tup_modified_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:tup_returned_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:wal_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:wlock_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_commit_rate15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_commit_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_commit_rate5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_rollback_rate15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_rollback_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_rollback_rate5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_total_rate15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_total_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_total_rate5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_total_sigma15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xlock_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:query:call_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:query:rt_1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:table:scan_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg_activity_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Count of connection among (datname,state)</td>
</tr>
<tr>
<td>pg_activity_max_conn_duration</td>
<td>gauge</td>
<td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Max backend session duration since state change among (datname, state)</td>
</tr>
<tr>
<td>pg_activity_max_duration</td>
<td>gauge</td>
<td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Max duration since last state change among (datname, state)</td>
</tr>
<tr>
<td>pg_activity_max_tx_duration</td>
<td>gauge</td>
<td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Max transaction duration since state change among (datname, state)</td>
</tr>
<tr>
<td>pg_archiver_failed_count</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of failed attempts for archiving WAL files</td>
</tr>
<tr>
<td>pg_archiver_finish_count</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of WAL files that have been successfully archived</td>
</tr>
<tr>
<td>pg_archiver_last_failed_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time of the last failed archival operation</td>
</tr>
<tr>
<td>pg_archiver_last_finish_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time of the last successful archive operation</td>
</tr>
<tr>
<td>pg_archiver_reset_time</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time at which archive statistics were last reset</td>
</tr>
<tr>
<td>pg_backend_count</td>
<td>gauge</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Database backend process count by backend_type</td>
</tr>
<tr>
<td>pg_bgwriter_buffers_alloc</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of buffers allocated</td>
</tr>
<tr>
<td>pg_bgwriter_buffers_backend</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of buffers written directly by a backend</td>
</tr>
<tr>
<td>pg_bgwriter_buffers_backend_fsync</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times a backend had to execute its own fsync call</td>
</tr>
<tr>
<td>pg_bgwriter_buffers_checkpoint</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of buffers written during checkpoints</td>
</tr>
<tr>
<td>pg_bgwriter_buffers_clean</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of buffers written by the background writer</td>
</tr>
<tr>
<td>pg_bgwriter_checkpoint_sync_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total amount of time that has been spent in the portion of checkpoint processing where files are synchronized to disk, in seconds</td>
</tr>
<tr>
<td>pg_bgwriter_checkpoint_write_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total amount of time that has been spent in the portion of checkpoint processing where files are written to disk, in seconds</td>
</tr>
<tr>
<td>pg_bgwriter_checkpoints_req</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of requested checkpoints that have been performed</td>
</tr>
<tr>
<td>pg_bgwriter_checkpoints_timed</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of scheduled checkpoints that have been performed</td>
</tr>
<tr>
<td>pg_bgwriter_maxwritten_clean</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times the background writer stopped a cleaning scan because it had written too many buffers</td>
</tr>
<tr>
<td>pg_bgwriter_reset_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time at which bgwriter statistics were last reset</td>
</tr>
<tr>
<td>pg_boot_time</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>unix timestamp when postmaster boot</td>
</tr>
<tr>
<td>pg_checkpoint_checkpoint_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint location</td>
</tr>
<tr>
<td>pg_checkpoint_elapse</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Seconds elapsed since latest checkpoint in seconds</td>
</tr>
<tr>
<td>pg_checkpoint_full_page_writes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s full_page_writes enabled</td>
</tr>
<tr>
<td>pg_checkpoint_newest_commit_ts_xid</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s newestCommitTsXid</td>
</tr>
<tr>
<td>pg_checkpoint_next_multi_offset</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s NextMultiOffset</td>
</tr>
<tr>
<td>pg_checkpoint_next_multixact_id</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s NextMultiXactId</td>
</tr>
<tr>
<td>pg_checkpoint_next_oid</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s NextOID</td>
</tr>
<tr>
<td>pg_checkpoint_next_xid</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s NextXID xid</td>
</tr>
<tr>
<td>pg_checkpoint_next_xid_epoch</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s NextXID epoch</td>
</tr>
<tr>
<td>pg_checkpoint_oldest_active_xid</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s oldestActiveXID</td>
</tr>
<tr>
<td>pg_checkpoint_oldest_commit_ts_xid</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s oldestCommitTsXid</td>
</tr>
<tr>
<td>pg_checkpoint_oldest_multi_dbid</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s oldestMulti&rsquo;s DB OID</td>
</tr>
<tr>
<td>pg_checkpoint_oldest_multi_xid</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s oldestMultiXid</td>
</tr>
<tr>
<td>pg_checkpoint_oldest_xid</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s oldestXID</td>
</tr>
<tr>
<td>pg_checkpoint_oldest_xid_dbid</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s oldestXID&rsquo;s DB OID</td>
</tr>
<tr>
<td>pg_checkpoint_prev_tli</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s PrevTimeLineID</td>
</tr>
<tr>
<td>pg_checkpoint_redo_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s REDO location</td>
</tr>
<tr>
<td>pg_checkpoint_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time of latest checkpoint</td>
</tr>
<tr>
<td>pg_checkpoint_tli</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s TimeLineID</td>
</tr>
<tr>
<td>pg_conf_reload_time</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds since last configuration reload</td>
</tr>
<tr>
<td>pg_db_active_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent executing SQL statements in this database, in seconds</td>
</tr>
<tr>
<td>pg_db_age</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Age of database calculated from datfrozenxid</td>
</tr>
<tr>
<td>pg_db_allow_conn</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>If false(0) then no one can connect to this database.</td>
</tr>
<tr>
<td>pg_db_blk_read_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent reading data file blocks by backends in this database, in seconds</td>
</tr>
<tr>
<td>pg_db_blk_write_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent writing data file blocks by backends in this database, in seconds</td>
</tr>
<tr>
<td>pg_db_blks_access</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times disk blocks that accessed read+hit</td>
</tr>
<tr>
<td>pg_db_blks_hit</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times disk blocks were found already in the buffer cache</td>
</tr>
<tr>
<td>pg_db_blks_read</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of disk blocks read in this database</td>
</tr>
<tr>
<td>pg_db_cks_fail_time</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time at which the last data page checksum failure was detected in this database</td>
</tr>
<tr>
<td>pg_db_cks_fails</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of data page checksum failures detected in this database, -1 for not enabled</td>
</tr>
<tr>
<td>pg_db_confl_confl_bufferpin</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of queries in this database that have been canceled due to pinned buffers</td>
</tr>
<tr>
<td>pg_db_confl_confl_deadlock</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of queries in this database that have been canceled due to deadlocks</td>
</tr>
<tr>
<td>pg_db_confl_confl_lock</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of queries in this database that have been canceled due to lock timeouts</td>
</tr>
<tr>
<td>pg_db_confl_confl_snapshot</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of queries in this database that have been canceled due to old snapshots</td>
</tr>
<tr>
<td>pg_db_confl_confl_tablespace</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of queries in this database that have been canceled due to dropped tablespaces</td>
</tr>
<tr>
<td>pg_db_conflicts</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of queries canceled due to conflicts with recovery in this database</td>
</tr>
<tr>
<td>pg_db_conn_limit</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Sets maximum number of concurrent connections that can be made to this database. -1 means no limit.</td>
</tr>
<tr>
<td>pg_db_datid</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>OID of the database</td>
</tr>
<tr>
<td>pg_db_deadlocks</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of deadlocks detected in this database</td>
</tr>
<tr>
<td>pg_db_frozen_xid</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>All transaction IDs before this one have been frozened</td>
</tr>
<tr>
<td>pg_db_is_template</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>If true(1), then this database can be cloned by any user with CREATEDB privileges</td>
</tr>
<tr>
<td>pg_db_ixact_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent idling while in a transaction in this database, in seconds</td>
</tr>
<tr>
<td>pg_db_numbackends</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of backends currently connected to this database</td>
</tr>
<tr>
<td>pg_db_reset_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time at which database statistics were last reset</td>
</tr>
<tr>
<td>pg_db_session_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent by database sessions in this database, in seconds</td>
</tr>
<tr>
<td>pg_db_sessions</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of sessions established to this database</td>
</tr>
<tr>
<td>pg_db_sessions_abandoned</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of database sessions to this database that were terminated because connection to the client was lost</td>
</tr>
<tr>
<td>pg_db_sessions_fatal</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of database sessions to this database that were terminated by fatal errors</td>
</tr>
<tr>
<td>pg_db_sessions_killed</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of database sessions to this database that were terminated by operator intervention</td>
</tr>
<tr>
<td>pg_db_temp_bytes</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total amount of data written to temporary files by queries in this database.</td>
</tr>
<tr>
<td>pg_db_temp_files</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of temporary files created by queries in this database</td>
</tr>
<tr>
<td>pg_db_tup_deleted</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows deleted by queries in this database</td>
</tr>
<tr>
<td>pg_db_tup_fetched</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows fetched by queries in this database</td>
</tr>
<tr>
<td>pg_db_tup_inserted</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows inserted by queries in this database</td>
</tr>
<tr>
<td>pg_db_tup_modified</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows modified by queries in this database</td>
</tr>
<tr>
<td>pg_db_tup_returned</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows returned by queries in this database</td>
</tr>
<tr>
<td>pg_db_tup_updated</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows updated by queries in this database</td>
</tr>
<tr>
<td>pg_db_xact_commit</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of transactions in this database that have been committed</td>
</tr>
<tr>
<td>pg_db_xact_rollback</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of transactions in this database that have been rolled back</td>
</tr>
<tr>
<td>pg_db_xact_total</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of transactions in this database</td>
</tr>
<tr>
<td>pg_downstream_count</td>
<td>gauge</td>
<td><code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Count of corresponding state</td>
</tr>
<tr>
<td>pg_exporter_agent_up</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg_exporter_last_scrape_time</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds exporter spending on scrapping</td>
</tr>
<tr>
<td>pg_exporter_query_cache_ttl</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times to live of query cache</td>
</tr>
<tr>
<td>pg_exporter_query_scrape_duration</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds query spending on scrapping</td>
</tr>
<tr>
<td>pg_exporter_query_scrape_error_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times the query failed</td>
</tr>
<tr>
<td>pg_exporter_query_scrape_hit_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>numbers been scrapped from this query</td>
</tr>
<tr>
<td>pg_exporter_query_scrape_metric_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>numbers of metrics been scrapped from this query</td>
</tr>
<tr>
<td>pg_exporter_query_scrape_total_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times exporter server was scraped for metrics</td>
</tr>
<tr>
<td>pg_exporter_scrape_duration</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds exporter spending on scrapping</td>
</tr>
<tr>
<td>pg_exporter_scrape_error_count</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times exporter was scraped for metrics and failed</td>
</tr>
<tr>
<td>pg_exporter_scrape_total_count</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times exporter was scraped for metrics</td>
</tr>
<tr>
<td>pg_exporter_server_scrape_duration</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds exporter server spending on scrapping</td>
</tr>
<tr>
<td>pg_exporter_server_scrape_error_count</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg_exporter_server_scrape_total_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times exporter server was scraped for metrics</td>
</tr>
<tr>
<td>pg_exporter_server_scrape_total_seconds</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds exporter server spending on scrapping</td>
</tr>
<tr>
<td>pg_exporter_up</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>always be 1 if your could retrieve metrics</td>
</tr>
<tr>
<td>pg_exporter_uptime</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds since exporter primary server inited</td>
</tr>
<tr>
<td>pg_flush_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>primary only, location of current wal syncing</td>
</tr>
<tr>
<td>pg_func_calls</td>
<td>counter</td>
<td><code>datname</code>, <code>funcname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times this function has been called</td>
</tr>
<tr>
<td>pg_func_self_time</td>
<td>counter</td>
<td><code>datname</code>, <code>funcname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total time spent in this function itself, not including other functions called by it, in ms</td>
</tr>
<tr>
<td>pg_func_total_time</td>
<td>counter</td>
<td><code>datname</code>, <code>funcname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total time spent in this function and all other functions called by it, in ms</td>
</tr>
<tr>
<td>pg_in_recovery</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>server is in recovery mode? 1 for yes 0 for no</td>
</tr>
<tr>
<td>pg_index_idx_blks_hit</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td>
<td>Number of buffer hits in this index</td>
</tr>
<tr>
<td>pg_index_idx_blks_read</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td>
<td>Number of disk blocks read from this index</td>
</tr>
<tr>
<td>pg_index_idx_scan</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td>
<td>Number of index scans initiated on this index</td>
</tr>
<tr>
<td>pg_index_idx_tup_fetch</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td>
<td>Number of live table rows fetched by simple index scans using this index</td>
</tr>
<tr>
<td>pg_index_idx_tup_read</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td>
<td>Number of index entries returned by scans on this index</td>
</tr>
<tr>
<td>pg_index_relpages</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td>
<td>Size of the on-disk representation of this index in pages</td>
</tr>
<tr>
<td>pg_index_reltuples</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td>
<td>Estimate relation tuples</td>
</tr>
<tr>
<td>pg_insert_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>primary only, location of current wal inserting</td>
</tr>
<tr>
<td>pg_io_evictions</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times a block has been written out from a shared or local buffer</td>
</tr>
<tr>
<td>pg_io_extend_time</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent in extend operations in seconds</td>
</tr>
<tr>
<td>pg_io_extends</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of relation extend operations, each of the size specified in op_bytes.</td>
</tr>
<tr>
<td>pg_io_fsync_time</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent in fsync operations in seconds</td>
</tr>
<tr>
<td>pg_io_fsyncs</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of fsync calls. These are only tracked in context normal</td>
</tr>
<tr>
<td>pg_io_hits</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>The number of times a desired block was found in a shared buffer.</td>
</tr>
<tr>
<td>pg_io_op_bytes</td>
<td>gauge</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>The number of bytes per unit of I/O read, written, or extended. 8192 by default</td>
</tr>
<tr>
<td>pg_io_read_time</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent in read operations in seconds</td>
</tr>
<tr>
<td>pg_io_reads</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of read operations, each of the size specified in op_bytes.</td>
</tr>
<tr>
<td>pg_io_reset_time</td>
<td>gauge</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Timestamp at which these statistics were last reset</td>
</tr>
<tr>
<td>pg_io_reuses</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>The number of times an existing buffer in reused</td>
</tr>
<tr>
<td>pg_io_write_time</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent in write operations in seconds</td>
</tr>
<tr>
<td>pg_io_writeback_time</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent in writeback operations in seconds</td>
</tr>
<tr>
<td>pg_io_writebacks</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of units of size op_bytes which the process requested the kernel write out to permanent storage.</td>
</tr>
<tr>
<td>pg_io_writes</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of write operations, each of the size specified in op_bytes.</td>
</tr>
<tr>
<td>pg_is_in_recovery</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>1 if in recovery mode</td>
</tr>
<tr>
<td>pg_is_wal_replay_paused</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>1 if wal play paused</td>
</tr>
<tr>
<td>pg_lag</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>replica only, replication lag in seconds</td>
</tr>
<tr>
<td>pg_last_replay_time</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>time when last transaction been replayed</td>
</tr>
<tr>
<td>pg_lock_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>mode</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of locks of corresponding mode and database</td>
</tr>
<tr>
<td>pg_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>log sequence number, current write location</td>
</tr>
<tr>
<td>pg_meta_info</td>
<td>gauge</td>
<td><code>cls</code>, <code>extensions</code>, <code>version</code>, <code>job</code>, <code>ins</code>, <code>primary_conninfo</code>, <code>conf_path</code>, <code>hba_path</code>, <code>ip</code>, <code>cluster_id</code>, <code>instance</code>, <code>listen_port</code>, <code>wal_level</code>, <code>ver_num</code>, <code>cluster_name</code>, <code>data_dir</code></td>
<td>constant 1</td>
</tr>
<tr>
<td>pg_query_calls</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times the statement was executed</td>
</tr>
<tr>
<td>pg_query_exec_time</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total time spent executing the statement, in seconds</td>
</tr>
<tr>
<td>pg_query_io_time</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total time the statement spent reading and writing blocks, in seconds</td>
</tr>
<tr>
<td>pg_query_rows</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of rows retrieved or affected by the statement</td>
</tr>
<tr>
<td>pg_query_sblk_dirtied</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of shared blocks dirtied by the statement</td>
</tr>
<tr>
<td>pg_query_sblk_hit</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of shared block cache hits by the statement</td>
</tr>
<tr>
<td>pg_query_sblk_read</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of shared blocks read by the statement</td>
</tr>
<tr>
<td>pg_query_sblk_written</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of shared blocks written by the statement</td>
</tr>
<tr>
<td>pg_query_wal_bytes</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total amount of WAL bytes generated by the statement</td>
</tr>
<tr>
<td>pg_receive_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>replica only, location of wal synced to disk</td>
</tr>
<tr>
<td>pg_recovery_backup_end_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Backup end location</td>
</tr>
<tr>
<td>pg_recovery_backup_start_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Backup start location</td>
</tr>
<tr>
<td>pg_recovery_min_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Minimum recovery ending location</td>
</tr>
<tr>
<td>pg_recovery_min_timeline</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Min recovery ending loc&rsquo;s timeline</td>
</tr>
<tr>
<td>pg_recovery_prefetch_block_distance</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>How many blocks ahead the prefetcher is looking</td>
</tr>
<tr>
<td>pg_recovery_prefetch_hit</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of blocks not prefetched because they were already in the buffer pool</td>
</tr>
<tr>
<td>pg_recovery_prefetch_io_depth</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>How many prefetches have been initiated but are not yet known to have completed</td>
</tr>
<tr>
<td>pg_recovery_prefetch_prefetch</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of blocks prefetched because they were not in the buffer pool</td>
</tr>
<tr>
<td>pg_recovery_prefetch_reset_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time at which these recovery prefetch statistics were last reset</td>
</tr>
<tr>
<td>pg_recovery_prefetch_skip_fpw</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of blocks not prefetched because a full page image was included in the WAL</td>
</tr>
<tr>
<td>pg_recovery_prefetch_skip_init</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of blocks not prefetched because they would be zero-initialized</td>
</tr>
<tr>
<td>pg_recovery_prefetch_skip_new</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of blocks not prefetched because they didn&rsquo;t exist yet</td>
</tr>
<tr>
<td>pg_recovery_prefetch_skip_rep</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of blocks not prefetched because they were already recently prefetched</td>
</tr>
<tr>
<td>pg_recovery_prefetch_wal_distance</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>How many bytes ahead the prefetcher is looking</td>
</tr>
<tr>
<td>pg_recovery_require_record</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>End-of-backup record required</td>
</tr>
<tr>
<td>pg_recv_flush_lsn</td>
<td>counter</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Last write-ahead log location already received and flushed to disk</td>
</tr>
<tr>
<td>pg_recv_flush_tli</td>
<td>counter</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Timeline number of last write-ahead log location received and flushed to disk</td>
</tr>
<tr>
<td>pg_recv_init_lsn</td>
<td>counter</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>First write-ahead log location used when WAL receiver is started</td>
</tr>
<tr>
<td>pg_recv_init_tli</td>
<td>counter</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>First timeline number used when WAL receiver is started</td>
</tr>
<tr>
<td>pg_recv_msg_recv_time</td>
<td>gauge</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Receipt time of last message received from origin WAL sender</td>
</tr>
<tr>
<td>pg_recv_msg_send_time</td>
<td>gauge</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Send time of last message received from origin WAL sender</td>
</tr>
<tr>
<td>pg_recv_pid</td>
<td>gauge</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Process ID of the WAL receiver process</td>
</tr>
<tr>
<td>pg_recv_reported_lsn</td>
<td>counter</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Last write-ahead log location reported to origin WAL sender</td>
</tr>
<tr>
<td>pg_recv_reported_time</td>
<td>gauge</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Time of last write-ahead log location reported to origin WAL sender</td>
</tr>
<tr>
<td>pg_recv_time</td>
<td>gauge</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Time of current snapshot</td>
</tr>
<tr>
<td>pg_recv_write_lsn</td>
<td>counter</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Last write-ahead log location already received and written to disk, but not flushed.</td>
</tr>
<tr>
<td>pg_relkind_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>relkind</code></td>
<td>Number of relations of corresponding relkind</td>
</tr>
<tr>
<td>pg_repl_backend_xmin</td>
<td>counter</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>This standby&rsquo;s xmin horizon reported by hot_standby_feedback.</td>
</tr>
<tr>
<td>pg_repl_client_port</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>TCP port number that the client is using for communication with this WAL sender, or -1 if a Unix socket is used</td>
</tr>
<tr>
<td>pg_repl_flush_diff</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Last log position flushed to disk by this standby server diff with current lsn</td>
</tr>
<tr>
<td>pg_repl_flush_lag</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written and flushed it</td>
</tr>
<tr>
<td>pg_repl_flush_lsn</td>
<td>counter</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Last write-ahead log location flushed to disk by this standby server</td>
</tr>
<tr>
<td>pg_repl_launch_time</td>
<td>counter</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time when this process was started, i.e., when the client connected to this WAL sender</td>
</tr>
<tr>
<td>pg_repl_lsn</td>
<td>counter</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Current log position on this server</td>
</tr>
<tr>
<td>pg_repl_replay_diff</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Last log position replayed into the database on this standby server diff with current lsn</td>
</tr>
<tr>
<td>pg_repl_replay_lag</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written, flushed and applied it</td>
</tr>
<tr>
<td>pg_repl_replay_lsn</td>
<td>counter</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Last write-ahead log location replayed into the database on this standby server</td>
</tr>
<tr>
<td>pg_repl_reply_time</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Send time of last reply message received from standby server</td>
</tr>
<tr>
<td>pg_repl_sent_diff</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Last log position sent to this standby server diff with current lsn</td>
</tr>
<tr>
<td>pg_repl_sent_lsn</td>
<td>counter</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Last write-ahead log location sent on this connection</td>
</tr>
<tr>
<td>pg_repl_state</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Current WAL sender encoded state 0-4 for streaming startup catchup backup stopping</td>
</tr>
<tr>
<td>pg_repl_sync_priority</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Priority of this standby server for being chosen as the synchronous standby</td>
</tr>
<tr>
<td>pg_repl_sync_state</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Encoded synchronous state of this standby server, 0-3 for async potential sync quorum</td>
</tr>
<tr>
<td>pg_repl_time</td>
<td>counter</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Current timestamp in unix epoch</td>
</tr>
<tr>
<td>pg_repl_write_diff</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Last log position written to disk by this standby server diff with current lsn</td>
</tr>
<tr>
<td>pg_repl_write_lag</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written it</td>
</tr>
<tr>
<td>pg_repl_write_lsn</td>
<td>counter</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Last write-ahead log location written to disk by this standby server</td>
</tr>
<tr>
<td>pg_replay_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>replica only, location of wal applied</td>
</tr>
<tr>
<td>pg_seq_blks_hit</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>seqname</code></td>
<td>Number of buffer hits in this sequence</td>
</tr>
<tr>
<td>pg_seq_blks_read</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>seqname</code></td>
<td>Number of disk blocks read from this sequence</td>
</tr>
<tr>
<td>pg_seq_last_value</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>seqname</code></td>
<td>The last sequence value written to disk</td>
</tr>
<tr>
<td>pg_setting_block_size</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>pg page block size, 8192 by default</td>
</tr>
<tr>
<td>pg_setting_data_checksums</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>whether data checksum is enabled, 1 enabled 0 disabled</td>
</tr>
<tr>
<td>pg_setting_max_connections</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>number of concurrent connections to the database server</td>
</tr>
<tr>
<td>pg_setting_max_locks_per_transaction</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>no more than this many distinct objects can be locked at any one time</td>
</tr>
<tr>
<td>pg_setting_max_prepared_transactions</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>maximum number of transactions that can be in the prepared state simultaneously</td>
</tr>
<tr>
<td>pg_setting_max_replication_slots</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>maximum number of replication slots</td>
</tr>
<tr>
<td>pg_setting_max_wal_senders</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>maximum number of concurrent connections from standby servers</td>
</tr>
<tr>
<td>pg_setting_max_worker_processes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>maximum number of background processes that the system can support</td>
</tr>
<tr>
<td>pg_setting_wal_log_hints</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>whether wal_log_hints is enabled, 1 enabled 0 disabled</td>
</tr>
<tr>
<td>pg_size_bytes</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>File size in bytes</td>
</tr>
<tr>
<td>pg_slot_active</td>
<td>gauge</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>True(1) if this slot is currently actively being used</td>
</tr>
<tr>
<td>pg_slot_catalog_xmin</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>The oldest transaction affecting the system catalogs that this slot needs the database to retain.</td>
</tr>
<tr>
<td>pg_slot_confirm_lsn</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>The address (LSN) up to which the logical slot&rsquo;s consumer has confirmed receiving data.</td>
</tr>
<tr>
<td>pg_slot_reset_time</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>When statistics were last reset</td>
</tr>
<tr>
<td>pg_slot_restart_lsn</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>The address (LSN) of oldest WAL which still might be required by the consumer of this slot</td>
</tr>
<tr>
<td>pg_slot_retained_bytes</td>
<td>gauge</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Size of bytes that retained for this slot</td>
</tr>
<tr>
<td>pg_slot_safe_wal_size</td>
<td>gauge</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>bytes that can be written to WAL which will not make slot into lost</td>
</tr>
<tr>
<td>pg_slot_spill_bytes</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Bytes that spilled to disk due to logical decode mem exceeding</td>
</tr>
<tr>
<td>pg_slot_spill_count</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Xacts that spilled to disk due to logical decode mem exceeding (a xact can be spilled multiple times)</td>
</tr>
<tr>
<td>pg_slot_spill_txns</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Xacts that spilled to disk due to logical decode mem exceeding (subtrans included)</td>
</tr>
<tr>
<td>pg_slot_stream_bytes</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Bytes that streamed to decoding output plugin after mem exceed</td>
</tr>
<tr>
<td>pg_slot_stream_count</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Xacts that streamed to decoding output plugin after mem exceed  (a xact can be streamed multiple times)</td>
</tr>
<tr>
<td>pg_slot_stream_txns</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Xacts that streamed to decoding output plugin after mem exceed</td>
</tr>
<tr>
<td>pg_slot_temporary</td>
<td>gauge</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>True(1) if this is a temporary replication slot.</td>
</tr>
<tr>
<td>pg_slot_total_bytes</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of decoded bytes sent to the decoding output plugin for this slot</td>
</tr>
<tr>
<td>pg_slot_total_txns</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of decoded xacts sent to the decoding output plugin for this slot</td>
</tr>
<tr>
<td>pg_slot_wal_status</td>
<td>gauge</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>WAL reserve status 0-3 means reserved,extended,unreserved,lost, -1 means other</td>
</tr>
<tr>
<td>pg_slot_xmin</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>The oldest transaction that this slot needs the database to retain.</td>
</tr>
<tr>
<td>pg_slru_blks_exists</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of blocks checked for existence for this SLRU</td>
</tr>
<tr>
<td>pg_slru_blks_hit</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times disk blocks were found already in the SLRU, so that a read was not necessary</td>
</tr>
<tr>
<td>pg_slru_blks_read</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of disk blocks read for this SLRU</td>
</tr>
<tr>
<td>pg_slru_blks_written</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of disk blocks written for this SLRU</td>
</tr>
<tr>
<td>pg_slru_blks_zeroed</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of blocks zeroed during initializations</td>
</tr>
<tr>
<td>pg_slru_flushes</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of flushes of dirty data for this SLRU</td>
</tr>
<tr>
<td>pg_slru_reset_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time at which these statistics were last reset</td>
</tr>
<tr>
<td>pg_slru_truncates</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of truncates for this SLRU</td>
</tr>
<tr>
<td>pg_ssl_disabled</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of client connection that does not use ssl</td>
</tr>
<tr>
<td>pg_ssl_enabled</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of client connection that use ssl</td>
</tr>
<tr>
<td>pg_sync_standby_enabled</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>names</code>, <code>instance</code>, <code>cls</code></td>
<td>Synchronous commit enabled, 1 if enabled, 0 if disabled</td>
</tr>
<tr>
<td>pg_table_age</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Age of this table in vacuum cycles</td>
</tr>
<tr>
<td>pg_table_analyze_count</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times this table has been manually analyzed</td>
</tr>
<tr>
<td>pg_table_autoanalyze_count</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times this table has been analyzed by the autovacuum daemon</td>
</tr>
<tr>
<td>pg_table_autovacuum_count</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times this table has been vacuumed by the autovacuum daemon</td>
</tr>
<tr>
<td>pg_table_frozenxid</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>All txid before this have been frozen on this table</td>
</tr>
<tr>
<td>pg_table_heap_blks_hit</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of buffer hits in this table</td>
</tr>
<tr>
<td>pg_table_heap_blks_read</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of disk blocks read from this table</td>
</tr>
<tr>
<td>pg_table_idx_blks_hit</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of buffer hits in all indexes on this table</td>
</tr>
<tr>
<td>pg_table_idx_blks_read</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of disk blocks read from all indexes on this table</td>
</tr>
<tr>
<td>pg_table_idx_scan</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of index scans initiated on this table</td>
</tr>
<tr>
<td>pg_table_idx_tup_fetch</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of live rows fetched by index scans</td>
</tr>
<tr>
<td>pg_table_kind</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Relation kind r/table/114</td>
</tr>
<tr>
<td>pg_table_n_dead_tup</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Estimated number of dead rows</td>
</tr>
<tr>
<td>pg_table_n_ins_since_vacuum</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Estimated number of rows inserted since this table was last vacuumed</td>
</tr>
<tr>
<td>pg_table_n_live_tup</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Estimated number of live rows</td>
</tr>
<tr>
<td>pg_table_n_mod_since_analyze</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Estimated number of rows modified since this table was last analyzed</td>
</tr>
<tr>
<td>pg_table_n_tup_del</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows deleted</td>
</tr>
<tr>
<td>pg_table_n_tup_hot_upd</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows HOT updated (i.e with no separate index update required)</td>
</tr>
<tr>
<td>pg_table_n_tup_ins</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows inserted</td>
</tr>
<tr>
<td>pg_table_n_tup_mod</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows modified (insert + update + delete)</td>
</tr>
<tr>
<td>pg_table_n_tup_newpage_upd</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows updated where the successor version goes onto a new heap page</td>
</tr>
<tr>
<td>pg_table_n_tup_upd</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows updated (includes HOT updated rows)</td>
</tr>
<tr>
<td>pg_table_ncols</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of columns in the table</td>
</tr>
<tr>
<td>pg_table_pages</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Size of the on-disk representation of this table in pages</td>
</tr>
<tr>
<td>pg_table_relid</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Relation oid of this table</td>
</tr>
<tr>
<td>pg_table_seq_scan</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of sequential scans initiated on this table</td>
</tr>
<tr>
<td>pg_table_seq_tup_read</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of live rows fetched by sequential scans</td>
</tr>
<tr>
<td>pg_table_size_bytes</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total bytes of this table (including toast, index, toast index)</td>
</tr>
<tr>
<td>pg_table_size_indexsize</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Bytes of all related indexes of this table</td>
</tr>
<tr>
<td>pg_table_size_relsize</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Bytes of this table itself (main, vm, fsm)</td>
</tr>
<tr>
<td>pg_table_size_toastsize</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Bytes of toast tables of this table</td>
</tr>
<tr>
<td>pg_table_tbl_scan</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of scans initiated on this table</td>
</tr>
<tr>
<td>pg_table_tup_read</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of live rows fetched by scans</td>
</tr>
<tr>
<td>pg_table_tuples</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>All txid before this have been frozen on this table</td>
</tr>
<tr>
<td>pg_table_vacuum_count</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times this table has been manually vacuumed (not counting VACUUM FULL)</td>
</tr>
<tr>
<td>pg_timestamp</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>database current timestamp</td>
</tr>
<tr>
<td>pg_up</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>last scrape was able to connect to the server: 1 for yes, 0 for no</td>
</tr>
<tr>
<td>pg_uptime</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds since postmaster start</td>
</tr>
<tr>
<td>pg_version</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>server version number</td>
</tr>
<tr>
<td>pg_wait_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>event</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Count of WaitEvent on target database</td>
</tr>
<tr>
<td>pg_wal_buffers_full</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times WAL data was written to disk because WAL buffers became full</td>
</tr>
<tr>
<td>pg_wal_bytes</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total amount of WAL generated in bytes</td>
</tr>
<tr>
<td>pg_wal_fpi</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of WAL full page images generated</td>
</tr>
<tr>
<td>pg_wal_records</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of WAL records generated</td>
</tr>
<tr>
<td>pg_wal_reset_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>When statistics were last reset</td>
</tr>
<tr>
<td>pg_wal_sync</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times WAL files were synced to disk via issue_xlog_fsync request</td>
</tr>
<tr>
<td>pg_wal_sync_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total amount of time spent syncing WAL files to disk via issue_xlog_fsync request, in seconds</td>
</tr>
<tr>
<td>pg_wal_write</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times WAL buffers were written out to disk via XLogWrite request.</td>
</tr>
<tr>
<td>pg_wal_write_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total amount of time spent writing WAL buffers to disk via XLogWrite request in seconds</td>
</tr>
<tr>
<td>pg_write_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>primary only, location of current wal writing</td>
</tr>
<tr>
<td>pg_xact_xmax</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>First as-yet-unassigned txid. txid &gt;= this are invisible.</td>
</tr>
<tr>
<td>pg_xact_xmin</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Earliest txid that is still active</td>
</tr>
<tr>
<td>pg_xact_xnum</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Current active transaction count</td>
</tr>
<tr>
<td>pgbouncer:cls:load1</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:cls:load15</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:cls:load5</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:db:conn_usage</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:db:conn_usage_reserve</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:db:pool_current_conn</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:db:pool_disabled</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:db:pool_max_conn</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:db:pool_paused</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:db:pool_reserve_size</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:db:pool_size</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:free_clients</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:free_servers</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:load1</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:load15</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:load5</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:login_clients</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:pool_databases</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:pool_users</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:pools</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:used_clients</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer_database_current_connections</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>Current number of connections for this database</td>
</tr>
<tr>
<td>pgbouncer_database_disabled</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>True(1) if this database is currently disabled, else 0</td>
</tr>
<tr>
<td>pgbouncer_database_max_connections</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>Maximum number of allowed connections for this database</td>
</tr>
<tr>
<td>pgbouncer_database_min_pool_size</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>Minimum number of server connections</td>
</tr>
<tr>
<td>pgbouncer_database_paused</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>True(1) if this database is currently paused, else 0</td>
</tr>
<tr>
<td>pgbouncer_database_pool_size</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>Maximum number of server connections</td>
</tr>
<tr>
<td>pgbouncer_database_reserve_pool</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>Maximum number of additional connections for this database</td>
</tr>
<tr>
<td>pgbouncer_exporter_agent_up</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer_exporter_last_scrape_time</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds exporter spending on scrapping</td>
</tr>
<tr>
<td>pgbouncer_exporter_query_cache_ttl</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times to live of query cache</td>
</tr>
<tr>
<td>pgbouncer_exporter_query_scrape_duration</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds query spending on scrapping</td>
</tr>
<tr>
<td>pgbouncer_exporter_query_scrape_error_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times the query failed</td>
</tr>
<tr>
<td>pgbouncer_exporter_query_scrape_hit_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>numbers been scrapped from this query</td>
</tr>
<tr>
<td>pgbouncer_exporter_query_scrape_metric_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>numbers of metrics been scrapped from this query</td>
</tr>
<tr>
<td>pgbouncer_exporter_query_scrape_total_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times exporter server was scraped for metrics</td>
</tr>
<tr>
<td>pgbouncer_exporter_scrape_duration</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds exporter spending on scrapping</td>
</tr>
<tr>
<td>pgbouncer_exporter_scrape_error_count</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times exporter was scraped for metrics and failed</td>
</tr>
<tr>
<td>pgbouncer_exporter_scrape_total_count</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times exporter was scraped for metrics</td>
</tr>
<tr>
<td>pgbouncer_exporter_server_scrape_duration</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds exporter server spending on scrapping</td>
</tr>
<tr>
<td>pgbouncer_exporter_server_scrape_total_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times exporter server was scraped for metrics</td>
</tr>
<tr>
<td>pgbouncer_exporter_server_scrape_total_seconds</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds exporter server spending on scrapping</td>
</tr>
<tr>
<td>pgbouncer_exporter_up</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>always be 1 if your could retrieve metrics</td>
</tr>
<tr>
<td>pgbouncer_exporter_uptime</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds since exporter primary server inited</td>
</tr>
<tr>
<td>pgbouncer_in_recovery</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>server is in recovery mode? 1 for yes 0 for no</td>
</tr>
<tr>
<td>pgbouncer_list_items</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>list</code>, <code>cls</code></td>
<td>Number of corresponding pgbouncer object</td>
</tr>
<tr>
<td>pgbouncer_pool_active_cancel_clients</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Client connections that have forwarded query cancellations to the server and are waiting for the server response.</td>
</tr>
<tr>
<td>pgbouncer_pool_active_cancel_servers</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Server connections that are currently forwarding a cancel request</td>
</tr>
<tr>
<td>pgbouncer_pool_active_clients</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Client connections that are linked to server connection and can process queries</td>
</tr>
<tr>
<td>pgbouncer_pool_active_servers</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Server connections that are linked to a client</td>
</tr>
<tr>
<td>pgbouncer_pool_cancel_clients</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Client connections that have not forwarded query cancellations to the server yet.</td>
</tr>
<tr>
<td>pgbouncer_pool_cancel_servers</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>cancel requests have completed that were sent to cancel a query on this server</td>
</tr>
<tr>
<td>pgbouncer_pool_idle_servers</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Server connections that are unused and immediately usable for client queries</td>
</tr>
<tr>
<td>pgbouncer_pool_login_servers</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Server connections currently in the process of logging in</td>
</tr>
<tr>
<td>pgbouncer_pool_maxwait</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>How long the first(oldest) client in the queue has waited, in seconds, key metric</td>
</tr>
<tr>
<td>pgbouncer_pool_maxwait_us</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Microsecond part of the maximum waiting time.</td>
</tr>
<tr>
<td>pgbouncer_pool_tested_servers</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Server connections that are currently running reset or check query</td>
</tr>
<tr>
<td>pgbouncer_pool_used_servers</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Server connections that have been idle for more than server_check_delay (means have to run check query)</td>
</tr>
<tr>
<td>pgbouncer_pool_waiting_clients</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Client connections that have sent queries but have not yet got a server connection</td>
</tr>
<tr>
<td>pgbouncer_stat_avg_query_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Average queries per second in last stat period</td>
</tr>
<tr>
<td>pgbouncer_stat_avg_query_time</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Average query duration, in seconds</td>
</tr>
<tr>
<td>pgbouncer_stat_avg_recv</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Average received (from clients) bytes per second</td>
</tr>
<tr>
<td>pgbouncer_stat_avg_sent</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Average sent (to clients) bytes per second</td>
</tr>
<tr>
<td>pgbouncer_stat_avg_wait_time</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent by clients waiting for a server, in seconds (average per second).</td>
</tr>
<tr>
<td>pgbouncer_stat_avg_xact_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Average transactions per second in last stat period</td>
</tr>
<tr>
<td>pgbouncer_stat_avg_xact_time</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Average transaction duration, in seconds</td>
</tr>
<tr>
<td>pgbouncer_stat_total_query_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of SQL queries pooled by pgbouncer</td>
</tr>
<tr>
<td>pgbouncer_stat_total_query_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of seconds spent when executing queries</td>
</tr>
<tr>
<td>pgbouncer_stat_total_received</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total volume in bytes of network traffic received by pgbouncer</td>
</tr>
<tr>
<td>pgbouncer_stat_total_sent</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total volume in bytes of network traffic sent by pgbouncer</td>
</tr>
<tr>
<td>pgbouncer_stat_total_wait_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent by clients waiting for a server, in seconds</td>
</tr>
<tr>
<td>pgbouncer_stat_total_xact_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of SQL transactions pooled by pgbouncer</td>
</tr>
<tr>
<td>pgbouncer_stat_total_xact_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of seconds spent when in a transaction</td>
</tr>
<tr>
<td>pgbouncer_up</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>last scrape was able to connect to the server: 1 for yes, 0 for no</td>
</tr>
<tr>
<td>pgbouncer_version</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>server version number</td>
</tr>
<tr>
<td>process_cpu_seconds_total</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total user and system CPU time spent in seconds.</td>
</tr>
<tr>
<td>process_max_fds</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Maximum number of open file descriptors.</td>
</tr>
<tr>
<td>process_open_fds</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of open file descriptors.</td>
</tr>
<tr>
<td>process_resident_memory_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Resident memory size in bytes.</td>
</tr>
<tr>
<td>process_start_time_seconds</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Start time of the process since unix epoch in seconds.</td>
</tr>
<tr>
<td>process_virtual_memory_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Virtual memory size in bytes.</td>
</tr>
<tr>
<td>process_virtual_memory_max_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Maximum amount of virtual memory available in bytes.</td>
</tr>
<tr>
<td>promhttp_metric_handler_requests_in_flight</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Current number of scrapes being served.</td>
</tr>
<tr>
<td>promhttp_metric_handler_requests_total</td>
<td>counter</td>
<td><code>code</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of scrapes by HTTP status code.</td>
</tr>
<tr>
<td>scrape_duration_seconds</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>scrape_samples_post_metric_relabeling</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>scrape_samples_scraped</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>scrape_series_added</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>up</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-06a73ab7adbd73b0e635c3d9403cab4e">17 - 常见问题</h1>
    <div class="lead">PostgreSQL 常见问题答疑</div>
	<hr>
<h2 id="pgsql初始化失败abort-due-to-postgres-exists">PGSQL初始化失败：ABORT due to postgres exists</h2>
<p>这意味着正在初始化的 PostgreSQL 实例已经存在了， 将 <code>pg_clean</code> 设置为 <code>true</code>，并将 <code>pg_safeguard</code> 设置为 <code>false</code>，就可以在执行 <code>pgsql.yml</code> 期间强制清理现存实例。</p>
<p>如果 <code>pg_clean</code> 为 <code>true</code> (并且 <code>pg_safeguard</code> 也为 <code>false</code>)，<code>pgsql.yml</code> 剧本将会移除现有的 pgsql 数据并重新初始化为新的，这使得这个剧本真正幂等。</p>
<p>你可以通过使用一个特殊的任务标签 <code>pg_purge</code> 来强制清除现有的 PostgreSQL 数据，这个标签任务会忽略 <code>pg_clean</code> 和 <code>pg_safeguard</code> 的设置，所以非常危险。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_clean      <span style="color:#8f5902;font-style:italic"># 优先考虑 pg_clean 和 pg_safeguard</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_purge      <span style="color:#8f5902;font-style:italic"># 忽略 pg_clean 和 pg_safeguard</span>
</span></span></code></pre></div><hr>
<h2 id="pgsql初始化失败abort-due-to-pg_safeguard-enabled">PGSQL初始化失败：ABORT due to pg_safeguard enabled</h2>
<p>这意味着正准备清理的 PostgreSQL 实例打开了防误删保险， 禁用 <code>pg_safeguard</code> 以移除 Postgres 实例。</p>
<p>如果防误删保险 <a href="/zh/docs/reference/param#pg_safeguard"><code>pg_safeguard</code></a> 打开，那么你就不能使用 <code>bin/pgsql-rm</code> 和 <code>pgsql-rm.yml</code> 剧本移除正在运行的 PGSQL 实例了。</p>
<p>要禁用 <code>pg_safeguard</code>，你可以在配置清单中将 <code>pg_safeguard</code> 设置为 <code>false</code>，或者在执行剧本时使用命令参数 <code>-e pg_safeguard=false</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql-rm.yml -e <span style="color:#000">pg_safeguard</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span> -l &lt;cls_to_remove&gt;    <span style="color:#8f5902;font-style:italic"># 强制覆盖 pg_safeguard</span>
</span></span></code></pre></div><p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;`</p>
<h2 id="pgsql初始化失败fail-to-wait-for-postgrespatroni-primary">PGSQL初始化失败：Fail to wait for postgres/patroni primary</h2>
<p>这种错误信息存在多种可能，需要你 <a href="https://github.com/Vonng/pigsty/discussions/338">检查</a> Ansible，Systemd / Patroni / PostgreSQL 日志，找出真正的原因。</p>
<ul>
<li>可能性1：集群配置错误，找出错误的配置项修改并应用。</li>
<li>可能性2：在部署中存在同名集群，或者之前的同名集群主节点被不正确地移除</li>
<li>可能性3：在DCS中有同名集群残留的垃圾元数据：没有正确完成下线，你可以使用 <code>etcdctl del --prefix /pg/&lt;cls&gt;</code> 来手工删除残留数据（请小心）</li>
<li>可能性4：你的 PostgreSQL 或节点相关 RPM 包没有被成功安装</li>
<li>可能性5：你的 Watchdog 内核模块没有正确启用加载</li>
<li>可能性6：你在初始化数据库时指定的语言 Locale 不存在（例如，使用了 en_US.UTF8，但没有安装英文语言包或 Locale 支持）</li>
<li>如果你遇到了其他的原因，欢迎提交 Issue 或向社区求助。</li>
</ul>
<hr>
<h2 id="pgsql初始化失败fail-to-wait-for-postgrespatroni-replica">PGSQL初始化失败：Fail to wait for postgres/patroni replica</h2>
<p>存在几种可能的原因：</p>
<p><strong>立即失败</strong>：通常是由于配置错误、网络问题、损坏的DCS元数据等原因。你必须检查 <code>/pg/log</code> 找出实际原因。</p>
<p><strong>过了一会儿失败</strong>：这可能是由于源实例数据损坏。查看 PGSQL FAQ：如何在数据损坏时创建副本？</p>
<p><strong>过了很长时间再超时</strong>：如果 <code>wait for postgres replica</code> 任务耗时 30 分钟或更长时间并由于超时而失败，这对于大型集群（例如，1TB+，可能需要几小时创建一个副本）是很常见的。</p>
<p>在这种情况下，底层创建副本的过程仍在进行。你可以使用 <code>pg list &lt;cls&gt;</code> 检查集群状态并等待副本赶上主节点。然后使用以下命令继续以下任务，完成完整的从库初始化：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_hba,pg_reload,pg_backup,pgbouncer,pg_vip,pg_dns,pg_service,pg_exporter,pg_register -l &lt;problematic_replica&gt;
</span></span></code></pre></div><hr>
<h2 id="如何安装其他的postgresql大版本12---14以及-16beta">如何安装其他的PostgreSQL大版本：12 - 14，以及 16beta</h2>
<p>要安装 PostgreSQL 12 - 15，你必须在配置清单中设置 <code>pg_version</code> 为 <code>12</code>、<code>13</code>、<code>14</code> 或 <code>15</code>，通常在集群级别配置这个参数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#8f5902;font-style:italic"># 在此模板中安装 pg 16</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_libs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pg_stat_statements, auto_explain&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 从 pg 16 beta 中移除 timescaledb，因为它不可用</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># 目前缺少 pg16 扩展</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在 <a href="https://github.com/Vonng/pigsty/blob/main/conf/prod.yml#L110">prod.yml</a> 43 节点生产环境仿真模板中提供了安装 12 - 16 大版本集群的示例。</p>
<p>详情请参考 <a href="/zh/docs/pgsql/config#%E5%A4%A7%E7%89%88%E6%9C%AC%E5%88%87%E6%8D%A2">PGSQL配置：切换大版本</a></p>
<hr>
<h2 id="如何为-postgresql-启用大页hugepage">如何为 PostgreSQL 启用大页/HugePage？</h2>
<blockquote>
<p>使用 <code>node_hugepage_count</code> 和 <code>node_hugepage_ratio</code> 或 <code>/pg/bin/pg-tune-hugepage</code></p>
</blockquote>
<p>如果你计划启用大页（HugePage），请考虑使用 <a href="/zh/docs/reference/param#node_hugepage_count"><code>node_hugepage_count</code></a> 和 <a href="/zh/docs/reference/param#node_hugepage_ratio"><code>node_hugepage_ratio</code></a>，并配合 <code>./node.yml -t node_tune</code> 进行应用。</p>
<p>大页对于数据库来说有利有弊，利是内存是专门管理的，不用担心被挪用，降低数据库 OOM 风险。缺点是某些场景下可能对性能由负面影响。</p>
<p>在 PostgreSQL 启动前，您需要分配 <strong>足够多的</strong> 大页，浪费的部分可以使用 <code>pg-tune-hugepage</code> 脚本对其进行回收，不过此脚本仅 PostgreSQL 15+ 可用。</p>
<p>如果你的 PostgreSQL 已经在运行，你可以使用下面的办法启动大页（仅 PG15+ 可用）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sync<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">echo</span> <span style="color:#0000cf;font-weight:bold">3</span> &gt; /proc/sys/vm/drop_caches   <span style="color:#8f5902;font-style:italic"># 刷盘，释放系统缓存（请做好数据库性能受到冲击的准备）</span>
</span></span><span style="display:flex;"><span>sudo /pg/bin/pg-tune-hugepage             <span style="color:#8f5902;font-style:italic"># 将 nr_hugepages 写入 /etc/sysctl.d/hugepage.conf</span>
</span></span><span style="display:flex;"><span>pg restart &lt;cls&gt;                          <span style="color:#8f5902;font-style:italic"># 重启 postgres 以使用 hugepage</span>
</span></span></code></pre></div><hr>
<h2 id="如何确保故障转移中数据不丢失">如何确保故障转移中数据不丢失？</h2>
<blockquote>
<p>使用 <code>crit.yml</code> 参数模板，设置 <code>pg_rpo</code> 为 <code>0</code>，或<a href="/zh/docs/pgsql/admin#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4">配置集群</a>为同步提交模式。</p>
</blockquote>
<p>考虑使用 <a href="/zh/docs/pgsql/config#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93">同步备库</a> 和 <a href="/zh/docs/pgsql/config#%E6%B3%95%E5%AE%9A%E4%BA%BA%E6%95%B0%E6%8F%90%E4%BA%A4">法定多数提交</a> 来确保故障转移过程中的零数据丢失。</p>
<p>更多细节，可以参考 <a href="/zh/docs/setup/security#%E5%8F%AF%E7%94%A8%E6%80%A7">安全考量 - 可用性</a> 的相关介绍。</p>
<hr>
<h2 id="磁盘写满了如何抢救">磁盘写满了如何抢救？</h2>
<p>如果磁盘写满了，连 Shell 命令都无法执行，<code>rm -rf /pg/dummy</code> 可以释放一些救命空间。</p>
<p>默认情况下，<a href="/zh/docs/reference/param#pg_dummy_filesize"><code>pg_dummy_filesize</code></a> 设置为 <code>64MB</code>。在生产环境中，建议将其增加到 <code>8GB</code> 或更大。</p>
<p>它将被放置在 PGSQL 主数据磁盘上的 <code>/pg/dummy</code> 路径下。你可以删除该文件以释放一些紧急空间：至少可以让你在该节点上运行一些 shell 脚本来进一步回收其他空间。</p>
<hr>
<h2 id="当集群数据已经损坏时如何创建副本">当集群数据已经损坏时如何创建副本？</h2>
<p>Pigsty 在所有实例的 patroni 配置中设置了 <code>cloneform: true</code> 标签，标记该实例可用于创建副本。</p>
<p>如果某个实例有损坏的数据文件，导致创建新副本的时候出错中断，那么你可以设置 <code>clonefrom: false</code> 来避免从损坏的实例中拉取数据。具体操作如下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ vi /pg/bin/patroni.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tags:
</span></span><span style="display:flex;"><span>  nofailover: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  clonefrom: <span style="color:#204a87">true</span>      <span style="color:#8f5902;font-style:italic"># ----------&gt; change to false</span>
</span></span><span style="display:flex;"><span>  noloadbalance: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  nosync: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  version:  <span style="color:#4e9a06">&#39;15&#39;</span>
</span></span><span style="display:flex;"><span>  spec: <span style="color:#4e9a06">&#39;4C.8G.50G&#39;</span>
</span></span><span style="display:flex;"><span>  conf: <span style="color:#4e9a06">&#39;oltp.yml&#39;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>$ systemctl reload patroni    <span style="color:#8f5902;font-style:italic"># 重新加载 Patroni 配置</span>
</span></span></code></pre></div><hr>
<h2 id="postgresql-监控的性能损耗如何">PostgreSQL 监控的性能损耗如何？</h2>
<p>一个常规 PostgreSQL 实例抓取耗时大约 200ms。抓取间隔默认为 10 秒，对于一个生产多核数据库实例来说几乎微不足道。</p>
<p>请注意，Pigsty 默认开启了库内对象监控，所以如果您的数据库内有数以十万计的表/索引对象，抓取可能耗时会增加到几秒。</p>
<p>您可以修改 Prometheus 的抓取频率，请确保一点：抓取周期应当显著高于一次抓取的时长。</p>
<hr>
<h2 id="如何监控一个现存的-postgresql-实例">如何监控一个现存的 PostgreSQL 实例？</h2>
<p>在 <a href="/zh/docs/pgsql/monitor">PGSQL Monitor</a> 中提供了详细的监控配置说明。</p>
<hr>
<h2 id="如何手工从-prometheus-中移除-postgresql-监控对象">如何手工从 Prometheus 中移除 PostgreSQL 监控对象？</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql-rm.yml -t prometheus -l &lt;cls&gt;     <span style="color:#8f5902;font-style:italic"># 将集群 &#39;cls&#39; 的所有实例从 prometheus 中移除</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgmon-rm &lt;ins&gt;     <span style="color:#8f5902;font-style:italic"># 用于从 Prometheus 中移除单个实例 &#39;ins&#39; 的监控对象，特别适合移除添加的外部实例</span>
</span></span></code></pre></div>
</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Mail" aria-label="Mail">
    <a target="_blank" rel="noopener" href="mailto:rh@vonng.com" aria-label="Mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Vonng/pigsty" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://twitter.com/GobeUncleWang" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="WeChat" aria-label="WeChat">
    <a target="_blank" rel="noopener" href="/img/pigsty/pigsty-cc.jpg" aria-label="WeChat">
      <i class="fa fa-comment"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Discord" aria-label="Discord">
    <a target="_blank" rel="noopener" href="https://discord.gg/wDzt5VyWEz" aria-label="Discord">
      <i class="fab fa-discord"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Telegram" aria-label="Telegram">
    <a target="_blank" rel="noopener" href="https://t.me/joinchat/gV9zfZraNPM3YjFh" aria-label="Telegram">
      <i class="fab fa-telegram"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2018&ndash;2024
    <span class="td-footer__authors">Ruohang Feng</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span></span><span class="ms-2"><a href="https://vonng.com/en/" target="_blank" rel="noopener">@Vonng</a></span>
<br><span>Pigsty® distributed under <a href="/docs/about/license" target="_blank" rel="noopener">AGPLv3</a></span>
<br><span class="ms-2"><a href="/docs/about/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
<span><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">浙ICP备15016890号</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.248655eb216150e39da254c2f7aa5357805d0ec66bdb741b591cd35fb5f629ab.js" integrity="sha256-JIZV6yFhUOOdolTC96pTV4BdDsZr23QbWRzTX7X2Kas=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
