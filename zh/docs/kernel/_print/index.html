<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="/zh/docs/kernel/">
<link rel="alternate" type="application/rss&#43;xml" href="/zh/docs/kernel/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>内核：PGSQL | Pigsty</title>
<meta name="description" content="如何在 Pigsty 中使用其他 PostgreSQL 内核分支？例如 Citus， Babelfish，IvorySQL， PolarDB 与 Neon">
<meta property="og:title" content="内核：PGSQL" />
<meta property="og:description" content="如何在 Pigsty 中使用其他 PostgreSQL 内核分支？例如 Citus， Babelfish，IvorySQL， PolarDB 与 Neon" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/zh/docs/kernel/" />

<meta itemprop="name" content="内核：PGSQL">
<meta itemprop="description" content="如何在 Pigsty 中使用其他 PostgreSQL 内核分支？例如 Citus， Babelfish，IvorySQL， PolarDB 与 Neon"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="内核：PGSQL"/>
<meta name="twitter:description" content="如何在 Pigsty 中使用其他 PostgreSQL 内核分支？例如 Citus， Babelfish，IvorySQL， PolarDB 与 Neon"/>




<link rel="preload" href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" as="style">
<link href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="/js/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LG1V9WTKGE');
}
</script>
  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/zh/"><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class="navbar-brand__name">Pigsty</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/zh/docs/"><i class='fa-solid fa-book'></i><span>文档</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/zh/blog/"><i class="fas fa-blog"></i><span>博客</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/Vonng/pigsty/" target="_blank" rel="noopener"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-language"></i>中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/docs/kernel/">English</a></li>
    </ul>
</div>
</li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.223b25cbca956773c67248ce39bab5b2.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/zh/docs/kernel/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">内核：PGSQL</h1>
<div class="lead">如何在 Pigsty 中使用其他 PostgreSQL 内核分支？例如 Citus， Babelfish，IvorySQL， PolarDB 与 Neon</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-1a7a34e956a00ba21a0bda7a65a13269">Citus (Distributive)</a></li>


    
  
    
    
	
<li>2: <a href="#pg-c07c8fe46183ed562301b41033998686">Babelfish (MSSQL)</a></li>


    
  
    
    
	
<li>3: <a href="#pg-cd3a97cb8e8be2f2db28d114fe918f9c">IvorySQL (Oracle)</a></li>


    
  
    
    
	
<li>4: <a href="#pg-e9444969fe5469879c2afc7db4af9eeb">PolarDB PG (RAC)</a></li>


    
  
    
    
	
<li>5: <a href="#pg-b091dbe5668f0761767fa9359d7638e1">PolarDB O(racle)</a></li>


    
  
    
    
	
<li>6: <a href="#pg-73b38c6d44013724535510c32940a5d2">PostgresML (AI/ML)</a></li>


    
  
    
    
	
<li>7: <a href="#pg-f74dd81ba7f50361f73dc87e6ed6daf3">Supabase (Firebase)</a></li>


    
  
    
    
	
<li>8: <a href="#pg-0a6512885669a2f1cdcdf701791e9975">Greenplum (MPP)</a></li>


    
  
    
    
	
<li>9: <a href="#pg-d3ea86d3a671be7a0a3ca5118e6c9f24">Cloudberry (MPP)</a></li>


    
  
    
    
	
<li>10: <a href="#pg-3b91cd1a5acbaacbd620223d3edc1416">Neon (Serverless)</a></li>


    
  

    </ul>


<div class="content">
      <p>在 Pigsty 中，您可以使用不同 “<strong>风味</strong>” 的 PostgreSQL 分支替换 “原生PG内核”，实现特殊的功能与效果。</p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1a7a34e956a00ba21a0bda7a65a13269">1 - Citus (Distributive)</h1>
    <div class="lead">使用 Pigsty 部署原生高可用的 Citus 水平分片集群，将 PostgreSQL 无缝伸缩到多套分片并加速 OLTP/OLAP 查询。</div>
	<p>Pigsty 原生支持 Citus。这是一个基于原生 PostgreSQL 内核的分布式水平扩展插件。</p>
<p><img src="/img/pigsty/citus.jpg"></p>
<hr>
<h2 id="安装">安装</h2>
<p>Citus 是一个 PostgreSQL <a href="/zh/docs/pgext/olap/citus">扩展插件</a>，可以按照标准插件安装的流程，在原生 PostgreSQL 集群上加装启用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_extension -e <span style="color:#4e9a06">&#39;{&#34;pg_extensions&#34;:[&#34;citus&#34;]}&#39;</span>
</span></span></code></pre></div><hr>
<h2 id="配置">配置</h2>
<p>要定义一个 citus 集群，您需要指定以下参数：</p>
<ul>
<li><a href="/zh/docs/reference/param#pg_mode"><code>pg_mode</code></a> 必须设置为 <code>citus</code>，而不是默认的 <code>pgsql</code></li>
<li>在每个分片集群上都必须定义分片名 <a href="/zh/docs/reference/param#pg_shard"><code>pg_shard</code></a> 和分片号 <a href="/zh/docs/reference/param#pg_group"><code>pg_group</code></a></li>
<li>必须定义 <a href="/zh/docs/reference/param#patroni_citus_db"><code>patroni_citus_db</code></a> 来指定由 Patroni 管理的数据库。</li>
<li>如果您想使用 <a href="/zh/docs/reference/param#pg_dbsu"><code>pg_dbsu</code></a> 的 <code>postgres</code> 而不是默认的 <a href="/zh/docs/reference/param#pg_admin_username"><code>pg_admin_username</code></a> 来执行管理命令，那么 <a href="/zh/docs/reference/param#pg_dbsu_password"><code>pg_dbsu_password</code></a> 必须设置为非空的纯文本密码</li>
</ul>
<p>此外，还需要额外的 hba 规则，允许从本地和其他数据节点进行 SSL 访问。</p>
<p>您可以将每个 Citus 集群分别定义为独立的分组，像标准的 PostgreSQL 集群一样，如 <a href="https://github.com/Vonng/pigsty/blob/main/conf/citus.yml"><code>conf/dbms/citus.yml</code></a> 所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">all</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">children</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-citus0</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus 0号分片</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-citus0 , pg_group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-citus1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus 1号分片</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-citus1 , pg_group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-citus2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus 2号分片</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-citus2 , pg_group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-citus3</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus 3号分片</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">10.10.10.14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-citus3 , pg_group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#8f5902;font-style:italic"># 所有 Citus 集群的全局参数</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">citus                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pgsql 集群模式需要设置为： citus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_shard</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-citus               </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus 水平分片名称： pg-citus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">patroni_citus_db</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus 数据库名称：meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_dbsu_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Postgres</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 如果使用 dbsu ，那么需要为其配置一个密码</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_meta ,password: DBUser.Meta ,pgbouncer: true ,roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_admin ] } ]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: meta ,extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">citus }, { name: postgis }, { name: timescaledb } ] } ]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32 ,auth: ssl ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all user ssl access from localhost&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user: &#39;all&#39; ,db: all  ,addr: intra        ,auth: ssl ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all user ssl access from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>您也可以在一个分组内指定所有 Citus 集群成员的身份参数，如 <a href="https://github.com/Vonng/pigsty/blob/main/conf/prod.yml#L298"><code>prod.yml</code></a> 所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#==========================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg-citus: 10 node citus cluster (5 x primary-replica pair)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#==========================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-citus</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus group</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.50</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.60/24 ,pg_seq: 0, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.51</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.60/24 ,pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.52</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.61/24 ,pg_seq: 0, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.53</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.61/24 ,pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.54</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.62/24 ,pg_seq: 0, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.55</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.62/24 ,pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.56</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_group: 3, pg_cluster: pg-citus3 ,pg_vip_address: 10.10.10.63/24 ,pg_seq: 0, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.57</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_group: 3, pg_cluster: pg-citus3 ,pg_vip_address: 10.10.10.63/24 ,pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.58</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_group: 4, pg_cluster: pg-citus4 ,pg_vip_address: 10.10.10.64/24 ,pg_seq: 0, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.59</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_group: 4, pg_cluster: pg-citus4 ,pg_vip_address: 10.10.10.64/24 ,pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_mode: citus                    # pgsql cluster mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">citus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_shard: pg-citus                # citus shard name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-citus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_primary_db</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># primary database used by citus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_dbsu_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Postgres</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># all dbsu password access for citus cluster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_vip_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_vip_interface</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">eth1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;citus postgis timescaledb pgvector&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_libs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;citus, timescaledb, pg_stat_statements, auto_explain&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus will be added by patroni automatically</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: test ,password: test ,pgbouncer: true ,roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_admin ] } ]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: test ,owner: test ,extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">citus }, { name: postgis } ] } ]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user: &#39;all&#39; ,db: all  ,addr: 10.10.10.0/24 ,auth: trust ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;trust citus cluster members&#39;</span><span style="color:#f8f8f8;text-decoration:underline">        </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32  ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all user ssl access from localhost&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user: &#39;all&#39; ,db: all  ,addr: intra         ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all user ssl access from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="使用">使用</h2>
<p>您可以像访问普通集群一样，访问任意节点：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pgbench -i postgres://test:test@pg-citus0/test
</span></span><span style="display:flex;"><span>pgbench -nv -P1 -T1000 -c <span style="color:#0000cf;font-weight:bold">2</span> postgres://test:test@pg-citus0/test
</span></span></code></pre></div><p>默认情况下，您对某一个 Shard 进行的变更，都只发生在这套集群上，而不会同步到其他 Shard。</p>
<p>如果你希望将写入分布到所有 Shard，可以使用 Citus 提供的 API 函数，将表标记为：</p>
<ul>
<li><strong>水平分片表</strong>（自动分区，需要指定分区键）</li>
<li><strong>引用表</strong>（全量复制：不需要指定分区键）：</li>
</ul>
<p>从 Citus 11.2 开始，任何 Citus 数据库节点都可以扮演协调者的角色，即，任意一个主节点都可以写入：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql -h pg-citus0 -d <span style="color:#204a87">test</span> -c <span style="color:#4e9a06">&#34;SELECT create_distributed_table(&#39;pgbench_accounts&#39;, &#39;aid&#39;); SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_accounts&#39;);&#34;</span>
</span></span><span style="display:flex;"><span>psql -h pg-citus0 -d <span style="color:#204a87">test</span> -c <span style="color:#4e9a06">&#34;SELECT create_reference_table(&#39;pgbench_branches&#39;)         ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_branches&#39;);&#34;</span>
</span></span><span style="display:flex;"><span>psql -h pg-citus0 -d <span style="color:#204a87">test</span> -c <span style="color:#4e9a06">&#34;SELECT create_reference_table(&#39;pgbench_history&#39;)          ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_history&#39;);&#34;</span>
</span></span><span style="display:flex;"><span>psql -h pg-citus0 -d <span style="color:#204a87">test</span> -c <span style="color:#4e9a06">&#34;SELECT create_reference_table(&#39;pgbench_tellers&#39;)          ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_tellers&#39;);&#34;</span>
</span></span></code></pre></div><p>将表分布出去后，你可以在其他节点上也访问到：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql -h pg-citus1 -d <span style="color:#204a87">test</span> -c <span style="color:#4e9a06">&#39;\dt+&#39;</span>
</span></span></code></pre></div><p>例如，全表扫描可以发现执行计划已经变为分布式计划</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@meta-1:~$ psql -h pg-citus3 -d <span style="color:#204a87">test</span> -c <span style="color:#4e9a06">&#39;explain select * from pgbench_accounts&#39;</span>
</span></span><span style="display:flex;"><span>                                               QUERY PLAN
</span></span><span style="display:flex;"><span>---------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span> Custom Scan <span style="color:#ce5c00;font-weight:bold">(</span>Citus Adaptive<span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span>0.00..0.00 <span style="color:#000">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">100000</span> <span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span>352<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   Task Count: <span style="color:#0000cf;font-weight:bold">32</span>
</span></span><span style="display:flex;"><span>   Tasks Shown: One of <span style="color:#0000cf;font-weight:bold">32</span>
</span></span><span style="display:flex;"><span>   -&gt;  Task
</span></span><span style="display:flex;"><span>         Node: <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">=</span>10.10.10.52 <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">5432</span> <span style="color:#000">dbname</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">test</span>
</span></span><span style="display:flex;"><span>         -&gt;  Seq Scan on pgbench_accounts_102008 pgbench_accounts  <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">cost</span><span style="color:#ce5c00;font-weight:bold">=</span>0.00..81.66 <span style="color:#000">rows</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3066</span> <span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">=</span>97<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6</span> rows<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>你可以从几个不同的主节点发起写入：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pgbench -nv -P1 -T1000 -c <span style="color:#0000cf;font-weight:bold">2</span> postgres://test:test@pg-citus1/test
</span></span><span style="display:flex;"><span>pgbench -nv -P1 -T1000 -c <span style="color:#0000cf;font-weight:bold">2</span> postgres://test:test@pg-citus2/test
</span></span><span style="display:flex;"><span>pgbench -nv -P1 -T1000 -c <span style="color:#0000cf;font-weight:bold">2</span> postgres://test:test@pg-citus3/test
</span></span><span style="display:flex;"><span>pgbench -nv -P1 -T1000 -c <span style="color:#0000cf;font-weight:bold">2</span> postgres://test:test@pg-citus4/test
</span></span></code></pre></div><p>当某个节点出现故障时，Patroni 提供的原生高可用支持会将备用节点提升并自动顶上。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">test</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic"># select * from  pg_dist_node;</span>
</span></span><span style="display:flex;"><span> nodeid <span style="color:#000;font-weight:bold">|</span> groupid <span style="color:#000;font-weight:bold">|</span>  nodename   <span style="color:#000;font-weight:bold">|</span> nodeport <span style="color:#000;font-weight:bold">|</span> noderack <span style="color:#000;font-weight:bold">|</span> hasmetadata <span style="color:#000;font-weight:bold">|</span> isactive <span style="color:#000;font-weight:bold">|</span> noderole <span style="color:#000;font-weight:bold">|</span> nodecluster <span style="color:#000;font-weight:bold">|</span> metadatasynced <span style="color:#000;font-weight:bold">|</span> shouldhaveshards
</span></span><span style="display:flex;"><span>--------+---------+-------------+----------+----------+-------------+----------+----------+-------------+----------------+------------------
</span></span><span style="display:flex;"><span>      <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>       <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">|</span> 10.10.10.51 <span style="color:#000;font-weight:bold">|</span>     <span style="color:#0000cf;font-weight:bold">5432</span> <span style="color:#000;font-weight:bold">|</span> default  <span style="color:#000;font-weight:bold">|</span> t           <span style="color:#000;font-weight:bold">|</span> t        <span style="color:#000;font-weight:bold">|</span> primary  <span style="color:#000;font-weight:bold">|</span> default     <span style="color:#000;font-weight:bold">|</span> t              <span style="color:#000;font-weight:bold">|</span> f
</span></span><span style="display:flex;"><span>      <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">|</span>       <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">|</span> 10.10.10.54 <span style="color:#000;font-weight:bold">|</span>     <span style="color:#0000cf;font-weight:bold">5432</span> <span style="color:#000;font-weight:bold">|</span> default  <span style="color:#000;font-weight:bold">|</span> t           <span style="color:#000;font-weight:bold">|</span> t        <span style="color:#000;font-weight:bold">|</span> primary  <span style="color:#000;font-weight:bold">|</span> default     <span style="color:#000;font-weight:bold">|</span> t              <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span>      <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#000;font-weight:bold">|</span>       <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span> 10.10.10.52 <span style="color:#000;font-weight:bold">|</span>     <span style="color:#0000cf;font-weight:bold">5432</span> <span style="color:#000;font-weight:bold">|</span> default  <span style="color:#000;font-weight:bold">|</span> t           <span style="color:#000;font-weight:bold">|</span> t        <span style="color:#000;font-weight:bold">|</span> primary  <span style="color:#000;font-weight:bold">|</span> default     <span style="color:#000;font-weight:bold">|</span> t              <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span>      <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000;font-weight:bold">|</span>       <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#000;font-weight:bold">|</span> 10.10.10.58 <span style="color:#000;font-weight:bold">|</span>     <span style="color:#0000cf;font-weight:bold">5432</span> <span style="color:#000;font-weight:bold">|</span> default  <span style="color:#000;font-weight:bold">|</span> t           <span style="color:#000;font-weight:bold">|</span> t        <span style="color:#000;font-weight:bold">|</span> primary  <span style="color:#000;font-weight:bold">|</span> default     <span style="color:#000;font-weight:bold">|</span> t              <span style="color:#000;font-weight:bold">|</span> t
</span></span><span style="display:flex;"><span>      <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#000;font-weight:bold">|</span>       <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000;font-weight:bold">|</span> 10.10.10.56 <span style="color:#000;font-weight:bold">|</span>     <span style="color:#0000cf;font-weight:bold">5432</span> <span style="color:#000;font-weight:bold">|</span> default  <span style="color:#000;font-weight:bold">|</span> t           <span style="color:#000;font-weight:bold">|</span> t        <span style="color:#000;font-weight:bold">|</span> primary  <span style="color:#000;font-weight:bold">|</span> default     <span style="color:#000;font-weight:bold">|</span> t              <span style="color:#000;font-weight:bold">|</span> t
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c07c8fe46183ed562301b41033998686">2 - Babelfish (MSSQL)</h1>
    <div class="lead">使用 WiltonDB 与 Babelfish 创建兼容 Microsoft SQL Server 的 PostgreSQL 数据库集群！（线缆协议级仿真）</div>
	<blockquote>
<p><a href="https://babelfishpg.org/">Babelfish</a> 是一个基于 PostgreSQL 的 MSSQL（微软 SQL Server）兼容性方案，由 AWS 开源。</p>
</blockquote>
<hr>
<h2 id="概览">概览</h2>
<p>Pigsty 允许用户使用 Babelfish 与 WiltonDB 创建 Microsoft SQL Server 兼容的 PostgreSQL 集群！</p>
<ul>
<li><a href="https://babelfishpg.org/">Babelfish</a> ：一个由 AWS 开源的 MSSQL（微软 SQL Server） 兼容性扩展插件</li>
<li><a href="https://github.com/wiltondb/wiltondb">WiltonDB</a>： 一个专注于整合 Babelfish 的 PostgreSQL 内核发行版</li>
</ul>
<p>Babelfish 是一个 PostgreSQL 扩展插件，但只能在一个轻微修改过的 PostgreSQL 内核 Fork 上工作，WiltonDB 在 EL/Ubuntu 系统下提供了编译后的Fork内核二进制与扩展二进制软件包。</p>
<p>Pigsty 可以使用 WiltonDB 替代原生的 PostgreSQL 内核，提供开箱即用的 MSSQL 兼容集群。MSSQL集群使用与管理与一套标准的 PostgreSQL 15 集群并无差异，您可以使用 Pigsty 提供的所有功能，如高可用，备份，监控等。</p>
<p>WiltonDB 带有包括 Babelfish 在内的若干扩展插件，但不能使用 PostgreSQL 原生的扩展插件。</p>
<p>MSSQL 兼容集群在启动后，除了监听 PostgreSQL 默认的端口外，还会监听 MSSQL 默认的 <code>1433</code> 端口，并在此端口上通过 TDS WireProtocol 提供 MSSQL 服务。
您可以用任何 MSSQL 客户端连接至 Pigsty 提供的 MSSQL 服务，如 SQL Server Management Studio，或者使用 <code>sqlcmd</code> 命令行工具。</p>
<p><img src="/img/pigsty/mssql.jpg"></p>
<hr>
<h2 id="安装">安装</h2>
<p>WiltonDB 与原生 PostgreSQL 内核冲突，在一个节点上只能选择一个内核进行安装，使用以下命令在线安装 WiltonDB 内核。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./node.yml -t node_install -e <span style="color:#4e9a06">&#39;{&#34;node_repo_modules&#34;:&#34;local,mssql&#34;,&#34;node_packages&#34;:[&#34;wiltondb&#34;]}&#39;</span>
</span></span></code></pre></div><p>请注意 WiltonDB 仅在 EL 与 Ubuntu 系统中可用，目前尚未提供 Debian 支持。</p>
<p>Pigsty 专业版提供了 WiltonDB 离线安装包，可以从本地软件源安装 WiltonDB。</p>
<hr>
<h2 id="配置">配置</h2>
<p>在安装部署 MSSQL 模块时需要特别注意以下事项：</p>
<ul>
<li>WiltonDB 在 EL (7/8/9) 和 Ubuntu (20.04/22.04) 中可用，<strong>在Debian系统中不可用</strong>。</li>
<li>WiltonDB 目前基于 PostgreSQL 15 编译，因此需要指定 <code>pg_version: 15</code> 。</li>
<li>在 EL 系统上，<code>wiltondb</code> 的二进制默认会安装至 <code>/usr/bin/</code> 目录下，而在 Ubuntu 系统上则会安装至 <code>/usr/lib/postgresql/15/bin/</code> 目录下，与 PostgreSQL 官方二进制文件放置位置不同。</li>
<li>WiltonDB 兼容模式下，HBA 密码认证规则需要使用 <code>md5</code>，而非 <code>scram-sha-256</code>，因此需要覆盖 Pigsty 默认的 HBA 规则集，将 SQL Server 需要的 <code>md5</code> 认证规则，插入到 <code>dbrole_readonly</code> 通配认证规则之前</li>
<li>WiltonDB 只能针对一个首要数据库启用，同时应当指定一个用户作为 Babelfish 的超级用户，以便 Babelfish 可以创建数据库和用户，默认为 <code>mssql</code> 与 <code>dbuser_myssql</code>，如果修改，请一并修改 <code>files/mssql.sql</code> 中的用户。</li>
<li>WiltonDB TDS 线缆协议兼容插件 <code>babelfishpg_tds</code> 需要在 <code>shared_preload_libraries</code> 中启用</li>
<li>WiltonDB 扩展在启用后，默认监听 MSSQL <code>1433</code> 端口，您可以覆盖 Pigsty 默认的服务定义，将 <code>primary</code> 与 <code>replica</code> 服务的端口指向 <code>1433</code> ，而不是 <code>5432</code> / <code>6432</code> 端口。</li>
</ul>
<p>以下参数需要针对 MSSQL 数据库集群进行配置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#----------------------------------#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># PGSQL &amp; MSSQL (Babelfish &amp; Wilton)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#----------------------------------#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># PG Installation</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">node_repo_modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">local,node,mssql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># add mssql and os upstream repos</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mssql                     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Microsoft SQL Server Compatible Mode</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_libs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;babelfishpg_tds, pg_stat_statements, auto_explain&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># add timescaledb to shared_preload_libraries</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#8f5902;font-style:italic"># The current WiltonDB major version is 15</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_packages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">wiltondb                       </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># install forked version of postgresql with babelfishpg support</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">patroni pgbouncer pgbackrest pg_exporter pgbadger vip-manager</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># do not install any vanilla postgresql extensions</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># PG Provision</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_default_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic"># overwrite default HBA rules for babelfish cluster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: local     ,auth: ident ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu access via local os user ident&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: local     ,auth: ident ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu replication from local os ident&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator replication from localhost&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator replication from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: postgres    ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator postgres db from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor from localhost with password&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: infra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor from infra host with password&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin @ infra nodes with pwd &amp; ssl&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: world     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin @ everywhere with ssl &amp; pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#204a87;font-weight:bold">user: dbuser_mssql ,db: mssql       ,addr: intra     ,auth: md5   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow mssql dbsu intranet access&#39;</span><span style="color:#f8f8f8;text-decoration:underline">     </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- use md5 auth method for mssql user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pgbouncer read/write via local socket&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;read/write biz user via password&#39;</span><span style="color:#f8f8f8;text-decoration:underline">     </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow etl offline tasks from intranet&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_default_services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># route primary &amp; replica service to mssql port 1433</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: primary ,port: 5433 ,dest: 1433  ,check: /primary   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: replica ,port: 5434 ,dest: 1433  ,check: /read-only ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">, backup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">, backup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>您可以定义 MSSQL 业务数据库与业务用户：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#----------------------------------#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pgsql (singleton on current node)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#----------------------------------#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># this is an example single-node postgres cluster with postgis &amp; timescaledb installed, with one biz database &amp; two biz users</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;---- primary instance with read-write capability</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#8f5902;font-style:italic"># create MSSQL superuser</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_mssql ,password: DBUser.MSSQL ,superuser: true, pgbouncer: true ,roles: [dbrole_admin], comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">superuser &amp; owner for babelfish  }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_primary_db</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mssql               </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># use `mssql` as the primary sql server database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mssql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">baseline</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mssql.sql            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># init babelfish database &amp; user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uuid-ossp          }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">babelfishpg_common }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">babelfishpg_tsql   }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">babelfishpg_tds    }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">babelfishpg_money  }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_hint_plan       }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system_stats       }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tds_fdw            }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_mssql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">&#39;babelfishpg_tsql.migration_mode&#39; </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;multi-db&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">babelfish cluster, a MSSQL compatible pg cluster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="访问">访问</h2>
<p>您可以使用任何 SQL Server 兼容的客户端工具来访问这个数据库集群。</p>
<p>Microsoft 提供了 <a href="https://learn.microsoft.com/en-us/sql/tools/sqlcmd/sqlcmd-use-utility?view=sql-server-ver16">sqlcmd</a> 作为官方的命令行工具。</p>
<p>除此之外，他们还提供了一个 Go 语言版本的命令行工具 <a href="https://github.com/microsoft/go-sqlcmd">go-sqlcmd</a>。</p>
<p>安装 <code>go-sqlcmd</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -LO https://github.com/microsoft/go-sqlcmd/releases/download/v1.4.0/sqlcmd-v1.4.0-linux-amd64.tar.bz2
</span></span><span style="display:flex;"><span>tar xjvf sqlcmd-v1.4.0-linux-amd64.tar.bz2
</span></span><span style="display:flex;"><span>sudo mv sqlcmd* /usr/bin/
</span></span></code></pre></div><p>快速上手 <code>go-sqlcmd</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sqlcmd -S 10.10.10.10,1433 -U dbuser_mssql -P DBUser.MSSQL
</span></span><span style="display:flex;"><span>1&gt; <span style="color:#204a87;font-weight:bold">select</span> @@version
</span></span><span style="display:flex;"><span>2&gt; go
</span></span><span style="display:flex;"><span>version                                                                                                                                                                                                                                                         
</span></span><span style="display:flex;"><span>----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>Babelfish <span style="color:#204a87;font-weight:bold">for</span> PostgreSQL with SQL Server Compatibility - 12.0.2000.8
</span></span><span style="display:flex;"><span>Oct <span style="color:#0000cf;font-weight:bold">22</span> <span style="color:#0000cf;font-weight:bold">2023</span> 17:48:32
</span></span><span style="display:flex;"><span>Copyright <span style="color:#ce5c00;font-weight:bold">(</span>c<span style="color:#ce5c00;font-weight:bold">)</span> Amazon Web Services
</span></span><span style="display:flex;"><span>PostgreSQL 15.4 <span style="color:#ce5c00;font-weight:bold">(</span>EL 1:15.4.wiltondb3.3_2-2.el8<span style="color:#ce5c00;font-weight:bold">)</span> on x86_64-redhat-linux-gnu <span style="color:#ce5c00;font-weight:bold">(</span>Babelfish 3.3.0<span style="color:#ce5c00;font-weight:bold">)</span>                                        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> row affected<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>使用 Pigsty 提供的服务机制，可以使用 5433 / 5434 端口始终连接到主库/从库上的 1433 端口。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 访问任意集群成员上的 5433 端口，指向主库上的 1433 MSSQL 端口 </span>
</span></span><span style="display:flex;"><span>sqlcmd -S 10.10.10.11,5433 -U dbuser_mssql -P DBUser.MSSQL
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 访问任意集群成员上的 5434 端口，指向任意可读库上的 1433 MSSQL 端口</span>
</span></span><span style="display:flex;"><span>sqlcmd -S 10.10.10.11,5434 -U dbuser_mssql -P DBUser.MSSQL
</span></span></code></pre></div><hr>
<h2 id="扩展">扩展</h2>
<p>绝大多数 <strong>PGSQL</strong> 模块的 <a href="/zh/docs/pgext/list"><strong>扩展插件</strong></a>（非纯 SQL 类）都无法直接在 MSSQL 模块的 WiltonDB 内核上使用，需要重新编译。</p>
<p>目前 WiltonDB 自带了以下扩展插件，除了 PostgreSQL Contrib 扩展，四个 BabelfishPG 核心扩展之外，还提供了 <code>pg_hint_pan</code>，<code>tds_fdw</code>，以及 <code>system_stats</code> 三个第三方扩展。</p>
<table>
<thead>
<tr>
<th>扩展名</th>
<th>版本</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>dblink</td>
<td>1.2</td>
<td>connect to other PostgreSQL databases from within a database</td>
</tr>
<tr>
<td>adminpack</td>
<td>2.1</td>
<td>administrative functions for PostgreSQL</td>
</tr>
<tr>
<td>dict_int</td>
<td>1.0</td>
<td>text search dictionary template for integers</td>
</tr>
<tr>
<td>intagg</td>
<td>1.1</td>
<td>integer aggregator and enumerator (obsolete)</td>
</tr>
<tr>
<td>dict_xsyn</td>
<td>1.0</td>
<td>text search dictionary template for extended synonym processing</td>
</tr>
<tr>
<td>amcheck</td>
<td>1.3</td>
<td>functions for verifying relation integrity</td>
</tr>
<tr>
<td>autoinc</td>
<td>1.0</td>
<td>functions for autoincrementing fields</td>
</tr>
<tr>
<td>bloom</td>
<td>1.0</td>
<td>bloom access method - signature file based index</td>
</tr>
<tr>
<td>fuzzystrmatch</td>
<td>1.1</td>
<td>determine similarities and distance between strings</td>
</tr>
<tr>
<td>intarray</td>
<td>1.5</td>
<td>functions, operators, and index support for 1-D arrays of integers</td>
</tr>
<tr>
<td>btree_gin</td>
<td>1.3</td>
<td>support for indexing common datatypes in GIN</td>
</tr>
<tr>
<td>btree_gist</td>
<td>1.7</td>
<td>support for indexing common datatypes in GiST</td>
</tr>
<tr>
<td>hstore</td>
<td>1.8</td>
<td>data type for storing sets of (key, value) pairs</td>
</tr>
<tr>
<td>hstore_plperl</td>
<td>1.0</td>
<td>transform between hstore and plperl</td>
</tr>
<tr>
<td>isn</td>
<td>1.2</td>
<td>data types for international product numbering standards</td>
</tr>
<tr>
<td>hstore_plperlu</td>
<td>1.0</td>
<td>transform between hstore and plperlu</td>
</tr>
<tr>
<td>jsonb_plperl</td>
<td>1.0</td>
<td>transform between jsonb and plperl</td>
</tr>
<tr>
<td>citext</td>
<td>1.6</td>
<td>data type for case-insensitive character strings</td>
</tr>
<tr>
<td>jsonb_plperlu</td>
<td>1.0</td>
<td>transform between jsonb and plperlu</td>
</tr>
<tr>
<td>jsonb_plpython3u</td>
<td>1.0</td>
<td>transform between jsonb and plpython3u</td>
</tr>
<tr>
<td>cube</td>
<td>1.5</td>
<td>data type for multidimensional cubes</td>
</tr>
<tr>
<td>hstore_plpython3u</td>
<td>1.0</td>
<td>transform between hstore and plpython3u</td>
</tr>
<tr>
<td>earthdistance</td>
<td>1.1</td>
<td>calculate great-circle distances on the surface of the Earth</td>
</tr>
<tr>
<td>lo</td>
<td>1.1</td>
<td>Large Object maintenance</td>
</tr>
<tr>
<td>file_fdw</td>
<td>1.0</td>
<td>foreign-data wrapper for flat file access</td>
</tr>
<tr>
<td>insert_username</td>
<td>1.0</td>
<td>functions for tracking who changed a table</td>
</tr>
<tr>
<td>ltree</td>
<td>1.2</td>
<td>data type for hierarchical tree-like structures</td>
</tr>
<tr>
<td>ltree_plpython3u</td>
<td>1.0</td>
<td>transform between ltree and plpython3u</td>
</tr>
<tr>
<td>pg_walinspect</td>
<td>1.0</td>
<td>functions to inspect contents of PostgreSQL Write-Ahead Log</td>
</tr>
<tr>
<td>moddatetime</td>
<td>1.0</td>
<td>functions for tracking last modification time</td>
</tr>
<tr>
<td>old_snapshot</td>
<td>1.0</td>
<td>utilities in support of old_snapshot_threshold</td>
</tr>
<tr>
<td>pgcrypto</td>
<td>1.3</td>
<td>cryptographic functions</td>
</tr>
<tr>
<td>pgrowlocks</td>
<td>1.2</td>
<td>show row-level locking information</td>
</tr>
<tr>
<td>pageinspect</td>
<td>1.11</td>
<td>inspect the contents of database pages at a low level</td>
</tr>
<tr>
<td>pg_surgery</td>
<td>1.0</td>
<td>extension to perform surgery on a damaged relation</td>
</tr>
<tr>
<td>seg</td>
<td>1.4</td>
<td>data type for representing line segments or floating-point intervals</td>
</tr>
<tr>
<td>pgstattuple</td>
<td>1.5</td>
<td>show tuple-level statistics</td>
</tr>
<tr>
<td>pg_buffercache</td>
<td>1.3</td>
<td>examine the shared buffer cache</td>
</tr>
<tr>
<td>pg_freespacemap</td>
<td>1.2</td>
<td>examine the free space map (FSM)</td>
</tr>
<tr>
<td>postgres_fdw</td>
<td>1.1</td>
<td>foreign-data wrapper for remote PostgreSQL servers</td>
</tr>
<tr>
<td>pg_prewarm</td>
<td>1.2</td>
<td>prewarm relation data</td>
</tr>
<tr>
<td>tcn</td>
<td>1.0</td>
<td>Triggered change notifications</td>
</tr>
<tr>
<td>pg_trgm</td>
<td>1.6</td>
<td>text similarity measurement and index searching based on trigrams</td>
</tr>
<tr>
<td>xml2</td>
<td>1.1</td>
<td>XPath querying and XSLT</td>
</tr>
<tr>
<td>refint</td>
<td>1.0</td>
<td>functions for implementing referential integrity (obsolete)</td>
</tr>
<tr>
<td>pg_visibility</td>
<td>1.2</td>
<td>examine the visibility map (VM) and page-level visibility info</td>
</tr>
<tr>
<td>pg_stat_statements</td>
<td>1.10</td>
<td>track planning and execution statistics of all SQL statements executed</td>
</tr>
<tr>
<td>sslinfo</td>
<td>1.2</td>
<td>information about SSL certificates</td>
</tr>
<tr>
<td>tablefunc</td>
<td>1.0</td>
<td>functions that manipulate whole tables, including crosstab</td>
</tr>
<tr>
<td>tsm_system_rows</td>
<td>1.0</td>
<td>TABLESAMPLE method which accepts number of rows as a limit</td>
</tr>
<tr>
<td>tsm_system_time</td>
<td>1.0</td>
<td>TABLESAMPLE method which accepts time in milliseconds as a limit</td>
</tr>
<tr>
<td>unaccent</td>
<td>1.1</td>
<td>text search dictionary that removes accents</td>
</tr>
<tr>
<td>uuid-ossp</td>
<td>1.1</td>
<td>generate universally unique identifiers (UUIDs)</td>
</tr>
<tr>
<td>plpgsql</td>
<td>1.0</td>
<td>PL/pgSQL procedural language</td>
</tr>
<tr>
<td>babelfishpg_money</td>
<td>1.1.0</td>
<td>babelfishpg_money</td>
</tr>
<tr>
<td>system_stats</td>
<td>2.0</td>
<td>EnterpriseDB system statistics for PostgreSQL</td>
</tr>
<tr>
<td>tds_fdw</td>
<td>2.0.3</td>
<td>Foreign data wrapper for querying a TDS database (Sybase or Microsoft SQL Server)</td>
</tr>
<tr>
<td>babelfishpg_common</td>
<td>3.3.3</td>
<td>Transact SQL Datatype Support</td>
</tr>
<tr>
<td>babelfishpg_tds</td>
<td>1.0.0</td>
<td>TDS protocol extension</td>
</tr>
<tr>
<td>pg_hint_plan</td>
<td>1.5.1</td>
<td></td>
</tr>
<tr>
<td>babelfishpg_tsql</td>
<td>3.3.1</td>
<td>Transact SQL compatibility</td>
</tr>
</tbody>
</table>
<ul>
<li>Pigsty 专业版提供离线安装 MSSQL 兼容模块的能力</li>
<li>Pigsty <a href="/zh/docs/about/service/"><strong>专业版</strong></a> 提供可选的 MSSQL 兼容内核扩展移植定制服务，可以将 PGSQL 模块中可用的 <a href="/zh/docs/pgext/list"><strong>扩展</strong></a> 移植到 MSSQL 集群中。</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cd3a97cb8e8be2f2db28d114fe918f9c">3 - IvorySQL (Oracle)</h1>
    <div class="lead">使用瀚高开源的 IvorySQL 内核，基于 PostgreSQL 集群实现 Oracle 语法/PLSQL 兼容性。</div>
	<p><a href="https://www.ivorysql.org/">IvorySQL</a> 是一个开源的，旨在基于 PG 提供 “Oracle兼容性” 的 PostgreSQL 内核分支。</p>
<hr>
<h2 id="概览">概览</h2>
<p>IvorySQL 内核支持在 Pigsty 开源版本中提供，您的服务器需要互联网访问，直接从 IvorySQL 的官方仓库下载相关软件包。</p>
<p>请注意，直接将 IvorySQL 加入 Pigsty 默认软件仓库中会影响原生 PostgreSQL 内核的安装。Pigsty 专业版提供包括 IvorySQL 内核在内的离线安装解决方案。</p>
<p><img src="/img/pigsty/ivory.jpg"></p>
<p>当前 IvorySQL 的最新版本为 <strong>3.4</strong>，对应的 PostgreSQL 版本为 <strong>16.4</strong>。请注意，IvorySQL 当前仅在 EL8/EL9 上可用。</p>
<blockquote>
<p>最后一个支持 EL7 的 IvorySQL 版本为 3.3，对应 PostgreSQL 16.3</p>
</blockquote>
<hr>
<h2 id="安装">安装</h2>
<p>如果您的环境有互联网访问，您可以使用以下方式，直接将 IvorySQL 仓库加入到节点上，然后执行 PGSQL 剧本进行安装</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./node.yml -t node_repo -e <span style="color:#4e9a06">&#39;{&#34;node_repo_modules&#34;:&#34;local,node,pgsql,ivory&#34;}&#39;</span>
</span></span></code></pre></div><hr>
<h2 id="配置">配置</h2>
<p>以下参数需要针对 IvorySQL 数据库集群进行配置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#----------------------------------#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Ivory SQL Configuration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#----------------------------------#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">node_repo_modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">local,node,pgsql,ivory </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># add ivorysql upstream repo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ivory                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># IvorySQL Oracle Compatible Mode</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_packages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;ivorysql patroni pgbouncer pgbackrest pg_exporter pgbadger vip-manager&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_libs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;liboracle_parser, pg_stat_statements, auto_explain&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># do not install any vanilla postgresql extensions</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><blockquote>
<p>使用 Oracle 兼容性模式时，需要动态加载 <code>liboracle_parser</code> 扩展插件。</p>
</blockquote>
<hr>
<h2 id="客户端访问">客户端访问</h2>
<p>IvorySQL 等效于 PostgreSQL 16，任何兼容 PostgreSQL 线缆协议的客户端工具都可以访问 IvorySQL 集群。</p>
<hr>
<h2 id="扩展列表">扩展列表</h2>
<p>绝大多数 <strong>PGSQL</strong> 模块的 <a href="/zh/docs/pgext/list"><strong>扩展插件</strong></a> （非纯 SQL 类）都无法直接在 IvorySQL 内核上使用，如果需要使用，请针对新内核从源码重新编译安装。</p>
<p>目前 IvorySQL 内核自带了以下 <strong>101</strong> 个扩展插件。</p>
<table>
<thead>
<tr>
<th>name</th>
<th>version</th>
<th>comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>hstore_plperl</td>
<td>1.0</td>
<td>transform between hstore and plperl</td>
</tr>
<tr>
<td>plisql</td>
<td>1.0</td>
<td>PL/iSQL procedural language</td>
</tr>
<tr>
<td>hstore_plperlu</td>
<td>1.0</td>
<td>transform between hstore and plperlu</td>
</tr>
<tr>
<td>adminpack</td>
<td>2.1</td>
<td>administrative functions for PostgreSQL</td>
</tr>
<tr>
<td>insert_username</td>
<td>1.0</td>
<td>functions for tracking who changed a table</td>
</tr>
<tr>
<td>dblink</td>
<td>1.2</td>
<td>connect to other PostgreSQL databases from within a database</td>
</tr>
<tr>
<td>dict_int</td>
<td>1.0</td>
<td>text search dictionary template for integers</td>
</tr>
<tr>
<td>amcheck</td>
<td>1.3</td>
<td>functions for verifying relation integrity</td>
</tr>
<tr>
<td>intagg</td>
<td>1.1</td>
<td>integer aggregator and enumerator (obsolete)</td>
</tr>
<tr>
<td>autoinc</td>
<td>1.0</td>
<td>functions for autoincrementing fields</td>
</tr>
<tr>
<td>bloom</td>
<td>1.0</td>
<td>bloom access method - signature file based index</td>
</tr>
<tr>
<td>dict_xsyn</td>
<td>1.0</td>
<td>text search dictionary template for extended synonym processing</td>
</tr>
<tr>
<td>btree_gin</td>
<td>1.3</td>
<td>support for indexing common datatypes in GIN</td>
</tr>
<tr>
<td>earthdistance</td>
<td>1.1</td>
<td>calculate great-circle distances on the surface of the Earth</td>
</tr>
<tr>
<td>file_fdw</td>
<td>1.0</td>
<td>foreign-data wrapper for flat file access</td>
</tr>
<tr>
<td>fuzzystrmatch</td>
<td>1.2</td>
<td>determine similarities and distance between strings</td>
</tr>
<tr>
<td>btree_gist</td>
<td>1.7</td>
<td>support for indexing common datatypes in GiST</td>
</tr>
<tr>
<td>intarray</td>
<td>1.5</td>
<td>functions, operators, and index support for 1-D arrays of integers</td>
</tr>
<tr>
<td>citext</td>
<td>1.6</td>
<td>data type for case-insensitive character strings</td>
</tr>
<tr>
<td>isn</td>
<td>1.2</td>
<td>data types for international product numbering standards</td>
</tr>
<tr>
<td>ivorysql_ora</td>
<td>1.0</td>
<td>Oracle Compatible extenison on Postgres Database</td>
</tr>
<tr>
<td>jsonb_plperl</td>
<td>1.0</td>
<td>transform between jsonb and plperl</td>
</tr>
<tr>
<td>cube</td>
<td>1.5</td>
<td>data type for multidimensional cubes</td>
</tr>
<tr>
<td>dummy_index_am</td>
<td>1.0</td>
<td>dummy_index_am - index access method template</td>
</tr>
<tr>
<td>dummy_seclabel</td>
<td>1.0</td>
<td>Test code for SECURITY LABEL feature</td>
</tr>
<tr>
<td>hstore</td>
<td>1.8</td>
<td>data type for storing sets of (key, value) pairs</td>
</tr>
<tr>
<td>jsonb_plperlu</td>
<td>1.0</td>
<td>transform between jsonb and plperlu</td>
</tr>
<tr>
<td>lo</td>
<td>1.1</td>
<td>Large Object maintenance</td>
</tr>
<tr>
<td>ltree</td>
<td>1.2</td>
<td>data type for hierarchical tree-like structures</td>
</tr>
<tr>
<td>moddatetime</td>
<td>1.0</td>
<td>functions for tracking last modification time</td>
</tr>
<tr>
<td>old_snapshot</td>
<td>1.0</td>
<td>utilities in support of old_snapshot_threshold</td>
</tr>
<tr>
<td>ora_btree_gin</td>
<td>1.0</td>
<td>support for indexing oracle datatypes in GIN</td>
</tr>
<tr>
<td>pg_trgm</td>
<td>1.6</td>
<td>text similarity measurement and index searching based on trigrams</td>
</tr>
<tr>
<td>ora_btree_gist</td>
<td>1.0</td>
<td>support for oracle indexing common datatypes in GiST</td>
</tr>
<tr>
<td>pg_visibility</td>
<td>1.2</td>
<td>examine the visibility map (VM) and page-level visibility info</td>
</tr>
<tr>
<td>pg_walinspect</td>
<td>1.1</td>
<td>functions to inspect contents of PostgreSQL Write-Ahead Log</td>
</tr>
<tr>
<td>pgcrypto</td>
<td>1.3</td>
<td>cryptographic functions</td>
</tr>
<tr>
<td>pgstattuple</td>
<td>1.5</td>
<td>show tuple-level statistics</td>
</tr>
<tr>
<td>pageinspect</td>
<td>1.12</td>
<td>inspect the contents of database pages at a low level</td>
</tr>
<tr>
<td>pgrowlocks</td>
<td>1.2</td>
<td>show row-level locking information</td>
</tr>
<tr>
<td>pg_buffercache</td>
<td>1.4</td>
<td>examine the shared buffer cache</td>
</tr>
<tr>
<td>pg_stat_statements</td>
<td>1.10</td>
<td>track planning and execution statistics of all SQL statements executed</td>
</tr>
<tr>
<td>pg_freespacemap</td>
<td>1.2</td>
<td>examine the free space map (FSM)</td>
</tr>
<tr>
<td>plsample</td>
<td>1.0</td>
<td>PL/Sample</td>
</tr>
<tr>
<td>pg_prewarm</td>
<td>1.2</td>
<td>prewarm relation data</td>
</tr>
<tr>
<td>pg_surgery</td>
<td>1.0</td>
<td>extension to perform surgery on a damaged relation</td>
</tr>
<tr>
<td>seg</td>
<td>1.4</td>
<td>data type for representing line segments or floating-point intervals</td>
</tr>
<tr>
<td>postgres_fdw</td>
<td>1.1</td>
<td>foreign-data wrapper for remote PostgreSQL servers</td>
</tr>
<tr>
<td>refint</td>
<td>1.0</td>
<td>functions for implementing referential integrity (obsolete)</td>
</tr>
<tr>
<td>test_ext_req_schema1</td>
<td>1.0</td>
<td>Required extension to be referenced</td>
</tr>
<tr>
<td>spgist_name_ops</td>
<td>1.0</td>
<td>Test opclass for SP-GiST</td>
</tr>
<tr>
<td>test_ext_req_schema2</td>
<td>1.0</td>
<td>Test schema referencing of required extensions</td>
</tr>
<tr>
<td>test_shm_mq</td>
<td>1.0</td>
<td>Test code for shared memory message queues</td>
</tr>
<tr>
<td>sslinfo</td>
<td>1.2</td>
<td>information about SSL certificates</td>
</tr>
<tr>
<td>test_slru</td>
<td>1.0</td>
<td>Test code for SLRU</td>
</tr>
<tr>
<td>tablefunc</td>
<td>1.0</td>
<td>functions that manipulate whole tables, including crosstab</td>
</tr>
<tr>
<td>bool_plperl</td>
<td>1.0</td>
<td>transform between bool and plperl</td>
</tr>
<tr>
<td>tcn</td>
<td>1.0</td>
<td>Triggered change notifications</td>
</tr>
<tr>
<td>test_ext_req_schema3</td>
<td>1.0</td>
<td>Test schema referencing of 2 required extensions</td>
</tr>
<tr>
<td>test_bloomfilter</td>
<td>1.0</td>
<td>Test code for Bloom filter library</td>
</tr>
<tr>
<td>test_copy_callbacks</td>
<td>1.0</td>
<td>Test code for COPY callbacks</td>
</tr>
<tr>
<td>test_ginpostinglist</td>
<td>1.0</td>
<td>Test code for ginpostinglist.c</td>
</tr>
<tr>
<td>test_custom_rmgrs</td>
<td>1.0</td>
<td>Test code for custom WAL resource managers</td>
</tr>
<tr>
<td>test_integerset</td>
<td>1.0</td>
<td>Test code for integerset</td>
</tr>
<tr>
<td>test_ddl_deparse</td>
<td>1.0</td>
<td>Test code for DDL deparse feature</td>
</tr>
<tr>
<td>tsm_system_rows</td>
<td>1.0</td>
<td>TABLESAMPLE method which accepts number of rows as a limit</td>
</tr>
<tr>
<td>test_ext1</td>
<td>1.0</td>
<td>Test extension 1</td>
</tr>
<tr>
<td>tsm_system_time</td>
<td>1.0</td>
<td>TABLESAMPLE method which accepts time in milliseconds as a limit</td>
</tr>
<tr>
<td>test_ext2</td>
<td>1.0</td>
<td>Test extension 2</td>
</tr>
<tr>
<td>unaccent</td>
<td>1.1</td>
<td>text search dictionary that removes accents</td>
</tr>
<tr>
<td>test_ext3</td>
<td>1.0</td>
<td>Test extension 3</td>
</tr>
<tr>
<td>test_ext4</td>
<td>1.0</td>
<td>Test extension 4</td>
</tr>
<tr>
<td>uuid-ossp</td>
<td>1.1</td>
<td>generate universally unique identifiers (UUIDs)</td>
</tr>
<tr>
<td>test_ext5</td>
<td>1.0</td>
<td>Test extension 5</td>
</tr>
<tr>
<td>worker_spi</td>
<td>1.0</td>
<td>Sample background worker</td>
</tr>
<tr>
<td>test_ext6</td>
<td>1.0</td>
<td>test_ext6</td>
</tr>
<tr>
<td>test_lfind</td>
<td>1.0</td>
<td>Test code for optimized linear search functions</td>
</tr>
<tr>
<td>xml2</td>
<td>1.1</td>
<td>XPath querying and XSLT</td>
</tr>
<tr>
<td>test_ext7</td>
<td>1.0</td>
<td>Test extension 7</td>
</tr>
<tr>
<td>plpgsql</td>
<td>1.0</td>
<td>PL/pgSQL procedural language</td>
</tr>
<tr>
<td>test_ext8</td>
<td>1.0</td>
<td>Test extension 8</td>
</tr>
<tr>
<td>test_parser</td>
<td>1.0</td>
<td>example of a custom parser for full-text search</td>
</tr>
<tr>
<td>test_pg_dump</td>
<td>1.0</td>
<td>Test pg_dump with an extension</td>
</tr>
<tr>
<td>test_ext_cine</td>
<td>1.0</td>
<td>Test extension using CREATE IF NOT EXISTS</td>
</tr>
<tr>
<td>test_predtest</td>
<td>1.0</td>
<td>Test code for optimizer/util/predtest.c</td>
</tr>
<tr>
<td>test_ext_cor</td>
<td>1.0</td>
<td>Test extension using CREATE OR REPLACE</td>
</tr>
<tr>
<td>test_rbtree</td>
<td>1.0</td>
<td>Test code for red-black tree library</td>
</tr>
<tr>
<td>test_ext_cyclic1</td>
<td>1.0</td>
<td>Test extension cyclic 1</td>
</tr>
<tr>
<td>test_ext_cyclic2</td>
<td>1.0</td>
<td>Test extension cyclic 2</td>
</tr>
<tr>
<td>test_ext_extschema</td>
<td>1.0</td>
<td>test @extschema@</td>
</tr>
<tr>
<td>test_regex</td>
<td>1.0</td>
<td>Test code for backend/regex/</td>
</tr>
<tr>
<td>test_ext_evttrig</td>
<td>1.0</td>
<td>Test extension - event trigger</td>
</tr>
<tr>
<td>bool_plperlu</td>
<td>1.0</td>
<td>transform between bool and plperlu</td>
</tr>
<tr>
<td>plperl</td>
<td>1.0</td>
<td>PL/Perl procedural language</td>
</tr>
<tr>
<td>plperlu</td>
<td>1.0</td>
<td>PL/PerlU untrusted procedural language</td>
</tr>
<tr>
<td>hstore_plpython3u</td>
<td>1.0</td>
<td>transform between hstore and plpython3u</td>
</tr>
<tr>
<td>jsonb_plpython3u</td>
<td>1.0</td>
<td>transform between jsonb and plpython3u</td>
</tr>
<tr>
<td>ltree_plpython3u</td>
<td>1.0</td>
<td>transform between ltree and plpython3u</td>
</tr>
<tr>
<td>plpython3u</td>
<td>1.0</td>
<td>PL/Python3U untrusted procedural language</td>
</tr>
<tr>
<td>pltcl</td>
<td>1.0</td>
<td>PL/Tcl procedural language</td>
</tr>
<tr>
<td>pltclu</td>
<td>1.0</td>
<td>PL/TclU untrusted procedural language</td>
</tr>
</tbody>
</table>
<p>请注意，Pigsty 不对使用 IvorySQL 内核承担任何质保责任，使用此内核遇到的任何问题与需求请联系原厂解决。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e9444969fe5469879c2afc7db4af9eeb">4 - PolarDB PG (RAC)</h1>
    <div class="lead">使用阿里云开源的 PolarDB for PostgreSQL 内核提供国产信创资质支持，与类似 Oracle RAC 的使用体验。</div>
	<hr>
<h2 id="概览">概览</h2>
<p>Pigsty 允许使用 PolarDB 创建带有 “国产化信创资质” 的 PostgreSQL 集群！</p>
<p>PolarDB for PostgreSQL 基本等效于 PostgreSQL 15，任何兼容 PostgreSQL 线缆协议的客户端工具都可以访问 PolarDB 集群。</p>
<p>Pigsty 的 PGSQL 仓库中提供了 EL7 / EL8 的 PolarDB PG 开源版安装包，但不会在 Pigsty 安装时下载到本地软件仓库。</p>
<p>如果您需要 PolarDB PG 的离线安装支持，请考虑我们的 <a href="/zh/docs/about/service">专业订阅服务</a></p>
<p><img src="/img/pigsty/polar.jpg"></p>
<hr>
<h2 id="安装">安装</h2>
<p>如果您的环境有互联网访问，您可以使用以下方式，直接将 Pigsty PGSQL 及依赖仓库加入到节点上，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">node_repo_modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">local,node,pgsql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>然后在 <code>pg_packages</code> 中，使用 <code>polardb</code> 替换原生的 <code>postgresql</code> 软件包。</p>
<hr>
<h2 id="配置">配置</h2>
<p>以下参数需要针对 PolarDB 数据库集群进行特殊配置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#----------------------------------#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># PGSQL &amp; PolarDB</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#----------------------------------#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_packages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;polardb patroni pgbouncer pgbackrest pg_exporter pgbadger vip-manager&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># do not install any vanilla postgresql extensions</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">polar                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># PolarDB Compatible Mode</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_default_roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># default roles and users in postgres cluster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_readonly  ,login: false ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for global read-only access     }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_offline   ,login: false ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for restricted read-only access }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for global read-write access }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for object creation }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: postgres     ,superuser: true  ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system superuser }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: replicator   ,superuser: true  ,replication: true ,roles: [pg_monitor, dbrole_readonly] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system replicator }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;- superuser is required for replication</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_monitor ,roles: [pg_monitor] ,pgbouncer: true ,parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql monitor user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这里特别注意，PolarDB PG 要求 <code>replicator</code> 复制用户为 Superuser，与原生 PG 不同。</p>
<hr>
<h2 id="扩展列表">扩展列表</h2>
<p>绝大多数 <strong>PGSQL</strong> 模块的 <a href="/zh/docs/pgext/list"><strong>扩展插件</strong></a> （非纯 SQL 类）都无法直接在 PolarDB 内核上使用，如果需要使用，请针对新内核从源码重新编译安装。</p>
<p>目前 PolarDB 内核自带了以下 <strong>61</strong> 个扩展插件，除去 Contrib 扩展外，提供的额外扩展包括：</p>
<ul>
<li><code>polar_csn</code> 1.0 :  polar_csn</li>
<li><code>polar_monitor</code> 1.2 :  examine the polardb information</li>
<li><code>polar_monitor_preload</code> 1.1 :  examine the polardb information</li>
<li><code>polar_parameter_check</code> 1.0 :  kernel extension for parameter validation</li>
<li><code>polar_px</code> 1.0 :  Parallel Execution extension</li>
<li><code>polar_stat_env</code> 1.0 :  env stat functions for PolarDB</li>
<li><code>polar_stat_sql</code> 1.3 :  Kernel statistics gathering, and sql plan nodes information gathering</li>
<li><code>polar_tde_utils</code> 1.0 :  Internal extension for TDE</li>
<li><code>polar_vfs</code> 1.0 :  polar_vfs</li>
<li><code>polar_worker</code> 1.0 :  polar_worker</li>
<li><code>timetravel</code> 1.0 : functions for implementing time travel</li>
<li><code>vector</code> 0.5.1   : vector data type and ivfflat and hnsw access methods</li>
<li><code>smlar</code> 1.0      : compute similary of any one-dimensional arrays</li>
</ul>
<p>PolarDB 可用的完整插件列表：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>version</th>
<th>comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>hstore_plpython2u</td>
<td>1.0</td>
<td>transform between hstore and plpython2u</td>
</tr>
<tr>
<td>dict_int</td>
<td>1.0</td>
<td>text search dictionary template for integers</td>
</tr>
<tr>
<td>adminpack</td>
<td>2.0</td>
<td>administrative functions for PostgreSQL</td>
</tr>
<tr>
<td>hstore_plpython3u</td>
<td>1.0</td>
<td>transform between hstore and plpython3u</td>
</tr>
<tr>
<td>amcheck</td>
<td>1.1</td>
<td>functions for verifying relation integrity</td>
</tr>
<tr>
<td>hstore_plpythonu</td>
<td>1.0</td>
<td>transform between hstore and plpythonu</td>
</tr>
<tr>
<td>autoinc</td>
<td>1.0</td>
<td>functions for autoincrementing fields</td>
</tr>
<tr>
<td>insert_username</td>
<td>1.0</td>
<td>functions for tracking who changed a table</td>
</tr>
<tr>
<td>bloom</td>
<td>1.0</td>
<td>bloom access method - signature file based index</td>
</tr>
<tr>
<td>file_fdw</td>
<td>1.0</td>
<td>foreign-data wrapper for flat file access</td>
</tr>
<tr>
<td>dblink</td>
<td>1.2</td>
<td>connect to other PostgreSQL databases from within a database</td>
</tr>
<tr>
<td>btree_gin</td>
<td>1.3</td>
<td>support for indexing common datatypes in GIN</td>
</tr>
<tr>
<td>fuzzystrmatch</td>
<td>1.1</td>
<td>determine similarities and distance between strings</td>
</tr>
<tr>
<td>lo</td>
<td>1.1</td>
<td>Large Object maintenance</td>
</tr>
<tr>
<td>intagg</td>
<td>1.1</td>
<td>integer aggregator and enumerator (obsolete)</td>
</tr>
<tr>
<td>btree_gist</td>
<td>1.5</td>
<td>support for indexing common datatypes in GiST</td>
</tr>
<tr>
<td>hstore</td>
<td>1.5</td>
<td>data type for storing sets of (key, value) pairs</td>
</tr>
<tr>
<td>intarray</td>
<td>1.2</td>
<td>functions, operators, and index support for 1-D arrays of integers</td>
</tr>
<tr>
<td>citext</td>
<td>1.5</td>
<td>data type for case-insensitive character strings</td>
</tr>
<tr>
<td>cube</td>
<td>1.4</td>
<td>data type for multidimensional cubes</td>
</tr>
<tr>
<td>hstore_plperl</td>
<td>1.0</td>
<td>transform between hstore and plperl</td>
</tr>
<tr>
<td>isn</td>
<td>1.2</td>
<td>data types for international product numbering standards</td>
</tr>
<tr>
<td>jsonb_plperl</td>
<td>1.0</td>
<td>transform between jsonb and plperl</td>
</tr>
<tr>
<td>dict_xsyn</td>
<td>1.0</td>
<td>text search dictionary template for extended synonym processing</td>
</tr>
<tr>
<td>hstore_plperlu</td>
<td>1.0</td>
<td>transform between hstore and plperlu</td>
</tr>
<tr>
<td>earthdistance</td>
<td>1.1</td>
<td>calculate great-circle distances on the surface of the Earth</td>
</tr>
<tr>
<td>pg_prewarm</td>
<td>1.2</td>
<td>prewarm relation data</td>
</tr>
<tr>
<td>jsonb_plperlu</td>
<td>1.0</td>
<td>transform between jsonb and plperlu</td>
</tr>
<tr>
<td>pg_stat_statements</td>
<td>1.6</td>
<td>track execution statistics of all SQL statements executed</td>
</tr>
<tr>
<td>jsonb_plpython2u</td>
<td>1.0</td>
<td>transform between jsonb and plpython2u</td>
</tr>
<tr>
<td>jsonb_plpython3u</td>
<td>1.0</td>
<td>transform between jsonb and plpython3u</td>
</tr>
<tr>
<td>jsonb_plpythonu</td>
<td>1.0</td>
<td>transform between jsonb and plpythonu</td>
</tr>
<tr>
<td>pg_trgm</td>
<td>1.4</td>
<td>text similarity measurement and index searching based on trigrams</td>
</tr>
<tr>
<td>pgstattuple</td>
<td>1.5</td>
<td>show tuple-level statistics</td>
</tr>
<tr>
<td>ltree</td>
<td>1.1</td>
<td>data type for hierarchical tree-like structures</td>
</tr>
<tr>
<td>ltree_plpython2u</td>
<td>1.0</td>
<td>transform between ltree and plpython2u</td>
</tr>
<tr>
<td>pg_visibility</td>
<td>1.2</td>
<td>examine the visibility map (VM) and page-level visibility info</td>
</tr>
<tr>
<td>ltree_plpython3u</td>
<td>1.0</td>
<td>transform between ltree and plpython3u</td>
</tr>
<tr>
<td>ltree_plpythonu</td>
<td>1.0</td>
<td>transform between ltree and plpythonu</td>
</tr>
<tr>
<td>seg</td>
<td>1.3</td>
<td>data type for representing line segments or floating-point intervals</td>
</tr>
<tr>
<td>moddatetime</td>
<td>1.0</td>
<td>functions for tracking last modification time</td>
</tr>
<tr>
<td>pgcrypto</td>
<td>1.3</td>
<td>cryptographic functions</td>
</tr>
<tr>
<td>pgrowlocks</td>
<td>1.2</td>
<td>show row-level locking information</td>
</tr>
<tr>
<td>pageinspect</td>
<td>1.7</td>
<td>inspect the contents of database pages at a low level</td>
</tr>
<tr>
<td>pg_buffercache</td>
<td>1.3</td>
<td>examine the shared buffer cache</td>
</tr>
<tr>
<td>pg_freespacemap</td>
<td>1.2</td>
<td>examine the free space map (FSM)</td>
</tr>
<tr>
<td>tcn</td>
<td>1.0</td>
<td>Triggered change notifications</td>
</tr>
<tr>
<td>plperl</td>
<td>1.0</td>
<td>PL/Perl procedural language</td>
</tr>
<tr>
<td>uuid-ossp</td>
<td>1.1</td>
<td>generate universally unique identifiers (UUIDs)</td>
</tr>
<tr>
<td>plperlu</td>
<td>1.0</td>
<td>PL/PerlU untrusted procedural language</td>
</tr>
<tr>
<td>refint</td>
<td>1.0</td>
<td>functions for implementing referential integrity (obsolete)</td>
</tr>
<tr>
<td>xml2</td>
<td>1.1</td>
<td>XPath querying and XSLT</td>
</tr>
<tr>
<td>plpgsql</td>
<td>1.0</td>
<td>PL/pgSQL procedural language</td>
</tr>
<tr>
<td>plpython3u</td>
<td>1.0</td>
<td>PL/Python3U untrusted procedural language</td>
</tr>
<tr>
<td>pltcl</td>
<td>1.0</td>
<td>PL/Tcl procedural language</td>
</tr>
<tr>
<td>pltclu</td>
<td>1.0</td>
<td>PL/TclU untrusted procedural language</td>
</tr>
<tr>
<td>polar_csn</td>
<td>1.0</td>
<td>polar_csn</td>
</tr>
<tr>
<td>sslinfo</td>
<td>1.2</td>
<td>information about SSL certificates</td>
</tr>
<tr>
<td>polar_monitor</td>
<td>1.2</td>
<td>examine the polardb information</td>
</tr>
<tr>
<td>polar_monitor_preload</td>
<td>1.1</td>
<td>examine the polardb information</td>
</tr>
<tr>
<td>polar_parameter_check</td>
<td>1.0</td>
<td>kernel extension for parameter validation</td>
</tr>
<tr>
<td>polar_px</td>
<td>1.0</td>
<td>Parallel Execution extension</td>
</tr>
<tr>
<td>tablefunc</td>
<td>1.0</td>
<td>functions that manipulate whole tables, including crosstab</td>
</tr>
<tr>
<td>polar_stat_env</td>
<td>1.0</td>
<td>env stat functions for PolarDB</td>
</tr>
<tr>
<td>smlar</td>
<td>1.0</td>
<td>compute similary of any one-dimensional arrays</td>
</tr>
<tr>
<td>timetravel</td>
<td>1.0</td>
<td>functions for implementing time travel</td>
</tr>
<tr>
<td>tsm_system_rows</td>
<td>1.0</td>
<td>TABLESAMPLE method which accepts number of rows as a limit</td>
</tr>
<tr>
<td>polar_stat_sql</td>
<td>1.3</td>
<td>Kernel statistics gathering, and sql plan nodes information gathering</td>
</tr>
<tr>
<td>tsm_system_time</td>
<td>1.0</td>
<td>TABLESAMPLE method which accepts time in milliseconds as a limit</td>
</tr>
<tr>
<td>polar_tde_utils</td>
<td>1.0</td>
<td>Internal extension for TDE</td>
</tr>
<tr>
<td>polar_vfs</td>
<td>1.0</td>
<td>polar_vfs</td>
</tr>
<tr>
<td>polar_worker</td>
<td>1.0</td>
<td>polar_worker</td>
</tr>
<tr>
<td>unaccent</td>
<td>1.1</td>
<td>text search dictionary that removes accents</td>
</tr>
<tr>
<td>postgres_fdw</td>
<td>1.0</td>
<td>foreign-data wrapper for remote PostgreSQL servers</td>
</tr>
</tbody>
</table>
<ul>
<li>Pigsty 专业版提供 PolarDB 离线安装支持，扩展插件编译支持，以及针对 PolarDB 集群进行专门适配的监控与管控支持。</li>
<li>Pigsty 与阿里云内核团队有合作，可以提供有偿内核兜底支持服务。</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b091dbe5668f0761767fa9359d7638e1">5 - PolarDB O(racle)</h1>
    <div class="lead">使用阿里云商业版本的 PolarDB for Oracle 内核（闭源，PG14，仅在特殊企业版定制中可用）</div>
	<p>Pigsty 允许使用 PolarDB 创建带有 “国产化信创资质” 的 PolarDB for Oracle 集群！</p>
<p>根据 【<a href="http://www.itsec.gov.cn/aqkkcp/cpgg/202312/t20231226_162074.html">安全可靠测评结果公告（2023年第1号）</a>】，附表三、集中式数据库。PolarDB v2.0 属于自主可控，安全可靠的国产信创数据库。</p>
<p>PolarDB for Oracle 是基于 PolarDB for PostgreSQL 进行二次开发的 Oracle 兼容版本，两者共用同一套内核，通过 <code>--compatibility-mode</code> 参数进行区分。</p>
<p>我们与阿里云内核团队合作，提供基于 PolarDB v2.0 内核与 Pigsty v3.0 RDS 的完整数据库解决方案，请联系销售咨询，或在阿里云市场自行采购。</p>
<p>PolarDB for Oracle 内核目前仅在 EL 系统中可用。</p>
<p><img src="/img/pigsty/polar.jpg"></p>
<hr>
<h2 id="扩展">扩展</h2>
<p>目前 PolarDB 2.0 (Oracle兼容) 内核自带了以下 <strong>188</strong> 个扩展插件：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>default_version</th>
<th>comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>cube</td>
<td>1.5</td>
<td>data type for multidimensional cubes</td>
</tr>
<tr>
<td>ip4r</td>
<td>2.4</td>
<td>NULL</td>
</tr>
<tr>
<td>adminpack</td>
<td>2.1</td>
<td>administrative functions for PostgreSQL</td>
</tr>
<tr>
<td>dict_xsyn</td>
<td>1.0</td>
<td>text search dictionary template for extended synonym processing</td>
</tr>
<tr>
<td>amcheck</td>
<td>1.4</td>
<td>functions for verifying relation integrity</td>
</tr>
<tr>
<td>autoinc</td>
<td>1.0</td>
<td>functions for autoincrementing fields</td>
</tr>
<tr>
<td>hstore</td>
<td>1.8</td>
<td>data type for storing sets of (key, value) pairs</td>
</tr>
<tr>
<td>bloom</td>
<td>1.0</td>
<td>bloom access method - signature file based index</td>
</tr>
<tr>
<td>earthdistance</td>
<td>1.1</td>
<td>calculate great-circle distances on the surface of the Earth</td>
</tr>
<tr>
<td>hstore_plperl</td>
<td>1.0</td>
<td>transform between hstore and plperl</td>
</tr>
<tr>
<td>bool_plperl</td>
<td>1.0</td>
<td>transform between bool and plperl</td>
</tr>
<tr>
<td>file_fdw</td>
<td>1.0</td>
<td>foreign-data wrapper for flat file access</td>
</tr>
<tr>
<td>bool_plperlu</td>
<td>1.0</td>
<td>transform between bool and plperlu</td>
</tr>
<tr>
<td>fuzzystrmatch</td>
<td>1.1</td>
<td>determine similarities and distance between strings</td>
</tr>
<tr>
<td>hstore_plperlu</td>
<td>1.0</td>
<td>transform between hstore and plperlu</td>
</tr>
<tr>
<td>btree_gin</td>
<td>1.3</td>
<td>support for indexing common datatypes in GIN</td>
</tr>
<tr>
<td>hstore_plpython2u</td>
<td>1.0</td>
<td>transform between hstore and plpython2u</td>
</tr>
<tr>
<td>btree_gist</td>
<td>1.6</td>
<td>support for indexing common datatypes in GiST</td>
</tr>
<tr>
<td>hll</td>
<td>2.17</td>
<td>type for storing hyperloglog data</td>
</tr>
<tr>
<td>hstore_plpython3u</td>
<td>1.0</td>
<td>transform between hstore and plpython3u</td>
</tr>
<tr>
<td>citext</td>
<td>1.6</td>
<td>data type for case-insensitive character strings</td>
</tr>
<tr>
<td>hstore_plpythonu</td>
<td>1.0</td>
<td>transform between hstore and plpythonu</td>
</tr>
<tr>
<td>hypopg</td>
<td>1.3.1</td>
<td>Hypothetical indexes for PostgreSQL</td>
</tr>
<tr>
<td>insert_username</td>
<td>1.0</td>
<td>functions for tracking who changed a table</td>
</tr>
<tr>
<td>dblink</td>
<td>1.2</td>
<td>connect to other PostgreSQL databases from within a database</td>
</tr>
<tr>
<td>decoderbufs</td>
<td>0.1.0</td>
<td>Logical decoding plugin that delivers WAL stream changes using a Protocol Buffer format</td>
</tr>
<tr>
<td>intagg</td>
<td>1.1</td>
<td>integer aggregator and enumerator (obsolete)</td>
</tr>
<tr>
<td>dict_int</td>
<td>1.0</td>
<td>text search dictionary template for integers</td>
</tr>
<tr>
<td>intarray</td>
<td>1.5</td>
<td>functions, operators, and index support for 1-D arrays of integers</td>
</tr>
<tr>
<td>isn</td>
<td>1.2</td>
<td>data types for international product numbering standards</td>
</tr>
<tr>
<td>jsonb_plperl</td>
<td>1.0</td>
<td>transform between jsonb and plperl</td>
</tr>
<tr>
<td>jsonb_plperlu</td>
<td>1.0</td>
<td>transform between jsonb and plperlu</td>
</tr>
<tr>
<td>jsonb_plpython2u</td>
<td>1.0</td>
<td>transform between jsonb and plpython2u</td>
</tr>
<tr>
<td>jsonb_plpython3u</td>
<td>1.0</td>
<td>transform between jsonb and plpython3u</td>
</tr>
<tr>
<td>jsonb_plpythonu</td>
<td>1.0</td>
<td>transform between jsonb and plpythonu</td>
</tr>
<tr>
<td>lo</td>
<td>1.1</td>
<td>Large Object maintenance</td>
</tr>
<tr>
<td>log_fdw</td>
<td>1.0</td>
<td>foreign-data wrapper for csvlog</td>
</tr>
<tr>
<td>ltree</td>
<td>1.2</td>
<td>data type for hierarchical tree-like structures</td>
</tr>
<tr>
<td>ltree_plpython2u</td>
<td>1.0</td>
<td>transform between ltree and plpython2u</td>
</tr>
<tr>
<td>ltree_plpython3u</td>
<td>1.0</td>
<td>transform between ltree and plpython3u</td>
</tr>
<tr>
<td>ltree_plpythonu</td>
<td>1.0</td>
<td>transform between ltree and plpythonu</td>
</tr>
<tr>
<td>moddatetime</td>
<td>1.0</td>
<td>functions for tracking last modification time</td>
</tr>
<tr>
<td>old_snapshot</td>
<td>1.0</td>
<td>utilities in support of old_snapshot_threshold</td>
</tr>
<tr>
<td>oracle_fdw</td>
<td>1.2</td>
<td>foreign data wrapper for Oracle access</td>
</tr>
<tr>
<td>oss_fdw</td>
<td>1.1</td>
<td>foreign-data wrapper for OSS access</td>
</tr>
<tr>
<td>pageinspect</td>
<td>2.1</td>
<td>inspect the contents of database pages at a low level</td>
</tr>
<tr>
<td>pase</td>
<td>0.0.1</td>
<td>ant ai similarity search</td>
</tr>
<tr>
<td>pg_bigm</td>
<td>1.2</td>
<td>text similarity measurement and index searching based on bigrams</td>
</tr>
<tr>
<td>pg_freespacemap</td>
<td>1.2</td>
<td>examine the free space map (FSM)</td>
</tr>
<tr>
<td>pg_hint_plan</td>
<td>1.4</td>
<td>controls execution plan with hinting phrases in comment of special form</td>
</tr>
<tr>
<td>pg_buffercache</td>
<td>1.5</td>
<td>examine the shared buffer cache</td>
</tr>
<tr>
<td>pg_prewarm</td>
<td>1.2</td>
<td>prewarm relation data</td>
</tr>
<tr>
<td>pg_repack</td>
<td>1.4.8-1</td>
<td>Reorganize tables in PostgreSQL databases with minimal locks</td>
</tr>
<tr>
<td>pg_sphere</td>
<td>1.0</td>
<td>spherical objects with useful functions, operators and index support</td>
</tr>
<tr>
<td>pg_cron</td>
<td>1.5</td>
<td>Job scheduler for PostgreSQL</td>
</tr>
<tr>
<td>pg_jieba</td>
<td>1.1.0</td>
<td>a parser for full-text search of Chinese</td>
</tr>
<tr>
<td>pg_stat_kcache</td>
<td>2.2.1</td>
<td>Kernel statistics gathering</td>
</tr>
<tr>
<td>pg_stat_statements</td>
<td>1.9</td>
<td>track planning and execution statistics of all SQL statements executed</td>
</tr>
<tr>
<td>pg_surgery</td>
<td>1.0</td>
<td>extension to perform surgery on a damaged relation</td>
</tr>
<tr>
<td>pg_trgm</td>
<td>1.6</td>
<td>text similarity measurement and index searching based on trigrams</td>
</tr>
<tr>
<td>pg_visibility</td>
<td>1.2</td>
<td>examine the visibility map (VM) and page-level visibility info</td>
</tr>
<tr>
<td>pg_wait_sampling</td>
<td>1.1</td>
<td>sampling based statistics of wait events</td>
</tr>
<tr>
<td>pgaudit</td>
<td>1.6.2</td>
<td>provides auditing functionality</td>
</tr>
<tr>
<td>pgcrypto</td>
<td>1.3</td>
<td>cryptographic functions</td>
</tr>
<tr>
<td>pgrowlocks</td>
<td>1.2</td>
<td>show row-level locking information</td>
</tr>
<tr>
<td>pgstattuple</td>
<td>1.5</td>
<td>show tuple-level statistics</td>
</tr>
<tr>
<td>pgtap</td>
<td>1.2.0</td>
<td>Unit testing for PostgreSQL</td>
</tr>
<tr>
<td>pldbgapi</td>
<td>1.1</td>
<td>server-side support for debugging PL/pgSQL functions</td>
</tr>
<tr>
<td>plperl</td>
<td>1.0</td>
<td>PL/Perl procedural language</td>
</tr>
<tr>
<td>plperlu</td>
<td>1.0</td>
<td>PL/PerlU untrusted procedural language</td>
</tr>
<tr>
<td>plpgsql</td>
<td>1.0</td>
<td>PL/pgSQL procedural language</td>
</tr>
<tr>
<td>plpython2u</td>
<td>1.0</td>
<td>PL/Python2U untrusted procedural language</td>
</tr>
<tr>
<td>plpythonu</td>
<td>1.0</td>
<td>PL/PythonU untrusted procedural language</td>
</tr>
<tr>
<td>plsql</td>
<td>1.0</td>
<td>Oracle compatible PL/SQL procedural language</td>
</tr>
<tr>
<td>pltcl</td>
<td>1.0</td>
<td>PL/Tcl procedural language</td>
</tr>
<tr>
<td>pltclu</td>
<td>1.0</td>
<td>PL/TclU untrusted procedural language</td>
</tr>
<tr>
<td>polar_bfile</td>
<td>1.0</td>
<td>The BFILE data type enables access to binary file LOBs that are stored in file systems outside Database</td>
</tr>
<tr>
<td>polar_bpe</td>
<td>1.0</td>
<td>polar_bpe</td>
</tr>
<tr>
<td>polar_builtin_cast</td>
<td>1.1</td>
<td>Internal extension for builtin casts</td>
</tr>
<tr>
<td>polar_builtin_funcs</td>
<td>2.0</td>
<td>implement polar builtin functions</td>
</tr>
<tr>
<td>polar_builtin_type</td>
<td>1.5</td>
<td>polar_builtin_type for PolarDB</td>
</tr>
<tr>
<td>polar_builtin_view</td>
<td>1.5</td>
<td>polar_builtin_view</td>
</tr>
<tr>
<td>polar_catalog</td>
<td>1.2</td>
<td>polardb pg extend catalog</td>
</tr>
<tr>
<td>polar_channel</td>
<td>1.0</td>
<td>polar_channel</td>
</tr>
<tr>
<td>polar_constraint</td>
<td>1.0</td>
<td>polar_constraint</td>
</tr>
<tr>
<td>polar_csn</td>
<td>1.0</td>
<td>polar_csn</td>
</tr>
<tr>
<td>polar_dba_views</td>
<td>1.0</td>
<td>polar_dba_views</td>
</tr>
<tr>
<td>polar_dbms_alert</td>
<td>1.2</td>
<td>implement polar_dbms_alert - supports asynchronous notification of database events.</td>
</tr>
<tr>
<td>polar_dbms_application_info</td>
<td>1.0</td>
<td>implement polar_dbms_application_info - record names of executing modules or transactions in the database.</td>
</tr>
<tr>
<td>polar_dbms_pipe</td>
<td>1.1</td>
<td>implements polar_dbms_pipe - package lets two or more sessions in the same instance communicate.</td>
</tr>
<tr>
<td>polar_dbms_aq</td>
<td>1.2</td>
<td>implement dbms_aq - provides an interface to Advanced Queuing.</td>
</tr>
<tr>
<td>polar_dbms_lob</td>
<td>1.3</td>
<td>implement dbms_lob - provides subprograms to operate on BLOBs, CLOBs, and NCLOBs.</td>
</tr>
<tr>
<td>polar_dbms_output</td>
<td>1.2</td>
<td>implement polar_dbms_output - enables you to send messages from stored procedures.</td>
</tr>
<tr>
<td>polar_dbms_lock</td>
<td>1.0</td>
<td>implement polar_dbms_lock - provides an interface to Oracle Lock Management services.</td>
</tr>
<tr>
<td>polar_dbms_aqadm</td>
<td>1.3</td>
<td>polar_dbms_aqadm - procedures to manage Advanced Queuing configuration and administration information.</td>
</tr>
<tr>
<td>polar_dbms_assert</td>
<td>1.0</td>
<td>implement polar_dbms_assert - provide an interface to validate properties of the input value.</td>
</tr>
<tr>
<td>polar_dbms_metadata</td>
<td>1.0</td>
<td>implement polar_dbms_metadata - provides a way for you to retrieve metadata from the database dictionary.</td>
</tr>
<tr>
<td>polar_dbms_random</td>
<td>1.0</td>
<td>implement polar_dbms_random - a built-in random number generator, not intended for cryptography</td>
</tr>
<tr>
<td>polar_dbms_crypto</td>
<td>1.1</td>
<td>implement dbms_crypto - provides an interface to encrypt and decrypt stored data.</td>
</tr>
<tr>
<td>polar_dbms_redact</td>
<td>1.0</td>
<td>implement polar_dbms_redact - provides an interface to mask data from queries by an application.</td>
</tr>
<tr>
<td>polar_dbms_debug</td>
<td>1.1</td>
<td>server-side support for debugging PL/SQL functions</td>
</tr>
<tr>
<td>polar_dbms_job</td>
<td>1.0</td>
<td>polar_dbms_job</td>
</tr>
<tr>
<td>polar_dbms_mview</td>
<td>1.1</td>
<td>implement polar_dbms_mview - enables to refresh materialized views.</td>
</tr>
<tr>
<td>polar_dbms_job_preload</td>
<td>1.0</td>
<td>polar_dbms_job_preload</td>
</tr>
<tr>
<td>polar_dbms_obfuscation_toolkit</td>
<td>1.1</td>
<td>implement polar_dbms_obfuscation_toolkit - enables an application to get data md5.</td>
</tr>
<tr>
<td>polar_dbms_rls</td>
<td>1.1</td>
<td>implement polar_dbms_rls - a fine-grained access control administrative built-in package</td>
</tr>
<tr>
<td>polar_multi_toast_utils</td>
<td>1.0</td>
<td>polar_multi_toast_utils</td>
</tr>
<tr>
<td>polar_dbms_session</td>
<td>1.2</td>
<td>implement polar_dbms_session - support to set preferences and security levels.</td>
</tr>
<tr>
<td>polar_odciconst</td>
<td>1.0</td>
<td>implement ODCIConst - Provide some built-in constants in Oracle.</td>
</tr>
<tr>
<td>polar_dbms_sql</td>
<td>1.2</td>
<td>implement polar_dbms_sql - provides an interface to execute dynamic SQL.</td>
</tr>
<tr>
<td>polar_osfs_toolkit</td>
<td>1.0</td>
<td>osfs library tools and functions extension</td>
</tr>
<tr>
<td>polar_dbms_stats</td>
<td>14.0</td>
<td>stabilize plans by fixing statistics</td>
</tr>
<tr>
<td>polar_monitor</td>
<td>1.5</td>
<td>monitor functions for PolarDB</td>
</tr>
<tr>
<td>polar_osfs_utils</td>
<td>1.0</td>
<td>osfs library utils extension</td>
</tr>
<tr>
<td>polar_dbms_utility</td>
<td>1.3</td>
<td>implement polar_dbms_utility - provides various utility subprograms.</td>
</tr>
<tr>
<td>polar_parameter_check</td>
<td>1.0</td>
<td>kernel extension for parameter validation</td>
</tr>
<tr>
<td>polar_dbms_xmldom</td>
<td>1.0</td>
<td>implement dbms_xmldom and dbms_xmlparser - support standard DOM interface and xml parser object</td>
</tr>
<tr>
<td>polar_parameter_manager</td>
<td>1.1</td>
<td>Extension to select parameters for manger.</td>
</tr>
<tr>
<td>polar_faults</td>
<td>1.0.0</td>
<td>simulate some database faults for end user or testing system.</td>
</tr>
<tr>
<td>polar_monitor_preload</td>
<td>1.1</td>
<td>examine the polardb information</td>
</tr>
<tr>
<td>polar_proxy_utils</td>
<td>1.0</td>
<td>Extension to provide operations about proxy.</td>
</tr>
<tr>
<td>polar_feature_utils</td>
<td>1.2</td>
<td>PolarDB feature utilization</td>
</tr>
<tr>
<td>polar_global_awr</td>
<td>1.0</td>
<td>PolarDB Global AWR Report</td>
</tr>
<tr>
<td>polar_publication</td>
<td>1.0</td>
<td>support polardb pg logical replication</td>
</tr>
<tr>
<td>polar_global_cache</td>
<td>1.0</td>
<td>polar_global_cache</td>
</tr>
<tr>
<td>polar_px</td>
<td>1.0</td>
<td>Parallel Execution extension</td>
</tr>
<tr>
<td>polar_serverless</td>
<td>1.0</td>
<td>polar serverless extension</td>
</tr>
<tr>
<td>polar_resource_manager</td>
<td>1.0</td>
<td>a background process that forcibly frees user session process memory</td>
</tr>
<tr>
<td>polar_sys_context</td>
<td>1.1</td>
<td>implement polar_sys_context - returns the value of parameter associated with the context namespace at the current instant.</td>
</tr>
<tr>
<td>polar_gpc</td>
<td>1.3</td>
<td>polar_gpc</td>
</tr>
<tr>
<td>polar_tde_utils</td>
<td>1.0</td>
<td>Internal extension for TDE</td>
</tr>
<tr>
<td>polar_gtt</td>
<td>1.1</td>
<td>polar_gtt</td>
</tr>
<tr>
<td>polar_utl_encode</td>
<td>1.2</td>
<td>implement polar_utl_encode - provides functions that encode RAW data into a standard encoded format</td>
</tr>
<tr>
<td>polar_htap</td>
<td>1.1</td>
<td>extension for PolarDB HTAP</td>
</tr>
<tr>
<td>polar_htap_db</td>
<td>1.0</td>
<td>extension for PolarDB HTAP database level operation</td>
</tr>
<tr>
<td>polar_io_stat</td>
<td>1.0</td>
<td>polar io stat in multi dimension</td>
</tr>
<tr>
<td>polar_utl_file</td>
<td>1.0</td>
<td>implement utl_file - support PL/SQL programs can read and write operating system text files</td>
</tr>
<tr>
<td>polar_ivm</td>
<td>1.0</td>
<td>polar_ivm</td>
</tr>
<tr>
<td>polar_sql_mapping</td>
<td>1.2</td>
<td>Record error sqls and mapping them to correct one</td>
</tr>
<tr>
<td>polar_stat_sql</td>
<td>1.0</td>
<td>Kernel statistics gathering, and sql plan nodes information gathering</td>
</tr>
<tr>
<td>tds_fdw</td>
<td>2.0.2</td>
<td>Foreign data wrapper for querying a TDS database (Sybase or Microsoft SQL Server)</td>
</tr>
<tr>
<td>xml2</td>
<td>1.1</td>
<td>XPath querying and XSLT</td>
</tr>
<tr>
<td>polar_upgrade_catalogs</td>
<td>1.1</td>
<td>Upgrade catalogs for old version instance</td>
</tr>
<tr>
<td>polar_utl_i18n</td>
<td>1.1</td>
<td>polar_utl_i18n</td>
</tr>
<tr>
<td>polar_utl_raw</td>
<td>1.0</td>
<td>implement utl_raw - provides SQL functions for manipulating RAW datatypes.</td>
</tr>
<tr>
<td>timescaledb</td>
<td>2.9.2</td>
<td>Enables scalable inserts and complex queries for time-series data</td>
</tr>
<tr>
<td>polar_vfs</td>
<td>1.0</td>
<td>polar virtual file system for different storage</td>
</tr>
<tr>
<td>polar_worker</td>
<td>1.0</td>
<td>polar_worker</td>
</tr>
<tr>
<td>postgres_fdw</td>
<td>1.1</td>
<td>foreign-data wrapper for remote PostgreSQL servers</td>
</tr>
<tr>
<td>refint</td>
<td>1.0</td>
<td>functions for implementing referential integrity (obsolete)</td>
</tr>
<tr>
<td>roaringbitmap</td>
<td>0.5</td>
<td>support for Roaring Bitmaps</td>
</tr>
<tr>
<td>tsm_system_time</td>
<td>1.0</td>
<td>TABLESAMPLE method which accepts time in milliseconds as a limit</td>
</tr>
<tr>
<td>vector</td>
<td>0.5.0</td>
<td>vector data type and ivfflat and hnsw access methods</td>
</tr>
<tr>
<td>rum</td>
<td>1.3</td>
<td>RUM index access method</td>
</tr>
<tr>
<td>unaccent</td>
<td>1.1</td>
<td>text search dictionary that removes accents</td>
</tr>
<tr>
<td>seg</td>
<td>1.4</td>
<td>data type for representing line segments or floating-point intervals</td>
</tr>
<tr>
<td>sequential_uuids</td>
<td>1.0.2</td>
<td>generator of sequential UUIDs</td>
</tr>
<tr>
<td>uuid-ossp</td>
<td>1.1</td>
<td>generate universally unique identifiers (UUIDs)</td>
</tr>
<tr>
<td>smlar</td>
<td>1.0</td>
<td>compute similary of any one-dimensional arrays</td>
</tr>
<tr>
<td>varbitx</td>
<td>1.1</td>
<td>varbit functions pack</td>
</tr>
<tr>
<td>sslinfo</td>
<td>1.2</td>
<td>information about SSL certificates</td>
</tr>
<tr>
<td>tablefunc</td>
<td>1.0</td>
<td>functions that manipulate whole tables, including crosstab</td>
</tr>
<tr>
<td>tcn</td>
<td>1.0</td>
<td>Triggered change notifications</td>
</tr>
<tr>
<td>zhparser</td>
<td>1.0</td>
<td>a parser for full-text search of Chinese</td>
</tr>
<tr>
<td>address_standardizer</td>
<td>3.3.2</td>
<td>Ganos PostGIS address standardizer</td>
</tr>
<tr>
<td>address_standardizer_data_us</td>
<td>3.3.2</td>
<td>Ganos PostGIS  address standardizer data us</td>
</tr>
<tr>
<td>ganos_fdw</td>
<td>6.0</td>
<td>Ganos Spatial FDW extension for POLARDB</td>
</tr>
<tr>
<td>ganos_geometry</td>
<td>6.0</td>
<td>Ganos geometry lite extension for POLARDB</td>
</tr>
<tr>
<td>ganos_geometry_pyramid</td>
<td>6.0</td>
<td>Ganos Geometry Pyramid extension for POLARDB</td>
</tr>
<tr>
<td>ganos_geometry_sfcgal</td>
<td>6.0</td>
<td>Ganos geometry lite sfcgal extension for POLARDB</td>
</tr>
<tr>
<td>ganos_geomgrid</td>
<td>6.0</td>
<td>Ganos geometry grid extension for POLARDB</td>
</tr>
<tr>
<td>ganos_importer</td>
<td>6.0</td>
<td>Ganos Spatial importer extension for POLARDB</td>
</tr>
<tr>
<td>ganos_networking</td>
<td>6.0</td>
<td>Ganos networking</td>
</tr>
<tr>
<td>ganos_pointcloud</td>
<td>6.0</td>
<td>Ganos pointcloud extension For POLARDB</td>
</tr>
<tr>
<td>ganos_pointcloud_geometry</td>
<td>6.0</td>
<td>Ganos_pointcloud LIDAR data and ganos_geometry data for POLARDB</td>
</tr>
<tr>
<td>ganos_raster</td>
<td>6.0</td>
<td>Ganos raster extension for POLARDB</td>
</tr>
<tr>
<td>ganos_scene</td>
<td>6.0</td>
<td>Ganos scene extension for POLARDB</td>
</tr>
<tr>
<td>ganos_sfmesh</td>
<td>6.0</td>
<td>Ganos surface mesh extension for POLARDB</td>
</tr>
<tr>
<td>ganos_spatialref</td>
<td>6.0</td>
<td>Ganos spatial reference extension for POLARDB</td>
</tr>
<tr>
<td>ganos_trajectory</td>
<td>6.0</td>
<td>Ganos trajectory extension for POLARDB</td>
</tr>
<tr>
<td>ganos_vomesh</td>
<td>6.0</td>
<td>Ganos volumn mesh extension for POLARDB</td>
</tr>
<tr>
<td>postgis_tiger_geocoder</td>
<td>3.3.2</td>
<td>Ganos PostGIS tiger geocoder</td>
</tr>
<tr>
<td>postgis_topology</td>
<td>3.3.2</td>
<td>Ganos PostGIS topology</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-73b38c6d44013724535510c32940a5d2">6 - PostgresML (AI/ML)</h1>
    <div class="lead">如何使用 Pigsty 拉起 PostgresML，在数据库内进行机器学习，模型训练、推理与 Embedding，RAG。</div>
	<p><a href="https://postgresml.org/">PostgresML</a> is an PostgreSQL extension with the support for latest LLMs, vector operations, classical Machine Learning and good old Postgres application workloads.</p>
<p>PostgresML (pgml) is a PostgreSQL extension written in Rust. You can run standalone docker images, but this is not a docker-compose template introduction, this file is for documentation purpose only.</p>
<p>PostgresML is officially supported on Ubuntu 22.04, but we also maintain an RPM version for EL 8/9, if you don&rsquo;t need CUDA &amp; NVIDIA stuff.</p>
<p>You&rsquo;ll need the Internet access on the database nodes to download python dependencies from PyPI and models from HuggingFace.</p>
<hr>
<h2 id="configuration">Configuration</h2>
<p>PostgresML is a RUST extension with official Ubuntu support. Pigsty maintains an RPM version for PostgresML on EL8 and EL9.</p>
<p><strong>Launch new Cluster</strong></p>
<p>PostgresML  2.7.9 is available for PostgreSQL 15 on Ubuntu 22.04 (Official), Debian 12 and EL 8/9 (Pigsty). To enable <code>pgml</code>, you have to install the extension first:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_meta     ,password: DBUser.Meta     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">read-only viewer for meta database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#204a87;font-weight:bold">name: postgis, schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">public}, {name: timescaledb}]}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user: dbuser_view , db: all ,addr: infra ,auth: pwd ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_libs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pgml, pg_stat_statements, auto_explain&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pgml_15 pgvector_15 wal2json_15 repack_15&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># ubuntu</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#pg_extensions: [ &#39;postgresql-pgml-15 postgresql-15-pgvector postgresql-15-wal2json postgresql-15-repack&#39; ]  # ubuntu</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>In EL 8/9, the extension name is <code>pgml_15</code>, corresponding name in ubuntu/debian is <code>postgresql-pgml-15</code>. and add <code>pgml</code> to <code>pg_libs</code>.</p>
<p><strong>Enable on Existing Cluster</strong></p>
<p>To enable <code>pgml</code> on existing cluster, install with ansible <code>package</code> module:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible pg-meta -m package -b -a <span style="color:#4e9a06">&#39;name=pgml_15&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ansible el8,el9 -m package -b -a &#39;name=pgml_15&#39;           # EL 8/9</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ansible u22 -m package -b -a &#39;name=postgresql-pgml-15&#39;    # Ubuntu 22.04 jammy</span>
</span></span></code></pre></div><hr>
<h2 id="python-dependencies">Python Dependencies</h2>
<p>You also have to install python dependencies for PostgresML on cluster nodes. Official tutorial: <a href="https://postgresml.org/docs/guides/developer-docs/installation">installation</a></p>
<p><strong>Install Python &amp; PIP</strong></p>
<p>Make sure <code>python3</code>, <code>pip</code> and <code>venv</code> is installed:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ubuntu 22.04 (python3.10), you have to install pip &amp; venv with apt</span>
</span></span><span style="display:flex;"><span>sudo apt install -y python3 python3-pip python3-venv   
</span></span></code></pre></div><p>For EL 8 / EL9 and compatible distros, you can use python3.11</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># el 8/9, you can upgrade default pip &amp; virtualenv if applicable</span>
</span></span><span style="display:flex;"><span>sudo yum install -y python3.11 python3.11-pip       <span style="color:#8f5902;font-style:italic"># install latest python3.11</span>
</span></span><span style="display:flex;"><span>python3.11 -m pip install --upgrade pip virtualenv  <span style="color:#8f5902;font-style:italic"># use python3.11 on el8 / el9</span>
</span></span></code></pre></div><details><summary>Using pypi mirrors</summary>
<p>For mainland China user, consider using the tsinghua pypi <a href="https://mirrors.tuna.tsinghua.edu.cn/help/pypi/">mirror</a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip config <span style="color:#204a87">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple    <span style="color:#8f5902;font-style:italic"># setup global mirror (recommended)</span>
</span></span><span style="display:flex;"><span>pip install -i https://pypi.tuna.tsinghua.edu.cn/simple some-package        <span style="color:#8f5902;font-style:italic"># one-time install</span>
</span></span></code></pre></div></details>
<p><strong>Install Requirements</strong></p>
<p>Create a python virtualenv and install requirements from <a href="https://github.com/postgresml/postgresml/blob/master/pgml-extension/requirements.txt"><code>requirements.txt</code></a> and <a href="https://github.com/postgresml/postgresml/blob/master/pgml-extension/requirements-xformers.txt"><code>requirements-xformers.txt</code></a> with <code>pip</code>.</p>
<blockquote>
<p>If you are using EL 8/9, you have to replace the <code>python3</code> with <code>python3.11</code> in the following commands.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>su - postgres<span style="color:#000;font-weight:bold">;</span>                          <span style="color:#8f5902;font-style:italic"># create venv with dbsu</span>
</span></span><span style="display:flex;"><span>mkdir -p /data/pgml<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">cd</span> /data/pgml<span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic"># make a venv directory</span>
</span></span><span style="display:flex;"><span>python3    -m venv /data/pgml           <span style="color:#8f5902;font-style:italic"># create virtualenv dir (ubuntu 22.04)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">source</span> /data/pgml/bin/activate          <span style="color:#8f5902;font-style:italic"># activate virtual env</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># write down python dependencies and install with pip</span>
</span></span><span style="display:flex;"><span>cat &gt; /data/pgml/requirments.txt <span style="color:#4e9a06">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">accelerate==0.22.0
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">auto-gptq==0.4.2
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">bitsandbytes==0.41.1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">catboost==1.2
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ctransformers==0.2.27
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">datasets==2.14.5
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">deepspeed==0.10.3
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">huggingface-hub==0.17.1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">InstructorEmbedding==1.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">lightgbm==4.1.0
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">orjson==3.9.7
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">pandas==2.1.0
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">rich==13.5.2
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">rouge==1.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">sacrebleu==2.3.1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">sacremoses==0.0.53
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">scikit-learn==1.3.0
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">sentencepiece==0.1.99
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">sentence-transformers==2.2.2
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">tokenizers==0.13.3
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">torch==2.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">torchaudio==2.0.2
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">torchvision==0.15.2
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">tqdm==4.66.1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">transformers==4.33.1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">xgboost==2.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">langchain==0.0.287
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">einops==0.6.1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">pynvml==11.5.0
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># install requirements with pip inside virtualenv</span>
</span></span><span style="display:flex;"><span>python3 -m pip install -r /data/pgml/requirments.txt
</span></span><span style="display:flex;"><span>python3 -m pip install <span style="color:#000">xformers</span><span style="color:#ce5c00;font-weight:bold">==</span>0.0.21 --no-dependencies
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># besides, 3 python packages need to be installed globally with sudo!</span>
</span></span><span style="display:flex;"><span>sudo python3 -m pip install xgboost lightgbm scikit-learn
</span></span></code></pre></div><hr>
<h2 id="enable-postgresml">Enable PostgresML</h2>
<p>After installing the <code>pgml</code> extension and python dependencies on all cluster nodes, you can enable <code>pgml</code> on the PostgreSQL cluster.</p>
<p><a href="https://pigsty.io/docs/pgsql/admin/#config-cluster">Configure</a> cluster with <code>patronictl</code> command and add <code>pgml</code> to <code>shared_preload_libraries</code>, and specify your <code>venv</code> dir in <code>pgml.venv</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">shared_preload_libraries</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgml, timescaledb, pg_stat_statements, auto_explain</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgml.venv</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/data/pgml&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>After that, restart database cluster, and create extension with SQL command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vector</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic">-- nice to have pgvector installed too!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgml</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic">-- create PostgresML in current database
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgml</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">();</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic">-- print PostgresML version string
</span></span></span></code></pre></div><p>If it works, you should see something like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># create extension pgml;</span>
</span></span><span style="display:flex;"><span>INFO:  Python version: 3.11.2 <span style="color:#ce5c00;font-weight:bold">(</span>main, Oct  <span style="color:#0000cf;font-weight:bold">5</span> 2023, 16:06:03<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">[</span>GCC 8.5.0 <span style="color:#0000cf;font-weight:bold">20210514</span> <span style="color:#ce5c00;font-weight:bold">(</span>Red Hat 8.5.0-18<span style="color:#ce5c00;font-weight:bold">)]</span>
</span></span><span style="display:flex;"><span>INFO:  Scikit-learn 1.3.0, XGBoost 2.0.0, LightGBM 4.1.0, NumPy 1.26.1
</span></span><span style="display:flex;"><span>CREATE EXTENSION
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># SELECT pgml.version(); -- print PostgresML version string</span>
</span></span><span style="display:flex;"><span> version
</span></span><span style="display:flex;"><span>---------
</span></span><span style="display:flex;"><span> 2.7.8
</span></span></code></pre></div><p>You are all set! Check PostgresML for more details: <a href="https://postgresml.org/docs/guides/use-cases/">https://postgresml.org/docs/guides/use-cases/</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f74dd81ba7f50361f73dc87e6ed6daf3">7 - Supabase (Firebase)</h1>
    <div class="lead">如何使用Pigsty自建Supabase，一键拉起开源Firebase替代，后端全栈全家桶。</div>
	<blockquote>
<p><a href="https://supabase.com/">Supabase</a> —— Build in a weekend, Scale to millions</p>
</blockquote>
<p>Supabase 是一个开源的 Firebase 替代，对 PostgreSQL 进行了封装，并提供了认证，开箱即用的 API，边缘函数，实时订阅，对象存储，向量嵌入能力。
这是一个低代码的一站式后端平台，能让你几乎告别大部分后端开发的工作，只需要懂数据库设计与前端即可快速出活！</p>
<p>Supabase 的口号是：“<strong>花个周末写写，随便扩容至百万</strong>”。诚然，在小微规模（4c8g）内的 Supabase <a href="https://supabase.com/pricing">极有性价比</a>，堪称赛博菩萨。
—— 但当你真的增长到百万用户时 —— 确实应该认真考虑托管自建 Supabase 了 —— 无论是出于功能，性能，还是成本上的考虑。</p>
<p>Pigsty 为您提供完整的 Supabase 一键自建方案。自建的 Supabase 可以享受完整的 PostgreSQL 监控，IaC，PITR 与高可用，
而且相比 Supabase 云服务，提供了多达 <a href="https://ext.pigsty.io"><strong>340</strong></a> 个开箱即用的 PostgreSQL 扩展，并能够更充分地利用现代硬件的性能与成本优势。</p>
<p>完整自建教程，请参考：《<a href="/zh/blog/db/supabase"><strong>Supabase自建手册</strong></a>》</p>
<hr>
<h2 id="快速上手">快速上手</h2>
<p>Pigsty 默认提供的 <a href="https://github.com/Vonng/pigsty/blob/main/conf/supa.yml"><code>supa.yml</code></a> 配置模板定义了一套单节点 Supabase。</p>
<p>首先，使用 Pigsty <a href="/zh/docs/setup/install">标准安装流程</a> 安装 Supabase 所需的 MinIO 与 PostgreSQL 实例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> curl -fsSL https://repo.pigsty.io/get <span style="color:#000;font-weight:bold">|</span> bash
</span></span><span style="display:flex;"><span>./bootstrap          <span style="color:#8f5902;font-style:italic"># 环境检查，安装依赖</span>
</span></span><span style="display:flex;"><span>./configure -c supa  <span style="color:#8f5902;font-style:italic"># 重要：请在配置文件中修改密码等关键信息！</span>
</span></span><span style="display:flex;"><span>./install.yml        <span style="color:#8f5902;font-style:italic"># 安装 Pigsty，拉起 PGSQL 与 MINIO！</span>
</span></span></code></pre></div><p>请在部署 Supabase 前，根据您的实际情况，修改 <code>pigsty.yml</code> 配置文件中<a href="/zh/docs/kernel/supabase/#配置细节">关于 Supabase 的参数</a>（主要是密码！）</p>
<p>然后，运行 <a href="https://github.com/Vonng/pigsty/blob/main/supabase.yml"><code>supabase.yml</code></a> 完成剩余的工作，拉起 Supabase 容器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./supabase.yml       <span style="color:#8f5902;font-style:italic"># 安装 Docker 并拉起 Supabase 无状态部分！</span>
</span></span></code></pre></div><p>中国区域用户注意，请您配置合适的 Docker 镜像站点或代理服务器绕过 GFW 以拉取 DockerHub 镜像。
对于 <a href="/zh/docs/about/service">专业订阅</a> ，我们提供在没有互联网访问的情况下，<a href="/zh/docs/setup/offline">离线安装</a> Pigsty 与 Supabase 的能力。</p>
<p>Pigsty 默认通过管理节点/INFRA节点上的 Nginx 对外暴露 Web 服务，您可以在本地添加 <code>supa.pigsty</code> 的 DNS 解析指向该节点，
然后通过浏览器访问 <code>https://supa.pigsty</code> 即可进入 Supabase Studio 管理界面。</p>
<blockquote>
<p>默认用户名与密码：supabase / pigsty</p>
</blockquote>
<p><a href="https://asciinema.org/a/692194"><img alt="asciicast" src="https://asciinema.org/a/692194.svg"></a></p>
<hr>
<h2 id="架构概览">架构概览</h2>
<p>Pigsty 以 Supabase 提供的 Docker Compose 模板为蓝本，提取了其中的无状态部分，由 Docker Compose 负责处理。而有状态的数据库和对象存储容器则替换为外部由 Pigsty 托管的 PostgreSQL 集群与 MinIO 服务。</p>
<blockquote>
<p><a href="https://supabase.com/docs/guides/self-hosting/docker">Supabase: 使用 Docker 自建</a></p>
</blockquote>
<p>经过改造后，Supabase 本体是无状态的，因此您可以随意运行，停止，甚至在同一套 PGSQL/MINIO 上同时运行多个无状态 Supabase 容器以实现扩容。</p>
<p><img src="https://supabase.com/docs/_next/image?url=%2Fdocs%2Fimg%2Fsupabase-architecture--light.svg&w=1920&q=75&dpl=dpl_DvE3RFyspEh3ueQLYomwedpVK8e2"></p>
<p>Pigsty 默认使用本机上的单机 <a href="/zh/docs/pgsql">PostgreSQL</a> 实例作为 Supabase 的核心后端数据库。对于严肃的生产部署，我们建议使用 Pigsty 部署一套至少由三节点的 PG 高可用集群。或至少使用外部对象存储作为 PITR 备份仓库，提供兜底。</p>
<p>Pigsty 默认使用本机上的 <a href="/zh/docs/minio/config#%E5%8D%95%E6%9C%BA%E5%8D%95%E7%9B%98">SNSD</a> MinIO 服务作为文件存储。对于严肃的生产环境部署，您可以使用外部的 S3 兼容对象存储服务，或者使用其他由 Pigsty 独立部署的 <a href="/zh/docs/minio/config#%E5%A4%9A%E6%9C%BA%E5%A4%9A%E7%9B%98">多机多盘</a> MinIO 集群。</p>
<hr>
<h2 id="配置细节">配置细节</h2>
<p>自建 Supabase 时，包含 Docker Compose 所需资源的目录 <a href="https://github.com/Vonng/pigsty/tree/main/app/supabase"><code>app/supabase</code></a> 会被整个拷贝到目标节点（默认为 <code>supabase</code> 分组）上的 <code>/opt/supabase</code>，并使用 <code>docker compose up -d</code> 在后台拉起。</p>
<p>所有配置参数都定义在 <a href="https://github.com/Vonng/pigsty/blob/main/app/supabase/.env"><code>.env</code></a> 文件与 <a href="https://github.com/Vonng/pigsty/blob/main/app/supabase/docker-compose.yml"><code>docker-compose.yml</code></a> 模板中。
但您通常不需要直接修改这两个模板，你可以在 <code>supa_config</code> 中指定 <code>.env</code> 中的参数，这些配置会自动覆盖或追加到最终的 <code>/opt/supabase/.env</code> 核心配置文件中。</p>
<p>这里最关键的参数是 <code>jwt_secret</code>，以及对应的 <code>anon_key</code> 与 <code>service_role_key</code>。对于严肃的生产使用，<strong>请您务必参考<a href="https://supabase.com/docs/guides/self-hosting/docker#securing-your-services">Supabase自建手册</a>中的说明与工具设置</strong>。
如果您希望使用域名对外提供服务，您可以在 <code>site_url</code>， <code>api_external_url</code>，以及 <code>supabase_public_url</code> 中指定您的域名。</p>
<p>Pigsty 默认使用本机 MinIO，如果您希望使用 S3 或 MinIO 作为文件存储，您需要配置 <code>s3_bucket</code>，<code>s3_endpoint</code>，<code>s3_access_key</code>，<code>s3_secret_key</code> 等参数。</p>
<p>通常来说，您还需要使用一个外部的 SMTP 服务来发送邮件，邮件服务不建议自建，请考虑使用成熟的第三方服务，如 Mailchimp，Aliyun 邮件推送等。</p>
<p>对于中国大陆用户来说，我们建议您配置 <a href="/zh/docs/docker/param#docker_registry_mirrors"><code>docker_registry_mirrors</code></a> 镜像站点，或使用 <a href="/zh/docs/reference/param#proxy_env"><code>proxy_env</code></a> 指定可用的代理服务器翻墙，否则从 DockerHub 上拉取镜像可能会失败或极为缓慢！</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># launch supabase stateless part with docker compose:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># ./supabase.yml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">supabase</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">supa_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># instance id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">supa_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">supa           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># cluster name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">docker_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># enable docker</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># use these to pull docker images via proxy and mirror registries</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#docker_registry_mirrors: [&#39;https://docker.xxxxx.io&#39;]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#proxy_env:   # add [OPTIONAL] proxy env to /etc/docker/daemon.json configuration file</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#  no_proxy: &#34;localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16,*.pigsty,*.aliyun.com,mirrors.*,*.myqcloud.com,*.tsinghua.edu.cn&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#  #all_proxy: http://user:pass@host:port</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># these configuration entries will OVERWRITE or APPEND to /opt/supabase/.env file (src template: app/supabase/.env)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># check https://github.com/Vonng/pigsty/blob/main/app/supabase/.env for default values</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">supa_config</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># IMPORTANT: CHANGE JWT_SECRET AND REGENERATE CREDENTIAL ACCORDING!!!!!!!!!!!</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># https://supabase.com/docs/guides/self-hosting/docker#securing-your-services</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">jwt_secret</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">your-super-secret-jwt-token-with-at-least-32-characters-long</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">anon_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">service_role_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJzZXJ2aWNlX3JvbGUiLAogICAgImlzcyI6ICJzdXBhYmFzZS1kZW1vIiwKICAgICJpYXQiOiAxNjQxNzY5MjAwLAogICAgImV4cCI6IDE3OTk1MzU2MDAKfQ.DaYlNEoUrrEn2Ig7tqibS-PHK5vgusbcbo7X36XVt4Q</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">dashboard_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">supabase</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">dashboard_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># postgres connection string (use the correct ip and port)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">postgres_host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">postgres_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5436</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># access via the &#39;default&#39; service, which always route to the primary postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">postgres_db</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">postgres_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Supa </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># password for supabase_admin and multiple supabase users</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># expose supabase via domain name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">site_url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http://supa.pigsty</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">api_external_url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http://supa.pigsty</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">supabase_public_url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http://supa.pigsty</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># if using s3/minio as file storage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">s3_bucket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">supa</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">s3_endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://sss.pigsty:9000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">s3_access_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">supabase</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">s3_secret_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">S3User.Supabase</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">s3_force_path_style</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">s3_protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">s3_region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">stub</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">minio_domain_ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># sss.pigsty domain name will resolve to this ip statically</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># if using SMTP (optional)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#smtp_admin_email: admin@example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#smtp_host: supabase-mail</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#smtp_port: 2500</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#smtp_user: fake_mail_user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#smtp_pass: fake_mail_password</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#smtp_sender_name: fake_sender</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#enable_anonymous_users: false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><br>
<hr>
<br>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0a6512885669a2f1cdcdf701791e9975">8 - Greenplum (MPP)</h1>
    <div class="lead">使用 Pigsty 部署/监控 Greenplum 集群，构建大规模并行处理（MPP）的 PostgreSQL 数据仓库集群！</div>
	<p>Pigsty 支持部署 Greenplum 集群，及其衍生发行版 YMatrixDB，并提供了将现有 Greenplum 部署纳入 Pigsty 监控的能力。</p>
<hr>
<h2 id="概览">概览</h2>
<p>Greenplum / YMatrix 集群部署能力仅在专业版本/企业版本中提供，目前不对外开源。</p>
<hr>
<h2 id="安装">安装</h2>
<p>Pigsty 提供了 Greenplum 6 (@el7) 与 Greenplum 7 (@el8) 的安装包，开源版本用户可以自行安装配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># EL 7 Only (Greenplum6)</span>
</span></span><span style="display:flex;"><span>./node.yml -t node_install  -e <span style="color:#4e9a06">&#39;{&#34;node_repo_modules&#34;:&#34;pgsql&#34;,&#34;node_packages&#34;:[&#34;open-source-greenplum-db-6&#34;]}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># EL 8 Only (Greenplum7)</span>
</span></span><span style="display:flex;"><span>./node.yml -t node_install  -e <span style="color:#4e9a06">&#39;{&#34;node_repo_modules&#34;:&#34;pgsql&#34;,&#34;node_packages&#34;:[&#34;open-source-greenplum-db-7&#34;]}&#39;</span>
</span></span></code></pre></div><hr>
<h2 id="配置">配置</h2>
<p>要定义 Greenplum 集群，需要用到 <code>pg_mode</code> = <code>gpsql</code>，并使用额外的身份参数 <code>pg_shard</code> 与 <code>gp_role</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#================================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                        GPSQL Clusters                          #</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#================================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#----------------------------------#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># cluster: mx-mdw (gp master)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#----------------------------------#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">mx-mdw</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role: primary , nodename</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mx-mdw-1 }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">gp_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">master         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># this cluster is used as greenplum master</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_shard</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mx            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pgsql sharding name &amp; gpsql deployment name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mx-mdw      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># this master cluster name is mx-mdw</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: matrixmgr , extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">matrixdbts } ] }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: meta , password: DBUser.Meta , pgbouncer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_monitor , password: DBUser.Monitor , roles: [ dbrole_readonly ], superuser</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pgbouncer_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># enable pgbouncer for greenplum master</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pgbouncer_exporter_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># enable pgbouncer_exporter for greenplum master</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_exporter_params</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;host=127.0.0.1&amp;sslmode=disable&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># use 127.0.0.1 as local monitor host</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#----------------------------------#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># cluster: mx-sdw (gp master)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#----------------------------------#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">mx-sdw</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">nodename</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mx-sdw-1       </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># greenplum segment node</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">pg_instances</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># greenplum segment instances</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">6000</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: mx-seg1, pg_seq: 1, pg_role: primary , pg_exporter_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9633</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">6001</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: mx-seg2, pg_seq: 2, pg_role: replica , pg_exporter_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9634</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">nodename</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mx-sdw-2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">pg_instances</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">6000</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: mx-seg2, pg_seq: 1, pg_role: primary , pg_exporter_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9633</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">6001</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: mx-seg3, pg_seq: 2, pg_role: replica , pg_exporter_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9634</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">nodename</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mx-sdw-3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">pg_instances</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">6000</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: mx-seg3, pg_seq: 1, pg_role: primary , pg_exporter_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9633</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">6001</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: mx-seg1, pg_seq: 2, pg_role: replica , pg_exporter_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9634</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">gp_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">segment              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># these are nodes for gp segments</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_shard</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mx                  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pgsql sharding name &amp; gpsql deployment name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mx-sdw            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># these segment clusters name is mx-sdw</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_preflight_skip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># skip preflight check (since pg_seq &amp; pg_role &amp; pg_cluster not exists)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_exporter_config</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_exporter_basic.yml                            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># use basic config to avoid segment server crash</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_exporter_params</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;options=-c%20gp_role%3Dutility&amp;sslmode=disable&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># use gp_role = utility to connect to segments</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>此外，PG Exporter 需要额外的连接参数，才能连接到 Greenplum Segment 实例上采集监控指标。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d3ea86d3a671be7a0a3ca5118e6c9f24">9 - Cloudberry (MPP)</h1>
    <div class="lead">使用 Pigsty 部署/监控 Cloudberry 集群，一个由 Greenplum 分叉而来的 MPP 数据仓库集群！</div>
	<hr>
<h2 id="安装">安装</h2>
<p>Pigsty 提供了 Greenplum 6 (@el7) 与 Greenplum 7 (@el8) 的安装包，开源版本用户可以自行安装配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># EL 7 Only (Greenplum6)</span>
</span></span><span style="display:flex;"><span>./node.yml -t node_install  -e <span style="color:#4e9a06">&#39;{&#34;node_repo_modules&#34;:&#34;pgsql&#34;,&#34;node_packages&#34;:[&#34;cloudberrydb&#34;]}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># EL 8 Only (Greenplum7)</span>
</span></span><span style="display:flex;"><span>./node.yml -t node_install  -e <span style="color:#4e9a06">&#39;{&#34;node_repo_modules&#34;:&#34;pgsql&#34;,&#34;node_packages&#34;:[&#34;cloudberrydb&#34;]}&#39;</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3b91cd1a5acbaacbd620223d3edc1416">10 - Neon (Serverless)</h1>
    <div class="lead">使用 Neon 开源的 Serverless 版本 PostgreSQL 内核，自建灵活伸缩，Scale To Zero，灵活分叉的PG服务。</div>
	<p><a href="https://github.com/neondatabase/neon"><strong>Neon</strong></a> 采用了存储与计算分离架构，提供了丝滑的自动扩缩容，Scale to Zero，以及数据库版本分叉等独家能力。</p>
<p>Neon 官网：https://neon.tech/</p>
<p>Neon 编译后的二进制产物过于庞大，目前不对开源版用户提供，目前处于试点阶段，有需求请联系 Pigsty 销售。</p>

</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Mail" aria-label="Mail">
    <a target="_blank" rel="noopener" href="mailto:rh@vonng.com" aria-label="Mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Vonng/pigsty" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://twitter.com/GobeUncleWang" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="WeChat" aria-label="WeChat">
    <a target="_blank" rel="noopener" href="/img/pigsty/pigsty-cc.jpg" aria-label="WeChat">
      <i class="fa fa-comment"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Discord" aria-label="Discord">
    <a target="_blank" rel="noopener" href="https://discord.gg/wDzt5VyWEz" aria-label="Discord">
      <i class="fab fa-discord"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Telegram" aria-label="Telegram">
    <a target="_blank" rel="noopener" href="https://t.me/joinchat/gV9zfZraNPM3YjFh" aria-label="Telegram">
      <i class="fab fa-telegram"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2018&ndash;2025
    <span class="td-footer__authors">Ruohang Feng</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span></span><span class="ms-2"><a href="https://vonng.com/en/" target="_blank" rel="noopener">@Vonng</a></span>
<br><span>Pigsty® distributed under <a href="/docs/about/license" target="_blank" rel="noopener">AGPLv3</a></span>
<br><span class="ms-2"><a href="/docs/about/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
<span><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">浙ICP备15016890号</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.248655eb216150e39da254c2f7aa5357805d0ec66bdb741b591cd35fb5f629ab.js" integrity="sha256-JIZV6yFhUOOdolTC96pTV4BdDsZr23QbWRzTX7X2Kas=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
