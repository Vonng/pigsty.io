<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="/zh/docs/tasks/">
<link rel="alternate" type="application/rss&#43;xml" href="/zh/docs/tasks/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>任务与教程 | Pigsty</title>
<meta name="description" content="Pigsty 中常见的任务列表与一些主题案例教学，例如：证书签发，故障演练，性能调优，数据迁移，使用 CMDB 等。">
<meta property="og:title" content="任务与教程" />
<meta property="og:description" content="Pigsty 中常见的任务列表与一些主题案例教学，例如：证书签发，故障演练，性能调优，数据迁移，使用 CMDB 等。" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/zh/docs/tasks/" />

<meta itemprop="name" content="任务与教程">
<meta itemprop="description" content="Pigsty 中常见的任务列表与一些主题案例教学，例如：证书签发，故障演练，性能调优，数据迁移，使用 CMDB 等。"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="任务与教程"/>
<meta name="twitter:description" content="Pigsty 中常见的任务列表与一些主题案例教学，例如：证书签发，故障演练，性能调优，数据迁移，使用 CMDB 等。"/>




<link rel="preload" href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" as="style">
<link href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="/js/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LG1V9WTKGE');
}
</script>
  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/zh/"><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class="navbar-brand__name">Pigsty</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/zh/docs/"><i class='fa-solid fa-book'></i><span>文档</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/zh/blog/"><i class="fas fa-blog"></i><span>博客</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/Vonng/pigsty/" target="_blank" rel="noopener"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Link</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/docs/">v3 Docs</a></li>
    <li><a class="dropdown-item" href="https://demo.pigsty.cc">Public Demo</a></li>
    <li><a class="dropdown-item" href="https://ext.pigsty.io">Extension Repo</a></li>
    <li><a class="dropdown-item" href="https://pigsty.cc/zh/docs">pigsty.cc</a></li>
    <li><a class="dropdown-item" href="https://pigsty.cc/zh/blog">ZH Blog</a></li>
    </ul>
</div></li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-language"></i>中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/docs/tasks/">English</a></li>
    </ul>
</div>
</li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.4254d9d640516c9dc82343a43641b8bc.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/zh/docs/tasks/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">任务与教程</h1>
<div class="lead">Pigsty 中常见的任务列表与一些主题案例教学，例如：证书签发，故障演练，性能调优，数据迁移，使用 CMDB 等。</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-99d2b713b93221365ecf430782dc8d2f">Nginx：向外代理暴露Web服务</a></li>


    
  
    
    
	
<li>2: <a href="#pg-303bb9027210f29a00e38a29f00d3519">Docker：启用容器支持与配置</a></li>


    
  
    
    
	
<li>3: <a href="#pg-635082b78e7ccd8765655b57d256e44d">使用 PostgreSQL 作为 Ansible 的配置清单与 CMDB</a></li>


    
  
    
    
	
<li>4: <a href="#pg-9f5474502d4f0b74cbd1e1f9ae23bc23">使用 Keepalived 为 Pigsty 节点集群配置二层 VIP</a></li>


    
  
    
    
	
<li>5: <a href="#pg-d55948673c4562234cd1d0c550779f28">使用 VIP-Manager 为 PostgreSQL 集群配置二层 VIP</a></li>


    
  
    
    
	
<li>6: <a href="#pg-4f7bd649e98232d39a0fac447d3ad879">使用 PostgreSQL 作为 Grafana 后端数据库</a></li>


    
  
    
    
	
<li>7: <a href="#pg-8ccc56d4ade450368e94558922ba0706">使用 TimescaleDB &#43; Promscale 存储 Prometheus 时序指标数据</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-99d2b713b93221365ecf430782dc8d2f">1 - Nginx：向外代理暴露Web服务</h1>
    <div class="lead">如何在使用 Nginx 对外代理、转发、暴露 Web 服务？</div>
	<p>Pigsty 在 <a href="/zh/docs/node#infra%E8%8A%82%E7%82%B9"><strong>INFRA节点</strong></a>上默认会安装 <a href="/zh/docs/infra#nginx"><strong>Nginx</strong></a> 作为 Web 服务代理。（单机安装时，本机默认也是一个 INFRA节点 ）</p>
<p>Nginx 是 Pigsty 所有 WebUI 类服务的访问入口，默认使用管理节点 <code>80/443</code> 端口。</p>
<p>Pigsty 提供了一个全局配置变量 <a href="/zh/docs/reference/param#infra_portal"><code>infra_portal</code></a>，用于配置 Nginx 的代理规则，以及对应的上游服务。</p>
<p>如果您直接通过端口访问 Nginx，默认访问的是 <code>h.pigsty</code>，即 Pigsty 文件系统首页。（<code>/www/</code> 目录）。
因为 Nginx 通过同一个端口对外提供多个服务，因此必须通过域名进行区分（浏览器的 <code>HOST</code> 首部），所以在默认情况下，Nginx 只会对外暴露 <code>带有 </code>domain` 参数的</p>
<p>默认情况下，Nginx 除了 <code>home</code> （文件系统，软件源）之外，还对外暴露 <code>grafana</code>，<code>prometheus</code>，<code>alertmanager</code> 三项可观测性服务：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">infra_portal</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># domain names and upstream servers</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">home         </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">h.pigsty }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">grafana      </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: g.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:3000&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">, websocket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">prometheus   </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: p.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:9090&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">alertmanager </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: a.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:9093&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">blackbox     </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:9115&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">loki         </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:3100&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#minio        : { domain: sss.pigsty  ,endpoint: &#34;${admin_ip}:9001&#34; ,scheme: https ,websocket: true }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="如何配置-nginx-代理">如何配置 Nginx 代理？</h2>
<p>Pigsty 自带的配置模板 <a href="https://github.com/Vonng/pigsty/blob/main/conf/full.yml"><code>full.yml</code></a> 配置文件，作为一个参考，额外对外部暴露了一些 Web 服务：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">infra_portal</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># domain names and upstream servers</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">home         </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">h.pigsty }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">grafana      </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: g.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:3000&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">, websocket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">prometheus   </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: p.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:9090&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">alertmanager </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: a.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:9093&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">blackbox     </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:9115&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">loki         </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:3100&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">minio        </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: sss.pigsty  ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:9001&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,scheme: https ,websocket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">postgrest    </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: api.pigsty  ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:8884&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">pgadmin      </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: adm.pigsty  ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:8885&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">pgweb        </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: cli.pigsty  ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:8886&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">bytebase     </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: ddl.pigsty  ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:8887&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">jupyter      </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: lab.pigsty  ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:8888&#34;</span><span style="color:#204a87;font-weight:bold">, websocket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">gitea        </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: git.pigsty  ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:8889&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">wiki         </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: wiki.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:9002&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">noco         </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: noco.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:9003&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">supa         </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: supa.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;10.10.10.10:8000&#34;</span><span style="color:#204a87;font-weight:bold">, websocket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这里不难看出，每一条记录都有一个独一无二的 <code>name</code> 作为 <code>key</code>，一个配置字典作为 <code>value</code>。在配置字典中，目前有以下四个可用配置项：</p>
<ul>
<li><code>endpoint</code>：必填，指定上游服务的地址，可以是 <code>IP:PORT</code> 或者 <code>DOMAIN:PORT</code>。
<ul>
<li>在此参数中，可以使用 <code>${admin_ip}</code> 占位符，Pigsty会填入 <a href="/zh/docs/reference/param#admin_ip"><code>admin_ip</code></a> 的值。</li>
</ul>
</li>
<li><code>domain</code>：可选，指定代理的域名，如果不填写，则 Nginx 不会对外暴露此服务。
<ul>
<li>对于那些需要知道 endpoint 地址，但不想对外暴露的服务（例如 Loki, Blackbox Exporter），可以不填写 <code>domain</code>。</li>
</ul>
</li>
<li><code>scheme</code>：可选，指定转发时的协议（<code>http</code>/<code>https</code>），留空则默认使用 http
<ul>
<li>对于那些强制要求 HTTPS 访问的上游 Web 服务（例如 MinIO 管理界面），需要指定 <code>scheme: https</code>。</li>
</ul>
</li>
<li><code>websocket</code>：可选，指定是否开启 WebSocket，留空则默认关闭。
<ul>
<li>类似 Grafana、Jupyter 等需要 WebSocket 的服务需要设置为 <code>true</code> 方能正常工作。</li>
</ul>
</li>
</ul>
<p>因此，如果您需要新增一个通过 Nginx 暴露的 Web 服务，首先需要在 <code>infra_portal</code> 中添加相应地记录，然后执行剧本生效：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./infra.yml -t nginx_config    <span style="color:#8f5902;font-style:italic"># 重新生成 Nginx 配置文件</span>
</span></span><span style="display:flex;"><span>./infra.yml -t nginx_cert      <span style="color:#8f5902;font-style:italic"># 重新签发自签名 HTTPS 证书，囊括新增的域名</span>
</span></span><span style="display:flex;"><span>./infra.yml -t nginx_launch    <span style="color:#8f5902;font-style:italic"># 重启 Nginx 以使配置生效（如果您不希望出现中断，手动使用 nginx -s reload）</span>
</span></span></code></pre></div><p>如果您始终通过 Pigsty 管理 Nginx 配置，也可以直接使用以下任务重新初始化 Nginx 配置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./infra.yml -t nginx           <span style="color:#8f5902;font-style:italic"># 直接重新初始化 Nginx 至描述的状态</span>
</span></span></code></pre></div><p>Nginx相关配置参数位于：<a href="/zh/docs/reference/param#nginx">配置：INFRA - NGINX</a></p>
<hr>
<h2 id="如何通过域名访问-nginx-代理的服务">如何通过域名访问 Nginx 代理的服务？</h2>
<p>Nginx 通过浏览器设置的 <code>HOST</code> 首部中的域名，来区分不同的服务，所以默认除了软件仓库之外服务，都的您需要通过域名访问。</p>
<p>您可以通过 IP地址 + 端口的方式直接访问这些服务。但我们更推荐您使用域名通过 Nginx 80/443 端口代理访问所有组件。</p>
<p>使用域名访问 Pigsty WebUI 时，您需要配置 <strong>DNS</strong> 解析，或者修改本地的 <code>/etc/hosts</code> 静态解析文件，有几种典型的方式</p>
<ul>
<li>
<p>如果您的服务需要直接暴露在公网上，那么应当通过 DNS 服务商（Cloudflare，Aliyun DNS 等）解析互联网域名。注意，在这种情况下，通常您还需要修改 Pigsty 的 <a href="/zh/docs/reference/param#infra_portal"><code>infra_portal</code></a> 参数，因为默认的 <code>*.pigsty</code> 并不是一个适合公网使用的域名。</p>
</li>
<li>
<p>如果您的服务需要在办公网共享访问，那么应当通过内网 DNS 服务商（公司内部 DNS 服务器）解析内网域名，并将其指向 Nginx 服务器所在的 IP。您可以要求网络管理员在公司内部 DNS 服务器中添加相应的解析记录，也可以要求系统的用户手工配置静态的 DNS 解析记录。</p>
</li>
<li>
<p>如果您的服务仅供自己，或少数用户使用（例如 DBA），那么您可以要求这些用户使用静态域名解析记录。在 Linux / MacOS 系统上，修改 <code>/etc/hosts</code> 文件（需要 sudo 权限）或 <code>C:\Windows\System32\drivers\etc\hosts</code>（Windows）文件。</p>
</li>
</ul>
<p>我们建议普通单机用户使用第三种方式，在 <strong>使用浏览器访问 Web 系统的机器上</strong> ，添加以下解析记录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&lt;your_public_ip_address&gt;  h.pigsty a.pigsty p.pigsty g.pigsty
</span></span></code></pre></div><p>这里的 IP 地址是安装 Pigsty 服务的 <strong>对外IP地址</strong>，然后您就可以在浏览器中通过： <a href="http://g.pigsty">http://g.pigsty</a>  这样的域名网址，访问 Pigsty 的子系统了。</p>
<p>其他的 Web 服务与自定义域名，也可以通过同样的方式添加。例如以下是 Pigsty 沙箱 Demo 可能用到的域名解析记录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>10.10.10.10 h.pigsty a.pigsty p.pigsty g.pigsty
</span></span><span style="display:flex;"><span>10.10.10.10 api.pigsty ddl.pigsty adm.pigsty cli.pigsty lab.pigsty
</span></span><span style="display:flex;"><span>10.10.10.10 supa.pigsty noco.pigsty odoo.pigsty dify.pigsty
</span></span></code></pre></div><hr>
<h2 id="如何使用-https-访问-nginx-代理的服务">如何使用 HTTPS 访问 Nginx 代理的服务？</h2>
<p>Pigsty默认使用自动生成的自签名的 CA 证书为 Nginx 启用 SSL，如果您希望使用 HTTPS 访问这些页面，而不弹窗提示&quot;不安全&quot;，通常有三个选择：</p>
<ul>
<li>在您的浏览器或操作系统中信任 Pigsty 自签名的 CA 证书： <code>files/pki/ca/ca.crt</code></li>
<li>如果您使用 Chrome，可以在提示不安全的窗口键入 <code>thisisunsafe</code> 跳过提示</li>
<li>您可以考虑使用 Let&rsquo;s Encrypt 或其他免费的 CA 证书服务，为 Pigsty Nginx 生成正式的 SSL证书。</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-303bb9027210f29a00e38a29f00d3519">2 - Docker：启用容器支持与配置</h1>
    <div class="lead">如何在 Pigsty 启用 Docker 容器支持？Docker 的安装部署配置，以及如何解决DockerHub被“墙”的问题</div>
	<p>Pigsty 提供了 <a href="/zh/docs/docker"><strong><code>DOCKER</code></strong></a> 模块，但默认并不安装。您可以使用 <a href="/zh/docs/docker#dockeryml"><code>docker.yml</code></a> 剧本在指定节点上安装并启用 Docker。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./docker.yml -l &lt;ip<span style="color:#000;font-weight:bold">|</span>group<span style="color:#000;font-weight:bold">|</span>cls&gt;   <span style="color:#8f5902;font-style:italic"># 在指定的节点、分组、集群上安装并启用 Docker</span>
</span></span></code></pre></div><hr>
<h2 id="如何建配置代理服务器">如何建配置代理服务器？</h2>
<p>本文不会介绍如何“翻墙”，而是假设你已经有了一个可用的 HTTP(s) 代理服务器，应该如何配置，让 Docker 可以通过代理服务器，访问 docker hub 或 quay.io 等镜像站点：</p>
<p>你的代理服务器软件应该会提供一个形如：</p>
<ul>
<li><code>http://&lt;ip|domain&gt;:&lt;port&gt;</code> 或者 <code>https://[user]:[pass]@&lt;ip|domain&gt;:&lt;port&gt;</code> 的代理地址</li>
</ul>
<p>例如，假设您使用的代理服务器配置为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ALL_PROXY</span><span style="color:#ce5c00;font-weight:bold">=</span>http://192.168.0.106:8118
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">HTTP_PROXY</span><span style="color:#ce5c00;font-weight:bold">=</span>http://192.168.0.106:8118
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">HTTPS_PROXY</span><span style="color:#ce5c00;font-weight:bold">=</span>http://192.168.0.106:8118
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">NO_PROXY</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16,*.pigsty,*.aliyun.com,mirrors.*,*.myqcloud.com,*.tsinghua.edu.cn&#34;</span>
</span></span></code></pre></div><p>您可以使用 <code>curl</code> 命令，检验代理服务器是否可以正常工作，例如成功可以访问 Google，通常说明代理服务器工作正常。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -x http://192.168.0.106:8118 -I http://www.google.com
</span></span></code></pre></div><hr>
<h2 id="如何为docker-daemon配置代理服务器">如何为Docker Daemon配置代理服务器？</h2>
<p>如果您希望 Docker 在 Pull 镜像时使用代理服务器，那么应当在 <code>pigsty.yml</code> 配置文件的全局变量中，指定 <a href="/zh/docs/reference/param#proxy_env"><code>proxy_env</code></a> 参数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">all</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">proxy_env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#8f5902;font-style:italic"># global proxy env when downloading packages</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">no_proxy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16,*.pigsty,*.aliyun.com,mirrors.*,*.myqcloud.com,*.tsinghua.edu.cn&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">http_proxy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http://192.168.0.106:8118</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">all_proxy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http://192.168.0.106:8118</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">https_proxy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http://192.168.0.106:8118</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>那么当 Docker 剧本执行，时，这些配置会被渲染为 <code>/etc/docker/daemon.json</code> 中的代理配置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;proxies&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;http-proxy&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;{{ proxy_env[&#39;http_proxy&#39;] }}&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;https-proxy&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;{{ proxy_env[&#39;http_proxy&#39;] }}&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;no-proxy&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;{{ proxy_env[&#39;no_proxy&#39;] }}&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><blockquote>
<p>请注意，Docker Daemon 不使用 <code>all_proxy</code> 参数</p>
</blockquote>
<p>如果您希望手工指定代理服务器，可以选则直接修改 <code>/etc/docker/daemon.json</code> 中的 <code>proxies</code> 配置；
或者也可以修改 <code>/lib/systemd/system/docker.service</code> (Debian/Ubuntu) 与 <code>/usr/lib/systemd/system/docker.service</code> 的服务定义，在 <code>[Service]</code> 一节中添加环境变量声明，并重启生效：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[Service]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">Environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;HTTP_PROXY=http://192.168.0.106:8118&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">Environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;HTTPS_PROXY=http://192.168.0.106:8118&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">Environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;NO_PROXY=localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16,*.pigsty,*.aliyun.com,mirrors.*,*.myqcloud.com,*.tsinghua.edu.cn&#34;</span>
</span></span></code></pre></div><p>重启后生效：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl restart docker
</span></span></code></pre></div><hr>
<h2 id="如何使用其他镜像站点">如何使用其他镜像站点？</h2>
<p>您可以在 <a href="/zh/docs/reference/param#docker_registry"><code>docker_registry_mirrors</code></a> 参数中指定其他镜像站点，例如阿里云、腾讯云、清华大学等镜像站点：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;https://mirror.ccs.tencentyun.com&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># tencent cloud mirror, intranet only</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;https://registry.cn-hangzhou.aliyuncs.com&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># aliyun cloud mirror, login required</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>不过目前来看，所有位于中国大陆的 DockerHub 公有镜像站都已经被封禁了，建议使用代理服务器直接访问 Docker Hub</p>
<p>如果您需要使用其他镜像站，例如 <code>quay.io</code>，可以首先执行：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker login quay.io
</span></span><span style="display:flex;"><span>username <span style="color:#8f5902;font-style:italic">#&gt; # input your username</span>
</span></span><span style="display:flex;"><span>password <span style="color:#8f5902;font-style:italic">#&gt; # input your password</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-635082b78e7ccd8765655b57d256e44d">3 - 使用 PostgreSQL 作为 Ansible 的配置清单与 CMDB</h1>
    <div class="lead">使用 PostgreSQL ，而不是静态 YAML 配置文件作为 Ansible 的配置源，从而更好地与外部系统集成整合。</div>
	<p>您可以使用 PostgreSQL 作为 Pigsty 的配置源，替代静态 YAML 配置文件。</p>
<p>使用 CMDB 作为 Ansible 的动态 <a href="/zh/docs/setup/config#%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95">配置清单</a> 具有一些优点：元数据以高度结构化的方式以数据表的形式呈现，并通过数据库约束确保一致性。 同时，使用 CMDB 允许您使用第三方的工具来编辑管理 Pigsty 元数据，便于与外部系统相互集成。</p>
<hr>
<h2 id="ansible配置原理">Ansible配置原理</h2>
<p>Pigsty 默认的配置文件路径在 <a href="https://github.com/Vonng/pigsty/blob/main/ansible.cfg"><code>ansible.cfg</code></a> 中指定为：<code>inventory = pigsty.yml</code></p>
<p>修改该参数，可以更改默认使用的配置文件路径。如果您将其指向一个可执行的脚本文件，那么 Ansible 会使用动态 Inventory 机制，执行该脚本，并期待该脚本返回一份配置文件。</p>
<p>修改配置源实质上是编辑Pigsty目录下的 <code>ansible.cfg</code> 实现的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#000">inventory</span> <span style="color:#ce5c00;font-weight:bold">=</span> pigsty.yml
</span></span><span style="display:flex;"><span>+++
</span></span><span style="display:flex;"><span><span style="color:#000">inventory</span> <span style="color:#ce5c00;font-weight:bold">=</span> inventory.sh
</span></span></code></pre></div><p>而 <code>inventory.sh</code> 则是一个从 PostgreSQL CMDB 的记录中，生成等效 YAML/JSON 配置文件的简单脚本。</p>
<p>你可以使用 <a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_cmdb"><code>bin/inventory_cmdb</code></a> 切换到动态的 CMDB 清单，
使用 <a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_conf"><code>bin/inventory_conf</code></a> 返回到本地配置文件。
你还需要使用 <a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_load"><code>bin/inventory_load</code></a> 将当前的配置文件清单加载到 CMDB。</p>
<hr>
<h2 id="加载配置">加载配置</h2>
<p>Pigsty CMDB的模式会在<code>pg-meta</code>元数据库初始化时自动创建（<a href="https://github.com/Vonng/pigsty/blob/main/files/cmdb.sql"><code>files/cmdb.sql</code></a>），位于<code>meta</code>数据库的<code>pigsty</code> 模式中。使用<code>bin/inventory_load</code>可以将静态配置文件加载至CMDB中。</p>
<blockquote>
<p>必须在元节点完整执行 <a href="/zh/docs/infra#infrayml"><code>infra.yml</code></a> 安装完毕后，方可使用 CMDB</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>usage: inventory_load <span style="color:#ce5c00;font-weight:bold">[</span>-h<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>-p PATH<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>-d CMDB_URL<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>load config arguments
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>optional arguments:
</span></span><span style="display:flex;"><span>  -h, --help            show this <span style="color:#204a87">help</span> message and exit„
</span></span><span style="display:flex;"><span>  -p PATH, --path PATH  config path, <span style="color:#4e9a06">${</span><span style="color:#000">PIGSTY_HOME</span><span style="color:#4e9a06">}</span>/pigsty.yml by default
</span></span><span style="display:flex;"><span>  -d DATA, --data DATA  postgres cmdb pgurl, <span style="color:#4e9a06">${</span><span style="color:#000">METADB_URL</span><span style="color:#4e9a06">}</span> by default
</span></span></code></pre></div><p>默认情况下，不带参数执行该脚本将会把<code>$PIGSTY_HOME/pigsty.yml</code>的名称载入默认CMDB中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/inventory_load
</span></span><span style="display:flex;"><span>bin/inventory_load -p conf/demo.yml
</span></span><span style="display:flex;"><span>bin/inventory_load -p conf/prod.yml -d postgresql://dbuser_meta:DBUser.Meta@10.10.10.10:5432/meta
</span></span></code></pre></div><p>当原有配置文件加载至 CMDB 作为初始数据后，即可配置 Ansible 使用 CMDB 作为配置源：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/inventory_cmdb
</span></span></code></pre></div><p>您可以切换回静态配置文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/inventory_conf
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9f5474502d4f0b74cbd1e1f9ae23bc23">4 - 使用 Keepalived 为 Pigsty 节点集群配置二层 VIP</h1>
    
	<p>您可以在节点集群上绑定一个可选的 L2 VIP —— 前提条件是：集群中的所有节点都在一个二层网络中。</p>
<p>在节点集群（任何一个 Ansible Group，包括数据库集群定义都可以视作一个节点集群）上，启用 <a href="/zh/docs/reference/param#vip_enabled"><code>vip_enabled</code></a> 参数，即可在节点集群上启用 Keepalived ，绑定一个2层 VIP。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>proxy:
</span></span><span style="display:flex;"><span>  hosts:
</span></span><span style="display:flex;"><span>    10.10.10.29: <span style="color:#ce5c00;font-weight:bold">{</span> nodename: proxy-1 <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#8f5902;font-style:italic"># 您可以显式指定初始的 VIP 角色：MASTER / BACKUP</span>
</span></span><span style="display:flex;"><span>    10.10.10.30: <span style="color:#ce5c00;font-weight:bold">{</span> nodename: proxy-2 <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#8f5902;font-style:italic"># , vip_role: master }</span>
</span></span><span style="display:flex;"><span>  vars:
</span></span><span style="display:flex;"><span>    node_cluster: proxy
</span></span><span style="display:flex;"><span>    vip_enabled: <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>    vip_vrid: <span style="color:#0000cf;font-weight:bold">128</span>
</span></span><span style="display:flex;"><span>    vip_address: 10.10.10.99
</span></span><span style="display:flex;"><span>    vip_interface: eth1
</span></span></code></pre></div><p>使用以下命令，刷新节点的 Keepalived 配置，并生效：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./node.yml -l proxy -t node_vip     <span style="color:#8f5902;font-style:italic"># 首次启用 VIP </span>
</span></span><span style="display:flex;"><span>./node.yml -l proxy -t vip_refresh  <span style="color:#8f5902;font-style:italic"># 刷新 vip 配置（例如指定 master）</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d55948673c4562234cd1d0c550779f28">5 - 使用 VIP-Manager 为 PostgreSQL 集群配置二层 VIP</h1>
    
	<p>您可以在 PostgreSQL 集群上绑定一个可选的 L2 VIP —— 前提条件是：集群中的所有节点都在一个二层网络中。</p>
<p>这个 L2 VIP 强制使用 Master - Backup 模式，Master 始终指向在数据库集群主库实例所在的节点。</p>
<p>这个 VIP 由 <a href="https://github.com/cybertec-postgresql/vip-manager">VIP-Manager</a> 组件管理，它会从 DCS （etcd） 中直接读取由 Patroni 写入的 Leader Key，从而判断自己是否是 Master。</p>
<hr>
<h2 id="启用vip">启用VIP</h2>
<p>在 PostgreSQL 集群上定义 <a href="/zh/docs/reference/param#pg_vip_enabled"><code>pg_vip_enabled</code></a> 参数为 <code>true</code>，即可在集群上启用 VIP 组件。当然您也可以在全局配置中启用此配置项。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pgsql 3 node ha cluster: pg-test</span>
</span></span><span style="display:flex;"><span>pg-test:
</span></span><span style="display:flex;"><span>  hosts:
</span></span><span style="display:flex;"><span>    10.10.10.11: <span style="color:#ce5c00;font-weight:bold">{</span> pg_seq: 1, pg_role: primary <span style="color:#ce5c00;font-weight:bold">}</span>   <span style="color:#8f5902;font-style:italic"># primary instance, leader of cluster</span>
</span></span><span style="display:flex;"><span>    10.10.10.12: <span style="color:#ce5c00;font-weight:bold">{</span> pg_seq: 2, pg_role: replica <span style="color:#ce5c00;font-weight:bold">}</span>   <span style="color:#8f5902;font-style:italic"># replica instance, follower of leader</span>
</span></span><span style="display:flex;"><span>    10.10.10.13: <span style="color:#ce5c00;font-weight:bold">{</span> pg_seq: 3, pg_role: replica, pg_offline_query: <span style="color:#204a87">true</span> <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#8f5902;font-style:italic"># replica with offline access</span>
</span></span><span style="display:flex;"><span>  vars:
</span></span><span style="display:flex;"><span>    pg_cluster: pg-test           <span style="color:#8f5902;font-style:italic"># define pgsql cluster name</span>
</span></span><span style="display:flex;"><span>    pg_users:  <span style="color:#ce5c00;font-weight:bold">[{</span> name: <span style="color:#204a87">test</span> , password: <span style="color:#204a87">test</span> , pgbouncer: <span style="color:#204a87">true</span> , roles: <span style="color:#ce5c00;font-weight:bold">[</span> dbrole_admin <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">}]</span>
</span></span><span style="display:flex;"><span>    pg_databases: <span style="color:#ce5c00;font-weight:bold">[{</span> name: <span style="color:#204a87">test</span> <span style="color:#ce5c00;font-weight:bold">}]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 启用 L2 VIP</span>
</span></span><span style="display:flex;"><span>    pg_vip_enabled: <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>    pg_vip_address: 10.10.10.3/24
</span></span><span style="display:flex;"><span>    pg_vip_interface: eth1
</span></span></code></pre></div><p>请注意，<a href="/zh/docs/reference/param#pg_vip_address"><code>pg_vip_address</code></a> 必须是一个合法的 IP 地址，带有网段，且在当前二层网络中可用。</p>
<p>请注意，<a href="/zh/docs/reference/param#pg_vip_interface"><code>pg_vip_interface</code></a> 必须是一个合法的网络接口名，并且应当是与 inventory 中使用 IPv4 地址一致的网卡。
如果集群成员的网卡名不一样，用户应当为每个实例显式指定 <code>pg_vip_interface</code> 参数，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role: primary , pg_vip_interface</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">eth0  }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role: replica , pg_vip_interface</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">eth1  }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 3, pg_role: replica , pg_vip_interface</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ens33 }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># define pgsql cluster name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: test , password: test , pgbouncer: true , roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_admin ] }]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test }]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 启用 L2 VIP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_vip_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_vip_address</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.3</span><span style="color:#000">/24</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#pg_vip_interface: eth1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>使用以下命令，刷新 PG 的 vip-manager 配置并重启生效：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_vip 
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4f7bd649e98232d39a0fac447d3ad879">6 - 使用 PostgreSQL 作为 Grafana 后端数据库</h1>
    <div class="lead">使用 PostgreSQL 而不是 SQLite 作为 Grafana 后端使用的远程存储数据库，获取更好的性能与可用性。</div>
	<p>您可以使用 PostgreSQL 作为 Grafana 后端使用的数据库。</p>
<p>这是了解Pigsty部署系统使用方式的好机会，完成此教程，您会了解：</p>
<ul>
<li>如何<a href="/zh/docs/tasks/grafana/#创建数据库集群">创建新数据库集群</a></li>
<li>如何在已有数据库集群中<a href="/zh/docs/tasks/grafana/#创建grafana业务用户">创建新业务用户</a></li>
<li>如何在已有数据库集群中<a href="/zh/docs/tasks/grafana/#创建grafana业务数据库">创建新业务数据库</a></li>
<li>如何<a href="/zh/docs/tasks/grafana/#使用grafana业务数据库">访问Pigsty所创建的数据库</a></li>
<li>如何<a href="/zh/docs/tasks/grafana/#管理grafana监控面板">管理Grafana中的监控面板</a></li>
<li>如何管理Grafana中的<a href="/zh/docs/tasks/grafana/#管理postgres数据源">PostgreSQL数据源</a></li>
<li>如何一步到位完成<a href="/zh/docs/tasks/grafana/#一步到位更新grafana">Grafana数据库升级</a></li>
</ul>
<hr>
<h2 id="太长不看">太长不看</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi pigsty.yml <span style="color:#8f5902;font-style:italic"># 取消注释DB/User定义：dbuser_grafana  grafana </span>
</span></span><span style="display:flex;"><span>bin/pgsql-user  pg-meta  dbuser_grafana
</span></span><span style="display:flex;"><span>bin/pgsql-db    pg-meta  grafana
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>psql postgres://dbuser_grafana:DBUser.Grafana@meta:5436/grafana -c <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  <span style="color:#4e9a06">&#39;CREATE TABLE t(); DROP TABLE t;&#39;</span> <span style="color:#8f5902;font-style:italic"># 检查连接串可用性</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>vi /etc/grafana/grafana.ini <span style="color:#8f5902;font-style:italic"># 修改 [database] type url</span>
</span></span><span style="display:flex;"><span>systemctl restart grafana-server
</span></span></code></pre></div><hr>
<h2 id="创建数据库集群">创建数据库集群</h2>
<p>我们可以在<code>pg-meta</code>上定义一个新的数据库<code>grafana</code>，也可以在新的机器节点上创建一个专用于Grafana的数据库集群：<code>pg-grafana</code></p>
<h3 id="定义集群">定义集群</h3>
<p>如果需要创建新的专用数据库集群<code>pg-grafana</code>，部署在<code>10.10.10.11</code>，<code>10.10.10.12</code>两台机器上，可以使用以下配置文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-grafana</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">revokeconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">grafana primary database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pgbouncer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">dbrole_admin]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for grafana database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="创建集群">创建集群</h3>
<p>使用以下命令完成数据库集群<code>pg-grafana</code>的创建：<a href="p-pgsql.yml"><code>pgsql.yml</code></a>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/createpg pg-grafana    <span style="color:#8f5902;font-style:italic"># 初始化pg-grafana集群</span>
</span></span></code></pre></div><p>该命令实际上调用了Ansible Playbook <a href="p-pgsq.md"><code>pgsql.yml</code></a> 创建数据库集群。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -l pg-grafana  <span style="color:#8f5902;font-style:italic"># 实际执行的等效Ansible剧本命令 </span>
</span></span></code></pre></div><p>定义在 <a href="/zh/docs/pgsql/config#pg_users"><code>pg_users</code></a> 与 <a href="/zh/docs/pgsql/config#pg_databases"><code>pg_databases</code></a> 中的业务用户与业务数据库会在集群初始化时自动创建，因此使用该配置时，集群创建完毕后，（在没有DNS支持的情况下）您可以使用以下连接串<a href="/zh/docs/pgsql/concept/access">访问</a>数据库（任一即可）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.11:5432/grafana <span style="color:#8f5902;font-style:italic"># 主库直连</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.11:5436/grafana <span style="color:#8f5902;font-style:italic"># 直连default服务</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.11:5433/grafana <span style="color:#8f5902;font-style:italic"># 连接串读写服务</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.12:5432/grafana <span style="color:#8f5902;font-style:italic"># 主库直连</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.12:5436/grafana <span style="color:#8f5902;font-style:italic"># 直连default服务</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.12:5433/grafana <span style="color:#8f5902;font-style:italic"># 连接串读写服务</span>
</span></span></code></pre></div><p>因为默认情况下Pigsty安装在<strong>单个元节点</strong>上，接下来的步骤我们会在已有的<code>pg-meta</code>数据库集群上创建Grafana所需的用户与数据库，而并非使用这里创建的<code>pg-grafana</code>集群。</p>
<hr>
<h2 id="创建grafana业务用户">创建Grafana业务用户</h2>
<p>通常业务对象管理的惯例是：先创建用户，再创建数据库。
因为如果为数据库配置了<code>owner</code>，数据库对相应的用户存在依赖。</p>
<h3 id="定义用户">定义用户</h3>
<p>要在<code>pg-meta</code>集群上创建用户<code>dbuser_grafana</code>，首先将以下用户定义添加至<code>pg-meta</code>的<a href="/zh/docs/tasks/grafana/#定义集群">集群定义</a>中：</p>
<p>添加位置：<code>all.children.pg-meta.vars.pg_users</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for grafana database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pgbouncer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_admin ]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><blockquote>
<p>如果您在这里定义了不同的密码，请在后续步骤中将相应参数替换为新密码</p>
</blockquote>
<h3 id="创建用户">创建用户</h3>
<p>使用以下命令完成<code>dbuser_grafana</code>用户的创建（任一均可）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-user pg-meta dbuser_grafana <span style="color:#8f5902;font-style:italic"># 在pg-meta集群上创建`dbuser_grafana`用户</span>
</span></span></code></pre></div><p>实际上调用了Ansible Playbook <a href="/zh/docs/pgsql/playbook#pgsql-createuser"><code>pgsql-createuser.yml</code></a> 创建用户</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql-user.yml -l pg-meta -e <span style="color:#000">pg_user</span><span style="color:#ce5c00;font-weight:bold">=</span>dbuser_grafana  <span style="color:#8f5902;font-style:italic"># Ansible</span>
</span></span></code></pre></div><p><code>dbrole_admin</code> 角色具有在数据库中执行DDL变更的权限，这正是Grafana所需要的。</p>
<hr>
<h2 id="创建grafana业务数据库">创建Grafana业务数据库</h2>
<h3 id="定义数据库">定义数据库</h3>
<p>创建业务数据库的方式与业务用户一致，首先在<code>pg-meta</code>的集群定义中添加新数据库<code>grafana</code>的<a href="/zh/docs/tasks/grafana/#定义集群">定义</a>。</p>
<p>添加位置：<code>all.children.pg-meta.vars.pg_databases</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: grafana, owner: dbuser_grafana, revokeconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="创建数据库">创建数据库</h3>
<p>使用以下命令完成<code>grafana</code>数据库的创建（任一均可）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-db pg-meta grafana <span style="color:#8f5902;font-style:italic"># 在`pg-meta`集群上创建`grafana`数据库</span>
</span></span></code></pre></div><p>实际上调用了Ansible Playbook <a href="/zh/docs/pgsql/playbook#pgsql-createdb"><code>pgsql-createdb.yml</code></a> 创建数据库</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql-db.yml -l pg-meta -e <span style="color:#000">pg_database</span><span style="color:#ce5c00;font-weight:bold">=</span>grafana <span style="color:#8f5902;font-style:italic"># 实际执行的Ansible剧本</span>
</span></span></code></pre></div><hr>
<h2 id="使用grafana业务数据库">使用Grafana业务数据库</h2>
<h3 id="检查连接串可达性">检查连接串可达性</h3>
<p>您可以使用不同的<a href="/zh/docs/pgsql/concept/service">服务</a>或<a href="/zh/docs/pgsql/concept/access">接入</a>方式访问数据库，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@meta:5432/grafana <span style="color:#8f5902;font-style:italic"># 直连</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@meta:5436/grafana <span style="color:#8f5902;font-style:italic"># default服务</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@meta:5433/grafana <span style="color:#8f5902;font-style:italic"># primary服务</span>
</span></span></code></pre></div><p>这里，我们将使用通过负载均衡器直接访问主库的 <a href="/zh/docs/concept/svc#default%E6%9C%8D%E5%8A%A1">Default服务</a>访问数据库。</p>
<p>首先检查连接串是否可达，以及是否有权限执行DDL命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres://dbuser_grafana:DBUser.Grafana@meta:5436/grafana -c <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  <span style="color:#4e9a06">&#39;CREATE TABLE t(); DROP TABLE t;&#39;</span>
</span></span></code></pre></div><h3 id="直接修改grafana配置">直接修改Grafana配置</h3>
<p>为了让Grafana使用 Postgres 数据源，您需要编辑 <code>/etc/grafana/grafana.ini</code>，并修改配置项：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[database]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;type = sqlite3</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;host = 127.0.0.1:3306</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;name = grafana</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;user = root</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If the password contains # or ; you have to wrap it with triple quotes. Ex &#34;&#34;&#34;#password;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;password =</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;url =</span>
</span></span></code></pre></div><p>将默认的配置项修改为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[database]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">postgres</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">url</span> <span style="color:#ce5c00;font-weight:bold">=</span>  <span style="color:#4e9a06">postgres://dbuser_grafana:DBUser.Grafana@meta/grafana</span>
</span></span></code></pre></div><p>随后重启Grafana即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl restart grafana-server
</span></span></code></pre></div><p>从监控系统中看到新增的 <a href="http://g.pigsty.cc/d/pgsql-database/pgsql-database?var-cls=pg-meta&var-ins=pg-meta-1&var-datname=grafana&orgId=1"><code>grafana</code></a> 数据库已经开始有活动，则说明Grafana已经开始使用Postgres作为首要后端数据库了。
但一个新的问题是，Grafana中原有的Dashboards与Datasources都消失了！这里需要重新导入<a href="/zh/docs/tasks/grafana/#管理grafana监控面板">监控面板</a>与<a href="/zh/docs/tasks/grafana/#管理ostgres数据源">Postgres数据源</a></p>
<hr>
<h2 id="管理grafana监控面板">管理Grafana监控面板</h2>
<p>您可以使用管理用户前往 Pigsty 目录下的<code>files/ui</code>目录，执行<code>grafana.py init</code>重新加载Pigsty监控面板。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty/files/ui
</span></span><span style="display:flex;"><span>./grafana.py init    <span style="color:#8f5902;font-style:italic"># 使用当前目录下的Dashboards初始化Grafana监控面板</span>
</span></span></code></pre></div><p>执行结果：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@meta:~/pigsty/files/ui
</span></span><span style="display:flex;"><span>$ ./grafana.py init
</span></span><span style="display:flex;"><span>Grafana API: admin:pigsty @ http://10.10.10.10:3000
</span></span><span style="display:flex;"><span>init dashboard : home.json
</span></span><span style="display:flex;"><span>init folder pgcat
</span></span><span style="display:flex;"><span>init dashboard: pgcat / pgcat-table.json
</span></span><span style="display:flex;"><span>init dashboard: pgcat / pgcat-bloat.json
</span></span><span style="display:flex;"><span>init dashboard: pgcat / pgcat-query.json
</span></span><span style="display:flex;"><span>init folder pgsql
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-replication.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-table.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-activity.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-cluster.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-node.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-database.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-xacts.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-overview.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-session.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-tables.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-instance.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-queries.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-alert.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-service.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-persist.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-proxy.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-query.json
</span></span><span style="display:flex;"><span>init folder pglog
</span></span><span style="display:flex;"><span>init dashboard: pglog / pglog-instance.json
</span></span><span style="display:flex;"><span>init dashboard: pglog / pglog-analysis.json
</span></span><span style="display:flex;"><span>init dashboard: pglog / pglog-session.json
</span></span></code></pre></div><p>该脚本会侦测当前的环境（安装时定义于<code>~/pigsty</code>），获取Grafana的访问信息，并将监控面板中的URL连接占位符域名（<code>*.pigsty</code>）替换为真实使用的域名。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">GRAFANA_ENDPOINT</span><span style="color:#ce5c00;font-weight:bold">=</span>http://10.10.10.10:3000
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">GRAFANA_USERNAME</span><span style="color:#ce5c00;font-weight:bold">=</span>admin
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">GRAFANA_PASSWORD</span><span style="color:#ce5c00;font-weight:bold">=</span>pigsty
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">NGINX_UPSTREAM_YUMREPO</span><span style="color:#ce5c00;font-weight:bold">=</span>yum.pigsty
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">NGINX_UPSTREAM_CONSUL</span><span style="color:#ce5c00;font-weight:bold">=</span>c.pigsty
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">NGINX_UPSTREAM_PROMETHEUS</span><span style="color:#ce5c00;font-weight:bold">=</span>p.pigsty
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">NGINX_UPSTREAM_ALERTMANAGER</span><span style="color:#ce5c00;font-weight:bold">=</span>a.pigsty
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">NGINX_UPSTREAM_GRAFANA</span><span style="color:#ce5c00;font-weight:bold">=</span>g.pigsty
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">NGINX_UPSTREAM_HAPROXY</span><span style="color:#ce5c00;font-weight:bold">=</span>h.pigsty
</span></span></code></pre></div><p>题外话，使用<code>grafana.py clean</code>会清空目标监控面板，使用<code>grafana.py load</code>会加载当前目录下所有监控面板，当Pigsty的监控面板发生变更，可以使用这两个命令升级所有的监控面板。</p>
<h2 id="管理postgres数据源">管理Postgres数据源</h2>
<p>当使用 <a href="p-pgsql"><code>pgsql.yml</code></a> 创建新PostgreSQL集群，或使用<a href="p-pgsql-createdb"><code>pgsql-createdb.yml</code></a>创建新业务数据库时，Pigsty会在Grafana中注册新的PostgreSQL数据源，您可以使用默认的监控用户通过Grafana直接访问目标数据库实例。应用<code>pgcat</code>的绝大部分功能有赖于此。</p>
<p>要注册Postgres数据库，可以使用<a href="p-pgsql"><code>pgsql.yml</code></a>中的<code>register_grafana</code>任务：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t register_grafana             <span style="color:#8f5902;font-style:italic"># 重新注册当前环境中所有Postgres数据源</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t register_grafana -l pg-test  <span style="color:#8f5902;font-style:italic"># 重新注册 pg-test 集群中所有的数据库</span>
</span></span></code></pre></div><hr>
<h2 id="一步到位更新grafana">一步到位更新Grafana</h2>
<p>您可以直接通过修改Pigsty配置文件，更改Grafana使用的后端数据源，一步到位的完成切换Grafana后端数据库的工作。编辑<code>pigsty.yml</code>中<a href="/zh/docs/infra/config#grafana_database"><code>grafana_database</code></a>与<a href="/zh/docs/infra/config#grafana_pgurl"><code>grafana_pgurl</code></a>参数，将其修改为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">grafana_database</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">grafana_pgurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres://dbuser_grafana:DBUser.Grafana@meta:5436/grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>然后重新执行 <a href="p-meta"><code>infral.yml</code></a>中的<code>grafana</code>任务，即可完成 Grafana升级</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./infra.yml -t grafana
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8ccc56d4ade450368e94558922ba0706">7 - 使用 TimescaleDB &#43; Promscale 存储 Prometheus 时序指标数据</h1>
    <div class="lead">您可以通过 Promscale，使用TimescaleDB持久化Prometheus指标数据。</div>
	<p>虽然这并不是推荐的行为，但这是了解Pigsty部署系统使用方式的好机会。</p>
<p>注意，使用 Promscale 存储 Prometheus 指标占用的存储空间大约是 Prometheus 的 4 倍，但是可以使用 SQL 来查询分析 Prometheus 监控指标。</p>
<h2 id="准备postgres数据库">准备Postgres数据库</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi pigsty.yml <span style="color:#8f5902;font-style:italic"># 取消注释DB/User定义：dbuser_prometheus  prometheus</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pg_databases:                           <span style="color:#8f5902;font-style:italic"># define business users/roles on this cluster, array of user definition</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ce5c00;font-weight:bold">{</span> name: prometheus, owner: dbuser_prometheus , revokeconn: true, comment: prometheus primary database <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>pg_users:                           <span style="color:#8f5902;font-style:italic"># define business users/roles on this cluster, array of user definition</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ce5c00;font-weight:bold">{</span>name: dbuser_prometheus , password: DBUser.Prometheus ,pgbouncer: <span style="color:#204a87">true</span> , createrole: true,  roles: <span style="color:#ce5c00;font-weight:bold">[</span>dbrole_admin<span style="color:#ce5c00;font-weight:bold">]</span>, comment: admin user <span style="color:#204a87;font-weight:bold">for</span> prometheus database <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>创建 Prometheus 业务数据库与业务用户。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/createuser  pg-meta  dbuser_prometheus
</span></span><span style="display:flex;"><span>bin/createdb    pg-meta  prometheus
</span></span></code></pre></div><p>检查数据库可用性并创建扩展</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres://dbuser_prometheus:DBUser.Prometheus@10.10.10.10:5432/prometheus -c <span style="color:#4e9a06">&#39;CREATE EXTENSION timescaledb;&#39;</span>
</span></span></code></pre></div><h2 id="配置promscale">配置Promscale</h2>
<p>在元节点上执行以下命令安装 <code>promscale</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y promscale 
</span></span></code></pre></div><p>如果默认软件包中没有，可以直接下载：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/timescale/promscale/releases/download/0.6.1/promscale_0.6.1_Linux_x86_64.rpm
</span></span><span style="display:flex;"><span>sudo rpm -ivh promscale_0.6.1_Linux_x86_64.rpm
</span></span></code></pre></div><p>编辑 <code>promscale</code> 的配置文件 <code>/etc/sysconfig/promscale.conf</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">PROMSCALE_DB_HOST</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PROMSCALE_DB_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;prometheus&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PROMSCALE_DB_PASSWORD</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;DBUser.Prometheus&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PROMSCALE_DB_PORT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;5432&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PROMSCALE_DB_SSL_MODE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;disable&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PROMSCALE_DB_USER</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;dbuser_prometheus&#34;</span>
</span></span></code></pre></div><p>最后启动promscale，它会访问安装有 <code>timescaledb</code> 的数据库实例，并创建所需的schema</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># launch </span>
</span></span><span style="display:flex;"><span>cat /usr/lib/systemd/system/promscale.service
</span></span><span style="display:flex;"><span>systemctl start promscale <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> systemctl status promscale
</span></span></code></pre></div><h2 id="配置prometheus">配置Prometheus</h2>
<p>Prometheus可以使用Remote Write/ Remote Read的方式，通过Promscale，使用Postgres作为远程存储。</p>
<p>编辑Prometheus配置文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi /etc/prometheus/prometheus.yml
</span></span></code></pre></div><p>添加以下记录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">remote_write</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;http://127.0.0.1:9201/write&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">remote_read</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;http://127.0.0.1:9201/read&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>重启Prometheus后，监控数据即可放入Postgres中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl restart prometheus
</span></span></code></pre></div>
</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Mail" aria-label="Mail">
    <a target="_blank" rel="noopener" href="mailto:rh@vonng.com" aria-label="Mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Vonng/pigsty" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://twitter.com/GobeUncleWang" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="WeChat" aria-label="WeChat">
    <a target="_blank" rel="noopener" href="/img/pigsty/pigsty-cc.jpg" aria-label="WeChat">
      <i class="fa fa-comment"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Discord" aria-label="Discord">
    <a target="_blank" rel="noopener" href="https://discord.gg/wDzt5VyWEz" aria-label="Discord">
      <i class="fab fa-discord"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Telegram" aria-label="Telegram">
    <a target="_blank" rel="noopener" href="https://t.me/joinchat/gV9zfZraNPM3YjFh" aria-label="Telegram">
      <i class="fab fa-telegram"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2018&ndash;2024
    <span class="td-footer__authors">Ruohang Feng</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span></span><span class="ms-2"><a href="https://vonng.com/en/" target="_blank" rel="noopener">@Vonng</a></span>
<br><span>Pigsty® distributed under <a href="/docs/about/license" target="_blank" rel="noopener">AGPLv3</a></span>
<br><span class="ms-2"><a href="/docs/about/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
<span><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">浙ICP备15016890号</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.248655eb216150e39da254c2f7aa5357805d0ec66bdb741b591cd35fb5f629ab.js" integrity="sha256-JIZV6yFhUOOdolTC96pTV4BdDsZr23QbWRzTX7X2Kas=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
