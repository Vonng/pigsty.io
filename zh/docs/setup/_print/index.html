<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="/zh/docs/setup/">
<link rel="alternate" type="application/rss&#43;xml" href="/zh/docs/setup/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>快速开始 | Pigsty</title>
<meta name="description" content="快速上手 Pigsty：根据需求进行规划，准备资源，置备服务器，创建管理用户，下载软件并完成安装。">
<meta property="og:title" content="快速开始" />
<meta property="og:description" content="快速上手 Pigsty：根据需求进行规划，准备资源，置备服务器，创建管理用户，下载软件并完成安装。" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/zh/docs/setup/" />

<meta itemprop="name" content="快速开始">
<meta itemprop="description" content="快速上手 Pigsty：根据需求进行规划，准备资源，置备服务器，创建管理用户，下载软件并完成安装。"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="快速开始"/>
<meta name="twitter:description" content="快速上手 Pigsty：根据需求进行规划，准备资源，置备服务器，创建管理用户，下载软件并完成安装。"/>




<link rel="preload" href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" as="style">
<link href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="/js/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LG1V9WTKGE');
}
</script>
  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/zh/"><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class="navbar-brand__name">Pigsty</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/zh/docs/"><i class='fa-solid fa-book'></i><span>文档</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/zh/blog/"><i class="fas fa-blog"></i><span>博客</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/Vonng/pigsty/" target="_blank" rel="noopener"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-language"></i>中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/docs/setup/">English</a></li>
    </ul>
</div>
</li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.69dec130450c1c9e9e7b7226c42a9aca.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/zh/docs/setup/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">快速开始</h1>
<div class="lead">快速上手 Pigsty：根据需求进行规划，准备资源，置备服务器，创建管理用户，下载软件并完成安装。</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-feb220ce98138be93707bc30fc029cd1">安装部署</a></li>


    
  
    
    
	
<li>2: <a href="#pg-01b2a33b37e8e7124df9aa116794fa36">离线安装</a></li>


    
  
    
    
	
<li>3: <a href="#pg-c38b3e7bce8cb65ffd26ccafa496eb5e">精简安装</a></li>


    
  
    
    
	
<li>4: <a href="#pg-d96b1765e9d967725a0824edd07fe95d">声明配置</a></li>


    
  
    
    
	
<li>5: <a href="#pg-24263fa625b63eabb5c32f29ec96c5f7">准备工作</a></li>


    
  
    
    
	
<li>6: <a href="#pg-98758ad7ef56ab0b1a9ad8320b14506b">执行剧本</a></li>


    
  
    
    
	
<li>7: <a href="#pg-2b6cc71ea6f4c2bb3c7905255869cead">置备机器</a></li>


    
  
    
    
	
<li>8: <a href="#pg-d6a656f7f8306b7de558a78bf1164ae0">安全考量</a></li>


    
  
    
    
	
<li>9: <a href="#pg-262f396efed9aff5d120f3d92b472bdf">常见问题</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-feb220ce98138be93707bc30fc029cd1">1 - 安装部署</h1>
    <div class="lead">下载、配置、安装 Pigsty</div>
	<blockquote>
<p>安装 Pigsty 四步走: <a href="/zh/docs/setup/install/#准备"><strong>准备</strong></a>，<a href="/zh/docs/setup/install/#下载"><strong>下载</strong></a>，<a href="/zh/docs/setup/install/#配置"><strong>配置</strong></a>，以及 <a href="/zh/docs/setup/install/#安装"><strong>安装</strong></a>。没有互联网访问，请同时参阅 <a href="/zh/docs/setup/offline/"><strong>离线安装</strong></a>。</p>
</blockquote>
<hr>
<h2 id="简短版本">简短版本</h2>
<p><a href="https://pigsty.io/docs/pgsql"><img alt="Postgres: 17.2" src="https://img.shields.io/badge/PostgreSQL-17.2-%233E668F?style=flat&logo=postgresql&labelColor=3E668F&logoColor=white"></a>
<a href="https://pigsty.io/docs/node"><img alt="Linux" src="https://img.shields.io/badge/Linux-%23FCC624?style=flat&logo=linux&labelColor=FCC624&logoColor=black"></a>
<a href="https://pigsty.io/zh/docs/pgext/list/rpm/"><img alt="EL Support: 7/8/9" src="https://img.shields.io/badge/EL-7/8/9-red?style=flat&logo=redhat&logoColor=red"></a>
<a href="https://pigsty.io/docs/reference/compatibility/"><img alt="Debian Support: 11/12" src="https://img.shields.io/badge/Debian-11/12-%23A81D33?style=flat&logo=debian&logoColor=%23A81D33"></a>
<a href="https://pigsty.io/zh/docs/pgext/list/deb/"><img alt="Ubuntu Support: 20/22/24" src="https://img.shields.io/badge/Ubuntu-20/22/24-%23E95420?style=flat&logo=ubuntu&logoColor=%23E95420"></a>
<a href="https://almalinux.org/"><img alt="Alma" src="https://img.shields.io/badge/Alma-slategray?style=flat&logo=almalinux&logoColor=black"></a>
<a href="https://almalinux.org/"><img alt="Rocky" src="https://img.shields.io/badge/Rocky-slategray?style=flat&logo=rockylinux&logoColor=%2310B981"></a>
<a href="https://almalinux.org/"><img alt="CentOS" src="https://img.shields.io/badge/CentOS-slategray?style=flat&logo=centos&logoColor=%23262577"></a>
<a href="https://almalinux.org/"><img alt="OracleLinux" src="https://img.shields.io/badge/Oracle-slategray?style=flat&logo=oracle&logoColor=%23F80000"></a></p>
<p><a href="/zh/docs/setup/install/#准备"><strong>准备</strong></a> 一个安装了 <a href="/zh/docs/reference/compatibility/"><strong>兼容</strong></a> 操作系统的 Linux <code>x86_64</code> / <code>aarch64</code> 节点，使用带有免密 <code>sudo</code> 权限的用户，执行以下命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -fsSL https://repo.pigsty.io/get <span style="color:#000;font-weight:bold">|</span> bash<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">cd</span> ~/pigsty<span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>该命令会 <a href="/zh/docs/setup/install/#下载"><strong>下载</strong></a> 并解压 Pigsty 源码至家目录，依次完成 <a href="/zh/docs/setup/install/#配置"><strong>配置</strong></a> 与<a href="/zh/docs/setup/install/#安装"><strong>安装</strong></a> 即可完成安装。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./bootstrap<span style="color:#000;font-weight:bold">;</span> ./configure<span style="color:#000;font-weight:bold">;</span> ./install.yml<span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic"># 准备依赖，生成配置，安装 Pigsty 三步走！</span>
</span></span></code></pre></div><ul>
<li><a href="/zh/docs/setup/offline/#bootstrap"><strong>bootstrap</strong></a>：【可选】用于确保 Ansible 正常安装，如果 <code>/tmp/pkg.tgz</code> <a href="/zh/docs/setup/offline/#离线软件包"><strong>离线包</strong></a>存在则使用它</li>
<li><a href="/zh/docs/setup/install/#配置"><strong>configure</strong></a>：【可选】检测环境并自动生成相应的推荐配置文件，如果知道如何 <a href="/zh/docs/setup/config/"><strong>配置</strong></a> Pigsty可以直接跳过</li>
<li><a href="/zh/docs/setup/install/#安装"><strong>install.yml</strong></a>：根据生成的配置文件开始在当前节点上执行安装，</li>
</ul>
<p>整个安装过程根据服务器规格/网络条件需 5 到 30 分钟不等，<a href="/zh/docs/setup/offline/#离线软件包"><strong>离线安装</strong></a>可以显著加速。</p>
<p>安装完成后，您可以通过域名，或<code>80/443</code>端口通过 Nginx 访问 WEB <a href="/zh/docs/setup/install/#用户界面"><strong>界面</strong></a>，
通过 <code>5432</code> 端口 <a href="/zh/docs/concept/svc#%E6%8E%A5%E5%85%A5%E6%9C%8D%E5%8A%A1"><strong>访问</strong></a> 默认的 PostgreSQL 数据库 <a href="/zh/docs/concept/svc/"><strong>服务</strong></a>。
您可以继续使用 Pigsty 纳管 <a href="/zh/docs/setup/install/#更多"><strong>更多</strong></a> 节点，并部署各种 <a href="/zh/docs/about/module/"><strong>模块</strong></a>。</p>
<p>如果您觉得 Pigsty 的组件过于复杂，还可以考虑使用 <a href="/zh/docs/setup/slim/"><strong>最小化安装</strong></a> ，仅安装高可用 PostgreSQL 集群所必需的组件。</p>
<p><strong>视频样例：在线单机安装（EL9）</strong></p>
<p><a href="https://asciinema.org/a/673459"><img alt="asciicast" src="https://asciinema.org/a/673459.svg"></a></p>
<hr>
<h2 id="使用命令行工具">使用命令行工具</h2>
<p>Pigsty 在 v3.2 后提供了命令行工具：<a href="https://github.com/pgsty/pig"><code>pig</code></a>，可用于安装 Pigsty，生成配置，执行部署等操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl https://repo.pigsty.io/pig <span style="color:#000;font-weight:bold">|</span> bash  <span style="color:#8f5902;font-style:italic"># 国际区域</span>
</span></span><span style="display:flex;"><span>curl https://repo.pigsty.cc/pig <span style="color:#000;font-weight:bold">|</span> bash  <span style="color:#8f5902;font-style:italic"># 中国大陆</span>
</span></span></code></pre></div><p>以上命令会自动安装 <code>pig</code> 命令行工具（目前支持 Linux amd64 / arm64），您可以直接使用 <code>pig sty</code> 子命令来完成上面的步骤：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pig sty init     <span style="color:#8f5902;font-style:italic"># 默认安装嵌入的最新 Pigsty 版本</span>
</span></span><span style="display:flex;"><span>pig sty boot     <span style="color:#8f5902;font-style:italic"># 执行 Bootstrap，安装 Ansible</span>
</span></span><span style="display:flex;"><span>pig sty conf     <span style="color:#8f5902;font-style:italic"># 执行 Configure，生成配置文件</span>
</span></span><span style="display:flex;"><span>pig sty install  <span style="color:#8f5902;font-style:italic"># 执行 install.yml 剧本完成部署</span>
</span></span></code></pre></div><hr>
<h2 id="准备">准备</h2>
<blockquote>
<p>关于准备工作的完整详细说明，请参考 <a href="/zh/docs/setup/prepare"><strong>入门：准备工作</strong></a> 一节。</p>
</blockquote>
<p>Pigsty 支持 <code>Linux</code> 内核与 <code>x86_64/aarch64</code> 架构，运行于物理机、虚拟机环境中，要求使用<strong>静态IP地址</strong>。
最低配置要求为 <code>1C1G</code>，推荐至少使用 <code>2C4G</code> 以上的机型，上不封顶，参数会自动优化适配。</p>
<p>我们强烈建议您使用刚安装完操作系统的全新节点部署，从而避免无谓的安装异常问题，建议使用 <strong>RockyLinux 8.9</strong> 或 <strong>Ubuntu 22.04.3</strong>，
支持的完整操作系统列表请参考 <a href="/zh/docs/reference/compatibility"><strong>兼容性</strong></a>。</p>
<p>在安装 Pigsty 的管理节点上，您需要拥有 <code>ssh</code> 登陆权限与 <code>sudo</code> 权限。
如果您的部署涉及多个节点，您应当确保当前管理用户在当前管理节点上，可以通过 SSH 公钥免密登陆其他被管理的节点（包括本节点）。</p>


<div class="alert alert-danger" role="alert">
<h4 class="alert-heading">避免使用 root 用户安装</h4>

    尽管使用 <code>root</code> 用户安装 Pigsty 是可行的，但 <a href="/zh/docs/setup/security/">安全最佳实践</a>
是使用一个不同于根用户（<code>root</code>）与数据库超级用户 (<code>postgres</code>) 的专用管理员用户（如：<code>dba</code>），
Pigsty 安装过程中会默认创建由配置文件指定的可选管理员用户 <code>dba</code>。

</div>

<p>Pigsty 依赖 Ansible 执行剧本，在执行安装前，您需要先安装 <code>ansible</code> 与 <code>jmespath</code> 软件包。
您可以通过 <a href="/zh/docs/setup/offline/#bootstrap"><strong><code>bootstrap</code></strong></a> 脚本完成这一任务，特别是当您没有互联网访问，需要进行<a href="/zh/docs/setup/offline/"><strong>离线安装</strong></a>时。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./bootstrap   <span style="color:#8f5902;font-style:italic"># 使用各种可选方式安装 Ansible 与 Jmespath 依赖，如果离线包存在则使用离线包</span>
</span></span></code></pre></div><p>您也可以直接使用操作系统的包管理器安装所需的 Ansible 与 Jmespath 软件包：</p>






<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        安装 Ansible
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          aria-controls="tabs-01-01" aria-selected="true">
        EL 8 / 9
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          aria-controls="tabs-01-02" aria-selected="false">
        EL 7
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-03" role="tab"
          aria-controls="tabs-01-03" aria-selected="false">
        Debian / Ubuntu
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-04" role="tab"
          aria-controls="tabs-01-04" aria-selected="false">
        MacOS
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"></code></pre></div>
    </div>
    <div class="tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>sudo dnf install -y ansible python3.12-jmespath python3-cryptography</span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>sudo yum install -y ansible   <span style="color:#8f5902;font-style:italic"># EL7 无需显式安装 Jmespath</span></span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-01-03" role="tabpanel" aria-labelled-by="tabs-01-03-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>sudo apt install -y ansible python3-jmespath</span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-01-04" role="tabpanel" aria-labelled-by="tabs-01-04-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>brew install ansible</span></span></code></pre></div>
    </div>
</div>

<hr>
<h2 id="下载">下载</h2>
<p>您可以使用以下命令自动下载、解压 Pigsty 源码包至 <code>~/pigsty</code> 目录下使用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -fsSL https://repo.pigsty.cc/get <span style="color:#000;font-weight:bold">|</span> bash            <span style="color:#8f5902;font-style:italic"># 安装最新稳定版本 </span>
</span></span><span style="display:flex;"><span>curl -fsSL https://repo.pigsty.cc/get <span style="color:#000;font-weight:bold">|</span> bash -s v3.2.0  <span style="color:#8f5902;font-style:italic"># 安装特定版本 3.2.0</span>
</span></span></code></pre></div><details><summary>一键下载脚本的样例输出</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -fsSL https://repo.pigsty.cc/get <span style="color:#000;font-weight:bold">|</span> bash 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>v3.2.0<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span><span style="display:flex;"><span>$ curl -fsSL https://repo.pigsty.cc/get <span style="color:#000;font-weight:bold">|</span> bash
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Site<span style="color:#ce5c00;font-weight:bold">]</span> https://pigsty.io
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Demo<span style="color:#ce5c00;font-weight:bold">]</span> https://demo.pigsty.cc
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Repo<span style="color:#ce5c00;font-weight:bold">]</span> https://github.com/Vonng/pigsty
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Docs<span style="color:#ce5c00;font-weight:bold">]</span> https://pigsty.io/docs/setup/install
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Download<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">version</span> <span style="color:#ce5c00;font-weight:bold">=</span> v3.2.0 <span style="color:#ce5c00;font-weight:bold">(</span>from default<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>curl -fSL https://repo.pigsty.cc/src/pigsty-v3.2.0.tgz -o /tmp/pigsty-v3.2.0.tgz
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">tarball</span> <span style="color:#ce5c00;font-weight:bold">=</span> /tmp/pigsty-v3.2.0.tgz exists, <span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">=</span> 1227379, use it
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">md5sums</span> <span style="color:#ce5c00;font-weight:bold">=</span> xxxxxx  /tmp/pigsty-v3.2.0.tgz
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Install<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> os <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> root , it<span style="color:#4e9a06">&#39;s recommended to install as a sudo-able admin
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[WARN] pigsty already installed on &#39;</span>/root/pigsty<span style="color:#4e9a06">&#39;, if you wish to overwrite:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">sudo rm -rf /tmp/pigsty_bk; cp -r /root/pigsty /tmp/pigsty_bk; # backup old
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">sudo rm -rf /tmp/pigsty;    tar -xf /tmp/pigsty-v3.2.0.tgz -C /tmp/; # extract new
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">rsync -av --exclude=&#39;</span>/pigsty.yml<span style="color:#4e9a06">&#39; --exclude=&#39;</span>/files/pki/***<span style="color:#a40000">&#39;</span> /tmp/pigsty/ /root/pigsty/<span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic"># rsync src</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>TodoList<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> /root/pigsty
</span></span><span style="display:flex;"><span>./bootstrap      <span style="color:#8f5902;font-style:italic"># [OPTIONAL] install ansible &amp; use offline package</span>
</span></span><span style="display:flex;"><span>./configure      <span style="color:#8f5902;font-style:italic"># [OPTIONAL] preflight-check and config generation</span>
</span></span><span style="display:flex;"><span>./install.yml    <span style="color:#8f5902;font-style:italic"># install pigsty modules according to your config.</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Complete<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span></code></pre></div></details><br>
<p>你也可以使用 <code>git</code> 来下载 Pigsty 源代码，请 <strong>务必</strong> 检出特定版本后使用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/Vonng/pigsty<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">cd</span> pigsty<span style="color:#000;font-weight:bold">;</span> git checkout v3.2.0
</span></span></code></pre></div>

<div class="alert alert-danger" role="alert">
<h4 class="alert-heading">检出特定版本使用</h4>

    <code>main</code> 主干为活跃开发分支，使用 <code>git</code> 时请务必检出特定版本后使用，可用版本请参考 <a href="/zh/docs/releasenote"><strong>发行注记</strong></a>。

</div>

<hr>
<h2 id="配置">配置</h2>
<p>配置 / <a href="https://github.com/Vonng/pigsty/blob/main/configure"><strong><code>configure</code></strong></a> 会根据您当前的环境，自动生成推荐的（单机安装） <a href="https://github.com/Vonng/pigsty/blob/main/pigsty.yml"><code>pigsty.yml</code></a> <a href="/zh/docs/setup/config/"><strong>配置文件</strong></a>。</p>
<p>提示: 如果您已经了解了如何配置 Pigsty，<code>configure</code> 这个步骤是可选的，可以跳过。 Pigsty 提供了许多开箱即用的预置 <a href="/zh/docs/conf/overview"><strong>配置模板</strong></a> 供您参考。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./configure <span style="color:#8f5902;font-style:italic"># 不带参数会自动推荐配置，并交互式问询</span>
</span></span><span style="display:flex;"><span>./configure <span style="color:#ce5c00;font-weight:bold">[</span>-i<span style="color:#000;font-weight:bold">|</span>--ip &lt;ipaddr&gt;<span style="color:#ce5c00;font-weight:bold">]</span>                     <span style="color:#8f5902;font-style:italic"># 指定首要 IP 地址，如果不指定，将在检测到多个可用IP地址时问询。</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">[</span>-c<span style="color:#000;font-weight:bold">|</span>--conf &lt;conf&gt;<span style="color:#ce5c00;font-weight:bold">]</span>                     <span style="color:#8f5902;font-style:italic"># 指定配置模板（相对于 conf/ 目录的配置名称，不带.yml 后缀），默认使用 meta 单节点模板</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">[</span>-v<span style="color:#000;font-weight:bold">|</span>--version &lt;ver&gt;<span style="color:#ce5c00;font-weight:bold">]</span>                   <span style="color:#8f5902;font-style:italic"># 指定要安装 PostgreSQL 大版本，部分模板不适用此配置 </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">[</span>-r<span style="color:#000;font-weight:bold">|</span>--region &lt;default<span style="color:#000;font-weight:bold">|</span>china<span style="color:#000;font-weight:bold">|</span>europe&gt;<span style="color:#ce5c00;font-weight:bold">]</span>   <span style="color:#8f5902;font-style:italic"># 选择镜像源区域，如果在 GFW 区域内，将被设置为 china</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">[</span>-n<span style="color:#000;font-weight:bold">|</span>--non-interactive<span style="color:#ce5c00;font-weight:bold">]</span>                 <span style="color:#8f5902;font-style:italic"># 跳过交互式向导</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">[</span>-x<span style="color:#000;font-weight:bold">|</span>--proxy<span style="color:#ce5c00;font-weight:bold">]</span>                           <span style="color:#8f5902;font-style:italic"># 将环境变量中的代理配置写入配置文件的 proxy_env 参数中</span>
</span></span></code></pre></div><details><summary>配置 / configure 过程的样例输出</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./configure
</span></span><span style="display:flex;"><span>configure pigsty v3.2.0 begin
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">region</span> <span style="color:#ce5c00;font-weight:bold">=</span> china
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">kernel</span> <span style="color:#ce5c00;font-weight:bold">=</span> Linux
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">machine</span> <span style="color:#ce5c00;font-weight:bold">=</span> x86_64
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">package</span> <span style="color:#ce5c00;font-weight:bold">=</span> rpm,yum
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">vendor</span>  <span style="color:#ce5c00;font-weight:bold">=</span> centos <span style="color:#ce5c00;font-weight:bold">(</span>CentOS Linux<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#ce5c00;font-weight:bold">(</span>7<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">sudo</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">ssh</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant@127.0.0.1 ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> Multiple IP address candidates found:
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">(</span>1<span style="color:#ce5c00;font-weight:bold">)</span> 192.168.121.110	    inet 192.168.121.110/24 brd 192.168.121.255 scope global noprefixroute dynamic eth0
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">(</span>2<span style="color:#ce5c00;font-weight:bold">)</span> 10.10.10.10	    inet 10.10.10.10/24 brd 10.10.10.255 scope global noprefixroute eth1
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">primary_ip</span> <span style="color:#ce5c00;font-weight:bold">=</span> 10.10.10.10 <span style="color:#ce5c00;font-weight:bold">(</span>from demo<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">admin</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant@10.10.10.10 ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> el7, CentOS 7.9 EOL @ 2024-06-30, deprecated, consider using el8 or el9 instead
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> configure pigsty <span style="color:#204a87;font-weight:bold">done</span>
</span></span><span style="display:flex;"><span>proceed with ./install.yml
</span></span></code></pre></div></details><br>
<ul>
<li><code>-i|--ip</code>： 当前主机的首要内网IP地址，用于替换配置文件中的 IP 地址占位符 <code>10.10.10.10</code>。</li>
<li><code>-c|--conf</code>： 用于指定使用的配置 <a href="/zh/docs/conf/overview"><strong>配置模板</strong></a>，相对于 <code>conf/</code> 目录，不带 <code>.yml</code> 后缀的配置名称。</li>
<li><code>-v|--version</code>： 用于指定要安装的 PostgreSQL 大版本，如 <code>13</code>、<code>14</code>、<code>15</code>、<code>16</code>、<code>17</code>，部分模板不支持此配置。</li>
<li><code>-r|--region</code>： 用于指定上游软件源的区域，加速下载： (<code>default|china|europe</code>)</li>
<li><code>-n|--non-interactive</code>： 直接使用命令行参数提供首要IP地址，跳过交互式向导。</li>
<li><code>-x|--proxy</code>: 使用当前环境变量配置  <a href="/zh/docs/reference/param/#proxy_env"><code>proxy_env</code></a> 变量（影响 <code>http_proxy</code>/<code>HTTP_PROXY</code>， <code>HTTPS_PROXY</code>， <code>ALL_PROXY</code>， <code>NO_PROXY</code>）。</li>
</ul>
<p>如果您的机器网卡绑定了多个 IP 地址，那么需要使用 <code>-i|--ip &lt;ipaddr&gt;</code> 显式指定一个当前节点的首要 IP 地址，或在交互式问询中提供。
选用的地址应为静态 IP 地址，请勿使用公网 IP 地址。</p>
<p>配置过程生成的配置文件默认位于：<code>~/pigsty/pigsty.yml</code>，您可以在安装前进行检查与修改定制。</p>


<div class="alert alert-danger" role="alert">
<h4 class="alert-heading">修改默认密码！</h4>

    我们强烈建议您在安装前，事先修改配置文件中使用的默认密码与凭据，详情参考 <a href="/zh/docs/setup/security/#%E5%AF%86%E7%A0%81"><strong>安全考量</strong></a>。

</div>

<hr>
<h2 id="安装">安装</h2>
<p>使用 <a href="https://github.com/Vonng/pigsty/blob/main/pigsty.yml"><strong><code>install.yml</code></strong></a> 剧本，默认在当前节点上完成标准的单节点 Pigsty 安装。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./install.yml    <span style="color:#8f5902;font-style:italic"># 一次性在所有节点上完成安装</span>
</span></span></code></pre></div><details><summary>安装过程的样例输出</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>vagrant@meta pigsty<span style="color:#ce5c00;font-weight:bold">]</span>$ ./install.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PLAY <span style="color:#ce5c00;font-weight:bold">[</span>IDENTITY<span style="color:#ce5c00;font-weight:bold">]</span> ********************************************************************************************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#ce5c00;font-weight:bold">[</span>node_id : get node fact<span style="color:#ce5c00;font-weight:bold">]</span> *****************************************************************************************************************
</span></span><span style="display:flex;"><span>changed: <span style="color:#ce5c00;font-weight:bold">[</span>10.10.10.10<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>PLAY RECAP **************************************************************************************************************************************************************************
</span></span><span style="display:flex;"><span>10.10.10.10                : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">288</span>  <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">215</span>  <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">skipped</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">64</span>   <span style="color:#000">rescued</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">ignored</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>localhost                  : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>    <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">skipped</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span>    <span style="color:#000">rescued</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">ignored</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div></details><br>
<p>这是一个 <strong>Ansible</strong> <a href="/zh/docs/setup/playbook"><strong>剧本</strong></a>，您可以使用以下参数控制其执行的目标、任务、并传递额外的命令参数：</p>
<ul>
<li><code>-l</code>: 限制执行的目标对象</li>
<li><code>-t</code>: 限制要执行的任务</li>
<li><code>-e</code>: 传入额外的命令行参数</li>
<li><code>-i</code>: 指定使用不同于 <code>pigsty.yml</code> 的配置文件</li>
<li>&hellip;</li>
</ul>


<div class="alert alert-danger" role="alert">
<h4 class="alert-heading">避免重复执行安装剧本！</h4>

    <p>警告： 在已经初始化的环境中再次运行 <a href="https://github.com/Vonng/pigsty/blob/main/install.yml"><strong><code>install.yml</code></strong></a> 会重置整个环境，所以请务必小心！</p>
<p>此剧本仅用于初始安装，安装完毕后可以用 <code>rm install.yml</code> 或 <code>chmod a-x install.yml</code> 来避免此剧本的误执行。</p>


</div>

<hr>
<h2 id="用户界面">用户界面</h2>
<p>当安装完成后，当前节点会安装有四个 <a href="/zh/docs/about/module/#%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97"><strong>核心模块</strong></a>：<a href="/zh/docs/pgsql"><strong><code>PGSQL</code></strong></a>，<a href="/zh/docs/infra"><strong><code>INFRA</code></strong></a>，<a href="/zh/docs/node"><strong><code>NODE</code></strong></a>，<a href="/zh/docs/etcd"><strong><code>ETCD</code></strong></a>。</p>
<p>本机上的 <a href="/zh/docs/pgsql"><strong>PGSQL</strong></a> 模块提供了一个开箱即用的单机 PostgreSQL 数据库实例，默认可以使用以下连接串 <a href="/zh/docs/pgsql/svc#%E5%8D%95%E6%9C%BA%E7%94%A8%E6%88%B7"><strong>访问</strong></a>：</p>





<ul class="nav nav-tabs" id="tabs-5" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-05-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-05-00" role="tab"
          aria-controls="tabs-05-00" aria-selected="false">
        默认用户连接串
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-05-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-05-01" role="tab"
          aria-controls="tabs-05-01" aria-selected="true">
        dbuser_dba
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-05-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-05-02" role="tab"
          aria-controls="tabs-05-02" aria-selected="false">
        dbuser_meta
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-05-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-05-03" role="tab"
          aria-controls="tabs-05-03" aria-selected="false">
        dbuser_view
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-5-content">
    <div class="tab-pane fade"
        id="tabs-05-00" role="tabpanel" aria-labelled-by="tabs-05-00-tab" tabindex="5">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"></code></pre></div>
    </div>
    <div class="tab-pane fade show active"
        id="tabs-05-01" role="tabpanel" aria-labelled-by="tabs-05-01-tab" tabindex="5">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10/meta     <span style="color:#8f5902;font-style:italic"># DBA / 超级用户（IP直连）</span></span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-05-02" role="tabpanel" aria-labelled-by="tabs-05-02-tab" tabindex="5">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>psql postgres://dbuser_meta:DBUser.Meta@10.10.10.10/meta   <span style="color:#8f5902;font-style:italic"># 业务管理员用户，读/写/DDL变更</span></span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-05-03" role="tabpanel" aria-labelled-by="tabs-05-03-tab" tabindex="5">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>psql postgres://dbuser_view:DBUser.View@pg-meta/meta       <span style="color:#8f5902;font-style:italic"># 只读用户（走域名访问）</span></span></span></code></pre></div>
    </div>
</div>

<p>本机上的 <a href="/zh/docs/infra"><strong>INFRA</strong></a> 模块为您提供了监控基础设施，默认使用的域名与端口如下所示：</p>
<table>
<thead>
<tr>
<th style="text-align:center">组件</th>
<th style="text-align:center">端口</th>
<th style="text-align:center">域名</th>
<th>说明</th>
<th>Demo地址</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>Nginx</strong></td>
<td style="text-align:center"><strong>80/443</strong></td>
<td style="text-align:center"><code>h.pigsty</code></td>
<td>Web 服务总入口，本地YUM源</td>
<td><a href="http://home.pigsty.cc"><code>home.pigsty.cc</code></a></td>
</tr>
<tr>
<td style="text-align:center">AlertManager</td>
<td style="text-align:center">9093</td>
<td style="text-align:center"><code>a.pigsty</code></td>
<td>告警聚合/屏蔽页面</td>
<td><a href="http://a.pigsty.cc"><code>a.pigsty.cc</code></a></td>
</tr>
<tr>
<td style="text-align:center"><strong>Grafana</strong></td>
<td style="text-align:center"><strong>3000</strong></td>
<td style="text-align:center"><code>g.pigsty</code></td>
<td>Grafana 监控面板</td>
<td><a href="https://demo.pigsty.cc"><code>demo.pigsty.cc</code></a></td>
</tr>
<tr>
<td style="text-align:center">Prometheus</td>
<td style="text-align:center">9090</td>
<td style="text-align:center"><code>p.pigsty</code></td>
<td>Prometheus 管理界面</td>
<td><a href="http://p.pigsty.cc"><code>p.pigsty.cc</code></a></td>
</tr>
</tbody>
</table>
<blockquote>
<p>Grafana 监控系统（g.pigsty / 3000端口）的默认用户名与密码为：<code>admin</code> / <code>pigsty</code></p>
</blockquote>
<p><a href="https://demo.pigsty.cc"><img alt="pigsty-home.jpg" src="/img/pigsty/home.jpg"></a></p>
<p>您可以通过 IP地址 + 端口的方式直接访问这些服务。但我们更推荐您使用域名通过 Nginx 80/443 端口代理访问所有组件。
使用域名访问 Pigsty WebUI 时，您需要配置 <strong>DNS</strong> 解析，或者修改本地的 <code>/etc/hosts</code> 静态解析文件。</p>
<br>
<details><summary> 如何通过域名访问 Pigsty WebUI ？</summary><br>
<p>客户端可以通过几种不同的办法来使用域名访问：</p>
<ol>
<li>通过 DNS 服务商解析互联网域名，适用于公网可访问的系统。</li>
<li>通过配置内网 DNS 服务器解析记录实现内网域名解析。</li>
<li>修改本机的 <code>/etc/hosts</code> 文件添加静态解析记录。（Windows下为：）</li>
</ol>
<p>我们建议普通用户使用第三种方式，在使用浏览器访问 Web 系统的机器上，修改 <code>/etc/hosts</code> （需要 sudo 权限）或 <code>C:\Windows\System32\drivers\etc\hosts</code>（Windows）文件，添加以下的解析记录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;your_public_ip_address&gt;  h.pigsty a.pigsty p.pigsty g.pigsty
</span></span></code></pre></div><p>这里的 IP 地址是安装 Pigsty 服务的 <strong>对外IP地址</strong>。</p>
</details>
<br>
<details><summary> 如何配置服务端使用的域名？</summary><br>
<p>服务器端域名使用 Nginx 进行配置，如果您想要替换默认的域名，在参数 <a href="/zh/docs/reference/param#infra_portal"><code>infra_portal</code></a> 中填入使用的域名即可。
当您使用 <code>http://g.pigsty</code> 访问 Grafana 监控主页时，实际上是通过 Nginx 代理访问了 Grafana 的 WebUI：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>http://g.pigsty ️-&gt; http://10.10.10.10:80 (nginx) -&gt; http://10.10.10.10:3000 (grafana)
</span></span></code></pre></div></details>
<br>
<details><summary> 如何使用 HTTPS 访问 Pigsty WebUI ？</summary><br>
<p>Pigsty默认使用自动生成的自签名的 CA 证书为 Nginx 启用 SSL，如果您希望使用 HTTPS 访问这些页面，而不弹窗提示&quot;不安全&quot;，通常有三个选择：</p>
<ul>
<li>在您的浏览器或操作系统中信任 Pigsty 自签名的 CA 证书： <code>files/pki/ca/ca.crt</code></li>
<li>如果您使用 Chrome，可以在提示不安全的窗口键入 <code>thisisunsafe</code> 跳过提示</li>
<li>您可以考虑使用 Let&rsquo;s Encrypt 或其他免费的 CA 证书服务，为 Pigsty Nginx 生成正式的 SSL证书。</li>
</ul>
</details><br>
<hr>
<h2 id="更多">更多</h2>
<p>你可以使用 Pigsty 部署更多的集群，管理更多的节点，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/node-add   pg-test      <span style="color:#8f5902;font-style:italic"># 将集群 pg-test 的3个节点纳入 Pigsty 管理</span>
</span></span><span style="display:flex;"><span>bin/pgsql-add  pg-test      <span style="color:#8f5902;font-style:italic"># 初始化一个3节点的 pg-test 高可用PG集群</span>
</span></span><span style="display:flex;"><span>bin/redis-add  redis-ms     <span style="color:#8f5902;font-style:italic"># 初始化 Redis 集群： redis-ms</span>
</span></span></code></pre></div><p>大多数模块都依赖 <a href="/zh/docs/node"><strong><code>NODE</code></strong></a> 模块，请确保节点被 Pigsty 纳管后再加装其他模块。更多细节请参考 <a href="/zh/docs/about/module"><strong>模块</strong></a> 详情：</p>
<p><a href="/zh/docs/pgsql"><strong><code>PGSQL</code></strong></a>，<a href="/zh/docs/infra"><strong><code>INFRA</code></strong></a>，<a href="/zh/docs/node"><strong><code>NODE</code></strong></a>，<a href="/zh/docs/etcd"><strong><code>ETCD</code></strong></a>，<a href="/zh/docs/minio"><strong><code>MINIO</code></strong></a>，<a href="/zh/docs/redis"><strong><code>REDIS</code></strong></a>，<a href="/zh/docs/ferret"><strong><code>MONGO</code></strong></a>，<a href="/zh/docs/node"><strong><code>DOCKER</code></strong></a>，……</p>
<p><a href="/zh/docs/kernel/babelfish/"><img alt="BABELFISH" src="https://img.shields.io/badge/WILTONDB-%2388A3CA?style=flat&logo=postgresql&labelColor=88A3CA&logoColor=black"></a>
<a href="/zh/docs/kernel/polardb/"><img alt="POLARDB PG" src="https://img.shields.io/badge/POLARDB_PG-%23DF6F2E?style=flat&logo=postgresql&labelColor=DF6F2E&logoColor=black"></a>
<a href="/zh/docs/kernel/polardb-o/"><img alt="POLARDB ORACLE" src="https://img.shields.io/badge/POLARDB_ORACLE-%23DF6F2E?style=flat&logo=postgresql&labelColor=DF6F2E&logoColor=black"></a>
<a href="/zh/docs/kernel/ivorysql/"><img alt="IVORYSQL" src="https://img.shields.io/badge/IVORYSQL-%23E8AC52?style=flat&logo=postgresql&labelColor=E8AC52&logoColor=black"></a>
<a href="/zh/docs/kernel/greenplum/"><img alt="GREENPLUM" src="https://img.shields.io/badge/GREENPLUM-%23578B09?style=flat&logo=postgresql&labelColor=578B09&logoColor=black"></a>
<a href="/zh/docs/kernel/cloudberry/"><img alt="CLOUDBERRY" src="https://img.shields.io/badge/CLOUDBERRY-orange?style=flat&logo=postgresql&labelColor=orange&logoColor=black"></a>
<a href="/zh/docs/kernel/neon/"><img alt="NEON" src="https://img.shields.io/badge/NEON-%2366D9C6?style=flat&logo=postgresql&labelColor=66D9C6&logoColor=black"></a>
<a href="/zh/docs/kernel/supabase/"><img alt="SUPABASE" src="https://img.shields.io/badge/SUPABASE-%233FCF8E?style=flat&logo=supabase&labelColor=3FCF8E&logoColor=white"></a></p>
<p><a href="/zh/docs/pro/kafka/"><img alt="KAFKA" src="https://img.shields.io/badge/KAFKA-%23231F20?style=flat&logo=apachekafka&labelColor=231F20&logoColor=white"></a>
<a href="/zh/docs/pro/kafka/"><img alt="MYSQL" src="https://img.shields.io/badge/MYSQL-%234479A1?style=flat&logo=mysql&labelColor=4479A1&logoColor=white"></a>
<a href="/zh/docs/pro/duckdb/"><img alt="DUCKDB" src="https://img.shields.io/badge/DUCKDB-%23FFF000?style=flat&logo=duckdb&labelColor=FFF000&logoColor=white"></a>
<a href="/zh/docs/pro/tigerbeetle/"><img alt="TIGERBEETLE" src="https://img.shields.io/badge/TIGERBEETLE-%231919191?style=flat&logo=openbugbounty&labelColor=1919191&logoColor=white"></a>
<a href="/zh/docs/pro/victoria/"><img alt="VICTORIA" src="https://img.shields.io/badge/VICTORIA-%23621773?style=flat&logo=victoriametrics&labelColor=621773&logoColor=white"></a>
<a href="/zh/docs/pro/kube/"><img alt="KUBERNETES" src="https://img.shields.io/badge/KUBERNETES-%23326CE5?style=flat&logo=kubernetes&labelColor=326CE5&logoColor=white"></a>
<a href="/zh/docs/pro/consul/"><img alt="CONSUL" src="https://img.shields.io/badge/CONSUL-%23F24C53?style=flat&logo=consul&labelColor=F24C53&logoColor=white"></a>
<a href="/zh/docs/pro/jupyter/"><img alt="JUPYTER" src="https://img.shields.io/badge/JUPYTER-%23F37626?style=flat&logo=jupyter&labelColor=F37626&logoColor=white"></a>
<a href="/zh/docs/pro/"><img alt="COCKROACH" src="https://img.shields.io/badge/COCKROACH-%236933FF?style=flat&logo=cockroachlabs&labelColor=6933FF&logoColor=white"></a></p>
<br>
<br>
<hr>
<br>
<br>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-01b2a33b37e8e7124df9aa116794fa36">2 - 离线安装</h1>
    <div class="lead">如何在没有互联网访问的环境中安装 Pigsty？以及如何制作、使用、下载离线软件安装包？</div>
	<p>Pigsty 默认的 <a href="/zh/docs/setup/install"><strong>标准安装</strong></a> 流程需要访问互联网，然而生产环境的数据库服务器通常是与互联网隔离的。</p>
<p>为了解决这个问题，Pigsty 提供了离线安装的功能。通过使用<a href="/zh/docs/setup/offline/#离线软件包"><strong>离线软件包</strong></a>，用户可以在没有互联网访问的环境中同样完成安装与部署。</p>
<p>离线软件包是本地软件源的快照与镜像，使用离线软件包可以避免重复的下载请求与流量消耗，显著加速安装速度，并提高安装交付过程的可靠性与一致性。</p>
<ul>
<li><a href="/zh/docs/setup/offline/#构建本地软件源">构建本地软件源</a></li>
<li><a href="/zh/docs/setup/offline/#制作离线软件包">制作离线软件包</a></li>
<li><a href="/zh/docs/setup/offline/#使用离线软件包">使用离线软件包</a></li>
<li><a href="/zh/docs/setup/offline/#离线包兼容性须知">离线包兼容性须知</a></li>
<li><a href="/zh/docs/setup/offline/#下载离线软件包">下载离线软件包</a></li>
<li><a href="/zh/docs/setup/offline/#bootstrap">Bootstrap</a></li>
</ul>
<hr>
<h2 id="构建本地软件源">构建本地软件源</h2>
<p>Pigsty 会在安装过程中从互联网上游的 yum/apt 软件仓库，下载所需的 rpm/deb 包并构建一个本地软件源（默认位于 <code>/www/pigsty</code>）。
本地软件源由 Nginx 对外提供服务，后续无论是本机还是其他节点，都默认会使用本地软件源进行安装，而不再需要访问互联网</p>
<p>使用本地软件源有四个主要好处：</p>
<ol>
<li>本地软件源可以避免重复的下载请求与流量消耗，显著加速安装速度并提高安装过程的可靠性。</li>
<li>构建本地软件源会对当前可用软件版本取快照，确保部署环境内节点所安装软件版本的一致性。</li>
<li>使用本地快照可以避免上游依赖变化导致的依赖错漏与安装失败问题，只要首个节点成功，相同环境的节点就能成功。</li>
<li>构建好的本地软件源可以整体打包，复制到安装有相同操作系统的隔离环境中用于<strong>离线安装</strong>。</li>
</ol>
<p>在 Pigsty 中，本地软件源的默认位置是本机上的 <code>/www/pigsty</code>目录（可以通过 <a href="/zh/docs/reference/param#nginx_home"><code>nginx_home</code></a> &amp; <a href="/zh/docs/reference/param#repo_name"><code>repo_name</code></a> 参数进行配置）。
这个本地软件源将使用 <code>createrepo_c</code> (EL) 或 <code>dpkg-dev</code> (Debian) 构建，本节点和其他节点可以通过 <a href="/zh/docs/reference/param#repo_upstream"><strong><code>repo_upstream</code></strong></a> 中 <code>module=local</code> 的仓库定义引用并使用该软件仓库。</p>
<p>您可以在安装完全相同操作系统的节点上执行标准安装，一旦构建完成，你可以将这个节点上的本地软件源目录，使用各种手段（<code>scp/rsync/ftp/usb</code>）拷贝到另一台安装了完全相同操作系统的节点上，用于 <strong>离线安装</strong>。</p>
<p>更为标准通用的做法是在安装完毕的节点上，将本地软件源打包制作为 <strong>离线软件包</strong>，并将其拷贝至同环境的待安装隔离节点上使用。</p>
<hr>
<h3 id="制作离线软件包">制作离线软件包</h3>
<p>Pigsty 提供了 <a href="https://github.com/Vonng/pigsty/blob/main/cache.yml"><strong><code>cache.yml</code></strong></a> 剧本，用于制作离线软件包。
例如以下命令会将 infra 节点上的 /www/pigsty 本地软件源，打包成离线软件包，并取回到本地 <code>dist/${version}</code> 目录下。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./cache.yml -l infra  
</span></span></code></pre></div><p>您可以使用 <code>cache_pkg_dir</code> 与 <code>cache_pkg_name</code> 参数自定义离线软件包的输出目录与名称，例如，以下命令会将离线软件包生成至 <code>files/pkg.tgz</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./cache.yml -l infra -e <span style="color:#4e9a06">&#39;{&#34;cache_pkg_dir&#34;:&#34;files&#34;,&#34;cache_pkg_name&#34;:&#34;pkg.tgz&#34;}&#39;</span>
</span></span></code></pre></div><hr>
<h3 id="使用离线软件包">使用离线软件包</h3>
<p>离线软件包实际上是一个使用 <code>gzip</code> 与 <code>tar</code> 制作的压缩包，使用时解压到 <code>/www/pigsty</code> 目录下即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo rm -rf /www/pigsty ； sudo tar -xf /tmp/pkg.tgz -C /www 
</span></span></code></pre></div><p>更简单的做法是将离线软件包拷贝至待安装节点的 <code>/tmp/pkg.tgz</code> 路径下，然后 Pigsty 会在 <a href="/zh/docs/setup/offline/#bootstrap"><code>bootstrap</code></a> 过程中会自动解包，并从本地软件源安装所需软件。</p>
<p>Pigsty 在构建本地软件源时会生成一个标记文件 <code>repo_complete</code>，标记这是一个 Pigsty 本地软件源。
当 Pigsty <a href="/zh/docs/setup/install/#安装"><strong>安装</strong></a> 时，如果发现本地软件源已经存在，就会进入离线安装模式。
在此模式下，Pigsty 将跳过从互联网下载并构建本地软件源的过程，使用本地软件源完成整个安装过程，期间无需互联网访问。</p>


<div class="alert alert-secondary" role="alert">
<h4 class="alert-heading">进入离线安装模式的判定标准</h4>

    <p><br>判定本地软件源存在的标准是：默认位于 <code>/www/pigsty/repo_complete</code> 的标记文件存在。</p>
<p>这个标记文件会在标准安装过程中，下载完成后自动生成，说明这是一个可用的本地软件源。</p>
<p>删除本地软件源的 <code>repo_complete</code> 标记文件后，安装时将重新从上游下载 <strong>缺失的</strong> 软件包。</p>


</div>

<hr>
<h3 id="离线包兼容性须知">离线包兼容性须知</h3>
<p>离线软件包中的 RPM/DEB 包大体上可以分为三类：</p>
<ul>
<li><a href="/zh/docs/infra"><strong>INFRA</strong></a> 软件包：例如 Prometheus，Grafana，各种监控组件，通常在任何 Linux 发行版下都可以运行。</li>
<li><a href="/zh/docs/pgsql"><strong>PGSQL</strong></a> 软件包：例如 PostgreSQL 内核与各种扩展插件，通常与 Linux 发行版 <strong>大版本</strong> 绑定。</li>
<li><a href="/zh/docs/node"><strong>NODE</strong></a> 软件包：例如各种动态链接库与主机依赖，通常与 Linux 发行版 <strong>大小版本</strong> 绑定</li>
</ul>
<p>因此，离线软件包的适用性取决于操作系统的 <strong>大版本</strong> 与 <strong>小版本</strong>，因为它包含了上面三种软件包。</p>
<p>通常来说，离线软件包只能用于操作系统大小版本精准匹配的场景。
如果大版本不匹配，INFRA 类软件包 通常可以成功安装，PGSQL 和 NODE 类软件包基本必定会出现依赖缺失或冲突。
如果小版本不匹配，INFRA 类软件包和 PGSQL 软件包通常可以成功安装，而 NODE 类软件包有概率成功，也有概率失败。</p>
<p>例如，RockLinux 8.9 下制作的离线软件包，在 RockyLinux 8.10 环境中有较大的概率可以直接使用。
而在 Ubuntu 22.04.3 下制作的离线软件，有极大概率会在 22.04.4 中出现依赖冲突问题。
（是的没错，<a href="https://wiki.ubuntu.com/Releases"><strong>Ubuntu</strong></a> 版本号里的 <code>.3</code> 才是小版本号，<code>22.04</code> 整个是 <code>jammy</code> 大版本号！）</p>
<p>如果离线软件包的操作系统小版本不匹配，您可以采用一种折中策略进行安装，即在 <a href="/zh/docs/setup/offline/#bootstrap"><strong>bootstrap</strong></a> 过程后，
移除 <code>/www/pigsty/repo_complete</code> 标记文件，让 Pigsty 重新在安装过程中从上游下载缺失的 NODE 软件包与相关依赖。
这种方式可以有效解决使用离线软件包时的依赖冲突问题，并同时获得离线安装的全部优点。</p>
<hr>
<h3 id="下载离线软件包">下载离线软件包</h3>
<p>从 Pigsty v3 开始，Pigsty 不再公开提供预制的离线软件包，统一默认使用在线安装的方式。
在线安装允许您从 Pigsty 提供的官方仓库与中国大陆 CDN 下载 INFRA / PGSQL 软件包，并由您操作系统的官方源与镜像下载 NODE 类软件包，从而最大程度的避免了 NODE 软件包小版本依赖冲突问题。</p>
<p>不过针对以下精确的操作系统版本，我们提供有偿制作的预制离线软件包，还额外包含了全部可用扩展插件，Docker 等组件。</p>
<ul>
<li>RockyLinux 8.9 / 8.10 (x86_64)</li>
<li>RockyLinux 9.3 / 9.4 (x86_64, aarch64)</li>
<li>Ubuntu 24.04.1 (x86_64, arm64)</li>
<li>Ubuntu 22.04.5 (x86_64, arm64)</li>
<li>Debian 12.7 (x86_64, arm64)</li>
</ul>
<p>Pigsty 的全套集成测试都针对于发布前预制的离线软件包快照进行，离线软件包能有效降低上游依赖变动导致的交付风险，省去您折腾的麻烦、与等待的时间。
更能体现您对开源事业的支持，物美价廉，仅需 <strong>¥199</strong>，请联系 <a href="rh@vonng.com">@Vonng</a> 获取下载链接。</p>
<p>对于 Pigsty <a href="/zh/docs/about/service">专业版订阅</a>，我们会针对您使用的具体操作系统大小版本，提供精确匹配，并经过集成测试后的离线软件包。</p>
<hr>
<h2 id="bootstrap">Bootstrap</h2>
<p>Pigsty 需要使用 Ansible 来运行剧本，因此 Ansible 本身不适合通过剧本进行安装。
Bootstrap 脚本用于解决这一问题：它会尽最大努力用各种方式来确保 Ansible 在节点上安装成功。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./bootstrap       <span style="color:#8f5902;font-style:italic"># 确保 ansible 正确安装（如果有离线包，优先使用离线安装并解包使用）</span>
</span></span></code></pre></div><p>如果您<a href="/zh/docs/setup/offline/#使用离线软件包"><strong>使用离线软件包</strong></a>进行安装，Bootstrap 过程会自动识别并处理位于 <code>/tmp/pkg.tgz</code> 的离线软件包，并优先从中安装 Ansible。
如果没有使用离线软件包，但是有互联网访问，Bootstrap 会自动添加对应操作系统/对应区域镜像的软件源，并从中安装 Ansible。
如果既没有网也没有离线包，Bootstrap 会交给用户自行处理此问题，用户需要自行保证当前节点配置的软件源包含可用的 Ansible。</p>
<p>Bootstrap 脚本有一些可选参数，例如您可以使用 <code>-p|--path</code> 参数指定一个不同于 <code>/tmp/pkg.tgz</code> 的离线软件包位置。
您也可以使用 <code>-r|--region</code> 指定一个区域，这样如果需要从互联网下载 Ansible，Pigsty 会添加对应区域的软件源（全球，中国，欧洲）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./boostrap
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">[</span>-r<span style="color:#000;font-weight:bold">|</span>--region &lt;region<span style="color:#ce5c00;font-weight:bold">]</span>   <span style="color:#ce5c00;font-weight:bold">[</span>default,china,europe<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">[</span>-p<span style="color:#000;font-weight:bold">|</span>--path &lt;path&gt;<span style="color:#ce5c00;font-weight:bold">]</span>      specify another offline pkg path
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">[</span>-k<span style="color:#000;font-weight:bold">|</span>--keep<span style="color:#ce5c00;font-weight:bold">]</span>             keep existing upstream repo during bootstrap
</span></span></code></pre></div><p>最后， bootstrap 过程中默认会备份（<code>/etc/yum.repos.d/backup</code> / <code>/etc/apt/source.list.d/backup</code>）并移除节点当前配置的软件源，从而最大程度避免软件源冲突问题。
如果这不是你期待的行为，或者您已经配置了本地软件源，可以使用 <code>-k|--keep</code> 参数，保留现有软件源。</p>
<details><summary>例：使用离线软件包</summary><br>
<p>在一台安装了 RockyLinux 8.9 的节点上使用离线软件包安装 Pigsty：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>vagrant@el8 pigsty<span style="color:#ce5c00;font-weight:bold">]</span>$ ls -alh /tmp/pkg.tgz
</span></span><span style="display:flex;"><span>-rw-r--r--. <span style="color:#0000cf;font-weight:bold">1</span> vagrant vagrant 1.4G Sep  <span style="color:#0000cf;font-weight:bold">1</span> 10:20 /tmp/pkg.tgz
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>vagrant@el8 pigsty<span style="color:#ce5c00;font-weight:bold">]</span>$ ./bootstrap
</span></span><span style="display:flex;"><span>bootstrap pigsty v3.0.4 begin
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">region</span> <span style="color:#ce5c00;font-weight:bold">=</span> china
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">kernel</span> <span style="color:#ce5c00;font-weight:bold">=</span> Linux
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">machine</span> <span style="color:#ce5c00;font-weight:bold">=</span> x86_64
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">package</span> <span style="color:#ce5c00;font-weight:bold">=</span> rpm,dnf
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">vendor</span> <span style="color:#ce5c00;font-weight:bold">=</span> rocky <span style="color:#ce5c00;font-weight:bold">(</span>Rocky Linux<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#ce5c00;font-weight:bold">(</span>8.9<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">sudo</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">ssh</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant@127.0.0.1 ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> /tmp/pkg.tgz exists
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">repo</span> <span style="color:#ce5c00;font-weight:bold">=</span> extract from /tmp/pkg.tgz
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> old <span style="color:#000">repos</span> <span style="color:#ce5c00;font-weight:bold">=</span> moved to /etc/yum.repos.d/backup
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> repo <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">=</span> use /etc/yum.repos.d/pigsty-local.repo
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> rpm <span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> updating, may take a <span style="color:#204a87;font-weight:bold">while</span>
</span></span><span style="display:flex;"><span>pigsty <span style="color:#204a87">local</span> <span style="color:#0000cf;font-weight:bold">8</span> - x86_64                                                                                                                               <span style="color:#0000cf;font-weight:bold">49</span> MB/s <span style="color:#000;font-weight:bold">|</span> 1.3 MB     00:00
</span></span><span style="display:flex;"><span>Metadata cache created.
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> repo <span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> created
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> install el8 utils
</span></span><span style="display:flex;"><span>Last metadata expiration check: 0:00:01 ago on Sun <span style="color:#0000cf;font-weight:bold">01</span> Sep <span style="color:#0000cf;font-weight:bold">2024</span> 10:30:52 AM UTC.
</span></span><span style="display:flex;"><span>Package wget-1.19.5-11.el8.x86_64 is already installed.
</span></span><span style="display:flex;"><span>Package yum-utils-4.0.21-23.el8.noarch is already installed.
</span></span><span style="display:flex;"><span>Dependencies resolved.
</span></span><span style="display:flex;"><span>........
</span></span><span style="display:flex;"><span>Installed:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  createrepo_c-0.17.7-6.el8.x86_64        createrepo_c-libs-0.17.7-6.el8.x86_64 drpm-0.4.1-3.el8.x86_64   modulemd-tools-0.7-8.el8.noarch python3-createrepo_c-0.17.7-6.el8.x86_64
</span></span><span style="display:flex;"><span>  python3-libmodulemd-2.13.0-1.el8.x86_64 python3-pyyaml-3.12-12.el8.x86_64     sshpass-1.09-4.el8.x86_64 unzip-6.0-46.el8.x86_64
</span></span><span style="display:flex;"><span>  ansible-9.2.0-1.el8.noarch                 ansible-core-2.16.3-2.el8.x86_64              git-core-2.43.5-1.el8_10.x86_64                 mpdecimal-2.5.1-3.el8.x86_64
</span></span><span style="display:flex;"><span>  python3-cffi-1.11.5-6.el8.x86_64           python3-cryptography-3.2.1-7.el8_9.x86_64     python3-jmespath-0.9.0-11.el8.noarch            python3-pycparser-2.14-14.el8.noarch
</span></span><span style="display:flex;"><span>  python3.12-3.12.3-2.el8_10.x86_64          python3.12-cffi-1.16.0-2.el8.x86_64           python3.12-cryptography-41.0.7-1.el8.x86_64     python3.12-jmespath-1.0.1-1.el8.noarch
</span></span><span style="display:flex;"><span>  python3.12-libs-3.12.3-2.el8_10.x86_64     python3.12-pip-wheel-23.2.1-4.el8.noarch      python3.12-ply-3.11-2.el8.noarch                python3.12-pycparser-2.20-2.el8.noarch
</span></span><span style="display:flex;"><span>  python3.12-pyyaml-6.0.1-2.el8.x86_64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Complete!
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">ansible</span> <span style="color:#ce5c00;font-weight:bold">=</span> ansible <span style="color:#ce5c00;font-weight:bold">[</span>core 2.16.3<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> boostrap pigsty <span style="color:#204a87">complete</span>
</span></span><span style="display:flex;"><span>proceed with ./configure
</span></span></code></pre></div></details><br>
<details><summary>例：不使用离线软件包，但是有互联网访问（Debian 12）</summary><br>
<p>在一台有互联网访问的 Debian 12 节点上，用户不使用离线软件包，Bootstrap 会自动添加 Debian 12 的上游软件源，并安装 <code>ansible</code> 与依赖：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@d12:~/pigsty$ ./bootstrap
</span></span><span style="display:flex;"><span>bootstrap pigsty v3.2.0 begin
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">region</span> <span style="color:#ce5c00;font-weight:bold">=</span> china
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">kernel</span> <span style="color:#ce5c00;font-weight:bold">=</span> Linux
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">machine</span> <span style="color:#ce5c00;font-weight:bold">=</span> x86_64
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">package</span> <span style="color:#ce5c00;font-weight:bold">=</span> deb,apt
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">vendor</span> <span style="color:#ce5c00;font-weight:bold">=</span> debian <span style="color:#ce5c00;font-weight:bold">(</span>Debian GNU/Linux<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">12</span> <span style="color:#ce5c00;font-weight:bold">(</span>12<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">sudo</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">ssh</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant@127.0.0.1 ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> old <span style="color:#000">repos</span> <span style="color:#ce5c00;font-weight:bold">=</span> moved to /etc/apt/backup
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> repo <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">=</span> add debian bookworm china upstream
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> apt <span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> updating, may take a <span style="color:#204a87;font-weight:bold">while</span>
</span></span><span style="display:flex;"><span>....... apt install output
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">ansible</span> <span style="color:#ce5c00;font-weight:bold">=</span> ansible <span style="color:#ce5c00;font-weight:bold">[</span>core 2.14.16<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> boostrap pigsty <span style="color:#204a87">complete</span>
</span></span><span style="display:flex;"><span>proceed with ./configure
</span></span></code></pre></div></details><br>
<details><summary>例：不使用离线软件包，也没有互联网访问（Ubuntu 22.04）</summary><br>
<p>在一个没有互联网访问，也没有离线包的 Ubuntu 22.04 节点上进行 bootstrap。</p>
<p>我们假设用户已经通过各种方式解决这个问题，例如在当前的服务器上已经配置了 CD / FS 路径的本地软件源，或者内网中有可用的 YUM / APT 仓库。</p>
<p>您可以使用 <code>-k</code> 参数显式保留当前的软件源配置，当然如果 Pigsty 检测到了没有互联网访问，也没有离线软件包，那么默认也会保留当前的软件源配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@u22:~/pigsty$ ./bootstrap
</span></span><span style="display:flex;"><span>bootstrap pigsty v3.2.0 begin
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">region</span> <span style="color:#ce5c00;font-weight:bold">=</span> china
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">kernel</span> <span style="color:#ce5c00;font-weight:bold">=</span> Linux
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">machine</span> <span style="color:#ce5c00;font-weight:bold">=</span> x86_64
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">package</span> <span style="color:#ce5c00;font-weight:bold">=</span> deb,apt
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">vendor</span> <span style="color:#ce5c00;font-weight:bold">=</span> ubuntu <span style="color:#ce5c00;font-weight:bold">(</span>Ubuntu<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">22</span> <span style="color:#ce5c00;font-weight:bold">(</span>22.04<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">sudo</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">ssh</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant@127.0.0.1 ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> old <span style="color:#000">repos</span> <span style="color:#ce5c00;font-weight:bold">=</span> moved to /etc/apt/backup
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> repo <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">=</span> add ubuntu jammy china upstream
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> apt <span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> updating, may take a <span style="color:#204a87;font-weight:bold">while</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> repo <span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...<span style="color:#ce5c00;font-weight:bold">(</span>apt update/install 输出<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">ansible</span> <span style="color:#ce5c00;font-weight:bold">=</span> ansible 2.10.8
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> boostrap pigsty <span style="color:#204a87">complete</span>
</span></span><span style="display:flex;"><span>proceed with ./configure
</span></span></code></pre></div></details><br>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c38b3e7bce8cb65ffd26ccafa496eb5e">3 - 精简安装</h1>
    <div class="lead">如何只安装高可用 PostgreSQL 集群以及其最小依赖，不安装本地软件源与基础设施组件？</div>
	<p>Pigsty 带有一整套服务于高可用 PostgreSQL 基础设施堆栈，但是这也完全是可选的，您可以通过 <strong>精简安装</strong>，只安装必要的 PostgreSQL 高可用集群组件。</p>
<hr>
<h2 id="概览">概览</h2>
<p>精简安装专注于纯粹的 HA-PostgreSQL 集群，仅安装所需的基本组件。</p>
<p>在精简安装模式下，不会有 <a href="/zh/docs/infra"><strong><code>Infra</code></strong></a> 模块，没有监控，没有 <a href="/zh/docs/setup/offline/#build-local-repo"><strong>本地仓库</strong></a></p>
<p>只有部分 NODE 模块的一部分，以及 ETCD 和 PGSQL 模块会被安装：您依然可以使用完整的 PGSQL 模块与 ETCD 模块的功能</p>
<p>在节点上会启用的 Systemd 服务有：</p>
<ul>
<li>patroni：<strong>必选</strong>，PostgreSQL 高可用与管控组件</li>
<li>etcd：<strong>必选</strong>, Patroni 高可用依赖的配置中心</li>
<li>pgbouncer：<strong>可选</strong>，数据库连接池</li>
<li>vip-manager：<strong>可选</strong>，为主库绑定一个可选的二层VIP。</li>
<li>haproxy：<strong>可选</strong>，提供自动路由的 <a href="/zh/docs/concept/svc"><strong>服务</strong></a> 接入</li>
<li>chronyd： <strong>可选</strong>，同步节点时间</li>
<li>tuned：<strong>可选</strong>，管理节点配置模板与系统内核参数</li>
</ul>
<p>其中 <code>patroni</code> 和 <code>etcd</code> 是必选的组件，其他组件都是可选的，尽管如此，Pigsty 不建议关闭这些组件 —— 您可以留着它们不用。</p>
<hr>
<h2 id="配置">配置</h2>
<p>要执行精简安装，您需要额外配置几个选项开关，如 <a href="https://github.com/Vonng/pigsty/blob/main/conf/slim.yml"><code>slim.yml</code></a> 所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">all</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">children</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">infra</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">infra_seq: 1 } }, vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">docker_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic">#10.10.10.11: { etcd_seq:  2 } # optional</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic">#10.10.10.12: { etcd_seq:  3 } # optional</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">primary }  # init one single-node pgsql cluster by default, with</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic">#10.10.10.11: { pg_seq: 2, pg_role: replica } # optional replica : bin/pgsql-add pg-meta 10.10.10.11</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic">#10.10.10.12: { pg_seq: 3, pg_role: replica } # optional replica : bin/pgsql-add pg-meta 10.10.10.12</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_users:         # define business users here</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://pigsty.io/docs/pgsql/user/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_meta ,password: DBUser.Meta ,pgbouncer: true ,roles: [ dbrole_admin ] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty default user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_databases:     # define business databases here</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://pigsty.io/docs/pgsql/db/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: meta ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty default database  }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_hba_rules:     # define HBA rules here</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://pigsty.io/docs/pgsql/hba/#define-hba</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user: dbuser_meta , db: all ,addr: world ,auth: pwd ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow default user world access with password (not a good idea!)&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">node_crontab</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic"># define backup policy with crontab (full|diff|incr)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#4e9a06">&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic">#pg_vip_address: 10.10.10.2/24  # optional l2 vip address and netmask</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_extensions:    # define pg extensions (345 available)</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://pigsty.io/docs/pgext/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#000">postgis timescaledb pgvector</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v3.2.0                  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pigsty version string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">admin_ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># admin node ip address</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">region: default                   # upstream mirror region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default|china|europe</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">node_tune</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tiny                  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># use tiny template for NODE  in demo environment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_conf</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tiny.yml                </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># use tiny template for PGSQL in demo environment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># minimal installation setup</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">node_repo_modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node,infra,pgsql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">nginx_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">dns_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">prometheus_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">grafana_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_exporter_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pgbouncer_exporter_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_vip_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>同时在初始化安装时，您应该使用  <a href="https://github.com/Vonng/pigsty/blob/main/slim.yml"><code>slim.yml</code></a>  剧本进行安装，而不是默认的 <a href="https://github.com/Vonng/pigsty/blob/main/install.yml"><code>install.yml</code></a>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./slim.yml
</span></span></code></pre></div><p>然后，配置指定的节点上便会安装最小化的 PostgreSQL 高可用集群组件。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d96b1765e9d967725a0824edd07fe95d">4 - 声明配置</h1>
    <div class="lead">使用声明式的配置来描述数据库集群与基础设施</div>
	<blockquote>
<p><strong>Pigsty将基础设施和数据库视为代码</strong>：Database as Code &amp; Infra as Code</p>
</blockquote>
<p>你可以通过声明式的接口/配置文件来描述基础设施和数据库集群，你只需在 <a href="/zh/docs/setup/config/#配置清单">配置清单</a> （Inventory） 中描述你的需求，然后用简单的幂等剧本使其生效即可。</p>
<hr>
<h2 id="配置清单">配置清单</h2>
<p>每一套 Pigsty 部署都有一个相应的 <strong>配置清单</strong>（Inventory）。它可以以 <a href="https://docs.ansible.com/ansible/2.9/user_guide/playbooks_variables.html">YAML</a> 的形式存储在本地，并使用 <code>git</code> 管理；或从 <a href="https://docs.ansible.com/ansible/2.9/user_guide/intro_dynamic_inventory.html">CMDB</a> 或任何 ansible 兼容的方式动态生成。</p>
<p>Pigsty 默认使用一个名为 <a href="https://github.com/Vonng/pigsty/blob/main/pigsty.yml"><code>pigsty.yml</code></a> 的单体 YAML 配置文件作为默认的配置清单，它<a href="https://github.com/Vonng/pigsty/blob/main/ansible.cfg#L3"><strong>位于</strong></a> Pigsty 源码主目录下，但你也可以通过命令行参数 <code>-i</code> 指定路径以使用别的配置清单。</p>
<p>清单由两部分组成：<strong>全局变量</strong> 和多个 <strong>组定义</strong> 。 前者 <code>all.vars</code> 通常用于描述基础设施，并为集群设置全局默认参数。后者 <code>all.children</code> 则负责定义新的集群（PGSQL/Redis/MinIO/ETCD等等）。一个配置清单文件从最顶层来看大概如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">all</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># 顶层对象：all</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#000">...}        </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 全局参数</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">children</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># 组定义</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">infra</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># 组定义：&#39;infra&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#000">...}       </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 组成员：&#39;infra&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span>{<span style="color:#000">...}       </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 组参数：&#39;infra&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">    </span>{<span style="color:#000">...}   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 组定义：&#39;etcd&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#000">...}   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 组定义：&#39;pg-meta&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#000">...}   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 组定义：&#39;pg-test&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">redis-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#000">...}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 组定义：&#39;redis-test&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># ...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="集群">集群</h2>
<p>每个组定义通常代表一个集群，可以是节点集群、PostgreSQL 集群、Redis 集群、Etcd 集群或 Minio 集群等。它们都使用相同的格式：<code>hosts</code> 和 <code>vars</code>。
你可以用 <code>all.children.&lt;cls&gt;.hosts</code> 定义集群成员，并使用 <code>all.children.&lt;cls&gt;.vars</code> 中的集群参数描述集群。以下是名为 <code>pg-test</code> 的三节点 PostgreSQL 高可用集群的定义示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 集群名称</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 集群参数</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 集群成员</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 实例1，在 10.10.10.11 上，主库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 实例2，在 10.10.10.12 上，从库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 3, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">offline }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 实例3，在 10.10.10.13 上，从库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>你也可以为特定的主机/实例定义参数，也称为实例参数。它将覆盖集群参数和全局参数，实例参数通常用于为节点和数据库实例分配身份（实例号，角色）。</p>
<hr>
<h2 id="参数">参数</h2>
<p>全局变量、组变量和主机变量都是由一系列 <strong>键值对</strong> 组成的字典对象。每一对都是一个命名的参数，由一个字符串名作为键，和一个值组成。值是五种类型之一：布尔值、字符串、数字、数组或对象。查看<a href="/zh/docs/reference/param">配置参数</a>以了解详细的参数语法语义。</p>
<p>绝大多数参数都有着合适的默认值，<strong>身份参数</strong> 除外；它们被用作标识符，并必须显式配置，例如 <a href="/zh/docs/reference/param#pg_cluster"><code>pg_cluster</code></a>， <a href="/zh/docs/reference/param#pg_role"><code>pg_role</code></a>，以及 <a href="/zh/docs/reference/param#pg_seq"><code>pg_seq</code></a>。</p>
<p>参数可以被更高优先级的同名参数定义覆盖，优先级如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>命令行参数 &gt; 剧本变量  &gt;  主机变量（实例参数）  &gt;  组变量（集群参数）  &gt;  全局变量（全局参数） &gt;  默认值
</span></span></code></pre></div><p>例如：</p>
<ul>
<li>使用命令行参数 <code>-e pg_clean=true</code> 强制删除现有数据库</li>
<li>使用实例参数 <code>pg_role</code> 和 <code>pg_seq</code> 来为一个数据库实例分配角色与标号。</li>
<li>使用集群变量来为集群设置默认值，如集群名称 <code>pg_cluster</code> 和数据库版本 <code>pg_version</code></li>
<li>使用全局变量为所有 PGSQL 集群设置默认值，如使用的默认参数和插件列表</li>
<li>如果没有显式配置 <code>pg_version</code> ，默认值 <code>16</code> 版本号会作为最后兜底的缺省值。</li>
</ul>
<hr>
<h2 id="模板">模板</h2>
<p>在 Pigsty 目录中的 <a href="https://github.com/Vonng/pigsty/blob/main/conf/README.md"><code>conf/</code></a> 目录里，提供了针对许多不同场景的预置配置模板可供参考选用。</p>
<p>在 <a href="/zh/docs/setup/install#%E9%85%8D%E7%BD%AE"><code>configure</code></a> 过程中，您可以通过 <code>-c</code> 参数指定模板。否则会默认使用单节点安装的 <a href="/zh/docs/conf/meta"><code>meta</code></a> 模板。</p>
<p>关于这些模版的功能，请参考 <a href="/zh/docs/conf"><strong>配置模板</strong></a> 中的介绍。</p>
<hr>
<h2 id="切换配置源">切换配置源</h2>
<p>要使用不同的配置模板，您可以将模板的内容复制到 Pigsty 源码目录的 <code>pigsty.yml</code> 文件中，并按需进行相应调整。</p>
<p>您也可以在执行 Ansible 剧本时，通过 <code>-i</code> 命令行参数，显式指定使用的配置文件，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./node.yml -i files/pigsty/rpmbuild.yml    <span style="color:#8f5902;font-style:italic"># 根据 rpmbuild 配置文件，初始化目标节点，而不是使用默认的 pigsty.yml 配置文件</span>
</span></span></code></pre></div><p>如果您希望修改默认的配置文件名称与位置，您也可以修改源码根目录下的 <a href="https://github.com/Vonng/pigsty/blob/main/ansible.cfg#L6"><code>ansible.cfg</code></a> 的 <code>inventory</code> 参数，将其指向您的配置文件路径，这样您就可以直接执行 <code>ansible-playbook</code> 命令而无需显式指定 <code>-i</code> 参数。</p>
<p>Pigsty 允许您使用数据库（CMDB）作为动态配置源，而不是使用静态配置文件。 Pigsty 提供了三个便利脚本：</p>
<ul>
<li><a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_load"><code>bin/inventory_load</code></a>: 将 <code>pigsty.yml</code> 配置文件的内容加载到本机上的 PostgreSQL 数据库中（<code>meta</code>.<code>pigsty</code>）</li>
<li><a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_cmdb"><code>bin/inventory_cmdb</code></a>: 切换配置源为本地 PostgreSQL 数据库（<code>meta</code>.<code>pigsty</code>）</li>
<li><a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_cmdb"><code>bin/inventory_conf</code></a>: 切换配置源为本地静态配置文件 <code>pigsty.yml</code></li>
</ul>
<hr>
<h2 id="参考">参考</h2>
<p>Pigsty 带有 280+ 配置参数，分为以下32个参数组，详情请参考 <a href="/zh/docs/reference/param">配置参数</a> 。</p>
<table>
<thead>
<tr>
<th style="text-align:center">模块</th>
<th>参数组</th>
<th>描述</th>
<th>数量</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#infra"><code>INFRA</code></a></td>
<td><a href="/zh/docs/reference/param#meta"><code>META</code></a></td>
<td>Pigsty 元数据</td>
<td>4</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#infra"><code>INFRA</code></a></td>
<td><a href="/zh/docs/reference/param#ca"><code>CA</code></a></td>
<td>自签名公私钥基础设施 CA</td>
<td>3</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#infra"><code>INFRA</code></a></td>
<td><a href="/zh/docs/reference/param#infra_id"><code>INFRA_ID</code></a></td>
<td>基础设施门户，Nginx域名</td>
<td>2</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#infra"><code>INFRA</code></a></td>
<td><a href="/zh/docs/reference/param#repo"><code>REPO</code></a></td>
<td>本地软件仓库</td>
<td>9</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#infra"><code>INFRA</code></a></td>
<td><a href="/zh/docs/reference/param#infra_package"><code>INFRA_PACKAGE</code></a></td>
<td>基础设施软件包</td>
<td>2</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#infra"><code>INFRA</code></a></td>
<td><a href="/zh/docs/reference/param#nginx"><code>NGINX</code></a></td>
<td>Nginx 网络服务器</td>
<td>7</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#infra"><code>INFRA</code></a></td>
<td><a href="/zh/docs/reference/param#dns"><code>DNS</code></a></td>
<td>DNSMASQ 域名服务器</td>
<td>3</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#infra"><code>INFRA</code></a></td>
<td><a href="/zh/docs/reference/param#prometheus"><code>PROMETHEUS</code></a></td>
<td>Prometheus 时序数据库全家桶</td>
<td>18</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#infra"><code>INFRA</code></a></td>
<td><a href="/zh/docs/reference/param#grafana"><code>GRAFANA</code></a></td>
<td>Grafana 可观测性全家桶</td>
<td>6</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#infra"><code>INFRA</code></a></td>
<td><a href="/zh/docs/reference/param#loki"><code>LOKI</code></a></td>
<td>Loki 日志服务</td>
<td>4</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#node"><code>NODE</code></a></td>
<td><a href="/zh/docs/reference/param#node_id"><code>NODE_ID</code></a></td>
<td>节点身份参数</td>
<td>5</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#node"><code>NODE</code></a></td>
<td><a href="/zh/docs/reference/param#node_dns"><code>NODE_DNS</code></a></td>
<td>节点域名 &amp; DNS解析</td>
<td>6</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#node"><code>NODE</code></a></td>
<td><a href="/zh/docs/reference/param#node_package"><code>NODE_PACKAGE</code></a></td>
<td>节点仓库源 &amp; 安装软件包</td>
<td>5</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#node"><code>NODE</code></a></td>
<td><a href="/zh/docs/reference/param#node_tune"><code>NODE_TUNE</code></a></td>
<td>节点调优与内核特性开关</td>
<td>10</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#node"><code>NODE</code></a></td>
<td><a href="/zh/docs/reference/param#node_admin"><code>NODE_ADMIN</code></a></td>
<td>管理员用户与SSH凭证管理</td>
<td>7</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#node"><code>NODE</code></a></td>
<td><a href="/zh/docs/reference/param#node_time"><code>NODE_TIME</code></a></td>
<td>时区，NTP服务与定时任务</td>
<td>5</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#node"><code>NODE</code></a></td>
<td><a href="/zh/docs/reference/param#node_vip"><code>NODE_VIP</code></a></td>
<td>可选的主机节点集群L2 VIP</td>
<td>8</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#node"><code>NODE</code></a></td>
<td><a href="/zh/docs/reference/param#haproxy"><code>HAPROXY</code></a></td>
<td>使用HAProxy对外暴露服务</td>
<td>10</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#node"><code>NODE</code></a></td>
<td><a href="/zh/docs/reference/param#node_exporter"><code>NODE_EXPORTER</code></a></td>
<td>主机节点监控与注册</td>
<td>3</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#node"><code>NODE</code></a></td>
<td><a href="/zh/docs/reference/param#promtail"><code>PROMTAIL</code></a></td>
<td>Promtail日志收集组件</td>
<td>4</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/docker/param"><code>DOCKER</code></a></td>
<td><a href="/zh/docs/docker/param"><code>DOCKER</code></a></td>
<td>Docker容器服务（可选）</td>
<td>4</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/etcd/param"><code>ETCD</code></a></td>
<td><a href="/zh/docs/etcd/param"><code>ETCD</code></a></td>
<td>Etcd DCS 集群</td>
<td>10</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/minio/param"><code>MINIO</code></a></td>
<td><a href="/zh/docs/minio/param"><code>MINIO</code></a></td>
<td>MinIO S3 对象存储</td>
<td>15</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#redis"><code>REDIS</code></a></td>
<td><a href="/zh/docs/reference/param#redis"><code>REDIS</code></a></td>
<td>Redis 缓存</td>
<td>20</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#pgsql"><code>PGSQL</code></a></td>
<td><a href="/zh/docs/reference/param#pg_id"><code>PG_ID</code></a></td>
<td>PG 身份参数</td>
<td>11</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#pgsql"><code>PGSQL</code></a></td>
<td><a href="/zh/docs/reference/param#pg_business"><code>PG_BUSINESS</code></a></td>
<td>PG 业务对象定义</td>
<td>12</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#pgsql"><code>PGSQL</code></a></td>
<td><a href="/zh/docs/reference/param#pg_install"><code>PG_INSTALL</code></a></td>
<td>安装 PG 软件包 &amp; 扩展</td>
<td>10</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#pgsql"><code>PGSQL</code></a></td>
<td><a href="/zh/docs/reference/param#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td>使用 Patroni 初始化 HA PG 集群</td>
<td>39</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#pgsql"><code>PGSQL</code></a></td>
<td><a href="/zh/docs/reference/param#pg_provision"><code>PG_PROVISION</code></a></td>
<td>创建 PG 数据库内对象</td>
<td>9</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#pgsql"><code>PGSQL</code></a></td>
<td><a href="/zh/docs/reference/param#pg_backup"><code>PG_BACKUP</code></a></td>
<td>使用 pgBackRest 设置备份仓库</td>
<td>5</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#pgsql"><code>PGSQL</code></a></td>
<td><a href="/zh/docs/reference/param#pg_service"><code>PG_SERVICE</code></a></td>
<td>对外暴露服务, 绑定 vip, dns</td>
<td>9</td>
</tr>
<tr>
<td style="text-align:center"><a href="/zh/docs/reference/param#pgsql"><code>PGSQL</code></a></td>
<td><a href="/zh/docs/reference/param#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td>PG 监控，服务注册</td>
<td>15</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-24263fa625b63eabb5c32f29ec96c5f7">5 - 准备工作</h1>
    <div class="lead">如何准备部署 Pigsty 所需的节点，操作系统，管理员用户，端口，与所需权限。</div>
	<p>与 Pigsty 部署有关的 101 入门知识。</p>
<hr>
<h2 id="节点准备">节点准备</h2>
<p>Pigsty 支持 <code>Linux</code> 内核与 <code>x86_64/amd64</code> 架构，适用于任意节点。</p>
<p>所谓节点（node），指 ssh 可达并提供裸操作系统环境的资源，例如物理机，裸金属，虚拟机，或者启用了 systemd 与 sshd 的操作系统容器。</p>
<p>部署 Pigsty 最少需要一个节点。最低配置要求为 <code>1C1G</code>，推荐至少使用 <code>2C4G</code> 以上的机型，适用配置上不封顶，参数会自动优化适配。</p>
<p>作为 Demo，个人站点，或者开发环境时，可以使用单个节点。作为独立监控基础设施使用时，建议使用 <strong>1-2</strong> 个节点，作为高可用 PostgreSQL 数据库集群使用时，建议至少使用 <strong>3</strong> 个节点。用于核心场景时，建议使用至少 <strong>4-5</strong> 个节点。</p>


<div class="alert alert-success" role="alert">
<h4 class="alert-heading">充分利用 IaC 工具完成琐事</h4>

    <p>手工配置大规模生产环境繁琐且容易出错，我们建议您充分利用 Infra as Code 工具，解决此类问题。</p>
<p>您可以使用 Pigsty 提供的 <a href="/zh/docs/setup/provision#terraform"><strong>Terraform</strong></a> 模板与 <a href="/zh/docs/setup/provision#vagrant"><strong>Vagrant</strong></a> 模板，使用 IaC 的方式一键创建所需的节点环境，完成好网络，操作系统，管理用户，权限，安全组的置备工作。</p>


</div>

<hr>
<h2 id="网络准备">网络准备</h2>
<p>Pigsty 要求节点使用 <strong>静态IPv4地址</strong>，即您应当为节点显式分配指定固定的 IP 地址，而不应当使用 DHCP 动态分配的地址。</p>
<p>节点使用的 IP 地址应当是节点用于内网通信的首要 IP 地址，并将作为节点的唯一身份标识符。</p>
<p>如果您希望使用可选的 Node VIP 与 PG VIP 功能，应当确保所有节点位于一个大二层网络中。</p>
<p>您的防火墙策略应当保证所需的端口在节点间开放，不同模块所需的具体端口列表请参考 <a href="/zh/docs/node/"><strong>节点：端口</strong></a>。</p>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">应该暴露哪些端口？</h4>

    <p>暴露端口的方法取决于您的网络安全策略实现，例如：公有云上的安全组策略，或本地 iptables 记录，防火墙配置等。
如果您只是希望尝尝鲜，不在乎安全，并且希望一切越简单越好，那么您可以仅对外部用户按需开放 <code>5432</code> 端口（ PostgreSQL 数据库） 与 <code>3000</code> 端口（Grafana 可视化界面）。</p>
<p>在 <a href="/zh/docs/node#infra%E8%8A%82%E7%82%B9"><strong>Infra节点</strong></a> 上的 Nginx 默认会对外暴露 <code>80/443</code> 端口提供 Web 服务，并通过域名对不同服务进行区分，这一端口应当对办公网络（或整个整个互联网）开放。</p>
<p>严肃的生产数据库服务端口通常不应当直接暴露在公网上，如果您确实需要这么做，建议首先查阅 <a href="/zh/docs/setup/security/">安全最佳实践</a>，并小心行事。</p>


</div>

<hr>
<h2 id="操作系统准备">操作系统准备</h2>
<p>Pigsty 支持多种基于 Linux 内核的服务器操作系统发行版，我们建议使用 <strong>RockyLinux 9.4</strong> 或 <strong>Ubuntu 22.04.5</strong> 作为安装 Pigsty 的 OS。</p>
<p>Pigsty 支持 RHEL (7,8,9)，Debian (11,12)，Ubuntu (20,22,24) 以及多种与之兼容的操作系统发行版，完整操作系统列表请参考 <a href="/zh/docs/reference/compatibility"><strong>兼容性</strong></a>。</p>
<p>在使用多个节点镜进行部署时，我们 <strong>强烈</strong> 建议您在所有用于 Pigsty 部署的节点上，使用<strong>相同版本</strong>的操作系统发行版与 Linux 内核版本</p>
<p>我们<strong>强烈建议使用干净，全新安装的最小化安装的服务器操作系统环境</strong>，并使用 <code>en_US</code> 作为首要语言。</p>


<div class="alert alert-success" role="alert">
<h4 class="alert-heading">如何安装并启用 en_US locale？</h4>

    <p>使用其他系统语言包时，如何确保 <code>en_US</code> 本地化规则集可用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y glibc-locale-source glibc-langpack-en
</span></span><span style="display:flex;"><span>localedef -i en_US -f UTF-8 en_US.UTF-8
</span></span><span style="display:flex;"><span>localectl set-locale <span style="color:#000">LANG</span><span style="color:#ce5c00;font-weight:bold">=</span>en_US.UTF-8
</span></span></code></pre></div><p>注：Pigsty 部署的 PostgreSQL 集群默认使用 <code>C.UTF8</code> locale，但字符集定义使用 <code>en_US</code> 以确保 <code>pg_trgm</code> 扩展可以正常工作。
如果您确实不需要此功能，可以配置 <a href="/zh/docs/reference/param#pg_lc_ctype"><strong><code>pg_lc_ctype</code></strong></a> 的值为 <code>C.UTF8</code> ，以避免在系统语言包缺失的情况下，数据库初始化报错的问题。</p>


</div>

<hr>
<h2 id="管理用户准备">管理用户准备</h2>
<p>在安装 Pigsty 的节点上，您需要拥有一个 “<strong>管理用户</strong>” —— 拥有免密 <code>ssh</code> 登陆权限与免密 <code>sudo</code> 权限。</p>
<p>免密 <code>sudo</code> 是必选项，用于在安装过程中执行需要 <code>sudo</code> 权限的命令，例如安装软件包，配置系统参数等。</p>


<div class="alert alert-success" role="alert">
<h4 class="alert-heading">如何配置管理用户的免密码 sudo 权限？</h4>

    <p>假设您的管理用户名为 <code>vagrant</code> ，则可以创建 <code>/etc/sudoers.d/vagrant</code> 文件，并添加以下记录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>%vagrant <span style="color:#000">ALL</span><span style="color:#ce5c00;font-weight:bold">=(</span>ALL<span style="color:#ce5c00;font-weight:bold">)</span> NOPASSWD: ALL
</span></span></code></pre></div><p>则 vagrant 用户即可免密 <code>sudo</code> 执行所有命令。如果你的用户名不是 <code>vagrant</code>，请将上面操作中的 <code>vagrant</code> 替换为您的用户名。</p>


</div>



<div class="alert alert-danger" role="alert">
<h4 class="alert-heading">避免使用 root 用户安装</h4>

    <p>尽管使用 <code>root</code> 用户安装 Pigsty 是可行的，但我们不推荐这样做。</p>
<p><a href="/zh/docs/setup/security/">安全最佳实践</a> 是使用一个不同于根用户（<code>root</code>）与数据库超级用户 (<code>postgres</code>) 的专用管理员用户（如：<code>dba</code>）</p>
<p>Pigsty 提供了专用剧本任务，可以使用一个现有的管理用户（例如 <code>root</code>），输入 ssh/sudo 密码，创建一个专用的 <a href="/zh/docs/node/#%E5%88%9B%E5%BB%BA%E7%AE%A1%E7%90%86%E5%91%98"><strong>管理员用户</strong></a>。</p>


</div>

<hr>
<h2 id="ssh-权限准备">SSH 权限准备</h2>
<p>除了免密 <code>sudo</code> 权限， Pigsty 还需要管理用户免密 <code>ssh</code> 登陆的权限。</p>
<p>对于<a href="/zh/docs/concept/arch#%E5%8D%95%E6%9C%BA%E5%AE%89%E8%A3%85">单机安装</a>的节点而言，这意味着本机上的管理用户可以通过 ssh 免密码登陆到本机上。
如果的 Pigsty 部署涉及到多个节点，这意味着<a href="/zh/docs/node#admin%E8%8A%82%E7%82%B9">管理节点</a>上的管理用户应当可以通过 ssh 免密码登陆到所有被 Pigsty 纳管的节点上（包括本机），并免密执行 <code>sudo</code> 命令。</p>
<p>单机安装时，在 <a href="/zh/docs/setup/install#%E9%85%8D%E7%BD%AE"><strong><code>configure</code></strong></a> 过程中，如果您的当前管理用户没有 SSH key，Pigsty 会尝试修复此问题：随机生成一对新的 <code>id_rsa</code> 密钥，并添加至本地 <code>~/.ssh/authroized_keys</code> 文件确保本机管理用户的 SSH 登陆能力。</p>
<p>Pigsty 默认会为您在纳管的节点上创建一个可用的管理用户 <code>dba</code> (<code>uid=88</code>)，如果您已经使用了此用户，我们建议您修改 <a href="/zh/docs/reference/param#node_admin_username"><code>node_admin_username</code></a> 使用新的用户名与其他 uid，或通过 <a href="/zh/docs/reference/param#node_admin_enabled"><code>node_admin_enabled</code></a> 参数禁用。</p>


<div class="alert alert-success" role="alert">
<h4 class="alert-heading">如何配置管理用户的 ssh 免密码登陆？</h4>

    <p>假设您的管理用户名为 <code>vagrant</code>，则以 <code>vagrant</code> 用户身份执行以下命令，会为其生成公私钥对 <code>~/.ssh/id_rsa[.pub]</code> 用于登陆。如果已经存在公私钥对，则无需生成新密钥对。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh-keygen -t rsa -b <span style="color:#0000cf;font-weight:bold">2048</span> -N <span style="color:#4e9a06">&#39;&#39;</span> -f ~/.ssh/id_rsa -q
</span></span></code></pre></div><p>生成的公钥默认位于：<code>/home/vagrant/.ssh/id_rsa.pub</code>，私钥默认位于：<code>/home/vagrant/.ssh/id_rsa</code>，如果您操作系统用户名不叫 <code>vagrant</code>，将上面的 <code>vagrant</code> 替换为您的用户名即可。</p>
<p>您应当将公钥文件（<code>id_rsa.pub</code>）追加写入到需要登陆机器的对应用户上：<code>/home/vagrant/.ssh/authorized_keys</code> 文件中。如果您已经可以直接通过密码访问远程机器，可以直接通过<code>ssh-copy-id</code>的方式拷贝公钥：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh-copy-id &lt;ip&gt;                        <span style="color:#8f5902;font-style:italic"># 输入密码以完成公钥拷贝</span>
</span></span><span style="display:flex;"><span>sshpass -p &lt;password&gt; ssh-copy-id &lt;ip&gt;  <span style="color:#8f5902;font-style:italic"># 直接将密码嵌入命令中，避免交互式密码输入（注意安全！）</span>
</span></span></code></pre></div><p>Pigsty 推荐将管理用户的创建，权限配置与密钥分发放在虚拟机的置备阶段完成，作为标准化交付内容的一部分。</p>


</div>

<hr>
<h2 id="ssh-例外情况">SSH 例外情况</h2>
<p>如果您的 SSH 访问有一些额外限制，例如，使用了跳板机，或者进行了某些定制化修改，无法通过简单的 <code>ssh &lt;ip&gt;</code> 方式访问，那么可以考虑使用 ssh 别名。</p>
<p>例如，如果您的服务器可以通过 <code>~/.ssh/config</code> 中定义的别名，例如 <code>meta</code> 通过 <code>ssh</code> 访问，那么可以为 <a href="/zh/docs/setup/config"><strong>配置清单</strong></a> 中的节点配置 <code>ansible_host</code> 参数，指定 SSH Alias：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">nodes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 10.10.10.10 无法直接 ssh，但可以通过ssh别名 `meta` 访问</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ansible_host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>如果 SSH 别名无法满足您的需求，Ansible 还提供了一系列自定义 <a href="https://docs.ansible.com/archive/ansible/2.4/intro_inventory.html#list-of-behavioral-inventory-parameters"><strong>ssh 连接参数</strong></a>，可以精细控制 SSH 连接的行为。</p>
<p>最后，如果以下命令可以在管理节点上使用管理用户成功执行，意味着该目标节点上的管理用户与权限配置已经妥当：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh &lt;ip<span style="color:#000;font-weight:bold">|</span>alias&gt; <span style="color:#4e9a06">&#39;sudo ls&#39;</span>
</span></span></code></pre></div><hr>
<h2 id="软件准备">软件准备</h2>
<p>在 <a href="/zh/docs/node#admin%E8%8A%82%E7%82%B9"><strong>管理节点</strong></a> 上，Pigsty 需要使用 <a href="/zh/docs/setup/playbook/#ansible"><strong>Ansible</strong></a> 发起控制命令。如果您使用本地单机安装，那么管理节点和被管理的节点是同一台，需要安装 Ansible。对于普通节点，则无需安装 Ansible。</p>
<p>在 <a href="/zh/docs/setup/offline#bootstrap"><strong><code>bootstrap</code></strong></a> 过程中，Pigsty 会尽最大努力自动为您完成安装 Ansible 这一任务，但您也可以选择手工安装 Ansible。手工安装 Ansible 的过程因不同操作系统发行版/大版本而异（通常涉及到额外的弱依赖 <code>jmespath</code>）：</p>






<ul class="nav nav-tabs" id="tabs-6" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-06-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-06-00" role="tab"
          aria-controls="tabs-06-00" aria-selected="false">
        安装 Ansible
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-06-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-06-01" role="tab"
          aria-controls="tabs-06-01" aria-selected="true">
        EL 8 / 9
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-06-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-06-02" role="tab"
          aria-controls="tabs-06-02" aria-selected="false">
        EL 7
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-06-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-06-03" role="tab"
          aria-controls="tabs-06-03" aria-selected="false">
        Debian / Ubuntu
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-06-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-06-04" role="tab"
          aria-controls="tabs-06-04" aria-selected="false">
        MacOS
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-6-content">
    <div class="tab-pane fade"
        id="tabs-06-00" role="tabpanel" aria-labelled-by="tabs-06-00-tab" tabindex="6">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"></code></pre></div>
    </div>
    <div class="tab-pane fade show active"
        id="tabs-06-01" role="tabpanel" aria-labelled-by="tabs-06-01-tab" tabindex="6">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>sudo dnf install -y ansible python3.12-jmespath python3-cryptography</span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-06-02" role="tabpanel" aria-labelled-by="tabs-06-02-tab" tabindex="6">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>sudo yum install -y ansible   <span style="color:#8f5902;font-style:italic"># EL7 无需显式安装 Jmespath</span></span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-06-03" role="tabpanel" aria-labelled-by="tabs-06-03-tab" tabindex="6">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>sudo apt install -y ansible python3-jmespath</span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-06-04" role="tabpanel" aria-labelled-by="tabs-06-04-tab" tabindex="6">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>brew install ansible</span></span></code></pre></div>
    </div>
</div>

<p>为了安装 Pigsty，您还需要准备 Pigsty 源码包。您可以直接从 <a href="https://github.com/Vonng/pigsty/releases/">GitHub Release</a> 页面下载特定版本，或使用以下命令获取最新稳定版本：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -fsSL https://repo.pigsty.cc/get <span style="color:#000;font-weight:bold">|</span> bash
</span></span></code></pre></div><p>如果您的环境没有互联网访问，也可以考虑直接从 GitHub Release 页面或其他渠道下载针对不同操作系统发行版预先制作的 <a href="/zh/docs/setup/offline/#离线软件包"><strong>离线安装包</strong></a>。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-98758ad7ef56ab0b1a9ad8320b14506b">6 - 执行剧本</h1>
    <div class="lead">Pigsty 使用 Ansible 剧本来实现所需的安装部署管理功能，但如果只是使用的话，您并不需要了解太多细节。</div>
	<p>在 Pigsty 中，剧本 / Playbooks 用于在节点上安装<a href="/zh/docs/about/module">模块</a>。</p>
<p>剧本可以视作可执行文件直接执行，例如：<code>./install.yml</code>.</p>
<hr>
<h2 id="剧本">剧本</h2>
<p>以下是 Pigsty 中默认包含的剧本：</p>
<table>
<thead>
<tr>
<th>剧本</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/install.yml"><code>install.yml</code></a></td>
<td>在当前节点上一次性完整安装 Pigsty</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/infra.yml"><code>infra.yml</code></a></td>
<td>在 infra 节点上初始化 pigsty 基础设施</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/infra-rm.yml"><code>infra-rm.yml</code></a></td>
<td>从 infra 节点移除基础设施组件</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/node.yml"><code>node.yml</code></a></td>
<td>纳管节点，并调整节点到期望的状态</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/node-rm.yml"><code>node-rm.yml</code></a></td>
<td>从 pigsty 中移除纳管节点</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/pgsql.yml"><code>pgsql.yml</code></a></td>
<td>初始化 HA PostgreSQL 集群或添加新的从库实例</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/pgsql-rm.yml"><code>pgsql-rm.yml</code></a></td>
<td>移除 PostgreSQL 集群或移除从库实例</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/pgsql-user.yml"><code>pgsql-user.yml</code></a></td>
<td>向现有的 PostgreSQL 集群添加新的业务用户</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/pgsql-db.yml"><code>pgsql-db.yml</code></a></td>
<td>向现有的 PostgreSQL 集群添加新的业务数据库</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/pgsql-monitor.yml"><code>pgsql-monitor.yml</code></a></td>
<td>监控纳管远程 postgres 实例</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/pgsql-migration.yml"><code>pgsql-migration.yml</code></a></td>
<td>为现有的 PostgreSQL 生成迁移手册和脚本</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/redis.yml"><code>redis.yml</code></a></td>
<td>初始化 redis 集群/节点/实例</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/redis-rm.yml"><code>redis-rm.yml</code></a></td>
<td>移除 redis 集群/节点/实例</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/etcd.yml"><code>etcd.yml</code></a></td>
<td>初始化 etcd 集群（patroni HA DCS所需）</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/minio.yml"><code>minio.yml</code></a></td>
<td>初始化 minio 集群（pgbackrest 备份仓库备选项）</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/docker.yml"><code>docker.yml</code></a></td>
<td>在节点上安装 docker</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/mongo.yml"><code>mongo.yml</code></a></td>
<td>在节点上安装 Mongo/FerretDB</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/cert.yml"><code>cert.yml</code></a></td>
<td>使用 pigsty 自签名 CA 颁发证书（例如用于客户端）</td>
</tr>
<tr>
<td><a href="https://github.com/vonng/pigsty/blob/main/cache.yml"><code>cache.yml</code></a></td>
<td>制作离线软件包</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="一次性安装">一次性安装</h3>
<p>特殊的剧本 <code>install.yml</code> 实际上是一个复合剧本，它在当前环境上安装所有以下组件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  playbook  / <span style="color:#204a87">command</span> / group         infra           nodes    etcd     minio     pgsql
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>infra.yml<span style="color:#ce5c00;font-weight:bold">]</span> ./infra.yml <span style="color:#ce5c00;font-weight:bold">[</span>-l infra<span style="color:#ce5c00;font-weight:bold">]</span>   <span style="color:#ce5c00;font-weight:bold">[</span>+infra<span style="color:#ce5c00;font-weight:bold">][</span>+node<span style="color:#ce5c00;font-weight:bold">]</span> 
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>node.yml<span style="color:#ce5c00;font-weight:bold">]</span>  ./node.yml                               <span style="color:#ce5c00;font-weight:bold">[</span>+node<span style="color:#ce5c00;font-weight:bold">]</span>  <span style="color:#ce5c00;font-weight:bold">[</span>+node<span style="color:#ce5c00;font-weight:bold">]</span>  <span style="color:#ce5c00;font-weight:bold">[</span>+node<span style="color:#ce5c00;font-weight:bold">]</span>   <span style="color:#ce5c00;font-weight:bold">[</span>+node<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>etcd.yml<span style="color:#ce5c00;font-weight:bold">]</span>  ./etcd.yml  <span style="color:#ce5c00;font-weight:bold">[</span>-l etcd <span style="color:#ce5c00;font-weight:bold">]</span>                            <span style="color:#ce5c00;font-weight:bold">[</span>+etcd<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>minio.yml<span style="color:#ce5c00;font-weight:bold">]</span> ./minio.yml <span style="color:#ce5c00;font-weight:bold">[</span>-l minio<span style="color:#ce5c00;font-weight:bold">]</span>                                     <span style="color:#ce5c00;font-weight:bold">[</span>+minio<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>pgsql.yml<span style="color:#ce5c00;font-weight:bold">]</span> ./pgsql.yml                                                          <span style="color:#ce5c00;font-weight:bold">[</span>+pgsql<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>请注意，<a href="/zh/docs/node"><code>NODE</code></a> 和 <a href="/zh/docs/infra"><code>INFRA</code></a> 之间存在循环依赖：为了在 INFRA 上注册 NODE，INFRA 应该已经存在，而 INFRA 模块依赖于 INFRA节点上的 NODE 模块才能工作。</p>
<p>为了解决这个问题，INFRA 模块的安装剧本也会在 INFRA 节点上安装 NODE 模块。所以，请确保首先初始化 INFRA 节点。</p>
<p>如果您非要一次性初始化包括 INFRA 在内的所有节点，<code>install.yml</code> 剧本就是用来解决这个问题的：它会正确的处理好这里的循环依赖，一次性完成整个环境的初始化。</p>
<hr>
<h2 id="ansible">Ansible</h2>
<p>执行剧本需要 <code>ansible-playbook</code> 可执行文件，该文件包含在 <code>ansible</code> rpm/deb 包中。</p>
<p>Pigsty 将在 <a href="/zh/docs/setup/install#%E5%87%86%E5%A4%87"><strong>准备</strong></a> 期间在尽最大努力尝试在当前节点安装 <code>ansible</code>。</p>
<p>您可以自己使用 <code>yum</code> / <code>apt</code> / <code>brew</code>  <code>install ansible</code> 来安装 Ansible，它含在各大发行版的默认仓库中。</p>
<p>了解 ansible 对于使用 Pigsty 很有帮助，但也不是必要的。对于基本使用，您只需要注意四个参数就足够了：</p>
<ul>
<li><code>-i|--inventory &lt;path&gt;</code> ：显式指定使用的配置文件</li>
<li><code>-l|--limit &lt;pattern&gt;</code> : 限制剧本在特定的组/主机/模式上执行目标（在哪里/Where）</li>
<li><code>-t|--tags &lt;tags&gt;</code> : 只运行带有特定标签的任务（做什么/What）</li>
<li><code>-e|--extra-vars &lt;vars&gt;</code> : 传递额外的命令行参数（怎么做/How）</li>
</ul>
<hr>
<h2 id="指定配置文件">指定配置文件</h2>
<p>您可以使用 <code>-i</code> 命令行参数，显式指定使用的配置文件。</p>
<p>Pigsty 默认使用名为 <code>pigsty.yml</code> 配置文件，该文件位于 Pigsty 源码根目录中的 <code>pigsty.yml</code>。但您可以使用 <code>-i</code> 覆盖这一行为，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./node.yml -i files/pigsty/rpmbuild.yml    <span style="color:#8f5902;font-style:italic"># 根据 rpmbuild 配置文件，初始化目标节点，而不是使用默认的 pigsty.yml 配置文件</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -i files/pigsty/rpm.yml        <span style="color:#8f5902;font-style:italic"># 根据 files/pigsty/rpm.yml 配置文件中的定义，在目标节点上安装 pgsql 模块</span>
</span></span><span style="display:flex;"><span>./redis.yml -i files/pigsty/redis.yml      <span style="color:#8f5902;font-style:italic"># 根据 files/pigsty/redis.yml 配置文件中的定义，在目标节点上安装 redis 模块</span>
</span></span></code></pre></div><p>如果您希望永久修改默认使用的配置文件，可以修改源码根目录下的 <a href="https://github.com/Vonng/pigsty/blob/main/ansible.cfg#L6"><code>ansible.cfg</code></a> 的 <code>inventory</code> 参数，将其指向您的配置文件路径。
这样您就可以在执行 <code>ansible-playbook</code> 命令时无需显式指定 <code>-i</code> 参数了。</p>
<hr>
<h2 id="指定执行对象">指定执行对象</h2>
<p>您可以使用 <code>-l|-limit &lt;selector&gt;</code> 限制剧本的执行目标。</p>
<p>缺少此值可能很危险，因为大多数剧本会在 <code>all</code> 分组，也就是所有主机上执行，使用时务必小心。</p>
<p>以下是一些主机限制的示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml                              <span style="color:#8f5902;font-style:italic"># 在所有主机上运行（非常危险！）</span>
</span></span><span style="display:flex;"><span>./pgsql.yml   -l pg-test                 <span style="color:#8f5902;font-style:italic"># 在 pg-test 集群上运行</span>
</span></span><span style="display:flex;"><span>./pgsql.yml   -l 10.10.10.10             <span style="color:#8f5902;font-style:italic"># 在单个主机 10.10.10.10 上运行</span>
</span></span><span style="display:flex;"><span>./pgsql.yml   -l pg-*                    <span style="color:#8f5902;font-style:italic"># 在与通配符 `pg-*` 匹配的主机/组上运行</span>
</span></span><span style="display:flex;"><span>./pgsql.yml   -l <span style="color:#4e9a06">&#39;10.10.10.11,&amp;pg-test&#39;</span>  <span style="color:#8f5902;font-style:italic"># 在组 pg-test 的 10.10.10.10 上运行</span>
</span></span><span style="display:flex;"><span>/pgsql-rm.yml -l <span style="color:#4e9a06">&#39;pg-test,!10.10.10.11&#39;</span>  <span style="color:#8f5902;font-style:italic"># 在 pg-test 上运行，除了 10.10.10.11 以外</span>
</span></span><span style="display:flex;"><span>./pgsql.yml   -l pg-test                 <span style="color:#8f5902;font-style:italic"># 在 pg-test 集群的主机上执行 pgsql 剧本</span>
</span></span></code></pre></div><hr>
<h2 id="执行剧本子集">执行剧本子集</h2>
<p>你可以使用 <code>-t|--tags &lt;tag&gt;</code> 执行剧本的子集。 你可以在逗号分隔的列表中指定多个标签，例如 <code>-t tag1,tag2</code>。</p>
<p>如果指定了任务子集，将执行给定标签的任务，而不是整个剧本。以下是任务限制的一些示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_clean    <span style="color:#8f5902;font-style:italic"># 如果必要，清理现有的 postgres</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_dbsu     <span style="color:#8f5902;font-style:italic"># 为 postgres dbsu 设置操作系统用户 sudo</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_install  <span style="color:#8f5902;font-style:italic"># 安装 postgres 包和扩展</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_dir      <span style="color:#8f5902;font-style:italic"># 创建 postgres 目录并设置 fhs</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_util     <span style="color:#8f5902;font-style:italic"># 复制工具脚本，设置别名和环境</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t patroni     <span style="color:#8f5902;font-style:italic"># 使用 patroni 引导 postgres</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_user     <span style="color:#8f5902;font-style:italic"># 提供 postgres 业务用户</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_db       <span style="color:#8f5902;font-style:italic"># 提供 postgres 业务数据库</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_backup   <span style="color:#8f5902;font-style:italic"># 初始化 pgbackrest 仓库和 basebackup</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pgbouncer   <span style="color:#8f5902;font-style:italic"># 与 postgres 一起部署 pgbouncer sidecar</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_vip      <span style="color:#8f5902;font-style:italic"># 使用 vip-manager 将 vip 绑定到 pgsql 主库</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_dns      <span style="color:#8f5902;font-style:italic"># 将 dns 名称注册到 infra dnsmasq</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_service  <span style="color:#8f5902;font-style:italic"># 使用 haproxy 暴露 pgsql 服务</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_exporter <span style="color:#8f5902;font-style:italic"># 使用 haproxy 暴露 pgsql 服务</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_register <span style="color:#8f5902;font-style:italic"># 将 postgres 注册到 pigsty 基础设施</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 运行多个任务：重新加载 postgres 和 pgbouncer hba 规则</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 运行多个任务：刷新 haproxy 配置并重新加载</span>
</span></span><span style="display:flex;"><span>./node.yml -t haproxy_config,haproxy_reload
</span></span></code></pre></div><hr>
<h2 id="传递额外参数">传递额外参数</h2>
<p>您可以通过 <code>-e|-extra-vars KEY=VALUE</code> 传递额外的命令行参数。</p>
<p>命令行参数具有压倒性的优先级，以下是一些额外参数的示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./node.yml -e <span style="color:#000">ansible_user</span><span style="color:#ce5c00;font-weight:bold">=</span>admin -k -K                  <span style="color:#8f5902;font-style:italic"># 作为另一个用户运行剧本（带有 admin sudo 密码）</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -e <span style="color:#000">pg_clean</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>                            <span style="color:#8f5902;font-style:italic"># 在初始化 pgsql 实例时强制清除现有的 postgres</span>
</span></span><span style="display:flex;"><span>./pgsql-rm.yml -e <span style="color:#000">pg_uninstall</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>                     <span style="color:#8f5902;font-style:italic"># 在 postgres 实例被删除后明确卸载 rpm</span>
</span></span><span style="display:flex;"><span>./redis.yml -l 10.10.10.11 -e <span style="color:#000">redis_port</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">6379</span> -t redis  <span style="color:#8f5902;font-style:italic"># 初始化一个特定的 redis 实例：10.10.10.11:6379</span>
</span></span><span style="display:flex;"><span>./redis-rm.yml -l 10.10.10.13 -e <span style="color:#000">redis_port</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">6379</span>        <span style="color:#8f5902;font-style:italic"># 删除一个特定的 redis 实例：10.10.10.11:6379</span>
</span></span></code></pre></div><p>此外，您还可以通过 JSON 的方式，传递诸如数组与对象这样的复杂参数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过指定软件包与仓库模块，在节点上安装 duckdb</span>
</span></span><span style="display:flex;"><span>./node.yml -t node_repo,node_pkg  -e <span style="color:#4e9a06">&#39;{&#34;node_repo_modules&#34;:&#34;infra&#34;,&#34;node_default_packages&#34;:[&#34;duckdb&#34;]}&#39;</span>
</span></span></code></pre></div><p>大多数剧本都是幂等的，这意味着在未打开保护选项的情况下，一些部署剧本可能会 <strong>删除现有的数据库</strong> 并创建新的数据库。</p>
<p><strong>请仔细阅读文档，多次校对命令，并小心操作。作者不对因误用造成的任何数据库损失负责</strong>。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2b6cc71ea6f4c2bb3c7905255869cead">7 - 置备机器</h1>
    <div class="lead">介绍 Pigsty 演示所使用的标准四节点沙箱环境，以及如何使用 Vagrant 与 Terraform 置备所需的虚拟机。</div>
	<p>Pigsty 在节点上运行，这些节点可以是裸机或虚拟机。您可以手工置备它们，或使用 terraform 和 vagrant 这样的工具在云端或本地进行自动配置。</p>
<hr>
<h2 id="沙箱环境">沙箱环境</h2>
<p>Pigsty 带有一个演示沙箱，所谓沙箱，就是专门用来演示/测试的环境：IP地址和其他标识符都预先固定配置好，便于复现各种演示用例。</p>
<p>默认的沙箱环境由4个节点组成，配置文件请参考 <a href="https://github.com/Vonng/pigsty/blob/main/conf/full.yml"><code>full.yml</code></a>。</p>
<p>沙箱的 4 个节点有着固定的 IP 地址：<code>10.10.10.10</code>、<code>10.10.10.11</code>、<code>10.10.10.12</code>、<code>10.10.10.13</code>。</p>
<p>沙箱带有一个位于 <code>meta</code> 节点上的单实例 PostgreSQL 集群：<code>pg-meta</code>：</p>
<ul>
<li><code>meta    10.10.10.10  pg-meta pg-meta-1</code></li>
</ul>
<p>沙箱中还有一个由三个实例组成的 PostgreSQL 高可用集群：<code>pg-test</code>，部署在另外三个节点上：</p>
<ul>
<li><code>node-1  10.10.10.11  pg-test.pg-test-1</code></li>
<li><code>node-2  10.10.10.12  pg-test.pg-test-2</code></li>
<li><code>node-3  10.10.10.13  pg-test.pg-test-3</code></li>
</ul>
<p>两个可选的 L2 VIP 分别绑定在 <code>pg-meta</code> 和 <code>pg-test</code> 集群的主实例上：</p>
<ul>
<li><code>10.10.10.2  pg-meta</code></li>
<li><code>10.10.10.3  pg-test</code></li>
</ul>
<p>在 <code>meta</code> 节点上，还有一个单实例的 <code>etcd</code> “集群”和一个单实例的 <code>minio</code> “集群”。</p>
<p><img alt="pigsty-sandbox.jpg" src="/img/pigsty/sandbox.jpg"></p>
<p>您可以在本地虚拟机或云虚拟机上运行沙箱。Pigsty 提供基于 Vagrant 的本地沙箱（使用 Virtualbox/libvirt 启动本地虚拟机）以及基于 Terraform 的云沙箱（使用云供应商 API 创建虚拟机）。</p>
<ul>
<li>
<p>本地沙箱可以在您的 Mac/PC 上免费运行。运行完整的4节点沙箱，您的 Mac/PC 应至少拥有 4C/8G。</p>
</li>
<li>
<p>云沙箱可以轻松创建和共享，单需要一个公有云帐户才行。云上虚拟机可以按需创建/一键销毁，对于快速测试来说非常便宜省事。</p>
</li>
</ul>
<p>此外，Pigsty 还提供了一个 42节点 的生产仿真环境沙箱 <a href="https://github.com/Vonng/pigsty/blob/main/conf/prod.yml"><code>prod.yml</code></a>。</p>
<hr>
<h2 id="vagrant">Vagrant</h2>
<p><a href="https://www.vagrantup.com/">Vagrant</a> 可以按照声明式的方式创建本地虚拟机。请查看 <a href="https://github.com/Vonng/pigsty/tree/master/vagrant/README.md">Vagrant 模板介绍</a> 以获取详情。</p>
<h3 id="安装">安装</h3>
<p>确保您的操作系统中已经安装并可以使用 <a href="https://www.vagrantup.com/">Vagrant</a> 和 <a href="https://www.virtualbox.org/">Virtualbox</a>。</p>
<p>如果您使用的是 macOS，您可以使用 <code>homebrew</code> 一键命令安装它们，注意安装 Virtualbox 后需要重启系统。</p>
<p>如果你用的是 Linux，可以使用 virtualbox，也可以考虑使用 KVM: <a href="https://vagrant-libvirt.github.io/vagrant-libvirt/">vagrant-libvirt</a>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/bin/bash -c <span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>brew install vagrant virtualbox ansible   <span style="color:#8f5902;font-style:italic"># 在 MacOS 中可以轻松一键安装，但只有 x86_64 Intel 芯片的可以 </span>
</span></span></code></pre></div><hr>
<h3 id="配置">配置</h3>
<p><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/Vagrantfile"><code>vagarnt/Vagranfile</code></a> 是一个 Ruby 脚本文件，用来描述 Vagrant 要创建的虚拟机节点。Pigsty 提供了一些默认的配置模板：</p>
<table>
<thead>
<tr>
<th style="text-align:center">模板</th>
<th style="text-align:center">快捷方式</th>
<th style="text-align:center">规格</th>
<th style="text-align:center">注释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/meta.rb">meta.rb</a></td>
<td style="text-align:center"><code>v1</code></td>
<td style="text-align:center">4C8G x 1</td>
<td style="text-align:center">单一 Meta 节点</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/full.rb">full.rb</a></td>
<td style="text-align:center"><code>v4</code></td>
<td style="text-align:center">2C4G + 1C2G x 3</td>
<td style="text-align:center">完整的4节点沙盒示例</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/el7.rb">el7.rb</a></td>
<td style="text-align:center"><code>v7</code></td>
<td style="text-align:center">2C4G + 1C2G x 3</td>
<td style="text-align:center">EL7 3-节点测试环境</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/el8.rb">el8.rb</a></td>
<td style="text-align:center"><code>v8</code></td>
<td style="text-align:center">2C4G + 1C2G x 3</td>
<td style="text-align:center">EL8 3-节点测试环境</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/el9.rb">el9.rb</a></td>
<td style="text-align:center"><code>v9</code></td>
<td style="text-align:center">2C4G + 1C2G x 3</td>
<td style="text-align:center">EL9 3-节点测试环境</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/build.rb">build.rb</a></td>
<td style="text-align:center"><code>vb</code></td>
<td style="text-align:center">2C4G x 3</td>
<td style="text-align:center">3-节点 EL7,8,9 构建环境</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/check.rb">check.rb</a></td>
<td style="text-align:center"><code>vc</code></td>
<td style="text-align:center">2C4G x 30</td>
<td style="text-align:center">30 EL7-9, PG12-16 测试环境</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/minio.rb">minio.rb</a></td>
<td style="text-align:center"><code>vm</code></td>
<td style="text-align:center">2C4G x 3 + Disk</td>
<td style="text-align:center">3-节点 MinIO/etcd 测试环境</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/prod.rb">prod.rb</a></td>
<td style="text-align:center"><code>vp</code></td>
<td style="text-align:center">2C4G x 42</td>
<td style="text-align:center">42节点的生产模拟环境</td>
</tr>
</tbody>
</table>
<p>每个规格文件包含一个描述虚拟机节点的 <code>Specs</code> 变量。例如，<code>full.rb</code> 包含4节点沙盒规格的描述：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#000">Specs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;meta&#34;</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#4e9a06">&#34;ip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;10.10.10.10&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;cpu&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;2&#34;</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#4e9a06">&#34;mem&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;4096&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;image&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;generic/rocky9&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;node-1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;10.10.10.11&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;cpu&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#4e9a06">&#34;mem&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;2048&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;image&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;generic/rocky9&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;node-2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;10.10.10.12&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;cpu&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#4e9a06">&#34;mem&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;2048&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;image&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;generic/rocky9&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;node-3&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;10.10.10.13&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;cpu&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#4e9a06">&#34;mem&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;2048&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;image&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;generic/rocky9&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>您可以使用 <code>vagrant/config</code> 脚本切换 Vagrant 配置文件，它会根据规格以及虚拟机软件类型，渲染生成最终的 <code>Vagrantfile</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty
</span></span><span style="display:flex;"><span>vagrant/config &lt;spec&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vagrant/config meta     <span style="color:#8f5902;font-style:italic"># singleton meta        | 别名：`make v1`</span>
</span></span><span style="display:flex;"><span>vagrant/config full     <span style="color:#8f5902;font-style:italic"># 4-node sandbox        | 别名：`make v4`</span>
</span></span><span style="display:flex;"><span>vagrant/config el7      <span style="color:#8f5902;font-style:italic"># 3-node el7 test       | 别名：`make v7`</span>
</span></span><span style="display:flex;"><span>vagrant/config el8      <span style="color:#8f5902;font-style:italic"># 3-node el8 test       | 别名：`make v8`</span>
</span></span><span style="display:flex;"><span>vagrant/config el9      <span style="color:#8f5902;font-style:italic"># 3-node el9 test       | 别名：`make v9`</span>
</span></span><span style="display:flex;"><span>vagrant/config prod     <span style="color:#8f5902;font-style:italic"># prod simulation       | 别名：`make vp`</span>
</span></span><span style="display:flex;"><span>vagrant/config build    <span style="color:#8f5902;font-style:italic"># building environment  | 别名：`make vd`</span>
</span></span><span style="display:flex;"><span>vagrant/config minio    <span style="color:#8f5902;font-style:italic"># 3-node minio env</span>
</span></span><span style="display:flex;"><span>vagrant/config check    <span style="color:#8f5902;font-style:italic"># 30-node check env</span>
</span></span></code></pre></div><hr>
<h3 id="虚拟机管理">虚拟机管理</h3>
<p>当您使用 <code>vagrant/Vagrantfile</code> 描述了所需的虚拟机后，你可以使用<code>vagrant up</code>命令创建这些虚拟机。</p>
<p>Pigsty 模板默认会使用你的 <code>~/.ssh/id_rsa[.pub]</code> 作为这些虚拟机的默认ssh凭证。</p>
<p>在开始之前，请确保你有一个有效的ssh密钥对，你可以通过以下方式生成一对：<code>ssh-keygen -t rsa -b 2048</code></p>
<p>此外，还有一些 <code>makefile</code> 快捷方式包装了 vagrant 命令，你可以使用它们来管理虚拟机。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make         <span style="color:#8f5902;font-style:italic"># 等于 make start</span>
</span></span><span style="display:flex;"><span>make new     <span style="color:#8f5902;font-style:italic"># 销毁现有虚拟机，根据规格创建新的</span>
</span></span><span style="display:flex;"><span>make ssh     <span style="color:#8f5902;font-style:italic"># 将 SSH 配置写入到 ~/.ssh/ 中 （新虚拟机拉起后必须完成这一步）</span>
</span></span><span style="display:flex;"><span>make dns     <span style="color:#8f5902;font-style:italic"># 将 虚拟机 DNS 记录写入到 /etc/hosts 中 （如果想使用名称访问虚拟机)</span>
</span></span><span style="display:flex;"><span>make start   <span style="color:#8f5902;font-style:italic"># 等于先执行 up ，再执行 ssh </span>
</span></span><span style="display:flex;"><span>make up      <span style="color:#8f5902;font-style:italic"># 根据配置拉起虚拟机，或启动现有虚拟机</span>
</span></span><span style="display:flex;"><span>make halt    <span style="color:#8f5902;font-style:italic"># 关停现有虚拟机 (down,dw)</span>
</span></span><span style="display:flex;"><span>make clean   <span style="color:#8f5902;font-style:italic"># 销毁现有虚拟机 (clean/del/destroy)</span>
</span></span><span style="display:flex;"><span>make status  <span style="color:#8f5902;font-style:italic"># 显示虚拟机状态 (st)</span>
</span></span><span style="display:flex;"><span>make pause   <span style="color:#8f5902;font-style:italic"># 暂停虚拟机运行 (suspend,pause)</span>
</span></span><span style="display:flex;"><span>make resume  <span style="color:#8f5902;font-style:italic"># 恢复虚拟机运行 (resume)</span>
</span></span><span style="display:flex;"><span>make nuke    <span style="color:#8f5902;font-style:italic"># 使用 virsh 销毁所有虚拟机 (仅libvirt可用) </span>
</span></span></code></pre></div><hr>
<h3 id="快捷方式">快捷方式</h3>
<p>你可以使用以下的 Makefile 快捷方式使用 vagrant 拉起虚拟机环境。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make meta     <span style="color:#8f5902;font-style:italic"># 单个元节点</span>
</span></span><span style="display:flex;"><span>make full     <span style="color:#8f5902;font-style:italic"># 4-节点沙箱</span>
</span></span><span style="display:flex;"><span>make el7      <span style="color:#8f5902;font-style:italic"># 3-节点 el7 测试环境</span>
</span></span><span style="display:flex;"><span>make el8      <span style="color:#8f5902;font-style:italic"># 3-节点 el8 测试环境</span>
</span></span><span style="display:flex;"><span>make el9      <span style="color:#8f5902;font-style:italic"># 3-节点 el9 测试环境</span>
</span></span><span style="display:flex;"><span>make prod     <span style="color:#8f5902;font-style:italic"># 42 节点生产仿真环境</span>
</span></span><span style="display:flex;"><span>make build    <span style="color:#8f5902;font-style:italic"># 3-节点 EL7,8,9 构建环境</span>
</span></span><span style="display:flex;"><span>make check    <span style="color:#8f5902;font-style:italic"># 30-节点构建校验测试环境</span>
</span></span><span style="display:flex;"><span>make minio    <span style="color:#8f5902;font-style:italic"># 3-节点 MinIO 测试环境</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make meta  install  <span style="color:#8f5902;font-style:italic"># 进行完整的单机安装</span>
</span></span><span style="display:flex;"><span>make full  install  <span style="color:#8f5902;font-style:italic"># 进行4节点沙箱安装</span>
</span></span><span style="display:flex;"><span>make prod  install  <span style="color:#8f5902;font-style:italic"># 进行42节点生产仿真环境安装</span>
</span></span><span style="display:flex;"><span>make check install  <span style="color:#8f5902;font-style:italic"># 进行30节点本地测试环境安装</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><hr>
<h2 id="terraform">Terraform</h2>
<p><a href="https://www.terraform.io/">Terraform</a>是一个开源的实践“基础设施即代码”的工具：描述你想要的云资源，然后一键创建它们。</p>
<p>Pigsty 提供了 AWS，阿里云，腾讯云的 Terraform 模板，您可以使用它们在云上一键创建虚拟机。</p>
<p>在 MacOS 上，Terraform 可以使用 homebrew 一键安装：<code>brew install terraform</code>。你需要创建一个云帐户，获取 AccessKey 和 AccessSecret 凭证来继续下面的操作。</p>
<p><code>terraform/</code>目录包含两个示例模板：一个 AWS 模板，一个阿里云模板，你可以按需调整它们，或者作为其他云厂商配置文件的参考，让我们用阿里云为例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> terraform                         <span style="color:#8f5902;font-style:italic"># 进入 Terraform 模板目录</span>
</span></span><span style="display:flex;"><span>cp spec/alicloud.tf terraform.tf     <span style="color:#8f5902;font-style:italic"># 使用 阿里云 Terraform 模板</span>
</span></span></code></pre></div><p>在执行 <code>terraform apply</code> 拉起虚拟机之前，你要执行一次 <code>terraform init</code> 安装相应云厂商的插件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>terraform init      <span style="color:#8f5902;font-style:italic"># 安装 terraform 云供应商插件：例如默认的 aliyun 插件 (第一次使用时安装即可)</span>
</span></span><span style="display:flex;"><span>terraform apply     <span style="color:#8f5902;font-style:italic"># 生成执行计划，显示会创建的云资源：虚拟机，网络，安全组，等等等等……</span>
</span></span></code></pre></div><p>运行 <code>apply</code> 子命令并按提示回答 <code>yes</code> 后，Terraform 将为你创建虚拟机以及其他云资源（网络，安全组，以及其他各种玩意）。</p>
<p>执行结束时，管理员节点的IP地址将被打印出来，你可以登录并开始完成 Pigsty 本身的<a href="/zh/docs/setup/install">安装</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d6a656f7f8306b7de558a78bf1164ae0">8 - 安全考量</h1>
    <div class="lead">Pigsty部署中与安全有关的考量</div>
	<p>Pigsty 的默认配置已经足以覆盖绝大多数场景对于安全的需求。</p>
<p>Pigsty 已经提供了开箱即用的<a href="/zh/docs/pgsql/hba">认证</a>与<a href="/zh/docs/pgsql/acl">访问控制</a>模型，对于绝大多数场景已经足够安全。</p>
<p><a href="/zh/docs/pgsql/acl"><img alt="pigsty-acl.jpg" src="/img/pigsty/acl.jpg"></a></p>
<p>如果您希望进一步加固系统的安全性，那么以下建议供您参考：</p>
<hr>
<h2 id="机密性">机密性</h2>
<h3 id="重要文件">重要文件</h3>
<p><strong>保护你的 pigsty.yml 配置文件或CMDB</strong></p>
<ul>
<li><code>pigsty.yml</code> 配置文件通常包含了高度敏感的机密信息，您应当确保它的安全。</li>
<li>严格控制管理节点的访问权限，仅限 DBA 或者 Infra 管理员访问。</li>
<li>严格控制 pigsty.yml 配置文件仓库的访问权限（如果您使用 git 进行管理）</li>
</ul>
<p><strong>保护你的 CA 私钥和其他证书，这些文件非常重要。</strong></p>
<ul>
<li>相关文件默认会在管理节点Pigsty源码目录的 <code>files/pki</code> 内生成。</li>
<li>你应该定期将它们备份到一个安全的地方存储。</li>
</ul>
<br>
<hr>
<h3 id="密码">密码</h3>
<p><strong>在生产环境部署时，必须更改这些密码，不要使用默认值！</strong></p>
<ul>
<li><a href="/zh/docs/reference/param#grafana_admin_password"><code>grafana_admin_password</code></a>   : <code>pigsty</code></li>
<li><a href="/zh/docs/reference/param#pg_admin_password"><code>pg_admin_password</code></a>             : <code>DBUser.DBA</code></li>
<li><a href="/zh/docs/reference/param#pg_monitor_password"><code>pg_monitor_password</code></a>         : <code>DBUser.Monitor</code></li>
<li><a href="/zh/docs/reference/param#pg_replication_password"><code>pg_replication_password</code></a> : <code>DBUser.Replicator</code></li>
<li><a href="/zh/docs/reference/param#patroni_password"><code>patroni_password</code></a>               : <code>Patroni.API</code></li>
<li><a href="/zh/docs/reference/param#haproxy_admin_password"><code>haproxy_admin_password</code></a>   : <code>pigsty</code></li>
<li><a href="/zh/docs/minio/param#minio_access_key"><code>minio_access_key</code></a>                   : <code>minioadmin</code></li>
<li><a href="/zh/docs/minio/param#minio_secret_key"><code>minio_secret_key</code></a>                   : <code>minioadmin</code></li>
</ul>
<p><strong>如果您使用MinIO，请修改MinIO的默认用户密码，与pgbackrest中的引用</strong></p>
<ul>
<li>请修改 MinIO 普通用户的密码：<a href="/zh/docs/minio/param#minio_users"><code>minio_users</code>.<code>[pgbacrest]</code>.<code>secret_key</code></a></li>
<li>请修改 pgbackrest 中对 MinIO 使用的备份用户密码：<a href="/zh/docs/reference/param#pgbackrest_repo"><code>pgbackrest_repo</code>.<code>minio</code>.<code>s3_key_secret</code></a></li>
</ul>
<p><strong>如果您使用远程备份仓库，请务必启用备份加密，并设置加解密密码</strong></p>
<ul>
<li>设置 <a href="/zh/docs/reference/param#pgbackrest_repo"><code>pgbackrest_repo</code>.<code>*</code>.<code>cipher_type</code></a> 为 <code>aes-256-cbc</code></li>
<li>设置密码时可以使用 <code>${pg_cluster}</code> 作为密码的一部分，避免所有集群使用同一个密码</li>
</ul>
<p><strong>为 PostgreSQL 使用安全可靠的密码加密算法</strong></p>
<ul>
<li>使用 <a href="/zh/docs/reference/param#pg_pwd_enc"><code>pg_pwd_enc</code></a> 默认值 <code>scram-sha-256</code> 替代传统的 <code>md5</code></li>
<li>这是默认行为，如果没有特殊理由（出于对历史遗留老旧客户端的支持），请不要将其修改回 <code>md5</code></li>
</ul>
<p><strong>使用 <code>passwordcheck</code> 扩展强制执行强密码</strong>。</p>
<ul>
<li>在 <a href="/zh/docs/reference/param#pg_libs"><code>pg_libs</code></a> 中添加 <code>$lib/passwordcheck</code> 来强制密码策略。</li>
</ul>
<p><strong>使用加密算法加密远程备份</strong></p>
<ul>
<li>在 <a href="/zh/docs/reference/param#pgbackrest_repo"><code>pgbackrest_repo</code></a> 的备份仓库定义中使用 <code>repo_cipher_type</code> 启用加密</li>
</ul>
<p><strong>为业务用户配置密码自动过期实践</strong></p>
<ul>
<li>
<p>你应当为每个<a href="/zh/docs/pgsql/user#%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7">业务用户</a>设置一个密码自动过期时间，以满足合规要求。</p>
</li>
<li>
<p>配置自动过期后，请不要忘记在巡检时定期更新这些密码。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_meta , password: Pleas3-ChangeThisPwd ,expire_in: 7300 ,pgbouncer: true ,roles: [ dbrole_admin ]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_view , password: Make.3ure-Compl1ance  ,expire_in: 7300 ,pgbouncer: true ,roles: [ dbrole_readonly ] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">read-only viewer for meta database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: postgres     ,superuser: true  ,expire_in: 7300                        ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system superuser }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: replicator ,replication: true  ,expire_in: 7300 ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system replicator }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_dba   ,superuser: true  ,expire_in: 7300 ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_monitor ,roles: [pg_monitor] ,expire_in: 7300 ,pgbouncer: true ,parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql monitor user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<p><strong>不要将更改密码的语句记录到 postgres 日志或其他日志中</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SET log_statement TO <span style="color:#4e9a06">&#39;none&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>ALTER USER <span style="color:#4e9a06">&#34;{{ user.name }}&#34;</span> PASSWORD <span style="color:#4e9a06">&#39;{{ user.password }}&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>SET log_statement TO DEFAULT<span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><br>
<hr>
<h3 id="ip地址">IP地址</h3>
<p><strong>为 postgres/pgbouncer/patroni 绑定指定的 IP 地址，而不是所有地址。</strong></p>
<ul>
<li>默认的 <a href="/zh/docs/reference/param#pg_listen"><code>pg_listen</code></a> 地址是 <code>0.0.0.0</code>，即所有 IPv4 地址。</li>
<li>考虑使用 <code>pg_listen: '${ip},${vip},${lo}'</code> 绑定到特定IP地址（列表）以增强安全性。</li>
</ul>
<p><strong>不要将任何端口直接暴露到公网IP上，除了基础设施出口Nginx使用的端口（默认80/443）</strong></p>
<ul>
<li>出于便利考虑，Prometheus/Grafana 等组件默认监听所有IP地址，可以直接从公网IP端口访问</li>
<li>您可以修改它们的配置文件，只监听内网IP地址，限制其只能通过 Nginx 门户通过域名访问，你也可以当使用安全组，防火墙规则来实现这些安全限制。</li>
<li>出于便利考虑，Redis服务器默认监听所有IP地址，您可以修改 <a href="/zh/docs/reference/param#redis_bind_address"><code>redis_bind_address</code></a> 只监听内网IP地址。</li>
</ul>
<p><strong>使用 <a href="/zh/docs/pgsql/hba">HBA</a> 限制 postgres 客户端访问</strong></p>
<ul>
<li>有一个增强安全性的配置模板：<a href="https://github.com/Vonng/pigsty/blob/main/conf/demo/security.yml"><code>security.yml</code></a></li>
</ul>
<p><strong>限制 patroni 管理访问权限：仅 infra/admin 节点可调用控制API</strong></p>
<ul>
<li>默认情况下，这是通过 <a href="https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/oltp.yml#L109"><code>restapi.allowlist</code></a> 限制的。</li>
</ul>
<br>
<hr>
<h3 id="网络流量">网络流量</h3>
<p><strong>使用 SSL 和域名，通过Nginx访问基础设施组件</strong></p>
<ul>
<li>Nginx SSL 由 <a href="/zh/docs/reference/param#nginx_sslmode"><code>nginx_sslmode</code></a> 控制，默认为 <code>enable</code>。</li>
<li>Nginx 域名由 <a href="/zh/docs/reference/param#infra_portal"><code>infra_portal.&lt;component&gt;.domain</code></a> 指定。</li>
</ul>
<p><strong>使用 SSL 保护 Patroni REST API</strong></p>
<ul>
<li><a href="/zh/docs/reference/param#patroni_ssl_enabled"><code>patroni_ssl_enabled</code></a> 默认为禁用。</li>
<li>由于它会影响健康检查和 API 调用。</li>
<li>注意这是一个全局选项，在部署前你必须做出决定。</li>
</ul>
<p><strong>使用 SSL 保护 Pgbouncer 客户端流量</strong></p>
<ul>
<li><a href="/zh/docs/reference/param#pgbouncer_sslmode"><code>pgbouncer_sslmode</code></a> 默认为 <code>disable</code></li>
<li>它会对 Pgbouncer 有显著的性能影响，所以这里是默认关闭的。</li>
</ul>
<hr>
<h2 id="完整性">完整性</h2>
<p><strong>为关键场景下的 PostgreSQL 数据库集群配置一致性优先模式（例如与钱相关的库）</strong></p>
<ul>
<li><a href="/zh/docs/reference/param#pg_conf"><code>pg_conf</code></a> 数据库调优模板，使用 <code>crit.yml</code> 将以一些可用性为代价，换取最佳的数据一致性。</li>
</ul>
<p><strong>使用crit节点调优模板，以获得更好的一致性。</strong></p>
<ul>
<li><a href="/zh/docs/reference/param#node_tune"><code>node_tune</code></a> 主机调优模板使用 <code>crit</code> ，可以以减少脏页比率，降低数据一致性风险。</li>
</ul>
<p><strong>启用数据校验和，以检测静默数据损坏。</strong></p>
<ul>
<li><a href="/zh/docs/reference/param#pg_checksum"><code>pg_checksum</code></a> 默认为 <code>off</code>，但建议开启。</li>
<li>当启用 <a href="/zh/docs/reference/param#pg_conf"><code>pg_conf</code></a> = <code>crit.yml</code> 数据库模板时，校验和是强制开启的。</li>
</ul>
<p><strong>记录建立/切断连接的日志</strong></p>
<ul>
<li>该配置默认关闭，但在 <code>crit.yml</code> 配置模板中是默认启用的。</li>
<li>可以手工<a href="/zh/docs/pgsql/admin#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4">配置集群</a>，启用 <code>log_connections</code> 和 <code>log_disconnections</code> 功能参数。</li>
</ul>
<p><strong>如果您希望彻底杜绝PG集群在故障转移时脑裂的可能性，请启用watchdog</strong></p>
<ul>
<li>如果你的流量走默认推荐的 HAProxy 分发，那么即使你不启用 watchdog，你也不会遇到脑裂的问题。</li>
<li>如果你的机器假死，Patroni 被 <code>kill -9</code> 杀死，那么 watchdog 可以用来兜底：超时自动关机。</li>
<li>最好不要在基础设施节点上启用 watchdog。</li>
</ul>
<hr>
<h2 id="可用性">可用性</h2>
<p><strong>对于关键场景的PostgreSQL数据库集群，请使用足够的节点/实例数量</strong></p>
<ul>
<li>你至少需要三个节点（能够容忍一个节点的故障）来实现生产级的高可用性。</li>
<li>如果你只有两个节点，你可以容忍特定备用节点的故障。</li>
<li>如果你只有一个节点，请使用外部的 S3/MinIO 进行冷备份和 WAL 归档存储。</li>
</ul>
<p><strong>对于 PostgreSQL，在可用性和一致性之间进行权衡</strong></p>
<ul>
<li><a href="/zh/docs/reference/param#pg_rpo"><code>pg_rpo</code></a> : <strong>可用性与一致性之间的权衡</strong></li>
<li><a href="/zh/docs/reference/param#pg_rto"><code>pg_rto</code></a> : <strong>故障概率与影响之间的权衡</strong></li>
</ul>
<p><strong>不要直接通过固定的 IP 地址访问数据库；请使用 VIP、DNS、HAProxy 或它们的排列组合</strong></p>
<ul>
<li>使用 HAProxy 进行服务<a href="/zh/docs/pgsql/svc#%E6%8E%A5%E5%85%A5%E6%9C%8D%E5%8A%A1">接入</a></li>
<li>在故障切换/主备切换的情况下，Haproxy 将处理客户端的流量切换。</li>
</ul>
<p><strong>在重要的生产部署中使用多个基础设施节点（例如，1~3）</strong></p>
<ul>
<li>小规模部署或要求宽松的场景，可以使用单一基础设施节点 / 管理节点。</li>
<li>大型生产部署建议设置至少两个基础设施节点互为备份。</li>
</ul>
<p><strong>使用足够数量的 etcd 服务器实例，并使用奇数个实例（1,3,5,7）</strong></p>
<ul>
<li>查看 <a href="/zh/docs/etcd#%E7%AE%A1%E7%90%86">ETCD 管理</a> 了解详细信息。</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-262f396efed9aff5d120f3d92b472bdf">9 - 常见问题</h1>
    <div class="lead">Pigsty 下载，安装，部署常见问题答疑</div>
	<blockquote>
<p>这里列出了Pigsty用户在下载、安装、部署时常遇到的问题，如果您遇到了难以解决的问题，可以提交 <a href="https://github.com/Vonng/pigsty/issues/new">Issue</a> 或者<a href="/zh/docs/about/community">联系我们</a>。</p>
</blockquote>
<hr>
<h2 id="如何获取pigsty软件源码包">如何获取Pigsty软件源码包？</h2>
<p>使用以下命令一键安装 Pigsty： <code>curl -fsSL https://repo.pigsty.cc/get | bash</code></p>
<p>上述命令会自动下载最新的稳定版本 <code>pigsty.tgz</code> 并解压到 <code>~/pigsty</code> 目录。您也可以从以下位置手动下载 Pigsty 源代码的特定版本。</p>
<p>如果您需要在没有互联网的环境中安装，可以提前在有网络的环境中下载好，并通过 scp/sftp 或者 CDROM/USB 传输至生产服务器。</p>
<hr>
<h2 id="如何加速从上游仓库下载-rpm-">如何加速从上游仓库下载 RPM ?</h2>
<p>考虑使用本地仓库镜像，仓库镜像在<a href="/zh/docs/reference/param#repo_upstream"><code>repo_upstream</code></a> 参数中配置，你可以选择 <a href="/zh/docs/reference/param#region"><code>region</code></a> 来使用不同镜像站。</p>
<p>例如，您可以设置 <code>region</code> = <code>china</code>，这样将使用 <code>baseurl</code> 中键为 <code>china</code> 的 URL 而不是 <code>default</code>。</p>
<p>如果防火墙或GFW屏蔽了某些仓库，考虑使用<a href="/zh/docs/reference/param#proxy_env"><code>proxy_env</code></a> 来绕过。</p>
<hr>
<h2 id="安装失败应该如何解决">安装失败应该如何解决？</h2>
<p>Pigsty 不依赖 Docker，所以期待的环境是一个全新安装操作系统后的状态，如果您使用已经跑了千奇百怪服务的系统，更容易遇到疑难杂症，我们建议不要这么做。
出现安装失败时，可以按照以下思路进行排查：</p>
<ol>
<li>您应当确认当前失败的位置在哪个模块，不同模块失败有不同的原因。您应当保留 Ansible 剧本输出结果备用，并找到所有标红的 Failed 任务。</li>
<li>如果出现无法识别配置，剧本直接无法开始，请检查您的配置文件是否是合法的 YAML，缩进，括号等是否有问题。</li>
<li>如果错误与本地软件源，Nginx 有关，请检查你的系统是不是全新系统，是否已经运行了 Nginx 或其他组件？或者是否有特殊的防火墙与安全策略在运作？</li>
<li>如果是安装节点软件包时出现错误，您是否使用了OS小版本精确匹配的离线软件包？上游是否出现依赖错漏？请参考下面的内容解决</li>
<li>如果是系统配置出现错误，您的操作系统是否是全新安装的状态？或者 —— 精简安装到了 Locale 都没有配置的状态？</li>
<li>如果是 MinIO 出现问题，您是否使用了 SNMD，MNMD 部署却没有提供真实的磁盘挂载点？您的 <code>sss.pigsty</code> 静态域名是否指向了任意 MinIO 节点或 LB 集群？</li>
<li>如果是 PGSQL 安装出现了问题，您在 pg_extension 中指定安装的扩展，是否还没有添加到 repo_packages 中，或者还没有被覆盖？</li>
<li>如果是 PGSQL 启动出现了问题，例如 wait for patroni primary，请参考 <a href="/zh/docs/pgsql/faq">PGSQL FAQ</a> 解决。</li>
</ol>
<hr>
<h2 id="软件包安装失败如何解决">软件包安装失败如何解决？</h2>
<p>请注意，Pigsty 的预制 <a href="/zh/docs/setup/offline#%E7%A6%BB%E7%BA%BF%E8%BD%AF%E4%BB%B6%E5%8C%85"><strong>离线软件包</strong></a> 是针对 <a href="/zh/docs/reference/compatibility/#vagrant-%E9%95%9C%E5%83%8F%E5%8F%82%E8%80%83"><strong>特定操作系统发行版小版本</strong></a> 打包的，
因此如果您使用的操作系统版本没有精确对齐，我们不建议使用离线软件安装包，而是直接从上游下载符合当前操作系统实际情况的软件包版本。</p>
<p>如果在线安装无法解决包冲突问题，您首先可以尝试修改 Pigsty 使用的上游软件源。例如在 EL 系操作系统中， Pigsty 默认的上游软件源中使用 <code>$releasever</code> 这样的大版本占位符，它将被解析为具体的 7，8，9 大版本号，但是许多操作系统发行版都提供了 Vault，允许您使用特定某一个版本的软件包镜像。
因此，您可以将 <code>repo_upstream</code> 参数中的 BaseURL 前段替换为具体的 Vault 小版本仓库，例如：</p>
<ul>
<li><code>https://mirrors.aliyun.com/rockylinux/$releasever/</code> （原始 BaseURL 前缀，不带 <code>vault</code> ）</li>
<li><code>https://mirrors.tuna.tsinghua.edu.cn/centos-vault/7.6.1810/</code> （使用 7.6 而不是默认的 7.9）</li>
<li><code>https://mirrors.aliyun.com/rockylinux-vault/8.6/</code> （使用 8.6 而不是默认的 8.9）</li>
<li><code>https://mirrors.aliyun.com/rockylinux-vault/9.2/</code> （使用 9.2 而不是默认的 9.3）</li>
</ul>
<p>在替换前请注意目标软件源的路径是否真实存在，例如 EPEL 不提供小版本特定的软件源。支持这种方式的上游源包括：<code>base</code>, <code>updates</code>, <code>extras</code>, <code>centos-sclo</code>, <code>centos-sclo-rh</code>, <code>baseos</code>, <code>appstream</code>, <code>extras</code>, <code>crb</code>, <code>powertools</code>, <code>pgdg-common</code>, <code>pgdg1*</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">repo_upstream</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pigsty-local   ,description: &#39;Pigsty Local&#39;      ,module: local ,releases: [7,8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;http://${admin_ip}/pigsty&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}}<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># used by intranet nodes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pigsty-infra   ,description: &#39;Pigsty INFRA&#39;      ,module: infra ,releases: [7,8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://repo.pigsty.io/rpm/infra/$basearch&#39; ,china</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://repo.pigsty.cc/rpm/infra/$basearch&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pigsty-pgsql   ,description: &#39;Pigsty PGSQL&#39;      ,module: pgsql ,releases: [7,8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://repo.pigsty.io/rpm/pgsql/el$releasever.$basearch&#39; ,china</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://repo.pigsty.cc/rpm/pgsql/el$releasever.$basearch&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: nginx          ,description: &#39;Nginx Repo&#39;        ,module: infra ,releases: [7,8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://nginx.org/packages/centos/$releasever/$basearch/&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: docker-ce      ,description: &#39;Docker CE&#39;         ,module: infra ,releases: [7,8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://download.docker.com/linux/centos/$releasever/$basearch/stable&#39;        ,china: &#39;https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/$basearch/stable&#39;  ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/docker-ce/linux/centos/$releasever/$basearch/stable&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: base           ,description: &#39;EL 7 Base&#39;         ,module: node  ,releases: [7    ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;http://mirror.centos.org/centos/$releasever/os/$basearch/&#39;                    ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/centos/$releasever/os/$basearch/&#39;           ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/centos/$releasever/os/$basearch/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">           </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: updates        ,description: &#39;EL 7 Updates&#39;      ,module: node  ,releases: [7    ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;http://mirror.centos.org/centos/$releasever/updates/$basearch/&#39;               ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/centos/$releasever/updates/$basearch/&#39;      ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/centos/$releasever/updates/$basearch/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">      </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: extras         ,description: &#39;EL 7 Extras&#39;       ,module: node  ,releases: [7    ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;http://mirror.centos.org/centos/$releasever/extras/$basearch/&#39;                ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/centos/$releasever/extras/$basearch/&#39;       ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/centos/$releasever/extras/$basearch/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">       </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: epel           ,description: &#39;EL 7 EPEL&#39;         ,module: node  ,releases: [7    ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;http://download.fedoraproject.org/pub/epel/$releasever/$basearch/&#39;            ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/epel/$releasever/$basearch/&#39;                ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/epel/$releasever/$basearch/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">                </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: centos-sclo    ,description: &#39;EL 7 SCLo&#39;         ,module: node  ,releases: [7    ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;http://mirror.centos.org/centos/$releasever/sclo/$basearch/sclo/&#39;             ,china: &#39;https://mirrors.aliyun.com/centos/$releasever/sclo/$basearch/sclo/&#39;              ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/centos/$releasever/sclo/$basearch/sclo/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: centos-sclo-rh ,description: &#39;EL 7 SCLo rh&#39;      ,module: node  ,releases: [7    ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;http://mirror.centos.org/centos/$releasever/sclo/$basearch/rh/&#39;               ,china: &#39;https://mirrors.aliyun.com/centos/$releasever/sclo/$basearch/rh/&#39;                ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/centos/$releasever/sclo/$basearch/rh/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">      </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: baseos         ,description: &#39;EL 8+ BaseOS&#39;      ,module: node  ,releases: [  8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://dl.rockylinux.org/pub/rocky/$releasever/BaseOS/$basearch/os/&#39;         ,china: &#39;https://mirrors.aliyun.com/rockylinux/$releasever/BaseOS/$basearch/os/&#39;          ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/rocky/$releasever/BaseOS/$basearch/os/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">     </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: appstream      ,description: &#39;EL 8+ AppStream&#39;   ,module: node  ,releases: [  8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://dl.rockylinux.org/pub/rocky/$releasever/AppStream/$basearch/os/&#39;      ,china: &#39;https://mirrors.aliyun.com/rockylinux/$releasever/AppStream/$basearch/os/&#39;       ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/rocky/$releasever/AppStream/$basearch/os/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: extras         ,description: &#39;EL 8+ Extras&#39;      ,module: node  ,releases: [  8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://dl.rockylinux.org/pub/rocky/$releasever/extras/$basearch/os/&#39;         ,china: &#39;https://mirrors.aliyun.com/rockylinux/$releasever/extras/$basearch/os/&#39;          ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/rocky/$releasever/extras/$basearch/os/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">     </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: crb            ,description: &#39;EL 9 CRB&#39;          ,module: node  ,releases: [    9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://dl.rockylinux.org/pub/rocky/$releasever/CRB/$basearch/os/&#39;            ,china: &#39;https://mirrors.aliyun.com/rockylinux/$releasever/CRB/$basearch/os/&#39;             ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/rocky/$releasever/CRB/$basearch/os/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">        </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: powertools     ,description: &#39;EL 8 PowerTools&#39;   ,module: node  ,releases: [  8  ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://dl.rockylinux.org/pub/rocky/$releasever/PowerTools/$basearch/os/&#39;     ,china: &#39;https://mirrors.aliyun.com/rockylinux/$releasever/PowerTools/$basearch/os/&#39;      ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/rocky/$releasever/PowerTools/$basearch/os/&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: epel           ,description: &#39;EL 8+ EPEL&#39;        ,module: node  ,releases: [  8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;http://download.fedoraproject.org/pub/epel/$releasever/Everything/$basearch/&#39; ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/epel/$releasever/Everything/$basearch/&#39;     ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/epel/$releasever/Everything/$basearch/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">     </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pgdg-common    ,description: &#39;PostgreSQL Common&#39; ,module: pgsql ,releases: [7,8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://download.postgresql.org/pub/repos/yum/common/redhat/rhel-$releasever-$basearch&#39; ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/common/redhat/rhel-$releasever-$basearch&#39; , europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/postgresql/repos/yum/common/redhat/rhel-$releasever-$basearch&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pgdg-extras    ,description: &#39;PostgreSQL Extra&#39;  ,module: pgsql ,releases: [7,8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://download.postgresql.org/pub/repos/yum/common/pgdg-rhel$releasever-extras/redhat/rhel-$releasever-$basearch&#39; ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/common/pgdg-rhel$releasever-extras/redhat/rhel-$releasever-$basearch&#39; , europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/postgresql/repos/yum/common/pgdg-rhel$releasever-extras/redhat/rhel-$releasever-$basearch&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pgdg-el8fix    ,description: &#39;PostgreSQL EL8FIX&#39; ,module: pgsql ,releases: [  8  ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://download.postgresql.org/pub/repos/yum/common/pgdg-centos8-sysupdates/redhat/rhel-8-x86_64/&#39; ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/common/pgdg-centos8-sysupdates/redhat/rhel-8-x86_64/&#39; , europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/postgresql/repos/yum/common/pgdg-centos8-sysupdates/redhat/rhel-8-x86_64/&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pgdg-el9fix    ,description: &#39;PostgreSQL EL9FIX&#39; ,module: pgsql ,releases: [    9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://download.postgresql.org/pub/repos/yum/common/pgdg-rocky9-sysupdates/redhat/rhel-9-x86_64/&#39;  ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/common/pgdg-rocky9-sysupdates/redhat/rhel-9-x86_64/&#39; , europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/postgresql/repos/yum/common/pgdg-rocky9-sysupdates/redhat/rhel-9-x86_64/&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pgdg15         ,description: &#39;PostgreSQL 15&#39;     ,module: pgsql ,releases: [7    ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://download.postgresql.org/pub/repos/yum/15/redhat/rhel-$releasever-$basearch&#39; ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/15/redhat/rhel-$releasever-$basearch&#39; ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/postgresql/repos/yum/15/redhat/rhel-$releasever-$basearch&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pgdg16         ,description: &#39;PostgreSQL 16&#39;     ,module: pgsql ,releases: [  8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://download.postgresql.org/pub/repos/yum/16/redhat/rhel-$releasever-$basearch&#39; ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/16/redhat/rhel-$releasever-$basearch&#39; ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/postgresql/repos/yum/16/redhat/rhel-$releasever-$basearch&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: timescaledb    ,description: &#39;TimescaleDB&#39;       ,module: pgsql ,releases: [7,8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://packagecloud.io/timescale/timescaledb/el/$releasever/$basearch&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在 Pigsty 配置文件中显式定义并覆盖 <code>repo_upstream</code> 后，（可清除 <code>/www/pigsty/repo_complete</code> 标记后）再次尝试安装。如果上游软件源与镜像源的软件没有解决问题，你可以考虑将上面的源替换为操作系统自带的软件源，再次尝试从上游直接安装。</p>
<p>最后如果以上手段都没有解决问题，你可以考虑移除 <code>node_packages</code>， <code>infra_packages</code>， <code>pg_packages</code>，<code>pg_extensions</code> 中出现冲突的软件包。或者移除、升级现有系统上的冲突软件包。</p>
<hr>
<h2 id="准备--bootstrap-过程是干什么的">准备 / bootstrap 过程是干什么的？</h2>
<p>检测环境是否就绪、用各种手段确保后续安装所必需的工具 <code>ansible</code> 被正确安装。</p>
<p>当你下载 Pigsty 源码后，可以进入目录并执行 <a href="/zh/docs/setup/install#%E5%87%86%E5%A4%87"><code>bootstrap</code></a> 脚本。它会检测你的节点环境，如果没有发现离线软件包，它会询问你要不要从互联网下载。</p>
<p>你可以选择 “是”（<code>y</code>），直接使用离线软件包安装又快又稳定。你也可以选“否” (<code>n</code>) 跳过，在安装时直接从互联网上游下载最新的软件包，这样会极大减少出现 RPM/DEB 包冲突的概率。</p>
<p>如果使用了离线软件包，bootstrap 会直接从离线软件包中安装 ansible，否则会从上游下载 ansible 并安装，如果你没有互联网访问，又没有 DVD，或者内网软件源，那就只能用离线软件包来安装了。</p>
<hr>
<h2 id="配置--configure-过程是干什么的">配置 / configure 过程是干什么的？</h2>
<p>配置 / <a href="/zh/docs/setup/install#%E9%85%8D%E7%BD%AE"><strong>configure</strong></a> 过程会检测你的节点环境并为你生成一个 pigsty 配置文件：<code>pigsty.yml</code>，默认根据你的操作系统（EL 7/8/9）选用相应的单机安装模板。</p>
<p>所有默认的配置模板都在 <code>files/pigsty</code>中，你可以使用 <code>-c</code> 直接指定想要使用的配置模板。如果您已经知道如何配置 Pigsty 了，那么完全可以跳过这一步，直接编辑 Pigsty 配置文件。</p>
<hr>
<h2 id="pigsty配置文件是干什么的">Pigsty配置文件是干什么的？</h2>
<p>Pigsty主目录下的 <code>pigsty.yml</code> 是默认的配置文件，可以用来描述整套部署的环境，在 <a href="https://github.com/Vonng/pigsty/tree/main/conf"><code>conf/</code></a> 目录中有许多配置示例供你参考。在 <a href="/zh/docs/conf">文档站：配置模板</a> 中相关说明。</p>
<p>当执行剧本时，你可以使用 <code>-i &lt;path&gt;</code> 参数，选用其他位置的配置文件。例如，你想根据另一个专门的配置文件 <code>redis.yml</code> 来安装 redis，可以这样做：<code>./redis.yml -i files/pigsty/redis.yml</code></p>
<hr>
<h2 id="如何使用-cmdb-作为配置清单">如何使用 CMDB 作为配置清单？</h2>
<p>Ansible 默认使用的配置清单在 <a href="https://github.com/Vonng/pigsty/blob/main/ansible.cfg"><code>ansible.cfg</code></a> 中指定为：<code>inventory = pigsty.yml</code></p>
<p>你可以使用 <a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_cmdb"><code>bin/inventory_cmdb</code></a> 切换到动态的 CMDB 清单，
使用 <a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_conf"><code>bin/inventory_conf</code></a> 返回到本地配置文件。
你还需要使用 <a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_load"><code>bin/inventory_load</code></a> 将当前的配置文件清单加载到 CMDB。</p>
<p>如果使用 CMDB，你必须从数据库而不是配置文件中编辑清单配置，这种方式适合将 Pigsty 与外部系统相集成。</p>
<hr>
<h2 id="配置文件中的ip地址占位符是干什么的">配置文件中的IP地址占位符是干什么的？</h2>
<p>Pigsty 使用 <code>10.10.10.10</code> 作为当前节点 IP 的占位符，配置过程中会用当前节点的主 IP 地址替换它。</p>
<p>当 <code>configure</code> 检测到当前节点有多个 NIC 带有多个 IP 时，配置向导会提示使用哪个<strong>主要</strong> IP，即 <strong>用户用于从内部网络访问节点的 IP</strong>，此 IP 将用于在配置文件模板中替换占位符 <code>10.10.10.10</code>。</p>
<p>请注意，您应当使用静态 IP 地址，而不是 DHCP 分配的动态 IP 地址，因为 Pigsty 使用静态 IPv4 地址唯一标识节点。</p>
<p>请注意：不要使用公共 IP 作为主 IP，因为 Pigsty 会使用主 IP 来配置内部服务，例如 Nginx，Prometheus，Grafana，Loki，AlertManager，Chronyd，DNSMasq 等，除了 Nginx 之外的服务不应该对外界暴露端口。</p>
<hr>
<h2 id="我没有静态ip可以安装pigsty吗">我没有静态IP，可以安装Pigsty吗？</h2>
<p>如果您的服务器没有静态IP，在 <strong>单机部署</strong> 的情况下，可以使用本地环回地址 <code>127.0.0.1</code> 作为这个唯一节点的 IP 地址标识。</p>
<hr>
<h2 id="配置文件中的哪些参数需要用户特殊关注">配置文件中的哪些参数需要用户特殊关注？</h2>
<p>Pigsty 提供了 280+ 配置参数，可以对整个环境与各个模块 infra / node / etcd / minio / pgsql 进行细致入微的定制。</p>
<p>通常在单节点安装中，你不需要对默认生成的配置文件进行任何调整。但如果需要，可以关注以下这些参数：</p>
<ul>
<li>当访问 web 服务组件时，域名由 <a href="/zh/docs/reference/param#infra_portal"><code>infra_portal</code></a> 指定，有些服务只能通过 Nginx 代理使用域名访问。</li>
<li>Pigsty 假定存在一个 <code>/data</code> 目录用于存放所有数据；如果数据磁盘的挂载点与此不同，你可以使用 <a href="/zh/docs/reference/param#node_data"><code>node_data</code></a> 调整这些路径。</li>
<li>进行生产部署时，不要忘记在配置文件中更改<strong>密码</strong>，更多细节请参考 <a href="/zh/docs/setup/security">安全考量</a>。</li>
</ul>
<hr>
<h2 id="在默认单机安装时到底都安装了什么东西">在默认单机安装时，到底都安装了什么东西？</h2>
<p>当您执行 <code>make install</code> 时，实际上是调用 Ansible 剧本 <a href="https://github.com/Vonng/pigsty/blob/main/install.yml"><code>install.yml</code></a>，根据配置文件中的参数，安装以下内容：</p>
<ul>
<li><a href="/zh/docs/infra"><code>INFRA</code></a> 模块：提供本地软件源，Nginx Web接入点，DNS服务器，NTP服务器，Prometheus与Grafana可观测性技术栈。</li>
<li><a href="/zh/docs/node"><code>NODE</code></a>  模块，将当前节点纳入 Pigsty 管理，部署 HAProxy 与 监控。</li>
<li><a href="/zh/docs/etcd"><code>ETCD</code></a>  模块，部署一个单机 etcd 集群，作为 PG 高可用的 DCS</li>
<li><a href="/zh/docs/minio"><code>MINIO</code></a> 模块如果定义，则会安装，它可以作为 PG 的可选备份仓库。</li>
<li><a href="/zh/docs/pgsql"><code>PGSQL</code></a> 模块，一个单机 PostgreSQL 数据库实例。</li>
</ul>
<hr>
<h2 id="安装遇到软件包冲突怎么办">安装遇到软件包冲突怎么办？</h2>
<p>在安装 node / infra / pgsql 软件包期间，可能有微小的几率出现软件包依赖错漏冲突。这里有几种常见原因：</p>
<ol>
<li>上游软件源发布了不匹配的软件包版本或缺失了依赖，您可能要等待上游修复此问题，时间以周计。事先在依赖完备时制作的离线安装包可以预防这个问题。</li>
<li>您制作离线安装包操作系统小版本与当前操作系统的小版本不匹配，您可以使用在线安装，或重新使用相同系统下制作的离线软件包的方式解决此问题</li>
<li>个别不重要，非必选的软件包，可以直接将其从安装列表，或本地软件源中剔除的方式快速绕过。</li>
</ol>
<hr>
<h2 id="如何重建本地软件仓库">如何重建本地软件仓库？</h2>
<p>我想要从上游仓库重新下载软件包，但是执行 <code>./infra.yml</code> 和 <code>repo</code> 子任务都跳过下载了，怎么办？</p>
<p>您可以使用以下快捷命令和剧本任务，强制重建本地软件源。 Pigsty 会重新检查上游仓库并下载软件包。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make repo-build      <span style="color:#8f5902;font-style:italic"># ./infra.yml -t repo_build  </span>
</span></span></code></pre></div><hr>
<h2 id="如何在安装后下载最新版本的软件包">如何在安装后下载最新版本的软件包？</h2>
<p>如果您想要下载最新的软件包版本（RPM/DEB），你可以选择在 <code>/www/pigsty</code> 中手工使用 <code>apt/dnf</code> 下载特定版本的软件包。
在这种情况下，您可以使用以下命令，只更新本地软件仓库的元数据库，而不是整个重建：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./infra.yml -t repo_create
</span></span></code></pre></div><p>或者移除 <code>/www/pigsty</code> 中的旧版本软件包后重新执行仓库重建命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make repo-build      <span style="color:#8f5902;font-style:italic"># ./infra.yml -t repo_build  </span>
</span></span></code></pre></div><hr>
<h2 id="如何使用-vagrant-创建本地虚拟机">如何使用 Vagrant 创建本地虚拟机？</h2>
<p>当你第一次使用 Vagrant 启动某个特定的操作系统仓库时，它会下载相应的 Box/Img 镜像文件，Pigsty 沙箱默认使用 <code>generic/rocky9</code> 镜像。</p>
<p>使用代理可能会增加下载速度。Box/Image 只需下载一次，在重建沙箱时会被重复使用。</p>
<hr>
<h2 id="阿里云上-centos-79-特有的-rpm-冲突问题">阿里云上 CentOS 7.9 特有的 RPM 冲突问题</h2>
<p>阿里云的 CentOS 7.9 额外安装的 <code>nscd</code> 可能会导致 RPM 冲突问题：<code>&quot;Error: Package: nscd-2.17-307.el7.1.x86_64 (@base)&quot;</code></p>
<p>遇见安装失败，RPM冲突报错不要慌，这是一个DNS缓存工具，把这个包卸载了就可以了：<code>sudo yum remove nscd</code>，或者使用 ansible 命令批量删除所有节点上的 <code>nscd</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible all -b -a <span style="color:#4e9a06">&#39;yum remove -y nscd&#39;</span>
</span></span></code></pre></div><hr>
<h2 id="腾讯云上-rocky-9x-特有的-rpm-冲突问题">腾讯云上 Rocky 9.x 特有的 RPM 冲突问题</h2>
<p>腾讯云的 Rocky 9.x 需要额外的 <code>annobin</code> 软件包才可以正常完成 Pigsty 安装。</p>
<p>遇见安装失败，RPM冲突报错不要慌，进入 <code>/www/pigsty</code> 把这几个包手动下载下来就好了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./infra.yml -t repo_upstream      <span style="color:#8f5902;font-style:italic"># add upstream repos</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> /www/pigsty<span style="color:#000;font-weight:bold">;</span>                   <span style="color:#8f5902;font-style:italic"># download missing packages</span>
</span></span><span style="display:flex;"><span>repotrack annobin gcc-plugin-annobin libuser
</span></span><span style="display:flex;"><span>./infra.yml -t repo_create        <span style="color:#8f5902;font-style:italic"># create repo</span>
</span></span></code></pre></div><hr>
<h2 id="ansible命令超时timeout-waiting-for-xxx">Ansible命令超时（Timeout waiting for xxx）</h2>
<p>Ansible 命令的默认 ssh 超时时间是10秒。由于网络延迟或其他原因，某些命令可能需要超过这个时间。</p>
<p>你可以在 ansible 配置文件 <a href="https://github.com/Vonng/pigsty/blob/main/ansible.cfg"><code>ansible.cfg</code></a> 中增加超时参数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[defaults]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">timeout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">10 # 将其修改为 60，120 或更高。</span>
</span></span></code></pre></div><p>如果你的SSH连接非常慢，通常会是 DNS的问题，请检查sshd配置确保 <code>UseDNS no</code>。</p>
<br>
<hr>
<br>
</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Mail" aria-label="Mail">
    <a target="_blank" rel="noopener" href="mailto:rh@vonng.com" aria-label="Mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Vonng/pigsty" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://twitter.com/GobeUncleWang" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="WeChat" aria-label="WeChat">
    <a target="_blank" rel="noopener" href="/img/pigsty/pigsty-cc.jpg" aria-label="WeChat">
      <i class="fa fa-comment"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Discord" aria-label="Discord">
    <a target="_blank" rel="noopener" href="https://discord.gg/wDzt5VyWEz" aria-label="Discord">
      <i class="fab fa-discord"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Telegram" aria-label="Telegram">
    <a target="_blank" rel="noopener" href="https://t.me/joinchat/gV9zfZraNPM3YjFh" aria-label="Telegram">
      <i class="fab fa-telegram"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2018&ndash;2024
    <span class="td-footer__authors">Ruohang Feng</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span></span><span class="ms-2"><a href="https://vonng.com/en/" target="_blank" rel="noopener">@Vonng</a></span>
<br><span>Pigsty® distributed under <a href="/docs/about/license" target="_blank" rel="noopener">AGPLv3</a></span>
<br><span class="ms-2"><a href="/docs/about/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
<span><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">浙ICP备15016890号</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.248655eb216150e39da254c2f7aa5357805d0ec66bdb741b591cd35fb5f629ab.js" integrity="sha256-JIZV6yFhUOOdolTC96pTV4BdDsZr23QbWRzTX7X2Kas=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
