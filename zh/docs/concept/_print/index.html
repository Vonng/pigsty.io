<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="/zh/docs/concept/">
<link rel="alternate" type="application/rss&#43;xml" href="/zh/docs/concept/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>核心概念 | Pigsty</title>
<meta name="description" content="了解 Pigsty 的重要概念：整体架构、逻辑模型，基础设施，以及数据库 HA，PITR，服务接入的原理。">
<meta property="og:title" content="核心概念" />
<meta property="og:description" content="了解 Pigsty 的重要概念：整体架构、逻辑模型，基础设施，以及数据库 HA，PITR，服务接入的原理。" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/zh/docs/concept/" />

<meta itemprop="name" content="核心概念">
<meta itemprop="description" content="了解 Pigsty 的重要概念：整体架构、逻辑模型，基础设施，以及数据库 HA，PITR，服务接入的原理。"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="核心概念"/>
<meta name="twitter:description" content="了解 Pigsty 的重要概念：整体架构、逻辑模型，基础设施，以及数据库 HA，PITR，服务接入的原理。"/>




<link rel="preload" href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" as="style">
<link href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="/js/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LG1V9WTKGE');
}
</script>
  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/zh/"><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class="navbar-brand__name">Pigsty</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/zh/docs/"><i class='fa-solid fa-book'></i><span>文档</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/zh/blog/"><i class="fas fa-blog"></i><span>博客</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/Vonng/pigsty/" target="_blank" rel="noopener"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-language"></i>中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/docs/concept/">English</a></li>
    </ul>
</div>
</li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.1f38004aae20e61f1d5ee05069eb6070.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/zh/docs/concept/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">核心概念</h1>
<div class="lead">了解 Pigsty 的重要概念：整体架构、逻辑模型，基础设施，以及数据库 HA，PITR，服务接入的原理。</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-6a8affb0541c18d4e9d29f408d0d1e80">系统架构</a></li>


    
  
    
    
	
<li>2: <a href="#pg-b6e18358c874d9d65209973819faed9a">集群模型</a></li>


    
  
    
    
	
<li>3: <a href="#pg-640213fc983ef0aae5180ea5bbbfb2d3">监控系统</a></li>


    
  
    
    
	
<li>4: <a href="#pg-a2af4580848e7a62549ec377b62ac71e">本地 CA</a></li>


    
  
    
    
	
<li>5: <a href="#pg-e4bef574b3856f296b026321cf35f1f9">基础设施即代码</a></li>


    
  
    
    
	
<li>6: <a href="#pg-316ebbf072075b20f0f8bf290998d747">数据库高可用</a></li>


    
  
    
    
	
<li>7: <a href="#pg-397dc822a55434d21cd8ee3a6f846291">时间点恢复</a></li>


    
  
    
    
	
<li>8: <a href="#pg-76a748b4626218b8ec1cb5db2047eae1">服务接入</a></li>


    
  
    
    
	
<li>9: <a href="#pg-5c7e49f373a8b6df52fbd9bec4787528">访问控制</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-6a8affb0541c18d4e9d29f408d0d1e80">1 - 系统架构</h1>
    <div class="lead">Pigsty的模块化架构：用声明的方式来组合模块</div>
	<p>Pigsty 使用 <strong>模块化架构</strong> 与 <strong>声明式接口</strong>。</p>
<ul>
<li>Pigsty 使用<a href="/zh/docs/setup/config">配置清单</a>描述整套部署环境，并通过 ansible <a href="/zh/docs/setup/playbook">剧本</a>实现。</li>
<li>Pigsty 在可以在任意节点上运行，无论是物理裸机还是虚拟机，只要操作系统<a href="/zh/docs/setup/install#%E8%A6%81%E6%B1%82">兼容</a>即可。</li>
<li>Pigsty 的行为由配置参数控制，具有幂等性的剧本 会将节点调整到配置所描述的状态。</li>
<li>Pigsty 采用模块化设计，可自由组合以适应不同场景。使用剧本将模块安装到配置指定的节点上。</li>
</ul>
<hr>
<h2 id="模块">模块</h2>
<p>Pigsty 采用模块化设计，有六个主要的默认模块：<a href="/zh/docs/pgsql"><code>PGSQL</code></a>、<a href="/zh/docs/infra"><code>INFRA</code></a>、<a href="/zh/docs/node"><code>NODE</code></a>、<a href="/zh/docs/etcd"><code>ETCD</code></a>、<a href="/zh/docs/redis"><code>REDIS</code></a> 和 <a href="/zh/docs/minio"><code>MINIO</code></a>。</p>
<ul>
<li><a href="/zh/docs/pgsql"><code>PGSQL</code></a>：由 Patroni、Pgbouncer、HAproxy、PgBackrest 等驱动的自治高可用 Postgres 集群。</li>
<li><a href="/zh/docs/infra"><code>INFRA</code></a>：本地软件仓库、Prometheus、Grafana、Loki、AlertManager、PushGateway、Blackbox Exporter&hellip;</li>
<li><a href="/zh/docs/node"><code>NODE</code></a>：调整节点到所需状态、名称、时区、NTP、ssh、sudo、haproxy、docker、promtail、keepalived</li>
<li><a href="/zh/docs/etcd"><code>ETCD</code></a>：分布式键值存储，用作高可用 Postgres 集群的 DCS：共识选主/配置管理/服务发现。</li>
<li><a href="/zh/docs/redis"><code>REDIS</code></a>：Redis 服务器，支持独立主从、哨兵、集群模式，并带有完整的监控支持。</li>
<li><a href="/zh/docs/minio"><code>MINIO</code></a>：与 S3 兼容的简单对象存储服务器，可作为 PG数据库备份的可选目的地。</li>
</ul>
<p>你可以声明式地自由组合它们。如果你想要主机监控，在基础设施节点上安装<a href="/zh/docs/infra"><code>INFRA</code></a>模块，并在纳管节点上安装 <a href="/zh/docs/node"><code>NODE</code></a> 模块就足够了。
<a href="/zh/docs/etcd"><code>ETCD</code></a> 和 <a href="/zh/docs/pgsql"><code>PGSQL</code></a> 模块用于搭建高可用 PG 集群，将模块安装在多个节点上，可以自动形成一个高可用的数据库集群。
您可以复用 Pigsty 基础架构并开发您自己的模块，<a href="/zh/docs/redis"><code>REDIS</code></a> 和 <a href="/zh/docs/minio"><code>MINIO</code></a> 可以作为一个样例。后续还会有更多的模块加入，例如对 Mongo 与 MySQL 的初步支持已经提上了日程。</p>
<p>请注意，所有模块都强依赖 <code>NODE</code> 模块：在 Pigsty 中节点必须先安装 <code>NODE</code> 模块，被 Pigsty 纳管后方可部署其他模块。
当节点（默认）使用本地软件源进行安装时，<code>NODE</code> 模块对 <code>INFRA</code> 模块有弱依赖。因此安装 <code>INFRA</code> 模块的管理节点/基础设施节点会在 [<code>install.yml</code>] 剧本中完成 Bootstrap 过程，解决循环依赖。</p>
<p><a href="/zh/docs/setup/provision"><img alt="pigsty-sandbox.jpg" src="/img/pigsty/sandbox.jpg"></a></p>
<hr>
<h2 id="单机安装">单机安装</h2>
<p>默认情况下，Pigsty 将在单个 <strong>节点</strong> (物理机/虚拟机) 上安装。<a href="https://github.com/Vonng/pigsty/blob/main/install.yml"><code>install.yml</code></a> 剧本将在<strong>当前</strong>节点上安装 <a href="/zh/docs/infra"><code>INFRA</code></a>、<a href="/zh/docs/etcd"><code>ETCD</code></a>、<a href="/zh/docs/pgsql"><code>PGSQL</code></a> 和可选的 <a href="/zh/docs/minio"><code>MINIO</code></a> 模块，
这将为你提供一个功能完备的可观测性技术栈全家桶 (Prometheus、Grafana、Loki、AlertManager、PushGateway、BlackboxExporter 等) ，以及一个内置的 PostgreSQL 单机实例作为 CMDB，也可以开箱即用。 (集群名 <code>pg-meta</code>，库名为 <code>meta</code>)。</p>
<p>这个节点现在会有完整的自我监控系统、可视化工具集，以及一个自动配置有 PITR 的 Postgres 数据库（HA不可用，因为你只有一个节点）。你可以使用此节点作为开发箱、测试、运行演示以及进行数据可视化和分析。或者，还可以把这个节点当作管理节点，部署纳管更多的节点！</p>
<p><a href="/zh/docs/infra/"><img alt="pigsty-arch.jpg" src="/img/pigsty/arch.jpg"></a></p>
<hr>
<h2 id="监控">监控</h2>
<p>安装的 <a href="/zh/docs/concept/arch/#单机安装">单机元节点</a> 可用作<strong>管理节点</strong>和<strong>监控中心</strong>，以将更多节点和数据库服务器置于其监视和控制之下。</p>
<p>Pigsty 的监控系统可以独立使用，如果你想安装 Prometheus / Grafana 可观测性全家桶，Pigsty 为你提供了最佳实践！
它为 <a href="https://demo.pigsty.cc/d/node-overview">主机节点</a> 和 <a href="https://demo.pigsty.cc/d/pgsql-overview">PostgreSQL数据库</a> 提供了丰富的仪表盘。
无论这些节点或 PostgreSQL 服务器是否由 Pigsty 管理，只需简单的配置，你就可以立即拥有生产级的监控和告警系统，并将现有的主机与PostgreSQL纳入监管。</p>
<p><a href="/zh/docs/pgsql/dashboard"><img alt="pigsty-dashboard.jpg" src="/img/pigsty/dashboard.jpg"></a></p>
<hr>
<h2 id="高可用pg集群">高可用PG集群</h2>
<p>Pigsty 帮助您在任何地方 <strong>拥有</strong> 您自己的生产级高可用 PostgreSQL RDS 服务。</p>
<p>要创建这样一个高可用 PostgreSQL 集群/RDS服务，你只需用简短的配置来描述它，并运行剧本来创建即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 3, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ bin/pgsql-add pg-test  <span style="color:#8f5902;font-style:italic"># 初始化集群 &#39;pg-test&#39;</span>
</span></span></code></pre></div><p>不到10分钟，您将拥有一个服务接入，监控，备份PITR，高可用配置齐全的 PostgreSQL 数据库集群。</p>
<p><a href="/zh/docs/concept/ha"><img alt="pigsty-ha.png" src="/img/pigsty/ha.png"></a></p>
<p>硬件故障由 patroni、etcd 和 haproxy 提供的自愈高可用架构来兜底，在主库故障的情况下，默认会在 30 秒内执行自动故障转移（Failover）。
客户端无需修改配置重启应用：Haproxy 利用 patroni 健康检查进行流量分发，读写请求会自动分发到新的集群主库中，并避免脑裂的问题。
这一过程十分丝滑，例如在从库故障，或主动切换（switchover）的情况下，客户端只有一瞬间的当前查询闪断，</p>
<p>软件故障、人为错误和 数据中心级灾难由 pgbackrest 和可选的 <a href="/zh/docs/minio">MinIO</a> 集群来兜底。这为您提供了本地/云端的 PITR 能力，并在数据中心失效的情况下提供了跨地理区域复制，与异地容灾功能。</p>
<hr>
<h2 id="数据库即代码">数据库即代码</h2>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b6e18358c874d9d65209973819faed9a">2 - 集群模型</h1>
    <div class="lead">Pigsty 是如何将不同种类的功能抽象成为模块的，以及这些模块的逻辑模型。</div>
	<p>在 Pigsty 中，功能模块是以 “集群” 的方式组织起来的。每一个集群都是一个 Ansible 分组，包含有若干节点资源，定义有实例</p>
<blockquote>
<p>PGSQL 模块总览：关键概念与架构细节</p>
</blockquote>
<p>PGSQL模块在生产环境中以<strong>集群</strong>的形式组织，这些<strong>集群</strong>是由一组由<strong>主-备</strong>关联的数据库<strong>实例</strong>组成的<strong>逻辑实体</strong>。
每个<strong>数据库集群</strong>都是一个<strong>自治</strong>的业务服务单元，由至少一个 <strong>数据库（主库）实例</strong> 组成。</p>
<hr>
<h2 id="实体概念图">实体概念图</h2>
<p>让我们从ER图开始。在Pigsty的PGSQL模块中，有四种核心实体：</p>
<ul>
<li><strong>集群</strong>（Cluster）：自治的PostgreSQL业务单元，用作其他实体的顶级命名空间。</li>
<li><strong>服务</strong>（Service）：集群能力的命名抽象，路由流量，并使用节点端口暴露postgres服务。</li>
<li><strong>实例</strong>（Instance）：一个在单个节点上的运行进程和数据库文件组成的单一postgres服务器。</li>
<li><strong>节点</strong>（Node）：硬件资源的抽象，可以是裸金属、虚拟机或甚至是k8s pods。</li>
</ul>
<p><img src="/img/pigsty/er.jpg"></p>
<p><strong>命名约定</strong></p>
<ul>
<li>集群名应为有效的 DNS 域名，不包含任何点号，正则表达式为：<code>[a-zA-Z0-9-]+</code></li>
<li>服务名应以集群名为前缀，并以特定单词作为后缀：<code>primary</code>、<code>replica</code>、<code>offline</code>、<code>delayed</code>，中间用<code>-</code>连接。</li>
<li>实例名以集群名为前缀，以正整数实例号为后缀，用<code>-</code>连接，例如<code>${cluster}-${seq}</code>。</li>
<li>节点由其首要内网IP地址标识，因为PGSQL模块中数据库与主机1:1部署，所以主机名通常与实例名相同。</li>
</ul>
<hr>
<h2 id="身份参数">身份参数</h2>
<p>Pigsty使用<strong>身份参数</strong>来识别实体：<a href="/zh/docs/reference/param#pg_id"><code>PG_ID</code></a>。</p>
<p>除了节点IP地址，<a href="/zh/docs/reference/param#pg_cluster"><code>pg_cluster</code></a>、<a href="/zh/docs/reference/param#pg_role"><code>pg_role</code></a>和<a href="/zh/docs/reference/param#pg_seq"><code>pg_seq</code></a>三个参数是定义postgres集群所必需的最小参数集。
以<a href="/zh/docs/setup/provision#%E6%B2%99%E7%AE%B1%E7%8E%AF%E5%A2%83">沙箱环境</a>测试集群<code>pg-test</code>为例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 3, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>集群的三个成员如下所示：</p>
<table>
<thead>
<tr>
<th style="text-align:center">集群</th>
<th style="text-align:center">序号</th>
<th style="text-align:center">角色</th>
<th style="text-align:center">主机 / IP</th>
<th style="text-align:center">实例</th>
<th style="text-align:center">服务</th>
<th style="text-align:center">节点名</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>pg-test</code></td>
<td style="text-align:center"><code>1</code></td>
<td style="text-align:center"><code>primary</code></td>
<td style="text-align:center"><code>10.10.10.11</code></td>
<td style="text-align:center"><code>pg-test-1</code></td>
<td style="text-align:center"><code>pg-test-primary</code></td>
<td style="text-align:center"><code>pg-test-1</code></td>
</tr>
<tr>
<td style="text-align:center"><code>pg-test</code></td>
<td style="text-align:center"><code>2</code></td>
<td style="text-align:center"><code>replica</code></td>
<td style="text-align:center"><code>10.10.10.12</code></td>
<td style="text-align:center"><code>pg-test-2</code></td>
<td style="text-align:center"><code>pg-test-replica</code></td>
<td style="text-align:center"><code>pg-test-2</code></td>
</tr>
<tr>
<td style="text-align:center"><code>pg-test</code></td>
<td style="text-align:center"><code>3</code></td>
<td style="text-align:center"><code>replica</code></td>
<td style="text-align:center"><code>10.10.10.13</code></td>
<td style="text-align:center"><code>pg-test-3</code></td>
<td style="text-align:center"><code>pg-test-replica</code></td>
<td style="text-align:center"><code>pg-test-3</code></td>
</tr>
</tbody>
</table>
<p>这里包含了：</p>
<ul>
<li>一个集群：该集群命名为<code>pg-test</code>。</li>
<li>两种角色：<code>primary</code>和<code>replica</code>。</li>
<li>三个实例：集群由三个实例组成：<code>pg-test-1</code>、<code>pg-test-2</code>、<code>pg-test-3</code>。</li>
<li>三个节点：集群部署在三个节点上：<code>10.10.10.11</code>、<code>10.10.10.12</code>和<code>10.10.10.13</code>。</li>
<li>四个服务：
<ul>
<li>读写服务：<a href="/zh/docs/pgsql/svc#primary%E6%9C%8D%E5%8A%A1"><code>pg-test-primary</code></a></li>
<li>只读服务：<a href="/zh/docs/pgsql/svc#replica%E6%9C%8D%E5%8A%A1"><code>pg-test-replica</code></a></li>
<li>直接连接的管理服务：<a href="/zh/docs/pgsql/svc#default%E6%9C%8D%E5%8A%A1"><code>pg-test-default</code></a></li>
<li>离线读服务：<a href="/zh/docs/pgsql/svc#offline%E6%9C%8D%E5%8A%A1"><code>pg-test-offline</code></a></li>
</ul>
</li>
</ul>
<p>在监控系统（Prometheus/Grafana/Loki）中，相应的指标将会使用这些身份参数进行标记：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">pg_up{cls=&#34;pg-meta&#34;, ins=&#34;pg-meta-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;pgsql&#34;}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">pg_up{cls=&#34;pg-test&#34;, ins=&#34;pg-test-1&#34;, ip=&#34;10.10.10.11&#34;, job=&#34;pgsql&#34;}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">pg_up{cls=&#34;pg-test&#34;, ins=&#34;pg-test-2&#34;, ip=&#34;10.10.10.12&#34;, job=&#34;pgsql&#34;}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">pg_up{cls=&#34;pg-test&#34;, ins=&#34;pg-test-3&#34;, ip=&#34;10.10.10.13&#34;, job=&#34;pgsql&#34;}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-640213fc983ef0aae5180ea5bbbfb2d3">3 - 监控系统</h1>
    <div class="lead">Pigsty 的监控系统是如何架构与实现的，被监控的目标对象又是如何被自动纳入管理的。</div>
	
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a2af4580848e7a62549ec377b62ac71e">4 - 本地 CA</h1>
    <div class="lead">Pigsty 带有一套自签名的 CA 公私钥基础设施，用于签发 SSL 证书，加密网络通信流量。</div>
	<p>Pigsty 部署默认启用了一些安全最佳实践：使用 SSL 加密网络流量，使用 HTTPS 加密 Web 界面。</p>
<p>为了实现这一功能，Pigsty 内置了本地自签名的 CA ，用于签发 SSL 证书，加密网络通信流量。</p>
<p>在默认情况下，SSL 与 HTTPS 是启用，但不强制使用的。对于有着较高安全要求的环境，您可以强制使用 SSL 与 HTTPS。</p>
<hr>
<h2 id="本地ca">本地CA</h2>
<p>Pigsty 默认会在初始化时，在 <a href="/zh/docs/node/#admin%E8%8A%82%E7%82%B9">ADMIN节点</a> 本机 Pigsty 源码目录（<code>~/pigsty</code>）中生成一个自签名的 CA，当您需要使用 SSL，HTTPS，数字签名，签发数据库客户端证书，高级安全特性时，可以使用此 CA。</p>
<p>因此，每一套 Pigsty 部署使用的 CA 都是唯一的，不同的 Pigsty 部署之间的 CA 是不相互信任的。</p>
<p>本地 CA 由两个文件组成，默认放置于 <code>files/pki/ca</code> 目录中：</p>
<ul>
<li><code>ca.crt</code>：自签名的 CA 根证书，应当分发安装至到所有纳管节点，用于证书验证。</li>
<li><code>ca.key</code>：CA 私钥，用于签发证书，验证 CA 身份，应当妥善保管，避免泄漏！</li>
</ul>


<div class="alert alert-danger" role="alert">
<h4 class="alert-heading">请保护好CA私钥文件</h4>

    请妥善保管 CA 私钥文件，不要遗失，不要泄漏。我们建议您在完成 Pigsty 安装后，加密备份此文件。

</div>

<hr>
<h2 id="使用现有ca">使用现有CA</h2>
<p>如果您本身已经有 CA 公私钥基础设施，Pigsty 也可以配置为使用现有 CA 。</p>
<p>将您的 CA 公钥与私钥文件放置于 <code>files/pki/ca</code> 目录中即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>files/pki/ca/ca.key     <span style="color:#8f5902;font-style:italic"># 核心的 CA 私钥文件，必须存在，如果不存在，默认会重新随机生成一个</span>
</span></span><span style="display:flex;"><span>files/pki/ca/ca.crt     <span style="color:#8f5902;font-style:italic"># 如果没有证书文件，Pigsty会自动重新从 CA 私钥生成新的根证书文件</span>
</span></span></code></pre></div><p>当 Pigsty 执行 <a href="/zh/docs/infra/#installyml"><strong><code>install.yml</code></strong></a> 与 <a href="/zh/docs/infra/#infrayml"><strong><code>infra.yml</code></strong></a> 剧本进行安装时，如果发现 <code>files/pki/ca</code> 目录中的 <code>ca.key</code> 私钥文件存在，则会使用已有的 CA 。<code>ca.crt</code> 文件可以从 <code>ca.key</code> 私钥文件生成，所以如果没有证书文件，Pigsty 会自动重新从 CA 私钥生成新的根证书文件。</p>


<div class="alert alert-secondary" role="alert">
<h4 class="alert-heading">使用现有CA时请注意</h4>

    您可以将 <a href="/zh/docs/reference/param#ca_method"><strong><code>ca_method</code></strong></a> 参数配置为 <code>copy</code>，确保 Pigsty 找不到本地 CA 时报错中止，而不是自行重新生成新的自签名 CA。

</div>

<hr>
<h2 id="信任ca">信任CA</h2>
<p>在 Pigsty 安装过程中，<code>ca.crt</code> 会在 <a href="/zh/docs/node/#nodeyml"><strong><code>node.yml</code></strong></a> 剧本的 <code>node_ca</code> 任务中，被分发至所有节点上的 <code>/etc/pki/ca.crt</code> 路径下。</p>
<p>EL系操作系统与 Debian系操作系统默认信任的 CA 根证书路径不同，因此分发的路径与更新的方式也不同。</p>







<ul class="nav nav-tabs" id="tabs-2" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-02-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-00" role="tab"
          aria-controls="tabs-02-00" aria-selected="false">
        信任CA证书
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-02-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-01" role="tab"
          aria-controls="tabs-02-01" aria-selected="true">
        EL
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-02-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-02-02" role="tab"
          aria-controls="tabs-02-02" aria-selected="false">
        Debian / Ubuntu
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-2-content">
    <div class="tab-pane fade"
        id="tabs-02-00" role="tabpanel" aria-labelled-by="tabs-02-00-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"></code></pre></div>
    </div>
    <div class="tab-pane fade show active"
        id="tabs-02-01" role="tabpanel" aria-labelled-by="tabs-02-01-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>rm -rf /etc/pki/ca-trust/source/anchors/ca.crt
</span></span><span style="display:flex;"><span>ln -s /etc/pki/ca.crt /etc/pki/ca-trust/source/anchors/ca.crt
</span></span><span style="display:flex;"><span>/bin/update-ca-trust</span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-02-02" role="tabpanel" aria-labelled-by="tabs-02-02-tab" tabindex="2">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>rm -rf /usr/local/share/ca-certificates/ca.crt
</span></span><span style="display:flex;"><span>ln -s /etc/pki/ca.crt /usr/local/share/ca-certificates/ca.crt
</span></span><span style="display:flex;"><span>/usr/sbin/update-ca-certificates</span></span></code></pre></div>
    </div>
</div>

<p>Pigsty 默认会为基础设施节点上的 Web 系统使用的域名签发 HTTPS 证书，您可以 HTTPS 访问 Pigsty 的 Web 系统。
如果您希望在客户端电脑上浏览器访问时不要弹出“不受信任的 CA 证书”信息，可以将 <code>ca.crt</code> 分发至客户端电脑的信任证书目录中。</p>
<p>您可以双击 <code>ca.crt</code> 文件将其加入系统钥匙串，例如在 MacOS 系统中，需要打开“钥匙串访问” 搜索 <code>pigsty-ca</code> 然后“信任”此根证书</p>
<hr>
<h2 id="查看证书内容">查看证书内容</h2>
<p>使用以下命令，可以查阅 Pigsty CA 证书的内容</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl x509 -text -in /etc/pki/ca.crt
</span></span></code></pre></div><details><summary>本地 CA 根证书内容样例</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Certificate:
</span></span><span style="display:flex;"><span>    Data:
</span></span><span style="display:flex;"><span>        Version: 3 (0x2)
</span></span><span style="display:flex;"><span>        Serial Number:
</span></span><span style="display:flex;"><span>            50:29:e3:60:96:93:f4:85:14:fe:44:81:73:b5:e1:09:2a:a8:5c:0a
</span></span><span style="display:flex;"><span>        Signature Algorithm: sha256WithRSAEncryption
</span></span><span style="display:flex;"><span>        Issuer: O=pigsty, OU=ca, CN=pigsty-ca
</span></span><span style="display:flex;"><span>        Validity
</span></span><span style="display:flex;"><span>            Not Before: Feb  7 00:56:27 2023 GMT
</span></span><span style="display:flex;"><span>            Not After : Jan 14 00:56:27 2123 GMT
</span></span><span style="display:flex;"><span>        Subject: O=pigsty, OU=ca, CN=pigsty-ca
</span></span><span style="display:flex;"><span>        Subject Public Key Info:
</span></span><span style="display:flex;"><span>            Public Key Algorithm: rsaEncryption
</span></span><span style="display:flex;"><span>                Public-Key: (4096 bit)
</span></span><span style="display:flex;"><span>                Modulus:
</span></span><span style="display:flex;"><span>                    00:c1:41:74:4f:28:c3:3c:2b:13:a2:37:05:87:31:
</span></span><span style="display:flex;"><span>                    ....
</span></span><span style="display:flex;"><span>                    e6:bd:69:a5:5b:e3:b4:c0:65:09:6e:84:14:e9:eb:
</span></span><span style="display:flex;"><span>                    90:f7:61
</span></span><span style="display:flex;"><span>                Exponent: 65537 (0x10001)
</span></span><span style="display:flex;"><span>        X509v3 extensions:
</span></span><span style="display:flex;"><span>            X509v3 Subject Alternative Name: 
</span></span><span style="display:flex;"><span>                DNS:pigsty-ca
</span></span><span style="display:flex;"><span>            X509v3 Key Usage: 
</span></span><span style="display:flex;"><span>                Digital Signature, Certificate Sign, CRL Sign
</span></span><span style="display:flex;"><span>            X509v3 Basic Constraints: critical
</span></span><span style="display:flex;"><span>                CA:TRUE, pathlen:1
</span></span><span style="display:flex;"><span>            X509v3 Subject Key Identifier: 
</span></span><span style="display:flex;"><span>                C5:F6:23:CE:BA:F3:96:F6:4B:48:A5:B1:CD:D4:FA:2B:BD:6F:A6:9C
</span></span><span style="display:flex;"><span>    Signature Algorithm: sha256WithRSAEncryption
</span></span><span style="display:flex;"><span>    Signature Value:
</span></span><span style="display:flex;"><span>        89:9d:21:35:59:6b:2c:9b:c7:6d:26:5b:a9:49:80:93:81:18:
</span></span><span style="display:flex;"><span>        ....
</span></span><span style="display:flex;"><span>        9e:dd:87:88:0d:c4:29:9e
</span></span><span style="display:flex;"><span>-----BEGIN CERTIFICATE-----
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>cXyWAYcvfPae3YeIDcQpng==
</span></span><span style="display:flex;"><span>-----END CERTIFICATE-----
</span></span></code></pre></div></details>
<hr>
<h2 id="签发证书">签发证书</h2>
<p>如果您希望通过客户端证书认证，那么可以使用本地 CA 与 <a href="https://github.com/Vonng/pigsty/blob/main/cert.yml"><strong><code>cert.yml</code></strong></a> 剧本手工签发PostgreSQL 客户端证书。</p>
<p>将证书的 <code>CN</code> 字段设置为数据库用户名即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./cert.yml -e <span style="color:#000">cn</span><span style="color:#ce5c00;font-weight:bold">=</span>dbuser_dba
</span></span><span style="display:flex;"><span>./cert.yml -e <span style="color:#000">cn</span><span style="color:#ce5c00;font-weight:bold">=</span>dbuser_monitor
</span></span></code></pre></div><p>签发的证书会默认生成在 <code>files/pki/misc/&lt;cn&gt;.{key,crt}</code> 路径下。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e4bef574b3856f296b026321cf35f1f9">5 - 基础设施即代码</h1>
    <div class="lead">基础设施即代码，Infra as Code，简称 IaC。Pigsty 使用 IaC 的方式管理整套部署环境中的所有组件。</div>
	<p>基础设施即代码，Infra as Code，简称 IaC。</p>
<p>Pigsty 遵循 IaC 与 GitOPS 的理念：Pigsty 的部署由声明式的 <a href="/zh/docs/setup/config#%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95"><strong>配置清单</strong></a> 描述，并通过 <a href="/zh/docs/setup/playbook"><strong>幂等剧本</strong></a> 来实现。</p>
<p>用户用声明的方式通过 <a href="/zh/docs/reference/param"><strong>参数</strong></a> 来描述自己期望的状态，而剧本则以幂等的方式调整目标节点以达到这个状态。这类似于 Kubernetes 的 CRD &amp; Operator，Pigsty 在裸机和虚拟机上实现了同样的功能。</p>
<hr>
<h2 id="声明模块">声明模块</h2>
<p>以下面的默认配置片段为例，这段配置描述了一个节点 <code>10.10.10.10</code>，其上安装了 <a href="/zh/docs/infra"><strong><code>INFRA</code></strong></a>、<a href="/zh/docs/node"><strong><code>NODE</code></strong></a>、<a href="/zh/docs/etcd"><strong><code>ETCD</code></strong></a> 和 <a href="/zh/docs/pgsql"><strong><code>PGSQL</code></strong></a> 模块。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 监控、告警、DNS、NTP 等基础设施集群...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">infra</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">infra_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># minio 集群，兼容 s3 的对象存储</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">minio</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">minio_seq: 1 } }, vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">minio_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">minio } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># etcd 集群，用作 PostgreSQL 高可用所需的 DCS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq: 1 } }, vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># PGSQL 示例集群: pg-meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role: primary }, vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>要真正安装这些模块，执行以下剧本：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./infra.yml -l 10.10.10.10  <span style="color:#8f5902;font-style:italic"># 在节点 10.10.10.10 上初始化 infra 模块</span>
</span></span><span style="display:flex;"><span>./etcd.yml  -l 10.10.10.10  <span style="color:#8f5902;font-style:italic"># 在节点 10.10.10.10 上初始化 etcd 模块</span>
</span></span><span style="display:flex;"><span>./minio.yml -l 10.10.10.10  <span style="color:#8f5902;font-style:italic"># 在节点 10.10.10.10 上初始化 minio 模块</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -l 10.10.10.10  <span style="color:#8f5902;font-style:italic"># 在节点 10.10.10.10 上初始化 pgsql 模块</span>
</span></span></code></pre></div><hr>
<h2 id="声明集群">声明集群</h2>
<p>您可以声明 PostgreSQL 数据库集群，在多个节点上安装 <a href="/zh/docs/pgsql/"><strong><code>PGSQL</code></strong></a> 模块，并使其成为一个服务单元：</p>
<p>例如，要在以下三个已被 Pigsty 纳管的节点上，部署一个使用流复制组建的三节点高可用 PostgreSQL 集群，
您可以在配置文件 <a href="https://github.com/Vonng/pigsty/blob/main/pigsty.yml"><code>pigsty.yml</code></a> 的 <code>all.children</code> 中添加以下定义：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 3, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">offline }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>定义完后，可以使用 <a href="/zh/docs/setup/playbook/"><strong>剧本</strong></a> 将集群创建：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-add pg-test   <span style="color:#8f5902;font-style:italic"># 创建 pg-test 集群 </span>
</span></span></code></pre></div><p><img alt="pigsty-iac.jpg" src="/img/pigsty/iac.jpg"></p>
<p>你可以使用不同的的实例角色，例如 <a href="/zh/docs/pgsql/config#%E8%AF%BB%E5%86%99%E4%B8%BB%E5%BA%93"><strong>主库</strong></a>（primary），<a href="/zh/docs/pgsql/config#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93"><strong>从库</strong></a>（replica），<a href="/zh/docs/pgsql/config#%E8%AF%BB%E5%86%99%E4%B8%BB%E5%BA%93"><strong>离线从库</strong></a>（offline），<a href="/zh/docs/pgsql/config#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4"><strong>延迟从库</strong></a>（delayed），<a href="/zh/docs/pgsql/config#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93"><strong>同步备库</strong></a>（sync standby）；
以及不同的集群：例如 <a href="/zh/docs/pgsql/config#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4"><strong>备份集群</strong></a>（Standby Cluster），<a href="/zh/docs/pgsql/config#citus%E9%9B%86%E7%BE%A4"><strong>Citus集群</strong></a>，甚至是 <a href="/zh/docs/redis"><strong>Redis</strong></a> / <a href="/zh/docs/minio"><strong>MinIO</strong></a> / <a href="/zh/docs/etcd"><strong>Etcd</strong></a> 集群</p>
<hr>
<h2 id="定制集群内容">定制集群内容</h2>
<p>您不仅可以使用声明式的方式定义集群，还可以定义集群中的数据库、用户、服务、HBA 规则等内容，例如，下面的配置文件对默认的 <code>pg-meta</code> 单节点数据库集群的内容进行了深度定制：</p>
<p>包括：声明了六个业务数据库与七个业务用户，添加了一个额外的 <code>standby</code> 服务（同步备库，提供无复制延迟的读取能力），定义了一些额外的 <code>pg_hba</code> 规则，一个指向集群主库的 L2 VIP 地址，与自定义的备份策略。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role: primary , pg_offline_query</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#8f5902;font-style:italic"># define business databases on this cluster, array of database definition</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta                     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># REQUIRED, `name` is the only mandatory field of a database definition</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">baseline</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cmdb.sql             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, database sql baseline path, (relative path among ansible search path, e.g files/)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pgbouncer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># optional, add this database to pgbouncer database list? true by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">schemas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pigsty]              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, additional schemas to be created, array of schema names</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">extensions:                     # optional, additional extensions to be installed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">array of `{name[,schema]}`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: postgis , schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">public }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">timescaledb }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty meta database  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, comment string for this database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres               </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, database owner, postgres by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">template1           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, which template to use, template1 by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">encoding</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UTF8                </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, database encoding, UTF8 by default. (MUST same as template database)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">locale</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">C                     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, database locale, C by default.  (MUST same as template database)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">lc_collate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">C                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, database collate, C by default. (MUST same as template database)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">lc_ctype</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">C                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, database ctype, C by default.   (MUST same as template database)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">tablespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_default        </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, default tablespace, &#39;pg_default&#39; by default.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">allowconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># optional, allow connection, true by default. false will disable connect at all</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">revokeconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic"># optional, revoke public connection privilege. false by default. (leave connect with grant option to owner)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">register_datasource</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># optional, register this database to grafana datasources? true by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># optional, database connection limit, default -1 disable limit</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pool_auth_user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_meta   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, all connection to this pgbouncer database will be authenticated by this user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pool_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">transaction        </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, pgbouncer pool mode at database level, default transaction</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pool_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># optional, pgbouncer pool size at database level, default 64</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pool_size_reserve</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># optional, pgbouncer pool size reserve at database level, default 32</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pool_size_min</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic"># optional, pgbouncer pool size min at database level, default 0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pool_max_db_conn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># optional, max database connections at database level, default 100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: grafana  ,owner: dbuser_grafana  ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">grafana primary database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: bytebase ,owner: dbuser_bytebase ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bytebase primary database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: kong     ,owner: dbuser_kong     ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kong the api gateway database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: gitea    ,owner: dbuser_gitea    ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gitea meta database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: wiki     ,owner: dbuser_wiki     ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wiki meta database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#8f5902;font-style:italic"># define business users/roles on this cluster, array of user definition</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_meta              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># REQUIRED, `name` is the only mandatory field of a user definition</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Meta          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, password, can be a scram-sha-256 hash string or plain text</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">login</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># optional, can log in, true by default  (new biz ROLE should be false)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">superuser</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># optional, is superuser? false by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">createdb</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># optional, can create database? false by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">createrole</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic"># optional, can create role? false by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">inherit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># optional, can this role use inherited privileges? true by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">replication</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic"># optional, can this role do replication? false by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">bypassrls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># optional, can this role bypass row level security? false by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pgbouncer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># optional, add this user to pgbouncer user-list? false by default (production user should be true explicitly)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># optional, user connection limit, default -1 disable limit</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">expire_in</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3650</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># optional, now + n days when this role is expired (OVERWRITE expire_at)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">expire_at</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;2030-12-31&#39;</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># optional, YYYY-MM-DD &#39;timestamp&#39; when this role is expired  (OVERWRITTEN by expire_in)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty admin user     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, comment string for this user/role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">roles: [dbrole_admin]           # optional, belonged roles. default roles are</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_{admin,readonly,readwrite,offline}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># optional, role level parameters with `ALTER ROLE SET`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pool_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">transaction         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, pgbouncer pool mode at user level, transaction by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pool_connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic"># optional, max database connections at user level, default -1 disable limit</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly], comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">read-only viewer for meta database}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_grafana  ,password: DBUser.Grafana  ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for grafana database   }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_bytebase ,password: DBUser.Bytebase ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for bytebase database  }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_kong     ,password: DBUser.Kong     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for kong api gateway   }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_gitea    ,password: DBUser.Gitea    ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for gitea service      }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_wiki     ,password: DBUser.Wiki     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for wiki.js service    }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#8f5902;font-style:italic"># extra services in addition to pg_default_services, array of service definition</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># standby service will route {ip|name}:5435 to sync replica&#39;s pgbouncer (5435-&gt;6432 standby)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name: standby                   # required, service name, the actual svc name will be prefixed with `pg_cluster`, e.g</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta-standby</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5435</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#8f5902;font-style:italic"># required, service exposed port (work as kubernetes service node port mode)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#8f5902;font-style:italic"># optional, service bind ip address, `*` for all ip by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># required, service member selector, use JMESPath to filter inventory</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">dest</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default                  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, destination port, default|postgres|pgbouncer|&lt;port_number&gt;, &#39;default&#39; by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">check</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/sync                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, health check url path, / by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">backup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `primary`]&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># backup server selector</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">maxconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># optional, max allowed front-end connection</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">balance: roundrobin             # optional, haproxy load balance algorithm (roundrobin by default, other</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">leastconn)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user: dbuser_view , db: all ,addr: infra ,auth: pwd ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_vip_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_vip_address</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.2</span><span style="color:#000">/24</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_vip_interface</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">eth1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">node_crontab</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># make a full backup 1 am everyday</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#4e9a06">&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="声明访问控制">声明访问控制</h2>
<p>您还可以通过声明式的配置，深度定制 Pigsty 的访问控制能力。例如下面的配置文件对 <code>pg-meta</code> 集群进行了深度安全定制：</p>
<p>使用三节点核心集群模板：<code>crit.yml</code>，确保数据一致性有限，故障切换数据零丢失。
启用了 L2 VIP，并将数据库与连接池的监听地址限制在了 本地环回IP + 内网IP + VIP 三个特定地址。
模板强制启用了 Patroni 的 SSL API，与 Pgbouncer 的 SSL，并在 HBA 规则中强制要求使用 SSL 访问数据库集群。
同时还在 <code>pg_libs</code> 中启用了 <code>$libdir/passwordcheck</code> 扩展，来强制执行密码强度安全策略。</p>
<p>最后，还单独声明了一个 <code>pg-meta-delay</code> 集群，作为 <code>pg-meta</code> 在一个小时前的延迟镜像从库，用于紧急数据误删恢复。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># 3 instance postgres cluster `pg-meta`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 3, pg_role: replica , pg_offline_query</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_conf</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">crit.yml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_meta , password: DBUser.Meta   , pgbouncer: true , roles: [ dbrole_admin ] , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_view , password: DBUser.Viewer , pgbouncer: true , roles: [ dbrole_readonly ] , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">read-only viewer for meta database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#204a87;font-weight:bold">name: postgis, schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">public}, {name: timescaledb}]}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_default_service_dest</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: standby ,src_ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,port: 5435 , dest: default ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">, backup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `primary`]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_vip_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_vip_address</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.2</span><span style="color:#000">/24</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_vip_interface</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">eth1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_listen</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${ip},${vip},${lo}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">patroni_ssl_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pgbouncer_sslmode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">require</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pgbackrest_method</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">minio</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_libs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;timescaledb, $libdir/passwordcheck, pg_stat_statements, auto_explain&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># add passwordcheck extension to enforce strong password</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_default_roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># default roles and users in postgres cluster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_readonly  ,login: false ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for global read-only access     }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_offline   ,login: false ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for restricted read-only access }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly]               ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for global read-write access }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite]  ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for object creation }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: postgres     ,superuser: true  ,expire_in: 7300                        ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system superuser }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: replicator ,replication: true  ,expire_in: 7300 ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system replicator }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_dba   ,superuser: true  ,expire_in: 7300 ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_monitor ,roles: [pg_monitor] ,expire_in: 7300 ,pgbouncer: true ,parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql monitor user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_default_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># postgres host-based auth rules by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: local     ,auth: ident ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu access via local os user ident&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: local     ,auth: ident ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu replication from local os ident&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: localhost ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator replication from localhost&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator replication from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: postgres    ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator postgres db from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor from localhost with password&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor from infra host with password&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin @ infra nodes with pwd &amp; ssl&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: world     ,auth: cert  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin @ everywhere with ssl &amp; cert&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pgbouncer read/write via local socket&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;read/write biz user via password&#39;</span><span style="color:#f8f8f8;text-decoration:underline">     </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow etl offline tasks from intranet&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pgb_default_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># pgbouncer host-based authentication rules</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: pgbouncer   ,addr: local     ,auth: peer  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu local admin access with os ident&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow all user local access with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: pgbouncer   ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor access via intranet with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: world     ,auth: deny  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;reject all other monitor access addr&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin access via intranet with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: world     ,auth: deny  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;reject all other admin access addr&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow all user intra access with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># OPTIONAL delayed cluster for pg-meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-meta-delay</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#8f5902;font-style:italic"># delayed instance for pg-meta (1 hour ago)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role: primary, pg_upstream: 10.10.10.10, pg_delay</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1h } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta-delay }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="citus分布式集群">Citus分布式集群</h2>
<p>下面是一个四节点的 Citus 分布式集群的声明式配置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">all</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">children</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-citus0</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus coordinator, pg_group = 0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-citus0 , pg_group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-citus1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus data node 1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-citus1 , pg_group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-citus2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus data node 2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-citus2 , pg_group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-citus3</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus data node 3, with an extra replica</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">10.10.10.14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-citus3 , pg_group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#8f5902;font-style:italic"># global parameters for all citus clusters</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_mode: citus                    # pgsql cluster mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">citus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_shard: pg-citus                # citus shard name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-citus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">patroni_citus_db</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus distributed database name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_dbsu_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Postgres</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># all dbsu password access for citus cluster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_meta ,password: DBUser.Meta ,pgbouncer: true ,roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_admin ] } ]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: meta ,extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">citus }, { name: postgis }, { name: timescaledb } ] } ]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32 ,auth: ssl ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all user ssl access from localhost&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user: &#39;all&#39; ,db: all  ,addr: intra        ,auth: ssl ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all user ssl access from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="redis集群">Redis集群</h2>
<p>下面给出了 Redis 主从集群、哨兵集群、以及 Redis Cluster 的声明配置样例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">redis-ms</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># redis classic primary &amp; replica</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">redis_node: 1 , redis_instances</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">}, 6380</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">replica_of</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;10.10.10.10 6379&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">redis_cluster: redis-ms ,redis_password: &#39;redis.ms&#39; ,redis_max_memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">64MB }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">redis-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># redis sentinel x 3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">redis_node: 1 , redis_instances</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">26379</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">} ,26380</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">} ,26381</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">redis_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">redis-meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">redis_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;redis.meta&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">redis_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sentinel</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">redis_max_memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">16MB</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">redis_sentinel_monitor</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># primary list for redis sentinel, use cls as name, primary ip:port</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: redis-ms, host: 10.10.10.10, port: 6379 ,password: redis.ms, quorum</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">redis-test: # redis native cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">3m x 3s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">redis_node: 1 ,redis_instances</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">} ,6380</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">} ,6381</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">redis_node: 2 ,redis_instances</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">} ,6380</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">} ,6381</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">redis_cluster: redis-test ,redis_password: &#39;redis.test&#39; ,redis_mode: cluster, redis_max_memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">32MB }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="etcd集群">ETCD集群</h2>
<p>下面给出了一个三节点的 Etcd 集群声明式配置样例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># dcs service for postgres/patroni ha consensus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 1 node for testing, 3 or 5 for production</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># etcd_seq required</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># assign from 1 ~ n</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># odd number please</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># cluster level parameter override roles/etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># mark etcd cluster name etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd_safeguard</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># safeguard against purging</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd_clean</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># purge etcd during init process</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="minio集群">MinIO集群</h2>
<p>下面给出了一个三节点的 MinIO 集群声明式配置样例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">minio</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">minio_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">minio_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">minio_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">minio_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">minio</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">minio_data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;/data{1...2}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># 每个节点使用两块磁盘</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">minio_node</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${minio_cluster}-${minio_seq}.pigsty&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 节点名称的模式</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">haproxy_services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">minio                    </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># [必选] 服务名称，需要唯一</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9002</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#8f5902;font-style:italic"># [必选] 服务端口，需要唯一</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#000">option httpchk</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#000">option http-keep-alive</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#000">http-check send meth OPTIONS uri /minio/health/live</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#000">http-check expect status 200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">servers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: minio-1 ,ip: 10.10.10.10 , port: 9000 , options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;check-ssl ca-file /etc/pki/ca.crt check port 9000&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: minio-2 ,ip: 10.10.10.11 , port: 9000 , options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;check-ssl ca-file /etc/pki/ca.crt check port 9000&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: minio-3 ,ip: 10.10.10.12 , port: 9000 , options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;check-ssl ca-file /etc/pki/ca.crt check port 9000&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-316ebbf072075b20f0f8bf290998d747">6 - 数据库高可用</h1>
    <div class="lead">Pigsty 使用 Patroni 实现了 PostgreSQL 的高可用，确保主库不可用时自动进行故障转移，由从库接管。</div>
	<hr>
<h2 id="概览">概览</h2>
<p>Pigsty 的 PostgreSQL 集群带有开箱即用的高可用方案，由 <a href="https://patroni.readthedocs.io/en/latest/"><strong>Patroni</strong></a>、<a href="https://etcd.io/"><strong>Etcd</strong></a> 和 <a href="http://www.haproxy.org/"><strong>HAProxy</strong></a> 强力驱动。</p>
<p>当您的 PostgreSQL 集群含有两个或更多实例时，您无需任何配置即拥有了硬件故障自愈的数据库高可用能力 —— 只要集群中有任意实例存活，集群就可以对外提供完整的服务，而客户端只要连接至集群中的任意节点，即可获得完整的服务，而无需关心主从拓扑变化。</p>
<p>在默认配置下，主库故障恢复时间目标 RTO ≈ 30s，数据恢复点目标 RPO &lt; 1MB；从库故障 RPO = 0，RTO ≈ 0 (闪断)；在一致性优先模式下，可确保故障切换数据零损失：RPO = 0。以上指标均可通过参数，根据您的实际硬件条件与可靠性要求 <a href="/zh/docs/concept/ha/#利弊权衡"><strong>按需配置</strong></a>。</p>
<p>Pigsty 内置了 HAProxy 负载均衡器用于自动流量切换，提供 DNS/VIP/LVS 等多种接入方式供客户端选用。故障切换与主动切换对业务侧除零星闪断外几乎无感知，应用不需要修改连接串重启。
极小的维护窗口需求带来了极大的灵活便利：您完全可以在无需应用配合的情况下滚动维护升级整个集群。硬件故障可以等到第二天再抽空善后处置的特性，让研发，运维与 DBA 都能在故障时安心睡个好觉。</p>
<p><del><img alt="pigsty-ha" src="/img/pigsty/ha.png"></del></p>
<p>许多大型组织与核心机构已经在生产环境中长时间使用 Pigsty ，最大的部署有 25K CPU 核心与 220+ PostgreSQL 超大规格实例（64c / 512g / 3TB NVMe SSD）；在这一部署案例中，五年内经历了数十次硬件故障与各类事故，但依然可以保持高于 <strong>99.999%</strong> 的总体可用性战绩。</p>
<hr>
<p><strong>高可用（High-Availability）解决什么问题？</strong></p>
<ul>
<li>将数据安全C/IA中的可用性提高到一个新高度：RPO ≈ 0, RTO &lt; 30s。</li>
<li>获得无缝滚动维护的能力，最小化维护窗口需求，带来极大便利。</li>
<li>硬件故障可以立即自愈，无需人工介入，运维DBA可以睡个好觉。</li>
<li>从库可以用于承载只读请求，分担主库负载，让资源得以充分利用。</li>
</ul>
<p><strong>高可用有什么代价？</strong></p>
<ul>
<li>基础设施依赖：高可用需要依赖 DCS (etcd/zk/consul) 提供共识。</li>
<li>起步门槛增加：一个有意义的高可用部署环境至少需要 <strong>三个节点</strong>。</li>
<li>额外的资源消耗：一个新从库就要消耗一份额外资源，不算大问题。</li>
<li>复杂度代价显著升高：备份成本显著加大，需要使用工具压制复杂度。</li>
</ul>
<p><strong>高可用的局限性</strong></p>
<p>因为复制实时进⾏，所有变更被⽴即应⽤⾄从库。因此基于流复制的高可用方案⽆法应对⼈为错误与软件缺陷导致的数据误删误改。（例如：<code>DROP TABLE</code>，或 <code>DELETE</code> 数据）
此类故障需要使用 <a href="/zh/docs/pgsql/config#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4"><strong>延迟集群</strong></a> ，或使用先前的基础备份与 WAL 归档进行 <a href="/zh/docs/concept/pitr"><strong>时间点恢复</strong></a>。</p>
<table>
<thead>
<tr>
<th style="text-align:left">配置策略</th>
<th>RTO</th>
<th style="text-align:left">RPO</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">单机 + <i class="fa-solid fa-music text-danger"></i> 什么也不做</td>
<td><i class="fas fa-circle-xmark text-danger"></i> <strong>数据永久丢失，无法恢复</strong></td>
<td style="text-align:left"><i class="fas fa-circle-xmark text-danger"></i> <strong>数据全部丢失</strong></td>
</tr>
<tr>
<td style="text-align:left">单机 + <i class="fa-solid fa-copy text-secondary"></i> 基础备份</td>
<td><i class="fa-solid fa-triangle-exclamation text-secondary"></i> 取决于备份大小与带宽（几小时）</td>
<td style="text-align:left"><i class="fa-solid fa-triangle-exclamation text-secondary"></i> 丢失上一次备份后的数据（几个小时到几天）</td>
</tr>
<tr>
<td style="text-align:left">单机 + <i class="fa-solid fa-copy text-primary"></i> 基础备份 + <i class="fa-solid fa-clock-rotate-left text-primary"></i> WAL归档</td>
<td><i class="fa-solid fa-triangle-exclamation text-primary"></i> 取决于备份大小与带宽（几小时）</td>
<td style="text-align:left"><i class="fa-solid fa-triangle-exclamation text-primary"></i> 丢失最后尚未归档的数据（几十MB）</td>
</tr>
<tr>
<td style="text-align:left">主从 + <i class="fa-solid fa-wrench text-secondary"></i> 手工故障切换</td>
<td><i class="fa-solid fa-triangle-exclamation text-primary"></i>  十分钟</td>
<td style="text-align:left"><i class="fa-solid fa-circle-check text-primary"></i> 丢失复制延迟中的数据（约百KB）</td>
</tr>
<tr>
<td style="text-align:left">主从 + <i class="fa-solid fa-infinity text-primary"></i> 自动故障切换</td>
<td><i class="fa-solid fa-circle-check text-primary"></i> 一分钟内</td>
<td style="text-align:left"><i class="fa-solid fa-circle-check text-primary"></i> 丢失复制延迟中的数据（约百KB）</td>
</tr>
<tr>
<td style="text-align:left">主从 + <i class="fa-solid fa-infinity text-primary"></i> 自动故障切换 + <i class="fa-solid fa-rotate text-success"></i> 同步提交</td>
<td><i class="fa-solid fa-circle-check text-success"></i> 一分钟内</td>
<td style="text-align:left"><i class="fa-solid fa-circle-check text-success"></i> 无数据丢失</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="原理">原理</h2>
<p>在 Pigsty 中，高可用架构的实现原理如下：</p>
<ul>
<li>PostgreSQL 使⽤标准流复制搭建物理从库，主库故障时由从库接管。</li>
<li>Patroni 负责管理 PostgreSQL 服务器进程，处理高可用相关事宜。</li>
<li>Etcd 提供分布式配置存储（DCS）能力，并用于故障后的领导者选举</li>
<li>Patroni 依赖 Etcd 达成集群领导者共识，并对外提供健康检查接口。</li>
<li>HAProxy 对外暴露集群服务，并利⽤ Patroni 健康检查接口，自动分发流量至健康节点。</li>
<li>vip-manager 提供一个可选的二层 VIP，从 Etcd 中获取领导者信息，并将 VIP 绑定在集群主库所在节点上。</li>
</ul>
<p>当主库故障时，将触发新一轮领导者竞选，集群中最为健康的从库将胜出（LSN位点最高，数据损失最小者），并被提升为新的主库。 胜选从库提升后，读写流量将立即路由至新的主库。
主库故障影响是 <strong>写服务短暂不可用</strong>：从主库故障到新主库提升期间，写入请求将被阻塞或直接失败，不可用时长通常在 15秒 ～ 30秒，通常不会超过 1 分钟。</p>
<p>当从库故障时，只读流量将路由至其他从库，如果所有从库都故障，只读流量才会最终由主库承载。
从库故障的影响是 <strong>部分只读查询闪断</strong>：当前从库上正在运行查询将由于连接重置而中止，并立即由其他可用从库接管。</p>
<p>故障检测由 Patroni 和 Etcd 共同完成，集群领导者将持有一个租约，
如果集群领导者因为故障而没有及时续租（10s），租约将会被释放，并触发 <strong>故障切换</strong>（Failover） 与新一轮集群选举。</p>
<p>即使没有出现任何故障，您依然可以主动通过 <a href="/zh/docs/pgsql/admin#%E4%B8%BB%E5%8A%A8%E5%88%87%E6%8D%A2"><strong>主动切换</strong></a> （Switchover）变更集群的主库。
在这种情况下，主库上的写入查询将会闪断，并立即路由至新主库执行。这一操作通常可用于滚动维护/升级数据库服务器。</p>
<hr>
<h2 id="利弊权衡">利弊权衡</h2>
<p><strong>故障恢复时间目标</strong>（<strong>RTO</strong>）与 <strong>数据恢复点目标</strong>（<strong>RPO</strong>）是高可用集群设计时需要仔细进行利弊权衡的两个参数。</p>
<p>Pigsty 使用的 <strong>RTO</strong> 与 <strong>RPO</strong> 默认值满足绝大多数场景下的可靠性要求，您可以根据您的硬件水平，网络质量，业务需求来合理调整它们。</p>


<div class="alert alert-danger" role="alert">
<h4 class="alert-heading">RTO 与 RPO 并非越小越好！</h4>

    过小的 RTO 将增大误报几率，过小的 RPO 将降低成功自动切换的概率。

</div>

<p>故障切换时的不可用时长上限由 <a href="/zh/docs/reference/param#pg_rto"><strong><code>pg_rto</code></strong></a> 参数控制，<strong>RTO</strong> 默认值为 <code>30s</code>，增大它将导致更长的主库故障转移写入不可用时长，而减少它将增加误报故障转移率（例如，由短暂网络抖动导致的反复切换）。</p>
<p>潜在数据丢失量的上限由 <a href="/zh/docs/reference/param#pg_rpo"><strong><code>pg_rpo</code></strong></a> 参数控制，默认为 <code>1MB</code>，减小这个值可以降低故障切换时的数据损失上限，但也会增加故障时因为从库不够健康（落后太久）而拒绝自动切换的概率。</p>
<p>Pigsty 默认使用<strong>可用性优先</strong>模式，这意味着当主库故障时，它将尽快进行故障转移，尚未复制到从库的数据可能会丢失（常规万兆网络下，复制延迟在通常在几KB到100KB）。</p>
<p>如果您需要确保故障切换时不丢失任何数据，您可以使用 <a href="/zh/docs/reference/param#pg_conf"><strong><code>crit.yml</code></strong></a> 模板来确保在故障转移期间没有数据丢失，但这会牺牲一些性能作为代价。</p>
<hr>
<h2 id="相关参数">相关参数</h2>
<h3 id="pg_rtozhdocsreferenceparampg_rto"><a href="/zh/docs/reference/param#pg_rto"><strong><code>pg_rto</code></strong></a></h3>
<p>参数名称： <code>pg_rto</code>， 类型： <code>int</code>， 层次：<code>C</code></p>
<p>以秒为单位的恢复时间目标（RTO）。这将用于计算 Patroni 的 TTL 值，默认为 <code>30</code> 秒。</p>
<p>如果主实例在这么长时间内失踪，将触发新的领导者选举，此值并非越低越好，它涉及到利弊权衡：
减小这个值可以减少集群故障转移期间的不可用时间（无法写入）， 但会使集群对短期网络抖动更加敏感，从而增加误报触发故障转移的几率。
您需要根据网络状况和业务约束来配置这个值，在 <strong>故障几率</strong> 和 <strong>故障影响</strong> 之间做出<strong>权衡</strong>。</p>
<h3 id="pg_rpozhdocsreferenceparampg_rpo"><a href="/zh/docs/reference/param#pg_rpo"><strong><code>pg_rpo</code></strong></a></h3>
<p>参数名称： <code>pg_rpo</code>， 类型： <code>int</code>， 层次：<code>C</code></p>
<p>以字节为单位的恢复点目标（RPO），默认值：<code>1048576</code>。</p>
<p>默认为 1MiB，这意味着在故障转移期间最多可以容忍 1MiB 的数据丢失。</p>
<p>当主节点宕机并且所有副本都滞后时，你必须做出一个艰难的选择：
是马上提升一个从库成为新的主库，付出可接受的数据丢失代价（例如，少于 1MB），并尽快将系统恢复服务。
还是等待主库重新上线（可能永远不会）以避免任何数据丢失，或放弃自动故障切换，等人工介入作出最终决策。
您需要根据业务的需求偏好配置这个值，在 <strong>可用性</strong> 和 <strong>一致性</strong> 之间进行 <strong>利弊权衡</strong>。</p>
<p>此外，您始终可以通过启用同步提交（例如：使用 <code>crit.yml</code> 模板），通过牺牲集群一部分延迟/吞吐性能来强制确保 RPO = 0。
对于数据一致性至关重要</p>
<br>
<hr>
<br>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-397dc822a55434d21cd8ee3a6f846291">7 - 时间点恢复</h1>
    <div class="lead">Pigsty 使用 pgBackRest 实现了 PostgreSQL 时间点恢复，允许用户回滚至备份策略容许范围内的任意时间点。</div>
	<hr>
<h2 id="概览">概览</h2>
<blockquote>
<p>您可以将集群恢复回滚至过去任意时刻，避免软件缺陷与人为失误导致的数据损失。</p>
</blockquote>
<p>Pigsty 的 PostgreSQL 集群带有自动配置的时间点恢复（PITR）方案，基于备份组件 <a href="https://pgbackrest.org/"><strong>pgBackRest</strong></a> 与可选的对象存储仓库 <a href="https://min.io/"><strong>MinIO</strong></a> 提供。</p>
<p><a href="/zh/docs/concept/ha"><strong>高可用方案</strong></a> 可以解决硬件故障，但却对软件缺陷与人为失误导致的数据删除/覆盖写入/删库等问题却无能为力。
对于这种情况，Pigsty 提供了开箱即用的 <strong>时间点恢复</strong>（Point in Time Recovery, PITR）能力，无需额外配置即默认启用。</p>
<p>Pigsty 为您提供了基础备份与 WAL 归档的默认配置，您可以使用本地目录与磁盘，亦或专用的 MinIO 集群或 S3 对象存储服务来存储备份并实现异地容灾。
当您使用本地磁盘时，默认保留恢复至过去一天内的任意时间点的能力。当您使用 MinIO 或 S3 时，默认保留恢复至过去一周内的任意时间点的能力。
只要存储空间管够，您尽可保留任意长地可恢复时间段，丰俭由人。</p>
<hr>
<p><strong>时间点恢复（PITR）解决什么问题？</strong></p>
<ul>
<li>容灾能⼒增强：<strong>RPO</strong> 从 ∞ 降⾄ ⼗⼏MB， <strong>RTO</strong> 从 ∞ 降⾄ ⼏⼩时/⼏刻钟。</li>
<li>确保数据安全：C/I/A 中的 <strong>数据完整性</strong>：避免误删导致的数据⼀致性问题。</li>
<li>确保数据安全：C/I/A 中的 <strong>数据可⽤性</strong>：提供对“永久不可⽤”这种灾难情况的兜底</li>
</ul>
<table>
<thead>
<tr>
<th>单实例配置策略</th>
<th style="text-align:center">事件</th>
<th>RTO</th>
<th style="text-align:left">RPO</th>
</tr>
</thead>
<tbody>
<tr>
<td><i class="fa-solid fa-music text-danger"></i> 什么也不做</td>
<td style="text-align:center">宕机</td>
<td><i class="fas fa-circle-xmark text-danger"></i> <strong>永久丢失</strong></td>
<td style="text-align:left"><i class="fas fa-circle-xmark text-danger"></i> <strong>全部丢失</strong></td>
</tr>
<tr>
<td><i class="fa-solid fa-copy text-secondary"></i> 基础备份</td>
<td style="text-align:center">宕机</td>
<td><i class="fa-solid fa-triangle-exclamation text-secondary"></i> 取决于备份大小与带宽（几小时）</td>
<td style="text-align:left"><i class="fa-solid fa-triangle-exclamation text-secondary"></i> 丢失上一次备份后的数据（几个小时到几天）</td>
</tr>
<tr>
<td><i class="fa-solid fa-copy text-primary"></i> 基础备份 + <i class="fa-solid fa-clock-rotate-left text-primary"></i> WAL归档</td>
<td style="text-align:center">宕机</td>
<td><i class="fa-solid fa-triangle-exclamation text-primary"></i> 取决于备份大小与带宽（几小时）</td>
<td style="text-align:left"><i class="fa-solid fa-triangle-exclamation text-primary"></i> 丢失最后尚未归档的数据（几十MB）</td>
</tr>
</tbody>
</table>
<p><strong>时间点恢复有什么代价？</strong></p>
<ul>
<li>降低数据安全中的 C：<strong>机密性</strong>，产生额外泄漏点，需要额外对备份进⾏保护。</li>
<li>额外的资源消耗：本地存储或⽹络流量 / 带宽开销，通常并不是⼀个问题。</li>
<li>复杂度代价升⾼：⽤户需要付出备份管理成本。</li>
</ul>
<p><strong>时间点恢复的局限性</strong></p>
<p>如果只有 PITR 用于故障恢复，则 RTO 与 RPO 指标相比 <a href="/zh/docs/concept/ha/"><strong>高可用方案</strong></a> 更为逊色，通常应两者组合使用。</p>
<ul>
<li><strong>RTO</strong>：如果只有单机 + PITR，恢复时长取决于备份大小与网络/磁盘带宽，从十几分钟到几小时，几天不等。</li>
<li><strong>RPO</strong>：如果只有单机 + PITR，宕机时可能丢失少量数据，一个或几个 WAL 日志段文件可能尚未归档，损失 16 MB 到⼏⼗ MB 不等的数据。</li>
</ul>
<p>除了 <a href="/zh/docs/pgsql/pitr"><strong>PITR</strong></a> 之外，您还可以在 Pigsty 中使用 <a href="/zh/docs/pgsql/config#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4"><strong>延迟集群</strong></a> 来解决人为失误或软件缺陷导致的数据误删误改问题。</p>
<hr>
<h2 id="原理">原理</h2>
<p>时间点恢复允许您将集群恢复回滚至过去的“任意时刻”，避免软件缺陷与人为失误导致的数据损失。要做到这一点，首先需要做好两样准备工作：<a href="/zh/docs/concept/pitr/#基础备份"><strong>基础备份</strong></a> 与 <a href="/zh/docs/concept/pitr/#wal归档"><strong>WAL归档</strong></a>。
拥有 <strong>基础备份</strong>，允许用户将数据库恢复至备份时的状态，而同时拥有从某个基础备份开始的 <strong>WAL归档</strong>，允许用户将数据库恢复至基础备份时刻之后的任意时间点。</p>
<p><img alt="fig-10-02.png" src="/img/blog/kernel/fig-10-02.png"></p>
<p>详细原理，请参阅：<a href="/zh/blog/kernel/ch10/"><strong>基础备份与时间点恢复</strong></a>；具体操作，请参考 <a href="/zh/docs/pgsql/pitr"><strong>PGSQL管理：备份恢复</strong></a>。</p>
<h3 id="基础备份">基础备份</h3>
<p>Pigsty 使用 pgbackrest 管理 PostgreSQL 备份。pgBackRest 将在所有集群实例上初始化空仓库，但只会在集群主库上实际使用仓库。</p>
<p>pgBackRest 支持三种备份模式：<strong>全量备份</strong>，<strong>增量备份</strong>，差异备份，其中前两者最为常用。
全量备份将对数据库集群取一个当前时刻的全量物理快照，增量备份会记录当前数据库集群与上一次全量备份之间的差异。</p>
<p>Pigsty 为备份提供了封装命令：<code>/pg/bin/pg-backup [full|incr]</code>。您可以通过 Crontab 或任何其他任务调度系统，按需定期制作基础备份。</p>
<h3 id="wal归档">WAL归档</h3>
<p>Pigsty 默认在集群主库上启⽤了 WAL 归档，并使⽤ <code>pgbackrest</code> 命令行工具持续推送 WAL 段⽂件至备份仓库。</p>
<p>pgBackRest 会⾃动管理所需的 WAL ⽂件，并根据备份的保留策略及时清理过期的备份，与其对应的 WAL 归档⽂件。</p>
<p>如果您不需要 PITR 功能，可以通过 <a href="/zh/docs/pgsql/admin#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4"><strong>配置集群</strong></a>： <code>archive_mode: off</code> 来关闭 WAL 归档，移除 <a href="/zh/docs/reference/param#node_crontab"><code>node_crontab</code></a> 来停止定期备份任务。</p>
<hr>
<h2 id="实现">实现</h2>
<p>默认情况下，Pigsty提供了两种预置<a href="/zh/docs/pgsql/pitr#%E5%A4%87%E4%BB%BD%E7%AD%96%E7%95%A5">备份策略</a>：默认使用本地文件系统备份仓库，在这种情况下每天进行一次全量备份，确保用户任何时候都能回滚至一天内的任意时间点。备选策略使用专用的 MinIO 集群或S3存储备份，每周一全备，每天一增备，默认保留两周的备份与WAL归档。</p>
<p>Pigsty 使用 pgBackRest 管理备份，接收 WAL 归档，执行 PITR。备份仓库可以进行灵活配置（<a href="/zh/docs/reference/param#pgbackrest_repo"><code>pgbackrest_repo</code></a>）：默认使用主库本地文件系统（<code>local</code>），但也可以使用其他磁盘路径，或使用自带的可选 <a href="/zh/docs/minio">MinIO</a> 服务（<code>minio</code>）与云上 S3 服务。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pgbackrest_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># 在 pgsql 主机上启用 pgBackRest 吗？</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgbackrest_clean</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># 初始化时删除 pg 备份数据？</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgbackrest_log_dir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/pg/log/pgbackrest</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pgbackrest 日志目录，默认为 `/pg/log/pgbackrest`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgbackrest_method</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">local         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pgbackrest 仓库方法：local, minio, [用户定义...]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgbackrest_repo</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># pgbackrest 仓库：https://pgbackrest.org/configuration.html#section-repository</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">local</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># 默认使用本地 posix 文件系统的 pgbackrest 仓库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/pg/backup             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 本地备份目录，默认为 `/pg/backup`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">retention_full_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">count   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 按计数保留完整备份</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">retention_full</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># 使用本地文件系统仓库时，最多保留 3 个完整备份，至少保留 2 个</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">minio</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># pgbackrest 的可选 minio 仓库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3                     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio 是与 s3 兼容的，所以使用 s3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sss.pigsty      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio 端点域名，默认为 `sss.pigsty`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">us-east-1         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio 区域，默认为 us-east-1，对 minio 无效</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_bucket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio 桶名称，默认为 `pgsql`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbackrest           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pgbackrest 的 minio 用户访问密钥</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_key_secret</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">S3User.Backup </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pgbackrest 的 minio 用户秘密密钥</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_uri_style</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 对 minio 使用路径风格的 uri，而不是主机风格</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/pgbackrest            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio 备份路径，默认为 `/pgbackrest`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">storage_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9000</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># minio 端口，默认为 9000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">storage_ca_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/pki/ca.crt </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio ca 文件路径，默认为 `/etc/pki/ca.crt`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">bundle</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">y</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># 将小文件打包成一个文件</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">cipher_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aes-256-cbc     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 为远程备份仓库启用 AES 加密</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">cipher_pass</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgBackRest      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># AES 加密密码，默认为 &#39;pgBackRest&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">retention_full_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">time    </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 在 minio 仓库上按时间保留完整备份</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">retention_full</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># 保留过去 14 天的完整备份</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 您还可以添加其他的可选备份仓库，例如 S3，用于异地容灾</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Pigsty 参数 <a href="/zh/docs/reference/param#pgbackrest_repo"><code>pgbackrest_repo</code></a> 中的目标仓库会被转换为 <code>/etc/pgbackrest/pgbackrest.conf</code> 配置文件中的仓库定义。
例如，如果您定义了一个美西区的 S3 仓库用于存储冷备份，可以使用下面的参考配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">s3</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># ------&gt; /etc/pgbackrest/pgbackrest.conf</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">repo1-type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3                                  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># ----&gt; repo1-type=s3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">repo1-s3-region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">us-west-1                      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># ----&gt; repo1-s3-region=us-west-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">repo1-s3-endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3-us-west-1.amazonaws.com   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># ----&gt; repo1-s3-endpoint=s3-us-west-1.amazonaws.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">repo1-s3-key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&lt;your_access_key&gt;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># ----&gt; repo1-s3-key=&lt;your_access_key&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">repo1-s3-key-secret</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&lt;your_secret_key&gt;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># ----&gt; repo1-s3-key-secret=&lt;your_secret_key&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">repo1-s3-bucket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql                          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># ----&gt; repo1-s3-bucket=pgsql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">repo1-s3-uri-style</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">host                        </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># ----&gt; repo1-s3-uri-style=host</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">repo1-path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/pgbackrest                         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># ----&gt; repo1-path=/pgbackrest</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">repo1-bundle</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">y</span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#8f5902;font-style:italic"># ----&gt; repo1-bundle=y</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">repo1-cipher-type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aes-256-cbc                  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># ----&gt; repo1-cipher-type=aes-256-cbc</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">repo1-cipher-pass</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgBackRest                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># ----&gt; repo1-cipher-pass=pgBackRest</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">repo1-retention-full-type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">time                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># ----&gt; repo1-retention-full-type=time</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">repo1-retention-full</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">90</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#8f5902;font-style:italic"># ----&gt; repo1-retention-full=90</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="恢复">恢复</h2>
<p>您可以直接使用以下封装命令可以用于 PostgreSQL 数据库集群的 <a href="https://pgbackrest.org/command.html#command-restore">时间点恢复</a>。</p>
<p>Pigsty 默认使用增量差分并行恢复，允许您以最快速度恢复到指定时间点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg-pitr                                 <span style="color:#8f5902;font-style:italic"># 恢复到WAL存档流的结束位置（例如在整个数据中心故障的情况下使用）</span>
</span></span><span style="display:flex;"><span>pg-pitr -i                              <span style="color:#8f5902;font-style:italic"># 恢复到最近备份完成的时间（不常用）</span>
</span></span><span style="display:flex;"><span>pg-pitr --time<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2022-12-30 14:44:44+08&#34;</span> <span style="color:#8f5902;font-style:italic"># 恢复到指定的时间点（在删除数据库或表的情况下使用）</span>
</span></span><span style="display:flex;"><span>pg-pitr --name<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;my-restore-point&#34;</span>       <span style="color:#8f5902;font-style:italic"># 恢复到使用 pg_create_restore_point 创建的命名恢复点</span>
</span></span><span style="display:flex;"><span>pg-pitr --lsn<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;0/7C82CB8&#34;</span> -X            <span style="color:#8f5902;font-style:italic"># 在LSN之前立即恢复</span>
</span></span><span style="display:flex;"><span>pg-pitr --xid<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;1234567&#34;</span> -X -P           <span style="color:#8f5902;font-style:italic"># 在指定的事务ID之前立即恢复，然后将集群直接提升为主库</span>
</span></span><span style="display:flex;"><span>pg-pitr --backup<span style="color:#ce5c00;font-weight:bold">=</span>latest                 <span style="color:#8f5902;font-style:italic"># 恢复到最新的备份集</span>
</span></span><span style="display:flex;"><span>pg-pitr --backup<span style="color:#ce5c00;font-weight:bold">=</span>20221108-105325        <span style="color:#8f5902;font-style:italic"># 恢复到特定备份集，备份集可以使用 pgbackrest info 列出</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pg-pitr                                 <span style="color:#8f5902;font-style:italic"># pgbackrest --stanza=pg-meta restore</span>
</span></span><span style="display:flex;"><span>pg-pitr -i                              <span style="color:#8f5902;font-style:italic"># pgbackrest --stanza=pg-meta --type=immediate restore</span>
</span></span><span style="display:flex;"><span>pg-pitr -t <span style="color:#4e9a06">&#34;2022-12-30 14:44:44+08&#34;</span>     <span style="color:#8f5902;font-style:italic"># pgbackrest --stanza=pg-meta --type=time --target=&#34;2022-12-30 14:44:44+08&#34; restore</span>
</span></span><span style="display:flex;"><span>pg-pitr -n <span style="color:#4e9a06">&#34;my-restore-point&#34;</span>           <span style="color:#8f5902;font-style:italic"># pgbackrest --stanza=pg-meta --type=name --target=my-restore-point restore</span>
</span></span><span style="display:flex;"><span>pg-pitr -b 20221108-105325F             <span style="color:#8f5902;font-style:italic"># pgbackrest --stanza=pg-meta --type=name --set=20221230-120101F restore</span>
</span></span><span style="display:flex;"><span>pg-pitr -l <span style="color:#4e9a06">&#34;0/7C82CB8&#34;</span> -X               <span style="color:#8f5902;font-style:italic"># pgbackrest --stanza=pg-meta --type=lsn --target=&#34;0/7C82CB8&#34; --target-exclusive restore</span>
</span></span><span style="display:flex;"><span>pg-pitr -x <span style="color:#0000cf;font-weight:bold">1234567</span> -X -P                <span style="color:#8f5902;font-style:italic"># pgbackrest --stanza=pg-meta --type=xid --target=&#34;0/7C82CB8&#34; --target-exclusive --target-action=promote restore</span>
</span></span></code></pre></div><p>在执行 PITR 时，您可以使用 Pigsty 监控系统观察集群 LSN 位点状态，判断是否成功恢复到指定的时间点，事务点，LSN位点，或其他点位。</p>
<p><img alt="pitr" src="/img/docs/concept/pitr.png"></p>
<br>
<hr>
<br>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-76a748b4626218b8ec1cb5db2047eae1">8 - 服务接入</h1>
    <div class="lead">Pigsty 使用 HAProxy 提供服务接入，并提供可选的 pgBouncer 池化连接，以及可选的 L2 VIP 与 DNS 接入。</div>
	<blockquote>
<p>分离读写操作，正确路由流量，稳定可靠地交付 PostgreSQL 集群提供的能力。</p>
</blockquote>
<p><a href="/zh/docs/concept/svc/#服务概述">服务</a>是一种抽象：它是数据库集群对外提供能力的形式，并封装了底层集群的细节。</p>
<p>服务对于生产环境中的<a href="/zh/docs/concept/svc/#接入服务">稳定接入</a>至关重要，在<a href="/zh/docs/concept/ha">高可用</a>集群自动故障时方显其价值，<a href="%E5%8D%95%E6%9C%BA%E7%94%A8%E6%88%B7">单机用户</a>通常不需要操心这个概念。</p>
<hr>
<h2 id="单机用户">单机用户</h2>
<p>“服务” 的概念是给生产环境用的，个人用户/单机集群可以不折腾，直接拿实例名/IP地址访问数据库。</p>
<p>例如，Pigsty 默认的单节点 <code>pg-meta</code>.<code>meta</code> 数据库，就可以直接用下面三个不同的用户连接上去。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10/meta     <span style="color:#8f5902;font-style:italic"># 直接用 DBA 超级用户连上去</span>
</span></span><span style="display:flex;"><span>psql postgres://dbuser_meta:DBUser.Meta@10.10.10.10/meta   <span style="color:#8f5902;font-style:italic"># 用默认的业务管理员用户连上去</span>
</span></span><span style="display:flex;"><span>psql postgres://dbuser_view:DBUser.View@pg-meta/meta       <span style="color:#8f5902;font-style:italic"># 用默认的只读用户走实例域名连上去</span>
</span></span></code></pre></div><hr>
<h2 id="服务概述">服务概述</h2>
<p>在真实世界生产环境中，我们会使用基于复制的主从数据库集群。集群中有且仅有一个实例作为领导者（<a href="/zh/docs/pgsql/config#%E8%AF%BB%E5%86%99%E4%B8%BB%E5%BA%93">主库</a>）可以接受写入。
而其他实例（<a href="/zh/docs/pgsql/config#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93">从库</a>）则会从持续从集群领导者获取变更日志，与领导者保持一致。同时，从库还可以承载只读请求，在读多写少的场景下可以显著分担主库的负担，
因此对集群的写入请求与只读请求进行区分，是一种十分常见的实践。</p>
<p>此外对于高频短连接的生产环境，我们还会通过连接池中间件（Pgbouncer）对请求进行池化，减少连接与后端进程的创建开销。但对于ETL与变更执行等场景，我们又需要绕过连接池，直接访问数据库。
同时，高可用集群在故障时会出现故障切换（Failover），故障切换会导致集群的领导者出现变更。因此高可用的数据库方案要求写入流量可以自动适配集群的领导者变化。
这些不同的访问需求（读写分离，池化与直连，故障切换自动适配）最终抽象出 <strong>服务</strong> （Service）的概念。</p>
<p>通常来说，数据库集群都必须提供这种最基础的服务：</p>
<ul>
<li><strong>读写服务（primary）</strong> ：可以读写数据库</li>
</ul>
<p>对于生产数据库集群，至少应当提供这两种服务：</p>
<ul>
<li><strong>读写服务（primary）</strong> ：写入数据：只能由主库所承载。</li>
<li><strong>只读服务（replica）</strong> ：读取数据：可以由从库承载，没有从库时也可由主库承载</li>
</ul>
<p>此外，根据具体的业务场景，可能还会有其他的服务，例如：</p>
<ul>
<li><strong>默认直连服务（default）</strong> ：允许（管理）用户，绕过连接池直接访问数据库的服务</li>
<li><strong>离线从库服务（offline）</strong> ：不承接线上只读流量的专用从库，用于ETL与分析查询</li>
<li><strong>同步从库服务（standby）</strong> ：没有复制延迟的只读服务，由<a href="/zh/docs/pgsql/config#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93">同步备库</a>/主库处理只读查询</li>
<li><strong>延迟从库服务（delayed）</strong> ：访问同一个集群在一段时间之前的旧数据，由<a href="/zh/docs/pgsql/config#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4">延迟从库</a>来处理</li>
</ul>
<hr>
<h2 id="接入服务">接入服务</h2>
<p>Pigsty的服务交付边界止步于集群的HAProxy，用户可以用各种手段访问这些负载均衡器。</p>
<p>典型的做法是使用 DNS 或 VIP 接入，将其绑定在集群所有或任意数量的负载均衡器上。</p>
<p><img alt="pigsty-access.jpg" src="/img/pigsty/access.jpg"></p>
<p>你可以使用不同的 主机 &amp; 端口 组合，它们以不同的方式提供 PostgreSQL 服务。</p>
<p><strong>主机</strong></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>样例</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>集群域名</td>
<td><code>pg-test</code></td>
<td>通过集群域名访问（由 dnsmasq @ infra 节点解析）</td>
</tr>
<tr>
<td>集群 VIP 地址</td>
<td><code>10.10.10.3</code></td>
<td>通过由 <code>vip-manager</code> 管理的 L2 VIP 地址访问，绑定到主节点</td>
</tr>
<tr>
<td>实例主机名</td>
<td><code>pg-test-1</code></td>
<td>通过任何实例主机名访问（由 dnsmasq @ infra 节点解析）</td>
</tr>
<tr>
<td>实例 IP 地址</td>
<td><code>10.10.10.11</code></td>
<td>访问任何实例的 IP 地址</td>
</tr>
</tbody>
</table>
<p><strong>端口</strong></p>
<p>Pigsty 使用不同的 <strong>端口</strong> 来区分 <a href="/zh/docs/concept/svc/#服务概述">pg services</a></p>
<table>
<thead>
<tr>
<th>端口</th>
<th>服务</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>5432</td>
<td>postgres</td>
<td>数据库</td>
<td>直接访问 postgres 服务器</td>
</tr>
<tr>
<td>6432</td>
<td>pgbouncer</td>
<td>中间件</td>
<td>访问 postgres 前先通过连接池中间件</td>
</tr>
<tr>
<td>5433</td>
<td>primary</td>
<td>服务</td>
<td>访问主 pgbouncer (或 postgres)</td>
</tr>
<tr>
<td>5434</td>
<td>replica</td>
<td>服务</td>
<td>访问备份 pgbouncer (或 postgres)</td>
</tr>
<tr>
<td>5436</td>
<td>default</td>
<td>服务</td>
<td>访问主 postgres</td>
</tr>
<tr>
<td>5438</td>
<td>offline</td>
<td>服务</td>
<td>访问离线 postgres</td>
</tr>
</tbody>
</table>
<p><strong>组合</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过集群域名访问</span>
</span></span><span style="display:flex;"><span>postgres://test@pg-test:5432/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; L2 VIP -&gt; 主直接连接</span>
</span></span><span style="display:flex;"><span>postgres://test@pg-test:6432/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; L2 VIP -&gt; 主连接池 -&gt; 主</span>
</span></span><span style="display:flex;"><span>postgres://test@pg-test:5433/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 主连接池 -&gt; 主</span>
</span></span><span style="display:flex;"><span>postgres://test@pg-test:5434/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 备份连接池 -&gt; 备份</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_dba@pg-test:5436/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 主直接连接 (用于管理员)</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_stats@pg-test:5438/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 离线直接连接 (用于 ETL/个人查询)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过集群 VIP 直接访问</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.3:5432/test <span style="color:#8f5902;font-style:italic"># L2 VIP -&gt; 主直接访问</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.3:6432/test <span style="color:#8f5902;font-style:italic"># L2 VIP -&gt; 主连接池 -&gt; 主</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.3:5433/test <span style="color:#8f5902;font-style:italic"># L2 VIP -&gt; HAProxy -&gt; 主连接池 -&gt; 主</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.3:5434/test <span style="color:#8f5902;font-style:italic"># L2 VIP -&gt; HAProxy -&gt; 备份连接池 -&gt; 备份</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_dba@10.10.10.3:5436/test <span style="color:#8f5902;font-style:italic"># L2 VIP -&gt; HAProxy -&gt; 主直接连接 (用于管理员)</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_stats@10.10.10.3::5438/test <span style="color:#8f5902;font-style:italic"># L2 VIP -&gt; HAProxy -&gt; 离线直接连接 (用于 ETL/个人查询)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 直接指定任何集群实例名</span>
</span></span><span style="display:flex;"><span>postgres://test@pg-test-1:5432/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; 数据库实例直接连接 (单例访问)</span>
</span></span><span style="display:flex;"><span>postgres://test@pg-test-1:6432/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; 连接池 -&gt; 数据库</span>
</span></span><span style="display:flex;"><span>postgres://test@pg-test-1:5433/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; HAProxy -&gt; 连接池 -&gt; 数据库读/写</span>
</span></span><span style="display:flex;"><span>postgres://test@pg-test-1:5434/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; HAProxy -&gt; 连接池 -&gt; 数据库只读</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_dba@pg-test-1:5436/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; HAProxy -&gt; 数据库直接连接</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_stats@pg-test-1:5438/test <span style="color:#8f5902;font-style:italic"># DNS -&gt; HAProxy -&gt; 数据库离线读/写</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 直接指定任何集群实例 IP 访问</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.11:5432/test <span style="color:#8f5902;font-style:italic"># 数据库实例直接连接 (直接指定实例, 没有自动流量分配)</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.11:6432/test <span style="color:#8f5902;font-style:italic"># 连接池 -&gt; 数据库</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.11:5433/test <span style="color:#8f5902;font-style:italic"># HAProxy -&gt; 连接池 -&gt; 数据库读/写</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.11:5434/test <span style="color:#8f5902;font-style:italic"># HAProxy -&gt; 连接池 -&gt; 数据库只读</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_dba@10.10.10.11:5436/test <span style="color:#8f5902;font-style:italic"># HAProxy -&gt; 数据库直接连接</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_stats@10.10.10.11:5438/test <span style="color:#8f5902;font-style:italic"># HAProxy -&gt; 数据库离线读-写</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 智能客户端：通过URL读写分离</span>
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style="color:#ce5c00;font-weight:bold">=</span>primary
</span></span><span style="display:flex;"><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style="color:#ce5c00;font-weight:bold">=</span>prefer-standby
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5c7e49f373a8b6df52fbd9bec4787528">9 - 访问控制</h1>
    <div class="lead">Pigsty 提供了标准的安全实践：密码与证书认证，开箱即用的权限模型，SSL加密网络流量，加密远程冷备份等。</div>
	<blockquote>
<p>Pigsty 提供了一套开箱即用的，基于<a href="/zh/docs/concept/ac/#角色系统">角色系统</a>和<a href="/zh/docs/concept/ac/#权限系统">权限系统</a>的访问控制模型。</p>
</blockquote>
<p>权限控制很重要，但很多用户做不好。因此 Pigsty 提供了一套开箱即用的精简访问控制模型，为您的集群安全性提供一个兜底。</p>
<hr>
<h2 id="角色系统">角色系统</h2>
<p>Pigsty 默认的角色系统包含四个<a href="/zh/docs/concept/ac/#默认角色">默认角色</a>和四个<a href="/zh/docs/concept/ac/#默认用户">默认用户</a>：</p>
<table>
<thead>
<tr>
<th>角色名称</th>
<th>属性</th>
<th>所属</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dbrole_readonly</code></td>
<td><code>NOLOGIN</code></td>
<td></td>
<td>角色：全局只读访问</td>
</tr>
<tr>
<td><code>dbrole_readwrite</code></td>
<td><code>NOLOGIN</code></td>
<td>dbrole_readonly</td>
<td>角色：全局读写访问</td>
</tr>
<tr>
<td><code>dbrole_admin</code></td>
<td><code>NOLOGIN</code></td>
<td>pg_monitor,dbrole_readwrite</td>
<td>角色：管理员/对象创建</td>
</tr>
<tr>
<td><code>dbrole_offline</code></td>
<td><code>NOLOGIN</code></td>
<td></td>
<td>角色：受限的只读访问</td>
</tr>
<tr>
<td><code>postgres</code></td>
<td><code>SUPERUSER</code></td>
<td></td>
<td>系统超级用户</td>
</tr>
<tr>
<td><code>replicator</code></td>
<td><code>REPLICATION</code></td>
<td>pg_monitor,dbrole_readonly</td>
<td>系统复制用户</td>
</tr>
<tr>
<td><code>dbuser_dba</code></td>
<td><code>SUPERUSER</code></td>
<td>dbrole_admin</td>
<td>pgsql 管理用户</td>
</tr>
<tr>
<td><code>dbuser_monitor</code></td>
<td></td>
<td>pg_monitor</td>
<td>pgsql 监控用户</td>
</tr>
</tbody>
</table>
<p>这些<a href="/zh/docs/pgsql/user#%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7">角色与用户</a>的详细定义如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_default_roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># 全局默认的角色与系统用户</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_readonly  ,login: false ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for global read-only access     }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_offline   ,login: false ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for restricted read-only access }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for global read-write access }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for object creation }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: postgres     ,superuser: true  ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system superuser }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system replicator }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_monitor ,roles: [pg_monitor] ,pgbouncer: true ,parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql monitor user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="默认角色">默认角色</h2>
<p>Pigsty 中有四个默认角色：</p>
<ul>
<li>业务只读 (<code>dbrole_readonly</code>): 用于全局只读访问的角色。如果别的业务想要此库只读访问权限，可以使用此角色。</li>
<li>业务读写 (<code>dbrole_readwrite</code>): 用于全局读写访问的角色，主属业务使用的生产账号应当具有数据库读写权限</li>
<li>业务管理员 (<code>dbrole_admin</code>): 拥有DDL权限的角色，通常用于业务管理员，或者需要在应用中建表的场景（比如各种业务软件）</li>
<li>离线只读访问 (<code>dbrole_offline</code>): 受限的只读访问角色（只能访问 <a href="/zh/docs/pgsql/config#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93">offline</a> 实例，通常是个人用户，ETL工具账号）</li>
</ul>
<p>默认角色在 <a href="/zh/docs/reference/param#pg_default_roles"><code>pg_default_roles</code></a> 中定义，除非您确实知道自己在干什么，建议不要更改默认角色的名称。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_readonly  , login: false , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for global read-only access  }                           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 生产环境的只读角色</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_offline ,   login: false , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for restricted read-only access (offline instance) }     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 受限的只读角色</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_readwrite , login: false , roles: [dbrole_readonly], comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for global read-write access } </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 生产环境的读写角色</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_admin , login: false , roles: [pg_monitor, dbrole_readwrite] , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for object creation }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 生产环境的 DDL 更改角色</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="默认用户">默认用户</h2>
<p>Pigsty 也有四个默认用户（系统用户）：</p>
<ul>
<li>超级用户 (<code>postgres</code>)，集群的所有者和创建者，与操作系统 dbsu 名称相同。</li>
<li>复制用户 (<code>replicator</code>)，用于主-从复制的系统用户。</li>
<li>监控用户 (<code>dbuser_monitor</code>)，用于监控数据库和连接池指标的用户。</li>
<li>管理用户 (<code>dbuser_dba</code>)，执行日常操作和数据库更改的管理员用户。</li>
</ul>
<p>这4个默认用户的用户名/密码通过4对专用参数进行定义，并在很多地方引用：</p>
<ul>
<li><a href="/zh/docs/reference/param#pg_dbsu"><code>pg_dbsu</code></a>：操作系统 dbsu 名称，默认为 postgres，最好不要更改它</li>
<li><a href="/zh/docs/reference/param#pg_dbsu_password"><code>pg_dbsu_password</code></a>：dbsu 密码，默认为空字符串意味着不设置 dbsu 密码，最好不要设置。</li>
<li><a href="/zh/docs/reference/param#pg_replication_username"><code>pg_replication_username</code></a>：postgres 复制用户名，默认为 <code>replicator</code></li>
<li><a href="/zh/docs/reference/param#pg_replication_password"><code>pg_replication_password</code></a>：postgres 复制密码，默认为 <code>DBUser.Replicator</code></li>
<li><a href="/zh/docs/reference/param#pg_admin_username"><code>pg_admin_username</code></a>：postgres 管理员用户名，默认为 <code>dbuser_dba</code></li>
<li><a href="/zh/docs/reference/param#pg_admin_password"><code>pg_admin_password</code></a>：postgres 管理员密码的明文，默认为 <code>DBUser.DBA</code></li>
<li><a href="/zh/docs/reference/param#pg_monitor_username"><code>pg_monitor_username</code></a>：postgres 监控用户名，默认为 <code>dbuser_monitor</code></li>
<li><a href="/zh/docs/reference/param#pg_monitor_password"><code>pg_monitor_password</code></a>：postgres 监控密码，默认为 <code>DBUser.Monitor</code></li>
</ul>
<blockquote>
<p><strong>在生产部署中记得更改这些密码，不要使用默认值！</strong></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_dbsu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres                            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 数据库超级用户名，这个用户名建议不要修改。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_dbsu_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&#39;</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># 数据库超级用户密码，这个密码建议留空！禁止dbsu密码登陆。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_replication_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replicator          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 系统复制用户名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_replication_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Replicator   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 系统复制密码，请务必修改此密码！</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_monitor_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 系统监控用户名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_monitor_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Monitor          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 系统监控密码，请务必修改此密码！</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_admin_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_dba                </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 系统管理用户名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_admin_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.DBA                </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 系统管理密码，请务必修改此密码！</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>如果您修改默认用户的参数，在 <a href="/zh/docs/reference/param#pg_default_roles"><code>pg_default_roles</code></a> 中修改相应的角色<a href="/zh/docs/pgsql/user#%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7">定义</a>即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: postgres     ,superuser: true                                          ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system superuser }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system replicator }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_monitor   ,roles: [pg_monitor, dbrole_readonly] ,pgbouncer: true ,parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql monitor user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="权限系统">权限系统</h2>
<p>Pigsty 拥有一套开箱即用的权限模型，该模型与<a href="/zh/docs/concept/ac/#default-roles">默认角色</a>一起配合工作。</p>
<ul>
<li>所有用户都可以访问所有模式。</li>
<li>只读用户（<code>dbrole_readonly</code>）可以从所有表中读取数据。（SELECT，EXECUTE）</li>
<li>读写用户（<code>dbrole_readwrite</code>）可以向所有表中写入数据并运行 DML。（INSERT，UPDATE，DELETE）。</li>
<li>管理员用户（<code>dbrole_admin</code>）可以创建对象并运行 DDL（CREATE，USAGE，TRUNCATE，REFERENCES，TRIGGER）。</li>
<li>离线用户（<code>dbrole_offline</code>）类似只读用户，但访问受到限制，只允许访问<a href="/zh/docs/pgsql/config#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93">离线实例</a>（<code>pg_role = 'offline'</code> 或 <code>pg_offline_query = true</code>）</li>
<li>由管理员用户创建的对象将具有正确的权限。</li>
<li>所有数据库上都配置了默认权限，包括模板数据库。</li>
<li>数据库连接权限由数据库<a href="/zh/docs/pgsql/db#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93">定义</a>管理。</li>
<li>默认撤销<code>PUBLIC</code>在数据库和<code>public</code>模式下的<code>CREATE</code>权限。</li>
</ul>
<hr>
<h2 id="对象权限">对象权限</h2>
<p>数据库中新建对象的默认权限由参数 <a href="/zh/docs/reference/param#pg_default_privileges"><code>pg_default_privileges</code></a> 所控制：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#000">GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>由管理员<strong>新创建</strong>的对象，默认将会上述权限。使用 <code>\ddp+</code> 可以查看这些默认权限：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>访问权限</th>
</tr>
</thead>
<tbody>
<tr>
<td>函数</td>
<td>=X</td>
</tr>
<tr>
<td></td>
<td>dbrole_readonly=X</td>
</tr>
<tr>
<td></td>
<td>dbrole_offline=X</td>
</tr>
<tr>
<td></td>
<td>dbrole_admin=X</td>
</tr>
<tr>
<td>模式</td>
<td>dbrole_readonly=U</td>
</tr>
<tr>
<td></td>
<td>dbrole_offline=U</td>
</tr>
<tr>
<td></td>
<td>dbrole_admin=UC</td>
</tr>
<tr>
<td>序列号</td>
<td>dbrole_readonly=r</td>
</tr>
<tr>
<td></td>
<td>dbrole_offline=r</td>
</tr>
<tr>
<td></td>
<td>dbrole_readwrite=wU</td>
</tr>
<tr>
<td></td>
<td>dbrole_admin=rwU</td>
</tr>
<tr>
<td>表</td>
<td>dbrole_readonly=r</td>
</tr>
<tr>
<td></td>
<td>dbrole_offline=r</td>
</tr>
<tr>
<td></td>
<td>dbrole_readwrite=awd</td>
</tr>
<tr>
<td></td>
<td>dbrole_admin=arwdDxt</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="默认权限">默认权限</h2>
<p>SQL 语句 <a href="https://www.postgresql.org/docs/current/sql-alterdefaultprivileges.html"><code>ALTER DEFAULT PRIVILEGES</code></a> 允许您设置将来创建的对象的权限。 它不会影响已经存在对象的权限，也不会影响非管理员用户创建的对象。</p>
<p>在 Pigsty 中，默认权限针对三个角色进行定义：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_default_privileges</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIVILEGES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_dbsu</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}}</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">endfor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_default_privileges</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIVILEGES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_admin_username</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}}</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">endfor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 对于其他业务管理员而言，它们应当在执行 DDL 前执行 SET ROLE dbrole_admin，从而使用对应的默认权限配置。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_default_privileges</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIVILEGES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;dbrole_admin&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}}</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">endfor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>这些内容将会被 PG集群初始化模板 <a href="https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql"><code>pg-init-template.sql</code></a> 所使用，在集群初始化的过程中渲染并输出至 <code>/pg/tmp/pg-init-template.sql</code>。
该命令会在 <code>template1</code> 与 <code>postgres</code> 数据库中执行，新创建的数据库会通过模板 <code>template1</code> 继承这些默认权限配置。</p>
<p>也就是说，为了维持正确的对象权限，您必须用<strong>管理员用户</strong>来执行 DDL，它们可以是：</p>
<ol>
<li><a href="/zh/docs/reference/param#pg_dbsu"><code>{{ pg_dbsu }}</code></a>，默认为 <code>postgres</code></li>
<li><a href="/zh/docs/reference/param#pg_admin_username"><code>{{ pg_admin_username }}</code></a>，默认为 <code>dbuser_dba</code></li>
<li>授予了 <code>dbrole_admin</code> 角色的业务管理员用户（通过 <code>SET ROLE</code> 切换为 <code>dbrole_admin</code> 身份）。</li>
</ol>
<p>使用 <code>postgres</code> 作为全局对象所有者是明智的。如果您希望以业务管理员用户身份创建对象，创建之前必须使用 <code>SET ROLE dbrole_admin</code> 来维护正确的权限。</p>
<p>当然，您也可以在数据库中通过 <code>ALTER DEFAULT PRIVILEGE FOR ROLE &lt;some_biz_admin&gt; XXX</code> 来显式对业务管理员授予默认权限。</p>
<hr>
<h2 id="数据库权限">数据库权限</h2>
<p>在 Pigsty 中，数据库（Database）层面的权限在<a href="/zh/docs/concept/ac/#定义数据库">数据库定义</a>中被涵盖。</p>
<p>数据库有三个级别的权限：<code>CONNECT</code>、<code>CREATE</code>、<code>TEMP</code>，以及一个特殊的&rsquo;权限&rsquo;：<code>OWNERSHIP</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta        </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 必选，`name` 是数据库定义中唯一的必选字段</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选，数据库所有者，默认为 postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">allowconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 可选，是否允许连接，默认为 true。显式设置 false 将完全禁止连接到此数据库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">revokeconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 可选，撤销公共连接权限。默认为 false，设置为 true 时，属主和管理员之外用户的 CONNECT 权限会被回收</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>如果 <code>owner</code> 参数存在，它作为数据库属主，替代默认的 <a href="/zh/docs/reference/param#pg_dbsu"><code>{{ pg_dbsu }}</code></a>（通常也就是<code>postgres</code>）</li>
<li>如果 <code>revokeconn</code> 为 <code>false</code>，所有用户都有数据库的 <code>CONNECT</code> 权限，这是默认的行为。</li>
<li>如果显式设置了 <code>revokeconn</code> 为 <code>true</code>：
<ul>
<li>数据库的 <code>CONNECT</code> 权限将从 <code>PUBLIC</code> 中撤销：普通用户无法连接上此数据库</li>
<li><code>CONNECT</code> 权限将被显式授予 <code>{{ pg_replication_username }}</code>、<code>{{ pg_monitor_username }}</code> 和 <code>{{ pg_admin_username }}</code></li>
<li><code>CONNECT</code> 权限将 <code>GRANT OPTION</code> 被授予数据库属主，数据库属主用户可以自行授权其他用户连接权限。</li>
</ul>
</li>
<li><code>revokeconn</code> 选项可用于在同一个集群间隔离跨数据库访问，您可以为每个数据库创建不同的业务用户作为属主，并为它们设置 <code>revokeconn</code> 选项。</li>
</ul>
<details><summary>示例：数据库隔离</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-infra</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.40</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.41</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role: replica , pg_offline_query</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-infra</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_confluence, password: mc2iohos , pgbouncer: true, roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_admin ] }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_gitlab, password: sdf23g22sfdd , pgbouncer: true, roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_readwrite ] }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_jira, password: sdpijfsfdsfdfs , pgbouncer: true, roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_admin ] }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: confluence , revokeconn: true, owner: dbuser_confluence , connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: gitlab , revokeconn: true, owner: dbuser_gitlab, connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: jira , revokeconn: true, owner: dbuser_jira , connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></details>
<hr>
<h2 id="create权限">CREATE权限</h2>
<p>出于安全考虑，Pigsty 默认从 <code>PUBLIC</code> 撤销数据库上的 <code>CREATE</code> 权限，从 PostgreSQL 15 开始这也是默认行为。</p>
<p>数据库属主总是可以根据实际需要，来自行调整 CREATE 权限。</p>

</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Mail" aria-label="Mail">
    <a target="_blank" rel="noopener" href="mailto:rh@vonng.com" aria-label="Mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Vonng/pigsty" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://twitter.com/GobeUncleWang" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="WeChat" aria-label="WeChat">
    <a target="_blank" rel="noopener" href="/img/pigsty/pigsty-cc.jpg" aria-label="WeChat">
      <i class="fa fa-comment"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Discord" aria-label="Discord">
    <a target="_blank" rel="noopener" href="https://discord.gg/wDzt5VyWEz" aria-label="Discord">
      <i class="fab fa-discord"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Telegram" aria-label="Telegram">
    <a target="_blank" rel="noopener" href="https://t.me/joinchat/gV9zfZraNPM3YjFh" aria-label="Telegram">
      <i class="fab fa-telegram"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2018&ndash;2024
    <span class="td-footer__authors">Ruohang Feng</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span></span><span class="ms-2"><a href="https://vonng.com/en/" target="_blank" rel="noopener">@Vonng</a></span>
<br><span>Pigsty® distributed under <a href="/docs/about/license" target="_blank" rel="noopener">AGPLv3</a></span>
<br><span class="ms-2"><a href="/docs/about/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
<span><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">浙ICP备15016890号</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.248655eb216150e39da254c2f7aa5357805d0ec66bdb741b591cd35fb5f629ab.js" integrity="sha256-JIZV6yFhUOOdolTC96pTV4BdDsZr23QbWRzTX7X2Kas=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
