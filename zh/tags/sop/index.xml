<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Pigsty – SOP</title>
    <link>/zh/tags/sop/</link>
    <description>Recent content in SOP on Pigsty</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh</language>
    
	  <atom:link href="/zh/tags/sop/index.xml" rel="self" type="application/rss+xml" />
    
    
      
        
      
    
    
    <item>
      <title>Docs: 管理预案</title>
      <link>/zh/docs/pgsql/admin/</link>
      <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
      
      <guid>/zh/docs/pgsql/admin/</guid>
      <description>
        
        
        &lt;blockquote&gt;
&lt;p&gt;本文整理了 Pigsty 中常用的 PostgreSQL 管理预案，用于维护生产环境中的数据库集群。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;这里是一些常见 PostgreSQL 管理任务的 SOP 预案：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;案例1：  &lt;a href=&#34;/zh/docs/pgsql/admin/#创建集群&#34;&gt;创建集群&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;案例2：  &lt;a href=&#34;/zh/docs/pgsql/admin/#创建用户&#34;&gt;创建用户&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;案例3：  &lt;a href=&#34;/zh/docs/pgsql/admin/#创建数据库&#34;&gt;创建数据库&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;案例4：  &lt;a href=&#34;/zh/docs/pgsql/admin/#重载服务&#34;&gt;重载服务&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;案例5：  &lt;a href=&#34;/zh/docs/pgsql/admin/#重载HBA&#34;&gt;重载HBA&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;案例6：  &lt;a href=&#34;/zh/docs/pgsql/admin/#配置集群&#34;&gt;配置集群&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;案例7：  &lt;a href=&#34;/zh/docs/pgsql/admin/#添加实例&#34;&gt;添加实例&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;案例8：  &lt;a href=&#34;/zh/docs/pgsql/admin/#移除实例&#34;&gt;移除实例&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;案例9：  &lt;a href=&#34;/zh/docs/pgsql/admin/#下线集群&#34;&gt;下线集群&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;案例10： &lt;a href=&#34;/zh/docs/pgsql/admin/#主动切换&#34;&gt;主动切换&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;案例11： &lt;a href=&#34;/zh/docs/pgsql/admin/#备份集群&#34;&gt;备份集群&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;案例12： &lt;a href=&#34;/zh/docs/pgsql/admin/#恢复集群&#34;&gt;恢复集群&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;案例13： &lt;a href=&#34;/zh/docs/pgsql/admin/#添加软件&#34;&gt;添加软件&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;案例14： &lt;a href=&#34;/zh/docs/pgsql/admin/#安装扩展&#34;&gt;安装扩展&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;案例15： &lt;a href=&#34;/zh/docs/pgsql/admin/#小版本升级&#34;&gt;小版本升级&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;案例16： &lt;a href=&#34;/zh/docs/pgsql/admin/#大版本升级&#34;&gt;大版本升级&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id=&#34;命令速查&#34;&gt;命令速查&lt;/h2&gt;
&lt;p&gt;PGSQL 剧本与快捷方式：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-add   &amp;lt;cls&amp;gt;                   &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 创建 pgsql 集群 &amp;lt;cls&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-user  &amp;lt;cls&amp;gt; &amp;lt;username&amp;gt;        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在 &amp;lt;cls&amp;gt; 上创建 pg 用户 &amp;lt;username&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-db    &amp;lt;cls&amp;gt; &amp;lt;dbname&amp;gt;          &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在 &amp;lt;cls&amp;gt; 上创建 pg 数据库 &amp;lt;dbname&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-svc   &amp;lt;cls&amp;gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;...ip&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;           &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重新加载集群 &amp;lt;cls&amp;gt; 的 pg 服务&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-hba   &amp;lt;cls&amp;gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;...ip&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;           &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重新加载集群 &amp;lt;cls&amp;gt; 的 postgres/pgbouncer HBA 规则&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-add   &amp;lt;cls&amp;gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;...ip&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;           &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 为集群 &amp;lt;cls&amp;gt; 添加从库副本&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-rm    &amp;lt;cls&amp;gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;...ip&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;           &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 从集群 &amp;lt;cls&amp;gt; 移除实例&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-rm    &amp;lt;cls&amp;gt;                   &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 删除 pgsql 集群 &amp;lt;cls&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Patroni 管理命令与快捷方式：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg list        &amp;lt;cls&amp;gt;                    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 打印集群信息&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg edit-config &amp;lt;cls&amp;gt;                    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 编辑集群配置&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg reload      &amp;lt;cls&amp;gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;ins&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;              &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重新加载集群配置&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg restart     &amp;lt;cls&amp;gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;ins&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;              &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重启 PostgreSQL 集群&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg reinit      &amp;lt;cls&amp;gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;ins&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;              &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重新初始化集群成员&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg pause       &amp;lt;cls&amp;gt;                    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 进入维护模式（自动故障转移暂停）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg resume      &amp;lt;cls&amp;gt;                    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 退出维护模式&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg switchover  &amp;lt;cls&amp;gt;                    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在集群 &amp;lt;cls&amp;gt; 上进行主动主从切换（主库健康）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg failover    &amp;lt;cls&amp;gt;                    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在集群 &amp;lt;cls&amp;gt; 上进行故障转移（主库故障）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;pgBackRest 备份/恢复命令与快捷方式：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pb info                                 &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 打印 pgbackrest 备份仓库信息&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-backup                               &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 进行备份，默认进行增量备份，如果没有完整备份过就做全量备份&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-backup full                          &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 进行全量备份&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-backup diff                          &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 进行差异备份&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-backup incr                          &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 进行增量备份&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-pitr -i                              &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 恢复到最近备份完成的时间（不常用）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-pitr --time&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;2022-12-30 14:44:44+08&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 恢复到特定时间点（如在删除数据库或表的情况下）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-pitr --name&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;my-restore-point&amp;#34;&lt;/span&gt;       &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 恢复到由 pg_create_restore_point 创建的命名还原点&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-pitr --lsn&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;0/7C82CB8&amp;#34;&lt;/span&gt; -X            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 恢复到 LSN 之前&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-pitr --xid&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;1234567&amp;#34;&lt;/span&gt; -X -P           &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 恢复到特定的事务ID之前，然后将其提升为主库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-pitr --backup&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;latest                 &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 恢复到最新的备份集&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-pitr --backup&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;20221108-105325        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 恢复到特定的备份集，使用名称指定，可以使用 pgbackrest info 进行检查&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;使用 Systemd 管理系统组件的命令：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;systemctl stop patroni                  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 启动 停止 重启 重载&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;systemctl stop pgbouncer                &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 启动 停止 重启 重载&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;systemctl stop pg_exporter              &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 启动 停止 重启 重载&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;systemctl stop pgbouncer_exporter       &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 启动 停止 重启 重载&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;systemctl stop node_exporter            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 启动 停止 重启&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;systemctl stop haproxy                  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 启动 停止 重启 重载&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;systemctl stop vip-manager              &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 启动 停止 重启 重载&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;systemctl stop postgres                 &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 仅当 patroni_mode == &amp;#39;remove&amp;#39; 时使用这个服务&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id=&#34;创建集群&#34;&gt;创建集群&lt;/h2&gt;
&lt;p&gt;要创建一个新的Postgres集群，请首先在配置清单中定义，然后进行初始化：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/node-add &amp;lt;cls&amp;gt;                &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 为集群 &amp;lt;cls&amp;gt; 初始化节点                  # ./node.yml  -l &amp;lt;cls&amp;gt; &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-add &amp;lt;cls&amp;gt;               &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 初始化集群 &amp;lt;cls&amp;gt; 的pgsql实例             # ./pgsql.yml -l &amp;lt;cls&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;请注意，PGSQL 模块需要在 Pigsty 纳管的节点上安装，请先使用 &lt;code&gt;bin/node-add&lt;/code&gt; 纳管节点。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;details&gt;&lt;summary&gt;示例：创建集群&lt;/summary&gt;
&lt;p&gt;&lt;a href=&#34;https://asciinema.org/a/568810&#34;&gt;&lt;img alt=&#34;asciicast&#34; src=&#34;https://asciinema.org/a/568810.svg&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/details&gt;
&lt;hr&gt;
&lt;h2 id=&#34;创建用户&#34;&gt;创建用户&lt;/h2&gt;
&lt;p&gt;要在现有的Postgres集群上创建一个新的业务用户，请将用户定义添加到 &lt;code&gt;all.children.&amp;lt;cls&amp;gt;.pg_users&lt;/code&gt;，然后使用以下命令将其创建：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-user &amp;lt;cls&amp;gt; &amp;lt;username&amp;gt;   &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# ./pgsql-user.yml -l &amp;lt;cls&amp;gt; -e username=&amp;lt;username&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;details&gt;&lt;summary&gt;示例：创建业务用户&lt;/summary&gt;
&lt;p&gt;&lt;a href=&#34;https://asciinema.org/a/568789&#34;&gt;&lt;img alt=&#34;asciicast&#34; src=&#34;https://asciinema.org/a/568789.svg&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/details&gt;
&lt;hr&gt;
&lt;h2 id=&#34;创建数据库&#34;&gt;创建数据库&lt;/h2&gt;
&lt;p&gt;要在现有的Postgres集群上创建一个新的数据库用户，请将数据库定义添加到 &lt;code&gt;all.children.&amp;lt;cls&amp;gt;.pg_databases&lt;/code&gt;，然后按照以下方式创建数据库：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-db &amp;lt;cls&amp;gt; &amp;lt;dbname&amp;gt;       &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# ./pgsql-db.yml -l &amp;lt;cls&amp;gt; -e dbname=&amp;lt;dbname&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;注意：如果数据库指定了一个非默认的属主，该属主用户应当已存在，否则您必须先&lt;a href=&#34;/zh/docs/pgsql/admin/#创建用户&#34;&gt;创建用户&lt;/a&gt;。&lt;/p&gt;
&lt;details&gt;&lt;summary&gt;示例：创建业务数据库&lt;/summary&gt;
&lt;p&gt;&lt;a href=&#34;https://asciinema.org/a/568790&#34;&gt;&lt;img alt=&#34;asciicast&#34; src=&#34;https://asciinema.org/a/568790.svg&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/details&gt;
&lt;hr&gt;
&lt;h2 id=&#34;重载服务&#34;&gt;重载服务&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;/zh/docs/pgsql/svc&#34;&gt;服务&lt;/a&gt;是 PostgreSQL 对外提供能力的访问点（PGURL可达），由主机节点上的 HAProxy 对外暴露。&lt;/p&gt;
&lt;p&gt;当集群成员发生变化时使用此任务，例如：&lt;a href=&#34;/zh/docs/pgsql/admin/#添加实例&#34;&gt;添加&lt;/a&gt;／&lt;a href=&#34;/zh/docs/pgsql/admin/#移除实例&#34;&gt;移除&lt;/a&gt;副本，&lt;a href=&#34;/zh/docs/pgsql/admin/#主动切换&#34;&gt;主从切换&lt;/a&gt;／故障转移 / 暴露新服务，或更新现有服务的配置（例如，LB权重）&lt;/p&gt;
&lt;p&gt;要在整个代理集群，或特定实例上创建新服务或重新加载现有服务：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-svc &amp;lt;cls&amp;gt;               &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# pgsql.yml -l &amp;lt;cls&amp;gt; -t pg_service -e pg_reload=true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-svc &amp;lt;cls&amp;gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;ip...&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;       &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# pgsql.yml -l ip... -t pg_service -e pg_reload=true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;details&gt;&lt;summary&gt;示例：重载PG服务以踢除一个实例&lt;/summary&gt;
&lt;p&gt;&lt;a href=&#34;https://asciinema.org/a/568815&#34;&gt;&lt;img alt=&#34;asciicast&#34; src=&#34;https://asciinema.org/a/568815.svg&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/details&gt;
&lt;hr&gt;
&lt;h2 id=&#34;重载hba&#34;&gt;重载HBA&lt;/h2&gt;
&lt;p&gt;当您的 Postgres/Pgbouncer HBA 规则发生更改时，您 &lt;em&gt;可能&lt;/em&gt; 需要重载 HBA 以应用更改。&lt;/p&gt;
&lt;p&gt;如果您有任何特定于角色的 HBA 规则，或者在IP地址段中引用了集群成员的别名，那么当主从切换/集群扩缩容后也可能需要重载HBA。&lt;/p&gt;
&lt;p&gt;要在整个集群或特定实例上重新加载 postgres 和 pgbouncer 的 HBA 规则：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-hba &amp;lt;cls&amp;gt;               &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# pgsql.yml -l &amp;lt;cls&amp;gt; -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e pg_reload=true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-hba &amp;lt;cls&amp;gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;ip...&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;       &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# pgsql.yml -l ip... -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e pg_reload=true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;details&gt;&lt;summary&gt;示例：重载集群 HBA 规则&lt;/summary&gt;
&lt;p&gt;&lt;a href=&#34;https://asciinema.org/a/568794&#34;&gt;&lt;img alt=&#34;asciicast&#34; src=&#34;https://asciinema.org/a/568794.svg&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/details&gt;
&lt;hr&gt;
&lt;h2 id=&#34;配置集群&#34;&gt;配置集群&lt;/h2&gt;
&lt;p&gt;要更改现有的 Postgres 集群配置，您需要在&lt;strong&gt;管理节点&lt;/strong&gt;上使用&lt;strong&gt;管理员用户&lt;/strong&gt;（安装Pigsty的用户，nopass ssh/sudo）发起控制命令：&lt;/p&gt;
&lt;p&gt;另一种方式是在数据库集群中的任何节点上，使用 &lt;code&gt;dbsu&lt;/code&gt; （默认为 postgres） ，也可以执行管理命令，但只能管理本集群。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg edit-config &amp;lt;cls&amp;gt;              &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# interactive config a cluster with patronictl&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;更改 patroni 参数和 &lt;code&gt;postgresql.parameters&lt;/code&gt;，根据提示保存并应用更改即可。&lt;/p&gt;
&lt;details&gt;&lt;summary&gt;示例：非交互式方式配置集群&lt;/summary&gt;
&lt;p&gt;您可以跳过交互模式，并使用 &lt;code&gt;-p&lt;/code&gt; 选项覆盖 postgres 参数，例如：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg edit-config -p &lt;span style=&#34;color:#000&#34;&gt;log_min_duration_statement&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1000&lt;/span&gt; pg-test
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg edit-config --force -p &lt;span style=&#34;color:#000&#34;&gt;shared_preload_libraries&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;timescaledb, pg_cron, pg_stat_statements, auto_explain&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/details&gt;
&lt;details&gt;&lt;summary&gt;示例：使用 Patroni REST API 更改集群配置&lt;/summary&gt;
&lt;p&gt;您还可以使用 &lt;a href=&#34;https://patroni.readthedocs.io/en/latest/rest_api.html&#34;&gt;Patroni REST API&lt;/a&gt; 以非交互式方式更改配置，例如：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;$ curl -s 10.10.10.11:8008/config &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; jq .  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# get current config&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;$ curl -u &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;postgres:Patroni.API&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;        -d &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;{&amp;#34;postgresql&amp;#34;:{&amp;#34;parameters&amp;#34;: {&amp;#34;log_min_duration_statement&amp;#34;:200}}}&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;        -s -X PATCH http://10.10.10.11:8008/config &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; jq .
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;注意：Patroni 敏感API（例如重启等） 访问仅限于从基础设施/管理节点发起，并且有 HTTP 基本认证（用户名/密码）以及可选的 HTTPS 保护。&lt;/p&gt;
&lt;/details&gt;
&lt;details&gt;&lt;summary&gt;示例：使用 patronictl 配置集群&lt;/summary&gt;
&lt;p&gt;&lt;a href=&#34;https://asciinema.org/a/568799&#34;&gt;&lt;img alt=&#34;asciicast&#34; src=&#34;https://asciinema.org/a/568799.svg&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/details&gt;
&lt;hr&gt;
&lt;h2 id=&#34;添加实例&#34;&gt;添加实例&lt;/h2&gt;
&lt;p&gt;若要将新从库添加到现有的 PostgreSQL 集群中，您需要将其定义添加到配置清单：&lt;code&gt;all.children.&amp;lt;cls&amp;gt;.hosts&lt;/code&gt; 中，然后：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/node-add &amp;lt;ip&amp;gt;                 &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 将节点 &amp;lt;ip&amp;gt; 纳入 Pigsty 管理                &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-add &amp;lt;cls&amp;gt; &amp;lt;ip&amp;gt;          &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 初始化 &amp;lt;ip&amp;gt; ，作为集群 &amp;lt;cls&amp;gt; 的新从库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这将会把节点 &lt;code&gt;&amp;lt;ip&amp;gt;&lt;/code&gt; 添加到 pigsty 并将其初始化为集群 &lt;code&gt;&amp;lt;cls&amp;gt;&lt;/code&gt; 的一个副本。&lt;/p&gt;
&lt;p&gt;集群服务将会&lt;a href=&#34;/zh/docs/pgsql/admin/#重载服务&#34;&gt;重新加载&lt;/a&gt;以接纳新成员。&lt;/p&gt;
&lt;details&gt;&lt;summary&gt;示例：为 pg-test 添加从库&lt;/summary&gt;
&lt;p&gt;&lt;a href=&#34;https://asciinema.org/a/566421&#34;&gt;&lt;img alt=&#34;asciicast&#34; src=&#34;https://asciinema.org/a/566421.svg&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;例如，如果您想将 &lt;code&gt;pg-test-3 / 10.10.10.13&lt;/code&gt; 添加到现有的集群 &lt;code&gt;pg-test&lt;/code&gt;，您首先需要更新配置清单：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-test:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  hosts:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    10.10.10.11: &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;{&lt;/span&gt; pg_seq: 1, pg_role: primary &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 已存在的成员&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    10.10.10.12: &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;{&lt;/span&gt; pg_seq: 2, pg_role: replica &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 已存在的成员&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    10.10.10.13: &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;{&lt;/span&gt; pg_seq: 3, pg_role: replica &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# &amp;lt;--- 新成员&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  vars: &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;{&lt;/span&gt; pg_cluster: pg-test &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;然后按如下方式应用更改：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/node-add          10.10.10.13   &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 将节点添加到 pigsty&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-add pg-test 10.10.10.13   &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在 10.10.10.13 上为集群 pg-test 初始化新的副本&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这与集群初始化相似，但只在单个实例上工作：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt; OK &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt; 初始化实例  10.10.10.11 到 pgsql 集群 &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;pg-test&amp;#39;&lt;/span&gt; 中:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;WARN&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;   提醒：先将节点添加到 pigsty 中，然后再安装模块 &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;pgsql&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;HINT&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;     $ bin/node-add  10.10.10.11  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 除 infra 节点外，先运行此命令&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;WARN&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;   从集群初始化实例：
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt; OK &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;     $ ./pgsql.yml -l &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;10.10.10.11,&amp;amp;pg-test&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;WARN&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;   重新加载现有实例上的 pg_service：
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt; OK &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;     $ ./pgsql.yml -l &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;pg-test,!10.10.10.11&amp;#39;&lt;/span&gt; -t pg_service
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/details&gt;
&lt;hr&gt;
&lt;h2 id=&#34;移除实例&#34;&gt;移除实例&lt;/h2&gt;
&lt;p&gt;若要从现有的 PostgreSQL 集群中移除副本：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-rm &amp;lt;cls&amp;gt; &amp;lt;ip...&amp;gt;        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# ./pgsql-rm.yml -l &amp;lt;ip&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这将从集群 &lt;code&gt;&amp;lt;cls&amp;gt;&lt;/code&gt; 中移除实例 &lt;code&gt;&amp;lt;ip&amp;gt;&lt;/code&gt;。 集群服务将会&lt;a href=&#34;/zh/docs/pgsql/admin/#重载服务&#34;&gt;重新加载&lt;/a&gt;以从负载均衡器中踢除已移除的实例。&lt;/p&gt;
&lt;details&gt;&lt;summary&gt;示例：从 pg-test 移除从库&lt;/summary&gt;
&lt;p&gt;&lt;a href=&#34;https://asciinema.org/a/566419&#34;&gt;&lt;img alt=&#34;asciicast&#34; src=&#34;https://asciinema.org/a/566419.svg&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;例如，如果您想从现有的集群 &lt;code&gt;pg-test&lt;/code&gt; 中移除 &lt;code&gt;pg-test-3 / 10.10.10.13&lt;/code&gt;：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-rm pg-test 10.10.10.13  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 从 pg-test 中移除 pgsql 实例 10.10.10.13&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/node-rm  10.10.10.13          &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 从 pigsty 中移除该节点（可选）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;vi pigsty.yml                     &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 从目录中移除实例定义&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-svc pg-test             &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 刷新现有实例上的 pg_service，以从负载均衡器中踢除已移除的实例&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt; OK &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt; 从 &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;pg-test&amp;#39;&lt;/span&gt; 移除 10.10.10.13 的 pgsql 实例：
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;WARN&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;   从集群中移除实例：
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt; OK &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;     $ ./pgsql-rm.yml -l &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;10.10.10.13,&amp;amp;pg-test&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;并从配置清单中移除实例定义：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;pg-test&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;hosts&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;    &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;10.10.10.11&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;{&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;pg_seq: 1, pg_role&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;primary }&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;    &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;10.10.10.12&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;{&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;pg_seq: 2, pg_role&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;replica }&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;    &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;10.10.10.13&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;{&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;pg_seq: 3, pg_role&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;replica }&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# &amp;lt;--- 执行后移除此行&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;vars&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;{&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;pg_cluster&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;pg-test }&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;最后，您可以&lt;a href=&#34;/zh/docs/pgsql/admin/#重载服务&#34;&gt;重载PG服务&lt;/a&gt;并从负载均衡器中踢除已移除的实例：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-svc pg-test             &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重载 pg-test 上的服务&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/details&gt;
&lt;hr&gt;
&lt;h2 id=&#34;下线集群&#34;&gt;下线集群&lt;/h2&gt;
&lt;p&gt;要移除整个 Postgres 集群，只需运行：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-rm &amp;lt;cls&amp;gt;                &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# ./pgsql-rm.yml -l &amp;lt;cls&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;details&gt;&lt;summary&gt;示例：移除集群&lt;/summary&gt;
&lt;p&gt;&lt;a href=&#34;https://asciinema.org/a/566418&#34;&gt;&lt;img alt=&#34;asciicast&#34; src=&#34;https://asciinema.org/a/566418.svg&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/details&gt;
&lt;details&gt;&lt;summary&gt;示例：强制移除集群&lt;/summary&gt;
&lt;p&gt;注意：如果为这个集群配置了&lt;a href=&#34;/zh/docs/reference/param#pg_safeguard&#34;&gt;&lt;code&gt;pg_safeguard&lt;/code&gt;&lt;/a&gt;（或全局设置为 &lt;code&gt;true&lt;/code&gt;），&lt;code&gt;pgsql-rm.yml&lt;/code&gt; 将中止，以避免意外移除集群。&lt;/p&gt;
&lt;p&gt;您可以使用 playbook 命令行参数明确地覆盖它，以强制执行清除：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;./pgsql-rm.yml -l pg-meta -e &lt;span style=&#34;color:#000&#34;&gt;pg_safeguard&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;false&lt;/span&gt;    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 强制移除 pg 集群 pg-meta&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/details&gt;
&lt;hr&gt;
&lt;h2 id=&#34;主动切换&#34;&gt;主动切换&lt;/h2&gt;
&lt;p&gt;您可以使用 patroni 命令行工具执行 PostgreSQL 集群的切换操作。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg switchover &amp;lt;cls&amp;gt;   &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 交互模式，您可以使用下面的参数组合直接跳过此交互向导&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg switchover --leader pg-test-1 --candidate&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;pg-test-2 --scheduled&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;now --force pg-test
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;details&gt;&lt;summary&gt;示例：pg-test 主从切换&lt;/summary&gt;
&lt;p&gt;&lt;a href=&#34;https://asciinema.org/a/566248&#34;&gt;&lt;img alt=&#34;asciicast&#34; src=&#34;https://asciinema.org/a/566248.svg&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;$ pg switchover pg-test
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Master &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;pg-test-1&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Candidate &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;pg-test-2&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;pg-test-3&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[]&lt;/span&gt;: pg-test-2
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;When should the switchover take place &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;e.g. 2022-12-26T07:39 &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;  &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;now&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;: now
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Current cluster topology
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;+ Cluster: pg-test &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;7181325041648035869&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt; -----+----+-----------+-----------------+
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Member    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Host        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Role    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; State   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; TL &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Lag in MB &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Tags            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;+-----------+-------------+---------+---------+----+-----------+-----------------+
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; pg-test-1 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 10.10.10.11 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Leader  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; running &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; clonefrom: &lt;span style=&#34;color:#204a87&#34;&gt;true&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; conf: tiny.yml  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; spec: 1C.2G.50G &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; version: &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;15&amp;#39;&lt;/span&gt;   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;+-----------+-------------+---------+---------+----+-----------+-----------------+
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; pg-test-2 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 10.10.10.12 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Replica &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; running &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; clonefrom: &lt;span style=&#34;color:#204a87&#34;&gt;true&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; conf: tiny.yml  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; spec: 1C.2G.50G &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; version: &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;15&amp;#39;&lt;/span&gt;   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;+-----------+-------------+---------+---------+----+-----------+-----------------+
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; pg-test-3 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 10.10.10.13 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Replica &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; running &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; clonefrom: &lt;span style=&#34;color:#204a87&#34;&gt;true&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; conf: tiny.yml  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; spec: 1C.2G.50G &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; version: &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;15&amp;#39;&lt;/span&gt;   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;+-----------+-------------+---------+---------+----+-----------+-----------------+
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Are you sure you want to switchover cluster pg-test, demoting current master pg-test-1? &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;y/N&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;: y
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;2022-12-26 06:39:58.02468 Successfully switched over to &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;pg-test-2&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;+ Cluster: pg-test &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;7181325041648035869&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt; -----+----+-----------+-----------------+
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Member    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Host        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Role    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; State   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; TL &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Lag in MB &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Tags            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;+-----------+-------------+---------+---------+----+-----------+-----------------+
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; pg-test-1 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 10.10.10.11 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Replica &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; stopped &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;   unknown &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; clonefrom: &lt;span style=&#34;color:#204a87&#34;&gt;true&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; conf: tiny.yml  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; spec: 1C.2G.50G &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; version: &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;15&amp;#39;&lt;/span&gt;   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;+-----------+-------------+---------+---------+----+-----------+-----------------+
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; pg-test-2 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 10.10.10.12 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Leader  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; running &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; clonefrom: &lt;span style=&#34;color:#204a87&#34;&gt;true&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; conf: tiny.yml  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; spec: 1C.2G.50G &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; version: &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;15&amp;#39;&lt;/span&gt;   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;+-----------+-------------+---------+---------+----+-----------+-----------------+
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; pg-test-3 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 10.10.10.13 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Replica &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; running &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; clonefrom: &lt;span style=&#34;color:#204a87&#34;&gt;true&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; conf: tiny.yml  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; spec: 1C.2G.50G &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; version: &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;15&amp;#39;&lt;/span&gt;   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;+-----------+-------------+---------+---------+----+-----------+-----------------+
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;要通过 Patroni API 来执行此操作（例如，在指定时间将主库从 2号实例 切换到 1号实例）&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;curl -u &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;postgres:Patroni.API&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  -d &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;{&amp;#34;leader&amp;#34;:&amp;#34;pg-test-2&amp;#34;, &amp;#34;candidate&amp;#34;: &amp;#34;pg-test-1&amp;#34;,&amp;#34;scheduled_at&amp;#34;:&amp;#34;2022-12-26T14:47+08&amp;#34;}&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  -s -X POST http://10.10.10.11:8008/switchover
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/details&gt;
&lt;p&gt;无论是主动切换还是故障切换，您都需要在集群成员身份发生变化后，重新刷新服务与HBA规则。您应当在变更发生后及时（例如几个小时，一天内），完成此操作：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-svc &amp;lt;cls&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bin/pgsql-hba &amp;lt;cls&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id=&#34;备份集群&#34;&gt;备份集群&lt;/h2&gt;
&lt;p&gt;使用 pgBackRest 创建备份，需要以本地 dbsu （默认为 &lt;code&gt;postgres&lt;/code&gt;）的身份运行以下命令：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-backup       &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 执行备份，如有必要，执行增量或全量备份&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-backup full  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 执行全量备份&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-backup diff  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 执行差异备份&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-backup incr  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 执行增量备份&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pb info         &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 打印备份信息 （pgbackrest info）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;参阅&lt;a href=&#34;/zh/docs/pgsql/pitr#%E5%A4%87%E4%BB%BD&#34;&gt;备份恢复&lt;/a&gt;获取更多信息。&lt;/p&gt;
&lt;details&gt;&lt;summary&gt;示例：创建备份&lt;/summary&gt;
&lt;p&gt;&lt;a href=&#34;https://asciinema.org/a/568813&#34;&gt;&lt;img alt=&#34;asciicast&#34; src=&#34;https://asciinema.org/a/568813.svg&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/details&gt;
&lt;details&gt;&lt;summary&gt;示例：创建定时备份任务&lt;/summary&gt;
&lt;p&gt;您可以将 crontab 添加到 &lt;a href=&#34;/zh/docs/reference/param#node_crontab&#34;&gt;&lt;code&gt;node_crontab&lt;/code&gt;&lt;/a&gt; 以指定您的备份策略。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 每天凌晨1点做一次全备份&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;&lt;/span&gt;- &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;00 01 * * * postgres /pg/bin/pg-backup full&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 周一凌晨1点进全量备份，其他工作日进行增量备份&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;&lt;/span&gt;- &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;00 01 * * 1 postgres /pg/bin/pg-backup full&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;&lt;/span&gt;- &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;00 01 * * 2,3,4,5,6,7 postgres /pg/bin/pg-backup&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/details&gt;
&lt;hr&gt;
&lt;h2 id=&#34;恢复集群&#34;&gt;恢复集群&lt;/h2&gt;
&lt;p&gt;要将集群恢复到先前的时间点 (PITR)，请以本地 dbsu 用户（默认为&lt;code&gt;postgres&lt;/code&gt;）运行 Pigsty 提供的辅助脚本 &lt;code&gt;pg-pitr&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-pitr -i                              &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 恢复到最近备份完成的时间（不常用）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-pitr --time&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;2022-12-30 14:44:44+08&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 恢复到指定的时间点（在删除数据库或表的情况下使用）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-pitr --name&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;my-restore-point&amp;#34;&lt;/span&gt;       &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 恢复到使用 pg_create_restore_point 创建的命名恢复点&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-pitr --lsn&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;0/7C82CB8&amp;#34;&lt;/span&gt; -X            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在LSN之前立即恢复&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-pitr --xid&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;1234567&amp;#34;&lt;/span&gt; -X -P           &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在指定的事务ID之前立即恢复，然后将集群直接提升为主库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-pitr --backup&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;latest                 &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 恢复到最新的备份集&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg-pitr --backup&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;20221108-105325        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 恢复到特定备份集，备份集可以使用 pgbackrest info 列出&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;该命令会输出操作手册，请按照说明进行操作。查看&lt;a href=&#34;/zh/docs/pgsql/pitr#%E6%81%A2%E5%A4%8D&#34;&gt;备份恢复-PITR&lt;/a&gt;获取详细信息。&lt;/p&gt;
&lt;details&gt;&lt;summary&gt;示例：使用原始pgBackRest命令进行 PITR&lt;/summary&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 恢复到最新可用的点（例如硬件故障）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pgbackrest --stanza&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;pg-meta restore
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# PITR 到特定的时间点（例如意外删除表）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pgbackrest --stanza&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;pg-meta --type&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;time&lt;/span&gt; --target&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;2022-11-08 10:58:48&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;   --target-action&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;promote restore
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 恢复特定的备份点，然后提升（或暂停|关闭）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pgbackrest --stanza&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;pg-meta --type&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;immediate --target-action&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;promote &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  --set&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;20221108-105325F_20221108-105938I restore
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/details&gt;
&lt;hr&gt;
&lt;h2 id=&#34;添加软件&#34;&gt;添加软件&lt;/h2&gt;
&lt;p&gt;要添加新版本的 RPM 包，你需要将它们加入到 &lt;a href=&#34;/zh/docs/reference/param#repo_packages&#34;&gt;&lt;code&gt;repo_packages&lt;/code&gt;&lt;/a&gt; 和 &lt;a href=&#34;/zh/docs/reference/param#repo_url_packages&#34;&gt;&lt;code&gt;repo_url_packages&lt;/code&gt;&lt;/a&gt; 中。&lt;/p&gt;
&lt;p&gt;使用 &lt;code&gt;./infra.yml -t repo_build&lt;/code&gt; 子任务在 Infra 节点上重新构建本地软件仓库。然后，你可以使用 &lt;code&gt;ansible&lt;/code&gt; 的 &lt;code&gt;package&lt;/code&gt; 模块安装这些包：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ansible pg-test -b -m package -a &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;name=pg_cron_15,topn_15,pg_stat_monitor_15*&amp;#34;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 使用 ansible 安装一些包&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;details&gt;&lt;summary&gt;示例：手动更本地新软件源中的包&lt;/summary&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在基础设施/管理节点上添加上游软件仓库，然后手工下载所需的软件包&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;cd&lt;/span&gt; ~/pigsty&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; ./infra.yml -t repo_upstream,repo_cache &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 添加上游仓库（互联网）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;cd&lt;/span&gt; /www/pigsty&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;  repotrack &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;some_new_package_name&amp;#34;&lt;/span&gt;   &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 下载最新的 RPM 包&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 更新本地软件仓库元数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;cd&lt;/span&gt; ~/pigsty&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; ./infra.yml -t repo_create              &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重新创建本地软件仓库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;./node.yml -t node_repo                              &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 刷新所有节点上的 YUM/APT 缓存&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 也可以使用 Ansible 手工刷新节点上的 YUM/APT 缓存&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ansible all -b -a &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;yum clean all&amp;#39;&lt;/span&gt;                    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 清理节点软件仓库缓存&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ansible all -b -a &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;yum makecache&amp;#39;&lt;/span&gt;                    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 从新的仓库重建yum/apt缓存&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ansible all -b -a &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;apt clean&amp;#39;&lt;/span&gt;                        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 清理 APT 缓存（Ubuntu/Debian）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ansible all -b -a &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;apt update&amp;#39;&lt;/span&gt;                       &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重建 APT 缓存（Ubuntu/Debian）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;例如，你可以使用以下方式安装或升级包：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ansible pg-test -b -m package -a &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;name=postgresql15* state=latest&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/details&gt;
&lt;hr&gt;
&lt;h2 id=&#34;安装扩展&#34;&gt;安装扩展&lt;/h2&gt;
&lt;p&gt;如果你想在 PostgreSQL 集群上安装扩展，请将它们加入到 &lt;a href=&#34;/zh/docs/reference/param#pg_extensions&#34;&gt;&lt;code&gt;pg_extensions&lt;/code&gt;&lt;/a&gt; 中，并执行：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;./pgsql.yml -t pg_extension     &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 安装扩展&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;一部分扩展需要在 &lt;code&gt;shared_preload_libraries&lt;/code&gt; 中加载后才能生效。你可以将它们加入到 &lt;a href=&#34;/zh/docs/reference/param#pg_libs&#34;&gt;&lt;code&gt;pg_libs&lt;/code&gt;&lt;/a&gt; 中，或者&lt;a href=&#34;/zh/docs/pgsql/admin/#配置集群&#34;&gt;配置&lt;/a&gt;一个已有的集群。&lt;/p&gt;
&lt;p&gt;最后，在集群的主库上执行 &lt;code&gt;CREATE EXTENSION &amp;lt;extname&amp;gt;;&lt;/code&gt; 来完成扩展的安装。&lt;/p&gt;
&lt;details&gt;&lt;summary&gt;示例：在 pg-test 集群上安装 pg_cron 扩展&lt;/summary&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ansible pg-test -b -m package -a &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;name=pg_cron_15&amp;#34;&lt;/span&gt;          &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在所有节点上安装 pg_cron 包&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 将 pg_cron 添加到 shared_preload_libraries 中&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg edit-config --force -p &lt;span style=&#34;color:#000&#34;&gt;shared_preload_libraries&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;timescaledb, pg_cron, pg_stat_statements, auto_explain&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg restart --force pg-test                                  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重新启动集群&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;psql -h pg-test -d postgres -c &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;CREATE EXTENSION pg_cron;&amp;#39;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在主库上安装 pg_cron&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/details&gt;
&lt;p&gt;更多细节，请参考&lt;a href=&#34;/zh/docs/reference/extension#%E6%89%A9%E5%B1%95%E5%AE%89%E8%A3%85&#34;&gt;PGSQL扩展安装&lt;/a&gt;。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id=&#34;小版本升级&#34;&gt;小版本升级&lt;/h2&gt;
&lt;p&gt;要执行小版本的服务器升级/降级，您首先需要在本地软件仓库中&lt;a href=&#34;/zh/docs/pgsql/admin/#添加软件&#34;&gt;添加软件&lt;/a&gt;：最新的PG小版本 RPM/DEB。&lt;/p&gt;
&lt;p&gt;首先对所有从库执行滚动升级/降级，然后执行集群&lt;a href=&#34;/zh/docs/pgsql/admin/#主动切换&#34;&gt;主从切换&lt;/a&gt;以升级/降级主库。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ansible &amp;lt;cls&amp;gt; -b -a &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;yum upgrade/downgrade -y &amp;lt;pkg&amp;gt;&amp;#34;&lt;/span&gt;    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 升级/降级软件包&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg restart --force &amp;lt;cls&amp;gt;                                &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重启集群&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;details&gt;&lt;summary&gt;示例：将PostgreSQL 15.2降级到15.1&lt;/summary&gt;
&lt;p&gt;将15.1的包添加到软件仓库并刷新节点的 yum/apt 缓存：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;cd&lt;/span&gt; ~/pigsty&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; ./infra.yml -t repo_upstream               &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 添加上游仓库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;cd&lt;/span&gt; /www/pigsty&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; repotrack postgresql15-*-15.1           &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 将15.1的包添加到yum仓库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;cd&lt;/span&gt; ~/pigsty&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; ./infra.yml -t repo_create                 &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重建仓库元数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ansible pg-test -b -a &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;yum clean all&amp;#39;&lt;/span&gt;                   &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 清理节点仓库缓存&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ansible pg-test -b -a &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;yum makecache&amp;#39;&lt;/span&gt;                   &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 从新仓库重新生成yum缓存&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 对于 Ubutnu/Debian 用户，使用 apt 替换 yum&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ansible pg-test -b -a &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;apt clean&amp;#39;&lt;/span&gt;                       &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 清理节点仓库缓存&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ansible pg-test -b -a &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;apt update&amp;#39;&lt;/span&gt;                      &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 从新仓库重新生成apt缓存&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;执行降级并重启集群：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ansible pg-test -b -a &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;yum downgrade -y postgresql15*&amp;#34;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 降级软件包）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg restart --force pg-test                              &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重启整个集群以完成升级&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/details&gt;
&lt;details&gt;&lt;summary&gt;示例：将PostgreSQL 15.1升级回15.2&lt;/summary&gt;
&lt;p&gt;这次我们采用滚动方式升级：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ansible pg-test -b -a &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;yum upgrade -y postgresql15*&amp;#34;&lt;/span&gt;    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 升级软件包（或 apt upgrade）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ansible pg-test -b -a &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;/usr/pgsql/bin/pg_ctl --version&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 检查二进制版本是否为15.2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg restart --role replica --force pg-test               &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重启从库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg switchover --leader pg-test-1 --candidate&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;pg-test-2 --scheduled&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;now --force pg-test    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 切换主从&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg restart --role primary --force pg-test               &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重启主库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/details&gt;
&lt;hr&gt;
&lt;h2 id=&#34;大版本升级&#34;&gt;大版本升级&lt;/h2&gt;
&lt;p&gt;实现大版本升级的最简单办法是：创建一个使用新版本的新集群，然后通过逻辑复制，蓝绿部署，并进行&lt;a href=&#34;/zh/docs/pgsql/migration&#34;&gt;在线迁移&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;您也可以进行原地大版本升级，当您只使用数据库内核本身时，这并不复杂，使用 PostgreSQL 自带的 &lt;code&gt;pg_upgrade&lt;/code&gt; 即可：&lt;/p&gt;
&lt;p&gt;假设您想将 PostgreSQL 大版本从 14 升级到 15，您首先需要在仓库中&lt;a href=&#34;/zh/docs/pgsql/admin/#添加软件&#34;&gt;添加软件&lt;/a&gt;，并确保两个大版本两侧安装的核心扩展插件也具有相同的版本号。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;./pgsql.yml -t pg_pkg -e &lt;span style=&#34;color:#000&#34;&gt;pg_version&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;15&lt;/span&gt;                         &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 安装pg 15的包&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo su - postgres&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; mkdir -p /data/postgres/pg-meta-15/data/   &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 为15准备目录&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg_upgrade -b /usr/pgsql-14/bin/ -B /usr/pgsql-15/bin/ -d /data/postgres/pg-meta-14/data/ -D /data/postgres/pg-meta-15/data/ -v -c &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 预检&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pg_upgrade -b /usr/pgsql-14/bin/ -B /usr/pgsql-15/bin/ -d /data/postgres/pg-meta-14/data/ -D /data/postgres/pg-meta-15/data/ --link -j8 -v -c
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;rm -rf /usr/pgsql&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; ln -s /usr/pgsql-15 /usr/pgsql&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;             &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 修复二进制链接&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mv /data/postgres/pg-meta-14 /data/postgres/pg-meta-15         &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重命名数据目录&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;rm -rf /pg&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; ln -s /data/postgres/pg-meta-15 /pg                &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 修复数据目录链接&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
      </description>
    </item>
    
  </channel>
</rss>
