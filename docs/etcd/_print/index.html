<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="/docs/etcd/">
<link rel="alternate" type="application/rss&#43;xml" href="/docs/etcd/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Module: ETCD | Pigsty</title>
<meta name="description" content="Pigsty has built-in etcd support, which is a reliable distributive consensus storage (DCS), empowering PostgreSQL HA.">
<meta property="og:title" content="Module: ETCD" />
<meta property="og:description" content="Pigsty has built-in etcd support, which is a reliable distributive consensus storage (DCS), empowering PostgreSQL HA." />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/etcd/" />

<meta itemprop="name" content="Module: ETCD">
<meta itemprop="description" content="Pigsty has built-in etcd support, which is a reliable distributive consensus storage (DCS), empowering PostgreSQL HA."><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Module: ETCD"/>
<meta name="twitter:description" content="Pigsty has built-in etcd support, which is a reliable distributive consensus storage (DCS), empowering PostgreSQL HA."/>




<link rel="preload" href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" as="style">
<link href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="/js/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LG1V9WTKGE');
}
</script>
  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class="navbar-brand__name">Pigsty</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/docs/"><i class='fa-solid fa-book'></i><span>Docs</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/blog/"><i class="fas fa-blog"></i><span>Blog</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/Vonng/pigsty/" target="_blank" rel="noopener"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-language"></i>English</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/zh/docs/etcd/">中文</a></li>
    </ul>
</div>
</li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.4125b29715bb03f7dec1973b107267cd.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/etcd/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Module: ETCD</h1>
<div class="lead">Pigsty has built-in etcd support, which is a reliable distributive consensus storage (DCS), empowering PostgreSQL HA.</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-b3c7d25a96ae732f6a6be2d1fd4d5ec6">Configuration</a></li>


    
  
    
    
	
<li>2: <a href="#pg-0bac52423651fcf771f1cdaad4f4c67b">Parameters</a></li>


    
  
    
    
	
<li>3: <a href="#pg-f7e866452f3057b5647d06b72632819e">Playbook</a></li>


    
  
    
    
	
<li>4: <a href="#pg-e2a09cf50caf28a3c5a85194967a50bc">Administration</a></li>


    
  
    
    
	
<li>5: <a href="#pg-e584a5e6bb1de156a6ab3580a5451148">Monitoring</a></li>


    
  
    
    
	
<li>6: <a href="#pg-b4db80f8234d7db0cbf16b40530478bd">Metrics</a></li>


    
  
    
    
	
<li>7: <a href="#pg-bfaeae9f961d15c2f4a30d7af548af0c">FAQ</a></li>


    
  

    </ul>


<div class="content">
      <blockquote>
<p>ETCD is a distributed, reliable key-value store for the most critical data of a distributed system</p>
</blockquote>
<p><a href="/docs/etcd/#configuration">Configuration</a> | <a href="/docs/etcd/#administration">Administration</a> | <a href="/docs/etcd/#playbook">Playbook</a> | <a href="/docs/etcd/#dashboard">Dashboard</a> | <a href="/docs/etcd/#parameter">Parameter</a></p>
<p>Pigsty use  <a href="https://etcd.io/"><strong>etcd</strong></a> as  <a href="https://patroni.readthedocs.io/en/latest/dcs_failsafe_mode.html"><strong>DCS</strong></a>: Distributed configuration storage (or distributed consensus service). Which is critical to PostgreSQL High-Availability &amp; Auto-Failover.</p>
<p>You have to install <a href="/docs/etcd/"><code>ETCD</code></a> module before any <a href="/docs/pgsql/"><code>PGSQL</code></a> modules, since patroni &amp; vip-manager will rely on etcd to work. Unless you are using an external etcd cluster.</p>
<p>You don&rsquo;t need <a href="/docs/node/"><code>NODE</code></a> module to install <a href="/docs/etcd/"><code>ETCD</code></a>, but it requires a valid <code>CA</code> on your local <code>files/pki/ca</code>. Check <a href="/docs/etcd/#administration">ETCD Administration SOP</a> for more details.</p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b3c7d25a96ae732f6a6be2d1fd4d5ec6">1 - Configuration</h1>
    <div class="lead">Configure etcd clusters according to your needs, and access the service</div>
	<p>You have to define the etcd cluster in the <a href="/docs/setup/config/#inventory">config inventory</a> before deploying it.</p>
<p>Usually you can choose an etcd cluster with:</p>
<ul>
<li><a href="/docs/etcd/config/#one-node">One Node</a>, no high availability, just the functionally of etcd, suitable for development, testing, demonstration.</li>
<li><a href="/docs/etcd/config/#three-nodes">Three Nodes</a>, basic high availability, tolerate one node failure, suitable for medium production environment.</li>
<li><a href="/docs/etcd/config/#five-nodes">Five Nodes</a>, better high availability, tolerate two node failure, suitable for large production environment.</li>
</ul>
<p>Even number of etcd nodes is meaningless, and more than five nodes is not common.</p>
<hr>
<h2 id="one-node">One Node</h2>
<p>Define the group <code>etcd</code> in the inventory, It will create a singleton etcd instance.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># etcd cluster for ha postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq: 1 } }, vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>This line exists almost in all single-node <a href="/docs/conf/">config</a> templates, where the placeholder IP address <code>10.10.10.10</code>
will be replaced with the current admin node IP.</p>
<p>The only necessary parameters are <a href="/docs/etcd/param/#etcd_seq"><code>etcd_seq</code></a> and <a href="/docs/etcd/param/#etcd_cluster"><code>etcd_cluster</code></a>,
which uniquely identify the cluster and each instance.</p>
<hr>
<h2 id="three-nodes">Three Nodes</h2>
<p>It&rsquo;s common to use a three-node etcd cluster, which can tolerate one node failure, suitable for medium prod env.</p>
<p>The <a href="/docs/conf/trio/"><code>trio</code></a> and <a href="/docs/conf/safe/"><code>safe</code></a> config templates use a three-node etcd cluster, as shown below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># dcs service for postgres/patroni ha consensus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 1 node for testing, 3 or 5 for production</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># etcd_seq required</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># assign from 1 ~ n</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># odd number please</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># cluster level parameter override roles/etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># mark etcd cluster name etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd_safeguard</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># safeguard against purging</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd_clean</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># purge etcd during init process</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="five-nodes">Five Nodes</h2>
<p>Five nodes etcd cluster can tolerate two node failure, suitable for large prod env.</p>
<p>There&rsquo;s a five-node etcd cluster example in the <a href="/docs/conf/prod/"><code>prod</code></a> template:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.21 </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.22 </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.23 </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.24 </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.25 </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd    }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You can use more nodes for production environment, but 3 or 5 nodes are recommended. Remember to use odd number for cluster size.</p>
<hr>
<h2 id="etcd-usage">Etcd Usage</h2>
<p>These are the services that currently use Etcd:</p>
<ul>
<li>patroni: Use etcd as a consensus backend for PostgreSQL HA</li>
<li>vip-manager: Read leader info from Etcd to bind an optional L2 VIP on the PostgreSQL cluster</li>
</ul>
<p>You&rsquo;ll have to <a href="/docs/etcd/admin/#reload-config"><strong>reload</strong></a> etcd config after any permanent change to the etcd cluster members.</p>
<p>e.g, update patroni reference to etcd endpoints:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_conf                            <span style="color:#8f5902;font-style:italic"># generate patroni config</span>
</span></span><span style="display:flex;"><span>ansible all -f <span style="color:#0000cf;font-weight:bold">1</span> -b -a <span style="color:#4e9a06">&#39;systemctl reload patroni&#39;</span> <span style="color:#8f5902;font-style:italic"># reload patroni config</span>
</span></span></code></pre></div><p>e.g, update vip-manager reference to etcd endpoints (if you are using PGSQL L2 VIP):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_vip_config                           <span style="color:#8f5902;font-style:italic"># generate vip-manager config</span>
</span></span><span style="display:flex;"><span>ansible all -f <span style="color:#0000cf;font-weight:bold">1</span> -b -a <span style="color:#4e9a06">&#39;systemctl restart vip-manager&#39;</span> <span style="color:#8f5902;font-style:italic"># restart vip-manager to use </span>
</span></span></code></pre></div><br>
<hr>
<br>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0bac52423651fcf771f1cdaad4f4c67b">2 - Parameters</h1>
    <div class="lead">Etcd has 10 parameters to customize the etcd cluster as needed.</div>
	<p>Etcd is a distributed, reliable key-value store used to store the most critical config/consensus data in the system.</p>
<p>Etcd is used as the DCS used by the HA agent Patroni, which is very important for the high availability of PostgreSQL in Pigsty.</p>
<p>Pigsty use the hard-coded group <code>etcd</code> for etcd cluster, which can be an external etcd cluster,
r a new etcd cluster created by Pigsty using the <a href="/docs/etcd/playbook/#etcdyml">etcd.yml</a> playbook.</p>
<hr>
<h2 id="parameters">Parameters</h2>
<p>There are 10 parameters about the <code>ETCD</code> module.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Level</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="/docs/etcd/param/#etcd_seq"><code>etcd_seq</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">I</td>
<td>etcd instance identifier, REQUIRED</td>
</tr>
<tr>
<td><a href="/docs/etcd/param/#etcd_cluster"><code>etcd_cluster</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>etcd cluster &amp; group name, etcd by default</td>
</tr>
<tr>
<td><a href="/docs/etcd/param/#etcd_safeguard"><code>etcd_safeguard</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">G/C/A</td>
<td>prevent purging running etcd instance?</td>
</tr>
<tr>
<td><a href="/docs/etcd/param/#etcd_clean"><code>etcd_clean</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">G/C/A</td>
<td>purging existing etcd during initialization?</td>
</tr>
<tr>
<td><a href="/docs/etcd/param/#etcd_data"><code>etcd_data</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>etcd data directory, /data/etcd by default</td>
</tr>
<tr>
<td><a href="/docs/etcd/param/#etcd_port"><code>etcd_port</code></a></td>
<td style="text-align:center">port</td>
<td style="text-align:center">C</td>
<td>etcd client port, 2379 by default</td>
</tr>
<tr>
<td><a href="/docs/etcd/param/#etcd_peer_port"><code>etcd_peer_port</code></a></td>
<td style="text-align:center">port</td>
<td style="text-align:center">C</td>
<td>etcd peer port, 2380 by default</td>
</tr>
<tr>
<td><a href="/docs/etcd/param/#etcd_init"><code>etcd_init</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>etcd initial cluster state, new or existing</td>
</tr>
<tr>
<td><a href="/docs/etcd/param/#etcd_election_timeout"><code>etcd_election_timeout</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">C</td>
<td>etcd election timeout, 1000ms by default</td>
</tr>
<tr>
<td><a href="/docs/etcd/param/#etcd_heartbeat_interval"><code>etcd_heartbeat_interval</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">C</td>
<td>etcd heartbeat interval, 100ms by default</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="defaults">Defaults</h2>
<p>The default parameters of Etcd is defined in <a href="https://github.com/Vonng/pigsty/blob/main/roles/etcd/defaults/main.yml"><code>roles/etcd/defaults/main.yml</code></a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#etcd_seq: 1                      # etcd instance identifier, explicitly required</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd               </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># etcd cluster &amp; group name, etcd by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_safeguard</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># prevent purging running etcd instance?</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_clean</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># purging existing etcd during initialization?</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/data/etcd            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># etcd data directory, /data/etcd by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2379</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># etcd client port, 2379 by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_peer_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2380</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic"># etcd peer port, 2380 by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_init</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">new                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># etcd initial cluster state, new or existing</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_election_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># etcd election timeout, 1000ms by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd_heartbeat_interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># etcd heartbeat interval, 100ms by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="etcd_seq"><code>etcd_seq</code></h2>
<p>name: <code>etcd_seq</code>, type: <code>int</code>, level: <code>I</code></p>
<p>etcd instance identifier, REQUIRED</p>
<p>no default value, you have to specify it explicitly. Here is a 3-node etcd cluster example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># dcs service for postgres/patroni ha consensus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 1 node for testing, 3 or 5 for production</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># etcd_seq required</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># assign from 1 ~ n</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># odd number please</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># cluster level parameter override roles/etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># mark etcd cluster name etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd_safeguard</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># safeguard against purging</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd_clean</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># purge etcd during init process</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="etcd_cluster"><code>etcd_cluster</code></h2>
<p>name: <code>etcd_cluster</code>, type: <code>string</code>, level: <code>C</code></p>
<p>etcd cluster &amp; group name, etcd by default</p>
<p>default values: <code>etcd</code>, which is a fixed group name, can be useful when you want to use deployed some extra etcd clusters</p>
<hr>
<h2 id="etcd_safeguard"><code>etcd_safeguard</code></h2>
<p>name: <code>etcd_safeguard</code>, type: <code>bool</code>, level: <code>G/C/A</code></p>
<p>prevent purging running etcd instance? default value is <code>false</code></p>
<p>If enabled, running etcd instance will not be purged by <a href="/docs/etcd/#etcdyml">etcd.yml</a> playbook.</p>
<hr>
<h2 id="etcd_clean"><code>etcd_clean</code></h2>
<p>name: <code>etcd_clean</code>, type: <code>bool</code>, level: <code>G/C/A</code></p>
<p>purging existing etcd during initialization? default value is <code>true</code></p>
<p>If enabled, running etcd instance will be purged by <a href="/docs/etcd/#etcdyml">etcd.yml</a> playbook, which makes the playbook fully idempotent.</p>
<p>But if <a href="/docs/etcd/param/#etcd_safeguard"><code>etcd_safeguard</code></a> is enabled, it will still abort on any running etcd instance.</p>
<hr>
<h2 id="etcd_data"><code>etcd_data</code></h2>
<p>name: <code>etcd_data</code>, type: <code>path</code>, level: <code>C</code></p>
<p>etcd data directory, <code>/data/etcd</code> by default</p>
<hr>
<h2 id="etcd_port"><code>etcd_port</code></h2>
<p>name: <code>etcd_port</code>, type: <code>port</code>, level: <code>C</code></p>
<p>etcd client port, <code>2379</code> by default</p>
<hr>
<h2 id="etcd_peer_port"><code>etcd_peer_port</code></h2>
<p>name: <code>etcd_peer_port</code>, type: <code>port</code>, level: <code>C</code></p>
<p>etcd peer port, <code>2380</code> by default</p>
<hr>
<h2 id="etcd_init"><code>etcd_init</code></h2>
<p>name: <code>etcd_init</code>, type: <code>enum</code>, level: <code>C</code></p>
<p>etcd initial cluster state, <code>new</code> or <code>existing</code></p>
<p>default values: <code>new</code>, which will create a standalone new etcd cluster.</p>
<p>The value <code>existing</code> is used when trying to <a href="/docs/etcd/#add-member">add new member</a> to existing etcd cluster.</p>
<hr>
<h2 id="etcd_election_timeout"><code>etcd_election_timeout</code></h2>
<p>name: <code>etcd_election_timeout</code>, type: <code>int</code>, level: <code>C</code></p>
<p>etcd election timeout, <code>1000</code> (ms) by default</p>
<hr>
<h2 id="etcd_heartbeat_interval"><code>etcd_heartbeat_interval</code></h2>
<p>name: <code>etcd_heartbeat_interval</code>, type: <code>int</code>, level: <code>C</code></p>
<p>etcd heartbeat interval, <code>100</code> (ms) by default</p>
<br>
<hr>
<br>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f7e866452f3057b5647d06b72632819e">3 - Playbook</h1>
    <div class="lead">How to manage etcd cluster with ansible playbooks</div>
	<p>There&rsquo;s a built-in playbook: <code>etcd.yml</code> for installing etcd cluster. But you have to <a href="/docs/etcd/config/">define</a> it first.</p>
<hr>
<h2 id="playbook">Playbook</h2>
<p>To <a href="/docs/etcd/admin/#create-cluster">create a new etcd cluster</a>, run the following playbook:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml    <span style="color:#8f5902;font-style:italic"># install etcd cluster on group &#39;etcd&#39;</span>
</span></span></code></pre></div><p>Here are available sub tasks:</p>
<ul>
<li><code>etcd_assert</code>   : generate etcd identity</li>
<li><code>etcd_install</code>  : install etcd rpm packages</li>
<li><code>etcd_clean</code>    : cleanup existing etcd
<ul>
<li><code>etcd_check</code>  : check etcd instance is running</li>
<li><code>etcd_purge</code>  : remove running etcd instance &amp; data</li>
</ul>
</li>
<li><code>etcd_dir</code>      : create etcd data &amp; conf dir</li>
<li><code>etcd_config</code>   : generate etcd config
<ul>
<li><code>etcd_conf</code>   : generate etcd main config</li>
<li><code>etcd_cert</code>   : generate etcd ssl cert</li>
</ul>
</li>
<li><code>etcd_launch</code>   : launch etcd service</li>
<li><code>etcd_register</code> : register etcd to prometheus</li>
</ul>
<p><a href="https://asciinema.org/a/566414"><img alt="asciicast" src="https://asciinema.org/a/566414.svg"></a></p>
<p>There&rsquo;s no dedicated uninstall playbook for etcd. If you want to uninstall etcd, you can use <code>etcd_clean</code> subtask:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml -t etcd_clean
</span></span></code></pre></div><hr>
<h2 id="commands">Commands</h2>
<p>Some shortcuts and common commands:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml                                      <span style="color:#8f5902;font-style:italic"># init etcd cluster </span>
</span></span><span style="display:flex;"><span>./etcd.yml -t etcd_launch                       <span style="color:#8f5902;font-style:italic"># restart etcd cluster</span>
</span></span><span style="display:flex;"><span>./etcd.yml -t etcd_clean                        <span style="color:#8f5902;font-style:italic"># remove etcd cluster</span>
</span></span><span style="display:flex;"><span>./etcd.yml -t etcd_purge                        <span style="color:#8f5902;font-style:italic"># remove etcd cluster with brute force</span>
</span></span><span style="display:flex;"><span>./etcd.yml -t etcd_conf                         <span style="color:#8f5902;font-style:italic"># refreshing /etc/etcd/etcd.conf</span>
</span></span><span style="display:flex;"><span>./etcd.yml -l 10.10.10.12 -e <span style="color:#000">etcd_init</span><span style="color:#ce5c00;font-weight:bold">=</span>existing <span style="color:#8f5902;font-style:italic"># add new member to existing etcd cluster</span>
</span></span><span style="display:flex;"><span>./etcd.yml -l 10.10.10.12 -t etcd_purge         <span style="color:#8f5902;font-style:italic"># remove member from existing etcd cluster</span>
</span></span></code></pre></div><hr>
<h2 id="safeguard">Safeguard</h2>
<p>Pigsty has safeguard mechanism for etcd module to prevent accidental purge.</p>
<ul>
<li><a href="/docs/etcd/param/#etcd_clean"><code>etcd_clean</code></a>: <code>true</code> by default, which will clean existing etcd instances during init</li>
<li><a href="/docs/etcd/param/#etcd_safeguard"><code>etcd_safeguard</code></a>: <code>false</code> by default, will not prevent purge etcd cluster.</li>
</ul>
<p>The default setting is useful for development, testing, and emergency rebuild of etcd cluster in production.</p>
<p>If you wish to prevent accidental purge, you can enable safeguard by setting <code>etcd_clean</code> to <code>false</code> and <code>etcd_safeguard</code> to <code>true</code>.
And you can always override this setting by using <code>-e etcd_clean=true</code> and <code>-e etcd_safeguard=false</code> in command line.</p>
<p>If you wish to remove existing cluster:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml -l &lt;cls&gt; -e <span style="color:#000">etcd_clean</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> -t etcd_clean
</span></span></code></pre></div><p>The final brutal way to remove etcd cluster is using the <code>etcd_purge</code> subtask, which will ignore the safeguard:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml -l &lt;cls&gt; -t etcd_purge
</span></span></code></pre></div><hr>
<h2 id="demo">Demo</h2>
<p><a href="https://asciinema.org/a/566415"><img alt="asciicast" src="https://asciinema.org/a/566415.svg"></a></p>
<br>
<hr>
<br>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e2a09cf50caf28a3c5a85194967a50bc">4 - Administration</h1>
    <div class="lead">Admin SOP, create &amp; remove etcd clusters and members</div>
	<p>Here are some administration SOP for etcd:</p>
<ul>
<li><a href="/docs/etcd/admin/#create-cluster">Create Cluster</a></li>
<li><a href="/docs/etcd/admin/#remove-cluster">Remove Cluster</a></li>
<li><a href="/docs/etcd/admin/#cli-environment">CLI Environment</a></li>
<li><a href="/docs/etcd/admin/#reload-config">Reload Config</a></li>
<li><a href="/docs/etcd/admin/#add-member">Add Member</a></li>
<li><a href="/docs/etcd/admin/#remove-member">Remove Member</a></li>
</ul>
<p>Check <a href="/docs/etcd/faq/">ETCD: FAQ</a> for more questions.</p>
<hr>
<h2 id="create-cluster">Create Cluster</h2>
<p>To create an etcd cluster, define the <code>etcd</code> cluster in <a href="/docs/setup/config/#inventory">inventory</a> first:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Then run the <a href="/docs/etcd/playbook/#etcdyml"><code>etcd.yml</code></a> playbook.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml   <span style="color:#8f5902;font-style:italic"># init etcd module on group &#39;etcd&#39;</span>
</span></span></code></pre></div><p>Pigsty has safeguard mechanism to prevent accidental purge. By default, <a href="/docs/etcd/param/#etcd_clean"><code>etcd_clean</code></a> is <code>true</code>, and <a href="/docs/etcd/param/#etcd_safeguard"><code>etcd_safeguard</code></a> is <code>false</code>,
which means the playbook will purge etcd cluster even if there are running etcd instances. In this case, <code>etcd.yml</code> is truly idempotent, which is useful for development, testing, and emergency rebuild of etcd cluster in production.</p>
<p>For provsioned etcd cluster in prod env, you can enable safeguard to prevent accidental clean.</p>
<hr>
<h2 id="remove-cluster">Remove Cluster</h2>
<p>To remove an existing etcd cluster, use the <code>etcd_clean</code> subtask of  <a href="/docs/etcd/playbook/#etcdyml"><code>etcd.yml</code></a>, do think before you type.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml -t etcd_clean  <span style="color:#8f5902;font-style:italic"># remove entire cluster, honor the etcd_safeguard</span>
</span></span><span style="display:flex;"><span>./etcd.yml -t etcd_purge  <span style="color:#8f5902;font-style:italic"># purge with brutal force, omit the etcd_safeguard</span>
</span></span></code></pre></div><p>The <code>etcd_clean</code> subtask will honor the <a href="/docs/etcd/param/#etcd_safeguard"><code>etcd_safeguard</code></a>,
while the <code>etcd_purge</code> subtask will ignore that and wipe out the entire etcd cluster.</p>
<hr>
<h2 id="cli-environment">CLI Environment</h2>
<p>Pigsty use etcd v3 API by default.</p>
<p>Here&rsquo;s an example of client environment config.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;etcdctl&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">em</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;etcdctl member&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ETCDCTL_ENDPOINTS</span><span style="color:#ce5c00;font-weight:bold">=</span>https://10.10.10.10:2379
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ETCDCTL_CACERT</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/pki/ca.crt
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ETCDCTL_CERT</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/server.crt
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ETCDCTL_KEY</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/server.key
</span></span></code></pre></div><p>You can do CRUD with following commands after setting up the envs:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>e put a <span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#000;font-weight:bold">;</span> e get a<span style="color:#000;font-weight:bold">;</span> e del a <span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic"># V3 API</span>
</span></span></code></pre></div><hr>
<h2 id="reload-config">Reload Config</h2>
<p>In case of permanent etcd cluster membership changes, You&rsquo;ll have to refresh the 4 etcd endpoints references:</p>
<ul>
<li>config file of existing etcd members</li>
<li>etcdctl client environment variables</li>
<li>patroni dcs endpoint config</li>
<li>vip-manager dcs endpoint config</li>
</ul>
<p>To refresh etcd config file <code>/etc/etcd/etcd.conf</code> on existing members:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml -t etcd_conf                           <span style="color:#8f5902;font-style:italic"># refresh /etc/etcd/etcd.conf with latest status</span>
</span></span><span style="display:flex;"><span>ansible etcd -f <span style="color:#0000cf;font-weight:bold">1</span> -b -a <span style="color:#4e9a06">&#39;systemctl restart etcd&#39;</span>  <span style="color:#8f5902;font-style:italic"># optional: restart etcd</span>
</span></span></code></pre></div><p>To refresh <code>etcdctl</code> client environment variables</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./etcd.yml -t etcd_env                          <span style="color:#8f5902;font-style:italic"># refresh /etc/profile.d/etcdctl.sh</span>
</span></span></code></pre></div><p>To update etcd endpoints reference on <code>patroni</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_conf                            <span style="color:#8f5902;font-style:italic"># regenerate patroni config</span>
</span></span><span style="display:flex;"><span>ansible all -f <span style="color:#0000cf;font-weight:bold">1</span> -b -a <span style="color:#4e9a06">&#39;systemctl reload patroni&#39;</span> <span style="color:#8f5902;font-style:italic"># reload patroni config</span>
</span></span></code></pre></div><p>To update etcd endpoints reference on <code>vip-manager</code>, (optional, if you are using a L2 vip)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_vip_config                           <span style="color:#8f5902;font-style:italic"># regenerate vip-manager config</span>
</span></span><span style="display:flex;"><span>ansible all -f <span style="color:#0000cf;font-weight:bold">1</span> -b -a <span style="color:#4e9a06">&#39;systemctl restart vip-manager&#39;</span> <span style="color:#8f5902;font-style:italic"># restart vip-manager to use new config</span>
</span></span></code></pre></div><hr>
<h2 id="add-member">Add Member</h2>
<p>ETCD Reference: <a href="https://etcd.io/docs/v3.5/op-guide/runtime-configuration/#add-a-new-member">Add a member</a></p>
<p>You can add new members to existing etcd cluster in 5 steps:</p>
<ol>
<li>issue <code>etcdctl member add</code> command to tell existing cluster that a new member is coming (use learner mode)</li>
<li>update inventory group <code>etcd</code> with new instance</li>
<li>init the new member with <code>etcd_init=existing</code>, to join the existing cluster rather than create a new one (<strong>VERY IMPORTANT</strong>)</li>
<li>promote the new member from leaner to follower</li>
<li>update etcd endpoints reference with <a href="/docs/etcd/admin/#reload-config">reload-config</a></li>
</ol>
<p><strong>Short Version</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl member add &lt;etcd-?&gt; --learner<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --peer-urls<span style="color:#ce5c00;font-weight:bold">=</span>https://&lt;new_ins_ip&gt;:2380
</span></span><span style="display:flex;"><span>./etcd.yml -l &lt;new_ins_ip&gt; -e <span style="color:#000">etcd_init</span><span style="color:#ce5c00;font-weight:bold">=</span>existing
</span></span><span style="display:flex;"><span>etcdctl member promote &lt;new_ins_server_id&gt;
</span></span></code></pre></div><details><summary>Detail: Add member to etcd cluster</summary>
<p>Here&rsquo;s the detail, let&rsquo;s start from one single etcd instance.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- this is the existing instance</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- add this new member definition to inventory</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Add a learner instance <code>etcd-2</code> to cluster with <code>etcd member add</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># tell the existing cluster that a new member etcd-2 is coming</span>
</span></span><span style="display:flex;"><span>$ etcdctl member add etcd-2 --learner<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --peer-urls<span style="color:#ce5c00;font-weight:bold">=</span>https://10.10.10.11:2380
</span></span><span style="display:flex;"><span>Member 33631ba6ced84cf8 added to cluster 6646fbcf5debc68f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;etcd-2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_INITIAL_CLUSTER</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;etcd-2=https://10.10.10.11:2380,etcd-1=https://10.10.10.10:2380&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://10.10.10.11:2380&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_INITIAL_CLUSTER_STATE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;existing&#34;</span>
</span></span></code></pre></div><p>Check the member list with <code>etcdctl member list</code> (or <code>em list</code>), we can see an <code>unstarted</code> member:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>33631ba6ced84cf8, unstarted, , https://10.10.10.11:2380, , true
</span></span><span style="display:flex;"><span>429ee12c7fbab5c1, started, etcd-1, https://10.10.10.10:2380, https://10.10.10.10:2379, false
</span></span></code></pre></div><p>Init the new etcd instance <code>etcd-2</code> with <code>etcd.yml</code> playbook, we can see the new member is started:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./etcd.yml -l 10.10.10.11 -e <span style="color:#000">etcd_init</span><span style="color:#ce5c00;font-weight:bold">=</span>existing    <span style="color:#8f5902;font-style:italic"># etcd_init=existing must be set</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>33631ba6ced84cf8, started, etcd-2, https://10.10.10.11:2380, https://10.10.10.11:2379, <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>429ee12c7fbab5c1, started, etcd-1, https://10.10.10.10:2380, https://10.10.10.10:2379, <span style="color:#204a87">false</span>
</span></span></code></pre></div><p>Promote the new member, from leaner to follower:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ etcdctl member promote 33631ba6ced84cf8   <span style="color:#8f5902;font-style:italic"># promote the new learner</span>
</span></span><span style="display:flex;"><span>Member 33631ba6ced84cf8 promoted in cluster 6646fbcf5debc68f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ em list                <span style="color:#8f5902;font-style:italic"># check again, the new member is started</span>
</span></span><span style="display:flex;"><span>33631ba6ced84cf8, started, etcd-2, https://10.10.10.11:2380, https://10.10.10.11:2379, <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>429ee12c7fbab5c1, started, etcd-1, https://10.10.10.10:2380, https://10.10.10.10:2379, fals
</span></span></code></pre></div><p>The new member is added, don&rsquo;t forget to <a href="/docs/etcd/admin/#reload-config">reload config</a>.</p>
<p>Repeat the steps above to add more members. remember to use at least 3 members for production.</p>
</details>
<hr>
<h2 id="remove-member">Remove Member</h2>
<p>To remove a member from existing etcd cluster, it usually takes 3 steps:</p>
<ol>
<li>remove/uncomment it from inventory and <a href="/docs/etcd/admin/#reload-config">reload config</a></li>
<li>remove it with <code>etcdctl member remove &lt;server_id&gt;</code> command and kick it out of the cluster</li>
<li>temporarily add it back to inventory and purge that instance, then remove it from inventory permanently</li>
</ol>
<details><summary>Detail: Remove member from etcd cluster</summary>
<p>Here&rsquo;s the detail, let&rsquo;s start from a 3 instance etcd cluster:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># &lt;---- comment this line, then reload-config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Then, you&rsquo;ll have to actually kick it from cluster with <code>etcdctl member remove</code> command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ etcdctl member list
</span></span><span style="display:flex;"><span>429ee12c7fbab5c1, started, etcd-1, https://10.10.10.10:2380, https://10.10.10.10:2379, <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>33631ba6ced84cf8, started, etcd-2, https://10.10.10.11:2380, https://10.10.10.11:2379, <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>93fcf23b220473fb, started, etcd-3, https://10.10.10.12:2380, https://10.10.10.12:2379, <span style="color:#204a87">false</span>  <span style="color:#8f5902;font-style:italic"># &lt;--- remove this</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ etcdctl member remove 93fcf23b220473fb  <span style="color:#8f5902;font-style:italic"># kick it from cluster</span>
</span></span><span style="display:flex;"><span>Member 93fcf23b220473fb removed from cluster 6646fbcf5debc68f
</span></span></code></pre></div><p>Finally, you have to shut down the instance, and purge it from node, you have to uncomment the member in inventory temporarily, then purge it with <code>etcd.yml</code> playbook:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml -t etcd_purge -l 10.10.10.12   <span style="color:#8f5902;font-style:italic"># purge it (the member is in inventory again)</span>
</span></span></code></pre></div><p>After that, remove the member from inventory permanently, all clear!</p>
</details>
<br>
<hr>
<br>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e584a5e6bb1de156a6ab3580a5451148">5 - Monitoring</h1>
    <div class="lead">Etcd monitoring metrics, dashboards, and alerting rules</div>
	<hr>
<h2 id="dashboard">Dashboard</h2>
<p>The ETCD module provides a monitoring dashboard: Etcd Overview.</p>
<h3 id="etcd-overview-dashboard">ETCD Overview Dashboard</h3>
<p><a href="https://demo.pigsty.cc/d/etcd-overview">ETCD Overview</a>: Overview of the ETCD cluster</p>
<p>This dashboard provides key information about the ETCD status, with the most notable being ETCD Aliveness, which displays the overall service status of the ETCD cluster.</p>
<p>Red bands indicate periods when instances are unavailable, while the blue-gray bands below show when the entire cluster is unavailable.</p>
<p><a href="https://demo.pigsty.cc/d/etcd-overview"><img alt="etcd-overview.jpg" src="/img/dashboard/etcd-overview.jpg"></a></p>
<hr>
<h2 id="alert-rules">Alert Rules</h2>
<p>Pigsty provides the following five preset alert rules for Etcd, defined in <a href="https://github.com/Vonng/pigsty/blob/main/files/prometheus/rules/etcd.yml"><code>files/prometheus/rules/etcd.yml</code></a>:</p>
<ul>
<li><code>EtcdServerDown</code>: Etcd node down, critical alert</li>
<li><code>EtcdNoLeader</code>: Etcd cluster has no leader, critical alert</li>
<li><code>EtcdQuotaFull</code>: Etcd quota usage exceeds 90%, warning</li>
<li><code>EtcdNetworkPeerRTSlow</code>: Etcd network latency is slow, notice</li>
<li><code>EtcdWalFsyncSlow</code>: Etcd disk fsync is slow, notice</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#==============================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                         Aliveness                            #</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#==============================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># etcd server instance down</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">alert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EtcdServerDown</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd_up &lt; 1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">level: 0, severity: CRIT, category</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">summary</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;CRIT EtcdServerDown {{ $labels.ins }}@{{ $labels.instance }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">description</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      etcd_up[ins={{ $labels.ins }}, instance={{ $labels.instance }}] = {{ $value }} &lt; 1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      http://g.pigsty/d/etcd-overview</span><span style="color:#f8f8f8;text-decoration:underline">      
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#==============================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                         Error                                #</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#==============================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Etcd no Leader triggers a P0 alert immediately</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># if dcs_failsafe mode is not enabled, this may lead to global outage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">alert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EtcdNoLeader</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">min(etcd_server_has_leader) by (cls) &lt; 1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">15s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">level: 0, severity: CRIT, category</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">summary</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;CRIT EtcdNoLeader: {{ $labels.cls }} {{ $value }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">description</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      etcd_server_has_leader[cls={{ $labels.cls }}] = {{ $value }} &lt; 1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      http://g.pigsty/d/etcd-overview?from=now-5m&amp;to=now&amp;var-cls={{$labels.cls}}</span><span style="color:#f8f8f8;text-decoration:underline">      
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#==============================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                        Saturation                            #</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#==============================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">alert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EtcdQuotaFull</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd:cls:quota_usage &gt; 0.90</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">level: 1, severity: WARN, category</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">summary</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;WARN EtcdQuotaFull: {{ $labels.cls }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">description</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      etcd:cls:quota_usage[cls={{ $labels.cls }}] = {{ $value | printf &#34;%.3f&#34; }} &gt; 90%</span><span style="color:#f8f8f8;text-decoration:underline">      
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#==============================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                         Latency                              #</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#==============================================================#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># etcd network peer rt p95 &gt; 200ms for 1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">alert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EtcdNetworkPeerRTSlow</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd:ins:network_peer_rt_p95_5m &gt; 0.200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">level: 2, severity: INFO, category</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">summary</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;INFO EtcdNetworkPeerRTSlow: {{ $labels.cls }} {{ $labels.ins }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">description</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      etcd:ins:network_peer_rt_p95_5m[cls={{ $labels.cls }}, ins={{ $labels.ins }}] = {{ $value }} &gt; 200ms
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      http://g.pigsty/d/etcd-instance?from=now-10m&amp;to=now&amp;var-cls={{ $labels.cls }}</span><span style="color:#f8f8f8;text-decoration:underline">      
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Etcd wal fsync rt p95 &gt; 50ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">alert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EtcdWalFsyncSlow</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">expr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd:ins:wal_fsync_rt_p95_5m &gt; 0.050</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">level: 2, severity: INFO, category</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">summary</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;INFO EtcdWalFsyncSlow: {{ $labels.cls }} {{ $labels.ins }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">description</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      etcd:ins:wal_fsync_rt_p95_5m[cls={{ $labels.cls }}, ins={{ $labels.ins }}] = {{ $value }} &gt; 50ms
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      http://g.pigsty/d/etcd-instance?from=now-10m&amp;to=now&amp;var-cls={{ $labels.cls }}</span><span style="color:#f8f8f8;text-decoration:underline">      
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b4db80f8234d7db0cbf16b40530478bd">6 - Metrics</h1>
    <div class="lead">Pigsty ETCD module metric list</div>
	<p><a href="/docs/etcd/"><strong><code>ETCD</code></strong></a> module has 177 available metrics</p>
<table>
<thead>
<tr>
<th>Metric Name</th>
<th>Type</th>
<th>Labels</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>etcd:ins:backend_commit_rt_p99_5m</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd:ins:disk_fsync_rt_p99_5m</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd:ins:network_peer_rt_p99_1m</td>
<td>Unknown</td>
<td><code>cls</code>, <code>To</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_cluster_version</td>
<td>gauge</td>
<td><code>cls</code>, <code>cluster_version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Which version is running. 1 for &lsquo;cluster_version&rsquo; label with current cluster version</td>
</tr>
<tr>
<td>etcd_debugging_auth_revision</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The current revision of auth store.</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_rebalance_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_rebalance_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_spill_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_spill_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_spill_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_write_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_write_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_disk_backend_commit_write_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_lease_granted_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of granted leases.</td>
</tr>
<tr>
<td>etcd_debugging_lease_renewed_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The number of renewed leases seen by the leader.</td>
</tr>
<tr>
<td>etcd_debugging_lease_revoked_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of revoked leases.</td>
</tr>
<tr>
<td>etcd_debugging_lease_ttl_total_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_lease_ttl_total_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_lease_ttl_total_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_compact_revision</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The revision of the last compaction in store.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_current_revision</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The current revision of store.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_db_compaction_keys_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of db keys compacted.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_db_compaction_last</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The unix time of the last db compaction. Resets to 0 on start.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_db_compaction_pause_duration_milliseconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_db_compaction_pause_duration_milliseconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_db_compaction_pause_duration_milliseconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_db_compaction_total_duration_milliseconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_db_compaction_total_duration_milliseconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_db_compaction_total_duration_milliseconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_events_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of events sent by this member.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_index_compaction_pause_duration_milliseconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_index_compaction_pause_duration_milliseconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_index_compaction_pause_duration_milliseconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_keys_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of keys.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_pending_events_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of pending events to be sent.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_range_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of ranges seen by this member.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_slow_watcher_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of unsynced slow watchers.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_total_put_size_in_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total size of put kv pairs seen by this member.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_watch_stream_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of watch streams.</td>
</tr>
<tr>
<td>etcd_debugging_mvcc_watcher_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of watchers.</td>
</tr>
<tr>
<td>etcd_debugging_server_lease_expired_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of expired leases.</td>
</tr>
<tr>
<td>etcd_debugging_snap_save_marshalling_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_snap_save_marshalling_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_snap_save_marshalling_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_snap_save_total_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_snap_save_total_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_snap_save_total_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_debugging_store_expires_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of expired keys.</td>
</tr>
<tr>
<td>etcd_debugging_store_reads_total</td>
<td>counter</td>
<td><code>cls</code>, <code>action</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of reads action by (get/getRecursive), local to this member.</td>
</tr>
<tr>
<td>etcd_debugging_store_watch_requests_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of incoming watch requests (new or reestablished).</td>
</tr>
<tr>
<td>etcd_debugging_store_watchers</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Count of currently active watchers.</td>
</tr>
<tr>
<td>etcd_debugging_store_writes_total</td>
<td>counter</td>
<td><code>cls</code>, <code>action</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of writes (e.g. set/compareAndDelete) seen by this member.</td>
</tr>
<tr>
<td>etcd_disk_backend_commit_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_backend_commit_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_backend_commit_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_backend_defrag_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_backend_defrag_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_backend_defrag_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_backend_snapshot_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_backend_snapshot_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_backend_snapshot_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_defrag_inflight</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Whether or not defrag is active on the member. 1 means active, 0 means not.</td>
</tr>
<tr>
<td>etcd_disk_wal_fsync_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_wal_fsync_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_wal_fsync_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_disk_wal_write_bytes_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of bytes written in WAL.</td>
</tr>
<tr>
<td>etcd_grpc_proxy_cache_hits_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of cache hits</td>
</tr>
<tr>
<td>etcd_grpc_proxy_cache_keys_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of keys/ranges cached</td>
</tr>
<tr>
<td>etcd_grpc_proxy_cache_misses_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of cache misses</td>
</tr>
<tr>
<td>etcd_grpc_proxy_events_coalescing_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of events coalescing</td>
</tr>
<tr>
<td>etcd_grpc_proxy_watchers_coalescing_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of current watchers coalescing</td>
</tr>
<tr>
<td>etcd_mvcc_db_open_read_transactions</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The number of currently open read transactions</td>
</tr>
<tr>
<td>etcd_mvcc_db_total_size_in_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total size of the underlying database physically allocated in bytes.</td>
</tr>
<tr>
<td>etcd_mvcc_db_total_size_in_use_in_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total size of the underlying database logically in use in bytes.</td>
</tr>
<tr>
<td>etcd_mvcc_delete_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of deletes seen by this member.</td>
</tr>
<tr>
<td>etcd_mvcc_hash_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_mvcc_hash_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_mvcc_hash_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_mvcc_hash_rev_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_mvcc_hash_rev_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_mvcc_hash_rev_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_mvcc_put_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of puts seen by this member.</td>
</tr>
<tr>
<td>etcd_mvcc_range_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of ranges seen by this member.</td>
</tr>
<tr>
<td>etcd_mvcc_txn_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of txns seen by this member.</td>
</tr>
<tr>
<td>etcd_network_active_peers</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>Local</code>, <code>instance</code>, <code>job</code>, <code>ip</code>, <code>Remote</code></td>
<td>The current number of active peer connections.</td>
</tr>
<tr>
<td>etcd_network_client_grpc_received_bytes_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of bytes received from grpc clients.</td>
</tr>
<tr>
<td>etcd_network_client_grpc_sent_bytes_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of bytes sent to grpc clients.</td>
</tr>
<tr>
<td>etcd_network_peer_received_bytes_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code>, <code>From</code></td>
<td>The total number of bytes received from peers.</td>
</tr>
<tr>
<td>etcd_network_peer_round_trip_time_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>To</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_network_peer_round_trip_time_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>To</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_network_peer_round_trip_time_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>To</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_network_peer_sent_bytes_total</td>
<td>counter</td>
<td><code>cls</code>, <code>To</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of bytes sent to peers.</td>
</tr>
<tr>
<td>etcd_server_apply_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>success</code>, <code>ip</code>, <code>op</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_server_apply_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>success</code>, <code>ip</code>, <code>op</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_server_apply_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>success</code>, <code>ip</code>, <code>op</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_server_client_requests_total</td>
<td>counter</td>
<td><code>client_api_version</code>, <code>cls</code>, <code>ins</code>, <code>instance</code>, <code>type</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of client requests per client version.</td>
</tr>
<tr>
<td>etcd_server_go_version</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>server_go_version</code>, <code>ip</code></td>
<td>Which Go version server is running with. 1 for &lsquo;server_go_version&rsquo; label with current version.</td>
</tr>
<tr>
<td>etcd_server_has_leader</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Whether or not a leader exists. 1 is existence, 0 is not.</td>
</tr>
<tr>
<td>etcd_server_health_failures</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of failed health checks</td>
</tr>
<tr>
<td>etcd_server_health_success</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of successful health checks</td>
</tr>
<tr>
<td>etcd_server_heartbeat_send_failures_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of leader heartbeat send failures (likely overloaded from slow disk).</td>
</tr>
<tr>
<td>etcd_server_id</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>server_id</code>, <code>ip</code></td>
<td>Server or member ID in hexadecimal format. 1 for &lsquo;server_id&rsquo; label with current ID.</td>
</tr>
<tr>
<td>etcd_server_is_leader</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Whether or not this member is a leader. 1 if is, 0 otherwise.</td>
</tr>
<tr>
<td>etcd_server_is_learner</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Whether or not this member is a learner. 1 if is, 0 otherwise.</td>
</tr>
<tr>
<td>etcd_server_leader_changes_seen_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The number of leader changes seen.</td>
</tr>
<tr>
<td>etcd_server_learner_promote_successes</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of successful learner promotions while this member is leader.</td>
</tr>
<tr>
<td>etcd_server_proposals_applied_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of consensus proposals applied.</td>
</tr>
<tr>
<td>etcd_server_proposals_committed_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of consensus proposals committed.</td>
</tr>
<tr>
<td>etcd_server_proposals_failed_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of failed proposals seen.</td>
</tr>
<tr>
<td>etcd_server_proposals_pending</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The current number of pending proposals to commit.</td>
</tr>
<tr>
<td>etcd_server_quota_backend_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Current backend storage quota size in bytes.</td>
</tr>
<tr>
<td>etcd_server_read_indexes_failed_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of failed read indexes seen.</td>
</tr>
<tr>
<td>etcd_server_slow_apply_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of slow apply requests (likely overloaded from slow disk).</td>
</tr>
<tr>
<td>etcd_server_slow_read_indexes_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The total number of pending read indexes not in sync with leader&rsquo;s or timed out read index requests.</td>
</tr>
<tr>
<td>etcd_server_snapshot_apply_in_progress_total</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>1 if the server is applying the incoming snapshot. 0 if none.</td>
</tr>
<tr>
<td>etcd_server_version</td>
<td>gauge</td>
<td><code>cls</code>, <code>server_version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Which version is running. 1 for &lsquo;server_version&rsquo; label with current version.</td>
</tr>
<tr>
<td>etcd_snap_db_fsync_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_snap_db_fsync_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_snap_db_fsync_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_snap_db_save_total_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_snap_db_save_total_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_snap_db_save_total_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_snap_fsync_duration_seconds_bucket</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_snap_fsync_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_snap_fsync_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>etcd_up</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>go_gc_duration_seconds</td>
<td>summary</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>quantile</code>, <code>job</code>, <code>ip</code></td>
<td>A summary of the pause duration of garbage collection cycles.</td>
</tr>
<tr>
<td>go_gc_duration_seconds_count</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>go_gc_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>go_goroutines</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of goroutines that currently exist.</td>
</tr>
<tr>
<td>go_info</td>
<td>gauge</td>
<td><code>cls</code>, <code>version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Information about the Go environment.</td>
</tr>
<tr>
<td>go_memstats_alloc_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes allocated and still in use.</td>
</tr>
<tr>
<td>go_memstats_alloc_bytes_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of bytes allocated, even if freed.</td>
</tr>
<tr>
<td>go_memstats_buck_hash_sys_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes used by the profiling bucket hash table.</td>
</tr>
<tr>
<td>go_memstats_frees_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of frees.</td>
</tr>
<tr>
<td>go_memstats_gc_cpu_fraction</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The fraction of this program&rsquo;s available CPU time used by the GC since the program started.</td>
</tr>
<tr>
<td>go_memstats_gc_sys_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes used for garbage collection system metadata.</td>
</tr>
<tr>
<td>go_memstats_heap_alloc_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of heap bytes allocated and still in use.</td>
</tr>
<tr>
<td>go_memstats_heap_idle_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of heap bytes waiting to be used.</td>
</tr>
<tr>
<td>go_memstats_heap_inuse_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of heap bytes that are in use.</td>
</tr>
<tr>
<td>go_memstats_heap_objects</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of allocated objects.</td>
</tr>
<tr>
<td>go_memstats_heap_released_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of heap bytes released to OS.</td>
</tr>
<tr>
<td>go_memstats_heap_sys_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of heap bytes obtained from system.</td>
</tr>
<tr>
<td>go_memstats_last_gc_time_seconds</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of seconds since 1970 of last garbage collection.</td>
</tr>
<tr>
<td>go_memstats_lookups_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of pointer lookups.</td>
</tr>
<tr>
<td>go_memstats_mallocs_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total number of mallocs.</td>
</tr>
<tr>
<td>go_memstats_mcache_inuse_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes in use by mcache structures.</td>
</tr>
<tr>
<td>go_memstats_mcache_sys_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes used for mcache structures obtained from system.</td>
</tr>
<tr>
<td>go_memstats_mspan_inuse_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes in use by mspan structures.</td>
</tr>
<tr>
<td>go_memstats_mspan_sys_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes used for mspan structures obtained from system.</td>
</tr>
<tr>
<td>go_memstats_next_gc_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of heap bytes when next garbage collection will take place.</td>
</tr>
<tr>
<td>go_memstats_other_sys_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes used for other system allocations.</td>
</tr>
<tr>
<td>go_memstats_stack_inuse_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes in use by the stack allocator.</td>
</tr>
<tr>
<td>go_memstats_stack_sys_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes obtained from system for stack allocator.</td>
</tr>
<tr>
<td>go_memstats_sys_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of bytes obtained from system.</td>
</tr>
<tr>
<td>go_threads</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of OS threads created.</td>
</tr>
<tr>
<td>grpc_server_handled_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>grpc_code</code>, <code>job</code>, <code>grpc_method</code>, <code>grpc_type</code>, <code>ip</code>, <code>grpc_service</code></td>
<td>Total number of RPCs completed on the server, regardless of success or failure.</td>
</tr>
<tr>
<td>grpc_server_msg_received_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>grpc_type</code>, <code>grpc_method</code>, <code>ip</code>, <code>grpc_service</code></td>
<td>Total number of RPC stream messages received on the server.</td>
</tr>
<tr>
<td>grpc_server_msg_sent_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>grpc_type</code>, <code>grpc_method</code>, <code>ip</code>, <code>grpc_service</code></td>
<td>Total number of gRPC stream messages sent by the server.</td>
</tr>
<tr>
<td>grpc_server_started_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>grpc_type</code>, <code>grpc_method</code>, <code>ip</code>, <code>grpc_service</code></td>
<td>Total number of RPCs started on the server.</td>
</tr>
<tr>
<td>os_fd_limit</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The file descriptor limit.</td>
</tr>
<tr>
<td>os_fd_used</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>The number of used file descriptors.</td>
</tr>
<tr>
<td>process_cpu_seconds_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Total user and system CPU time spent in seconds.</td>
</tr>
<tr>
<td>process_max_fds</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Maximum number of open file descriptors.</td>
</tr>
<tr>
<td>process_open_fds</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Number of open file descriptors.</td>
</tr>
<tr>
<td>process_resident_memory_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Resident memory size in bytes.</td>
</tr>
<tr>
<td>process_start_time_seconds</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Start time of the process since unix epoch in seconds.</td>
</tr>
<tr>
<td>process_virtual_memory_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Virtual memory size in bytes.</td>
</tr>
<tr>
<td>process_virtual_memory_max_bytes</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Maximum amount of virtual memory available in bytes.</td>
</tr>
<tr>
<td>promhttp_metric_handler_requests_in_flight</td>
<td>gauge</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>Current number of scrapes being served.</td>
</tr>
<tr>
<td>promhttp_metric_handler_requests_total</td>
<td>counter</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code>, <code>code</code></td>
<td>Total number of scrapes by HTTP status code.</td>
</tr>
<tr>
<td>scrape_duration_seconds</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>scrape_samples_post_metric_relabeling</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>scrape_samples_scraped</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>scrape_series_added</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
<tr>
<td>up</td>
<td>Unknown</td>
<td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td>
<td>N/A</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bfaeae9f961d15c2f4a30d7af548af0c">7 - FAQ</h1>
    <div class="lead">Pigsty ETCD dcs module frequently asked questions</div>
	<hr>
<h2 id="what-is-the-role-of-the-etcd-in-pigsty">What is the role of the etcd in pigsty?</h2>
<p>etcd is a distributed, reliable key-value store used to store the most critical config / consensus data in the deployment.
Pigsty uses etcd as the DCS (Distributed Configuration Store) service for Patroni, which will store the high availability status information of the PostgreSQL cluster.</p>
<hr>
<h2 id="how-many-etcd-instance-should-i-choose">How many etcd instance should I choose?</h2>
<p>If more than (include) half of the etcd instances are down, the etcd cluster and its service will be unavailable.</p>
<p>For example, a 3-node etcd cluster can tolerate at most one node failure, and the other two nodes can still work normally; while a 5-node etcd cluster can tolerate 2 node failures.</p>
<p>Beware that the <strong>learner</strong> instances in the etcd cluster do not count in the member number, so in a 3-node etcd cluster, if there is a learner instance, the actual member count is 2, so no node failure can be tolerated.</p>
<p>It is advisable to choose an odd number of etcd instances to avoid split-brain scenarios. It is recommended to use 3 or 5 nodes for the production environment.</p>
<hr>
<h2 id="what-is-the-impact-of-etcd-failure">What is the impact of etcd failure?</h2>
<p>If etcd cluster is unavailable, it will affect the control plane of Pigsty, but not the data plane - the existing PostgreSQL cluster will continue to serve, but admin operations through Patroni will not work.</p>
<p>During etcd failure, PostgreSQL HA is unable to perform automatic failover, and most of the Patroni operations will be blocked, such as edit-config, restart, switchover, etc&hellip;
Admin tasks through Ansible playbooks are usually not affected by etcd failure, such as create database, create user, reload HBA and Service, etc&hellip;, And you can always operate the PostgreSQL cluster directly to achieve most of the patroni functions.</p>
<p>Beware that the above description is only applicable to newer versions of Patroni (&gt;=3.0, Pigsty &gt;= 2.0). If you are using an older version of Patroni (&lt;3.0, corresponding to Pigsty version 1.x), etcd / consul failure will cause a serious impact:
All PostgreSQL clusters will be demoted and reject write requests, and etcd failure will be amplified as a global PostgreSQL failure. After Patroni 3.0&rsquo;s DCS Failsafe feature, this situation has been significantly improved.</p>
<hr>
<h2 id="what-data-is-stored-in-the-etcd-cluster">What data is stored in the etcd cluster?</h2>
<p>etcd is only used for PostgreSQL HA consensus in Pigsty, no other data is stored in etcd by default.</p>
<p>These consensus data are managed by Patroni, and when these data are lost in etcd, Patroni will automatically rebuild them.</p>
<p>Thus, by default, the <strong>etcd</strong> in Pigsty can be regarded as a &ldquo;stateless service&rdquo; that is disposable, which brings great convenience to maintenance work.</p>
<p>If you use etcd for other purposes, such as storing metadata for Kubernetes, or storing other data, you need to back up the etcd data yourself and restore the data after the etcd cluster is restored.</p>
<hr>
<h2 id="how-to-recover-from-etcd-failure">How to recover from etcd failure?</h2>
<p>Since etcd is disposable in Pigsty, you can quickly stop the bleeding by &ldquo;restarting&rdquo; or &ldquo;redeploying&rdquo; etcd in case of failure.</p>
<p>To <strong>Restart</strong> the etcd cluster, you can use the following Ansible command (or <code>systemctl restart etcd</code>):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml -t etcd_launch
</span></span></code></pre></div><p>To <strong>Reset</strong> the etcd cluster, you can run this playbook, it will <strong>nuke</strong> the etcd cluster and redeploy it:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./etcd.yml
</span></span></code></pre></div><p>Beware that if you use etcd to store other data, don&rsquo;t forget to backup etcd data before nuking the etcd cluster.</p>
<hr>
<h2 id="is-any-maintenance-work-for-etcd-cluster">Is any maintenance work for etcd cluster?</h2>
<p>In short: do not use all the <strong>quota</strong> of etcd.</p>
<p>etcd has a default quota for database size of 2GB, if your etcd database size exceeds this limit, etcd will reject write requests.
Meanwhile, as etcd&rsquo;s <a href="https://etcd.io/docs/v3.5/learning/data_model/">data model</a> illustrates, each write will generate a new version (a.k.a. revision),
so if your etcd cluster writes frequently, even with very few keys, the etcd database size may continue to grow, and may fail when it reaches the quota limit.</p>
<p>You can achieve this by <strong>Auto Compact</strong>, <strong>Manual Compact</strong>, <strong>Defragmentation</strong>, and <strong>Quota Increase</strong>, etc., please refer to the etcd <a href="https://etcd.io/docs/v3.5/op-guide/maintenance/">official maintenance guide</a>.</p>
<p>Pigsty has auto compact enabled by default since v2.6, so you usually don&rsquo;t have to worry about etcd full.
For versions before v2.6, we <strong>strongly recommend</strong> enabling etcd&rsquo;s auto compact feature in the production environment.</p>


<div class="alert alert-danger" role="alert">
<h4 class="alert-heading">Fill etcd may lead to PostgreSQL failure!</h4>

    For Pigsty v2.0 - v2.5 users, we strongly recommend upgrading to a newer version, or following the instructions below to enable etcd auto compaction!

</div>

<hr>
<h2 id="how-to-enable-etcd-auto-compaction">How to enable etcd auto compaction?</h2>
<p>If you are using an earlier version of Pigsty (v2.0 - v2.5), we strongly recommend that you enable etcd&rsquo;s auto compaction feature in the production environment.</p>
<p>Edit the etcd config template in <a href="https://github.com/Vonng/pigsty/blob/main/roles/etcd/templates/etcd.conf.j2#L30"><code>roles/etcd/templates/etcd.conf.j2</code></a> with these 3 new lines:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">auto-compaction-mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">periodic</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">auto-compaction-retention</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;24h&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">quota-backend-bytes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">17179869184</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You can set all the PostgreSQL cluster to <strong>maintenance mode</strong> and then redeploy the etcd cluster with <code>./etcd.yml</code> to apply the these changes.</p>
<p>It will increase the etcd default quota from 2 GiB to 16 GiB, and ensure that only the most recent day&rsquo;s write history is retained, avoiding the infinite growth of the etcd database size.</p>
<hr>
<h2 id="where-does-the-postgresql-ha-data-stored-in-etcd">Where does the PostgreSQL HA data stored in etcd?</h2>
<p>Patroni will use the <a href="/docs/reference/param/#pg_namespace"><strong><code>pg_namespace</code></strong></a> (default is <code>/pg</code>) as the prefix for all metadata keys in etcd, followed by the PostgreSQL cluster name.</p>
<p>For example, a PG cluster named <code>pg-meta</code>, its metadata keys will be stored under <code>/pg/pg-meta</code>, which may look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/pg/pg-meta/config
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;ttl&#34;</span>:30,<span style="color:#4e9a06">&#34;loop_wait&#34;</span>:10,<span style="color:#4e9a06">&#34;retry_timeout&#34;</span>:10,<span style="color:#4e9a06">&#34;primary_start_timeout&#34;</span>:10,<span style="color:#4e9a06">&#34;maximum_lag_on_failover&#34;</span>:1048576,<span style="color:#4e9a06">&#34;maximum_lag_on_syncnode&#34;</span>:-1,<span style="color:#4e9a06">&#34;primary_stop_timeout&#34;</span>:30,<span style="color:#4e9a06">&#34;synchronous_mode&#34;</span>:false,<span style="color:#4e9a06">&#34;synchronous_mode_strict&#34;</span>:false,<span style="color:#4e9a06">&#34;failsafe_mode&#34;</span>:true,<span style="color:#4e9a06">&#34;pg_version&#34;</span>:16,<span style="color:#4e9a06">&#34;pg_cluster&#34;</span>:<span style="color:#4e9a06">&#34;pg-meta&#34;</span>,<span style="color:#4e9a06">&#34;pg_shard&#34;</span>:<span style="color:#4e9a06">&#34;pg-meta&#34;</span>,<span style="color:#4e9a06">&#34;pg_group&#34;</span>:0,<span style="color:#4e9a06">&#34;postgresql&#34;</span>:<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;use_slots&#34;</span>:true,<span style="color:#4e9a06">&#34;use_pg_rewind&#34;</span>:true,<span style="color:#4e9a06">&#34;remove_data_directory_on_rewind_failure&#34;</span>:true,<span style="color:#4e9a06">&#34;parameters&#34;</span>:<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;max_connections&#34;</span>:100,<span style="color:#4e9a06">&#34;superuser_reserved_connections&#34;</span>:10,<span style="color:#4e9a06">&#34;max_locks_per_transaction&#34;</span>:200,<span style="color:#4e9a06">&#34;max_prepared_transactions&#34;</span>:0,<span style="color:#4e9a06">&#34;track_commit_timestamp&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;wal_level&#34;</span>:<span style="color:#4e9a06">&#34;logical&#34;</span>,<span style="color:#4e9a06">&#34;wal_log_hints&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;max_worker_processes&#34;</span>:16,<span style="color:#4e9a06">&#34;max_wal_senders&#34;</span>:50,<span style="color:#4e9a06">&#34;max_replication_slots&#34;</span>:50,<span style="color:#4e9a06">&#34;password_encryption&#34;</span>:<span style="color:#4e9a06">&#34;scram-sha-256&#34;</span>,<span style="color:#4e9a06">&#34;ssl&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;ssl_cert_file&#34;</span>:<span style="color:#4e9a06">&#34;/pg/cert/server.crt&#34;</span>,<span style="color:#4e9a06">&#34;ssl_key_file&#34;</span>:<span style="color:#4e9a06">&#34;/pg/cert/server.key&#34;</span>,<span style="color:#4e9a06">&#34;ssl_ca_file&#34;</span>:<span style="color:#4e9a06">&#34;/pg/cert/ca.crt&#34;</span>,<span style="color:#4e9a06">&#34;shared_buffers&#34;</span>:<span style="color:#4e9a06">&#34;7969MB&#34;</span>,<span style="color:#4e9a06">&#34;maintenance_work_mem&#34;</span>:<span style="color:#4e9a06">&#34;1993MB&#34;</span>,<span style="color:#4e9a06">&#34;work_mem&#34;</span>:<span style="color:#4e9a06">&#34;79MB&#34;</span>,<span style="color:#4e9a06">&#34;max_parallel_workers&#34;</span>:8,<span style="color:#4e9a06">&#34;max_parallel_maintenance_workers&#34;</span>:2,<span style="color:#4e9a06">&#34;max_parallel_workers_per_gather&#34;</span>:0,<span style="color:#4e9a06">&#34;hash_mem_multiplier&#34;</span>:8.0,<span style="color:#4e9a06">&#34;huge_pages&#34;</span>:<span style="color:#4e9a06">&#34;try&#34;</span>,<span style="color:#4e9a06">&#34;temp_file_limit&#34;</span>:<span style="color:#4e9a06">&#34;7GB&#34;</span>,<span style="color:#4e9a06">&#34;vacuum_cost_delay&#34;</span>:<span style="color:#4e9a06">&#34;20ms&#34;</span>,<span style="color:#4e9a06">&#34;vacuum_cost_limit&#34;</span>:2000,<span style="color:#4e9a06">&#34;bgwriter_delay&#34;</span>:<span style="color:#4e9a06">&#34;10ms&#34;</span>,<span style="color:#4e9a06">&#34;bgwriter_lru_maxpages&#34;</span>:800,<span style="color:#4e9a06">&#34;bgwriter_lru_multiplier&#34;</span>:5.0,<span style="color:#4e9a06">&#34;min_wal_size&#34;</span>:<span style="color:#4e9a06">&#34;7GB&#34;</span>,<span style="color:#4e9a06">&#34;max_wal_size&#34;</span>:<span style="color:#4e9a06">&#34;28GB&#34;</span>,<span style="color:#4e9a06">&#34;max_slot_wal_keep_size&#34;</span>:<span style="color:#4e9a06">&#34;42GB&#34;</span>,<span style="color:#4e9a06">&#34;wal_buffers&#34;</span>:<span style="color:#4e9a06">&#34;16MB&#34;</span>,<span style="color:#4e9a06">&#34;wal_writer_delay&#34;</span>:<span style="color:#4e9a06">&#34;20ms&#34;</span>,<span style="color:#4e9a06">&#34;wal_writer_flush_after&#34;</span>:<span style="color:#4e9a06">&#34;1MB&#34;</span>,<span style="color:#4e9a06">&#34;commit_delay&#34;</span>:20,<span style="color:#4e9a06">&#34;commit_siblings&#34;</span>:10,<span style="color:#4e9a06">&#34;checkpoint_timeout&#34;</span>:<span style="color:#4e9a06">&#34;15min&#34;</span>,<span style="color:#4e9a06">&#34;checkpoint_completion_target&#34;</span>:0.8,<span style="color:#4e9a06">&#34;archive_mode&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;archive_timeout&#34;</span>:300,<span style="color:#4e9a06">&#34;archive_command&#34;</span>:<span style="color:#4e9a06">&#34;pgbackrest --stanza=pg-meta archive-push %p&#34;</span>,<span style="color:#4e9a06">&#34;max_standby_archive_delay&#34;</span>:<span style="color:#4e9a06">&#34;10min&#34;</span>,<span style="color:#4e9a06">&#34;max_standby_streaming_delay&#34;</span>:<span style="color:#4e9a06">&#34;3min&#34;</span>,<span style="color:#4e9a06">&#34;wal_receiver_status_interval&#34;</span>:<span style="color:#4e9a06">&#34;1s&#34;</span>,<span style="color:#4e9a06">&#34;hot_standby_feedback&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;wal_receiver_timeout&#34;</span>:<span style="color:#4e9a06">&#34;60s&#34;</span>,<span style="color:#4e9a06">&#34;max_logical_replication_workers&#34;</span>:8,<span style="color:#4e9a06">&#34;max_sync_workers_per_subscription&#34;</span>:6,<span style="color:#4e9a06">&#34;random_page_cost&#34;</span>:1.1,<span style="color:#4e9a06">&#34;effective_io_concurrency&#34;</span>:1000,<span style="color:#4e9a06">&#34;effective_cache_size&#34;</span>:<span style="color:#4e9a06">&#34;23907MB&#34;</span>,<span style="color:#4e9a06">&#34;default_statistics_target&#34;</span>:200,<span style="color:#4e9a06">&#34;log_destination&#34;</span>:<span style="color:#4e9a06">&#34;csvlog&#34;</span>,<span style="color:#4e9a06">&#34;logging_collector&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;log_directory&#34;</span>:<span style="color:#4e9a06">&#34;/pg/log/postgres&#34;</span>,<span style="color:#4e9a06">&#34;log_filename&#34;</span>:<span style="color:#4e9a06">&#34;postgresql-%Y-%m-%d.log&#34;</span>,<span style="color:#4e9a06">&#34;log_checkpoints&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;log_lock_waits&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;log_replication_commands&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;log_statement&#34;</span>:<span style="color:#4e9a06">&#34;ddl&#34;</span>,<span style="color:#4e9a06">&#34;log_min_duration_statement&#34;</span>:100,<span style="color:#4e9a06">&#34;track_io_timing&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;track_functions&#34;</span>:<span style="color:#4e9a06">&#34;all&#34;</span>,<span style="color:#4e9a06">&#34;track_activity_query_size&#34;</span>:8192,<span style="color:#4e9a06">&#34;log_autovacuum_min_duration&#34;</span>:<span style="color:#4e9a06">&#34;1s&#34;</span>,<span style="color:#4e9a06">&#34;autovacuum_max_workers&#34;</span>:2,<span style="color:#4e9a06">&#34;autovacuum_naptime&#34;</span>:<span style="color:#4e9a06">&#34;1min&#34;</span>,<span style="color:#4e9a06">&#34;autovacuum_vacuum_cost_delay&#34;</span>:-1,<span style="color:#4e9a06">&#34;autovacuum_vacuum_cost_limit&#34;</span>:-1,<span style="color:#4e9a06">&#34;autovacuum_freeze_max_age&#34;</span>:1000000000,<span style="color:#4e9a06">&#34;deadlock_timeout&#34;</span>:<span style="color:#4e9a06">&#34;50ms&#34;</span>,<span style="color:#4e9a06">&#34;idle_in_transaction_session_timeout&#34;</span>:<span style="color:#4e9a06">&#34;10min&#34;</span>,<span style="color:#4e9a06">&#34;shared_preload_libraries&#34;</span>:<span style="color:#4e9a06">&#34;timescaledb, pg_stat_statements, auto_explain&#34;</span>,<span style="color:#4e9a06">&#34;auto_explain.log_min_duration&#34;</span>:<span style="color:#4e9a06">&#34;1s&#34;</span>,<span style="color:#4e9a06">&#34;auto_explain.log_analyze&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;auto_explain.log_verbose&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;auto_explain.log_timing&#34;</span>:<span style="color:#4e9a06">&#34;on&#34;</span>,<span style="color:#4e9a06">&#34;auto_explain.log_nested_statements&#34;</span>:true,<span style="color:#4e9a06">&#34;pg_stat_statements.max&#34;</span>:5000,<span style="color:#4e9a06">&#34;pg_stat_statements.track&#34;</span>:<span style="color:#4e9a06">&#34;all&#34;</span>,<span style="color:#4e9a06">&#34;pg_stat_statements.track_utility&#34;</span>:<span style="color:#4e9a06">&#34;off&#34;</span>,<span style="color:#4e9a06">&#34;pg_stat_statements.track_planning&#34;</span>:<span style="color:#4e9a06">&#34;off&#34;</span>,<span style="color:#4e9a06">&#34;timescaledb.telemetry_level&#34;</span>:<span style="color:#4e9a06">&#34;off&#34;</span>,<span style="color:#4e9a06">&#34;timescaledb.max_background_workers&#34;</span>:8,<span style="color:#4e9a06">&#34;citus.node_conninfo&#34;</span>:<span style="color:#4e9a06">&#34;sslm
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ode=prefer&#34;</span><span style="color:#ce5c00;font-weight:bold">}}}</span>
</span></span><span style="display:flex;"><span>/pg/pg-meta/failsafe
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;pg-meta-2&#34;</span>:<span style="color:#4e9a06">&#34;http://10.10.10.11:8008/patroni&#34;</span>,<span style="color:#4e9a06">&#34;pg-meta-1&#34;</span>:<span style="color:#4e9a06">&#34;http://10.10.10.10:8008/patroni&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>/pg/pg-meta/initialize
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">7418384210787662172</span>
</span></span><span style="display:flex;"><span>/pg/pg-meta/leader
</span></span><span style="display:flex;"><span>pg-meta-1
</span></span><span style="display:flex;"><span>/pg/pg-meta/members/pg-meta-1
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;conn_url&#34;</span>:<span style="color:#4e9a06">&#34;postgres://10.10.10.10:5432/postgres&#34;</span>,<span style="color:#4e9a06">&#34;api_url&#34;</span>:<span style="color:#4e9a06">&#34;http://10.10.10.10:8008/patroni&#34;</span>,<span style="color:#4e9a06">&#34;state&#34;</span>:<span style="color:#4e9a06">&#34;running&#34;</span>,<span style="color:#4e9a06">&#34;role&#34;</span>:<span style="color:#4e9a06">&#34;primary&#34;</span>,<span style="color:#4e9a06">&#34;version&#34;</span>:<span style="color:#4e9a06">&#34;4.0.1&#34;</span>,<span style="color:#4e9a06">&#34;tags&#34;</span>:<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;clonefrom&#34;</span>:true,<span style="color:#4e9a06">&#34;version&#34;</span>:<span style="color:#4e9a06">&#34;16&#34;</span>,<span style="color:#4e9a06">&#34;spec&#34;</span>:<span style="color:#4e9a06">&#34;8C.32G.125G&#34;</span>,<span style="color:#4e9a06">&#34;conf&#34;</span>:<span style="color:#4e9a06">&#34;tiny.yml&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>,<span style="color:#4e9a06">&#34;xlog_location&#34;</span>:184549376,<span style="color:#4e9a06">&#34;timeline&#34;</span>:1<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>/pg/pg-meta/members/pg-meta-2
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;conn_url&#34;</span>:<span style="color:#4e9a06">&#34;postgres://10.10.10.11:5432/postgres&#34;</span>,<span style="color:#4e9a06">&#34;api_url&#34;</span>:<span style="color:#4e9a06">&#34;http://10.10.10.11:8008/patroni&#34;</span>,<span style="color:#4e9a06">&#34;state&#34;</span>:<span style="color:#4e9a06">&#34;running&#34;</span>,<span style="color:#4e9a06">&#34;role&#34;</span>:<span style="color:#4e9a06">&#34;replica&#34;</span>,<span style="color:#4e9a06">&#34;version&#34;</span>:<span style="color:#4e9a06">&#34;4.0.1&#34;</span>,<span style="color:#4e9a06">&#34;tags&#34;</span>:<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;clonefrom&#34;</span>:true,<span style="color:#4e9a06">&#34;version&#34;</span>:<span style="color:#4e9a06">&#34;16&#34;</span>,<span style="color:#4e9a06">&#34;spec&#34;</span>:<span style="color:#4e9a06">&#34;8C.32G.125G&#34;</span>,<span style="color:#4e9a06">&#34;conf&#34;</span>:<span style="color:#4e9a06">&#34;tiny.yml&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>,<span style="color:#4e9a06">&#34;xlog_location&#34;</span>:184549376,<span style="color:#4e9a06">&#34;replication_state&#34;</span>:<span style="color:#4e9a06">&#34;streaming&#34;</span>,<span style="color:#4e9a06">&#34;timeline&#34;</span>:1<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>/pg/pg-meta/status
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;optime&#34;</span>:184549376,<span style="color:#4e9a06">&#34;slots&#34;</span>:<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;pg_meta_2&#34;</span>:184549376,<span style="color:#4e9a06">&#34;pg_meta_1&#34;</span>:184549376<span style="color:#ce5c00;font-weight:bold">}</span>,<span style="color:#4e9a06">&#34;retain_slots&#34;</span>:<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;pg_meta_1&#34;</span>,<span style="color:#4e9a06">&#34;pg_meta_2&#34;</span><span style="color:#ce5c00;font-weight:bold">]}</span>
</span></span></code></pre></div><hr>
<h2 id="how-to-use-existing-external-etcd-cluster">How to use existing external etcd cluster?</h2>
<p>The hard-coded group, <code>etcd</code>, will be used as DCS servers for PGSQL. You can initialize them with <code>etcd.yml</code> or assume it is an existing external etcd cluster.</p>
<p>To use an existing external etcd cluster, define them as usual and make sure your current etcd cluster certificate is signed by the same CA as your self-signed CA for PGSQL.</p>
<hr>
<h2 id="how-to-add-a-new-member-to-the-existing-etcd-cluster">How to add a new member to the existing etcd cluster?</h2>
<p>Check <a href="/docs/etcd/#add-member">Add a member to etcd cluster</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl member add &lt;etcd-?&gt; --learner<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --peer-urls<span style="color:#ce5c00;font-weight:bold">=</span>https://&lt;new_ins_ip&gt;:2380 <span style="color:#8f5902;font-style:italic"># on admin node</span>
</span></span><span style="display:flex;"><span>./etcd.yml -l &lt;new_ins_ip&gt; -e <span style="color:#000">etcd_init</span><span style="color:#ce5c00;font-weight:bold">=</span>existing                                 <span style="color:#8f5902;font-style:italic"># init new etcd member</span>
</span></span><span style="display:flex;"><span>etcdctl member promote &lt;new_ins_server_id&gt;                                       <span style="color:#8f5902;font-style:italic"># on admin node</span>
</span></span></code></pre></div><hr>
<h2 id="how-to-remove-a-member-from-an-existing-etcd-cluster">How to remove a member from an existing etcd cluster?</h2>
<p>Check <a href="/docs/etcd/#remove-member">Remove member from etcd cluster</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl member remove &lt;etcd_server_id&gt;   <span style="color:#8f5902;font-style:italic"># kick member out of the cluster (on admin node)</span>
</span></span><span style="display:flex;"><span>./etcd.yml -l &lt;ins_ip&gt; -t etcd_purge     <span style="color:#8f5902;font-style:italic"># purge etcd instance</span>
</span></span></code></pre></div>
</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Mail" aria-label="Mail">
    <a target="_blank" rel="noopener" href="mailto:rh@vonng.com" aria-label="Mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Vonng/pigsty" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://twitter.com/GobeUncleWang" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="WeChat" aria-label="WeChat">
    <a target="_blank" rel="noopener" href="/img/pigsty/pigsty-cc.jpg" aria-label="WeChat">
      <i class="fa fa-comment"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Discord" aria-label="Discord">
    <a target="_blank" rel="noopener" href="https://discord.gg/wDzt5VyWEz" aria-label="Discord">
      <i class="fab fa-discord"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Telegram" aria-label="Telegram">
    <a target="_blank" rel="noopener" href="https://t.me/joinchat/gV9zfZraNPM3YjFh" aria-label="Telegram">
      <i class="fab fa-telegram"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2018&ndash;2024
    <span class="td-footer__authors">Ruohang Feng</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span></span><span class="ms-2"><a href="https://vonng.com/en/" target="_blank" rel="noopener">@Vonng</a></span>
<br><span>Pigsty® distributed under <a href="/docs/about/license" target="_blank" rel="noopener">AGPLv3</a></span>
<br><span class="ms-2"><a href="/docs/about/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
<span><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">浙ICP备15016890号</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.248655eb216150e39da254c2f7aa5357805d0ec66bdb741b591cd35fb5f629ab.js" integrity="sha256-JIZV6yFhUOOdolTC96pTV4BdDsZr23QbWRzTX7X2Kas=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
