<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="/docs/tasks/">
<link rel="alternate" type="application/rss&#43;xml" href="/docs/tasks/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Task &amp; Tutorial | Pigsty</title>
<meta name="description" content="Look up common tasks and how to perform them using a short sequence of steps">
<meta property="og:title" content="Task &amp; Tutorial" />
<meta property="og:description" content="Look up common tasks and how to perform them using a short sequence of steps" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/tasks/" />

<meta itemprop="name" content="Task &amp; Tutorial">
<meta itemprop="description" content="Look up common tasks and how to perform them using a short sequence of steps"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Task &amp; Tutorial"/>
<meta name="twitter:description" content="Look up common tasks and how to perform them using a short sequence of steps"/>




<link rel="preload" href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" as="style">
<link href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="/js/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LG1V9WTKGE');
}
</script>
  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class="navbar-brand__name">Pigsty</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/docs/"><i class='fa-solid fa-book'></i><span>Docs</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/blog/"><i class="fas fa-blog"></i><span>Blog</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/Vonng/pigsty/" target="_blank" rel="noopener"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Link</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/docs/">v3 Docs</a></li>
    <li><a class="dropdown-item" href="https://demo.pigsty.cc">Public Demo</a></li>
    <li><a class="dropdown-item" href="https://ext.pigsty.io">Extension Repo</a></li>
    <li><a class="dropdown-item" href="https://pigsty.cc/zh/docs">pigsty.cc</a></li>
    <li><a class="dropdown-item" href="https://pigsty.cc/zh/blog">ZH Blog</a></li>
    </ul>
</div></li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-language"></i>English</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/zh/docs/tasks/">中文</a></li>
    </ul>
</div>
</li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.39b2729f8cb058c2a8f90b42d3a25137.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/tasks/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Task &amp; Tutorial</h1>
<div class="lead">Look up common tasks and how to perform them using a short sequence of steps</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-99d2b713b93221365ecf430782dc8d2f">Nginx: Expose Web Service</a></li>


    
  
    
    
	
<li>2: <a href="#pg-303bb9027210f29a00e38a29f00d3519">Docker: Container Support &amp; Proxy</a></li>


    
  
    
    
	
<li>3: <a href="#pg-635082b78e7ccd8765655b57d256e44d">Use PostgreSQL as Ansible Config Inventory CMDB</a></li>


    
  
    
    
	
<li>4: <a href="#pg-4f7bd649e98232d39a0fac447d3ad879">Use PG as Grafana Backend</a></li>


    
  
    
    
	
<li>5: <a href="#pg-8ccc56d4ade450368e94558922ba0706">Use PG as Prometheus Backend</a></li>


    
  
    
    
	
<li>6: <a href="#pg-9f5474502d4f0b74cbd1e1f9ae23bc23">Bind a L2 VIP to Node Cluster with Keepalived</a></li>


    
  
    
    
	
<li>7: <a href="#pg-d55948673c4562234cd1d0c550779f28">Bind a L2 VIP to PostgreSQL Primary with VIP-Manager</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-99d2b713b93221365ecf430782dc8d2f">1 - Nginx: Expose Web Service</h1>
    <div class="lead">How to expose, proxy, and forward web services using Nginx?</div>
	<p>Pigsty will install <a href="/docs/infra/#nginx"><strong>Nginx</strong></a> on <a href="/docs/node/#infra节点"><strong>INFRA Node</strong></a>, as a Web service proxy.</p>
<p>Nginx is the access entry for all WebUI services of Pigsty, and it defaults to the use the <code>80/443</code> port on INFRA nodes.</p>
<p>Pigsty provides a global parameter <a href="/docs/reference/param/#infra_portal"><code>infra_portal</code></a> to configure Nginx proxy rules and corresponding upstream services.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">infra_portal</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># domain names and upstream servers</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">home         </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">h.pigsty }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">grafana      </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: g.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:3000&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">, websocket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">prometheus   </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: p.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:9090&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">alertmanager </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: a.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:9093&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">blackbox     </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:9115&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">loki         </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:3100&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#minio        : { domain: sss.pigsty  ,endpoint: &#34;${admin_ip}:9001&#34; ,scheme: https ,websocket: true }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>If you access Nginx directly through the ip:port, it will route to <code>h.pigsty</code>, which is the Pigsty homepage (<code>/www/</code> directory, served as software repo).</p>
<p>Because Nginx provides multiple services through the same port, it must be distinguished by the domain name (<code>HOST</code> header by the browser). Therefore, by default, Nginx only exposes services with the <code>domain</code> parameter.</p>
<p>And Pigsty will expose <code>grafana</code>, <code>prometheus</code>, and <code>alertmanager</code> services by default in addition to the <code>home</code> server.</p>
<hr>
<h2 id="how-to-configure-nginx-upstream">How to configure nginx upstream?</h2>
<p>Pigsty has a built-in configuration template <a href="https://github.com/Vonng/pigsty/blob/main/conf/full.yml"><code>full.yml</code></a>, could be used as a reference, and also exposes some Web services in addition to the default services.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">infra_portal</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># domain names and upstream servers</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">home         </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">h.pigsty }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">grafana      </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: g.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:3000&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">, websocket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">prometheus   </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: p.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:9090&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">alertmanager </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: a.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:9093&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">blackbox     </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:9115&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">loki         </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:3100&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">minio        </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: sss.pigsty  ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${admin_ip}:9001&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,scheme: https ,websocket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">postgrest    </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: api.pigsty  ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:8884&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">pgadmin      </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: adm.pigsty  ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:8885&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">pgweb        </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: cli.pigsty  ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:8886&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">bytebase     </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: ddl.pigsty  ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:8887&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">jupyter      </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: lab.pigsty  ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:8888&#34;</span><span style="color:#204a87;font-weight:bold">, websocket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">gitea        </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: git.pigsty  ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:8889&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">wiki         </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: wiki.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:9002&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">noco         </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: noco.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1:9003&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">supa         </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">domain: supa.pigsty ,endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;10.10.10.10:8000&#34;</span><span style="color:#204a87;font-weight:bold">, websocket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Each record in <code>infra_portal</code> is a key-value pair, where the <code>key</code> is the <code>name</code> of the service, and the <code>value</code> is a dictionary.
Currently, there are four available configuration items in the configuration dictionary:</p>
<ul>
<li><code>endpoint</code>: <strong>REQUIRED</strong>, specifies the address of the upstream service, which can be <code>IP:PORT</code> or <code>DOMAIN:PORT</code>.
<ul>
<li>In this parameter, you can use the placeholder <code>${admin_ip}</code>, and Pigsty will fill in the value of <a href="/docs/reference/param/#admin_ip"><code>admin_ip</code></a>.</li>
</ul>
</li>
<li><code>domain</code>: <strong>OPTIONAL</strong>, specifies the domain name of the proxy. If not filled in, Nginx will not expose this service.
<ul>
<li>For services that need to know the endpoint address but do not want to expose them (such as Loki, Blackbox Exporter), you can leave the <code>domain</code> blank.</li>
</ul>
</li>
<li><code>scheme</code>: <strong>OPTIONAL</strong>, specifies the protocol (<code>http</code>/<code>https</code>) when forwarding, leave it blank to default to http.
<ul>
<li>For services that require HTTPS access (such as the MinIO management interface), you need to specify <code>scheme: https</code>.</li>
</ul>
</li>
<li><code>websocket</code>: <strong>OPTIONAL</strong>, specifies whether to enable WebSocket, leave it blank to default to off.
<ul>
<li>Services that require WebSocket (such as Grafana, Jupyter) need to be set to <code>true</code> to work properly.</li>
</ul>
</li>
</ul>
<p>If you need to add a new Web service exposed by Nginx, you need to add the corresponding record in the <code>infra_portal</code> parameter in the <code>pigsty.yml</code> file, and then execute the playbook to take effect:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./infra.yml -t nginx           <span style="color:#8f5902;font-style:italic"># Tune nginx into desired state</span>
</span></span></code></pre></div><p>To avoid service interruption, you can also execute the following tasks separately:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./infra.yml -t nginx_config    <span style="color:#8f5902;font-style:italic"># re-generate nginx upstream config in /etc/nginx/conf.d</span>
</span></span><span style="display:flex;"><span>./infra.yml -t nginx_cert      <span style="color:#8f5902;font-style:italic"># re-generate nginx ssl cert to include new domain names</span>
</span></span><span style="display:flex;"><span>nginx -s reload                <span style="color:#8f5902;font-style:italic"># online reload nginx configuration</span>
</span></span></code></pre></div><p>Or the simple way:</p>
<p>Nginx related configuration parameters are located at: <a href="/docs/reference/param/#nginx">Parameters: INFRA - NGINX</a></p>
<hr>
<h2 id="how-to-access-via-domain-names">How to access via domain names?</h2>
<p>Nginx distinguishes between different services using the domain name in the <code>HOST</code> header set by the browser. Thus, by default, except for the software repository, you need to access services via domain name.</p>
<p>You can directly access these services via IP address + port, but we recommend accessing all components through Nginx on ports 80/443 using domain names.</p>
<p>When accessing the Pigsty WebUI via domain name, you need to configure <strong>DNS</strong> resolution or modify the local <code>/etc/hosts</code> file for static resolution. There are several typical methods:</p>
<ul>
<li>If your service needs to be publicly accessible, you should resolve the internet domain name via a DNS provider (Cloudflare, Aliyun DNS, etc.). Note that in this case, you usually need to modify the Pigsty <a href="/"><code>infra_portal</code></a>parameter, as the default <code>*.pigsty</code> is not suitable for public use.</li>
<li>If your service needs to be shared within an office network, you should resolve the internal domain name via an internal DNS provider (company internal DNS server) and point it to the IP of the Nginx server. You can request the network administrator to add the appropriate resolution records in the internal DNS server, or ask the system users to manually configure static DNS resolution records.</li>
<li>If your service is only for personal use or a few users (e.g., DBA), you can ask these users to use static domain name resolution records. On Linux/MacOS systems, modify the <code>/etc/hosts</code> file (requires sudo permissions) or <code>C:\Windows\System32\drivers\etc\hosts</code> (Windows) file.</li>
</ul>
<p>We recommend ordinary single-machine users use the third method, adding the following resolution records <strong>on the machine used to access the web system via a browser</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&lt;your_public_ip_address&gt;  h.pigsty a.pigsty p.pigsty g.pigsty
</span></span></code></pre></div><p>The IP address here is the <strong>public IP address</strong> where the Pigsty service is installed, and then you can access Pigsty subsystems in the browser via a domain like: <a href="http://g.pigsty/">http://g.pigsty</a>.</p>
<p>Other web services and custom domains can be added similarly. For example, the following are possible domain resolution records for the Pigsty sandbox demo:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>10.10.10.10 h.pigsty a.pigsty p.pigsty g.pigsty
</span></span><span style="display:flex;"><span>10.10.10.10 api.pigsty ddl.pigsty adm.pigsty cli.pigsty lab.pigsty
</span></span><span style="display:flex;"><span>10.10.10.10 supa.pigsty noco.pigsty odoo.pigsty dify.pigsty
</span></span></code></pre></div><hr>
<h2 id="how-to-access-via-https">How to access via HTTPS?</h2>
<p>If <a href="/docs/reference/param/#nginx_sslmode"><code>nginx_sslmode</code></a> is set to <code>enabled</code> or <code>enforced</code>, you can trust self-signed ca: <code>files/pki/ca/ca.crt</code> to use <code>https</code> in your browser.</p>
<p>Pigsty will generate self-signed certs for Nginx, if you wish to access via HTTPS without &ldquo;Warning&rdquo;, here are some options:</p>
<ul>
<li>Apply &amp; add real certs from trusted CA: such as Let&rsquo;s Encrypt</li>
<li>Trust your generated CA crt as root ca in your OS and browser</li>
<li>Type <code>thisisunsafe</code> in Chrome will supress the warning</li>
</ul>
<p>You can access these web UI directly via IP + port. While the common best practice would be access them through Nginx and distinguish via domain names. You&rsquo;ll need configure DNS records, or use the local static records (<code>/etc/hosts</code>) for that.</p>
<br>
<details><summary>How to access Pigsty Web UI by domain name?</summary><br>
<p>There are several options:</p>
<ol>
<li>Resolve internet domain names through a DNS service provider, suitable for systems accessible from the public internet.</li>
<li>Configure internal network DNS server resolution records for internal domain name resolution.</li>
<li>Modify the local machine&rsquo;s <code>/etc/hosts</code> file to add static resolution records. (For Windows, it&rsquo;s located at:)</li>
</ol>
<p>We recommend the third method for common users. On the machine (which runs the browser), add the following record into <code>/etc/hosts</code> (sudo required) or <code>C:\Windows\System32\drivers\etc\hosts</code> in Windows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;your_public_ip_address&gt;  h.pigsty a.pigsty p.pigsty g.pigsty
</span></span></code></pre></div><p>You have to use the <strong>external</strong> IP address of the node here.</p>
</details><br>
<details><summary>How to configure server side domain names?</summary><br>
<p>The server-side domain name is configured with Nginx. If you want to replace the default domain name, simply enter the domain you wish to use in the parameter <a href="/docs/reference/param/#infra_portal"><code>infra_portal</code></a>. When you access the Grafana monitoring homepage via <code>http://g.pigsty</code>, it is actually accessed through the Nginx proxy to Grafana&rsquo;s WebUI:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>http://g.pigsty ️-&gt; http://10.10.10.10:80 (nginx) -&gt; http://10.10.10.10:3000 (grafana)
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-303bb9027210f29a00e38a29f00d3519">2 - Docker: Container Support &amp; Proxy</h1>
    <div class="lead">How to configure container support in Pigsty? and how to configure proxy for DockerHub?</div>
	<p>Pigsty has a <a href="/docs/docker/"><strong><code>DOCKER</code></strong></a> module, which provides a set of playbooks to install and manage Docker on the target nodes.</p>
<p>This document will guide you through how to enable Docker support in Pigsty, and how to configure a proxy server for DockerHub.</p>
<hr>
<h2 id="install-docker">Install Docker</h2>
<p>To install docker on specified nodes, you can use the <a href="/docs/docker/#dockeryml"><code>docker.yml</code></a> playbook:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./docker.yml -l &lt;ip<span style="color:#000;font-weight:bold">|</span>group<span style="color:#000;font-weight:bold">|</span>cls&gt;
</span></span></code></pre></div><p>That&rsquo;s it.</p>
<hr>
<h2 id="proxy-101">Proxy 101</h2>
<p>Assuming you have a working HTTP(s) proxy server, if you wish to connect to docker hub or other registry sites via the proxy server:</p>
<p>You proxy service should provide you with something like</p>
<ul>
<li><code>http://&lt;ip|domain&gt;:&lt;port&gt;</code> | <code>https://[user]:[pass]@&lt;ip|domain&gt;:&lt;port&gt;</code></li>
</ul>
<p>For example, if you have a proxy server configuring like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ALL_PROXY</span><span style="color:#ce5c00;font-weight:bold">=</span>http://192.168.0.106:8118
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">HTTP_PROXY</span><span style="color:#ce5c00;font-weight:bold">=</span>http://192.168.0.106:8118
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">HTTPS_PROXY</span><span style="color:#ce5c00;font-weight:bold">=</span>http://192.168.0.106:8118
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">NO_PROXY</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16,*.pigsty,*.aliyun.com,mirrors.*,*.myqcloud.com,*.tsinghua.edu.cn&#34;</span>
</span></span></code></pre></div><p>You can check the proxy server by using the <code>curl</code> command, for example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -x http://192.168.0.106:8118 -I http://www.google.com
</span></span></code></pre></div><hr>
<h2 id="how-to-configure-proxy-for-docker-daemon">How to configure proxy for Docker Daemon?</h2>
<p>If you wish to use a proxy server when Docker pulls images, you should specify the <a href="/docs/reference/param/#proxy_env"><code>proxy_env</code></a> parameter in the global variables of the <code>pigsty.yml</code> configuration file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">all</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">proxy_env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#8f5902;font-style:italic"># global proxy env when downloading packages</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">no_proxy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16,*.pigsty,*.aliyun.com,mirrors.*,*.myqcloud.com,*.tsinghua.edu.cn&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">http_proxy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http://192.168.0.106:8118</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">all_proxy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http://192.168.0.106:8118</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">https_proxy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http://192.168.0.106:8118</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>And when the Docker playbook is executed, these configurations will be rendered as proxy configurations in <code>/etc/docker/daemon.json</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;proxies&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;http-proxy&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;{{ proxy_env[&#39;http_proxy&#39;] }}&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;https-proxy&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;{{ proxy_env[&#39;http_proxy&#39;] }}&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;no-proxy&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;{{ proxy_env[&#39;no_proxy&#39;] }}&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><blockquote>
<p>Please note that Docker Daemon does not use the <code>all_proxy</code> parameter</p>
</blockquote>
<p>If you wish to manually specify a proxy server, you can directly modify the <code>proxies</code> configuration in <code>/etc/docker/daemon.json</code>;</p>
<p>Or you can modify the service definition in <code>/lib/systemd/system/docker.service</code> (Debian/Ubuntu) and <code>/usr/lib/systemd/system/docker.service</code> to add environment variable declarations in the <code>[Service]</code> section</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[Service]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">Environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;HTTP_PROXY=http://192.168.0.106:8118&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">Environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;HTTPS_PROXY=http://192.168.0.106:8118&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">Environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;NO_PROXY=localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16,*.pigsty,*.aliyun.com,mirrors.*,*.myqcloud.com,*.tsinghua.edu.cn&#34;</span>
</span></span></code></pre></div><p>And restart dockerd service to take effect:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl restart docker
</span></span></code></pre></div><hr>
<h2 id="how-to-use-other-registry">How to use other registry?</h2>
<p>You can specify other registry sites in the <a href="/docs/reference/param/#docker_registry"><code>docker_registry_mirrors</code></a> parameter.</p>
<p>It may look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;https://mirror.ccs.tencentyun.com&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># tencent cloud mirror, intranet only</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;https://registry.cn-hangzhou.aliyuncs.com&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># aliyun cloud mirror, login required</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You can also log in to other mirror sites, such as <code>quay.io</code>, by executing:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker login quay.io
</span></span><span style="display:flex;"><span>username <span style="color:#8f5902;font-style:italic">#&gt; # input your username</span>
</span></span><span style="display:flex;"><span>password <span style="color:#8f5902;font-style:italic">#&gt; # input your password</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-635082b78e7ccd8765655b57d256e44d">3 - Use PostgreSQL as Ansible Config Inventory CMDB</h1>
    <div class="lead">Use PostgreSQL instead of static YAML config file as Ansible config inventory</div>
	<p>You can use PostgreSQL as a configuration source for Pigsty, replacing the static YAML configuration file.</p>
<p>There are some advantages to using CMDB as a dynamic <a href="/docs/setup/config/#inventory">inventory</a>: metadata is presented in a highly structured way in the form of data tables,
and consistency is ensured through database constraints. At the same time, using CMDB allows you to use third-party tools to edit and manage Pigsty metadata, making it easier to integrate with external systems.</p>
<hr>
<h2 id="ansible-inventory">Ansible Inventory</h2>
<p>Pigsty&rsquo;s default configuration file path is specified in <a href="https://github.com/Vonng/pigsty/blob/main/ansible.cfg"><code>ansible.cfg</code></a> as <code>inventory = pigsty.yml</code>.</p>
<p>Changing this parameter will change the default configuration file path used by Ansible.
If you point it to an executable script file, Ansible will use the dynamic inventory mechanism, execute the script, and expect the script to return a configuration file.</p>
<p>Using CMDB is implemented by editing the <code>ansible.cfg</code> in the Pigsty directory:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#000">inventory</span> <span style="color:#ce5c00;font-weight:bold">=</span> pigsty.yml
</span></span><span style="display:flex;"><span>+++
</span></span><span style="display:flex;"><span><span style="color:#000">inventory</span> <span style="color:#ce5c00;font-weight:bold">=</span> inventory.sh
</span></span></code></pre></div><p>And the <code>inventory.sh</code> is a simple script that generates equivalent YAML/JSON configuration files from the records in the PostgreSQL CMDB.</p>
<p>You can use <a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_cmdb"><code>bin/inventory_cmdb</code></a> to switch to CMDB inventory, and
use <a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_conf"><code>bin/inventory_conf</code></a> to switch back to the local YAML configuration file.</p>
<p>You may also need <a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_load"><code>bin/inventory_load</code></a> to load the YAML configuration file into the CMDB.</p>
<hr>
<h2 id="load-configuration">Load Configuration</h2>
<p>Pigsty will init a CMDB (optional) on the default <code>pg-meta</code> cluster&rsquo;s <code>meta</code> database, under <code>pigsty</code> schema.</p>
<blockquote>
<p>the CMDB is available only after <a href="/en/docs/infra"><code>infra.yml</code></a> is fully executed on the admin node.</p>
</blockquote>
<p>You can load YAML config file into CMDB with <code>bin/inventory_load</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>usage: inventory_load <span style="color:#ce5c00;font-weight:bold">[</span>-h<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>-p PATH<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>-d CMDB_URL<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>load config arguments
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>optional arguments:
</span></span><span style="display:flex;"><span>  -h, --help            show this <span style="color:#204a87">help</span> message and exit„
</span></span><span style="display:flex;"><span>  -p PATH, --path PATH  config path, <span style="color:#4e9a06">${</span><span style="color:#000">PIGSTY_HOME</span><span style="color:#4e9a06">}</span>/pigsty.yml by default
</span></span><span style="display:flex;"><span>  -d DATA, --data DATA  postgres cmdb pgurl, <span style="color:#4e9a06">${</span><span style="color:#000">METADB_URL</span><span style="color:#4e9a06">}</span> by default
</span></span></code></pre></div><p>If you run <code>bin/inventory_load</code> without any arguments, it will load the default <code>pigsty.yml</code> into the default CMDB.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/inventory_load
</span></span><span style="display:flex;"><span>bin/inventory_load -p conf/demo.yml
</span></span><span style="display:flex;"><span>bin/inventory_load -p conf/prod.yml -d postgresql://dbuser_meta:DBUser.Meta@10.10.10.10:5432/meta
</span></span></code></pre></div><p>You can switch to dynamic CMDB inventory with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/inventory_cmdb
</span></span></code></pre></div><p>To switch back to local YAML config file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/inventory_conf
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4f7bd649e98232d39a0fac447d3ad879">4 - Use PG as Grafana Backend</h1>
    <div class="lead">Use PostgreSQL instead of default SQLite, as the backend storage for Grafana</div>
	<p>You can use postgres as the database used by the Grafana backend.</p>
<p>In this tutorial, you will learn about the following.</p>
<ul>
<li>How to <a href="/docs/tasks/grafana/#create-cluster">create a new cluster</a></li>
<li>How to <a href="/docs/tasks/grafana/#create-biz-user">create a new biz user</a> in an existing database cluster</li>
<li>How to <a href="/docs/tasks/grafana/#create-biz-database">create a new biz database</a> in an existing database cluster</li>
<li>How to <a href="/docs/tasks/grafana/#access-database">access databases</a> created by Pigsty</li>
<li>How to <a href="/docs/tasks/grafana/#manage-dashboard">manage dashboards</a> in Grafana</li>
<li>How to manage <a href="/docs/tasks/grafana/#manage-datasources">PostgreSQL DataSources</a>  in Grafana</li>
<li>How to do <a href="/docs/tasks/grafana/#update-grafana-database">upgrade the grafana database</a></li>
</ul>
<hr>
<h2 id="tl-dr">TL; DR</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi pigsty.yml   <span style="color:#8f5902;font-style:italic"># uncomment user/db definition: dbuser_grafana  grafana </span>
</span></span><span style="display:flex;"><span>bin/pgsql-user  pg-meta  dbuser_grafana
</span></span><span style="display:flex;"><span>bin/pgsql-db    pg-meta  grafana
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>psql postgres://dbuser_grafana:DBUser.Grafana@meta:5436/grafana -c <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  <span style="color:#4e9a06">&#39;CREATE TABLE t(); DROP TABLE t;&#39;</span>    <span style="color:#8f5902;font-style:italic"># check pgurl connectivity</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>vi /etc/grafana/grafana.ini            <span style="color:#8f5902;font-style:italic"># edit [database] section: type &amp; url</span>
</span></span><span style="display:flex;"><span>systemctl restart grafana-server
</span></span></code></pre></div><hr>
<h2 id="create-postgres-cluster">Create Postgres Cluster</h2>
<p>We can define a new database <code>grafana</code> on <code>pg-meta</code>.
A Grafana-specific database cluster can also be created on a new machine node: <code>pg-grafana</code>.</p>
<h3 id="define-cluster">Define Cluster</h3>
<p>To create a new dedicated database cluster <code>pg-grafana</code> on two bare nodes <code>10.10.10.11</code>, <code>10.10.10.12</code>, define it in the config file.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-grafana</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">revokeconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">grafana primary database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pgbouncer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">dbrole_admin]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for grafana database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h3 id="create-cluster">Create Cluster</h3>
<p>Complete the creation of the database cluster <code>pg-grafana</code> with the following command: <a href="p-pgsql.md"><code>pgsql.yml</code></a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/createpg pg-grafana <span style="color:#8f5902;font-style:italic"># Initialize the pg-grafana cluster</span>
</span></span></code></pre></div><p>This command calls Ansible Playbook <a href="p-pgsql.md"><code>pgsql.yml</code></a> to create the database cluster.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>. /pgsql.yml -l pg-grafana <span style="color:#8f5902;font-style:italic"># The actual equivalent Ansible playbook command executed </span>
</span></span></code></pre></div><p>The business users and databases defined in <code>pg_users</code> and <code>pg_databases</code> are created automatically when the cluster is initialized. After creating the cluster using this configuration, the following connection string <a href="c-service.md#access">access</a> database can be used.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.11:5432/grafana <span style="color:#8f5902;font-style:italic"># direct connection to the primary</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.11:5436/grafana <span style="color:#8f5902;font-style:italic"># direct connection to the default service</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.11:5433/grafana <span style="color:#8f5902;font-style:italic"># Connect to the string read/write service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.12:5432/grafana <span style="color:#8f5902;font-style:italic"># direct connection to the primary</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.12:5436/grafana <span style="color:#8f5902;font-style:italic"># Direct connection to default service</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.12:5433/grafana <span style="color:#8f5902;font-style:italic"># Connected string read/write service</span>
</span></span></code></pre></div><p>By default, Pigsty is installed on a <strong>single meta node</strong>. Then the required users and databases for Grafana are created on the existing <code>pg-meta</code> database cluster instead of using the <code>pg-grafana</code> cluster.</p>
<hr>
<h2 id="create-biz-user">Create Biz User</h2>
<p>The convention for business object management is to create users first and then create the database.</p>
<h3 id="define-user">Define User</h3>
<p>To create a user <code>dbuser_grafana</code> on a <code>pg-meta</code> cluster, add the following user definition to <code>pg-meta</code>&rsquo;s <a href="/docs/tasks/grafana/#define-cluster">cluster definition</a>.</p>
<p>Add location: <code>all.children.pg-meta.vars.pg_users</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for grafana database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pgbouncer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_admin ]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><blockquote>
<p>If you have defined a different password here, replace the corresponding parameter with the new password.</p>
</blockquote>
<h3 id="create-user">Create User</h3>
<p>Complete the creation of the <code>dbuser_grafana</code> user with the following command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-user pg-meta dbuser_grafana <span style="color:#8f5902;font-style:italic"># Create the `dbuser_grafana` user on the pg-meta cluster</span>
</span></span></code></pre></div><p>Calls Ansible Playbook <a href="/docs/pgsql/playbook/#pgsql-useryml"><code>pgsql-user.yml</code></a> to create the user</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>. /pgsql-user.yml -l pg-meta -e <span style="color:#000">pg_user</span><span style="color:#ce5c00;font-weight:bold">=</span>dbuser_grafana <span style="color:#8f5902;font-style:italic"># Ansible</span>
</span></span></code></pre></div><p>The <code>dbrole_admin</code> role has the privilege to perform DDL changes in the database, which is precisely what Grafana needs.</p>
<hr>
<h2 id="create-biz-database">Create Biz Database</h2>
<h3 id="define-database">Define database</h3>
<p>Create business databases in the same way as business users. First, add the <a href="/docs/tasks/grafana/#define-cluster">definition</a> of the new database <code>grafana</code> to the cluster definition of <code>pg-meta</code>.</p>
<p>Add location: <code>all.children.pg-meta.vars.pg_databases</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: grafana, owner: dbuser_grafana, revokeconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="create-database">Create database</h3>
<p>Use the following command to complete the creation of the <code>grafana</code> database.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-db pg-meta grafana <span style="color:#8f5902;font-style:italic"># Create the `grafana` database on the `pg-meta` cluster</span>
</span></span></code></pre></div><p>Calls Ansible Playbook <a href="/docs/pgsql/playbook/#pgsql-dbyml"><code>pgsql-db.yml</code></a> to create the database.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>. /pgsql-db.yml -l pg-meta -e <span style="color:#000">pg_database</span><span style="color:#ce5c00;font-weight:bold">=</span>grafana <span style="color:#8f5902;font-style:italic"># The actual Ansible playbook to execute</span>
</span></span></code></pre></div><hr>
<h2 id="access-database">Access Database</h2>
<h3 id="check-connectivity">Check Connectivity</h3>
<p>You can access the database using different <a href="c-service.md">services</a> or <a href="c-service.md">access</a> methods.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@meta:5432/grafana <span style="color:#8f5902;font-style:italic"># Direct connection</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@meta:5436/grafana <span style="color:#8f5902;font-style:italic"># default service</span>
</span></span><span style="display:flex;"><span>postgres://dbuser_grafana:DBUser.Grafana@meta:5433/grafana <span style="color:#8f5902;font-style:italic"># primary service</span>
</span></span></code></pre></div><p>We will use the <a href="c-service.md#default-services">default service</a> that accesses the database directly from the primary through the LB.</p>
<p>First, check if the connection string is reachable and if you have privileges to execute DDL commands.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres://dbuser_grafana:DBUser.Grafana@meta:5436/grafana -c <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  <span style="color:#4e9a06">&#39;CREATE TABLE t(); DROP TABLE t;&#39;</span>
</span></span></code></pre></div><h3 id="config-grafana">Config Grafana</h3>
<p>For Grafana to use the Postgres data source, you need to edit <code>/etc/grafana/grafana.ini</code> and modify the config entries.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[database]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;type = sqlite3</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;host = 127.0.0.1:3306</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;name = grafana</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;user = root</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If the password contains # or ; you have to wrap it with triple quotes. Ex &#34;&#34;&#34;#password;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;password =</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">;url =</span>
</span></span></code></pre></div><p>Change the default config entries.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[database]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">postgres</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">url</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">postgres://dbuser_grafana:DBUser.Grafana@meta/grafana</span>
</span></span></code></pre></div><p>Subsequently, restart Grafana.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl restart grafana-server
</span></span></code></pre></div><p>See from the monitor system that the new <a href="http://demo.pigsty.cc/d/pgsql-alert"><code>grafana</code></a> database is already active, then Grafana has started using Postgres as the primary backend database. However, the original Dashboards and Datasources in Grafana have disappeared. You need to re-import <a href="/docs/tasks/grafana/#Manage-Dashboard">Dashboards</a> and <a href="/docs/tasks/grafana/#Manage-Datasources">Postgres Datasources</a>.</p>
<hr>
<h2 id="manage-dashboard">Manage Dashboard</h2>
<p>You can reload the Pigsty monitor dashboard by going to the <code>files/ui</code> dir in the Pigsty dir using the admin user and executing <code>grafana.py init</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty/files/ui
</span></span><span style="display:flex;"><span>. /grafana.py init <span style="color:#8f5902;font-style:italic"># Initialize the Grafana monitor dashboard using the Dashboards in the current directory</span>
</span></span></code></pre></div><p>Execution results in:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@meta:~/pigsty/files/ui
</span></span><span style="display:flex;"><span>$ ./grafana.py init
</span></span><span style="display:flex;"><span>Grafana API: admin:pigsty @ http://10.10.10.10:3000
</span></span><span style="display:flex;"><span>init dashboard : home.json
</span></span><span style="display:flex;"><span>init folder pgcat
</span></span><span style="display:flex;"><span>init dashboard: pgcat / pgcat-table.json
</span></span><span style="display:flex;"><span>init dashboard: pgcat / pgcat-bloat.json
</span></span><span style="display:flex;"><span>init dashboard: pgcat / pgcat-query.json
</span></span><span style="display:flex;"><span>init folder pgsql
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-replication.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-table.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-activity.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-cluster.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-node.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-database.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-xacts.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-overview.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-session.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-tables.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-instance.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-queries.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-alert.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-service.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-persist.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-proxy.json
</span></span><span style="display:flex;"><span>init dashboard: pgsql / pgsql-query.json
</span></span><span style="display:flex;"><span>init folder pglog
</span></span><span style="display:flex;"><span>init dashboard: pglog / pglog-instance.json
</span></span><span style="display:flex;"><span>init dashboard: pglog / pglog-analysis.json
</span></span><span style="display:flex;"><span>init dashboard: pglog / pglog-session.json
</span></span></code></pre></div><p>This script detects the current environment (defined at <code>~/pigsty</code> during installation), gets Grafana access information, and replaces the URL connection placeholder domain name (<code>*.pigsty</code>) in the monitor dashboard with the real one in use.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">GRAFANA_ENDPOINT</span><span style="color:#ce5c00;font-weight:bold">=</span>http://10.10.10.10:3000
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">GRAFANA_USERNAME</span><span style="color:#ce5c00;font-weight:bold">=</span>admin
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">GRAFANA_PASSWORD</span><span style="color:#ce5c00;font-weight:bold">=</span>pigsty
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">NGINX_UPSTREAM_YUMREPO</span><span style="color:#ce5c00;font-weight:bold">=</span>yum.pigsty
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">NGINX_UPSTREAM_CONSUL</span><span style="color:#ce5c00;font-weight:bold">=</span>c.pigsty
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">NGINX_UPSTREAM_PROMETHEUS</span><span style="color:#ce5c00;font-weight:bold">=</span>p.pigsty
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">NGINX_UPSTREAM_ALERTMANAGER</span><span style="color:#ce5c00;font-weight:bold">=</span>a.pigsty
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">NGINX_UPSTREAM_GRAFANA</span><span style="color:#ce5c00;font-weight:bold">=</span>g.pigsty
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">NGINX_UPSTREAM_HAPROXY</span><span style="color:#ce5c00;font-weight:bold">=</span>h.pigsty
</span></span></code></pre></div><p>As a reminder, using <code>grafana.py clean</code> will clear the target monitor dashboard, and using <code>grafana.py load</code> will load all the monitor dashboards in the current dir. When Pigsty&rsquo;s monitor dashboard changes, you can use these two commands to upgrade all the monitor dashboards.</p>
<hr>
<h2 id="manage-datasources">Manage DataSources</h2>
<p>When creating a new PostgreSQL cluster with <a href="p-pgsql"><code>pgsql.yml</code></a> or a new business database with <a href="p-pgsql.md#pgsql-db"><code>pgsql-db.yml</code></a>, Pigsty will register the new PostgreSQL data source in Grafana, and you can access the target database instance directly through Grafana using the default admin user. Most of the functionality of the application <code>pgcat</code> relies on this.</p>
<p>To register a Postgres database, you can use the <code>register_grafana</code> task in <a href="p-pgsql.md"><code>pgsql.yml</code></a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t register_grafana <span style="color:#8f5902;font-style:italic"># Re-register all Postgres data sources in the current environment</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t register_grafana -l pg-test <span style="color:#8f5902;font-style:italic"># Re-register all the databases in the pg-test cluster</span>
</span></span></code></pre></div><hr>
<h2 id="update-grafana-database">Update Grafana Database</h2>
<p>You can directly change the backend data source used by Grafana by modifying the Pigsty config file. Edit the <a href="v-infra.md#grafana_database"><code>grafana_database</code></a> and <a href="v-infra.md#grafana_pgurl"><code>grafana_pgurl</code></a> parameters in <code>pigsty.yml</code> and change them.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">grafana_database</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">grafana_pgurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres://dbuser_grafana:DBUser.Grafana@meta:5436/grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Then re-execute the <code>grafana</code> task in <a href="p-infra.md"><code>infral.yml</code></a> to complete the Grafana upgrade.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./infra.yml -t grafana
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8ccc56d4ade450368e94558922ba0706">5 - Use PG as Prometheus Backend</h1>
    <div class="lead">Persist prometheus metrics with PostgreSQL + TimescaleDB through Promscale</div>
	<p>It is not recommended to use PostgreSQL as a backend for Prometheus, but it is a good opportunity to understand the
Pigsty deployment system.</p>
<hr>
<h2 id="postgres-preparation">Postgres Preparation</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi pigsty.yml <span style="color:#8f5902;font-style:italic"># dbuser_prometheus  prometheus</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pg_databases:                           <span style="color:#8f5902;font-style:italic"># define business users/roles on this cluster, array of user definition</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ce5c00;font-weight:bold">{</span> name: prometheus, owner: dbuser_prometheus , revokeconn: true, comment: prometheus primary database <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>pg_users:                           <span style="color:#8f5902;font-style:italic"># define business users/roles on this cluster, array of user definition</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ce5c00;font-weight:bold">{</span>name: dbuser_prometheus , password: DBUser.Prometheus ,pgbouncer: <span style="color:#204a87">true</span> , createrole: true,  roles: <span style="color:#ce5c00;font-weight:bold">[</span>dbrole_admin<span style="color:#ce5c00;font-weight:bold">]</span>, comment: admin user <span style="color:#204a87;font-weight:bold">for</span> prometheus database <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>Create the database and user:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-user  pg-meta  dbuser_prometheus
</span></span><span style="display:flex;"><span>bin/pgsql-db    pg-meta  prometheus
</span></span></code></pre></div><p>Check the connection string:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql postgres://dbuser_prometheus:DBUser.Prometheus@10.10.10.10:5432/prometheus -c <span style="color:#4e9a06">&#39;CREATE EXTENSION timescaledb;&#39;</span>
</span></span></code></pre></div><hr>
<h2 id="promscale-configuration">Promscale Configuration</h2>
<p>Install promscale package:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y promscale 
</span></span></code></pre></div><p>If the package is not available in the default repository, you can download it directly:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/timescale/promscale/releases/download/0.6.1/promscale_0.6.1_Linux_x86_64.rpm
</span></span><span style="display:flex;"><span>sudo rpm -ivh promscale_0.6.1_Linux_x86_64.rpm
</span></span></code></pre></div><p>Edit the <code>promscale</code> configuration file <code>/etc/sysconfig/promscale.conf</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">PROMSCALE_DB_HOST</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PROMSCALE_DB_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;prometheus&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PROMSCALE_DB_PASSWORD</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;DBUser.Prometheus&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PROMSCALE_DB_PORT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;5432&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PROMSCALE_DB_SSL_MODE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;disable&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PROMSCALE_DB_USER</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;dbuser_prometheus&#34;</span>
</span></span></code></pre></div><p>Launch promscale service, it will create schema in <code>prometheus</code> database.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># launch </span>
</span></span><span style="display:flex;"><span>cat /usr/lib/systemd/system/promscale.service
</span></span><span style="display:flex;"><span>systemctl start promscale <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> systemctl status promscale
</span></span></code></pre></div><hr>
<h2 id="prometheus-configuration">Prometheus Configuration</h2>
<p>Prometheus can use Remote Write/ Remote Read to store metrics in Postgres via Promscale.</p>
<p>Edit the Prometheus configuration file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi /etc/prometheus/prometheus.yml
</span></span></code></pre></div><p>Add the following configuration to the <code>remote_write</code> and <code>remote_read</code> sections:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">remote_write</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;http://127.0.0.1:9201/write&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">remote_read</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;http://127.0.0.1:9201/read&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Metrics are loaded into Postgres after Prometheus is restarted.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl restart prometheus
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9f5474502d4f0b74cbd1e1f9ae23bc23">6 - Bind a L2 VIP to Node Cluster with Keepalived</h1>
    
	<p>You can bind an optional L2 VIP on a node cluster with <a href="/docs/reference/param/#vip_enabled"><code>vip_enabled</code></a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>proxy:
</span></span><span style="display:flex;"><span>  hosts:
</span></span><span style="display:flex;"><span>    10.10.10.29: <span style="color:#ce5c00;font-weight:bold">{</span> nodename: proxy-1 <span style="color:#ce5c00;font-weight:bold">}</span> 
</span></span><span style="display:flex;"><span>    10.10.10.30: <span style="color:#ce5c00;font-weight:bold">{</span> nodename: proxy-2 <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#8f5902;font-style:italic"># , vip_role: master }</span>
</span></span><span style="display:flex;"><span>  vars:
</span></span><span style="display:flex;"><span>    node_cluster: proxy
</span></span><span style="display:flex;"><span>    vip_enabled: <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>    vip_vrid: <span style="color:#0000cf;font-weight:bold">128</span>
</span></span><span style="display:flex;"><span>    vip_address: 10.10.10.99
</span></span><span style="display:flex;"><span>    vip_interface: eth1
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./node.yml -l proxy -t node_vip     <span style="color:#8f5902;font-style:italic"># enable for the first time</span>
</span></span><span style="display:flex;"><span>./node.yml -l proxy -t vip_refresh  <span style="color:#8f5902;font-style:italic"># refresh vip config (e.g. designated master) </span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d55948673c4562234cd1d0c550779f28">7 - Bind a L2 VIP to PostgreSQL Primary with VIP-Manager</h1>
    
	<p>You can define an <strong>OPTIONAL</strong> L2 VIP on a PostgreSQL cluster, provided that all nodes in the cluster are in the same L2 network.</p>
<p>This VIP works on Master-Backup mode and always points to the node where the primary instance of the database cluster is located.</p>
<p>This VIP is managed by the <a href="https://github.com/cybertec-postgresql/vip-manager">VIP-Manager</a>, which reads the Leader Key written by Patroni from DCS (etcd) to determine whether it is the master.</p>
<hr>
<h2 id="enable-vip">Enable VIP</h2>
<p>Define <a href="/docs/reference/param/#pg_vip_enabled"><code>pg_vip_enabled</code></a> parameter as <code>true</code> in the cluster level:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pgsql 3 node ha cluster: pg-test</span>
</span></span><span style="display:flex;"><span>pg-test:
</span></span><span style="display:flex;"><span>  hosts:
</span></span><span style="display:flex;"><span>    10.10.10.11: <span style="color:#ce5c00;font-weight:bold">{</span> pg_seq: 1, pg_role: primary <span style="color:#ce5c00;font-weight:bold">}</span>   <span style="color:#8f5902;font-style:italic"># primary instance, leader of cluster</span>
</span></span><span style="display:flex;"><span>    10.10.10.12: <span style="color:#ce5c00;font-weight:bold">{</span> pg_seq: 2, pg_role: replica <span style="color:#ce5c00;font-weight:bold">}</span>   <span style="color:#8f5902;font-style:italic"># replica instance, follower of leader</span>
</span></span><span style="display:flex;"><span>    10.10.10.13: <span style="color:#ce5c00;font-weight:bold">{</span> pg_seq: 3, pg_role: replica, pg_offline_query: <span style="color:#204a87">true</span> <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#8f5902;font-style:italic"># replica with offline access</span>
</span></span><span style="display:flex;"><span>  vars:
</span></span><span style="display:flex;"><span>    pg_cluster: pg-test           <span style="color:#8f5902;font-style:italic"># define pgsql cluster name</span>
</span></span><span style="display:flex;"><span>    pg_users:  <span style="color:#ce5c00;font-weight:bold">[{</span> name: <span style="color:#204a87">test</span> , password: <span style="color:#204a87">test</span> , pgbouncer: <span style="color:#204a87">true</span> , roles: <span style="color:#ce5c00;font-weight:bold">[</span> dbrole_admin <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">}]</span>
</span></span><span style="display:flex;"><span>    pg_databases: <span style="color:#ce5c00;font-weight:bold">[{</span> name: <span style="color:#204a87">test</span> <span style="color:#ce5c00;font-weight:bold">}]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 启用 L2 VIP</span>
</span></span><span style="display:flex;"><span>    pg_vip_enabled: <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>    pg_vip_address: 10.10.10.3/24
</span></span><span style="display:flex;"><span>    pg_vip_interface: eth1
</span></span></code></pre></div><p>Beware that <a href="/docs/reference/param/#pg_vip_address"><code>pg_vip_address</code></a> must be a valid IP address with subnet and available in the current L2 network.</p>
<p>Beware that <a href="/docs/reference/param/#pg_vip_interface"><code>pg_vip_interface</code></a> must be a valid network interface name and should be the same as the one using IPv4 address in the inventory.</p>
<p>If the network interface name is different among cluster members, users should explicitly specify the <code>pg_vip_interface</code> parameter for each instance, for example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role: primary , pg_vip_interface</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">eth0  }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role: replica , pg_vip_interface</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">eth1  }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 3, pg_role: replica , pg_vip_interface</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ens33 }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># define pgsql cluster name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: test , password: test , pgbouncer: true , roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_admin ] }]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test }]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 启用 L2 VIP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_vip_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_vip_address</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.3</span><span style="color:#000">/24</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#pg_vip_interface: eth1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>To refresh the VIP configuration and restart the VIP-Manager, use the following command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_vip 
</span></span></code></pre></div>
</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Mail" aria-label="Mail">
    <a target="_blank" rel="noopener" href="mailto:rh@vonng.com" aria-label="Mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Vonng/pigsty" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://twitter.com/GobeUncleWang" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="WeChat" aria-label="WeChat">
    <a target="_blank" rel="noopener" href="/img/pigsty/pigsty-cc.jpg" aria-label="WeChat">
      <i class="fa fa-comment"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Discord" aria-label="Discord">
    <a target="_blank" rel="noopener" href="https://discord.gg/wDzt5VyWEz" aria-label="Discord">
      <i class="fab fa-discord"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Telegram" aria-label="Telegram">
    <a target="_blank" rel="noopener" href="https://t.me/joinchat/gV9zfZraNPM3YjFh" aria-label="Telegram">
      <i class="fab fa-telegram"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2018&ndash;2024
    <span class="td-footer__authors">Ruohang Feng</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span></span><span class="ms-2"><a href="https://vonng.com/en/" target="_blank" rel="noopener">@Vonng</a></span>
<br><span>Pigsty® distributed under <a href="/docs/about/license" target="_blank" rel="noopener">AGPLv3</a></span>
<br><span class="ms-2"><a href="/docs/about/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
<span><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">浙ICP备15016890号</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.248655eb216150e39da254c2f7aa5357805d0ec66bdb741b591cd35fb5f629ab.js" integrity="sha256-JIZV6yFhUOOdolTC96pTV4BdDsZr23QbWRzTX7X2Kas=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
