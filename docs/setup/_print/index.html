<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="/docs/setup/">
<link rel="alternate" type="application/rss&#43;xml" href="/docs/setup/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Getting Started | Pigsty</title>
<meta name="description" content="Get Pigsty up &amp; running based your resources and needs: preparation, provision, download, configure, and installation
">
<meta property="og:title" content="Getting Started" />
<meta property="og:description" content="Get Pigsty up &amp; running based your resources and needs: preparation, provision, download, configure, and installation
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/setup/" />

<meta itemprop="name" content="Getting Started">
<meta itemprop="description" content="Get Pigsty up &amp; running based your resources and needs: preparation, provision, download, configure, and installation
"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Getting Started"/>
<meta name="twitter:description" content="Get Pigsty up &amp; running based your resources and needs: preparation, provision, download, configure, and installation
"/>




<link rel="preload" href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" as="style">
<link href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="/js/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LG1V9WTKGE');
}
</script>
  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class="navbar-brand__name">Pigsty</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/docs/"><i class='fa-solid fa-book'></i><span>Docs</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/blog/"><i class="fas fa-blog"></i><span>Blog</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/Vonng/pigsty/" target="_blank" rel="noopener"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-language"></i>English</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/zh/docs/setup/">中文</a></li>
    </ul>
</div>
</li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.7f52716eed5c00c4ea3a67d5969ab944.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/setup/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Getting Started</h1>
<div class="lead">Get Pigsty up &amp; running based your resources and needs: preparation, provision, download, configure, and installation</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-feb220ce98138be93707bc30fc029cd1">Installation</a></li>


    
  
    
    
	
<li>2: <a href="#pg-01b2a33b37e8e7124df9aa116794fa36">Offline Install</a></li>


    
  
    
    
	
<li>3: <a href="#pg-c38b3e7bce8cb65ffd26ccafa496eb5e">Slim Installation</a></li>


    
  
    
    
	
<li>4: <a href="#pg-d96b1765e9d967725a0824edd07fe95d">Configuration</a></li>


    
  
    
    
	
<li>5: <a href="#pg-24263fa625b63eabb5c32f29ec96c5f7">Preparation</a></li>


    
  
    
    
	
<li>6: <a href="#pg-98758ad7ef56ab0b1a9ad8320b14506b">Playbooks</a></li>


    
  
    
    
	
<li>7: <a href="#pg-2b6cc71ea6f4c2bb3c7905255869cead">Provisioning</a></li>


    
  
    
    
	
<li>8: <a href="#pg-d6a656f7f8306b7de558a78bf1164ae0">Security</a></li>


    
  
    
    
	
<li>9: <a href="#pg-262f396efed9aff5d120f3d92b472bdf">FAQ</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-feb220ce98138be93707bc30fc029cd1">1 - Installation</h1>
    <div class="lead">How to install Pigsty?</div>
	<p>Install Pigsty with 4 steps: <a href="/docs/setup/install/#prepare"><strong>Prepare</strong></a>, <a href="/docs/setup/install/#download"><strong>Download</strong></a>, <a href="/docs/setup/install/#configure"><strong>Configure</strong></a> and <a href="/docs/setup/install/#install"><strong>Install</strong></a>. Also check <a href="/docs/setup/offline/">offline</a> if you don&rsquo;t have internet access.</p>
<hr>
<h2 id="short-version">Short Version</h2>
<p><a href="https://pigsty.io/docs/pgsql"><img alt="Postgres: 17.2" src="https://img.shields.io/badge/PostgreSQL-17.2-%233E668F?style=flat&logo=postgresql&labelColor=3E668F&logoColor=white"></a>
<a href="https://pigsty.io/docs/node"><img alt="Linux" src="https://img.shields.io/badge/Linux-%23FCC624?style=flat&logo=linux&labelColor=FCC624&logoColor=black"></a>
<a href="https://pigsty.io/docs/reference/compatibility/"><img alt="EL Support: 7/8/9" src="https://img.shields.io/badge/EL-7/8/9-red?style=flat&logo=redhat&logoColor=red"></a>
<a href="https://pigsty.io/docs/reference/compatibility/"><img alt="Debian Support: 11/12" src="https://img.shields.io/badge/Debian-11/12-%23A81D33?style=flat&logo=debian&logoColor=%23A81D33"></a>
<a href="https://pigsty.io/docs/pgext/list/deb/"><img alt="Ubuntu Support: 20/22/24" src="https://img.shields.io/badge/Ubuntu-20/22/24-%23E95420?style=flat&logo=ubuntu&logoColor=%23E95420"></a>
<a href="https://almalinux.org/"><img alt="Alma" src="https://img.shields.io/badge/Alma-slategray?style=flat&logo=almalinux&logoColor=black"></a>
<a href="https://almalinux.org/"><img alt="Rocky" src="https://img.shields.io/badge/Rocky-slategray?style=flat&logo=rockylinux&logoColor=%2310B981"></a>
<a href="https://almalinux.org/"><img alt="CentOS" src="https://img.shields.io/badge/CentOS-slategray?style=flat&logo=centos&logoColor=%23262577"></a>
<a href="https://almalinux.org/"><img alt="OracleLinux" src="https://img.shields.io/badge/Oracle-slategray?style=flat&logo=oracle&logoColor=%23F80000"></a></p>
<p><a href="/docs/setup/install/#prepare"><strong>Prepare</strong></a> a fresh <strong>x86_64/aarch64</strong> node that runs any <a href="/docs/reference/compatibility/"><strong>compatible</strong></a> <strong>Linux</strong> OS Distros, then <a href="/docs/setup/install/#download"><strong>Download</strong></a> <strong>Pigsty</strong> with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -fsSL https://repo.pigsty.io/get <span style="color:#000;font-weight:bold">|</span> bash<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">cd</span> ~/pigsty<span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>You can run the optional <a href="/docs/setup/offline/#bootstrap"><strong>bootstrap</strong></a> and <a href="/docs/setup/install/#configure"><strong>configure</strong></a> to install <code>ansible</code> and generate <code>pigsty.yml</code> config file.</p>
<p>Next, run the <a href="/docs/setup/install/#install"><strong><code>install.yml</code></strong></a> playbook with an <a href="/docs/setup/prepare/#admin-user"><strong>admin user</strong></a> (<strong>nopass</strong> <code>ssh</code> &amp; <code>sudo</code>):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./bootstrap<span style="color:#000;font-weight:bold">;</span> ./configure<span style="color:#000;font-weight:bold">;</span> ./install.yml<span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><ul>
<li><a href="/docs/setup/offline/#bootstrap"><strong>bootstrap</strong></a>: <strong>OPTIONAL</strong>, make sure <code>ansible</code> is installed, and use offline package <code>/tmp/pkg.tgz</code> if applicable</li>
<li><a href="/docs/setup/install/#configure"><strong>configure</strong></a>: <strong>OPTIONAL</strong>, recommend &amp; generate <code>pigsty.yml</code> config according to your env.</li>
<li><a href="/docs/setup/install/#install"><strong>install.yml</strong></a>: <strong>REQUIRED</strong>, install Pigsty modules according to your config file.</li>
</ul>
<p>It may take 5-20 minutes to complete the installation according to your network speed and hardware spec.</p>
<p>After that, you will get a pigsty singleton node <a href="/docs/setup/install/#interface"><strong>ready</strong></a>, with Web service on port <code>80/443</code> and Postgres on port <code>5432</code>.</p>
<p>BTW: If you feel Pigsty is too complicated, you can consider the <a href="/docs/setup/slim/"><strong>Slim Installation</strong></a>, which only installs the necessary components for HA PostgreSQL clusters.</p>
<hr>
<p><strong>Example: Singleton Installation on RockyLinux 9.3:</strong></p>
<p><a href="https://asciinema.org/a/673459"><img alt="asciicast" src="https://asciinema.org/a/673459.svg"></a></p>
<hr>
<h2 id="prepare">Prepare</h2>
<blockquote>
<p>Check <a href="/docs/setup/prepare/">Preparation</a> for a complete guide of resource preparation.</p>
</blockquote>
<p>Pigsty support the <code>Linux</code> kernel and <code>x86_64/aarch64</code> arch. It can run on any nodes: physical machine, bare metal, virtual machines, or VM-like containers, but a <strong>static</strong> IPv4 address is required.
The minimum spec is <code>1C1G</code>. It is recommended to use bare metals or VMs with at least <code>2C4G</code>. There&rsquo;s no upper limit, and node param will be auto-tuned.</p>
<p>We recommend using fresh <strong>RockyLinux 8.10 / 9.4</strong> or <strong>Ubuntu 22.04</strong> as underlying operating systems.
For a complete list of supported operating systems, please refer to <a href="/docs/reference/compatibility/"><strong>Compatibility</strong></a>.</p>
<p>Public key <code>ssh</code> access to localhost and NOPASSWD <code>sudo</code> privilege is required to perform the installation, Try not using the <code>root</code> user.
If you wish to manage more nodes, these nodes needs to be <code>ssh</code> / <code>sudo</code> accessible via your current admin node &amp; admin user.</p>


<div class="alert alert-danger" role="alert">
<h4 class="alert-heading">DO NOT use the root user</h4>

    While it is possible to install Pigsty as the <code>root</code> user, It would be much safer using a dedicate admin user (<code>dba</code>, <code>admin</code>, &hellip;). due to <a href="/docs/setup/security/"><strong>security</strong></a> consideration
which has to be different from <code>root</code> and dbsu (<code>postgres</code>). Pigsty will create an optional admin user <code>dba</code> according to the config by default.

</div>

<p>Pigsty relies on Ansible to execute playbooks. you have to install <code>ansible</code> and <code>jmespath</code> packages fist before <a href="/docs/setup/install/#install"><strong>install</strong></a> procedure.
This can be done with the following command, or through the <a href="/docs/setup/offline/#bootstrap"><strong><code>bootstrap</code></strong></a> procedure, especially when you don&rsquo;t have internet access.</p>






<ul class="nav nav-tabs" id="tabs-1" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-01-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-00" role="tab"
          aria-controls="tabs-01-00" aria-selected="false">
        Install Ansible
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-01-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-01" role="tab"
          aria-controls="tabs-01-01" aria-selected="true">
        EL 8 / 9
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-02" role="tab"
          aria-controls="tabs-01-02" aria-selected="false">
        EL 7
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-03" role="tab"
          aria-controls="tabs-01-03" aria-selected="false">
        Debian / Ubuntu
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-01-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-01-04" role="tab"
          aria-controls="tabs-01-04" aria-selected="false">
        MacOS
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-1-content">
    <div class="tab-pane fade"
        id="tabs-01-00" role="tabpanel" aria-labelled-by="tabs-01-00-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"></code></pre></div>
    </div>
    <div class="tab-pane fade show active"
        id="tabs-01-01" role="tabpanel" aria-labelled-by="tabs-01-01-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>sudo dnf install -y ansible python3.12-jmespath python3-cryptography</span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-01-02" role="tabpanel" aria-labelled-by="tabs-01-02-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>sudo yum install -y ansible   <span style="color:#8f5902;font-style:italic"># EL7 does not need to install jmespath explicitly</span></span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-01-03" role="tabpanel" aria-labelled-by="tabs-01-03-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>sudo apt install -y ansible python3-jmespath</span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-01-04" role="tabpanel" aria-labelled-by="tabs-01-04-tab" tabindex="1">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>brew install ansible</span></span></code></pre></div>
    </div>
</div>

<hr>
<h2 id="download">Download</h2>
<p>You can get &amp; extract pigsty source via the following command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -fsSL https://repo.pigsty.io/get <span style="color:#000;font-weight:bold">|</span> bash<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">cd</span> ~/pigsty
</span></span></code></pre></div><details><summary>Install with get script</summary><br>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -fsSL https://repo.pigsty.io/get <span style="color:#000;font-weight:bold">|</span> bash
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>v3.1.0<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span><span style="display:flex;"><span>$ curl -fsSL https://repo.pigsty.io/get <span style="color:#000;font-weight:bold">|</span> bash
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Site<span style="color:#ce5c00;font-weight:bold">]</span> https://pigsty.io
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Demo<span style="color:#ce5c00;font-weight:bold">]</span> https://demo.pigsty.cc
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Repo<span style="color:#ce5c00;font-weight:bold">]</span> https://github.com/Vonng/pigsty
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Docs<span style="color:#ce5c00;font-weight:bold">]</span> https://pigsty.io/docs/setup/install
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Download<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">version</span> <span style="color:#ce5c00;font-weight:bold">=</span> v3.1.0 <span style="color:#ce5c00;font-weight:bold">(</span>from default<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>curl -fSL https://repo.pigsty.io/src/pigsty-v3.1.0.tgz -o /tmp/pigsty-v3.1.0.tgz
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">######################################################################## 100.0%</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">md5sums</span> <span style="color:#ce5c00;font-weight:bold">=</span> 01b4acbe8983c1324652ae68b4f3c56f  /tmp/pigsty-v3.1.0.tgz
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Install<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> os <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> root , it<span style="color:#a40000">&#39;</span>s recommended to install as a sudo-able admin
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">install</span> <span style="color:#ce5c00;font-weight:bold">=</span> /root/pigsty, from /tmp/pigsty-v3.1.0.tgz
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>TodoList<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> /root/pigsty
</span></span><span style="display:flex;"><span>./bootstrap      <span style="color:#8f5902;font-style:italic"># [OPTIONAL] install ansible &amp; use offline package</span>
</span></span><span style="display:flex;"><span>./configure      <span style="color:#8f5902;font-style:italic"># [OPTIONAL] preflight-check and config generation</span>
</span></span><span style="display:flex;"><span>./install.yml    <span style="color:#8f5902;font-style:italic"># install pigsty modules according to your config.</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Complete<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span></code></pre></div></details>
<p>To install a specific version, pass the version string as the first parameter:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -fsSL https://repo.pigsty.io/get <span style="color:#000;font-weight:bold">|</span> bash -s v3.1.0<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">cd</span> ~/pigsty
</span></span></code></pre></div><p>You can also use <code>git</code> to download the Pigsty source. Please make sure to <strong>check out a specific version</strong> before using.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/Vonng/pigsty<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">cd</span> pigsty<span style="color:#000;font-weight:bold">;</span> git checkout v3.1.0
</span></span></code></pre></div>

<div class="alert alert-danger" role="alert">
<h4 class="alert-heading">Checkout a specific version</h4>

    The <code>main</code> branch may in an unstable development status.
Always checkout a version when using <code>git</code>, check <a href="/docs/releasenote/">Release Notes</a> for available versions.

</div>

<hr>
<h2 id="configure">Configure</h2>
<p><a href="/docs/setup/config/"><code>configure</code></a> will create a <a href="https://github.com/Vonng/pigsty/blob/main/pigsty.yml"><code>pigsty.yml</code></a> <a href="/docs/setup/config/">config</a> file according to your env.
This procedure is <strong>OPTIONAL</strong> if you know how to <a href="/docs/setup/config/">configure</a> pigsty manually. There are many <a href="/docs/conf/overview/"><strong>config tempalte</strong></a> for your reference.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./configure <span style="color:#8f5902;font-style:italic"># interactive-wizard, ask for IP address</span>
</span></span><span style="display:flex;"><span>./configure <span style="color:#ce5c00;font-weight:bold">[</span>-i<span style="color:#000;font-weight:bold">|</span>--ip &lt;ipaddr&gt;<span style="color:#ce5c00;font-weight:bold">]</span>                     <span style="color:#8f5902;font-style:italic"># give primary IP &amp; config mode</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">[</span>-c<span style="color:#000;font-weight:bold">|</span>--conf &lt;conf&gt;<span style="color:#ce5c00;font-weight:bold">]</span>                     <span style="color:#8f5902;font-style:italic"># specify config template (relative to conf/ dir without .yml suffix)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">[</span>-v<span style="color:#000;font-weight:bold">|</span>--version &lt;ver&gt;<span style="color:#ce5c00;font-weight:bold">]</span>                   <span style="color:#8f5902;font-style:italic"># specify PostgreSQL major version (13,14,15,16,17)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">[</span>-r<span style="color:#000;font-weight:bold">|</span>--region &lt;default<span style="color:#000;font-weight:bold">|</span>china<span style="color:#000;font-weight:bold">|</span>europe&gt;<span style="color:#ce5c00;font-weight:bold">]</span>   <span style="color:#8f5902;font-style:italic"># choose upstream repo region</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">[</span>-n<span style="color:#000;font-weight:bold">|</span>--non-interactive<span style="color:#ce5c00;font-weight:bold">]</span>                 <span style="color:#8f5902;font-style:italic"># skip interactive wizard</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">[</span>-x<span style="color:#000;font-weight:bold">|</span>--proxy<span style="color:#ce5c00;font-weight:bold">]</span>                           <span style="color:#8f5902;font-style:italic"># write proxy env to config </span>
</span></span></code></pre></div><details><summary>Configure Example Output</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./configure
</span></span><span style="display:flex;"><span>configure pigsty v3.1.0 begin
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">region</span> <span style="color:#ce5c00;font-weight:bold">=</span> china
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">kernel</span> <span style="color:#ce5c00;font-weight:bold">=</span> Linux
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">machine</span> <span style="color:#ce5c00;font-weight:bold">=</span> x86_64
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">package</span> <span style="color:#ce5c00;font-weight:bold">=</span> rpm,yum
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">vendor</span>  <span style="color:#ce5c00;font-weight:bold">=</span> centos <span style="color:#ce5c00;font-weight:bold">(</span>CentOS Linux<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#ce5c00;font-weight:bold">(</span>7<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">sudo</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">ssh</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant@127.0.0.1 ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> Multiple IP address candidates found:
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">(</span>1<span style="color:#ce5c00;font-weight:bold">)</span> 192.168.121.110	    inet 192.168.121.110/24 brd 192.168.121.255 scope global noprefixroute dynamic eth0
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">(</span>2<span style="color:#ce5c00;font-weight:bold">)</span> 10.10.10.10	    inet 10.10.10.10/24 brd 10.10.10.255 scope global noprefixroute eth1
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">primary_ip</span> <span style="color:#ce5c00;font-weight:bold">=</span> 10.10.10.10 <span style="color:#ce5c00;font-weight:bold">(</span>from demo<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">admin</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant@10.10.10.10 ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> el7, CentOS 7.9 EOL @ 2024-06-30, deprecated, consider using el8 or el9 instead
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> configure pigsty <span style="color:#204a87;font-weight:bold">done</span>
</span></span><span style="display:flex;"><span>proceed with ./install.yml
</span></span></code></pre></div></details><br>
<ul>
<li><code>-i|--ip</code>: Replace IP address placeholder <code>10.10.10.10</code> with your primary ipv4 address of current node.</li>
<li><code>-c|--conf</code>: Generate config from <a href="/docs/conf/overview/">config templates</a> according to this parameter</li>
<li><code>-v|--version</code>: Specify PostgreSQL major version (<code>13|14|15|16|17</code>)</li>
<li><code>-r|--region</code>: Set upstream repo mirror according to <code>region</code> (<code>default|china|europe</code>)</li>
<li><code>-n|--non-interactive</code>: skip interactive wizard and using default/arg values</li>
<li><code>-x|--proxy</code>: write current proxy env to the config <a href="/docs/reference/param/#proxy_env"><code>proxy_env</code></a> (<code>http_proxy</code>/<code>HTTP_PROXY</code>,  <code>HTTPS_PROXY</code>,  <code>ALL_PROXY</code>,  <code>NO_PROXY</code>)</li>
</ul>
<p>When <code>-n|--non-interactive</code> is specified, you have to specify a primary IP address with <code>-i|--ip &lt;ipaddr&gt;</code> in case of multiple IP address,
since there&rsquo;s no default value for primary IP address in this case.</p>
<p>If your machine&rsquo;s network interface have multiple IP addresses, you&rsquo;ll need to explicitly specify a <strong>primary</strong> IP address for the current node using <code>-i|--ip &lt;ipaddr&gt;</code>, or provide it during interactive inquiry. The address should be a static IP address, and you should avoid using any public IP addresses.</p>
<p>You can check and modify the generated config file <code>~/pigsty/pigsty.yml</code> before installation.</p>


<div class="alert alert-danger" role="alert">
<h4 class="alert-heading">Change the default passwords!</h4>

    PLEASE CHANGE THE DEFAULT PASSWORDs in the config file before installation, check <a href="/docs/setup/security/#passwords">secure password</a> for details.

</div>

<hr>
<h2 id="install">Install</h2>
<p>Run the <a href="https://github.com/Vonng/pigsty/blob/main/pigsty.yml"><code>install.yml</code></a> playbook to perform a full installation on current node</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./install.yml    <span style="color:#8f5902;font-style:italic"># install everything in one-pass</span>
</span></span></code></pre></div><details><summary>Installation Output Example</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>vagrant@meta pigsty<span style="color:#ce5c00;font-weight:bold">]</span>$ ./install.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PLAY <span style="color:#ce5c00;font-weight:bold">[</span>IDENTITY<span style="color:#ce5c00;font-weight:bold">]</span> ********************************************************************************************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#ce5c00;font-weight:bold">[</span>node_id : get node fact<span style="color:#ce5c00;font-weight:bold">]</span> *****************************************************************************************************************
</span></span><span style="display:flex;"><span>changed: <span style="color:#ce5c00;font-weight:bold">[</span>10.10.10.10<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>PLAY RECAP **************************************************************************************************************************************************************************
</span></span><span style="display:flex;"><span>10.10.10.10                : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">288</span>  <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">215</span>  <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">skipped</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">64</span>   <span style="color:#000">rescued</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">ignored</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>localhost                  : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>    <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">skipped</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span>    <span style="color:#000">rescued</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">ignored</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div></details><br>
<p>It&rsquo;s a standard ansible <a href="/docs/setup/playbook/"><strong>playbook</strong></a>, you can have fine-grained control with ansible options:</p>
<ul>
<li><code>-l</code>: limit execution targets</li>
<li><code>-t</code>: limit execution tasks</li>
<li><code>-e</code>: passing extra args</li>
<li><code>-i</code>: use another config</li>
<li>&hellip;</li>
</ul>


<div class="alert alert-danger" role="alert">
<h4 class="alert-heading">DON'T EVER RUN THIS PLAYBOOK AGAIN!</h4>

    <p>It&rsquo;s very DANGEROUS to re-run <a href="https://github.com/Vonng/pigsty/blob/main/install.yml"><strong><code>install.yml</code></strong></a> on existing deployment!</p>
<p>It may nuke your entire deployment!!! Only do this when you know what you are doing.</p>
<p>Otherwise, consider <code>rm install.yml</code> or <code>chmod a-x install.yml</code> to avoid accidental execution.</p>


</div>

<hr>
<h2 id="interface">Interface</h2>
<p>Once installed, you&rsquo;ll have four <a href="/docs/about/module/#core-modules">core modules</a> <a href="/docs/pgsql/"><strong><code>PGSQL</code></strong></a>, <a href="/docs/infra/"><strong><code>INFRA</code></strong></a>, <a href="/docs/node/"><strong><code>NODE</code></strong></a>, and <a href="/docs/etcd/"><strong><code>ETCD</code></strong></a> the current node.</p>
<p>The <a href="/docs/pgsql/"><strong>PGSQL</strong></a> provides a PostgreSQL singleton which can be <a href="/docs/concept/svc/#personal-user">accessed</a> via:</p>





<ul class="nav nav-tabs" id="tabs-5" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-05-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-05-00" role="tab"
          aria-controls="tabs-05-00" aria-selected="false">
        Default Users
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-05-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-05-01" role="tab"
          aria-controls="tabs-05-01" aria-selected="true">
        dbuser_dba
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-05-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-05-02" role="tab"
          aria-controls="tabs-05-02" aria-selected="false">
        dbuser_meta
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-05-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-05-03" role="tab"
          aria-controls="tabs-05-03" aria-selected="false">
        dbuser_view
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-5-content">
    <div class="tab-pane fade"
        id="tabs-05-00" role="tabpanel" aria-labelled-by="tabs-05-00-tab" tabindex="5">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"></code></pre></div>
    </div>
    <div class="tab-pane fade show active"
        id="tabs-05-01" role="tabpanel" aria-labelled-by="tabs-05-01-tab" tabindex="5">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10/meta     <span style="color:#8f5902;font-style:italic"># DBA / superuser (via IP)</span></span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-05-02" role="tabpanel" aria-labelled-by="tabs-05-02-tab" tabindex="5">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>psql postgres://dbuser_meta:DBUser.Meta@10.10.10.10/meta   <span style="color:#8f5902;font-style:italic"># business admin, read / write / ddl</span></span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-05-03" role="tabpanel" aria-labelled-by="tabs-05-03-tab" tabindex="5">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>psql postgres://dbuser_view:DBUser.View@pg-meta/meta       <span style="color:#8f5902;font-style:italic"># read-only user</span></span></span></code></pre></div>
    </div>
</div>

<p>The <a href="/docs/infra/"><strong>INFRA</strong></a> module gives you an entire modern observability stack, exposed by Nginx on (<code>80</code> / <code>443</code>):</p>
<p>There are several services are exposed by Nginx (configured by <a href="/docs/reference/param/#infra_portal"><code>infra_portal</code></a>):</p>
<table>
<thead>
<tr>
<th style="text-align:center">Component</th>
<th style="text-align:center">Port</th>
<th style="text-align:center">Domain</th>
<th>Comment</th>
<th>Public Demo</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>Nginx</strong></td>
<td style="text-align:center"><strong>80/443</strong></td>
<td style="text-align:center"><code>h.pigsty</code></td>
<td>Web Service Portal, Repo</td>
<td><a href="http://home.pigsty.cc"><code>home.pigsty.cc</code></a></td>
</tr>
<tr>
<td style="text-align:center">AlertManager</td>
<td style="text-align:center">9093</td>
<td style="text-align:center"><code>a.pigsty</code></td>
<td>Alter Aggregator</td>
<td><a href="http://a.pigsty.cc"><code>a.pigsty.cc</code></a></td>
</tr>
<tr>
<td style="text-align:center"><strong>Grafana</strong></td>
<td style="text-align:center"><strong>3000</strong></td>
<td style="text-align:center"><code>g.pigsty</code></td>
<td>Grafana Dashboard Home</td>
<td><a href="https://demo.pigsty.cc"><code>demo.pigsty.cc</code></a></td>
</tr>
<tr>
<td style="text-align:center">Prometheus</td>
<td style="text-align:center">9090</td>
<td style="text-align:center"><code>p.pigsty</code></td>
<td>Prometheus Web UI</td>
<td><a href="http://p.pigsty.cc"><code>p.pigsty.cc</code></a></td>
</tr>
</tbody>
</table>
<blockquote>
<p>Grafana Dashboards (g.pigsty, port 3000) credentials, user: <code>admin</code> / pass: <code>pigsty</code></p>
</blockquote>
<p><a href="https://demo.pigsty.cc"><img alt="pigsty-home.jpg" src="/img/pigsty/home.jpg"></a></p>
<p>You can access these web UI directly via IP + port. While the common best practice would be access them through Nginx and distinguish via domain names. You&rsquo;ll need configure DNS records, or use the local static records (<code>/etc/hosts</code>) for that.</p>
<br>
<details><summary>How to access Pigsty Web UI by domain name?</summary><br>
<p>There are several options:</p>
<ol>
<li>Resolve internet domain names through a DNS service provider, suitable for systems accessible from the public internet.</li>
<li>Configure internal network DNS server resolution records for internal domain name resolution.</li>
<li>Modify the local machine&rsquo;s <code>/etc/hosts</code> file to add static resolution records. (For Windows, it&rsquo;s located at:)</li>
</ol>
<p>We recommend the third method for common users. On the machine (which runs the browser), add the following record into <code>/etc/hosts</code> (sudo required) or <code>C:\Windows\System32\drivers\etc\hosts</code> in Windows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">&lt;your_public_ip_address&gt;  h.pigsty a.pigsty p.pigsty g.pigsty</span>
</span></span></code></pre></div><p>You have to use the <strong>external</strong> IP address of the node here.</p>
</details><br>
<details><summary>How to configure server side domain names?</summary><br>
<p>The server-side domain name is configured with Nginx. If you want to replace the default domain name, simply enter the domain you wish to use in the parameter <a href="/docs/reference/param/#infra_portal"><code>infra_portal</code></a>. When you access the Grafana monitoring homepage via <code>http://g.pigsty</code>, it is actually accessed through the Nginx proxy to Grafana&rsquo;s WebUI:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>http://g.pigsty ️-&gt; http://10.10.10.10:80 <span style="color:#ce5c00;font-weight:bold">(</span>nginx<span style="color:#ce5c00;font-weight:bold">)</span> -&gt; http://10.10.10.10:3000 <span style="color:#ce5c00;font-weight:bold">(</span>grafana<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>If <a href="/docs/reference/param/#nginx_sslmode"><code>nginx_sslmode</code></a> is set to <code>enabled</code> or <code>enforced</code>, you can trust self-signed ca: <code>files/pki/ca/ca.crt</code> to use <code>https</code> in your browser.</p>
</details><br>
<details><summary>How to use HTTPS in Pigsty WebUI?</summary><br>
<p>Pigsty will generate self-signed certs for Nginx, if you wish to access via HTTPS without &ldquo;Warning&rdquo;, here are some options:</p>
<ul>
<li>Apply &amp; add real certs from trusted CA: such as Let&rsquo;s Encrypt</li>
<li>Trust your generated CA crt as root ca in your OS and browser</li>
<li>Type <code>thisisunsafe</code> in Chrome will supress the warning</li>
</ul>
</details>
<hr>
<h2 id="more">More</h2>
<p>You can deploy &amp; monitor more clusters with pigsty: add more nodes to <code>pigsty.yml</code> and run corresponding playbooks:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/node-add   pg-test      <span style="color:#8f5902;font-style:italic"># init 3 nodes of cluster pg-test</span>
</span></span><span style="display:flex;"><span>bin/pgsql-add  pg-test      <span style="color:#8f5902;font-style:italic"># init HA PGSQL Cluster pg-test</span>
</span></span><span style="display:flex;"><span>bin/redis-add  redis-ms     <span style="color:#8f5902;font-style:italic"># init redis cluster redis-ms</span>
</span></span></code></pre></div><p>Remember that most modules require the <a href="/docs/node/"><code>NODE</code></a> module installed first. Check <a href="/docs/about/module/"><strong>modules</strong></a> for detail</p>
<p><a href="/docs/pgsql/"><strong><code>PGSQL</code></strong></a>, <a href="/docs/infra/"><strong><code>INFRA</code></strong></a>, <a href="/docs/node/"><strong><code>NODE</code></strong></a>, <a href="/docs/etcd/"><strong><code>ETCD</code></strong></a>, <a href="/docs/minio/"><strong><code>MINIO</code></strong></a>, <a href="/docs/redis/"><strong><code>REDIS</code></strong></a>, <a href="/docs/ferret/"><strong><code>FERRET</code></strong></a>, <a href="/docs/node/"><strong><code>DOCKER</code></strong></a>, ……</p>
<p><a href="/docs/kernel/babelfish/"><img alt="BABELFISH" src="https://img.shields.io/badge/WILTONDB-%2388A3CA?style=flat&logo=postgresql&labelColor=88A3CA&logoColor=black"></a>
<a href="/docs/kernel/polardb/"><img alt="POLARDB PG" src="https://img.shields.io/badge/POLARDB_PG-%23DF6F2E?style=flat&logo=postgresql&labelColor=DF6F2E&logoColor=black"></a>
<a href="/docs/kernel/polardb-o/"><img alt="POLARDB ORACLE" src="https://img.shields.io/badge/POLARDB_ORACLE-%23DF6F2E?style=flat&logo=postgresql&labelColor=DF6F2E&logoColor=black"></a>
<a href="/docs/kernel/ivorysql/"><img alt="IVORYSQL" src="https://img.shields.io/badge/IVORYSQL-%23E8AC52?style=flat&logo=postgresql&labelColor=E8AC52&logoColor=black"></a>
<a href="/docs/kernel/greenplum/"><img alt="GREENPLUM" src="https://img.shields.io/badge/GREENPLUM-%23578B09?style=flat&logo=postgresql&labelColor=578B09&logoColor=black"></a>
<a href="/docs/kernel/cloudberry/"><img alt="CLOUDBERRY" src="https://img.shields.io/badge/CLOUDBERRY-orange?style=flat&logo=postgresql&labelColor=orange&logoColor=black"></a>
<a href="/docs/kernel/neon/"><img alt="NEON" src="https://img.shields.io/badge/NEON-%2366D9C6?style=flat&logo=postgresql&labelColor=66D9C6&logoColor=black"></a>
<a href="/docs/kernel/supabase/"><img alt="SUPABASE" src="https://img.shields.io/badge/SUPABASE-%233FCF8E?style=flat&logo=supabase&labelColor=3FCF8E&logoColor=white"></a></p>
<p><a href="/docs/pro/kafka/"><img alt="KAFKA" src="https://img.shields.io/badge/KAFKA-%23231F20?style=flat&logo=apachekafka&labelColor=231F20&logoColor=white"></a>
<a href="/docs/pro/kafka/"><img alt="MYSQL" src="https://img.shields.io/badge/MYSQL-%234479A1?style=flat&logo=mysql&labelColor=4479A1&logoColor=white"></a>
<a href="/docs/pro/duckdb/"><img alt="DUCKDB" src="https://img.shields.io/badge/DUCKDB-%23FFF000?style=flat&logo=duckdb&labelColor=FFF000&logoColor=white"></a>
<a href="/docs/pro/tigerbeetle/"><img alt="TIGERBEETLE" src="https://img.shields.io/badge/TIGERBEETLE-%231919191?style=flat&logo=openbugbounty&labelColor=1919191&logoColor=white"></a>
<a href="/docs/pro/victoria/"><img alt="VICTORIA" src="https://img.shields.io/badge/VICTORIA-%23621773?style=flat&logo=victoriametrics&labelColor=621773&logoColor=white"></a>
<a href="/docs/pro/kube/"><img alt="KUBERNETES" src="https://img.shields.io/badge/KUBERNETES-%23326CE5?style=flat&logo=kubernetes&labelColor=326CE5&logoColor=white"></a>
<a href="/docs/pro/consul/"><img alt="CONSUL" src="https://img.shields.io/badge/CONSUL-%23F24C53?style=flat&logo=consul&labelColor=F24C53&logoColor=white"></a>
<a href="/docs/pro/jupyter/"><img alt="JUPYTER" src="https://img.shields.io/badge/JUPYTER-%23F37626?style=flat&logo=jupyter&labelColor=F37626&logoColor=white"></a>
<a href="/docs/pro/"><img alt="COCKROACH" src="https://img.shields.io/badge/COCKROACH-%236933FF?style=flat&logo=cockroachlabs&labelColor=6933FF&logoColor=white"></a></p>
<br>
<br>
<hr>
<br>
<br>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-01b2a33b37e8e7124df9aa116794fa36">2 - Offline Install</h1>
    <div class="lead">How to install pigsty without Internet access? How to make your own offline packages.</div>
	<p>Pigsty&rsquo;s <a href="/docs/setup/install/"><strong>Installation</strong></a> procedure requires Internet access, but production database servers are often isolated from the Internet.</p>
<p>To address this issue, Pigsty supports offline installation from <a href="/docs/setup/offline/#offline-package"><strong>offline packages</strong></a>, which can help you install Pigsty in an environment without Internet access, and increase the certainty, reliability, speed and consistency of the installation process.</p>
<ul>
<li><a href="/docs/setup/offline/#build-local-repo">Build Local Repo</a></li>
<li><a href="/docs/setup/offline/#make-offline-pacakge">Make Offline Pacakge</a></li>
<li><a href="/docs/setup/offline/#use-offline-pacakge">Use Offline Package</a></li>
<li><a href="/docs/setup/offline/#compatibility-notes">Compatibility Notes</a></li>
<li><a href="/docs/setup/offline/#download-pre-made-package">Download Pre-made Package</a></li>
<li><a href="/docs/setup/offline/#bootstrap">Bootstrap</a></li>
</ul>
<hr>
<h2 id="build-local-repo">Build Local Repo</h2>
<p>Pigsty&rsquo;s <a href="/docs/setup/install/"><strong>install</strong></a> procedure will download all the required rpm/deb packages and all its dependencies from the upstream yum/apt repo, and build a local repo before installing the software.</p>
<p>The repo is served by Nginx and is available to all nodes in the deployment environment, including itself. All the installation will go through this local repo without further internet access.</p>
<p>There are certain benefits to using a local repo:</p>
<ol>
<li>It can avoid repetitive download requests and traffic consumption, significantly speeding up the installation and improving its reliability.</li>
<li>It will take a <strong>snapshot</strong> of current software versions, ensuring the consistency of the software versions installed across nodes in the environment.</li>
<li>The snapshot contains all the deps, so it can avoid upstream dependency changes that may cause installation failures. One successful node can ensure all nodes in the same env.</li>
<li>The built local software repo can be packaged as a whole tarball and copied to an isolated environment with the same operating system for <strong>offline installation</strong>.</li>
</ol>
<p>The default location for local repo is <code>/www/pigsty</code> (customizable by <a href="/docs/reference/param/#nginx_home"><code>nginx_home</code></a> &amp; <a href="/docs/reference/param/#repo_name"><code>repo_name</code></a>).
The repo will be created by <code>createrepo_c</code> or <code>dpkg_dev</code> according to the OS distro, and referenced by all nodes in the environment through <a href="/docs/reference/param/#repo_upstream"><strong><code>repo_upstream</code></strong></a> entry with <code>module=local</code>.</p>
<p>You can perform install on one node with the exact same OS version, then copy the local repo directory to another node with the same OS version for offline installation.</p>
<p>A more common practice is to package the local software repo directory into an <a href="/docs/setup/offline/#make-offline-pacakge"><strong>offline package</strong></a> and copy it to the isolated node for installation.</p>
<hr>
<h2 id="make-offline-pacakge">Make Offline Pacakge</h2>
<p>Pigsty offers a <a href="https://github.com/Vonng/pigsty/blob/main/cache.yml"><strong><code>cache.yml</code></strong></a> playbook to make offline package.
For example, the following command will take the local software repo on the infra node <code>/www/pigsty</code> and package it into an offline package, and retrieve it to the local <code>dist/${version}</code> directory.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./cache.yml -l infra  
</span></span></code></pre></div><p>You can customize the output directory and name of the offline package with the <code>cache_pkg_dir</code> and <code>cache_pkg_name</code> parameters.
For example, the following command will fetch the made offline package to <code>files/pkg.tgz</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./cache.yml -l 10.10.10.10 -e <span style="color:#4e9a06">&#39;{&#34;cache_pkg_dir&#34;:&#34;files&#34;,&#34;cache_pkg_name&#34;:&#34;pkg.tgz&#34;}&#39;</span>
</span></span></code></pre></div><hr>
<h2 id="use-offline-pacakge">Use Offline Pacakge</h2>
<p>The offline package is a tarball made by <code>gzip</code> and <code>tar</code>, and extract to <code>/www/pigsty</code> for use.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo rm -rf /www/pigsty ； sudo tar -xf /tmp/pkg.tgz -C /www 
</span></span></code></pre></div><p>The simpler way is to copy the offline package to <code>/tmp/pkg.tgz</code> on the isolated node to be installed, and Pigsty will automatically unpack it during the <a href="/docs/setup/offline/#bootstrap"><strong><code>bootstrap</code></strong></a> process and install from it.</p>
<p>When building the local software repo, Pigsty will generate a marker file <code>repo_complete</code> to mark it as a finished Pigsty local software repo.
When Pigsty <a href="/docs/setup/install/#install"><strong>install.yml</strong></a> playbook finds that the local software repo already exists, it will enter offline install mode.</p>
<p>In offline install mode, pigsty will no longer download software from the internet, but install from the local software repo directly.</p>


<div class="alert alert-secondary" role="alert">
<h4 class="alert-heading">Criteria for Offline Install Mode</h4>

     <br>
<p>The criteria for the existence of a local repo is the <strong>presence</strong> of a marker file located by default at <code>/www/pigsty/repo_complete</code>.</p>
<p>This marker file is automatically generated after the download is complete during the standard installation procedure, indicating a usable local software repo is done.</p>
<p>Deleting the <code>repo_complete</code> marker file of the local repo will mark the procedure for re-download <strong>missing</strong> packages from upstream.</p>


</div>

<hr>
<h2 id="compatibility-notes">Compatibility Notes</h2>
<p>The software packages (rpm/deb) can be roughly divided into 3 categories:</p>
<ul>
<li><a href="/docs/infra/"><strong>INFRA</strong></a> Packages such as Prometheus &amp; Grafana stacks and monitoring agents, which are OS distro/version <strong>independent</strong>.</li>
<li><a href="/docs/pgsql/"><strong>PGSQL</strong></a> Packages such as pgsql kernel &amp; extensions, which are optionally bound to the Linux distro <strong>major</strong> version.</li>
<li><a href="/docs/node/"><strong>NODE</strong></a> Packages such as so libs, utils, deps, which are bound to the Linux distro <strong>major &amp; minor</strong> version.</li>
</ul>
<p>Therefore, the compatibility of offline packages depends on the <strong>OS major version</strong> and <strong>minor version</strong> because it contains all three types of packages.</p>
<p>Usually, offline packages can be used in an environment with the exact same OS major/minor version.
If the major version does not match, INFRA packages can usually be installed successfully, while PGSQL and NODE packages may have missing or conflicting dependencies.
If the minor version does not match, INFRA and PGSQL packages can usually be installed successfully, while NODE packages have a chance of success and a chance of failure.</p>
<p>For example, offline packages made on RockLinux 8.9 <strong>may</strong> have a greater chance of success when offline installed on RockyLinux 8.10 environment.
While offline packages made on Ubuntu 22.04.3 is most likely to fail on Ubuntu 22.04.4.
(Yes the minor version here in <a href="https://wiki.ubuntu.com/Releases"><strong>Ubuntu</strong></a> is final <code>.3</code> rather than <code>.04</code>, and the major version is <code>22.04|jammy</code>)</p>
<p>If the OS minor version is not exactly matched, you can use a hybrid strategy to install, that is, after the <a href="/docs/setup/offline/#bootstrap"><strong>bootstrap</strong></a> process,
remove the <code>/www/pigsty/repo_complete</code> marker file, so that Pigsty will re-download the <strong>missing</strong> NODE packages and related dependencies during the installation process.
Which can effectively solve the dependency conflict problem when using offline packages, and don&rsquo;t lose the benefits of offline installation.</p>
<hr>
<h3 id="download-pre-made-package">Download Pre-made Package</h3>
<p>Pigsty does not offer pre-made offline packages for download starting from Pigsty v3.0.0.</p>
<p>It will use online installation by default, since it can download the exact NODE packages from the official repo to avoid dependency conflicts.
Besides, there are too much maintenance overhead to keep the offline packages for so many OS distros / major / minor version combinations.</p>
<p>BUT, we do offer pre-made offline packages for the following precise OS versions, which include Docker and pljava/jdbc_fw components, ready to use with a fair price.</p>
<ul>
<li>RockyLinux 8.9</li>
<li>RockyLinux 9.3</li>
<li>Ubuntu 22.04.3</li>
<li>Debian 12.4</li>
</ul>
<p>All the integration tests of Pigsty are based on the pre-made offline package snapshot before release,
Using these can effectively reduce the delivery risk caused by upstream dependency changes, save you the trouble and waiting time.
And show your support for the open-source cause, with a fair price of <strong>$99</strong>, please contact @Vonng (<a href="mailto:rh@vonng.com">rh@vonng.com</a>) to get the download link.</p>
<p>We use offline package to deliver our <strong>pro</strong> version, which is precisely matched to your specific OS distro major/minor version and has been tested after integration.</p>
<hr>
<h2 id="offline-package">Offline Package</h2>
<p>Therefore, Pigsty offers an offline installation feature, allowing you to complete the installation and deployment in an environment without internet access.</p>
<p>If you have internet access, downloading the pre-made <a href="/docs/setup/offline/#offline-package"><strong>Offline Package</strong></a> in advance can help speed up the installation process and enhance the certainty and reliability of the installation.</p>
<blockquote>
<p>Pigsty will no longer provide offline software packages for download starting from v3.0.0</p>
<p>You can make your own with the <code>bin/cache</code> script after the standard installation process.</p>
<p>Pigsty <a href="/docs/about/service/"><strong>Pro</strong></a> offers pre-made offline packages for various OS distros.</p>
</blockquote>
<hr>
<h2 id="bootstrap">Bootstrap</h2>
<p>Pigsty needs <code>ansible</code> to run the <a href="/docs/setup/playbook/"><strong>playbooks</strong></a>, so it is not suitable to install Ansible through playbooks.
The Bootstrap script is used to solve this problem: it will try its best to ensure that Ansible is installed on the node before the real installation.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./bootstrap       <span style="color:#8f5902;font-style:italic"># make suare ansible installed (if offline package available, setup &amp; use offline install)</span>
</span></span></code></pre></div><p>If you are <a href="/docs/setup/offline/#use-offline-pacakge"><strong>using offline package</strong></a>, the Bootstrap script will automatically recognize and process the offline package located at <code>/tmp/pkg.tgz</code>, and install Ansible from it if applicable.
Otherwise, if you have internet access, Bootstrap will automatically add the upstrema yum/apt repo of the corresponding OS/region and install Ansible from it.
If neither internet nor offline package is available, Bootstrap will leave it to the user to handle this issue, and the user needs to ensure that the repo configured on the node contains a usable Ansible.</p>
<p>There are some optional parameters for the Bootstrap script, you can use the <code>-p|--path</code> parameter to specify a different offline package location other than <code>/tmp/pkg.tgz</code>. or designate a region with the <code>-r|--region</code> parameter:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./boostrap
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">[</span>-r<span style="color:#000;font-weight:bold">|</span>--region &lt;region<span style="color:#ce5c00;font-weight:bold">]</span>   <span style="color:#ce5c00;font-weight:bold">[</span>default,china,europe<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">[</span>-p<span style="color:#000;font-weight:bold">|</span>--path &lt;path&gt;<span style="color:#ce5c00;font-weight:bold">]</span>      specify another offline pkg path
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">[</span>-k<span style="color:#000;font-weight:bold">|</span>--keep<span style="color:#ce5c00;font-weight:bold">]</span>             keep existing upstream repo during bootstrap
</span></span></code></pre></div><p>And bootstrap will automatically backup and remove the current repo (<code>/etc/yum.repos.d/backup</code> / <code>/etc/apt/source.list.d/backup</code>) of the node during the process to avoid software source conflicts. If this is not the behavior you expected, or you have already configured a local software repo, you can use the <code>-k|--keep</code> parameter to keep the existing software repo.</p>
<details><summary>Example: Use offline package (EL8)</summary><br>
<p>Bootstrap with offline package on a RockyLinux 8.9 node:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>vagrant@el8 pigsty<span style="color:#ce5c00;font-weight:bold">]</span>$ ls -alh /tmp/pkg.tgz
</span></span><span style="display:flex;"><span>-rw-r--r--. <span style="color:#0000cf;font-weight:bold">1</span> vagrant vagrant 1.4G Sep  <span style="color:#0000cf;font-weight:bold">1</span> 10:20 /tmp/pkg.tgz
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>vagrant@el8 pigsty<span style="color:#ce5c00;font-weight:bold">]</span>$ ./bootstrap
</span></span><span style="display:flex;"><span>bootstrap pigsty v3.1.0 begin
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">region</span> <span style="color:#ce5c00;font-weight:bold">=</span> china
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">kernel</span> <span style="color:#ce5c00;font-weight:bold">=</span> Linux
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">machine</span> <span style="color:#ce5c00;font-weight:bold">=</span> x86_64
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">package</span> <span style="color:#ce5c00;font-weight:bold">=</span> rpm,dnf
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">vendor</span> <span style="color:#ce5c00;font-weight:bold">=</span> rocky <span style="color:#ce5c00;font-weight:bold">(</span>Rocky Linux<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#ce5c00;font-weight:bold">(</span>8.9<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">sudo</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">ssh</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant@127.0.0.1 ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> /tmp/pkg.tgz exists
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">repo</span> <span style="color:#ce5c00;font-weight:bold">=</span> extract from /tmp/pkg.tgz
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> old <span style="color:#000">repos</span> <span style="color:#ce5c00;font-weight:bold">=</span> moved to /etc/yum.repos.d/backup
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> repo <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">=</span> use /etc/yum.repos.d/pigsty-local.repo
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> rpm <span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> updating, may take a <span style="color:#204a87;font-weight:bold">while</span>
</span></span><span style="display:flex;"><span>pigsty <span style="color:#204a87">local</span> <span style="color:#0000cf;font-weight:bold">8</span> - x86_64                                                                                                                               <span style="color:#0000cf;font-weight:bold">49</span> MB/s <span style="color:#000;font-weight:bold">|</span> 1.3 MB     00:00
</span></span><span style="display:flex;"><span>Metadata cache created.
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> repo <span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> created
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> install el8 utils
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>........ yum install output
</span></span><span style="display:flex;"><span>Installed:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  createrepo_c-0.17.7-6.el8.x86_64        createrepo_c-libs-0.17.7-6.el8.x86_64 drpm-0.4.1-3.el8.x86_64   modulemd-tools-0.7-8.el8.noarch python3-createrepo_c-0.17.7-6.el8.x86_64
</span></span><span style="display:flex;"><span>  python3-libmodulemd-2.13.0-1.el8.x86_64 python3-pyyaml-3.12-12.el8.x86_64     sshpass-1.09-4.el8.x86_64 unzip-6.0-46.el8.x86_64
</span></span><span style="display:flex;"><span>  ansible-9.2.0-1.el8.noarch                 ansible-core-2.16.3-2.el8.x86_64              git-core-2.43.5-1.el8_10.x86_64                 mpdecimal-2.5.1-3.el8.x86_64
</span></span><span style="display:flex;"><span>  python3-cffi-1.11.5-6.el8.x86_64           python3-cryptography-3.2.1-7.el8_9.x86_64     python3-jmespath-0.9.0-11.el8.noarch            python3-pycparser-2.14-14.el8.noarch
</span></span><span style="display:flex;"><span>  python3.12-3.12.3-2.el8_10.x86_64          python3.12-cffi-1.16.0-2.el8.x86_64           python3.12-cryptography-41.0.7-1.el8.x86_64     python3.12-jmespath-1.0.1-1.el8.noarch
</span></span><span style="display:flex;"><span>  python3.12-libs-3.12.3-2.el8_10.x86_64     python3.12-pip-wheel-23.2.1-4.el8.noarch      python3.12-ply-3.11-2.el8.noarch                python3.12-pycparser-2.20-2.el8.noarch
</span></span><span style="display:flex;"><span>  python3.12-pyyaml-6.0.1-2.el8.x86_64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Complete!
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">ansible</span> <span style="color:#ce5c00;font-weight:bold">=</span> ansible <span style="color:#ce5c00;font-weight:bold">[</span>core 2.16.3<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> boostrap pigsty <span style="color:#204a87">complete</span>
</span></span><span style="display:flex;"><span>proceed with ./configure
</span></span></code></pre></div></details><br>
<details><summary>Example: Bootstrap from Internet without offline Package (Debian 12)</summary><br>
<p>On a debian 12 node with internet access, Pigsty add the upstream repo and install <code>ansible</code> and its dependencies using apt:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@d12:~/pigsty$ ./bootstrap
</span></span><span style="display:flex;"><span>bootstrap pigsty v3.1.0 begin
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">region</span> <span style="color:#ce5c00;font-weight:bold">=</span> china
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">kernel</span> <span style="color:#ce5c00;font-weight:bold">=</span> Linux
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">machine</span> <span style="color:#ce5c00;font-weight:bold">=</span> x86_64
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">package</span> <span style="color:#ce5c00;font-weight:bold">=</span> deb,apt
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">vendor</span> <span style="color:#ce5c00;font-weight:bold">=</span> debian <span style="color:#ce5c00;font-weight:bold">(</span>Debian GNU/Linux<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">12</span> <span style="color:#ce5c00;font-weight:bold">(</span>12<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">sudo</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">ssh</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant@127.0.0.1 ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> old <span style="color:#000">repos</span> <span style="color:#ce5c00;font-weight:bold">=</span> moved to /etc/apt/backup
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> repo <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">=</span> add debian bookworm china upstream
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> apt <span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> updating, may take a <span style="color:#204a87;font-weight:bold">while</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>....... apt install output
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">ansible</span> <span style="color:#ce5c00;font-weight:bold">=</span> ansible <span style="color:#ce5c00;font-weight:bold">[</span>core 2.14.16<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> boostrap pigsty <span style="color:#204a87">complete</span>
</span></span><span style="display:flex;"><span>proceed with ./configure
</span></span></code></pre></div></details><br>
<details><summary>Example: Bootstrap from the Default (Ubuntu 20.04)</summary><br>
<p>One an Ubuntu 20.04 node without internet access &amp; offline package, Pigsty will assume you already have resolved this issue with your own way:
Such as a local software repo / mirror / CDROM / intranet repo, etc&hellip;</p>
<p>You can explicitly keep the current repo config with the <code>-k</code> parameter, or Pigsty will keep it by default if it detects no internet access and no offline package.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@ubuntu20:~/pigsty$ ./bootstrap -k
</span></span><span style="display:flex;"><span>bootstrap pigsty v3.1.0 begin
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">region</span> <span style="color:#ce5c00;font-weight:bold">=</span> china
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">kernel</span> <span style="color:#ce5c00;font-weight:bold">=</span> Linux
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">machine</span> <span style="color:#ce5c00;font-weight:bold">=</span> x86_64
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">package</span> <span style="color:#ce5c00;font-weight:bold">=</span> deb,apt
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">vendor</span> <span style="color:#ce5c00;font-weight:bold">=</span> ubuntu <span style="color:#ce5c00;font-weight:bold">(</span>Ubuntu<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">20</span> <span style="color:#ce5c00;font-weight:bold">(</span>20.04<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">sudo</span> <span style="color:#ce5c00;font-weight:bold">=</span> vagrant ok
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> ubuntu <span style="color:#0000cf;font-weight:bold">20</span> focal does not have corresponding offline package, use online install
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> missing and skip download
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">repo</span> <span style="color:#ce5c00;font-weight:bold">=</span> skip <span style="color:#ce5c00;font-weight:bold">(</span>/tmp/pkg.tgz not exists<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> repo <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">=</span> add ubuntu focal china upstream
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span> apt <span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> updating, make take a <span style="color:#204a87;font-weight:bold">while</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...<span style="color:#ce5c00;font-weight:bold">(</span>apt update/install output<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">ansible</span> <span style="color:#ce5c00;font-weight:bold">=</span> ansible 2.10.8
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> boostrap pigsty <span style="color:#204a87">complete</span>
</span></span><span style="display:flex;"><span>proceed with ./configure
</span></span></code></pre></div></details><br>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c38b3e7bce8cb65ffd26ccafa496eb5e">3 - Slim Installation</h1>
    <div class="lead">How to perform slim install with HA PostgreSQL related components only</div>
	<p>Pigsty has an entire infrastructure stack as an enclosure of HA PostgreSQL clusters, BUT it is viable to install only the PostgreSQL components without the rest of the stack. This is called a slim installation.</p>
<hr>
<h2 id="overview">Overview</h2>
<p>The minimal installation focus on Pure HA-PostgreSQL Cluster, and it only installs essential components for this purpose.</p>
<p>There&rsquo;s NO <a href="/docs/infra/"><strong><code>Infra</code></strong></a> modules, No monitoring, No <a href="/docs/setup/offline/#build-local-repo"><strong>local repo</strong></a> Just partial of NODE module, along with ETCD &amp; PGSQL modules</p>
<p>Systemd Service Installed in this mode:</p>
<ul>
<li>patroni: <strong>REQUIRED</strong>, bootstrap HA PostgreSQL cluster</li>
<li>etcd: <strong>REQUIRED</strong>, DCS for patroni</li>
<li>pgbouncer: <strong>OPTIONAL</strong>, connection pooler for postgres</li>
<li>vip-manager: <strong>OPTIONAL</strong>, if you want to use a L2 VIP bind to primary</li>
<li>haproxy: <strong>OPTIONAL</strong>, if you wish to auto-routing <a href="/docs/concept/svc/"><strong>service</strong></a></li>
<li>chronyd: <strong>OPTIONAL</strong>, if you wish to sync time with NTP server</li>
<li>tuned: <strong>OPTIONAL</strong>, manage node template and kernel parameters</li>
</ul>
<p>You can turn off the optional components, the only two essential components are <code>patroni</code> and <code>etcd</code>.</p>
<hr>
<h2 id="configure">Configure</h2>
<p>To perform a minimal installation, you need to disable some switches in the <code>pigsty.yml</code> config file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">all</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">children</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># actually not used</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">infra</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">infra_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># etcd cluster for ha postgres, still required in minimal installation</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_seq: 1 } }, vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">etcd_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># postgres cluster &#39;pg-meta&#39; with 2 instances</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [ pigsty ] ,extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vector }] } ]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_meta ,password: DBUser.Meta   ,pgbouncer: true ,roles: [ dbrole_admin ]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_view ,password: DBUser.Viewer ,pgbouncer: true ,roles: [ dbrole_readonly ] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">read-only viewer for meta database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">node_crontab</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># make a full backup every 1am</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#8f5902;font-style:italic"># global parameters</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v3.1.0                  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pigsty version string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">admin_ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># admin node ip address</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">region: default                   # upstream mirror region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default,china,europe</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">node_tune: oltp                   # node tuning specs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">oltp,olap,tiny,crit</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_conf: oltp.yml                 # pgsql tuning specs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#000">oltp,olap,tiny,crit}.yml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># slim installation setup</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">nginx_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic"># nginx not exists</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">dns_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># dnsmasq not exists</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">prometheus_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># prometheus not exists</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">grafana_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># grafana not exists</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_exporter_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># disable pg_exporter</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pgbouncer_exporter_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_vip_enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#----------------------------------#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Repo, Node, Packages</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#----------------------------------#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">node_repo_modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node,infra,pgsql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># use node_repo_modules instead of repo_modules</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">node_repo_remove</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># remove existing node repo for node managed by pigsty?</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">repo_packages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># default packages to be downloaded (if `repo_packages` is not explicitly set)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">node-bootstrap, infra-package, infra-addons, node-package1, node-package2, pgsql-common</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#,docker</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">repo_extra_packages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># default postgres packages to be downloaded</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">pgsql-main</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#,pgsql-core,pgsql-time,pgsql-gis,pgsql-rag,pgsql-fts,pgsql-olap,pgsql-feat,pgsql-lang,pgsql-type,pgsql-func,pgsql-admin,pgsql-stat,pgsql-sec,pgsql-fdw,pgsql-sim,pgsql-etl,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#,pg17-core,pg17-time,pg17-gis,pg17-rag,pg17-fts,pg17-olap,pg17-feat,pg17-lang,pg17-type,pg17-func,pg17-admin,pg17-stat,pg17-sec,pg17-fdw,pg17-sim,pg17-etl,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#,pg16-core,pg16-time,pg16-gis,pg16-rag,pg16-fts,pg16-olap,pg16-feat,pg16-lang,pg16-type,pg16-func,pg16-admin,pg16-stat,pg16-sec,pg16-fdw,pg16-sim,pg16-etl,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>And use the <a href="https://github.com/Vonng/pigsty/blob/main/slim.yml"><code>slim.yml</code></a> instead of the <a href="https://github.com/Vonng/pigsty/blob/main/install.yml"><code>install.yml</code></a> playbook:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./slim.yml
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d96b1765e9d967725a0824edd07fe95d">4 - Configuration</h1>
    <div class="lead">Describe database and infrastructure as code using declarative Configuration</div>
	<p><strong>Pigsty treats Infra &amp; Database as Code.</strong> You can describe the infrastructure &amp; database clusters through a declarative interface. All your essential work is to describe your need in the <a href="/docs/setup/config/#inventory">inventory</a>, then materialize it with a simple idempotent playbook.</p>
<hr>
<h2 id="inventory">Inventory</h2>
<p>Each pigsty deployment has a corresponding config <strong>inventory</strong>. It could be stored in a local git-managed file in <a href="https://docs.ansible.com/ansible/2.9/user_guide/playbooks_variables.html">YAML</a> format or dynamically generated from <a href="https://docs.ansible.com/ansible/2.9/user_guide/intro_dynamic_inventory.html">CMDB</a> or any ansible compatible format. Pigsty uses a monolith YAML config file as the default config inventory, which is <a href="https://github.com/Vonng/pigsty/blob/main/pigsty.yml"><code>pigsty.yml</code></a>,  <a href="https://github.com/Vonng/pigsty/blob/main/ansible.cfg#L3">located</a> in the pigsty home directory.</p>
<p>The inventory consists of two parts: <strong>global vars</strong> &amp; multiple <strong>group definitions</strong>. You can define new clusters with inventory groups: <code>all.children</code>. And describe infra and set global default parameters for clusters with global vars: <code>all.vars</code>. Which may look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">all:                  # Top-level object</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">all</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#000">...}        </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Global Parameters</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">children</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># Group Definitions</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">infra:            # Group Definition</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;infra&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">...}        # Group Membership</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;infra&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span>{<span style="color:#204a87;font-weight:bold">...}        # Group Parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;infra&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">    </span>{<span style="color:#204a87;font-weight:bold">...}    # Group Definition</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;etcd&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">...}    # Group Definition</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pg-meta&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">...}    # Group Definition</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pg-test&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">redis-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">...} # Group Definition</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;redis-test&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># ...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>There are lots of config examples under <a href="https://github.com/Vonng/pigsty/blob/main/conf/README.md"><code>conf/</code></a></p>
<hr>
<h2 id="cluster">Cluster</h2>
<p>Each group may represent a cluster, which could be a Node cluster, PostgreSQL cluster, Redis cluster, Etcd cluster, or Minio cluster, etc&hellip; They all use the same format: <strong>group vars</strong> &amp; <strong>hosts</strong>. You can define cluster members with <code>all.children.&lt;cls&gt;.hosts</code> and describe cluster with cluster parameters in <code>all.children.&lt;cls&gt;.vars</code>. Here is an example of 3 nodes PostgreSQL HA cluster named <code>pg-test</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># Group Name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Group Vars (Cluster Parameters)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># Group Host (Cluster Membership)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Host1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Host2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 3, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">offline }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Host3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You can also define parameters for a specific host, as known as <strong>host vars</strong>. It will override group vars and global vars. Which is usually used for assigning identities to nodes &amp; database instances.</p>
<hr>
<h2 id="parameter">Parameter</h2>
<p>Global vars, Group vars, and Host vars are dict objects consisting of a series of K-V pairs. Each pair is a named <strong>Parameter</strong> consisting of a string name as the key and a value of one of five types:  boolean, string, number, array, or object. Check parameter reference for detailed syntax &amp; semantics.</p>
<p>Every parameter has a proper default value except for mandatory <strong>IDENTITY PARAMETERS</strong>; they are used as identifiers and must be set explicitly, such as <a href="/docs/reference/param/#pg_cluster"><code>pg_cluster</code></a>, <a href="/docs/reference/param/#pg_role"><code>pg_role</code></a>, and <a href="/docs/reference/param/#pg_seq"><code>pg_seq</code></a>.</p>
<p>Parameters can be specified &amp; overridden with the following precedence.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Playbook Args  &gt;  Host Vars  &gt;  Group Vars  &gt;  Global Vars  &gt;  Defaults
</span></span></code></pre></div><p>For examples:</p>
<ul>
<li>Force removing existing databases with Playbook CLI Args <code>-e pg_clean=true</code></li>
<li>Override an instance role with Instance Level Parameter <code>pg_role</code> on Host Vars</li>
<li>Override a cluster name with Cluster Level Parameter <code>pg_cluster</code> on Group Vars.</li>
<li>Specify global NTP servers with Global Parameter <code>node_ntp_servers</code> on Global Vars</li>
<li>If no <code>pg_version</code> is set, it will use the default value from role implementation (16 by default)</li>
</ul>
<hr>
<h2 id="template">Template</h2>
<p>There are numerous preset config templates for different scenarios under the <a href="https://github.com/Vonng/pigsty/blob/main/conf"><code>conf/</code></a> directory.</p>
<p>During <a href="/docs/setup/install/#configure"><code>configure</code></a>  process, you can specify a template using the -c parameter.
Otherwise, the single-node installation config template will be automatically selected based on your OS distribution.</p>
<p>Details about this built-in configuration files can be found @ <a href="/docs/conf/"><strong>Configuration</strong></a></p>
<hr>
<h2 id="switch-config-inventory">Switch Config Inventory</h2>
<p>To use a different config inventory, you can copy &amp; paste the content into the <code>pigsty.yml</code> file in the home dir as needed.</p>
<p>You can also explicitly specify the config inventory file to use when executing Ansible playbooks by using the <code>-i</code> command-line parameter, for example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./node.yml -i files/pigsty/rpmbuild.yml    <span style="color:#8f5902;font-style:italic"># use another file as config inventory, rather than the default pigsty.yml</span>
</span></span></code></pre></div><p>If you want to modify the <strong>default</strong> config inventory filename, you can change the <code>inventory</code> parameter in the <a href="https://github.com/Vonng/pigsty/blob/main/ansible.cfg#L6"><code>ansible.cfg</code></a> file in the home dir to point to your own inventory file path.
This allows you to run the <code>ansible-playbook</code> command without explicitly specifying the <code>-i</code> parameter.</p>
<p>Pigsty allows you to use a database (CMDB) as a dynamic configuration source instead of a static configuration file. Pigsty provides three convenient scripts:</p>
<ul>
<li><a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_load"><code>bin/inventory_load</code></a>: Loads the content of the <code>pigsty.yml</code> into the local PostgreSQL database (<code>meta</code>.<code>pigsty</code>)</li>
<li><a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_cmdb"><code>bin/inventory_cmdb</code></a>: Switches the configuration source to the local PostgreSQL database (<code>meta</code>.<code>pigsty</code>)</li>
<li><a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_cmdb"><code>bin/inventory_conf</code></a>: Switches the configuration source to the local static configuration file <code>pigsty.yml</code></li>
</ul>
<hr>
<h2 id="reference">Reference</h2>
<p>Pigsty have 280+ parameters, check <a href="/docs/reference/param/">Parameter</a> for details.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Module</th>
<th>Section</th>
<th>Description</th>
<th>Count</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#infra"><code>INFRA</code></a></td>
<td><a href="/docs/reference/param/#meta"><code>META</code></a></td>
<td>Pigsty Metadata</td>
<td>4</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#infra"><code>INFRA</code></a></td>
<td><a href="/docs/reference/param/#ca"><code>CA</code></a></td>
<td>Self-Signed CA</td>
<td>3</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#infra"><code>INFRA</code></a></td>
<td><a href="/docs/reference/param/#infra_id"><code>INFRA_ID</code></a></td>
<td>Infra Portals &amp; Identity</td>
<td>2</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#infra"><code>INFRA</code></a></td>
<td><a href="/docs/reference/param/#repo"><code>REPO</code></a></td>
<td>Local Software Repo</td>
<td>9</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#infra"><code>INFRA</code></a></td>
<td><a href="/docs/reference/param/#infra_package"><code>INFRA_PACKAGE</code></a></td>
<td>Infra Packages</td>
<td>2</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#infra"><code>INFRA</code></a></td>
<td><a href="/docs/reference/param/#nginx"><code>NGINX</code></a></td>
<td>Nginx Web Server</td>
<td>7</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#infra"><code>INFRA</code></a></td>
<td><a href="/docs/reference/param/#dns"><code>DNS</code></a></td>
<td>DNSMASQ Nameserver</td>
<td>3</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#infra"><code>INFRA</code></a></td>
<td><a href="/docs/reference/param/#prometheus"><code>PROMETHEUS</code></a></td>
<td>Prometheus Stack</td>
<td>18</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#infra"><code>INFRA</code></a></td>
<td><a href="/docs/reference/param/#grafana"><code>GRAFANA</code></a></td>
<td>Grafana Stack</td>
<td>6</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#infra"><code>INFRA</code></a></td>
<td><a href="/docs/reference/param/#loki"><code>LOKI</code></a></td>
<td>Loki Logging Service</td>
<td>4</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#node"><code>NODE</code></a></td>
<td><a href="/docs/reference/param/#node_id"><code>NODE_ID</code></a></td>
<td>Node Identity Parameters</td>
<td>5</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#node"><code>NODE</code></a></td>
<td><a href="/docs/reference/param/#node_dns"><code>NODE_DNS</code></a></td>
<td>Node domain names &amp; resolver</td>
<td>6</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#node"><code>NODE</code></a></td>
<td><a href="/docs/reference/param/#node_package"><code>NODE_PACKAGE</code></a></td>
<td>Node Repo &amp; Packages</td>
<td>5</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#node"><code>NODE</code></a></td>
<td><a href="/docs/reference/param/#node_tune"><code>NODE_TUNE</code></a></td>
<td>Node Tuning &amp; Kernel features</td>
<td>10</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#node"><code>NODE</code></a></td>
<td><a href="/docs/reference/param/#node_admin"><code>NODE_ADMIN</code></a></td>
<td>Admin User &amp; Credentials</td>
<td>7</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#node"><code>NODE</code></a></td>
<td><a href="/docs/reference/param/#node_time"><code>NODE_TIME</code></a></td>
<td>Node Timezone, NTP, Crontabs</td>
<td>5</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#node"><code>NODE</code></a></td>
<td><a href="/docs/reference/param/#node_vip"><code>NODE_VIP</code></a></td>
<td>Node Keepalived L2 VIP</td>
<td>8</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#node"><code>NODE</code></a></td>
<td><a href="/docs/reference/param/#haproxy"><code>HAPROXY</code></a></td>
<td>HAProxy the load balancer</td>
<td>10</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#node"><code>NODE</code></a></td>
<td><a href="/docs/reference/param/#node_exporter"><code>NODE_EXPORTER</code></a></td>
<td>Node Monitoring Agent</td>
<td>3</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#node"><code>NODE</code></a></td>
<td><a href="/docs/reference/param/#promtail"><code>PROMTAIL</code></a></td>
<td>Promtail logging Agent</td>
<td>4</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#docker"><code>DOCKER</code></a></td>
<td><a href="/docs/reference/param/#docker"><code>DOCKER</code></a></td>
<td>Docker Daemon</td>
<td>4</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#etcd"><code>ETCD</code></a></td>
<td><a href="/docs/reference/param/#etcd"><code>ETCD</code></a></td>
<td>ETCD DCS Cluster</td>
<td>10</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#minio"><code>MINIO</code></a></td>
<td><a href="/docs/reference/param/#minio"><code>MINIO</code></a></td>
<td>MINIO S3 Object Storage</td>
<td>15</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#redis"><code>REDIS</code></a></td>
<td><a href="/docs/reference/param/#redis"><code>REDIS</code></a></td>
<td>Redis the key-value NoSQL cache</td>
<td>20</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#pgsql"><code>PGSQL</code></a></td>
<td><a href="/docs/reference/param/#pg_id"><code>PG_ID</code></a></td>
<td>PG Identity Parameters</td>
<td>11</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#pgsql"><code>PGSQL</code></a></td>
<td><a href="/docs/reference/param/#pg_business"><code>PG_BUSINESS</code></a></td>
<td>PG Business Object Definition</td>
<td>12</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#pgsql"><code>PGSQL</code></a></td>
<td><a href="/docs/reference/param/#pg_install"><code>PG_INSTALL</code></a></td>
<td>Install PG Packages &amp; Extensions</td>
<td>10</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#pgsql"><code>PGSQL</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td>Init HA PG Cluster with Patroni</td>
<td>39</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#pgsql"><code>PGSQL</code></a></td>
<td><a href="/docs/reference/param/#pg_provision"><code>PG_PROVISION</code></a></td>
<td>Create in-database objects</td>
<td>9</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#pgsql"><code>PGSQL</code></a></td>
<td><a href="/docs/reference/param/#pg_backup"><code>PG_BACKUP</code></a></td>
<td>Set Backup Repo with pgBackRest</td>
<td>5</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#pgsql"><code>PGSQL</code></a></td>
<td><a href="/docs/reference/param/#pg_service"><code>PG_SERVICE</code></a></td>
<td>Exposing service, bind vip, dns</td>
<td>9</td>
</tr>
<tr>
<td style="text-align:center"><a href="/docs/reference/param/#pgsql"><code>PGSQL</code></a></td>
<td><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td>PG Monitor agent for Prometheus</td>
<td>15</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-24263fa625b63eabb5c32f29ec96c5f7">5 - Preparation</h1>
    <div class="lead">How to prepare the nodes, network, OS distros, admin user, ports, and permissions for Pigsty.</div>
	<hr>
<h2 id="node">Node</h2>
<p>Pigsty supports the <code>Linux</code> kernel and <code>x86_64/aarch64</code> arch, applicable to any node.</p>
<p>A &ldquo;node&rdquo; refers to a resource that is SSH accessible and offers a bare OS environment, such as a physical machine, a virtual machine, or an OS container equipped with <code>systemd</code> and <code>sshd</code>.</p>
<p>Deploying Pigsty requires at least 1 node. The minimum spec requirement is <code>1C1G</code>, but it is recommended to use at least <code>2C4G</code>, with no upper limit: parameters will automatically optimize and adapt.</p>
<p>For demos, personal sites, devbox, or standalone monitoring infra, <strong>1-2</strong> nodes are recommended, while at least 3 nodes are suggested for an HA PostgreSQL cluster. For critical scenarios, <strong>4-5</strong> nodes are advisable.</p>


<div class="alert alert-success" role="alert">
<h4 class="alert-heading">Leverage IaC Tools for chores</h4>

    <p>Managing a large-scale prod env could be tedious and error-prone. We recommend using Infrastructure as Code (IaC) tools to address these issues.</p>
<p>You can use the <a href="/docs/setup/provision/#terraform"><strong>Terraform</strong></a> and <a href="/docs/setup/provision/#vagrant"><strong>Vagrant</strong></a> templates provided by Pigsty,
to create the required node environment with just one command through IaC, provisioning network, OS image, admin user, privileges, etc&hellip;</p>


</div>

<hr>
<h2 id="network">Network</h2>
<p>Pigsty requires nodes to use <strong>static IPv4 addresses</strong>, which means you should explicitly assign your nodes a specific fixed IP address rather than using DHCP-assigned addresses.</p>
<p>The IP address used by a node should be the primary IP address for internal network communications and will serve as the node&rsquo;s unique identifier.</p>
<p>If you wish to use the optional Node VIP and PG VIP features, ensure all nodes are located within an L2 network.</p>
<p>Your firewall policy should ensure the required ports are open between nodes. For a detailed list of ports required by different modules, refer to <a href="/docs/node/"><strong>Node: Ports</strong></a>.</p>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Which Ports Should Be Exposed?</h4>

    <p>For beginners or those who are just trying it out, you can just open ports <code>5432</code> (PostgreSQL database) and <code>3000</code> (Grafana visualization interface) to the world.</p>
<p>For a serious prod env, you should only expose the necessary ports to the exterior, such as <code>80/443</code> for web services, open to the office network (or the entire Internet).</p>
<p>Exposing database service ports directly to the Internet is not advisable. If you need to do this, consider consulting <a href="/docs/setup/security/">Security Best Practices</a> and proceed cautiously.</p>
<p>The method for exposing ports depends on your network implementation, such as security group policies, local iptables records, firewall configurations, etc.</p>


</div>

<hr>
<h2 id="operating-system">Operating System</h2>
<p>Pigsty supports various Linux OS. We recommend using <strong>RockyLinux 9.4</strong> or <strong>Ubuntu 22.04.5</strong> as the default OS for installing Pigsty.</p>
<p>Pigsty supports RHEL (7,8,9), Debian (11,12), Ubuntu (20,22,24), and many other compatible OS distros. Check <a href="/docs/reference/compatibility/"><strong>Compatibility</strong></a> For a complete list of compatible OS distros.</p>
<p>When deploying on multiple nodes, we <strong>strongly recommend</strong> using the <strong>same version</strong> of the OS distro and the Linux kernel on all nodes.</p>
<p>We <strong>strongly recommend</strong> using a clean, minimally installed OS environment with <code>en_US</code> set as the primary language.</p>


<div class="alert alert-success" role="alert">
<h4 class="alert-heading">How to enable en_US locale?</h4>

    <p>To ensure the <code>en_US</code> locale is available when using other primary language:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y glibc-locale-source glibc-langpack-en
</span></span><span style="display:flex;"><span>localedef -i en_US -f UTF-8 en_US.UTF-8
</span></span><span style="display:flex;"><span>localectl set-locale <span style="color:#000">LANG</span><span style="color:#ce5c00;font-weight:bold">=</span>en_US.UTF-8
</span></span></code></pre></div><p>Note: The PostgreSQL cluster deployed by Pigsty defaults to the <code>C.UTF8</code> locale, but character set definitions use <code>en_US</code> to ensure the <code>pg_trgm</code> extension functions properly.
If you do not need this feature, you can configure the value of <a href="/docs/reference/param/#pg_lc_ctype"><strong><code>pg_lc_ctype</code></strong></a> to <code>C.UTF8</code> to avoid this issue when en locale is missing.</p>


</div>

<hr>
<h2 id="admin-user">Admin User</h2>
<p>You&rsquo;ll need an &ldquo;<strong>admin user</strong>&rdquo; on all nodes where Pigsty is meant to be deployed — an OS user with nopass <code>ssh</code> login and nopass <code>sudo</code> permissions.</p>
<p>On the nodes where Pigsty is installed, you need an &ldquo;<strong>administrative user</strong>&rdquo; who has nopass <code>ssh</code> login and nopass <code>sudo</code> permissions.</p>
<p>No password <code>sudo</code> is required to execute commands during the installation process, such as installing packages, configuring system settings, etc.</p>


<div class="alert alert-success" role="alert">
<h4 class="alert-heading">How to configure nopass sudo for admin user?</h4>

    <p>Assuming your admin username is <code>vagrant</code>, you can create a file in <code>/etc/sudoers.d/vagrant</code> and add the following content:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>%vagrant <span style="color:#000">ALL</span><span style="color:#ce5c00;font-weight:bold">=(</span>ALL<span style="color:#ce5c00;font-weight:bold">)</span> NOPASSWD: ALL
</span></span></code></pre></div><p>This will allow the <code>vagrant</code> user to execute all commands without a sudo password. If your username is not <code>vagrant</code>, replace <code>vagrant</code> in the above steps with your username.</p>


</div>



<div class="alert alert-danger" role="alert">
<h4 class="alert-heading">Avoid using the root user</h4>

    <p>While it is possible to install Pigsty using the <code>root</code> user, we do not recommend it.</p>
<p>We recommend using a dedicated admin user, such as <code>dba</code>, different from the root user (<code>root</code>) and the database superuser (<code>postgres</code>).</p>
<p>There is a dedicated playbook subtask that can use an existing admin user (e.g., <code>root</code>) with ssh/sudo password input to <a href="/docs/node/#create-admin">create</a> a dedicated admin user.</p>


</div>

<hr>
<h2 id="ssh-permission">SSH Permission</h2>
<p>In addition to nopass <code>sudo</code> privilege, Pigsty also requires the admin user to have nopass <code>ssh</code> login privilege (login via ssh key).</p>
<p>For <a href="/docs/concept/arch/#singleton-meta">single-host installations</a> setup, this means the admin user on the local node should be able to log in to the host itself via ssh without a password.</p>
<p>If your Pigsty deployment involves multiple nodes, this means the admin user on the <a href="/docs/node/#admin-node">admin node</a> should be able to log in to all nodes managed by Pigsty (including the local node) via ssh without a password, and execute <code>sudo</code> commands without a password as well.</p>
<p>During the <a href="/docs/setup/install/#configuration"><strong><code>configure</code></strong></a> procedure, if your current admin user does not have any SSH key, it will attempt to address this issue by generating a new <code>id_rsa</code> key pair and adding it to the local <code>~/.ssh/authorized_keys</code> file to ensure local SSH login capability for the local admin user.</p>
<p>By default, Pigsty creates an admin user <code>dba</code> (<code>uid=88</code>) on all managed nodes. If you are already using this user, we recommend that you change the <a href="/docs/reference/param/#node_admin_username"><code>node_admin_username</code></a> to a new username with a different uid, or disable it using the <a href="/docs/reference/param/#node_admin_enabled"><code>node_admin_enabled</code></a> parameter.</p>


<div class="alert alert-success" role="alert">
<h4 class="alert-heading">How to configure nopass SSH login for admin user?</h4>

    <p>Assuming your admin username is <code>vagrant</code>, execute the following command as the <code>vagrant</code> user will generate a public/private key pair for login. If a key pair already exists, there is no need to generate a new one.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh-keygen -t rsa -b <span style="color:#0000cf;font-weight:bold">2048</span> -N <span style="color:#4e9a06">&#39;&#39;</span> -f ~/.ssh/id_rsa -q
</span></span></code></pre></div><p>The generated public key is by default located at: <code>/home/vagrant/.ssh/id_rsa.pub</code>, and the private key at: <code>/home/vagrant/.ssh/id_rsa</code>. If your OS username is not <code>vagrant</code>, replace <code>vagrant</code> in the above commands with your username.</p>
<p>You should append the public key file (<code>id_rsa.pub</code>) to the <code>authorized_keys</code> file of the user you need to log into: <code>/home/vagrant/.ssh/authorized_keys</code>. If you already have password access to the remote machine, you can use <code>ssh-copy-id</code> to copy the public key:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh-copy-id &lt;ip&gt;                        <span style="color:#8f5902;font-style:italic"># Enter password to complete public key copying</span>
</span></span><span style="display:flex;"><span>sshpass -p &lt;password&gt; ssh-copy-id &lt;ip&gt;  <span style="color:#8f5902;font-style:italic"># Or: you can embed the password directly in the command to avoid interactive password entry (cautious!)</span>
</span></span></code></pre></div><p>Pigsty recommends provisioning the admin user during node provisioning and making it viable by default.</p>


</div>

<hr>
<h2 id="ssh-accessibility">SSH Accessibility</h2>
<p>If your environment has some restrictions on SSH access, such as a bastion server or ad hoc firewall rules that prevent simple SSH access via <code>ssh &lt;ip&gt;</code>, consider using SSH aliases.</p>
<p>For example, if there&rsquo;s a node with IP <code>10.10.10.10</code> that can not be accessed directly via ssh but can be accessed via an ssh alias <code>meta</code> defined in <code>~/.ssh/config</code>,
then you can configure the <code>ansible_host</code> parameter for that node in the <a href="/docs/setup/config/#inventory"><strong>inventory</strong></a> to specify the SSH Alias on the host level:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">nodes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 10.10.10.10 can not be accessed directly via ssh, but can be accessed via ssh alias &#39;meta&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ansible_host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>If the ssh alias does not meet your requirement, there are a plethora of custom <a href="https://docs.ansible.com/archive/ansible/2.4/intro_inventory.html#list-of-behavioral-inventory-parameters"><strong>ssh connection parameters</strong></a> that can bring fine-grained control over SSH connection behavior.</p>
<p>If the following cmd can be successfully executed on the admin node by the admin user, it means that the target node&rsquo;s admin user is properly configured.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh &lt;ip<span style="color:#000;font-weight:bold">|</span>alias&gt; <span style="color:#4e9a06">&#39;sudo ls&#39;</span>
</span></span></code></pre></div><hr>
<h2 id="software">Software</h2>
<p>On the <a href="/docs/node/#admin-node"><strong>admin node</strong></a>, Pigsty requires <a href="/docs/setup/playbook/#ansible"><strong><code>ansible</code></strong></a> to initiate control.
If you are using the singleton meta installation, Ansible is required on this node. It is not required for common nodes.</p>
<p>The <a href="/docs/setup/offline/#bootstrap"><strong><code>bootstrap</code></strong></a> procedure will make every effort to do this for you.
But you can always choose to install Ansible manually. The process of manually installing Ansible varies with different OS distros / major versions (usually involving an additional weak dependency <code>jmespath</code>):</p>






<ul class="nav nav-tabs" id="tabs-6" role="tablist">
  <li class="nav-item">
      <button class="nav-link disabled"
          id="tabs-06-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-06-00" role="tab"
          aria-controls="tabs-06-00" aria-selected="false">
        Install Ansible
      </button>
    </li><li class="nav-item">
      <button class="nav-link active"
          id="tabs-06-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-06-01" role="tab"
          aria-controls="tabs-06-01" aria-selected="true">
        EL 8 / 9
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-06-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-06-02" role="tab"
          aria-controls="tabs-06-02" aria-selected="false">
        EL 7
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-06-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-06-03" role="tab"
          aria-controls="tabs-06-03" aria-selected="false">
        Debian / Ubuntu
      </button>
    </li><li class="nav-item">
      <button class="nav-link"
          id="tabs-06-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-06-04" role="tab"
          aria-controls="tabs-06-04" aria-selected="false">
        MacOS
      </button>
    </li>
</ul>

<div class="tab-content" id="tabs-6-content">
    <div class="tab-pane fade"
        id="tabs-06-00" role="tabpanel" aria-labelled-by="tabs-06-00-tab" tabindex="6">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"></code></pre></div>
    </div>
    <div class="tab-pane fade show active"
        id="tabs-06-01" role="tabpanel" aria-labelled-by="tabs-06-01-tab" tabindex="6">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>sudo dnf install -y ansible python3.12-jmespath</span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-06-02" role="tabpanel" aria-labelled-by="tabs-06-02-tab" tabindex="6">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>sudo yum install -y ansible   <span style="color:#8f5902;font-style:italic"># EL7 does not need to install jmespath explicitly</span></span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-06-03" role="tabpanel" aria-labelled-by="tabs-06-03-tab" tabindex="6">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>sudo apt install -y ansible python3-jmespath</span></span></code></pre></div>
    </div>
    <div class="tab-pane fade"
        id="tabs-06-04" role="tabpanel" aria-labelled-by="tabs-06-04-tab" tabindex="6">
        <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>brew install ansible</span></span></code></pre></div>
    </div>
</div>

<p>To install Pigsty, you also need to prepare the Pigsty source package. You can directly download a specific version from the <a href="https://github.com/Vonng/pigsty/releases/">GitHub Release</a> page or use the following command to obtain the latest stable version:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -fsSL https://repo.pigsty.io/get <span style="color:#000;font-weight:bold">|</span> bash
</span></span></code></pre></div><p>If your env does not have Internet access, consider using the <a href="/docs/setup/offline/#offline-packages"><strong>offline packages</strong></a>, which are pre-packed for different OS distros, and can be downloaded from the GitHub Release page.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-98758ad7ef56ab0b1a9ad8320b14506b">6 - Playbooks</h1>
    <div class="lead">Pigsty implement module controller with ansible idempotent playbooks, here are some necessary info you need to learn about it.</div>
	<p>Playbooks are used in Pigsty to install <a href="/docs/concept/arch/#modules">modules</a> on nodes.</p>
<p>To run playbooks, just treat them as executables. e.g. run with <code>./install.yml</code>.</p>
<hr>
<h2 id="playbooks">Playbooks</h2>
<p>Here are default playbooks included in Pigsty.</p>
<table>
<thead>
<tr>
<th>Playbook</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/install.yml"><code>install.yml</code></a></td>
<td>Install Pigsty on current node in one-pass</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/infra.yml"><code>infra.yml</code></a></td>
<td>Init pigsty infrastructure on infra nodes</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/infra-rm.yml"><code>infra-rm.yml</code></a></td>
<td>Remove infrastructure components from infra nodes</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/node.yml"><code>node.yml</code></a></td>
<td>Init node for pigsty, tune node into desired status</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/node-rm.yml"><code>node-rm.yml</code></a></td>
<td>Remove node from pigsty</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/pgsql.yml"><code>pgsql.yml</code></a></td>
<td>Init HA PostgreSQL clusters, or adding new replicas</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/pgsql-rm.yml"><code>pgsql-rm.yml</code></a></td>
<td>Remove PostgreSQL cluster, or remove replicas</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/pgsql-user.yml"><code>pgsql-user.yml</code></a></td>
<td>Add new business user to existing PostgreSQL cluster</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/pgsql-db.yml"><code>pgsql-db.yml</code></a></td>
<td>Add new business database to existing PostgreSQL cluster</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/pgsql-monitor.yml"><code>pgsql-monitor.yml</code></a></td>
<td>Monitor remote postgres instance with local exporters</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/pgsql-migration.yml"><code>pgsql-migration.yml</code></a></td>
<td>Generate Migration manual &amp; scripts for existing PostgreSQL</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/redis.yml"><code>redis.yml</code></a></td>
<td>Init redis cluster/node/instance</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/redis-rm.yml"><code>redis-rm.yml</code></a></td>
<td>Remove redis cluster/node/instance</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/etcd.yml"><code>etcd.yml</code></a></td>
<td>Init etcd cluster (required for patroni HA DCS)</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/minio.yml"><code>minio.yml</code></a></td>
<td>Init minio cluster (optional for pgbackrest repo)</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/docker.yml"><code>docker.yml</code></a></td>
<td>Install docker on nodes</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/mongo.yml"><code>mongo.yml</code></a></td>
<td>Install Mongo/FerretDB on nodes</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/cert.yml"><code>cert.yml</code></a></td>
<td>Issue cert with pigsty self-signed CA (e.g. for pg clients)</td>
</tr>
<tr>
<td><a href="https://github.com/Vonng/pigsty/blob/main/cache.yml"><code>cache.yml</code></a></td>
<td>Make offline install packages from target node</td>
</tr>
</tbody>
</table>
<p><strong>One-Pass Install</strong></p>
<p>The special playbook <code>install.yml</code> is actually a composed playbook that install everything on current environment.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  playbook  / <span style="color:#204a87">command</span> / group         infra           nodes    etcd     minio     pgsql
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>infra.yml<span style="color:#ce5c00;font-weight:bold">]</span> ./infra.yml <span style="color:#ce5c00;font-weight:bold">[</span>-l infra<span style="color:#ce5c00;font-weight:bold">]</span>   <span style="color:#ce5c00;font-weight:bold">[</span>+infra<span style="color:#ce5c00;font-weight:bold">][</span>+node<span style="color:#ce5c00;font-weight:bold">]</span> 
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>node.yml<span style="color:#ce5c00;font-weight:bold">]</span>  ./node.yml                               <span style="color:#ce5c00;font-weight:bold">[</span>+node<span style="color:#ce5c00;font-weight:bold">]</span>  <span style="color:#ce5c00;font-weight:bold">[</span>+node<span style="color:#ce5c00;font-weight:bold">]</span>  <span style="color:#ce5c00;font-weight:bold">[</span>+node<span style="color:#ce5c00;font-weight:bold">]</span>   <span style="color:#ce5c00;font-weight:bold">[</span>+node<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>etcd.yml<span style="color:#ce5c00;font-weight:bold">]</span>  ./etcd.yml  <span style="color:#ce5c00;font-weight:bold">[</span>-l etcd <span style="color:#ce5c00;font-weight:bold">]</span>                            <span style="color:#ce5c00;font-weight:bold">[</span>+etcd<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>minio.yml<span style="color:#ce5c00;font-weight:bold">]</span> ./minio.yml <span style="color:#ce5c00;font-weight:bold">[</span>-l minio<span style="color:#ce5c00;font-weight:bold">]</span>                                     <span style="color:#ce5c00;font-weight:bold">[</span>+minio<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>pgsql.yml<span style="color:#ce5c00;font-weight:bold">]</span> ./pgsql.yml                                                          <span style="color:#ce5c00;font-weight:bold">[</span>+pgsql<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>Note that there&rsquo;s a circular dependency between <a href="/docs/node/"><code>NODE</code></a> and <a href="/docs/infra/"><code>INFRA</code></a>:
to register a NODE to INFRA, the INFRA should already exist, while the INFRA module relies on NODE to work.</p>
<p>The solution is that <code>INFRA</code> playbook will also install <a href="/docs/node/"><code>NODE</code></a> module in addition to <a href="/docs/infra/"><code>INFRA</code></a> on infra nodes.
Make sure that infra nodes are init first. If you really want to init all nodes including infra in one-pass, <code>install.yml</code> is the way to go.</p>
<hr>
<h2 id="ansible">Ansible</h2>
<p>Playbooks require <code>ansible-playbook</code> executable to run, playbooks which is included in <code>ansible</code> rpm / deb package.</p>
<p>Pigsty will try it&rsquo;s best to install ansible on admin node during <a href="/docs/setup/install/#bootstrap">bootstrap</a>.</p>
<p>You can install it by yourself with <code>yum|apt|brew</code> <code>install ansible</code>, it is included in default OS repo.</p>
<p>Knowledge about ansible is good but not required. Only four parameters needs your attention:</p>
<ul>
<li><code>-l|--limit &lt;pattern&gt;</code> : Limit execution target on specific group/host/pattern (Where)</li>
<li><code>-t|--tags &lt;tags&gt;</code>: Only run tasks with specific tags (What)</li>
<li><code>-e|--extra-vars &lt;vars&gt;</code>: Extra command line arguments (How)</li>
<li><code>-i|--inventory &lt;path&gt;</code>: Using another inventory file (Conf)</li>
</ul>
<hr>
<h2 id="designate-inventory">Designate Inventory</h2>
<p>To use a different config inventory, you can copy &amp; paste the content into the <code>pigsty.yml</code> file in the home dir as needed.</p>
<p>The active inventory file can be specified with the <code>-i|--inventory &lt;path&gt;</code> parameter when running Ansible playbooks.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./node.yml  -i files/pigsty/rpmbuild.yml    <span style="color:#8f5902;font-style:italic"># use another file as config inventory, rather than the default pigsty.yml</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -i files/pigsty/rpm.yml         <span style="color:#8f5902;font-style:italic"># install pgsql module on machine define in files/pigsty/rpm.yml</span>
</span></span><span style="display:flex;"><span>./redis.yml -i files/pigsty/redis.yml       <span style="color:#8f5902;font-style:italic"># install redis module on machine define in files/pigsty/redis.yml</span>
</span></span></code></pre></div><p>If you wish to permanently modify the <strong>default</strong> config inventory filename, you can change the <code>inventory</code> parameter in the <a href="https://github.com/Vonng/pigsty/blob/main/ansible.cfg#L6"><code>ansible.cfg</code></a></p>
<hr>
<h2 id="limit-host">Limit Host</h2>
<p>The target of playbook can be limited with <code>-l|-limit &lt;selector&gt;</code>.</p>
<p>Missing this value could be dangerous since most playbooks will execute on <code>all</code> host, DO USE WITH CAUTION.</p>
<p>Here are some examples of host limit:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml                 <span style="color:#8f5902;font-style:italic"># run on all hosts (very dangerous!)</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -l pg-test      <span style="color:#8f5902;font-style:italic"># run on pg-test cluster</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -l 10.10.10.10  <span style="color:#8f5902;font-style:italic"># run on single host 10.10.10.10</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -l pg-*         <span style="color:#8f5902;font-style:italic"># run on host/group matching glob pattern `pg-*`</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -l <span style="color:#4e9a06">&#39;10.10.10.11,&amp;pg-test&#39;</span>     <span style="color:#8f5902;font-style:italic"># run on 10.10.10.10 of group pg-test</span>
</span></span><span style="display:flex;"><span>/pgsql-rm.yml -l <span style="color:#4e9a06">&#39;pg-test,!10.10.10.11&#39;</span>   <span style="color:#8f5902;font-style:italic"># run on pg-test, except 10.10.10.11</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -l pg-test      <span style="color:#8f5902;font-style:italic"># Execute the pgsql playbook against the hosts in the pg-test cluster</span>
</span></span></code></pre></div><hr>
<h2 id="limit-tags">Limit Tags</h2>
<p>You can execute a subset of playbook with <code>-t|--tags &lt;tags&gt;</code>.</p>
<p>You can specify multiple tags in comma separated list, e.g. <code>-t tag1,tag2</code>.</p>
<p>If specified, tasks with given tags will be executed instead of entire playbook.</p>
<p>Here are some examples of task limit:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_clean    <span style="color:#8f5902;font-style:italic"># cleanup existing postgres if necessary</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_dbsu     <span style="color:#8f5902;font-style:italic"># setup os user sudo for postgres dbsu</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_install  <span style="color:#8f5902;font-style:italic"># install postgres packages &amp; extensions</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_dir      <span style="color:#8f5902;font-style:italic"># create postgres directories and setup fhs</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_util     <span style="color:#8f5902;font-style:italic"># copy utils scripts, setup alias and env</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t patroni     <span style="color:#8f5902;font-style:italic"># bootstrap postgres with patroni</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_user     <span style="color:#8f5902;font-style:italic"># provision postgres business users</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_db       <span style="color:#8f5902;font-style:italic"># provision postgres business databases</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_backup   <span style="color:#8f5902;font-style:italic"># init pgbackrest repo &amp; basebackup</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pgbouncer   <span style="color:#8f5902;font-style:italic"># deploy a pgbouncer sidecar with postgres</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_vip      <span style="color:#8f5902;font-style:italic"># bind vip to pgsql primary with vip-manager</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_dns      <span style="color:#8f5902;font-style:italic"># register dns name to infra dnsmasq</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_service  <span style="color:#8f5902;font-style:italic"># expose pgsql service with haproxy</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_exporter <span style="color:#8f5902;font-style:italic"># expose pgsql service with haproxy</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_register <span style="color:#8f5902;font-style:italic"># register postgres to pigsty infrastructure</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># run multiple tasks: reload postgres &amp; pgbouncer hba rules</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># run multiple tasks: refresh haproxy config &amp; reload it</span>
</span></span><span style="display:flex;"><span>./node.yml -t haproxy_config,haproxy_reload
</span></span></code></pre></div><hr>
<h2 id="extra-vars">Extra Vars</h2>
<p>Extra command-line args can be passing via <code>-e|-extra-vars KEY=VALUE</code>.</p>
<p>It has the highest precedence over all other definition.</p>
<p>Here are some examples of extra vars</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./node.yml -e <span style="color:#000">ansible_user</span><span style="color:#ce5c00;font-weight:bold">=</span>admin -k -K   <span style="color:#8f5902;font-style:italic"># run playbook as another user (with admin sudo password)</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -e <span style="color:#000">pg_clean</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>             <span style="color:#8f5902;font-style:italic"># force purging existing postgres when init a pgsql instance</span>
</span></span><span style="display:flex;"><span>./pgsql-rm.yml -e <span style="color:#000">pg_uninstall</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>      <span style="color:#8f5902;font-style:italic"># explicitly uninstall rpm after postgres instance is removed</span>
</span></span><span style="display:flex;"><span>./redis.yml -l 10.10.10.10 -e <span style="color:#000">redis_port</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">6379</span> -t redis  <span style="color:#8f5902;font-style:italic"># init a specific redis instance: 10.10.10.11:6379</span>
</span></span><span style="display:flex;"><span>./redis-rm.yml -l 10.10.10.13 -e <span style="color:#000">redis_port</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">6379</span>        <span style="color:#8f5902;font-style:italic"># remove a specific redis instance: 10.10.10.11:6379</span>
</span></span></code></pre></div><p>You can also passing complex parameters like array and object via JSON:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># install duckdb packages on node with specified upstream repo module</span>
</span></span><span style="display:flex;"><span>./node.yml -t node_repo,node_pkg  -e <span style="color:#4e9a06">&#39;{&#34;node_repo_modules&#34;:&#34;infra&#34;,&#34;node_default_packages&#34;:[&#34;duckdb&#34;]}&#39;</span>
</span></span></code></pre></div><p>Most playbooks are idempotent, meaning that some deployment playbooks may erase existing databases and create new ones without the protection option turned on.</p>
<p>Please read the documentation carefully, proofread the commands several times, and operate with caution. The author is not responsible for any loss of databases due to misuse.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2b6cc71ea6f4c2bb3c7905255869cead">7 - Provisioning</h1>
    <div class="lead">Introduce the 4 node sandbox environment. and provision VMs with vagrant &amp; terraform</div>
	<p>Pigsty runs on nodes, which are Bare Metals or Virtual Machines. You can prepare them manually, or using terraform &amp; vagrant for provisioning.</p>
<hr>
<h2 id="sandbox">Sandbox</h2>
<p>Pigsty has a sandbox, which is a 4-node deployment with fixed IP addresses and other identifiers.
Check <a href="https://github.com/Vonng/pigsty/blob/main/conf/sandbox/full.yml"><code>full.yml</code></a> for details.</p>
<p>The sandbox consists of 4 nodes with fixed IP addresses: <code>10.10.10.10</code>, <code>10.10.10.11</code>, <code>10.10.10.12</code>, <code>10.10.10.13</code>.</p>
<p>There&rsquo;s a primary singleton PostgreSQL cluster: <code>pg-meta</code> on the <code>meta</code> node, which can be used alone if you don&rsquo;t care about PostgreSQL high availability.</p>
<ul>
<li><code>meta    10.10.10.10  pg-meta pg-meta-1</code></li>
</ul>
<p>There are 3 additional nodes in the sandbox, form a 3-instance PostgreSQL HA cluster <code>pg-test</code>.</p>
<ul>
<li><code>node-1  10.10.10.11  pg-test.pg-test-1</code></li>
<li><code>node-2  10.10.10.12  pg-test.pg-test-2</code></li>
<li><code>node-3  10.10.10.13  pg-test.pg-test-3</code></li>
</ul>
<p>Two optional L2 VIP are bind on primary instances of cluster <code>pg-meta</code>  and <code>pg-test</code>:</p>
<ul>
<li><code>10.10.10.2  pg-meta</code></li>
<li><code>10.10.10.3  pg-test</code></li>
</ul>
<p>There&rsquo;s also a 1-instance <code>etcd</code> cluster, and 1-instance <code>minio</code> cluster on the <code>meta</code> node, too.</p>
<p><img alt="pigsty-sandbox.jpg" src="/img/pigsty/sandbox.jpg"></p>
<p>You can run sandbox on local VMs or cloud VMs. Pigsty offers a local sandbox based on <a href="/docs/setup/provision/#vagrant">Vagrant</a> (pulling up local VMs using Virtualbox or libvirt), and a cloud sandbox based on Terraform (creating VMs using the cloud vendor API).</p>
<ul>
<li>
<p>Local sandbox can be run on your Mac/PC for free.  Your Mac/PC should have at least 4C/8G to run the full 4-node sandbox.</p>
</li>
<li>
<p>Cloud sandbox can be easily created and shared. You will have to create a cloud account for that. VMs are created on-demand and can be destroyed with one command, which is also very cheap for a quick glance.</p>
</li>
</ul>
<hr>
<h2 id="vagrant">Vagrant</h2>
<p><a href="https://www.vagrantup.com/">Vagrant</a> can create local VMs according to specs in a declarative way.
Check <a href="https://github.com/Vonng/pigsty/tree/master/vagrant/README.md">Vagrant Templates Intro</a> for details</p>
<p>Vagrant will use  <a href="https://www.virtualbox.org/">VirtualBox</a> as the default VM provider.
however libvirt, docker, parallel desktop and vmware can also be used. We will use VirtualBox in this guide.</p>
<h3 id="installation">Installation</h3>
<p>Make sure <a href="https://www.vagrantup.com/">Vagrant</a> and <a href="https://www.virtualbox.org/">Virtualbox</a> are installed and available on your OS.</p>
<p>If you are using macOS, You can use <code>homebrew</code> to install both of them with one command (reboot required). You can also use <a href="https://vagrant-libvirt.github.io/vagrant-libvirt/">vagrant-libvirt</a> on Linux.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/bin/bash -c <span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>brew install vagrant virtualbox ansible   <span style="color:#8f5902;font-style:italic"># Run on MacOS with one command, but only works on x86_64 Intel chips</span>
</span></span></code></pre></div><h3 id="configuration">Configuration</h3>
<p><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/Vagrantfile"><code>vagarnt/Vagranfile</code></a> is a ruby script file describing VM nodes. Here are some default specs of Pigsty.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Templates</th>
<th style="text-align:center">Shortcut</th>
<th style="text-align:center">Spec</th>
<th style="text-align:center">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/meta.rb">meta.rb</a></td>
<td style="text-align:center"><code>v1</code></td>
<td style="text-align:center">4C8G x 1</td>
<td style="text-align:center">Single Meta Node</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/full.rb">full.rb</a></td>
<td style="text-align:center"><code>v4</code></td>
<td style="text-align:center">2C4G + 1C2G x 3</td>
<td style="text-align:center">Full 4 Nodes Sandbox Demo</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/el7.rb">el7.rb</a></td>
<td style="text-align:center"><code>v7</code></td>
<td style="text-align:center">2C4G + 1C2G x 3</td>
<td style="text-align:center">EL7 3-node Testing Env</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/el8.rb">el8.rb</a></td>
<td style="text-align:center"><code>v8</code></td>
<td style="text-align:center">2C4G + 1C2G x 3</td>
<td style="text-align:center">EL8 3-node Testing Env</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/el9.rb">el9.rb</a></td>
<td style="text-align:center"><code>v9</code></td>
<td style="text-align:center">2C4G + 1C2G x 3</td>
<td style="text-align:center">EL9 3-node Testing Env</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/build.rb">build.rb</a></td>
<td style="text-align:center"><code>vb</code></td>
<td style="text-align:center">2C4G x 3</td>
<td style="text-align:center">3-Node EL7,8,9 Building Environment</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/check.rb">check.rb</a></td>
<td style="text-align:center"><code>vc</code></td>
<td style="text-align:center">2C4G x 30</td>
<td style="text-align:center">30 Node EL7-EL9 PG 12-16 Env</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/minio.rb">minio.rb</a></td>
<td style="text-align:center"><code>vm</code></td>
<td style="text-align:center">2C4G x 3 + Disk</td>
<td style="text-align:center">3-Node MinIO/etcd Testing Env</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/Vonng/pigsty/blob/main/vagrant/spec/prod.rb">prod.rb</a></td>
<td style="text-align:center"><code>vp</code></td>
<td style="text-align:center">45 nodes</td>
<td style="text-align:center">Prod simulation with 45 Nodes</td>
</tr>
</tbody>
</table>
<p>Each spec file contains a <code>Specs</code> variable describe VM nodes. For example, the <code>full.rb</code> contains the 4-node sandbox specs.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#000">Specs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;meta&#34;</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#4e9a06">&#34;ip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;10.10.10.10&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;cpu&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;2&#34;</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#4e9a06">&#34;mem&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;4096&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;image&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;generic/rocky9&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;node-1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;10.10.10.11&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;cpu&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#4e9a06">&#34;mem&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;2048&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;image&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;generic/rocky9&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;node-2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;10.10.10.12&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;cpu&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#4e9a06">&#34;mem&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;2048&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;image&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;generic/rocky9&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;name&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;node-3&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ip&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;10.10.10.13&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;cpu&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#4e9a06">&#34;mem&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;2048&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;image&#34;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">&#34;generic/rocky9&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>You can switch specs with the <code>vagrant/switch</code> script, it will render the final <code>Vagrantfile</code> according to the spec.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty
</span></span><span style="display:flex;"><span>vagrant/switch &lt;spec&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vagrant/switch meta     <span style="color:#8f5902;font-style:italic"># singleton meta        | alias:  `make v1`</span>
</span></span><span style="display:flex;"><span>vagrant/switch full     <span style="color:#8f5902;font-style:italic"># 4-node sandbox        | alias:  `make v4`</span>
</span></span><span style="display:flex;"><span>vagrant/switch el7      <span style="color:#8f5902;font-style:italic"># 3-node el7 test       | alias:  `make v7`</span>
</span></span><span style="display:flex;"><span>vagrant/switch el8      <span style="color:#8f5902;font-style:italic"># 3-node el8 test       | alias:  `make v8`</span>
</span></span><span style="display:flex;"><span>vagrant/switch el9      <span style="color:#8f5902;font-style:italic"># 3-node el9 test       | alias:  `make v9`</span>
</span></span><span style="display:flex;"><span>vagrant/switch prod     <span style="color:#8f5902;font-style:italic"># prod simulation       | alias:  `make vp`</span>
</span></span><span style="display:flex;"><span>vagrant/switch build    <span style="color:#8f5902;font-style:italic"># building environment  | alias:  `make vd`</span>
</span></span><span style="display:flex;"><span>vagrant/switch minio    <span style="color:#8f5902;font-style:italic"># 3-node minio env</span>
</span></span><span style="display:flex;"><span>vagrant/switch check    <span style="color:#8f5902;font-style:italic"># 30-node check env</span>
</span></span></code></pre></div><h3 id="management">Management</h3>
<p>After describing the VM nodes with specs and generate the <code>vagrant/Vagrantfile</code>. you can create the VMs with <code>vagrant up</code> command.</p>
<p>Pigsty templates will use your <code>~/.ssh/id_rsa[.pub]</code> as the default ssh key for vagrant provisioning.</p>
<p>Make sure you have a valid ssh key pair before you start, you can generate one by: <code>ssh-keygen -t rsa -b 2048</code></p>
<p>There are some makefile shortcuts that wrap the vagrant commands, you can use them to manage the VMs.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make         <span style="color:#8f5902;font-style:italic"># = make start</span>
</span></span><span style="display:flex;"><span>make new     <span style="color:#8f5902;font-style:italic"># destroy existing vm and create new ones</span>
</span></span><span style="display:flex;"><span>make ssh     <span style="color:#8f5902;font-style:italic"># write VM ssh config to ~/.ssh/     (required)</span>
</span></span><span style="display:flex;"><span>make dns     <span style="color:#8f5902;font-style:italic"># write VM DNS records to /etc/hosts (optional)</span>
</span></span><span style="display:flex;"><span>make start   <span style="color:#8f5902;font-style:italic"># launch VMs and write ssh config    (up + ssh) </span>
</span></span><span style="display:flex;"><span>make up      <span style="color:#8f5902;font-style:italic"># launch VMs with vagrant up</span>
</span></span><span style="display:flex;"><span>make halt    <span style="color:#8f5902;font-style:italic"># shutdown VMs (down,dw)</span>
</span></span><span style="display:flex;"><span>make clean   <span style="color:#8f5902;font-style:italic"># destroy VMs (clean/del/destroy)</span>
</span></span><span style="display:flex;"><span>make status  <span style="color:#8f5902;font-style:italic"># show VM status (st)</span>
</span></span><span style="display:flex;"><span>make pause   <span style="color:#8f5902;font-style:italic"># pause VMs (suspend,pause)</span>
</span></span><span style="display:flex;"><span>make resume  <span style="color:#8f5902;font-style:italic"># pause VMs (resume)</span>
</span></span><span style="display:flex;"><span>make nuke    <span style="color:#8f5902;font-style:italic"># destroy all vm &amp; volumes with virsh (if using libvirt) </span>
</span></span></code></pre></div><h3 id="shortcuts">Shortcuts</h3>
<p>You can create VMs with the following shortcuts:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make meta     <span style="color:#8f5902;font-style:italic"># singleton meta</span>
</span></span><span style="display:flex;"><span>make full     <span style="color:#8f5902;font-style:italic"># 4-node sandbox</span>
</span></span><span style="display:flex;"><span>make el7      <span style="color:#8f5902;font-style:italic"># 3-node el7 test</span>
</span></span><span style="display:flex;"><span>make el8      <span style="color:#8f5902;font-style:italic"># 3-node el8 test</span>
</span></span><span style="display:flex;"><span>make el9      <span style="color:#8f5902;font-style:italic"># 3-node el9 test</span>
</span></span><span style="display:flex;"><span>make prod     <span style="color:#8f5902;font-style:italic"># prod simulation</span>
</span></span><span style="display:flex;"><span>make build    <span style="color:#8f5902;font-style:italic"># building environment</span>
</span></span><span style="display:flex;"><span>make minio    <span style="color:#8f5902;font-style:italic"># 3-node minio env</span>
</span></span><span style="display:flex;"><span>make check    <span style="color:#8f5902;font-style:italic"># 30-node check env</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make meta  install   <span style="color:#8f5902;font-style:italic"># create and install pigsty on 1-node singleton meta</span>
</span></span><span style="display:flex;"><span>make full  install   <span style="color:#8f5902;font-style:italic"># create and install pigsty on 4-node sandbox</span>
</span></span><span style="display:flex;"><span>make prod  install   <span style="color:#8f5902;font-style:italic"># create and install pigsty on 42-node KVM libvirt environment</span>
</span></span><span style="display:flex;"><span>make check install   <span style="color:#8f5902;font-style:italic"># create and install pigsty on 30-node testing &amp; validating environment</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><hr>
<h2 id="terraform">Terraform</h2>
<p><a href="https://www.terraform.io/">Terraform</a> is an open-source tool to practice &lsquo;Infra as Code&rsquo;. Describe the cloud resource you want and create them with one command.</p>
<p>Pigsty has terraform templates for AWS, Aliyun, and Tencent Cloud, you can use them to create VMs on the cloud for Pigsty Demo.</p>
<p>Terraform can be easily installed with homebrew, too: <code>brew install terraform</code>. You will have to create a cloud account to obtain AccessKey and AccessSecret credentials to proceed.</p>
<p>The <code>terraform/</code> dir have two example templates: one for AWS, and one for Aliyun, you can adjust them to fit your need, or modify them if you are using a different cloud vendor.</p>
<p>Take Aliyun as example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> terraform                          <span style="color:#8f5902;font-style:italic"># goto the terraform dir</span>
</span></span><span style="display:flex;"><span>cp spec/aliyun.tf terraform.tf        <span style="color:#8f5902;font-style:italic"># use aliyun template</span>
</span></span></code></pre></div><p>You have to perform <code>terraform init</code> before <code>terraform apply</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>terraform init      <span style="color:#8f5902;font-style:italic"># install terraform provider: aliyun (required only for the first time)</span>
</span></span><span style="display:flex;"><span>terraform apply     <span style="color:#8f5902;font-style:italic"># generate execution plans: create VMs, virtual segments/switches/security groups</span>
</span></span></code></pre></div><p>After running <code>apply</code> and answering <code>yes</code> to the prompt, Terraform will create the VMs and configure the network for you.</p>
<p>The admin node ip address will be printed out at the end of the execution, you can ssh login and start pigsty <a href="/docs/setup/install/">installation</a>.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d6a656f7f8306b7de558a78bf1164ae0">8 - Security</h1>
    <div class="lead">Security considerations and best-practices in Pigsty</div>
	<p>Pigsty already provides a secure-by-default <a href="/docs/pgsql/hba/">authentication</a> and <a href="/docs/pgsql/acl/">access control</a> model, which is sufficient for most scenarios.</p>
<p><a href="/docs/pgsql/acl/"><img alt="pigsty-acl.jpg" src="/img/pigsty/acl.jpg"></a></p>
<p>But if you want to further strengthen the security of the system, the following suggestions are for your reference:</p>
<hr>
<h2 id="confidentiality">Confidentiality</h2>
<h3 id="important-files">Important Files</h3>
<p><strong>Secure your pigsty config inventory</strong></p>
<ul>
<li><code>pigsty.yml</code> has highly sensitive information, including passwords, certificates, and keys.</li>
<li>You should limit access to admin/infra nodes, only accessible by the admin/dba users</li>
<li>Limit access to the git repo, if you are using git to manage your pigsty source.</li>
</ul>
<p><strong>Secure your CA private key and other certs</strong></p>
<ul>
<li>These files are very important, and will be generated under <code>files/pki</code> under pigsty source dir by default.</li>
<li>You should secure &amp; backup them in a safe place periodically.</li>
</ul>
<hr>
<h3 id="passwords">Passwords</h3>
<p><strong>Always change these passwords, DO NOT USE THE DEFAULT VALUES:</strong></p>
<ul>
<li><a href="/docs/reference/param/#grafana_admin_password"><code>grafana_admin_password</code></a>   : <code>pigsty</code></li>
<li><a href="/docs/reference/param/#pg_admin_password"><code>pg_admin_password</code></a>             : <code>DBUser.DBA</code></li>
<li><a href="/docs/reference/param/#pg_monitor_password"><code>pg_monitor_password</code></a>         : <code>DBUser.Monitor</code></li>
<li><a href="/docs/reference/param/#pg_replication_password"><code>pg_replication_password</code></a> : <code>DBUser.Replicator</code></li>
<li><a href="/docs/reference/param/#patroni_password"><code>patroni_password</code></a>               : <code>Patroni.API</code></li>
<li><a href="/docs/reference/param/#haproxy_admin_password"><code>haproxy_admin_password</code></a>   : <code>pigsty</code></li>
<li><a href="/docs/reference/param/#minio_secret_key"><code>minio_secret_key</code></a>               : <code>minioadmin</code></li>
</ul>
<p><strong>Please change MinIO user secret key and pgbackrest_repo references</strong></p>
<ul>
<li>Please change the password for <a href="/docs/reference/param/#minio_users"><code>minio_users</code>.<code>[pgbacrest]</code>.<code>secret_key</code></a></li>
<li>Please change pgbackrest references: <a href="/docs/reference/param/#pgbackrest_repo"><code>pgbackrest_repo</code>.<code>minio</code>.<code>s3_key_secret</code></a></li>
</ul>
<p><strong>If you are using remote backup method, secure backup with distinct passwords</strong></p>
<ul>
<li>Use <code>aes-256-cbc</code> for <a href="/docs/reference/param/#pgbackrest_repo"><code>pgbackrest_repo</code>.<code>*</code>.<code>cipher_type</code></a></li>
<li>When setting a password, you can use <code>${pg_cluster}</code> placeholder as part of the password to avoid using the same password.</li>
</ul>
<p><strong>Use advanced password encryption method for PostgreSQL</strong></p>
<ul>
<li>use <a href="/docs/reference/param/#pg_pwd_enc"><code>pg_pwd_enc</code></a> default <code>scram-sha-256</code> instead of legacy <code>md5</code></li>
</ul>
<p><strong>Enforce a strong pg password with the <code>passwordcheck</code> extension.</strong></p>
<ul>
<li>add <code>$lib/passwordcheck</code> to <a href="/docs/reference/param/#pg_libs"><code>pg_libs</code></a> to enforce password policy.</li>
</ul>
<p><strong>Encrypt remote backup with an encryption algorithm</strong></p>
<ul>
<li>check <a href="/docs/reference/param/#pgbackrest_repo"><code>pgbackrest_repo</code></a> definition <code>repo_cipher_type</code></li>
</ul>
<p><strong>Add an expiration date to biz user passwords.</strong></p>
<ul>
<li>
<p>You can set an expiry date for each user for compliance purposes.</p>
</li>
<li>
<p>Don&rsquo;t forget to refresh these passwords periodically.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_meta , password: Pleas3-ChangeThisPwd ,expire_in: 7300 ,pgbouncer: true ,roles: [ dbrole_admin ]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_view , password: Make.3ure-Compl1ance  ,expire_in: 7300 ,pgbouncer: true ,roles: [ dbrole_readonly ] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">read-only viewer for meta database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: postgres     ,superuser: true  ,expire_in: 7300                        ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system superuser }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: replicator ,replication: true  ,expire_in: 7300 ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system replicator }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_dba   ,superuser: true  ,expire_in: 7300 ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_monitor ,roles: [pg_monitor] ,expire_in: 7300 ,pgbouncer: true ,parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql monitor user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<p><strong>Do not log changing password statement into postgres log.</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SET log_statement TO <span style="color:#4e9a06">&#39;none&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>ALTER USER <span style="color:#4e9a06">&#34;{{ user.name }}&#34;</span> PASSWORD <span style="color:#4e9a06">&#39;{{ user.password }}&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>SET log_statement TO DEFAULT<span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><hr>
<h3 id="ip-addresses">IP Addresses</h3>
<p><strong>Bind to specific IP addresses rather than all addresses for postgres/pgbouncer/patroni</strong></p>
<ul>
<li>The default <a href="/docs/reference/param/#pg_listen"><code>pg_listen</code></a> address is <code>0.0.0.0</code>, which is all IPv4 addresses.</li>
<li>consider using <code>pg_listen: '${ip},${vip},${lo}'</code> to bind to specific addresses for better security.</li>
</ul>
<p><strong>Do not expose any port to the Internet; except 80/443, the infra portal</strong></p>
<ul>
<li>Grafana/Prometheus are bind to <strong>all</strong> IP address by default for convenience.</li>
<li>You can modify their bind configuration to listen on localhost/intranet IP and expose by Nginx.</li>
<li>Redis server are bind to <strong>all</strong> IP address by default for convenience. You can change <a href="/docs/reference/param/#redis_bind_address"><code>redis_bind_address</code></a> to listen on intranet IP.</li>
<li>You can also implement it with the security group or firewall rules.</li>
</ul>
<p><strong>Limit postgres client access with <a href="/docs/pgsql/hba/">HBA</a></strong></p>
<ul>
<li>There&rsquo;s a security enhance config template: <a href="https://github.com/Vonng/pigsty/blob/main/conf/demo/security.yml"><code>security.yml</code></a></li>
</ul>
<p><strong>Limit patroni admin access from the infra/admin node.</strong></p>
<ul>
<li>This is restricted by default with <a href="https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/oltp.yml#L109"><code>restapi.allowlist</code></a></li>
</ul>
<hr>
<h3 id="network-traffic">Network Traffic</h3>
<ul>
<li>
<p>Access Nginx with SSL and domain names</p>
<ul>
<li>Nginx SSL is controlled by <a href="/docs/reference/param/#nginx_sslmode"><code>nginx_sslmode</code></a>, which is <code>enable</code> by default.</li>
<li>Nginx Domain names are specified by <a href="/docs/reference/param/#infra_portal"><code>infra_portal.&lt;value&gt;.domain</code></a>.</li>
</ul>
</li>
<li>
<p>Secure Patroni REST API with SSL</p>
<ul>
<li><a href="/docs/reference/param/#patroni_ssl_enabled"><code>patroni_ssl_enabled</code></a> is disabled by default</li>
<li>Since it affects health checks and API invocation.</li>
<li>Note this is a global option, and you have to decide before deployment.</li>
</ul>
</li>
<li>
<p>Secure Pgbouncer Client Traffic with SSL</p>
<ul>
<li><a href="/docs/reference/param/#pgbouncer_sslmode"><code>pgbouncer_sslmode</code></a> is <code>disable</code> by default</li>
<li>Since it has a significant performance impact.</li>
</ul>
</li>
</ul>
<hr>
<h2 id="integrity">Integrity</h2>
<hr>
<h3 id="consistency">Consistency</h3>
<p><strong>Use consistency-first mode for PostgreSQL.</strong></p>
<ul>
<li>Use <code>crit.yml</code> templates for <a href="/docs/reference/param/#pg_conf"><code>pg_conf</code></a> will trade some availability for the best consistency.</li>
</ul>
<p><strong>Use node crit tuned template for better consistency</strong></p>
<ul>
<li>set <a href="/docs/reference/param/#node_tune"><code>node_tune</code></a> to <code>crit</code> to reduce dirty page ratio.</li>
</ul>
<ul>
<li>Enable data checksum to detect silent data corruption.
<ul>
<li><a href="/docs/reference/param/#pg_checksum"><code>pg_checksum</code></a> is disabled by default, and enabled for <code>crit.yml</code> by default</li>
<li>This can be enabled later, which requires a full cluster scan/stop.</li>
</ul>
</li>
</ul>
<hr>
<h3 id="audit">Audit</h3>
<ul>
<li>Enable <code>log_connections</code> and <code>log_disconnections</code> after the pg cluster bootstrap.
<ul>
<li>Audit incoming sessions; this is enabled in <code>crit.yml</code> by default.</li>
</ul>
</li>
</ul>
<hr>
<h2 id="availability">Availability</h2>
<ul>
<li>
<p>Do not access the database directly via a fixed IP address; use VIP, DNS, HAProxy, or their combination.</p>
<ul>
<li>Haproxy will handle the traffic control for the clients in case of failover/switchover.</li>
</ul>
</li>
<li>
<p>Use enough nodes for serious production deployment.</p>
<ul>
<li>You need at least three nodes (tolerate one node failure) to achieve production-grade high availability.</li>
<li>If you only have two nodes, you can tolerate the failure of the specific standby node.</li>
<li>If you have one node, use an external S3/MinIO for cold backup &amp; wal archive storage.</li>
</ul>
</li>
<li>
<p>Trade off between availability and consistency for PostgreSQL.</p>
<ul>
<li><a href="/docs/reference/param/#pg_rpo"><code>pg_rpo</code></a> : <strong>trade-off between Availability and Consistency</strong></li>
<li><a href="/docs/reference/param/#pg_rto"><code>pg_rto</code></a> : <strong>trade-off between failure chance and impact</strong></li>
</ul>
</li>
<li>
<p>Use multiple infra nodes in serious production deployment (e.g., 1~3)</p>
<ul>
<li>Usually, 2 ~ 3 is enough for a large production deployment.</li>
</ul>
</li>
<li>
<p>Use enough etcd members and use even numbers (1,3,5,7).</p>
<ul>
<li>Check <a href="/docs/etcd/#administration">ETCD Administration</a> for details.</li>
</ul>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-262f396efed9aff5d120f3d92b472bdf">9 - FAQ</h1>
    <div class="lead">Frequently asked questions about download, setup, configuration, and installation in Pigsty.</div>
	<blockquote>
<p>If you have any unlisted questions or suggestions, please create an <a href="https://github.com/Vonng/pigsty/issues/new">Issue</a> or ask the <a href="/docs/overview#about">community</a> for help.</p>
</blockquote>
<hr>
<h2 id="how-to-get-the-pigsty-source-package">How to Get the Pigsty Source Package?</h2>
<p>Use the following command to install Pigsty with one click: <code>curl -fsSL https://repo.pigsty.io/get | bash</code></p>
<p>This command will automatically download the latest stable version <code>pigsty.tgz</code> and extract it to the <code>~/pigsty</code> directory. You can also manually download a specific version of the Pigsty source code from the following locations.</p>
<p>If you need to install it in an environment without internet access, you can download it in advance in a networked environment and transfer it to the production server via scp/sftp or CDROM/USB.</p>
<hr>
<h2 id="how-to-speed-up-rpm-downloads-from-upstream-repositories">How to Speed Up RPM Downloads from Upstream Repositories?</h2>
<p>Consider using a local repository mirror, which can be configured with the <a href="/docs/reference/param/#repo_upstream"><code>repo_upstream</code></a> parameter. You can choose <a href="/docs/reference/param/#region"><code>region</code></a> to use different mirror sites.</p>
<p>For example, you can set <code>region</code> = <code>china</code>, which will use the URL with the key <code>china</code> in the <code>baseurl</code> instead of <code>default</code>.</p>
<p>If some repositories are blocked by a firewall or the GFW, consider using <a href="/docs/reference/param/#proxy_env"><code>proxy_env</code></a> to bypass it.</p>
<hr>
<h2 id="how-to-resolve-node-package-conflict">How to resolve node package conflict?</h2>
<p>Beware that Pigsty&rsquo;s pre-built <a href="/docs/setup/offline/"><strong>offline packages</strong></a> are tailored for <a href="/docs/reference/compatibility/#vagrant-boxes"><strong>specific minor versions OS Distors</strong></a>.
Therefore, if the <code>major.minor</code> version of your OS distro does not precisely align, we advise against using the offline installation packages.
Instead, following the default installation procedure and download the package directly from upstream repo through the Internet, which will acquire the versions that exactly match your OS version.</p>
<p>If online installation doesn&rsquo;t work for you, you can first try modifying the upstream software sources used by Pigsty.
For example, in EL family operating systems, Pigsty&rsquo;s default upstream sources use a major version placeholder <code>$releasever</code>, which resolves to specific major versions like 7, 8, 9.
However, many operating system distributions offer a Vault, allowing you to use a package mirror for a specific version.
Therefore, you could replace the front part of the <code>repo_upstream</code> parameter&rsquo;s BaseURL with a specific Vault minor version repository, such as:</p>
<ul>
<li><code>https://dl.rockylinux.org/pub/rocky/$releasever</code> (Original BaseURL prefix, without <code>vault</code>)</li>
<li><code>https://vault.centos.org/7.6.1810/</code> (Using 7.6 instead of the default 7.9)</li>
<li><code>https://dl.rockylinux.org/vault/rocky/8.6/</code> (Using 8.6 instead of the default 8.9)</li>
<li><code>https://dl.rockylinux.org/vault/rocky/9.2/</code> (Using 9.2 instead of the default 9.3)</li>
</ul>
<p>Make sure the vault URL path exists &amp; valid before replacing the old values. Beware that some repo like <code>epel</code> do not offer specific minor version subdirs.
Upstream repo that support this approach include: <code>base</code>, <code>updates</code>, <code>extras</code>, <code>centos-sclo</code>, <code>centos-sclo-rh</code>, <code>baseos</code>, <code>appstream</code>, <code>extras</code>, <code>crb</code>, <code>powertools</code>, <code>pgdg-common</code>, <code>pgdg1*</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">repo_upstream</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pigsty-local   ,description: &#39;Pigsty Local&#39;      ,module: local ,releases: [7,8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;http://${admin_ip}/pigsty&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}}<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># used by intranet nodes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pigsty-infra   ,description: &#39;Pigsty INFRA&#39;      ,module: infra ,releases: [7,8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://repo.pigsty.io/rpm/infra/$basearch&#39; ,china</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://repo.pigsty.cc/rpm/infra/$basearch&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pigsty-pgsql   ,description: &#39;Pigsty PGSQL&#39;      ,module: pgsql ,releases: [7,8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://repo.pigsty.io/rpm/pgsql/el$releasever.$basearch&#39; ,china</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://repo.pigsty.cc/rpm/pgsql/el$releasever.$basearch&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: nginx          ,description: &#39;Nginx Repo&#39;        ,module: infra ,releases: [7,8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://nginx.org/packages/centos/$releasever/$basearch/&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: docker-ce      ,description: &#39;Docker CE&#39;         ,module: infra ,releases: [7,8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://download.docker.com/linux/centos/$releasever/$basearch/stable&#39;        ,china: &#39;https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/$basearch/stable&#39;  ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/docker-ce/linux/centos/$releasever/$basearch/stable&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: base           ,description: &#39;EL 7 Base&#39;         ,module: node  ,releases: [7    ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;http://mirror.centos.org/centos/$releasever/os/$basearch/&#39;                    ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/centos/$releasever/os/$basearch/&#39;           ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/centos/$releasever/os/$basearch/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">           </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: updates        ,description: &#39;EL 7 Updates&#39;      ,module: node  ,releases: [7    ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;http://mirror.centos.org/centos/$releasever/updates/$basearch/&#39;               ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/centos/$releasever/updates/$basearch/&#39;      ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/centos/$releasever/updates/$basearch/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">      </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: extras         ,description: &#39;EL 7 Extras&#39;       ,module: node  ,releases: [7    ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;http://mirror.centos.org/centos/$releasever/extras/$basearch/&#39;                ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/centos/$releasever/extras/$basearch/&#39;       ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/centos/$releasever/extras/$basearch/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">       </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: epel           ,description: &#39;EL 7 EPEL&#39;         ,module: node  ,releases: [7    ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;http://download.fedoraproject.org/pub/epel/$releasever/$basearch/&#39;            ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/epel/$releasever/$basearch/&#39;                ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/epel/$releasever/$basearch/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">                </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: centos-sclo    ,description: &#39;EL 7 SCLo&#39;         ,module: node  ,releases: [7    ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;http://mirror.centos.org/centos/$releasever/sclo/$basearch/sclo/&#39;             ,china: &#39;https://mirrors.aliyun.com/centos/$releasever/sclo/$basearch/sclo/&#39;              ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/centos/$releasever/sclo/$basearch/sclo/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: centos-sclo-rh ,description: &#39;EL 7 SCLo rh&#39;      ,module: node  ,releases: [7    ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;http://mirror.centos.org/centos/$releasever/sclo/$basearch/rh/&#39;               ,china: &#39;https://mirrors.aliyun.com/centos/$releasever/sclo/$basearch/rh/&#39;                ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/centos/$releasever/sclo/$basearch/rh/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">      </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: baseos         ,description: &#39;EL 8+ BaseOS&#39;      ,module: node  ,releases: [  8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://dl.rockylinux.org/pub/rocky/$releasever/BaseOS/$basearch/os/&#39;         ,china: &#39;https://mirrors.aliyun.com/rockylinux/$releasever/BaseOS/$basearch/os/&#39;          ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/rocky/$releasever/BaseOS/$basearch/os/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">     </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: appstream      ,description: &#39;EL 8+ AppStream&#39;   ,module: node  ,releases: [  8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://dl.rockylinux.org/pub/rocky/$releasever/AppStream/$basearch/os/&#39;      ,china: &#39;https://mirrors.aliyun.com/rockylinux/$releasever/AppStream/$basearch/os/&#39;       ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/rocky/$releasever/AppStream/$basearch/os/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: extras         ,description: &#39;EL 8+ Extras&#39;      ,module: node  ,releases: [  8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://dl.rockylinux.org/pub/rocky/$releasever/extras/$basearch/os/&#39;         ,china: &#39;https://mirrors.aliyun.com/rockylinux/$releasever/extras/$basearch/os/&#39;          ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/rocky/$releasever/extras/$basearch/os/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">     </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: crb            ,description: &#39;EL 9 CRB&#39;          ,module: node  ,releases: [    9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://dl.rockylinux.org/pub/rocky/$releasever/CRB/$basearch/os/&#39;            ,china: &#39;https://mirrors.aliyun.com/rockylinux/$releasever/CRB/$basearch/os/&#39;             ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/rocky/$releasever/CRB/$basearch/os/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">        </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: powertools     ,description: &#39;EL 8 PowerTools&#39;   ,module: node  ,releases: [  8  ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://dl.rockylinux.org/pub/rocky/$releasever/PowerTools/$basearch/os/&#39;     ,china: &#39;https://mirrors.aliyun.com/rockylinux/$releasever/PowerTools/$basearch/os/&#39;      ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/rocky/$releasever/PowerTools/$basearch/os/&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: epel           ,description: &#39;EL 8+ EPEL&#39;        ,module: node  ,releases: [  8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;http://download.fedoraproject.org/pub/epel/$releasever/Everything/$basearch/&#39; ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/epel/$releasever/Everything/$basearch/&#39;     ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/epel/$releasever/Everything/$basearch/&#39;</span><span style="color:#f8f8f8;text-decoration:underline">     </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pgdg-common    ,description: &#39;PostgreSQL Common&#39; ,module: pgsql ,releases: [7,8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://download.postgresql.org/pub/repos/yum/common/redhat/rhel-$releasever-$basearch&#39; ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/common/redhat/rhel-$releasever-$basearch&#39; , europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/postgresql/repos/yum/common/redhat/rhel-$releasever-$basearch&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pgdg-extras    ,description: &#39;PostgreSQL Extra&#39;  ,module: pgsql ,releases: [7,8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://download.postgresql.org/pub/repos/yum/common/pgdg-rhel$releasever-extras/redhat/rhel-$releasever-$basearch&#39; ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/common/pgdg-rhel$releasever-extras/redhat/rhel-$releasever-$basearch&#39; , europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/postgresql/repos/yum/common/pgdg-rhel$releasever-extras/redhat/rhel-$releasever-$basearch&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pgdg-el8fix    ,description: &#39;PostgreSQL EL8FIX&#39; ,module: pgsql ,releases: [  8  ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://download.postgresql.org/pub/repos/yum/common/pgdg-centos8-sysupdates/redhat/rhel-8-x86_64/&#39; ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/common/pgdg-centos8-sysupdates/redhat/rhel-8-x86_64/&#39; , europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/postgresql/repos/yum/common/pgdg-centos8-sysupdates/redhat/rhel-8-x86_64/&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pgdg-el9fix    ,description: &#39;PostgreSQL EL9FIX&#39; ,module: pgsql ,releases: [    9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://download.postgresql.org/pub/repos/yum/common/pgdg-rocky9-sysupdates/redhat/rhel-9-x86_64/&#39;  ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/common/pgdg-rocky9-sysupdates/redhat/rhel-9-x86_64/&#39; , europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/postgresql/repos/yum/common/pgdg-rocky9-sysupdates/redhat/rhel-9-x86_64/&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pgdg15         ,description: &#39;PostgreSQL 15&#39;     ,module: pgsql ,releases: [7    ] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://download.postgresql.org/pub/repos/yum/15/redhat/rhel-$releasever-$basearch&#39; ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/15/redhat/rhel-$releasever-$basearch&#39; ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/postgresql/repos/yum/15/redhat/rhel-$releasever-$basearch&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: pgdg16         ,description: &#39;PostgreSQL 16&#39;     ,module: pgsql ,releases: [  8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default: &#39;https://download.postgresql.org/pub/repos/yum/16/redhat/rhel-$releasever-$basearch&#39; ,china: &#39;https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/16/redhat/rhel-$releasever-$basearch&#39; ,europe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://mirrors.xtom.de/postgresql/repos/yum/16/redhat/rhel-$releasever-$basearch&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: timescaledb    ,description: &#39;TimescaleDB&#39;       ,module: pgsql ,releases: [7,8,9] ,baseurl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;https://packagecloud.io/timescale/timescaledb/el/$releasever/$basearch&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>After explicitly defining and overriding the <code>repo_upstream</code> in the Pigsty configuration file, (you may clear the <code>/www/pigsty/repo_complete</code> flag) try the installation again.
If the upstream software source and the mirror source software do not solve the problem, you might consider replacing them with the operating system&rsquo;s built-in software sources and attempt a direct installation from upstream once more.</p>
<p>Finally, if the above methods do not resolve the issue, consider removing conflicting packages from <code>node_packages</code>, <code>infra_packages</code>, <code>pg_packages</code>, <code>pg_extensions</code>, or remove or upgrade the conflicting packages on the existing system.</p>
<hr>
<h2 id="what-does-bootstrap-do">What does <code>bootstrap</code> do?</h2>
<blockquote>
<p>Check the environment, ask for downloading offline packages, and make sure the essential tool <code>ansible</code> is installed.</p>
</blockquote>
<p>It will make sure the essential tool <code>ansible</code> is installed by various means.</p>
<p>When you download the Pigsty source code, you can enter the directory and execute the <a href="/docs/setup/install/#bootstrap"><code>bootstrap</code></a> script.
It will check if your node environment is ready, and if it does not find offline packages, it will ask if you want to download them from the internet if applicable.</p>
<p>You can choose <code>y</code> to use offline packages, which will make the installation procedure faster.
You can also choose <code>n</code> to skip and download directly from the internet during the installation process,
which will download the latest software versions and reduce the chance of RPM conflicts.</p>
<hr>
<h2 id="what-does-configure-do">What does <code>configure</code> do?</h2>
<blockquote>
<p>Detect the environment, generate the configuration, enable the offline package (optional), and install the essential tool Ansible.</p>
</blockquote>
<p>After downloading the Pigsty source package and unpacking it, you may have to execute <code>./configure</code> to complete the environment <a href="/docs/setup/install/#configure">configuration</a>. This is optional if you already know how to configure Pigsty properly.</p>
<p>The <strong>configure</strong> procedure will detect your node environment and generate a pigsty config file: <code>pigsty.yml</code> for you.</p>
<hr>
<h2 id="what-is-the-pigsty-config-file">What is the Pigsty config file?</h2>
<blockquote>
<p><code>pigsty.yml</code> under the pigsty home dir is the default config file.</p>
</blockquote>
<p>Pigsty uses a single config file <code>pigsty.yml,</code> to describe the entire environment, and you can define everything there. There are many config examples in <a href="https://github.com/Vonng/pigsty/tree/master/files/pigsty"><code>files/pigsty</code></a> for your reference.</p>
<p>You can pass the <code>-i &lt;path&gt;</code> to playbooks to use other configuration files. For example, you want to install redis according to another config: <code>redis.yml</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./redis.yml -i files/pigsty/redis.yml
</span></span></code></pre></div><hr>
<h2 id="how-to-use-the-cmdb-as-config-inventory">How to use the CMDB as config inventory</h2>
<p>The default config file path is specified in <a href="https://github.com/Vonng/pigsty/blob/main/ansible.cfg"><code>ansible.cfg</code></a>: <code>inventory = pigsty.yml</code></p>
<p>You can switch to a dynamic CMDB inventory with <a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_cmdb"><code>bin/inventory_cmdb</code></a>, and switch back to the local config file with <a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_conf"><code>bin/inventory_conf</code></a>. You must also load the current config file inventory to CMDB with <a href="https://github.com/Vonng/pigsty/blob/main/bin/inventory_load"><code>bin/inventory_load</code></a>.</p>
<p>If CMDB is used, you must edit the inventory config from the database rather than the config file.</p>
<hr>
<h2 id="what-is-the-ip-address-placeholder-in-the-config-file">What is the IP address placeholder in the config file?</h2>
<blockquote>
<p>Pigsty uses <code>10.10.10.10</code> as a placeholder for the current node IP, which will be replaced with the primary IP of the current node during the configuration.</p>
</blockquote>
<p>When the <code>configure</code> detects multiple NICs with multiple IPs on the current node, the config wizard will prompt for the <strong>primary</strong> IP to be used, i.e., <strong>the IP used by the user to access the node from the internal network</strong>. Note that please do not use the public IP.</p>
<p>This IP will be used to replace <code>10.10.10.10</code> in the config file template.</p>
<hr>
<h2 id="which-parameters-need-your-attention">Which parameters need your attention?</h2>
<blockquote>
<p>Usually, in a singleton installation, there is no need to make any adjustments to the config files.</p>
</blockquote>
<p>Pigsty provides 265 config parameters to customize the entire infra/node/etcd/minio/pgsql.  However, there are a few parameters that can be adjusted in advance if needed:</p>
<ul>
<li>When accessing web service components, the domain name is <a href="/docs/reference/param/#infra_portal"><code>infra_portal</code></a> (some services can only be accessed using the domain name through the Nginx proxy).</li>
<li>Pigsty assumes that a <code>/data</code> dir exists to hold all data; you can adjust these paths if the data disk mount point differs from this.</li>
<li>Don&rsquo;t forget to change those <strong>passwords</strong> in the config file for your production deployment.</li>
</ul>
<hr>
<h2 id="installation">Installation</h2>
<hr>
<h2 id="what-was-executed-during-installation">What was executed during installation?</h2>
<blockquote>
<p>When running <code>make install</code>, the ansible-playbook <a href="https://github.com/Vonng/pigsty/blob/main/install.yml"><code>install.yml</code></a> will be invoked to install everything on all nodes</p>
</blockquote>
<p>Which will:</p>
<ul>
<li>Install <code>INFRA</code> module on the current node.</li>
<li>Install <code>NODE</code> module on the current node.</li>
<li>Install <code>ETCD</code> module on the current node.</li>
<li>The <code>MinIO</code> module is optional, and will not be installed by default.</li>
<li>Install <code>PGSQL</code> module on the current node.</li>
</ul>
<hr>
<h2 id="how-to-resolve-rpm-conflict">How to resolve RPM conflict?</h2>
<p>There may have a slight chance that rpm conflict occurs during node/infra/pgsql packages installation.</p>
<p>The simplest way to resolve this is to install without offline packages, which will download directly from the upstream repo.</p>
<p>If there are only a few problematic RPM/DEB pakages, you can use a trick to fix the yum/apt repo quickly:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>rm -rf /www/pigsty/repo_complete    <span style="color:#8f5902;font-style:italic"># delete the repo_complete flag file to mark this repo incomplete</span>
</span></span><span style="display:flex;"><span>rm -rf SomeBrokenPackages           <span style="color:#8f5902;font-style:italic"># delete problematic RPM/DEB packages</span>
</span></span><span style="display:flex;"><span>./infra.yml -t repo_upstream        <span style="color:#8f5902;font-style:italic"># write upstream repos. you can also use /etc/yum.repos.d/backup/*</span>
</span></span><span style="display:flex;"><span>./infra.yml -t repo_pkg             <span style="color:#8f5902;font-style:italic"># download rpms according to your current OS</span>
</span></span></code></pre></div><hr>
<h2 id="how-to-create-local-vms-with-vagrant">How to create local VMs with vagrant</h2>
<blockquote>
<p>The first time you use Vagrant to pull up a particular OS repo, it will download the corresponding BOX.</p>
</blockquote>
<p>Pigsty sandbox uses <code>generic/rocky9</code> image box by default, and Vagrant will download the <code>rocky/9</code> box for the first time the VM is started.</p>
<p>Using a proxy may increase the download speed. Box only needs to be downloaded once, and will be reused when recreating the sandbox.</p>
<hr>
<h2 id="rpms-error-on-aliyun-centos-79">RPMs error on Aliyun CentOS 7.9</h2>
<blockquote>
<p>Aliyun CentOS 7.9 server has DNS caching service <code>nscd</code> installed by default. Just remove it.</p>
</blockquote>
<p>Aliyun&rsquo;s CentOS 7.9 repo has <code>nscd</code> installed by default, locking out the glibc version, which can cause RPM dependency errors during installation.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#4e9a06">&#34;Error: Package: nscd-2.17-307.el7.1.x86_64 (@base)&#34;</span>
</span></span></code></pre></div><p>Run <code>yum remove -y nscd</code> on all nodes to resolve this issue, and with Ansible, you can batch.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible all -b -a <span style="color:#4e9a06">&#39;yum remove -y nscd&#39;</span>
</span></span></code></pre></div><hr>
<h2 id="rpms-error-on-tencent-qcloud-rocky-91">RPMs error on Tencent Qcloud Rocky 9.1</h2>
<blockquote>
<p>Tencent Qcloud Rocky 9.1 require extra <code>annobin</code> packages</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./infra.yml -t repo_upstream      <span style="color:#8f5902;font-style:italic"># add upstream repos</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> /www/pigsty<span style="color:#000;font-weight:bold">;</span>                   <span style="color:#8f5902;font-style:italic"># download missing packages</span>
</span></span><span style="display:flex;"><span>repotrack annobin gcc-plugin-annobin libuser
</span></span><span style="display:flex;"><span>./infra.yml -t repo_create        <span style="color:#8f5902;font-style:italic"># create repo</span>
</span></span></code></pre></div><hr>
<h2 id="ansible-command-timeout-timeout-waiting-for-xxx">Ansible command timeout (Timeout waiting for xxx)</h2>
<p>The default ssh timeout for ansible command is 10 seconds, some commands may take longer than that due to network latency or other reasons.</p>
<p>You can increase the timeout parameter in the ansible config file <a href="https://github.com/Vonng/pigsty/blob/main/ansible.cfg"><code>ansible.cfg</code></a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">[defaults]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">timeout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">10 # change to 60,120 or more</span>
</span></span></code></pre></div>
</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Mail" aria-label="Mail">
    <a target="_blank" rel="noopener" href="mailto:rh@vonng.com" aria-label="Mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Vonng/pigsty" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://twitter.com/GobeUncleWang" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="WeChat" aria-label="WeChat">
    <a target="_blank" rel="noopener" href="/img/pigsty/pigsty-cc.jpg" aria-label="WeChat">
      <i class="fa fa-comment"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Discord" aria-label="Discord">
    <a target="_blank" rel="noopener" href="https://discord.gg/wDzt5VyWEz" aria-label="Discord">
      <i class="fab fa-discord"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Telegram" aria-label="Telegram">
    <a target="_blank" rel="noopener" href="https://t.me/joinchat/gV9zfZraNPM3YjFh" aria-label="Telegram">
      <i class="fab fa-telegram"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2018&ndash;2024
    <span class="td-footer__authors">Ruohang Feng</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span></span><span class="ms-2"><a href="https://vonng.com/en/" target="_blank" rel="noopener">@Vonng</a></span>
<br><span>Pigsty® distributed under <a href="/docs/about/license" target="_blank" rel="noopener">AGPLv3</a></span>
<br><span class="ms-2"><a href="/docs/about/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
<span><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">浙ICP备15016890号</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.248655eb216150e39da254c2f7aa5357805d0ec66bdb741b591cd35fb5f629ab.js" integrity="sha256-JIZV6yFhUOOdolTC96pTV4BdDsZr23QbWRzTX7X2Kas=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
