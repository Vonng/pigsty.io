<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="/docs/pgsql/">
<link rel="alternate" type="application/rss&#43;xml" href="/docs/pgsql/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Module: PGSQL | Pigsty</title>
<meta name="description" content="The most advanced open-source relational database in the world with HA, PITR, IaC and more!">
<meta property="og:title" content="Module: PGSQL" />
<meta property="og:description" content="The most advanced open-source relational database in the world with HA, PITR, IaC and more!" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/pgsql/" />

<meta itemprop="name" content="Module: PGSQL">
<meta itemprop="description" content="The most advanced open-source relational database in the world with HA, PITR, IaC and more!"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Module: PGSQL"/>
<meta name="twitter:description" content="The most advanced open-source relational database in the world with HA, PITR, IaC and more!"/>




<link rel="preload" href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" as="style">
<link href="/scss/main.min.194607c777ee31a481a26dfc3d1c65134dfc8eb296a0aae9d353b3bd5be6a683.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script defer
  src="/js/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LG1V9WTKGE');
}
</script>
  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class="navbar-brand__name">Pigsty</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/docs/"><i class='fa-solid fa-book'></i><span>Docs</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/blog/"><i class="fas fa-blog"></i><span>Blog</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/Vonng/pigsty/" target="_blank" rel="noopener"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-language"></i>English</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/zh/docs/pgsql/">中文</a></li>
    </ul>
</div>
</li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.b40d8bc16bcda835248990ff9db38455.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/pgsql/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Module: PGSQL</h1>
<div class="lead">The most advanced open-source relational database in the world with HA, PITR, IaC and more!</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-ea3ddc89f231393b38923a59f1c6d742">Architecture</a></li>


    
  
    
    
	
<li>2: <a href="#pg-85b6224145fe3fe5038c58a93cf9de21">Users</a></li>


    
  
    
    
	
<li>3: <a href="#pg-77da146645a70d6fc90b1213d22e52d5">Databases</a></li>


    
  
    
    
	
<li>4: <a href="#pg-d9b0c31dfa75886b76d79a64b11591aa">Services</a></li>


    
  
    
    
	
<li>5: <a href="#pg-07d77c313c9a2410ca022115a263dafc">Extensions</a></li>


    
  
    
    
	
<li>6: <a href="#pg-d353f8b723fb78c622e9dd520898a3dd">Authentication</a></li>


    
  
    
    
	
<li>7: <a href="#pg-61c2dced240f3df23a0a7e039b04b7d6">Configuration</a></li>


    
  
    
    
	
<li>8: <a href="#pg-091b9f18681382583303e1ac5c7cea55">Playbook</a></li>


    
  
    
    
	
<li>9: <a href="#pg-7002dbf9503f9bb5f791aa73eb5fabe9">Administration</a></li>


    
  
    
    
	
<li>10: <a href="#pg-54447441a605cf594e517be7f37ae788">Access Control</a></li>


    
  
    
    
	
<li>11: <a href="#pg-cd0c200c9f6515f7a7ac9cc0f4b856bf">Backup &amp; PITR</a></li>


    
  
    
    
	
<li>12: <a href="#pg-9df6c956772e8cb04fe4f58165034338">Migration</a></li>


    
  
    
    
	
<li>13: <a href="#pg-d62cf100c93be858ce7b3c37726c8061">Monitoring</a></li>


    
  
    
    
	
<li>14: <a href="#pg-0ce334f57e9d6869b53659cc6bab754e">Dashboards</a></li>


    
  
    
    
	
<li>15: <a href="#pg-1f69b3f46163cb973f38581bf88a88a8">Metrics</a></li>


    
  
    
    
	
<li>16: <a href="#pg-06a73ab7adbd73b0e635c3d9403cab4e">FAQ</a></li>


    
  

    </ul>


<div class="content">
      <blockquote>
<p><strong>The most advanced open-source relational database in the world!</strong></p>
<p>With battery-included observability, reliability, and maintainability powered by Pigsty</p>
</blockquote>
<h2 id="concept">Concept</h2>
<blockquote>
<p>Overview of PostgreSQL in Pigsty</p>
</blockquote>
<ul>
<li><a href="/docs/pgsql/arch/">Architecture</a></li>
<li><a href="/docs/pgsql/conf">Configuration</a></li>
<li><a href="/docs/pgsql/extension/">Extensions</a></li>
<li><a href="/docs/pgsql/db/">Databases</a></li>
<li><a href="/docs/pgsql/user/">Users</a></li>
<li><a href="/docs/pgsql/svc/">Services</a></li>
<li><a href="/docs/pgsql/hba/">HBA Rules</a></li>
<li><a href="/docs/pgsql/acl/">Access Control</a></li>
<li><a href="/docs/pgsql/admin/">Administration</a></li>
<li><a href="/docs/pgsql/pitr/">Backup &amp; PITR</a></li>
<li><a href="/docs/pgsql/monitor/">Monitor</a></li>
<li><a href="/docs/pgsql/migration/">Migration</a></li>
</ul>
<hr>
<h2 id="configuration">Configuration</h2>
<blockquote>
<p><a href="/docs/pgsql/conf">Describe</a> the cluster you want</p>
</blockquote>
<ul>
<li><a href="/docs/pgsql/conf#identity">Identity</a>: Parameters used for describing a PostgreSQL cluster</li>
<li><a href="/docs/pgsql/conf#primary">Primary</a>: Define a single instance cluster</li>
<li><a href="/docs/pgsql/conf#replica">Replica</a>: Define a basic HA cluster with one primary &amp; one replica</li>
<li><a href="/docs/pgsql/conf#offline">Offline</a>: Define a dedicated instance for OLAP/ETL/Interactive queries.</li>
<li><a href="/docs/pgsql/conf#sync-standby">Sync Standby</a>: Enable synchronous commit to ensure no data loss</li>
<li><a href="/docs/pgsql/conf#quorum-commit">Quorum Commit</a>:   Use quorum sync commit for an even higher consistency level</li>
<li><a href="/docs/pgsql/conf#standby-cluster">Standby Cluster</a>: Clone an existing cluster and follow it</li>
<li><a href="/docs/pgsql/conf#delayed-cluster">Delayed Cluster</a>: Clone an existing cluster for emergency data recovery</li>
<li><a href="/docs/pgsql/conf#citus-cluster">Citus Cluster</a>: Define a Citus distributed database cluster</li>
<li><a href="/docs/pgsql/conf#major-version">Major Version</a>: Define a PostgreSQL cluster with specific major version</li>
</ul>
<hr>
<h2 id="administration">Administration</h2>
<blockquote>
<p><a href="/docs/pgsql/admin/">Admin</a> your existing clusters</p>
</blockquote>
<ul>
<li><a href="/docs/pgsql/admin/#cheatsheet"><code>Admin Cheatsheet</code></a></li>
<li><a href="/docs/pgsql/admin/#create-cluster"><code>Create Cluster</code></a></li>
<li><a href="/docs/pgsql/admin/#create-user"><code>Create User</code></a></li>
<li><a href="/docs/pgsql/admin/#create-database"><code>Create Database</code></a></li>
<li><a href="/docs/pgsql/admin/#reload-service"><code>Reload Service</code></a></li>
<li><a href="/docs/pgsql/admin/#reload-hbarule"><code>Reload HBARule</code></a></li>
<li><a href="/docs/pgsql/admin/#config-cluster"><code>Config Cluster</code></a></li>
<li><a href="/docs/pgsql/admin/#append-replica"><code>Append Replica</code></a></li>
<li><a href="/docs/pgsql/admin/#remove-replica"><code>Remove Replica</code></a></li>
<li><a href="/docs/pgsql/admin/#remove-cluster"><code>Remove Cluster</code></a></li>
<li><a href="/docs/pgsql/admin/#switchover"><code>Switchover Cluster</code></a></li>
<li><a href="/docs/pgsql/admin/#backup-cluster"><code>Backup Cluster</code></a></li>
<li><a href="/docs/pgsql/admin/#restore-cluster"><code>Restore Cluster</code></a></li>
</ul>
<hr>
<h2 id="playbook">Playbook</h2>
<blockquote>
<p>Materialize the cluster with idempotent <a href="/docs/pgsql/playbook/">playbooks</a></p>
</blockquote>
<ul>
<li><a href="/docs/pgsql/playbook/#pgsqlyml"><code>pgsql.yml</code></a> : Init HA PostgreSQL clusters or add new replicas.</li>
<li><a href="/docs/pgsql/playbook/#pgsql-rmyml"><code>pgsql-rm.yml</code></a> : Remove PostgreSQL cluster, or remove replicas</li>
<li><a href="/docs/pgsql/playbook/#pgsql-useryml"><code>pgsql-user.yml</code></a> : Add new business user to existing PostgreSQL cluster</li>
<li><a href="/docs/pgsql/playbook/#pgsql-dbyml"><code>pgsql-db.yml</code></a> : Add new business database to existing PostgreSQL cluster</li>
<li><a href="/docs/pgsql/playbook/#pgsql-monitoryml"><code>pgsql-monitor.yml</code></a> : Monitor remote PostgreSQL instance with local exporters</li>
<li><a href="/docs/pgsql/playbook/#pgsql-migrationyml"><code>pgsql-migration.yml</code></a> : Generate Migration manual &amp; scripts for existing PostgreSQL</li>
</ul>
<details><summary>Example: Install PGSQL module</summary>
<p><a href="https://asciinema.org/a/566417"><img alt="asciicast" src="https://asciinema.org/a/566417.svg"></a></p>
</details>
<details><summary>Example: Remove PGSQL module</summary>
<p><a href="https://asciinema.org/a/566418"><img alt="asciicast" src="https://asciinema.org/a/566418.svg"></a></p>
</details>
<hr>
<h2 id="dashboard">Dashboard</h2>
<p>There are 26 default grafana dashboards about PostgreSQL and categorized into 4 levels. Check <a href="/docs/pgsql/dashboard/">Dashboards</a> for details.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Overview</th>
<th style="text-align:center">Cluster</th>
<th style="text-align:center">Instance</th>
<th style="text-align:center">Database</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-overview">PGSQL Overview</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-cluster">PGSQL Cluster</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-instance">PGSQL Instance</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-database">PGSQL Database</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-alert">PGSQL Alert</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgrds-cluster">PGRDS Cluster</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgrds-instance">PGRDS Instance</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-database">PGCAT Database</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-shard">PGSQL Shard</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-activity">PGSQL Activity</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-instance">PGCAT Instance</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-tables">PGSQL Tables</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-replication">PGSQL Replication</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-persist">PGSQL Persist</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-table">PGSQL Table</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-service">PGSQL Service</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-proxy">PGSQL Proxy</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-table">PGCAT Table</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-databases">PGSQL Databases</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-pgbouncer">PGSQL Pgbouncer</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-query">PGSQL Query</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-patroni">PGSQL Patroni</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-session">PGSQL Session</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-query">PGCAT Query</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-pitr">PGSQL PITR</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-xacts">PGSQL Xacts</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-locks">PGCAT Locks</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-exporter">PGSQL Exporter</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-schema">PGCAT Schema</a></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="parameter">Parameter</h2>
<blockquote>
<p>API Reference for <a href="/docs/reference/param/#pgsql">PGSQL</a> module:</p>
</blockquote>
<ul>
<li><a href="/docs/reference/param/#pg_id"><code>PG_ID</code></a>               : Calculate &amp; Check Postgres Identity</li>
<li><a href="/docs/reference/param/#pg_business"><code>PG_BUSINESS</code></a>   : Postgres Business Object Definition</li>
<li><a href="/docs/reference/param/#pg_install"><code>PG_INSTALL</code></a>     : Install PGSQL Packages &amp; Extensions</li>
<li><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a> : Init a HA Postgres Cluster with Patroni</li>
<li><a href="/docs/reference/param/#pg_provision"><code>PG_PROVISION</code></a> : Create users, databases, and in-database objects</li>
<li><a href="/docs/reference/param/#pg_backup"><code>PG_BACKUP</code></a>       : Setup backup repo with pgbackrest</li>
<li><a href="/docs/reference/param/#pg_service"><code>PG_SERVICE</code></a>     : Exposing pg service, bind vip and register DNS</li>
<li><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a>   : Add Monitor for PGSQL Instance</li>
</ul>
<details><summary>Parameters</summary>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Section</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Level</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="/docs/reference/param/#pg_mode"><code>pg_mode</code></a></td>
<td><a href="/docs/reference/param/#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>pgsql cluster mode: pgsql,citus,gpsql</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_cluster"><code>pg_cluster</code></a></td>
<td><a href="/docs/reference/param/#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>pgsql cluster name, REQUIRED identity parameter</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_seq"><code>pg_seq</code></a></td>
<td><a href="/docs/reference/param/#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">I</td>
<td>pgsql instance seq number, REQUIRED identity parameter</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_role"><code>pg_role</code></a></td>
<td><a href="/docs/reference/param/#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">I</td>
<td>pgsql role, REQUIRED, could be primary,replica,offline</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_instances"><code>pg_instances</code></a></td>
<td><a href="/docs/reference/param/#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">dict</td>
<td style="text-align:center">I</td>
<td>define multiple pg instances on node in <code>{port:ins_vars}</code> format</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_upstream"><code>pg_upstream</code></a></td>
<td><a href="/docs/reference/param/#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">ip</td>
<td style="text-align:center">I</td>
<td>repl upstream ip addr for standby cluster or cascade replica</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_shard"><code>pg_shard</code></a></td>
<td><a href="/docs/reference/param/#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>pgsql shard name, optional identity for sharding clusters</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_group"><code>pg_group</code></a></td>
<td><a href="/docs/reference/param/#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">C</td>
<td>pgsql shard index number, optional identity for sharding clusters</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#gp_role"><code>gp_role</code></a></td>
<td><a href="/docs/reference/param/#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>greenplum role of this cluster, could be master or segment</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_exporters"><code>pg_exporters</code></a></td>
<td><a href="/docs/reference/param/#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">dict</td>
<td style="text-align:center">C</td>
<td>additional pg_exporters to monitor remote postgres instances</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_offline_query"><code>pg_offline_query</code></a></td>
<td><a href="/docs/reference/param/#pg_id"><code>PG_ID</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">I</td>
<td>set to true to enable offline query on this instance</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_users"><code>pg_users</code></a></td>
<td><a href="/docs/reference/param/#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">user[]</td>
<td style="text-align:center">C</td>
<td>postgres business users</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_databases"><code>pg_databases</code></a></td>
<td><a href="/docs/reference/param/#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">database[]</td>
<td style="text-align:center">C</td>
<td>postgres business databases</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_services"><code>pg_services</code></a></td>
<td><a href="/docs/reference/param/#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">service[]</td>
<td style="text-align:center">C</td>
<td>postgres business services</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_hba_rules"><code>pg_hba_rules</code></a></td>
<td><a href="/docs/reference/param/#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">hba[]</td>
<td style="text-align:center">C</td>
<td>business hba rules for postgres</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgb_hba_rules"><code>pgb_hba_rules</code></a></td>
<td><a href="/docs/reference/param/#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">hba[]</td>
<td style="text-align:center">C</td>
<td>business hba rules for pgbouncer</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_replication_username"><code>pg_replication_username</code></a></td>
<td><a href="/docs/reference/param/#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">username</td>
<td style="text-align:center">G</td>
<td>postgres replication username, <code>replicator</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_replication_password"><code>pg_replication_password</code></a></td>
<td><a href="/docs/reference/param/#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">password</td>
<td style="text-align:center">G</td>
<td>postgres replication password, <code>DBUser.Replicator</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_admin_username"><code>pg_admin_username</code></a></td>
<td><a href="/docs/reference/param/#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">username</td>
<td style="text-align:center">G</td>
<td>postgres admin username, <code>dbuser_dba</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_admin_password"><code>pg_admin_password</code></a></td>
<td><a href="/docs/reference/param/#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">password</td>
<td style="text-align:center">G</td>
<td>postgres admin password in plain text, <code>DBUser.DBA</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_monitor_username"><code>pg_monitor_username</code></a></td>
<td><a href="/docs/reference/param/#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">username</td>
<td style="text-align:center">G</td>
<td>postgres monitor username, <code>dbuser_monitor</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_monitor_password"><code>pg_monitor_password</code></a></td>
<td><a href="/docs/reference/param/#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">password</td>
<td style="text-align:center">G</td>
<td>postgres monitor password, <code>DBUser.Monitor</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_dbsu_password"><code>pg_dbsu_password</code></a></td>
<td><a href="/docs/reference/param/#pg_business"><code>PG_BUSINESS</code></a></td>
<td style="text-align:center">password</td>
<td style="text-align:center">G/C</td>
<td>dbsu password, empty string means no dbsu password by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_dbsu"><code>pg_dbsu</code></a></td>
<td><a href="/docs/reference/param/#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">username</td>
<td style="text-align:center">C</td>
<td>os dbsu name, postgres by default, better not change it</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_dbsu_uid"><code>pg_dbsu_uid</code></a></td>
<td><a href="/docs/reference/param/#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">C</td>
<td>os dbsu uid and gid, 26 for default postgres users and groups</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_dbsu_sudo"><code>pg_dbsu_sudo</code></a></td>
<td><a href="/docs/reference/param/#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>dbsu sudo privilege, none,limit,all,nopass. limit by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_dbsu_home"><code>pg_dbsu_home</code></a></td>
<td><a href="/docs/reference/param/#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>postgresql home directory, <code>/var/lib/pgsql</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_dbsu_ssh_exchange"><code>pg_dbsu_ssh_exchange</code></a></td>
<td><a href="/docs/reference/param/#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>exchange postgres dbsu ssh key among same pgsql cluster</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_version"><code>pg_version</code></a></td>
<td><a href="/docs/reference/param/#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>postgres major version to be installed, 16 by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_bin_dir"><code>pg_bin_dir</code></a></td>
<td><a href="/docs/reference/param/#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>postgres binary dir, <code>/usr/pgsql/bin</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_log_dir"><code>pg_log_dir</code></a></td>
<td><a href="/docs/reference/param/#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>postgres log dir, <code>/pg/log/postgres</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_packages"><code>pg_packages</code></a></td>
<td><a href="/docs/reference/param/#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">string[]</td>
<td style="text-align:center">C</td>
<td>pg packages to be installed, <code>${pg_version}</code> will be replaced</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_extensions"><code>pg_extensions</code></a></td>
<td><a href="/docs/reference/param/#pg_install"><code>PG_INSTALL</code></a></td>
<td style="text-align:center">string[]</td>
<td style="text-align:center">C</td>
<td>pg extensions to be installed, <code>${pg_version}</code> will be replaced</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_safeguard"><code>pg_safeguard</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">G/C/A</td>
<td>prevent purging running postgres instance? false by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_clean"><code>pg_clean</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">G/C/A</td>
<td>purging existing postgres during pgsql init? true by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_data"><code>pg_data</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>postgres data directory, <code>/pg/data</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_fs_main"><code>pg_fs_main</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>mountpoint/path for postgres main data, <code>/data</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_fs_bkup"><code>pg_fs_bkup</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>mountpoint/path for pg backup data, <code>/data/backup</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_storage_type"><code>pg_storage_type</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>storage type for pg main data, SSD,HDD, SSD by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_dummy_filesize"><code>pg_dummy_filesize</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">size</td>
<td style="text-align:center">C</td>
<td>size of <code>/pg/dummy</code>, hold 64MB disk space for emergency use</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_listen"><code>pg_listen</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">ip(s)</td>
<td style="text-align:center">C/I</td>
<td>postgres/pgbouncer listen addresses, comma separated list</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_port"><code>pg_port</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">port</td>
<td style="text-align:center">C</td>
<td>postgres listen port, 5432 by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_localhost"><code>pg_localhost</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>postgres unix socket dir for localhost connection</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_namespace"><code>pg_namespace</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>top level key namespace in etcd, used by patroni &amp; vip</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#patroni_enabled"><code>patroni_enabled</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>if disabled, no postgres cluster will be created during init</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#patroni_mode"><code>patroni_mode</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>patroni working mode: default,pause,remove</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#patroni_port"><code>patroni_port</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">port</td>
<td style="text-align:center">C</td>
<td>patroni listen port, 8008 by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#patroni_log_dir"><code>patroni_log_dir</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>patroni log dir, <code>/pg/log/patroni</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#patroni_ssl_enabled"><code>patroni_ssl_enabled</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">G</td>
<td>secure patroni RestAPI communications with SSL?</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#patroni_watchdog_mode"><code>patroni_watchdog_mode</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>patroni watchdog mode: automatic,required,off. off by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#patroni_username"><code>patroni_username</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">username</td>
<td style="text-align:center">C</td>
<td>patroni restapi username, <code>postgres</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#patroni_password"><code>patroni_password</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">password</td>
<td style="text-align:center">C</td>
<td>patroni restapi password, <code>Patroni.API</code> by default</td>
</tr>
<tr>
<td><a href="/docs/pgsql/#pg_primary_db"><code>pg_primary_db</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>primary database name, used by citus,etc&hellip; ,postgres by default</td>
</tr>
<tr>
<td><a href="/docs/pgsql/#pg_parameters"><code>pg_parameters</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">dict</td>
<td style="text-align:center">C</td>
<td>extra parameters in postgresql.auto.conf</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_conf"><code>pg_conf</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>config template: oltp,olap,crit,tiny. <code>oltp.yml</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_max_conn"><code>pg_max_conn</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">C</td>
<td>postgres max connections, <code>auto</code> will use recommended value</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_shared_buffer_ratio"><code>pg_shared_buffer_ratio</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">float</td>
<td style="text-align:center">C</td>
<td>postgres shared buffer memory ratio, 0.25 by default, 0.1~0.4</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_rto"><code>pg_rto</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">C</td>
<td>recovery time objective in seconds, <code>30s</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_rpo"><code>pg_rpo</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">C</td>
<td>recovery point objective in bytes, <code>1MiB</code> at most by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_libs"><code>pg_libs</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>preloaded libraries, <code>timescaledb,pg_stat_statements,auto_explain</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_delay"><code>pg_delay</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">interval</td>
<td style="text-align:center">I</td>
<td>replication apply delay for standby cluster leader</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_checksum"><code>pg_checksum</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>enable data checksum for postgres cluster?</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_pwd_enc"><code>pg_pwd_enc</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>passwords encryption algorithm: md5,scram-sha-256</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_encoding"><code>pg_encoding</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>database cluster encoding, <code>UTF8</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_locale"><code>pg_locale</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>database cluster local, <code>C</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_lc_collate"><code>pg_lc_collate</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>database cluster collate, <code>C</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_lc_ctype"><code>pg_lc_ctype</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>database character type, <code>en_US.UTF8</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgbouncer_enabled"><code>pgbouncer_enabled</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>if disabled, pgbouncer will not be launched on pgsql host</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgbouncer_port"><code>pgbouncer_port</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">port</td>
<td style="text-align:center">C</td>
<td>pgbouncer listen port, 6432 by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgbouncer_log_dir"><code>pgbouncer_log_dir</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>pgbouncer log dir, <code>/pg/log/pgbouncer</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgbouncer_auth_query"><code>pgbouncer_auth_query</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>query postgres to retrieve unlisted business users?</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgbouncer_poolmode"><code>pgbouncer_poolmode</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>pooling mode: transaction,session,statement, transaction by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgbouncer_sslmode"><code>pgbouncer_sslmode</code></a></td>
<td><a href="/docs/reference/param/#pg_bootstrap"><code>PG_BOOTSTRAP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>pgbouncer client ssl mode, disable by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_provision"><code>pg_provision</code></a></td>
<td><a href="/docs/reference/param/#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>provision postgres cluster after bootstrap</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_init"><code>pg_init</code></a></td>
<td><a href="/docs/reference/param/#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">G/C</td>
<td>provision init script for cluster template, <code>pg-init</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_default_roles"><code>pg_default_roles</code></a></td>
<td><a href="/docs/reference/param/#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">role[]</td>
<td style="text-align:center">G/C</td>
<td>default roles and users in postgres cluster</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_default_privileges"><code>pg_default_privileges</code></a></td>
<td><a href="/docs/reference/param/#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">string[]</td>
<td style="text-align:center">G/C</td>
<td>default privileges when created by admin user</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_default_schemas"><code>pg_default_schemas</code></a></td>
<td><a href="/docs/reference/param/#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">string[]</td>
<td style="text-align:center">G/C</td>
<td>default schemas to be created</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_default_extensions"><code>pg_default_extensions</code></a></td>
<td><a href="/docs/reference/param/#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">extension[]</td>
<td style="text-align:center">G/C</td>
<td>default extensions to be created</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_reload"><code>pg_reload</code></a></td>
<td><a href="/docs/reference/param/#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">A</td>
<td>reload postgres after hba changes</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_default_hba_rules"><code>pg_default_hba_rules</code></a></td>
<td><a href="/docs/reference/param/#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">hba[]</td>
<td style="text-align:center">G/C</td>
<td>postgres default host-based authentication rules</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgb_default_hba_rules"><code>pgb_default_hba_rules</code></a></td>
<td><a href="/docs/reference/param/#pg_provision"><code>PG_PROVISION</code></a></td>
<td style="text-align:center">hba[]</td>
<td style="text-align:center">G/C</td>
<td>pgbouncer default host-based authentication rules</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgbackrest_enabled"><code>pgbackrest_enabled</code></a></td>
<td><a href="/docs/reference/param/#pg_backup"><code>PG_BACKUP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>enable pgbackrest on pgsql host?</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgbackrest_clean"><code>pgbackrest_clean</code></a></td>
<td><a href="/docs/reference/param/#pg_backup"><code>PG_BACKUP</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>remove pg backup data during init?</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgbackrest_log_dir"><code>pgbackrest_log_dir</code></a></td>
<td><a href="/docs/reference/param/#pg_backup"><code>PG_BACKUP</code></a></td>
<td style="text-align:center">path</td>
<td style="text-align:center">C</td>
<td>pgbackrest log dir, <code>/pg/log/pgbackrest</code> by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgbackrest_method"><code>pgbackrest_method</code></a></td>
<td><a href="/docs/reference/param/#pg_backup"><code>PG_BACKUP</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>pgbackrest repo method: local,minio,etc&hellip;</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgbackrest_repo"><code>pgbackrest_repo</code></a></td>
<td><a href="/docs/reference/param/#pg_backup"><code>PG_BACKUP</code></a></td>
<td style="text-align:center">dict</td>
<td style="text-align:center">G/C</td>
<td>pgbackrest repo: <a href="https://pgbackrest.org/configuration.html#section-repository">https://pgbackrest.org/configuration.html#section-repository</a></td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_weight"><code>pg_weight</code></a></td>
<td><a href="/docs/reference/param/#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">I</td>
<td>relative load balance weight in service, 100 by default, 0-255</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_service_provider"><code>pg_service_provider</code></a></td>
<td><a href="/docs/reference/param/#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">G/C</td>
<td>dedicate haproxy node group name, or empty string for local nodes by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_default_service_dest"><code>pg_default_service_dest</code></a></td>
<td><a href="/docs/reference/param/#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">G/C</td>
<td>default service destination if svc.dest=&lsquo;default&rsquo;</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_default_services"><code>pg_default_services</code></a></td>
<td><a href="/docs/reference/param/#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">service[]</td>
<td style="text-align:center">G/C</td>
<td>postgres default service definitions</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_vip_enabled"><code>pg_vip_enabled</code></a></td>
<td><a href="/docs/reference/param/#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>enable a l2 vip for pgsql primary? false by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_vip_address"><code>pg_vip_address</code></a></td>
<td><a href="/docs/reference/param/#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">cidr4</td>
<td style="text-align:center">C</td>
<td>vip address in <code>&lt;ipv4&gt;/&lt;mask&gt;</code> format, require if vip is enabled</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_vip_interface"><code>pg_vip_interface</code></a></td>
<td><a href="/docs/reference/param/#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C/I</td>
<td>vip network interface to listen, eth0 by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_dns_suffix"><code>pg_dns_suffix</code></a></td>
<td><a href="/docs/reference/param/#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>pgsql dns suffix, &rsquo;&rsquo; by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_dns_target"><code>pg_dns_target</code></a></td>
<td><a href="/docs/reference/param/#pg_service"><code>PG_SERVICE</code></a></td>
<td style="text-align:center">enum</td>
<td style="text-align:center">C</td>
<td>auto, primary, vip, none, or ad hoc ip</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_exporter_enabled"><code>pg_exporter_enabled</code></a></td>
<td><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>enable pg_exporter on pgsql hosts?</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_exporter_config"><code>pg_exporter_config</code></a></td>
<td><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>pg_exporter configuration file name</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_exporter_cache_ttls"><code>pg_exporter_cache_ttls</code></a></td>
<td><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>pg_exporter collector ttl stage in seconds, &lsquo;1,10,60,300&rsquo; by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_exporter_port"><code>pg_exporter_port</code></a></td>
<td><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">port</td>
<td style="text-align:center">C</td>
<td>pg_exporter listen port, 9630 by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_exporter_params"><code>pg_exporter_params</code></a></td>
<td><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>extra url parameters for pg_exporter dsn</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_exporter_url"><code>pg_exporter_url</code></a></td>
<td><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">pgurl</td>
<td style="text-align:center">C</td>
<td>overwrite auto-generate pg dsn if specified</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_exporter_auto_discovery"><code>pg_exporter_auto_discovery</code></a></td>
<td><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>enable auto database discovery? enabled by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_exporter_exclude_database"><code>pg_exporter_exclude_database</code></a></td>
<td><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>csv of database that WILL NOT be monitored during auto-discovery</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_exporter_include_database"><code>pg_exporter_include_database</code></a></td>
<td><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">string</td>
<td style="text-align:center">C</td>
<td>csv of database that WILL BE monitored during auto-discovery</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_exporter_connect_timeout"><code>pg_exporter_connect_timeout</code></a></td>
<td><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">int</td>
<td style="text-align:center">C</td>
<td>pg_exporter connect timeout in ms, 200 by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pg_exporter_options"><code>pg_exporter_options</code></a></td>
<td><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">arg</td>
<td style="text-align:center">C</td>
<td>overwrite extra options for pg_exporter</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgbouncer_exporter_enabled"><code>pgbouncer_exporter_enabled</code></a></td>
<td><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">bool</td>
<td style="text-align:center">C</td>
<td>enable pgbouncer_exporter on pgsql hosts?</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgbouncer_exporter_port"><code>pgbouncer_exporter_port</code></a></td>
<td><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">port</td>
<td style="text-align:center">C</td>
<td>pgbouncer_exporter listen port, 9631 by default</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgbouncer_exporter_url"><code>pgbouncer_exporter_url</code></a></td>
<td><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">pgurl</td>
<td style="text-align:center">C</td>
<td>overwrite auto-generate pgbouncer dsn if specified</td>
</tr>
<tr>
<td><a href="/docs/reference/param/#pgbouncer_exporter_options"><code>pgbouncer_exporter_options</code></a></td>
<td><a href="/docs/reference/param/#pg_exporter"><code>PG_EXPORTER</code></a></td>
<td style="text-align:center">arg</td>
<td style="text-align:center">C</td>
<td>overwrite extra options for pgbouncer_exporter</td>
</tr>
</tbody>
</table>
</details>
<h2 id="tutorials">Tutorials</h2>
<ul>
<li>Fork an existing PostgreSQL cluster.</li>
<li>Create a standby cluster of an existing PostgreSQL cluster.</li>
<li>Create a delayed cluster of another pgsql cluster?</li>
<li>Monitoring an existing postgres instance?</li>
<li>Migration from an external PostgreSQL with logical replication?</li>
<li>Use MinIO as a central pgBackRest repo.</li>
<li>Use dedicate etcd cluster for DCS?</li>
<li>Use dedicated haproxy for exposing PostgreSQL service.</li>
<li>Deploy a multi-node MinIO cluster?</li>
<li>Use CMDB instead of Config as inventory.</li>
<li>Use PostgreSQL as grafana backend storage ?</li>
<li>Use PostgreSQL as prometheus backend storage ?</li>
</ul>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ea3ddc89f231393b38923a59f1c6d742">1 - Architecture</h1>
    <div class="lead">PostgreSQL cluster architectures and implmenetation details.</div>
	<hr>
<h2 id="component-overview">Component Overview</h2>
<p>Here is how PostgreSQL module components and their interactions. From top to bottom:</p>
<ul>
<li>Cluster DNS is resolved by DNSMASQ on infra nodes</li>
<li>Cluster VIP is manged by <code>vip-manager</code>, which will bind to cluster primary.
<ul>
<li><code>vip-manager</code> will acquire cluster leader info written by <code>patroni</code> from <code>etcd</code> cluster directly</li>
</ul>
</li>
<li>Cluster services are exposed by Haproxy on nodes, services are distinguished by node ports (543x).
<ul>
<li>Haproxy port 9101: monitoring metrics &amp; stats &amp; admin page</li>
<li>Haproxy port 5433: default service that routes to primary pgbouncer: <a href="/docs/pgsql/svc/#primary-service">primary</a></li>
<li>Haproxy port 5434: default service that routes to replica pgbouncer: <a href="/docs/pgsql/svc/#replica-service">replica</a></li>
<li>Haproxy port 5436: default service that routes to primary postgres: <a href="/docs/pgsql/svc/#default-service">default</a></li>
<li>Haproxy port 5438: default service that routeroutesto offline postgres: <a href="/docs/pgsql/svc/#offline-service">offline</a></li>
<li>HAProxy will route traffic based on health check information provided by <code>patroni</code>.</li>
</ul>
</li>
<li>Pgbouncer is a connection pool middleware that buffers connections, exposes extra metrics, and brings extra flexibility @ port 6432
<ul>
<li>Pgbouncer is stateless and deployed with the Postgres server in a 1:1 manner through a local unix socket.</li>
<li>Production traffic (Primary/Replica) will go through pgbouncer by default (can be skipped by <a href="/docs/reference/param/#pg_default_service_dest"><code>pg_default_service_dest</code></a> )</li>
<li>Default/Offline service will always bypass pgbouncer and connect to target Postgres directly.</li>
</ul>
</li>
<li>Postgres provides relational database services @ port 5432
<ul>
<li>Install PGSQL module on multiple nodes will automatically form a HA cluster based on streaming replication</li>
<li>PostgreSQL is supervised by <code>patroni</code> by default.</li>
</ul>
</li>
<li>Patroni will <strong>supervise</strong> PostgreSQL server @ port 8008 by default
<ul>
<li>Patroni spawn postgres servers as the child process</li>
<li>Patroni uses <code>etcd</code> as DCS: config storage, failure detection, and leader election.</li>
<li>Patroni will provide Postgres information through a health check. Which is used by HAProxy</li>
<li>Patroni metrics will be scraped by prometheus on infra nodes</li>
</ul>
</li>
<li>PG Exporter will expose postgres metrics @ port 9630
<ul>
<li>PostgreSQL&rsquo;s metrics will be scraped by prometheus on infra nodes</li>
</ul>
</li>
<li>Pgbouncer Exporter will expose pgbouncer metrics @ port 9631
<ul>
<li>Pgbouncer&rsquo;s metrics will be scraped by prometheus on infra nodes</li>
</ul>
</li>
<li>pgBackRest will work on the local repo by default (<a href="/docs/reference/param/#pgbackrest_method"><code>pgbackrest_method</code></a>)
<ul>
<li>If <code>local</code> (default) is used as the backup repo, pgBackRest will create local repo under the primary&rsquo;s <a href="/docs/reference/param/#pg_fs_bkup"><code>pg_fs_bkup</code></a></li>
<li>If <code>minio</code> is used as the backup repo, pgBackRest will create the repo on the dedicated MinIO cluster in <a href="/docs/reference/param/#pgbackrest_repo"><code>pgbackrest_repo</code>.<code>minio</code></a></li>
</ul>
</li>
<li>Postgres-related logs (postgres,pgbouncer,patroni,pgbackrest) are exposed by promtail @ port 9080
<ul>
<li>Promtail will send logs to Loki on infra nodes</li>
</ul>
</li>
</ul>
<p><a href="/docs/infra/"><img alt="pigsty-arch.jpg" src="/img/pigsty/arch.jpg"></a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-85b6224145fe3fe5038c58a93cf9de21">2 - Users</h1>
    <div class="lead">Define business users &amp; roles in PostgreSQL, which is the object created by SQL <code>CREATE USER/ROLE</code></div>
	<blockquote>
<p>In this context, the <strong>User</strong> refers to objects created by SQL <code>CREATE USER/ROLE</code>.</p>
</blockquote>
<hr>
<h2 id="define-user">Define User</h2>
<p>There are two parameters related to users:</p>
<ul>
<li><a href="/docs/reference/param/#pg_users"><code>pg_users</code></a> : Define business users &amp; roles at cluster level</li>
<li><a href="/docs/reference/param/#pg_default_roles"><code>pg_default_roles</code></a> : Define system-wide roles &amp; global users at global level</li>
</ul>
<p>They are both arrays of user/role definition. You can define multiple users/roles in one cluster.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_meta     ,password: DBUser.Meta     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">read-only viewer for meta database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_grafana  ,password: DBUser.Grafana  ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for grafana database    }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_bytebase ,password: DBUser.Bytebase ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for bytebase database   }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_kong     ,password: DBUser.Kong     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for kong api gateway    }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_gitea    ,password: DBUser.Gitea    ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for gitea service       }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_wiki     ,password: DBUser.Wiki     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for wiki.js service     }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">name: dbuser_noco     ,password: DBUser.Noco     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin user for nocodb service      }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>And each user definition may look like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_meta              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># REQUIRED, `name` is the only mandatory field of a user definition</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Meta          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, password, can be a scram-sha-256 hash string or plain text</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">login</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># optional, can log in, true by default  (new biz ROLE should be false)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">superuser</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># optional, is superuser? false by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">createdb</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># optional, can create database? false by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">createrole</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic"># optional, can create role? false by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">inherit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># optional, can this role use inherited privileges? true by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replication</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic"># optional, can this role do replication? false by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bypassrls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># optional, can this role bypass row level security? false by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pgbouncer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># optional, add this user to pgbouncer user-list? false by default (production user should be true explicitly)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># optional, user connection limit, default -1 disable limit</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">expire_in</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3650</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># optional, now + n days when this role is expired (OVERWRITE expire_at)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">expire_at</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;2030-12-31&#39;</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># optional, YYYY-MM-DD &#39;timestamp&#39; when this role is expired  (OVERWRITTEN by expire_in)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty admin user     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, comment string for this user/role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">roles: [dbrole_admin]           # optional, belonged roles. default roles are</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_{admin,readonly,readwrite,offline}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># optional, role level parameters with `ALTER ROLE SET`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">transaction         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, pgbouncer pool mode at user level, transaction by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool_connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic"># optional, max database connections at user level, default -1 disable limit</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">search_path: public             # key value config parameters according to postgresql documentation (e.g</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">use pigsty as default search_path)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>The only required field is <code>name</code>, which should be a valid &amp; unique username in PostgreSQL.</li>
<li>Roles don&rsquo;t need a <code>password</code>, while it could be necessary for a login-able user.</li>
<li>The <code>password</code> can be plain text or a scram-sha-256 / md5 hash string.</li>
<li>User/Role are created one by one in array order. So make sure role/group definition is ahead of its members</li>
<li><code>login</code>, <code>superuser</code>, <code>createdb</code>, <code>createrole</code>, <code>inherit</code>, <code>replication</code>, <code>bypassrls</code> are boolean flags</li>
<li><code>pgbouncer</code> is disabled by default. To add a business user to the pgbouncer user-list, you should set it to <code>true</code> explicitly.</li>
</ul>
<p><strong>ACL System</strong></p>
<p>Pigsty has a battery-included <a href="/docs/pgsql/acl/">ACL</a> system, which can be easily used by assigning roles to users:</p>
<ul>
<li><code>dbrole_readonly</code> : The role for global read-only access</li>
<li><code>dbrole_readwrite</code> : The role for global read-write access</li>
<li><code>dbrole_admin</code> : The role for object creation</li>
<li><code>dbrole_offline</code> : The role for restricted read-only access (<a href="/docs/pgsql/conf#offline">offline</a> instance)</li>
</ul>
<p>If you wish to re-design your ACL system, check the following parameters &amp; templates.</p>
<ul>
<li><a href="/docs/reference/param/#pg_default_roles"><code>pg_default_roles</code></a> : System-wide roles &amp; global users</li>
<li><a href="/docs/reference/param/#pg_default_privileges"><code>pg_default_privileges</code></a> : Default privileges for newly created objects</li>
<li><a href="https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-role.sql"><code>roles/pgsql/templates/pg-init-role.sql</code></a>: Role creation SQL template</li>
<li><a href="https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql"><code>roles/pgsql/templates/pg-init-template.sql</code></a>: Privilege SQL template</li>
</ul>
<hr>
<h2 id="create-user">Create User</h2>
<p>Users &amp; Roles <a href="/docs/pgsql/user/#define-user">defined</a> in <a href="/docs/reference/param/#pg_default_roles"><code>pg_default_roles</code></a> and <a href="/docs/reference/param/#pg_users"><code>pg_users</code></a> will be automatically created one by one during cluster bootstrap.</p>
<p>If you wish to <a href="/docs/pgsql/admin/#create-user">create user</a> on an existing cluster, the <code>bin/pgsql-user</code> util can be used.</p>
<p>Add new user definition to <code>all.children.&lt;cls&gt;.pg_users</code>, and create that database with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;    <span style="color:#8f5902;font-style:italic"># pgsql-user.yml -l &lt;cls&gt; -e username=&lt;username&gt;</span>
</span></span></code></pre></div><p>The playbook is idempotent, so it&rsquo;s ok to run this multiple times on the existing cluster.</p>


<div class="alert alert-secondary" role="alert">
<h4 class="alert-heading">Create User with Playbook!</h4>

    If you are using the default pgbouncer, You <strong>MUST</strong> create new users with <code>bin/pgsql-user</code> util, or <code>pgsql-user.yml</code> playbook,
The playbook will add and configure database user to the <a href="/docs/pgsql/user/#pgbouncer-user">pgbouncer userlist</a> for your.

</div>

<hr>
<h2 id="pgbouncer-user">Pgbouncer User</h2>
<p>Pgbouncer is enabled by default and serves as a connection pool middleware, and its user is managed by default.</p>
<p>Pigsty will add all users in <a href="/docs/reference/param/#pg_users"><code>pg_users</code></a> with <code>pgbouncer: true</code> flag to the pgbouncer userlist by default.</p>
<p>The user is listed in <code>/etc/pgbouncer/userlist.txt</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">&#34;postgres&#34; &#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_wiki&#34; &#34;SCRAM-SHA-256$4096:+77dyhrPeFDT/TptHs7/7Q</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$KeatuohpKIYzHPCt/tqBu85vI11o9mar/by0hHYM2W8=:X9gig4JtjoS8Y/o1vQsIX/gY1Fns8ynTXkbWOjUfbRQ=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_view&#34; &#34;SCRAM-SHA-256$4096:DFoZHU/DXsHL8MJ8regdEw</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$gx9sUGgpVpdSM4o6A2R9PKAUkAsRPLhLoBDLBUYtKS0=:MujSgKe6rxcIUMv4GnyXJmV0YNbf39uFRZv724+X1FE=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_monitor&#34; &#34;SCRAM-SHA-256$4096:fwU97ZMO/KR0ScHO5+UuBg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$CrNsmGrx1DkIGrtrD1Wjexb/aygzqQdirTO1oBZROPY=:L8+dJ+fqlMQh7y4PmVR/gbAOvYWOr+KINjeMZ8LlFww=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_meta&#34; &#34;SCRAM-SHA-256$4096:leB2RQPcw1OIiRnPnOMUEg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$eyC+NIMKeoTxshJu314+BmbMFpCcspzI3UFZ1RYfNyU=:fJgXcykVPvOfro2MWNkl5q38oz21nSl1dTtM65uYR1Q=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_kong&#34; &#34;SCRAM-SHA-256$4096:bK8sLXIieMwFDz67/0dqXQ</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$P/tCRgyKx9MC9LH3ErnKsnlOqgNd/nn2RyvThyiK6e4=:CDM8QZNHBdPf97ztusgnE7olaKDNHBN0WeAbP/nzu5A=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_grafana&#34; &#34;SCRAM-SHA-256$4096:HjLdGaGmeIAGdWyn2gDt/Q</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$jgoyOB8ugoce+Wqjr0EwFf8NaIEMtiTuQTg1iEJs9BM=:ed4HUFqLyB4YpRr+y25FBT7KnlFDnan6JPVT9imxzA4=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_gitea&#34; &#34;SCRAM-SHA-256$4096:l1DBGCc4dtircZ8O8Fbzkw</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$tpmGwgLuWPDog8IEKdsaDGtiPAxD16z09slvu+rHE74=:pYuFOSDuWSofpD9OZhG7oWvyAR0PQjJBffgHZLpLHds=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_dba&#34; &#34;SCRAM-SHA-256$4096:zH8niABU7xmtblVUo2QFew</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$Zj7/pq+ICZx7fDcXikiN7GLqkKFA+X5NsvAX6CMshF0=:pqevR2WpizjRecPIQjMZOm+Ap+x0kgPL2Iv5zHZs0+g=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">&#34;dbuser_bytebase&#34; &#34;SCRAM-SHA-256$4096:OMoTM9Zf8QcCCMD0svK5gg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">=$kMchqbf4iLK1U67pVOfGrERa/fY818AwqfBPhsTShNQ=:6HqWteN+AadrUnrgC0byr5A72noqnPugItQjOLFw0Wk=&#34;</span>
</span></span></code></pre></div><p>And user level parameters are listed in <code>/etc/pgbouncer/useropts.txt</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">dbuser_dba</span>                  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">pool_mode=session max_user_connections=16</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">dbuser_monitor</span>              <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">pool_mode=session max_user_connections=8</span>
</span></span></code></pre></div><p>The userlist &amp; useropts file will be updated automatically when you add a new user with <code>pgsql-user</code> util, or <code>pgsql-user.yml</code> playbook.</p>
<p>You can use <a href="/docs/reference/param/#pgbouncer_auth_query"><code>pgbouncer_auth_query</code></a> to simplify pgbouncer user management (with the cost of reliability &amp; security).</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-77da146645a70d6fc90b1213d22e52d5">3 - Databases</h1>
    <div class="lead">Define business databases in PostgreSQL, which is the object create by SQL <code>CREATE DATABASE</code></div>
	<blockquote>
<p>In this context, Database refers to the object created by SQL <code>CREATE DATABASE</code>.</p>
</blockquote>
<p>A PostgreSQL server can serve multiple databases simultaneously. And you can customize each database with Pigsty API.</p>
<hr>
<h2 id="define-database">Define Database</h2>
<p>Business databases are defined by <a href="/docs/reference/param/#pg_databases"><code>pg_databases</code></a>, which is a cluster-level parameter.</p>
<p>For example, the default <code>meta</code> database is defined in the <code>pg-meta</code> cluster:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#204a87;font-weight:bold">name: postgis, schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">public}, {name: timescaledb}]}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: grafana  ,owner: dbuser_grafana  ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">grafana primary database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: bytebase ,owner: dbuser_bytebase ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bytebase primary database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: kong     ,owner: dbuser_kong     ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kong the api gateway database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: gitea    ,owner: dbuser_gitea    ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gitea meta database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: wiki     ,owner: dbuser_wiki     ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wiki meta database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: noco     ,owner: dbuser_noco     ,revokeconn: true ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nocodb database }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Each database definition is a dict with the following fields:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta                     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># REQUIRED, `name` is the only mandatory field of a database definition</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">baseline</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cmdb.sql             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, database sql baseline path, (relative path among ansible search path, e.g files/)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pgbouncer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># optional, add this database to pgbouncer database list? true by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">schemas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pigsty]              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, additional schemas to be created, array of schema names</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">extensions:                     # optional, additional extensions to be installed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">array of `{name[,schema]}`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: postgis , schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">public }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">timescaledb }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pigsty meta database  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, comment string for this database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres                </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, database owner, postgres by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">template1            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, which template to use, template1 by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">encoding</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UTF8                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, database encoding, UTF8 by default. (MUST same as template database)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">locale</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">C                      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, database locale, C by default.  (MUST same as template database)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">lc_collate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">C                  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, database collate, C by default. (MUST same as template database)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">lc_ctype</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">C                    </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, database ctype, C by default.   (MUST same as template database)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">tablespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_default         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, default tablespace, &#39;pg_default&#39; by default.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">allowconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># optional, allow connection, true by default. false will disable connect at all</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">revokeconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic"># optional, revoke public connection privilege. false by default. (leave connect with grant option to owner)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">register_datasource</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># optional, register this database to grafana datasources? true by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># optional, database connection limit, default -1 disable limit</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool_auth_user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_meta    </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, all connection to this pgbouncer database will be authenticated by this user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">transaction         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, pgbouncer pool mode at database level, default transaction</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># optional, pgbouncer pool size at database level, default 64</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool_size_reserve</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># optional, pgbouncer pool size reserve at database level, default 32</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool_size_min</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># optional, pgbouncer pool size min at database level, default 0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool_max_db_conn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># optional, max database connections at database level, default 100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>The only required field is <code>name</code>, which should be a valid and unique database name in PostgreSQL.</p>
<p>Newly created databases are forked from <code>template1</code> database by default. which is customized by <a href="/docs/reference/param/#pg_provision"><code>PG_PROVISION</code></a> during cluster bootstrap.</p>
<p>Check <a href="/docs/pgsql/acl/#database-privilege">ACL: Database Privilege</a> for details about database-level privilege.</p>
<hr>
<h2 id="create-database">Create Database</h2>
<p>Databases <a href="/docs/pgsql/db/#define-database">defined</a> in <a href="/docs/reference/param/#pg_databases"><code>pg_databases</code></a> will be automatically created during cluster bootstrap.</p>
<p>If you wish to <a href="/docs/pgsql/admin/#create-database">create database</a> on an existing cluster, the <code>bin/pgsql-db</code> util can be used.</p>
<p>Add new database definition to <code>all.children.&lt;cls&gt;.pg_databases</code>, and create that database with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-db &lt;cls&gt; &lt;dbname&gt;    <span style="color:#8f5902;font-style:italic"># pgsql-db.yml -l &lt;cls&gt; -e dbname=&lt;dbname&gt;</span>
</span></span></code></pre></div><p>It&rsquo;s usually not a good idea to execute this on the existing database again when a <code>baseline</code> script is used.</p>
<p>If you are using the default pgbouncer as the proxy middleware, YOU MUST create the new database with <code>pgsql-db</code> util or <code>pgsql-db.yml</code> playbook. Otherwise, the new database will not be added to the <a href="/docs/pgsql/db/#pgbouncer-database">pgbouncer database</a> list.</p>
<p>Remember, if your database definition has a non-trivial <code>owner</code> (dbsu <code>postgres</code> by default ), make sure the owner user exists.
That is to say, always <a href="/docs/pgsql/admin/#create-user">create</a> the <a href="/docs/pgsql/user/">user</a> before the database.</p>
<hr>
<h2 id="pgbouncer-database">Pgbouncer Database</h2>
<p>Pgbouncer is enabled by default and serves as a connection pool middleware.</p>
<p>Pigsty will add all databases in <a href="/docs/reference/param/#pg_databases"><code>pg_databases</code></a> to the pgbouncer database list by default.
You can disable the pgbouncer proxy for a specific database by setting <code>pgbouncer: false</code> in the database <a href="/docs/pgsql/db/#define-database">definition</a>.</p>
<p>The database is listed in <code>/etc/pgbouncer/database.txt</code>, with extra database-level parameters such as:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#c4a000">meta</span>                        <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">host=/var/run/postgresql mode=session</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">grafana</span>                     <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">host=/var/run/postgresql mode=transaction</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">bytebase</span>                    <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">host=/var/run/postgresql auth_user=dbuser_meta</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">kong</span>                        <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">host=/var/run/postgresql pool_size=32 reserve_pool=64</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">gitea</span>                       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">host=/var/run/postgresql min_pool_size=10</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">wiki</span>                        <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">host=/var/run/postgresql</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">noco</span>                        <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">host=/var/run/postgresql</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">mongo</span>                       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">host=/var/run/postgresql</span>
</span></span></code></pre></div><p>The Pgbouncer database list will be updated when <a href="/docs/pgsql/db/#create-database">create database</a> with Pigsty util &amp; playbook.</p>
<p>To access pgbouncer administration functionality, you can use the <code>pgb</code> alias as dbsu.</p>
<p>There&rsquo;s a util function defined in <code>/etc/profile.d/pg-alias.sh</code>, allowing you to reroute pgbouncer database traffic to a new host quickly, which can be used during zero-downtime migration.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># route pgbouncer traffic to another cluster member</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> pgb-route<span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">local</span> <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">1</span><span style="color:#000;font-weight:bold">-</span><span style="color:#4e9a06">&#39;\/var\/run\/postgresql&#39;</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>  sed -ie <span style="color:#4e9a06">&#34;s/host=[^[:space:]]\+/host=</span><span style="color:#4e9a06">${</span><span style="color:#000">ip</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/g&#34;</span> /etc/pgbouncer/pgbouncer.ini
</span></span><span style="display:flex;"><span>  cat /etc/pgbouncer/pgbouncer.ini
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d9b0c31dfa75886b76d79a64b11591aa">4 - Services</h1>
    <div class="lead">Define and create new services, and expose them via haproxy</div>
	<hr>
<h2 id="service-implementation">Service Implementation</h2>
<p>In Pigsty, services are implemented using <a href="/docs/reference/param/#haproxy">haproxy</a> on <a href="/docs/node/">nodes</a>, differentiated by different ports on the host node.</p>
<p>Every node has Haproxy enabled to expose services. From the database perspective, nodes in the cluster may be primary or replicas, but from the service perspective, all nodes are the same. This means even if you access a replica node, as long as you use the correct service port, you can still use the primary&rsquo;s read-write service. This design seals the complexity: as long as you can access any instance on the PostgreSQL cluster, you can fully access all services.</p>
<p>This design is akin to the NodePort service in Kubernetes. Similarly, in Pigsty, every service includes these two core elements:</p>
<ol>
<li>Access endpoints exposed via NodePort (port number, from where to access?)</li>
<li>Target instances chosen through Selectors (list of instances, who will handle it?)</li>
</ol>
<p>The boundary of Pigsty&rsquo;s service delivery stops at the cluster&rsquo;s HAProxy. Users can access these load balancers in various ways. Please refer to <a href="/docs/concept/svc/#access-service">Access Service</a>.</p>
<p>All services are declared through configuration files. For instance, the default PostgreSQL service is defined by the <a href="/docs/reference/param/#pg_default_services"><code>pg_default_services</code></a> parameter:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">, backup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">, backup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You can also define new service in <a href="/docs/reference/param/#pg_services"><code>pg_services</code></a>. And <code>pg_default_services</code> 与 <code>pg_services</code> are both array of <a href="/docs/pgsql/svc/#define-service">Service Definition</a>.</p>
<hr>
<h2 id="define-service">Define Service</h2>
<p>The default services are defined in <a href="/docs/reference/param/#pg_default_services"><code>pg_default_services</code></a>.</p>
<p>While you can define your extra PostgreSQL services with <a href="/docs/reference/param/#pg_services"><code>pg_services</code></a> @ the global or cluster level.</p>
<p>These two parameters are both arrays of service objects. Each service definition will be rendered as a haproxy config in <code>/etc/haproxy/&lt;svcname&gt;.cfg</code>, check <a href="https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/service.j2"><code>service.j2</code></a> for details.</p>
<p>Here is an example of an extra service definition: <code>standby</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name: standby                   # required, service name, the actual svc name will be prefixed with `pg_cluster`, e.g</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta-standby</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5435</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#8f5902;font-style:italic"># required, service exposed port (work as kubernetes service node port mode)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#8f5902;font-style:italic"># optional, service bind ip address, `*` for all ip by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># required, service member selector, use JMESPath to filter inventory</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dest</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default                  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, destination port, default|postgres|pgbouncer|&lt;port_number&gt;, &#39;default&#39; by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">check</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/sync                   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, health check url path, / by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">backup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `primary`]&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># backup server selector</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">maxconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># optional, max allowed front-end connection</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">balance: roundrobin             # optional, haproxy load balance algorithm (roundrobin by default, other</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">leastconn)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>And it will be translated to a haproxy config file <code>/etc/haproxy/pg-test-standby.conf</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#---------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># service: pg-test-standby @ 10.10.10.11:5435</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#---------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># service instances 10.10.10.11, 10.10.10.13, 10.10.10.12</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># service backups   10.10.10.11</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">listen pg-test-standby</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">bind *:5435</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">mode tcp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">maxconn 5000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">balance roundrobin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">option httpchk</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">option http-keep-alive</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">http-check send meth OPTIONS uri /sync  # &lt;--- true for primary &amp; sync standby</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">http-check expect status 200</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># servers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">server pg-test-1 10.10.10.11:6432 check port 8008 weight 100 backup   # the primary is used as backup server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">server pg-test-3 10.10.10.13:6432 check port 8008 weight 100</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c4a000">server pg-test-2 10.10.10.12:6432 check port 8008 weight 100</span>
</span></span></code></pre></div><hr>
<h2 id="reload-service">Reload Service</h2>
<p>When cluster membership has changed, such as append / remove replicas, switchover/failover, or adjust relative weight,
You have to <a href="/docs/pgsql/admin/#reload-service">reload service</a> to make the changes take effect.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-svc &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>ip...<span style="color:#ce5c00;font-weight:bold">]</span>         <span style="color:#8f5902;font-style:italic"># reload service for lb cluster or lb instance</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ./pgsql.yml -t pg_service         # the actual ansible task to reload service</span>
</span></span></code></pre></div><hr>
<h2 id="override-service">Override Service</h2>
<p>You can override default service configuration with several ways:</p>
<p><strong>Bypass Pgbouncer</strong></p>
<p>When defining a service, if <code>svc.dest='default'</code>, this parameter <a href="/docs/reference/param/#pg_default_service_dest"><code>pg_default_service_dest</code></a> will be used as the default value.
<code>pgbouncer</code> is used by default, you can use <code>postgres</code> instead, so the default primary &amp; replica service will bypass pgbouncer and route traffic to postgres directly</p>
<p>If you don&rsquo;t need connection pooling at all, you can change <a href="/docs/reference/param/#pg_default_service_dest"><code>pg_default_service_dest</code></a> to <code>postgres</code>, and remove <code>default</code> and <code>offline</code> services.</p>
<p>If you don&rsquo;t need read-only replicas for online traffic, you can remove <code>replica</code> from <code>pg_default_services</code> too.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_default_services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">, backup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">, backup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="delegate-service">Delegate Service</h2>
<p>Pigsty expose PostgreSQL services with haproxy on node. All haproxy instances among the cluster are configured with the same service definition.</p>
<p>However, you can delegate pg service to a specific node group (e.g. dedicate haproxy lb cluster) rather than cluster members.</p>
<p>To do so, you will have to override the default service definition with <a href="/docs/reference/param/#pg_default_services"><code>pg_default_services</code></a> and set <a href="/docs/reference/param/#pg_service_provider"><code>pg_service_provider</code></a> to the proxy group name.</p>
<p>For example, this configuration will expose pg cluster primary service on haproxy node group <code>proxy</code> with port 10013.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_service_provider</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">proxy      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># use load balancer on group `proxy` with port 10013</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_default_services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: primary ,port: 10013 ,dest: postgres  ,check: /primary   ,selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;[]&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>It&rsquo;s user&rsquo;s responsibility to make sure each delegate service port is <strong>unique</strong> among the proxy cluster.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-07d77c313c9a2410ca022115a263dafc">5 - Extensions</h1>
    <div class="lead">Define, Create, Install, Enable Extensions in Pigsty</div>
	<p>Extensions are the soul of PostgreSQL, and Pigsty deeply integrates the core extension plugins of the PostgreSQL ecosystem, providing you with battery-included distributed temporal, geospatial text, graph, and vector database capabilities! Check <a href="/docs/pgsql/extension/#extension-list"><strong>extension list</strong></a> for details.</p>
<p>Pigsty includes over <strong>340</strong> PostgreSQL extension plugins and has compiled, packaged, integrated, and maintained many extensions not included in the official PGDG source.
It also ensures through thorough testing that all these plugins can work together seamlessly. Including some potent extensions:</p>
<ul>
<li>PostGIS: Add geospatial data support to PostgreSQL</li>
<li>TimescaleDB: Add time-series/continuous-aggregation support to PostgreSQL</li>
<li>PGVector: AI vector/embedding data type support, and ivfflat / hnsw index access method</li>
<li>Citus: Turn a standalone primary-replica postgres cluster into a horizontally scalable distributed cluster</li>
<li>Apache AGE: Add OpenCypher graph query language support to PostgreSQL, works like Neo4J</li>
<li>PG GraphQL: Add GraphQL language support to PostgreSQL</li>
<li>zhparser : Add Chinese word segmentation support to PostgreSQL, works like ElasticSearch</li>
<li><a href="https://github.com/Vonng/pigsty/tree/master/app/supabase">Supabase</a>: Open-Source Firebase alternative based on PostgreSQL</li>
<li><a href="https://github.com/Vonng/pigsty/tree/master/app/ferretdb">FerretDB</a>: Open-Source MongoDB alternative based on PostgreSQL</li>
<li><a href="https://github.com/Vonng/pigsty/tree/master/app/pgml">PostgresML</a>: Use machine learning algorithms and pretrained models with SQL</li>
<li><a href="https://www.paradedb.com/">ParadeDB</a>: Open-Source ElasticSearch Alternative (based on PostgreSQL)</li>
</ul>
<p>Plugins are already included and placed in the yum repo of the infra nodes, which can be directly enabled through PGSQL <a href="/docs/pgsql/extension/#install-extension">Cluster Config</a>. Pigsty also introduces a complete compilation environment and infrastructure, allowing you to <a href="https://github.com/Vonng/pigsty-rpm">compile extensions</a> not included in Pigsty &amp; PGDG.</p>
<p><img alt="pigsty-ecosystem.jpg" src="/img/pigsty/ecosystem.jpg"></p>
<p>Some &ldquo;database&rdquo; are not actual PostgreSQL extensions, but also supported by pigsty, such as:</p>
<ul>
<li><a href="https://github.com/Vonng/pigsty/tree/master/app/supabase">Supabase</a>: Open-Source Firebase Alternative (based on PostgreSQL)</li>
<li><a href="https://github.com/Vonng/pigsty/tree/master/app/ferretdb">FerretDB</a>: Open-Source MongoDB Alternative (based on PostgreSQL)</li>
<li><a href="https://github.com/Vonng/pigsty/tree/master/app/nocodb">NocoDB</a>: Open-Source Airtable Alternative (based on PostgreSQL)</li>
<li><a href="https://github.com/Vonng/pigsty/tree/master/app/duckdb">DuckDB</a>: Open-Source Analytical SQLite Alternative (PostgreSQL Compatible)</li>
</ul>
<hr>
<h2 id="install-extension">Install Extension</h2>
<p>When you init a PostgreSQL cluster, the extensions listed in <a href="/docs/reference/param/#pg_packages"><code>pg_packages</code></a> &amp; <a href="/docs/reference/param/#pg_extension"><code>pg_extensions</code></a> will be installed.</p>
<p>For default EL systems, the default values of <code>pg_packages</code> and <code>pg_extensions</code> are defined as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_packages:     # these extensions are always installed by default </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_repack, wal2json, passwordcheck_cracklib</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">pg_repack_$v* wal2json_$v* passwordcheck_cracklib_$v*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># important extensions</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># install postgis, timescaledb, pgvector by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">postgis34_$v* timescaledb-2-postgresql-$v* pgvector_$v*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>For ubuntu / debian, package names are different, and <code>passwordcheck_cracklib</code> is not available.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_packages:    # these extensions are always installed by default </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_repack, wal2json</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">postgresql-$v-repack postgresql-$v-wal2json</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># these extensions are installed by default:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">postgresql-$v-postgis* timescaledb-2-postgresql-$v postgresql-$v-pgvector postgresql-$v-citus-12.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Here, <code>$v</code> is a placeholder that will be replaced with the actual major version number <a href="/docs/reference/param/#pg_version"><code>pg_version</code></a> of that PostgreSQL cluster
Therefore, the default configuration will install these extensions:</p>
<ul>
<li><code>pg_repack</code>: Extension for online table bloat processing.</li>
<li><code>wal2json</code>: Extracts changes in JSON format through logical decoding.</li>
<li><code>passwordcheck_cracklib</code>: Enforce password policy. (EL only)</li>
<li><code>postgis</code>: Geospatial database extension (postgis34, EL7: postgis33)</li>
<li><code>timescaledb</code>: Time-series database extension</li>
<li><code>pgvector</code>: Vector datatype and ivfflat/hnsw index</li>
<li><code>citus</code>: Distributed/columnar storage extension, (citus is conflict with <code>hydra</code>, choose one of them on EL systems)</li>
</ul>
<p>If you want to enable certain extensions in a target cluster that has not yet been created, you can directly declare them with the parameters:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1 ,pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># &lt;----- install these extensions for database `test`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: postgis, schema</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">public }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">timescaledb }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_cron }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vector }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">age }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_libs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;timescaledb, pg_cron, pg_stat_statements, auto_explain&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;- some extension require a share library to work</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">postgis34_$v* timescaledb-2-postgresql-$v* pgvector_$v* hydra_$v*  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># default extensions to be installed</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">pg_cron_$v*        # &lt;---- new extension</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_cron</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">apache-age_$v*     # &lt;---- new extension</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apache-age</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">zhparser_$v*       # &lt;---- new extension</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">zhparser</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You can run the <code>pg_extension</code> sub-task in <a href="/docs/pgsql/playbook/#pgsqlyml"><code>pgsql.yml</code></a> to add extensions to clusters that have already been created.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -l pg-meta -t pg_extension    <span style="color:#8f5902;font-style:italic"># install specified extensions for cluster pg-v15</span>
</span></span></code></pre></div><p>To install <strong>all</strong> available extensions in one pass, you can just specify <code>pg_extensions: ['*$v*']</code>, which is really a bold move.</p>
<hr>
<h3 id="install-manually">Install Manually</h3>
<p>After the PostgreSQL cluster is inited, you can manually install plugins via Ansible or Shell commands. For example, if you want to enable a specific extension on a cluster that has already been initialized:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty<span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic"># enter pigsty home dir and install the apache age extension for the pg-test cluster</span>
</span></span><span style="display:flex;"><span>ansible pg-test -m yum -b -a <span style="color:#4e9a06">&#39;name=apache-age_16*&#39;</span>     <span style="color:#8f5902;font-style:italic"># The extension name usually has a suffix like `_&lt;pgmajorversion&gt;`</span>
</span></span></code></pre></div><p>Most plugins are already included in the yum repository on the infrastructure node and can be installed directly using the yum command. If not included, you can consider downloading from the PGDG upstream source using the <code>repotrack</code> / <code>apt download</code> command or compiling source code into RPMs for distribution.</p>
<p>After the extension installation, you should be able to see them in the <code>pg_available_extensions</code> view of the target database cluster. Next, execute in the database where you want to install the extension:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">age</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic">-- install the graph database extension
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d353f8b723fb78c622e9dd520898a3dd">6 - Authentication</h1>
    <div class="lead">Host-Based Authentication in Pigsty, how to manage HBA rules in Pigsty?</div>
	<blockquote>
<p>Host-Based Authentication in Pigsty</p>
</blockquote>
<p>PostgreSQL has various <a href="https://www.postgresql.org/docs/current/client-authentication.html">authentication</a> methods. You can use all of them, while pigsty&rsquo;s battery-include ACL system focuses on HBA, password, and SSL authentication.</p>
<hr>
<h2 id="client-authentication">Client Authentication</h2>
<p>To connect to a PostgreSQL database, the user has to be authenticated (with a password by default).</p>
<p>You can provide the password in the connection string (not secure) or use the <code>PGPASSWORD</code> env or <code>.pgpass</code> file. Check <a href="https://www.postgresql.org/docs/current/app-psql.html#usage"><code>psql</code></a> docs and <a href="https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING">PostgreSQL connection string</a> for more details.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql <span style="color:#4e9a06">&#39;host=&lt;host&gt; port=&lt;port&gt; dbname=&lt;dbname&gt; user=&lt;username&gt; password=&lt;password&gt;&#39;</span>
</span></span><span style="display:flex;"><span>psql postgres://&lt;username&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;dbname&gt;
</span></span><span style="display:flex;"><span><span style="color:#000">PGPASSWORD</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;password&gt;<span style="color:#000;font-weight:bold">;</span> psql -U &lt;username&gt; -h &lt;host&gt; -p &lt;port&gt; -d &lt;dbname&gt;
</span></span></code></pre></div><p>The default connection string for the <code>meta</code> database:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql <span style="color:#4e9a06">&#39;host=10.10.10.10 port=5432 dbname=meta user=dbuser_dba password=DBUser.DBA&#39;</span>
</span></span><span style="display:flex;"><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta
</span></span><span style="display:flex;"><span><span style="color:#000">PGPASSWORD</span><span style="color:#ce5c00;font-weight:bold">=</span>DBUser.DBA<span style="color:#000;font-weight:bold">;</span> psql -U dbuser_dba -h 10.10.10.10 -p <span style="color:#0000cf;font-weight:bold">5432</span> -d meta
</span></span></code></pre></div><p>To connect with the SSL certificate, you can use the <code>PGSSLCERT</code> and <code>PGSSLKEY</code> env or <code>sslkey</code> &amp; <code>sslcert</code> parameters.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>psql <span style="color:#4e9a06">&#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta?sslkey=/path/to/dbuser_dba.key&amp;sslcert=/path/to/dbuser_dba.crt&#39;</span>
</span></span></code></pre></div><p>While the client certificate (<code>CN</code> = username) can be issued with local CA &amp; <a href="https://github.com/Vonng/pigsty/blob/main/cert.yml">cert.yml</a>.</p>
<hr>
<h2 id="define-hba">Define HBA</h2>
<p>There are four parameters for HBA Rules in Pigsty:</p>
<ul>
<li><a href="/docs/reference/param/#pg_hba_rules"><code>pg_hba_rules</code></a>: postgres ad-hoc hba rules</li>
<li><a href="/docs/reference/param/#pg_default_hba_rules"><code>pg_default_hba_rules</code></a>: postgres default hba rules</li>
<li><a href="/docs/reference/param/#pgb_hba_rules"><code>pgb_hba_rules</code></a>: pgbouncer ad-hoc hba rules</li>
<li><a href="/docs/reference/param/#pgb_default_hba_rules"><code>pgb_default_hba_rules</code></a>: pgbouncer default hba rules</li>
</ul>
<p>Which are array of hba rule objects, and each hba rule is one of the following forms:</p>
<h3 id="1-raw-form">1. Raw Form</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow intranet password access</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">common</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">host   all  all  10.0.0.0/8      md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">host   all  all  172.16.0.0/12   md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">host   all  all  192.168.0.0/16  md5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>In the form, the <code>title</code> will be rendered as a comment line, followed by the <code>rules</code> as hba string one by one.</p>
<p>An HBA Rule is installed when the instance&rsquo;s <a href="/docs/reference/param/#pg_role"><code>pg_role</code></a> is the same as the <code>role</code>.</p>
<p>HBA Rule with <code>role: common</code> will be installed on all instances.</p>
<p>HBA Rule with <code>role: offline</code> will be installed on instances with <a href="/docs/reference/param/#pg_role"><code>pg_role</code></a> = <code>offline</code> or <a href="/docs/reference/param/#pg_offline_query"><code>pg_offline_query</code></a> = <code>true</code>.</p>
<h3 id="2-alias-form">2. Alias Form</h3>
<p>The alias form, which replace <code>rules</code> with <code>addr</code>, <code>auth</code>, <code>user</code>, and <code>db</code> fields.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">addr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;intra&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># world|intra|infra|admin|local|localhost|cluster|&lt;cidr&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">auth</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># trust|pwd|ssl|cert|deny|&lt;official auth method&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all&#39;</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># all|${dbsu}|${repl}|${admin}|${monitor}|&lt;user&gt;|&lt;group&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">db</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all&#39;</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># all|replication|....</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># raw hba string precedence over above all</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow intranet password access</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li><code>addr</code>: <strong>where</strong>
<ul>
<li><code>world</code>: all IP addresses</li>
<li><code>intra</code>: all intranet cidr: <code>'10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16'</code></li>
<li><code>infra</code>: IP addresses of infra nodes</li>
<li><code>admin</code>: <code>admin_ip</code> address</li>
<li><code>local</code>: local unix socket</li>
<li><code>localhost</code>: local unix socket + tcp 127.0.0.1/32</li>
<li><code>cluster</code>: all IP addresses of pg cluster members</li>
<li><code>&lt;cidr&gt;</code>: any standard CIDR blocks or IP addresses</li>
</ul>
</li>
<li><code>auth</code>: <strong>how</strong>
<ul>
<li><code>deny</code>: reject access</li>
<li><code>trust</code>: trust authentication</li>
<li><code>pwd</code>: use <code>md5</code> or <code>scram-sha-256</code> password auth according to <a href="/docs/reference/param/#pg_pwd_enc"><code>pg_pwd_enc</code></a></li>
<li><code>sha</code>/<code>scram-sha-256</code>: enforce <code>scram-sha-256</code> password authentication</li>
<li><code>md5</code>: <code>md5</code> password authentication</li>
<li><code>ssl</code>: enforce host ssl in addition to <code>pwd</code> auth</li>
<li><code>ssl-md5</code>: enforce host ssl in addition to <code>md5</code> password auth</li>
<li><code>ssl-sha</code>: enforce host ssl in addition to <code>scram-sha-256</code> password auth</li>
<li><code>os</code>/<code>ident</code>: use <code>ident</code> os user authentication</li>
<li><code>peer</code>: use <code>peer</code> authentication</li>
<li><code>cert</code>: use certificate-based client authentication</li>
</ul>
</li>
<li><code>user</code>: <strong>who</strong>
<ul>
<li><code>all</code>: all users</li>
<li><code>${dbsu}</code>: database superuser specified by <a href="/docs/reference/param/#pg_dbsu"><code>pg_dbsu</code></a></li>
<li><code>${repl}</code>: replication user specified by <a href="/docs/reference/param/#pg_replication_username"><code>pg_replication_username</code></a></li>
<li><code>${admin}</code>: admin user specified by <a href="/docs/reference/param/#pg_admin_username"><code>pg_admin_username</code></a></li>
<li><code>${monitor}</code>: monitor user specified by <a href="/docs/reference/param/#pg_monitor_username"><code>pg_monitor_username</code></a></li>
<li>ad hoc users &amp; roles.</li>
</ul>
</li>
<li><code>db</code>: <strong>which</strong>
<ul>
<li><code>all</code>: all databases</li>
<li><code>replication</code>: replication database</li>
<li>ad hoc database name</li>
</ul>
</li>
</ul>
<h3 id="3-where-to-define">3. Where to Define</h3>
<p>Typically, global HBA is defined in all.vars. If you want to modify the global default HBA rules, you can copy from the full.yml template to all.vars for modification.</p>
<ul>
<li><a href="/docs/reference/param/#pg_default_hba_rules"><code>pg_default_hba_rules</code></a>: postgres global default HBA rules</li>
<li><a href="/docs/reference/param/#pgb_default_hba_rules"><code>pgb_default_hba_rules</code></a>: pgbouncer global default HBA rules</li>
</ul>
<p>Cluster-specific HBA rules are defined in the cluster-level configuration of the database:</p>
<ul>
<li><a href="/docs/reference/param/#pg_hba_rules"><code>pg_hba_rules</code></a>: postgres HBA rules for the cluster</li>
<li><a href="/docs/reference/param/#pgb_hba_rules"><code>pgb_hba_rules</code></a>: pgbouncer HBA rules for the cluster</li>
</ul>
<p>Here are some examples of cluster HBA rule definitions.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user: dbuser_view ,db: all    ,addr: infra        ,auth: pwd  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user: all         ,db: all    ,addr: 100.0.0.0/8  ,auth: pwd  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all user access all db from kubernetes cluster&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">,db: world  ,addr: 0.0.0.0/0    ,auth: cert ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all admin world access with client cert&#39;</span><span style="color:#f8f8f8;text-decoration:underline">        </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="reload-hba">Reload HBA</h2>
<p>To reload postgres/pgbouncer hba rules:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-hba &lt;cls&gt;                 <span style="color:#8f5902;font-style:italic"># reload hba rules of cluster `&lt;cls&gt;`</span>
</span></span><span style="display:flex;"><span>bin/pgsql-hba &lt;cls&gt; ip1 ip2...      <span style="color:#8f5902;font-style:italic"># reload hba rules of specific instances</span>
</span></span></code></pre></div><p>The underlying command: are:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -l &lt;cls&gt; -e <span style="color:#000">pg_reload</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> -t pg_hba,pg_reload
</span></span><span style="display:flex;"><span>./pgsql.yml -l &lt;cls&gt; -e <span style="color:#000">pg_reload</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> -t pgbouncer_hba,pgbouncer_reload
</span></span></code></pre></div><hr>
<h2 id="default-hba">Default HBA</h2>
<p>Pigsty has a default set of HBA rules, which is pretty secure for most cases.</p>
<p>The rules are self-explained in alias form.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_default_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># postgres default host-based authentication rules</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: local     ,auth: ident ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu access via local os user ident&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: local     ,auth: ident ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu replication from local os ident&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator replication from localhost&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator replication from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: postgres    ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator postgres db from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor from localhost with password&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: infra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor from infra host with password&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin @ infra nodes with pwd &amp; ssl&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: world     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin @ everywhere with ssl &amp; pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pgbouncer read/write via local socket&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;read/write biz user via password&#39;</span><span style="color:#f8f8f8;text-decoration:underline">     </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow etl offline tasks from intranet&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgb_default_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># pgbouncer default host-based authentication rules</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: pgbouncer   ,addr: local     ,auth: peer  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu local admin access with os ident&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow all user local access with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: pgbouncer   ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor access via intranet with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: world     ,auth: deny  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;reject all other monitor access addr&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin access via intranet with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: world     ,auth: deny  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;reject all other admin access addr&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow all user intra access with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><details><summary>Example: Rendered pg_hba.conf</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#==============================================================#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># File      :   pg_hba.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Desc      :   Postgres HBA Rules for pg-meta-1 [primary]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Time      :   2023-01-11 15:19</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Host      :   pg-meta-1 @ 10.10.10.10:5432</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Path      :   /pg/data/pg_hba.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note      :   ANSIBLE MANAGED, DO NOT CHANGE!</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Author    :   Ruohang Feng (rh@vonng.com)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># License   :   AGPLv3</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#==============================================================#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># addr alias</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># local     : /var/run/postgresql</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># admin     : 10.10.10.10</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># infra     : 10.10.10.10</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># intra     : 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># user alias</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dbsu    :  postgres</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># repl    :  replicator</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># monitor :  dbuser_monitor</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># admin   :  dbuser_dba</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dbsu access via local os user ident [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">local    all                postgres                              ident</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dbsu replication from local os ident [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">local    replication        postgres                              ident</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># replicator replication from localhost [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">local    replication        replicator                            scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     replication        replicator         127.0.0.1/32       scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># replicator replication from intranet [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     replication        replicator         10.0.0.0/8         scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     replication        replicator         172.16.0.0/12      scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     replication        replicator         192.168.0.0/16     scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># replicator postgres db from intranet [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     postgres           replicator         10.0.0.0/8         scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     postgres           replicator         172.16.0.0/12      scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     postgres           replicator         192.168.0.0/16     scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># monitor from localhost with password [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">local    all                dbuser_monitor                        scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                dbuser_monitor     127.0.0.1/32       scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># monitor from infra host with password [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                dbuser_monitor     10.10.10.10/32     scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># admin @ infra nodes with pwd &amp; ssl [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">hostssl  all                dbuser_dba         10.10.10.10/32     scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># admin @ everywhere with ssl &amp; pwd [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">hostssl  all                dbuser_dba         0.0.0.0/0          scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pgbouncer read/write via local socket [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">local    all                +dbrole_readonly                      scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                +dbrole_readonly   127.0.0.1/32       scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># read/write biz user via password [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                +dbrole_readonly   10.0.0.0/8         scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                +dbrole_readonly   172.16.0.0/12      scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                +dbrole_readonly   192.168.0.0/16     scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allow etl offline tasks from intranet [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                +dbrole_offline    10.0.0.0/8         scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                +dbrole_offline    172.16.0.0/12      scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                +dbrole_offline    192.168.0.0/16     scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allow application database intranet access [common] [DISABLED]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#host    kong            dbuser_kong         10.0.0.0/8          md5</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#host    bytebase        dbuser_bytebase     10.0.0.0/8          md5</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#host    grafana         dbuser_grafana      10.0.0.0/8          md5</span>
</span></span></code></pre></div></details>
<details><summary>Example: Rendered pgb_hba.conf</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#==============================================================#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># File      :   pgb_hba.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Desc      :   Pgbouncer HBA Rules for pg-meta-1 [primary]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Time      :   2023-01-11 15:28</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Host      :   pg-meta-1 @ 10.10.10.10:5432</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Path      :   /etc/pgbouncer/pgb_hba.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note      :   ANSIBLE MANAGED, DO NOT CHANGE!</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Author    :   Ruohang Feng (rh@vonng.com)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># License   :   AGPLv3</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#==============================================================#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># PGBOUNCER HBA RULES FOR pg-meta-1 @ 10.10.10.10:6432</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ansible managed: 2023-01-11 14:30:58</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># addr alias</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># local     : /var/run/postgresql</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># admin     : 10.10.10.10</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># infra     : 10.10.10.10</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># intra     : 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># user alias</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dbsu    :  postgres</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># repl    :  replicator</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># monitor :  dbuser_monitor</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># admin   :  dbuser_dba</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dbsu local admin access with os ident [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">local    pgbouncer          postgres                              peer</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allow all user local access with pwd [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">local    all                all                                   scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                all                127.0.0.1/32       scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># monitor access via intranet with pwd [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     pgbouncer          dbuser_monitor     10.0.0.0/8         scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     pgbouncer          dbuser_monitor     172.16.0.0/12      scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     pgbouncer          dbuser_monitor     192.168.0.0/16     scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># reject all other monitor access addr [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                dbuser_monitor     0.0.0.0/0          reject</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># admin access via intranet with pwd [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                dbuser_dba         10.0.0.0/8         scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                dbuser_dba         172.16.0.0/12      scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                dbuser_dba         192.168.0.0/16     scram-sha-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># reject all other admin access addr [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                dbuser_dba         0.0.0.0/0          reject</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allow all user intra access with pwd [default]</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                all                10.0.0.0/8         scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                all                172.16.0.0/12      scram-sha-256</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host     all                all                192.168.0.0/16     scram-sha-256</span>
</span></span></code></pre></div></details>
<hr>
<h2 id="security-enhancement">Security Enhancement</h2>
<p>For those critical cases, we have a <a href="https://github.com/Vonng/pigsty/blob/main/conf/safe.yml">security.yml</a> template with the following hba rule set as a reference:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_default_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># postgres host-based auth rules by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: local     ,auth: ident ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu access via local os user ident&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: local     ,auth: ident ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu replication from local os ident&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: localhost ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator replication from localhost&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: replication ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator replication from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${repl}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: postgres    ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;replicator postgres db from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor from localhost with password&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor from infra host with password&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin @ infra nodes with pwd &amp; ssl&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: world     ,auth: cert  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin @ everywhere with ssl &amp; cert&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pgbouncer read/write via local socket&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;read/write biz user via password&#39;</span><span style="color:#f8f8f8;text-decoration:underline">     </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow etl offline tasks from intranet&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pgb_default_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># pgbouncer host-based authentication rules</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${dbsu}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">,db: pgbouncer   ,addr: local     ,auth: peer  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;dbsu local admin access with os ident&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow all user local access with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: pgbouncer   ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;monitor access via intranet with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${monitor}&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: world     ,auth: deny  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;reject all other monitor access addr&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;admin access via intranet with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${admin}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">,db: all         ,addr: world     ,auth: deny  ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;reject all other admin access addr&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#204a87;font-weight:bold">user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;allow all user intra access with pwd&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-61c2dced240f3df23a0a7e039b04b7d6">7 - Configuration</h1>
    <div class="lead">Configure your PostgreSQL cluster &amp; instances according to your needs</div>
	<p>You can define different types of instances &amp; clusters.</p>
<ul>
<li><a href="/docs/reference/param/#pg_id">Identity</a>: Parameters used for describing a PostgreSQL cluster</li>
<li><a href="/docs/pgsql/config/#primary">Primary</a>: Define a single instance cluster.</li>
<li><a href="/docs/pgsql/config/#replica">Replica</a>: Define a basic HA cluster with one primary &amp; one replica.</li>
<li><a href="/docs/pgsql/config/#offline">Offline</a>: Define a dedicated instance for OLAP/ETL/Interactive queries</li>
<li><a href="/docs/pgsql/config/#sync-standby">Sync Standby</a>: Enable synchronous commit to ensure no data loss.</li>
<li><a href="/docs/pgsql/config/#quorum-commit">Quorum Commit</a>:   Use quorum sync commit for an even higher consistency level.</li>
<li><a href="/docs/pgsql/config/#standby-cluster">Standby Cluster</a>: Clone an existing cluster and follow it</li>
<li><a href="/docs/pgsql/config/#delayed-cluster">Delayed Cluster</a>: Clone an existing cluster for emergency data recovery</li>
<li><a href="/docs/pgsql/config/#citus-cluster">Citus Cluster</a>: Define a Citus distributed database cluster</li>
<li><a href="/docs/pgsql/config/#major-version">Major Version</a>: Create postgres cluster with different major version</li>
</ul>
<hr>
<h2 id="primary">Primary</h2>
<p>Let&rsquo;s start with the simplest case, singleton meta:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Use the following command to create a primary database instance on the <code>10.10.10.11</code> node.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-add pg-test
</span></span></code></pre></div><hr>
<h2 id="replica">Replica</h2>
<p>To add a physical replica, you can assign a new instance to <code>pg-test</code> with <a href="/docs/reference/param/#pg_role"><code>pg_role</code></a> set to <code>replica</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica } </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- newly added</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You can <a href="/docs/pgsql/admin/#create-cluster">create</a> an entire cluster or <a href="/docs/pgsql/admin/#append-replica">append</a> a replica to the existing cluster:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-add pg-test               <span style="color:#8f5902;font-style:italic"># init entire cluster in one-pass</span>
</span></span><span style="display:flex;"><span>bin/pgsql-add pg-test 10.10.10.12   <span style="color:#8f5902;font-style:italic"># add replica to existing cluster</span>
</span></span></code></pre></div><hr>
<h2 id="offline">Offline</h2>
<p>The offline instance is a dedicated replica to serve slow queries, ETL, OLAP traffic and interactive queries, etc&hellip;</p>
<p>To add an offline instance, assign a new instance with <a href="/docs/reference/param/#pg_role"><code>pg_role</code></a> set to <code>offline</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">offline }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- newly added</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Offline instance works like common replica instances, but it is used as a backup server in <code>pg-test-replica</code> service.
That is to say, offline and primary instance serves only when all <code>replica</code> instances are down.</p>
<p>You can have ad hoc access control offline with <a href="/docs/reference/param/#pg_default_hba_rules"><code>pg_default_hba_rules</code></a> and <a href="/docs/reference/param/#pg_hba_rules"><code>pg_hba_rules</code></a>.
It will apply to the offline instance and any instances with <a href="/docs/reference/param/#pg_offline_query"><code>pg_offline_query</code></a> flag.</p>
<hr>
<h2 id="sync-standby">Sync Standby</h2>
<p>Pigsty uses asynchronous stream replication by default. Which may have a small replication lag. (10KB / 10ms).
A small window of data loss may occur when the primary fails (can be controlled with <a href="/docs/reference/param/#pg_rpo"><code>pg_rpo</code></a>.), but it is acceptable for most scenarios.</p>
<p>But in some critical scenarios (e.g. financial transactions), data loss is totally unacceptable or read-your-write consistency is required.
In this case, you can enable synchronous commit to ensure that.</p>
<p>To enable sync standby mode, you can simply use <code>crit.yml</code> template in <a href="/docs/reference/param/#pg_conf"><code>pg_conf</code></a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 3, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_conf</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">crit.yml  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- use crit template</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>To enable sync standby on existing clusters, <a href="/docs/pgsql/admin/#config-cluster">config</a> the cluster and enable <code>synchronous_mode</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg edit-config pg-test    <span style="color:#8f5902;font-style:italic"># run on admin node with admin user</span>
</span></span><span style="display:flex;"><span>+++
</span></span><span style="display:flex;"><span>-synchronous_mode: <span style="color:#204a87">false</span>    <span style="color:#8f5902;font-style:italic"># &lt;--- old value</span>
</span></span><span style="display:flex;"><span>+synchronous_mode: <span style="color:#204a87">true</span>     <span style="color:#8f5902;font-style:italic"># &lt;--- new value</span>
</span></span><span style="display:flex;"><span> synchronous_mode_strict: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Apply these changes? <span style="color:#ce5c00;font-weight:bold">[</span>y/N<span style="color:#ce5c00;font-weight:bold">]</span>: y
</span></span></code></pre></div><p>If <code>synchronous_mode: true</code>, the <a href="https://www.postgresql.org/docs/current/runtime-config-replication.html#synchronous_standby_names"><code>synchronous_standby_names</code></a> parameter will be managed by patroni.
It will choose a sync standby from all available replicas and write its name to the primary&rsquo;s configuration file.</p>
<hr>
<h2 id="quorum-commit">Quorum Commit</h2>
<p>When <a href="/docs/pgsql/config/#sync-standby">sync standby</a> is enabled, PostgreSQL will pick one replica as the standby instance, and all other replicas as candidates.
Primary will wait until the standby instance flushes to disk before a commit is confirmed, and the standby instance will always have the latest data without any lags.</p>
<p>However, you can achieve an even higher/lower consistency level with the quorum commit (trade-off with availability).</p>
<p>For example, to have <strong>all</strong> 2 replicas to confirm a commit:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">synchronous_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># make sure synchronous mode is enabled</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">synchronous_node_count</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># at least 2 nodes to confirm a commit</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>If you have more replicas and wish to have more sync standby, increase <code>synchronous_node_count</code> accordingly.
Beware of adjust <code>synchronous_node_count</code> accordingly when you <a href="/docs/pgsql/admin/#append-replica">append</a> or <a href="/docs/pgsql/admin/#remove-replica">remove</a> replicas.</p>
<p>The postgres <code>synchronous_standby_names</code> parameter will be managed by patroni:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">synchronous_standby_names = &#39;2 (&#34;pg-test-3&#34;,&#34;pg-test-2&#34;)&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><details><summary>Example: Multiple Sync Standby</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg edit-config pg-test
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>+++
</span></span><span style="display:flex;"><span>@@ -82,10 +82,12 @@
</span></span><span style="display:flex;"><span>     work_mem: 4MB
</span></span><span style="display:flex;"><span>+    synchronous_standby_names: <span style="color:#4e9a06">&#39;ANY 2 (pg-test-2, pg-test-3, pg-test-4)&#39;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>-synchronous_mode: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>+synchronous_mode: <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>+synchronous_node_count: <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span> synchronous_mode_strict: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Apply these changes? <span style="color:#ce5c00;font-weight:bold">[</span>y/N<span style="color:#ce5c00;font-weight:bold">]</span>: y
</span></span></code></pre></div><p>And we can see that the two replicas are selected as sync standby now.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>+ Cluster: pg-test <span style="color:#ce5c00;font-weight:bold">(</span>7080814403632534854<span style="color:#ce5c00;font-weight:bold">)</span> +---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> Member    <span style="color:#000;font-weight:bold">|</span> Host        <span style="color:#000;font-weight:bold">|</span> Role         <span style="color:#000;font-weight:bold">|</span> State   <span style="color:#000;font-weight:bold">|</span> TL <span style="color:#000;font-weight:bold">|</span> Lag in MB <span style="color:#000;font-weight:bold">|</span> Tags            <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+--------------+---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-1 <span style="color:#000;font-weight:bold">|</span> 10.10.10.10 <span style="color:#000;font-weight:bold">|</span> Leader       <span style="color:#000;font-weight:bold">|</span> running <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-2 <span style="color:#000;font-weight:bold">|</span> 10.10.10.11 <span style="color:#000;font-weight:bold">|</span> Sync Standby <span style="color:#000;font-weight:bold">|</span> running <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-3 <span style="color:#000;font-weight:bold">|</span> 10.10.10.12 <span style="color:#000;font-weight:bold">|</span> Sync Standby <span style="color:#000;font-weight:bold">|</span> running <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+--------------+---------+----+-----------+-----------------+
</span></span></code></pre></div></details>
<p>The classic quorum commit is to use <strong>majority</strong> of replicas to confirm a commit.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">synchronous_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">quorum       </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># use quorum commit</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">postgresql</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#8f5902;font-style:italic"># change the PostgreSQL parameter `synchronous_standby_names`, use the `ANY n ()` notion</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">synchronous_standby_names</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;ANY 1 (*)&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># you can specify a list of standby names, or use `*` to match them all</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><details><summary>Example: Enable Quorum Commit</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg edit-config pg-test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>+    synchronous_standby_names: <span style="color:#4e9a06">&#39;ANY 1 (*)&#39;</span> <span style="color:#8f5902;font-style:italic"># You have to configure this manually</span>
</span></span><span style="display:flex;"><span>+ synchronous_mode: quorum        <span style="color:#8f5902;font-style:italic"># use quorum commit mode, undocumented parameter</span>
</span></span><span style="display:flex;"><span>- synchronous_node_count: <span style="color:#0000cf;font-weight:bold">2</span>       <span style="color:#8f5902;font-style:italic"># this parameter is no longer needed in quorum mode</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Apply these changes? <span style="color:#ce5c00;font-weight:bold">[</span>y/N<span style="color:#ce5c00;font-weight:bold">]</span>: y
</span></span></code></pre></div><p>After applying the configuration, we can see that all replicas are no longer sync standby, but just normal replicas.</p>
<p>After that, when we can check <code>pg_stat_replication.sync_state</code>, it becomes <code>quorum</code> instead of <code>sync</code> or <code>async</code>.</p>
</details>
<hr>
<h2 id="standby-cluster">Standby Cluster</h2>
<p>You can clone an existing cluster and create a <a href="/docs/pgsql/config/#standby-cluster">standby cluster</a>, which can be used for migration, horizontal split, multi-az deployment, or disaster recovery.</p>
<p>A standby cluster&rsquo;s definition is just the same as any other normal cluster, except there&rsquo;s a <a href="/docs/reference/param/#pg_upstream"><code>pg_upstream</code></a> defined on the primary instance.</p>
<p>For example, you have a <code>pg-test</code> cluster, to create a standby cluster <code>pg-test2</code>, the inventory may look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pg-test is the original cluster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg-test2 is a standby cluster of pg-test.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-test2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role: primary , pg_upstream</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.11</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- pg_upstream is defined here</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test2 }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>And <code>pg-test2-1</code>, the primary of <code>pg-test2</code> will be a replica of <code>pg-test</code> and serve as a <strong>Standby Leader</strong> in <code>pg-test2</code>.</p>
<p>Just make sure that the <a href="/docs/reference/param/#pg_upstream"><code>pg_upstream</code></a> parameter is configured on the primary of the backup cluster to pull backups from the original upstream automatically.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-add pg-test     <span style="color:#8f5902;font-style:italic"># Creating the original cluster</span>
</span></span><span style="display:flex;"><span>bin/pgsql-add pg-test2    <span style="color:#8f5902;font-style:italic"># Creating a Backup Cluster</span>
</span></span></code></pre></div><details><summary>Example: Change Replication Upstream</summary>
<p>You can change the replication upstream of the standby cluster when necessary (e.g. upstream failover).</p>
<p>To do so, just change the <code>standby_cluster.host</code> to the new upstream IP address and apply.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg edit-config pg-test2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> standby_cluster:
</span></span><span style="display:flex;"><span>   create_replica_methods:
</span></span><span style="display:flex;"><span>   - basebackup
</span></span><span style="display:flex;"><span>-  host: 10.10.10.13     <span style="color:#8f5902;font-style:italic"># &lt;--- The old upstream</span>
</span></span><span style="display:flex;"><span>+  host: 10.10.10.12     <span style="color:#8f5902;font-style:italic"># &lt;--- The new upstream</span>
</span></span><span style="display:flex;"><span>   port: <span style="color:#0000cf;font-weight:bold">5432</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> Apply these changes? <span style="color:#ce5c00;font-weight:bold">[</span>y/N<span style="color:#ce5c00;font-weight:bold">]</span>: y
</span></span></code></pre></div></details>
<details><summary>Example: Promote Standby Cluster</summary>
<p>You can promote the standby cluster to a standalone cluster at any time.</p>
<p>To do so, you have to <a href="/docs/pgsql/admin/#config-cluster">config</a> the cluster and wipe the entire <code>standby_cluster</code> section then apply.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg edit-config pg-test2
</span></span><span style="display:flex;"><span>-standby_cluster:
</span></span><span style="display:flex;"><span>-  create_replica_methods:
</span></span><span style="display:flex;"><span>-  - basebackup
</span></span><span style="display:flex;"><span>-  host: 10.10.10.11
</span></span><span style="display:flex;"><span>-  port: <span style="color:#0000cf;font-weight:bold">5432</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Apply these changes? <span style="color:#ce5c00;font-weight:bold">[</span>y/N<span style="color:#ce5c00;font-weight:bold">]</span>: y
</span></span></code></pre></div></details>
<details><summary>Example: Cascade Replica</summary>
<p>If the <a href="/docs/reference/param/#pg_upstream"><code>pg_upstream</code></a> is specified for <strong>replica</strong> rather than <strong>primary</strong>, the replica will be configured as a cascade replica with the given upstream ip instead of the cluster primary</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># pg-test-1 ---&gt; pg-test-2 ---&gt; pg-test-3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- bridge instance</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role: replica, pg_upstream</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.12</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># ^--- replicate from pg-test-2 (the bridge) instead of pg-test-1 (the primary) </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></details>
<hr>
<h2 id="delayed-cluster">Delayed Cluster</h2>
<p>A delayed cluster is a special type of standby cluster, which is used to recover &ldquo;drop-by-accident&rdquo; ASAP.</p>
<p>For example, if you wish to have a cluster <code>pg-testdelay</code> which has the same data as 1-day ago <code>pg-test</code> cluster:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pg-test is the original cluster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg-testdelay is a delayed cluster of pg-test.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-testdelay</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role: primary , pg_upstream: 10.10.10.11, pg_delay</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1d }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test2 }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You can also <a href="/docs/pgsql/admin/#config-cluster">configure</a> a replication delay on the existing <a href="/docs/pgsql/config/#standby-cluster">standby cluster</a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg edit-config pg-testdelay
</span></span><span style="display:flex;"><span> standby_cluster:
</span></span><span style="display:flex;"><span>   create_replica_methods:
</span></span><span style="display:flex;"><span>   - basebackup
</span></span><span style="display:flex;"><span>   host: 10.10.10.11
</span></span><span style="display:flex;"><span>   port: <span style="color:#0000cf;font-weight:bold">5432</span>
</span></span><span style="display:flex;"><span>+  recovery_min_apply_delay: 1h    <span style="color:#8f5902;font-style:italic"># &lt;--- add delay here</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Apply these changes? <span style="color:#ce5c00;font-weight:bold">[</span>y/N<span style="color:#ce5c00;font-weight:bold">]</span>: y
</span></span></code></pre></div><p>When some tuples &amp; tables are dropped by accident, you can advance this delayed cluster to a proper time point and select data from it.</p>
<p>It takes more resources, but can be much faster and have less impact than <a href="/docs/concept/pitr/">PITR</a></p>
<hr>
<h2 id="citus-cluster">Citus Cluster</h2>
<p>Pigsty has native citus support. Check <a href="https://github.com/Vonng/pigsty/blob/main/conf/citus.yml"><code>files/pigsty/citus.yml</code></a> &amp; <a href="https://github.com/Vonng/pigsty/blob/main/conf/prod.yml#L298"><code>prod.yml</code></a> for example.</p>
<p>To define a citus cluster, you have to specify the following parameters:</p>
<ul>
<li><a href="/docs/reference/param/#pg_mode"><code>pg_mode</code></a> has to be set to <code>citus</code> instead of default <code>pgsql</code></li>
<li><a href="/docs/reference/param/#pg_shard"><code>pg_shard</code></a> &amp; <a href="/docs/reference/param/#pg_group"><code>pg_group</code></a> has to be defined on each sharding cluster</li>
<li><a href="/docs/reference/param/#patroni_citus_db"><code>patroni_citus_db</code></a> has to be defined to specify the database to be managed</li>
<li><a href="/docs/reference/param/#pg_dbsu_password"><code>pg_dbsu_password</code></a> has to be set to a non-empty string plain password if you want to use the <a href="/docs/reference/param/#pg_dbsu"><code>pg_dbsu</code></a> <code>postgres</code> rather than default <a href="/docs/reference/param/#pg_admin_username"><code>pg_admin_username</code></a> to perform admin commands</li>
</ul>
<p>Besides, extra hba rules that allow ssl access from local &amp; other data nodes are required. Which may looks like this</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">all</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">children</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-citus0</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus data node 0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-citus0 , pg_group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-citus1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus data node 1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-citus1 , pg_group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-citus2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus data node 2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-citus2 , pg_group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg-citus3</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus data node 3, with an extra replica</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">10.10.10.14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-citus3 , pg_group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#8f5902;font-style:italic"># global parameters for all citus clusters</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_mode: citus                    # pgsql cluster mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">citus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_shard: pg-citus                # citus shard name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-citus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">patroni_citus_db</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># citus distributed database name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_dbsu_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Postgres</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># all dbsu password access for citus cluster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_meta ,password: DBUser.Meta ,pgbouncer: true ,roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_admin ] } ]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: meta ,extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">citus }, { name: postgis }, { name: timescaledb } ] } ]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_hba_rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32 ,auth: ssl ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all user ssl access from localhost&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user: &#39;all&#39; ,db: all  ,addr: intra        ,auth: ssl ,title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all user ssl access from intranet&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>And you can create distributed table &amp; reference table on the coordinator node. Any data node can be used as the coordinator node since citus 11.2.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SELECT create_distributed_table<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pgbench_accounts&#39;</span>, <span style="color:#4e9a06">&#39;aid&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span> SELECT truncate_local_data_after_distributing_table<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">$$</span>public.pgbench_accounts<span style="color:#000">$$</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>SELECT create_reference_table<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pgbench_branches&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#000;font-weight:bold">;</span> SELECT truncate_local_data_after_distributing_table<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">$$</span>public.pgbench_branches<span style="color:#000">$$</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>SELECT create_reference_table<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pgbench_history&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>          <span style="color:#000;font-weight:bold">;</span> SELECT truncate_local_data_after_distributing_table<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">$$</span>public.pgbench_history<span style="color:#000">$$</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>SELECT create_reference_table<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pgbench_tellers&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>          <span style="color:#000;font-weight:bold">;</span> SELECT truncate_local_data_after_distributing_table<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">$$</span>public.pgbench_tellers<span style="color:#000">$$</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><hr>
<h2 id="major-version">Major Version</h2>
<p>Pigsty works on PostgreSQL 10+. While the pre-packaged packages only includes 12 - 16 for now.</p>
<table>
<thead>
<tr>
<th>version</th>
<th>Comment</th>
<th>Packages</th>
</tr>
</thead>
<tbody>
<tr>
<td>16</td>
<td>The latest version with important extensions</td>
<td>Core, L1 L2</td>
</tr>
<tr>
<td>15</td>
<td>The stable major version, with full extension support (default)</td>
<td>Core, L1,L2,L3</td>
</tr>
<tr>
<td>14</td>
<td>The old stable major version, ith L1 extension support only</td>
<td>Core, L1</td>
</tr>
<tr>
<td>13</td>
<td>Older major version, with L1 extension support only</td>
<td>Core, L1</td>
</tr>
<tr>
<td>12</td>
<td>Older major version, with L1 extension support only</td>
<td>Core, L1</td>
</tr>
</tbody>
</table>
<ul>
<li>Core: <code>postgresql*</code>, available on PG 12 - 16</li>
<li>L1 extensions: <code>wal2json</code>, <code>pg_repack</code>, <code>passwordcheck_cracklib</code> (PG 12 - 16)</li>
<li>L2 extensions: <code>postgis</code>, <code>citus</code>, <code>timescaledb</code>, <code>pgvector</code> (PG15, PG16)</li>
<li>L3 extensions: Other miscellaneous extensions (PG15 only)</li>
</ul>
<p>Since some extensions are not available on PG 12,13,14,16, you may have to change <a href="/docs/reference/param/#pg_extensions"><code>pg_extensions</code></a> and <a href="/docs/reference/param/#pg_libs"><code>pg_libs</code></a> to fit your needs.</p>
<p>Here are some example cluster definition with different major versions.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-v12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1 ,pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-v12</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_libs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pg_stat_statements, auto_explain&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;wal2json_12* pg_repack_12* passwordcheck_cracklib_12*&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-v13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1 ,pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-v13</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_libs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pg_stat_statements, auto_explain&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;wal2json_13* pg_repack_13* passwordcheck_cracklib_13*&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-v14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.14</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1 ,pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-v14</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-v15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1 ,pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-v15</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg-v16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.16</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1 ,pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary } }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-v16</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Beware that these extensions are just not included in Pigsty&rsquo;s default repo. You can have these extensions on older pg version with proper configuration.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-091b9f18681382583303e1ac5c7cea55">8 - Playbook</h1>
    <div class="lead">How to manage PostgreSQL cluster with ansible playbooks</div>
	<p>Pigsty has a series of playbooks for PostgreSQL:</p>
<ul>
<li><a href="/docs/pgsql/playbook/#pgsqlyml"><code>pgsql.yml</code></a> : Init HA PostgreSQL clusters or add new replicas.</li>
<li><a href="/docs/pgsql/playbook/#pgsql-rmyml"><code>pgsql-rm.yml</code></a> : Remove PostgreSQL cluster, or remove replicas</li>
<li><a href="/docs/pgsql/playbook/#pgsql-useryml"><code>pgsql-user.yml</code></a> : Add new business user to existing PostgreSQL cluster</li>
<li><a href="/docs/pgsql/playbook/#pgsql-dbyml"><code>pgsql-db.yml</code></a> : Add new business database to existing PostgreSQL cluster</li>
<li><a href="/docs/pgsql/playbook/#pgsql-monitoryml"><code>pgsql-monitor.yml</code></a> : Monitor remote PostgreSQL instance with local exporters</li>
<li><a href="/docs/pgsql/playbook/#pgsql-migrationyml"><code>pgsql-migration.yml</code></a> : Generate Migration manual &amp; scripts for existing PostgreSQL</li>
</ul>
<hr>
<h3 id="safeguard">Safeguard</h3>
<p>Beware, when using the <a href="/docs/pgsql/playbook/#pgsqlyml"><code>pgsql.yml</code></a> and <a href="/docs/pgsql/playbook/#pgsql-rmyml"><code>pgsql-rm.yml</code></a> playbooks, it can pose a risk of accidentally deleting databases if misused!</p>
<ul>
<li>When using <code>pgsql.yml</code>, please check the <code>--tags|-t</code> and <code>--limit|-l</code> parameters.</li>
<li>Adding the -l parameter when executing playbooks is strongly recommended to limit execution hosts.</li>
<li>Think thrice before proceeding.</li>
</ul>
<p>To prevent accidental deletions, the <a href="/docs/pgsql/">PGSQL</a> module offers a safeguard option controlled by the following two parameters:</p>
<ul>
<li><a href="/docs/reference/param/#pg_safeguard"><code>pg_safeguard</code></a> is set to <code>false</code> by default: do not prevent purging by default.</li>
<li><a href="/docs/reference/param/#pg_clean"><code>pg_clean</code></a> is set to <code>true</code> by default, meaning it will clean existing instances.</li>
</ul>
<p><strong>Effects on the init playbook</strong></p>
<p>When meeting a running instance with the same config during the execution of the <a href="/docs/pgsql/playbook/#pgsqlyml"><code>pgsql.yml</code></a> playbook:</p>
<table>
<thead>
<tr>
<th style="text-align:center"><code>pg_safeguard</code> / <code>pg_clean</code></th>
<th style="text-align:center"><code>pg_clean=true</code></th>
<th style="text-align:center"><code>pg_clean=false</code></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>pg_safeguard=false</code></td>
<td style="text-align:center"><strong>Purge</strong></td>
<td style="text-align:center">Abort</td>
</tr>
<tr>
<td style="text-align:center"><code>pg_safeguard=true</code></td>
<td style="text-align:center">Abort</td>
<td style="text-align:center">Abort</td>
</tr>
</tbody>
</table>
<ul>
<li>If <a href="/docs/reference/param/#pg_safeguard"><code>pg_safeguard</code></a> is enabled, the playbook will abort to avoid purging the running instance.</li>
<li>If the safeguard is disabled, it will further decide whether to remove the existing instance according to the value of <a href="/docs/reference/param/#pg_clean"><code>pg_clean</code></a>.
<ul>
<li>If <code>pg_clean</code> is <code>true</code>, the playbook will directly clean up the existing instance to make room for the new instance. This is the default behavior.</li>
<li>If <code>pg_clean</code> is <code>false</code>, the playbook will abort, which requires explicit configuration.</li>
</ul>
</li>
</ul>
<p><strong>Effects on the remove playbook</strong></p>
<p>When meeting a running instance with the same config during the execution of the <a href="/docs/pgsql/playbook/#pgsql-rmyml"><code>pgsql-rm.yml</code></a> playbook:</p>
<table>
<thead>
<tr>
<th style="text-align:center"><code>pg_safeguard</code> / <code>pg_clean</code></th>
<th style="text-align:center"><code>pg_clean=true</code></th>
<th style="text-align:center"><code>pg_clean=false</code></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>pg_safeguard=false</code></td>
<td style="text-align:center"><strong>Purge</strong> &amp; rm data</td>
<td style="text-align:center"><strong>Purge</strong></td>
</tr>
<tr>
<td style="text-align:center"><code>pg_safeguard=true</code></td>
<td style="text-align:center">Abort</td>
<td style="text-align:center">Abort</td>
</tr>
</tbody>
</table>
<ul>
<li>If <a href="/docs/reference/param/#pg_safeguard"><code>pg_safeguard</code></a> is enabled, the playbook will abort to avoid purging the running instance.</li>
<li>If the safeguard is disabled, it purges the running instance and will further decide whether to remove the existing data along with the instance according to the value of <a href="/docs/reference/param/#pg_clean"><code>pg_clean</code></a>.
<ul>
<li>If <code>pg_clean</code> is <code>true</code>, the playbook will directly clean up the PostgreSQL data cluster.</li>
<li>If <code>pg_clean</code> is <code>false</code>, the playbook will skip data purging, which requires explicit configuration.</li>
</ul>
</li>
</ul>
<hr>
<h2 id="pgsqlyml"><code>pgsql.yml</code></h2>
<p>The <a href="https://github.com/Vonng/pigsty/blob/main/pgsql.yml"><code>pgsql.yml</code></a> is used for init HA PostgreSQL clusters or adding new replicas.</p>
<p><a href="https://asciinema.org/a/566417"><img alt="asciicast" src="https://asciinema.org/a/566417.svg"></a></p>
<p><strong>This playbook contains following subtasks</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pg_clean      : cleanup existing postgres if necessary</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_dbsu       : setup os user sudo for postgres dbsu</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_install    : install postgres packages &amp; extensions</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_pkg              : install postgres related packages</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_extension        : install postgres extensions only</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_path             : link pgsql version bin to /usr/pgsql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_env              : add pgsql bin to system path</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_dir        : create postgres directories and setup fhs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_util       : copy utils scripts, setup alias and env</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_bin              : sync postgres util scripts /pg/bin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_alias            : write /etc/profile.d/pg-alias.sh</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_psql             : create psqlrc file for psql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_dummy            : create dummy placeholder file</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># patroni       : bootstrap postgres with patroni</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_config           : generate postgres config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     - pg_conf           : generate patroni config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     - pg_systemd        : generate patroni systemd config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     - pgbackrest_config : generate pgbackrest config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   -  pg_cert            : issues certificates for postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   -  pg_launch          : launch postgres primary &amp; replicas</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     - pg_watchdog       : grant watchdog permission to postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     - pg_primary        : launch patroni/postgres primary</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     - pg_init           : init pg cluster with roles/templates</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     - pg_pass           : write .pgpass file to pg home</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     - pg_replica        : launch patroni/postgres replicas</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     - pg_hba            : generate pg HBA rules</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     - patroni_reload    : reload patroni config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     - pg_patroni        : pause or remove patroni if necessary</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_user       : provision postgres business users</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_user_config      : render create user sql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_user_create      : create user on postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_db         : provision postgres business databases</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_db_config        : render create database sql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_db_create        : create database on postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_backup               : init pgbackrest repo &amp; basebackup</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pgbackrest_init     : init pgbackrest repo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pgbackrest_backup   : make a initial backup after bootstrap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pgbouncer     : deploy a pgbouncer sidecar with postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pgbouncer_clean     : cleanup existing pgbouncer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pgbouncer_dir       : create pgbouncer directories</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pgbouncer_config    : generate pgbouncer config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     -  pgbouncer_svc    : generate pgbouncer systemd config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     -  pgbouncer_ini    : generate pgbouncer main config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     -  pgbouncer_hba    : generate pgbouncer hba config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     -  pgbouncer_db     : generate pgbouncer database config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     -  pgbouncer_user   : generate pgbouncer user config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   -  pgbouncer_launch   : launch pgbouncer pooling service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   -  pgbouncer_reload   : reload pgbouncer config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_vip        : bind vip to pgsql primary with vip-manager</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_vip_config       : generate config for vip-manager</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_vip_launch       : launch vip-manager to bind vip</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_dns        : register dns name to infra dnsmasq</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_dns_ins          : register pg instance name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_dns_cls          : register pg cluster name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_service    : expose pgsql service with haproxy</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_service_config   : generate local haproxy config for pg services</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_service_reload   : expose postgres services with haproxy</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_exporter   : expose pgsql service with haproxy</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_exporter_config  : config pg_exporter &amp; pgbouncer_exporter</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_exporter_launch  : launch pg_exporter</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pgbouncer_exporter_launch : launch pgbouncer exporter</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_register   : register postgres to pigsty infrastructure</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - register_prometheus : register pg as prometheus monitor targets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - register_grafana    : register pg database as grafana datasource</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>Administration Tasks that use this playbook</strong></p>
<ul>
<li><a href="/docs/pgsql/admin/#create-cluster"><code>Create Cluster</code></a></li>
<li><a href="/docs/pgsql/admin/#append-replica"><code>Append Replica</code></a></li>
<li><a href="/docs/pgsql/admin/#reload-service"><code>Reload Service</code></a></li>
<li><a href="/docs/pgsql/admin/#reload-hbarule"><code>Reload HBARule</code></a></li>
</ul>
<p><strong>Some notes about this playbook</strong></p>
<p>When running this playbook on a single replica, You should make sure the cluster primary is already initialized.</p>
<ul>
<li>you may have to run <a href="/docs/pgsql/admin/#reload-hbarule"><code>Reload HBARule</code></a> and  <a href="/docs/pgsql/admin/#append-replica"><code>Append Replica</code></a> after replica init.</li>
<li>The wrap script <code>pgsql-add</code> will do this, check SOP: <a href="/docs/pgsql/admin/#add-instance">Add Instance</a> for details.</li>
</ul>
<hr>
<h2 id="pgsql-rmyml"><code>pgsql-rm.yml</code></h2>
<p>The playbook <a href="https://github.com/Vonng/pigsty/blob/main/pgsql-rm.yml"><code>pgsql-rm.yml</code></a> can remove PostgreSQL cluster, or specific replicas from cluster.</p>
<p><a href="https://asciinema.org/a/566418"><img alt="asciicast" src="https://asciinema.org/a/566418.svg"></a></p>
<p><strong>This playbook contains following subtasks</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># register       : remove registration in prometheus, grafana, nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - prometheus : remove monitor target from prometheus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - grafana    : remove datasource from grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># dns            : remove pg dns records</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># vip            : remove pg vip manager</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_service     : remove service definition from haproxy</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_exporter    : remove pg_exporter &amp; pgbouncer_exporter</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pgbouncer      : remove pgbouncer connection middleware</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># postgres       : remove postgres instances</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_replica : remove all replicas</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - pg_primary : remove primary instance</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   - dcs        : remove metadata from dcs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_data        : remove postgres data (disable with `pg_clean=false`),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pgbackrest     : remove postgres backup when removing primary (disable with `pgbackrest_clean=false`),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># pg_pkg         : remove postgres packages (enable with `pg_uninstall=true`)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Some arguments can affect the behavior of this playbook:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># remove pgsql cluster `pg-test`</span>
</span></span><span style="display:flex;"><span>   pgsql-rm.yml -l pg-test       <span style="color:#8f5902;font-style:italic"># remove cluster `pg-test`</span>
</span></span><span style="display:flex;"><span>       -e <span style="color:#000">pg_clean</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>          <span style="color:#8f5902;font-style:italic"># remove postgres data by default</span>
</span></span><span style="display:flex;"><span>       -e <span style="color:#000">pgbackrest_clean</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>  <span style="color:#8f5902;font-style:italic"># remove postgres backup by default (when removing primary)</span>
</span></span><span style="display:flex;"><span>       -e <span style="color:#000">pg_uninstall</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span>     <span style="color:#8f5902;font-style:italic"># do not uninstall pg packages by default, explicit override required</span>
</span></span><span style="display:flex;"><span>       -e <span style="color:#000">pg_safeguard</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span>     <span style="color:#8f5902;font-style:italic"># purge safeguard is not enabled by default, explicit override required</span>
</span></span></code></pre></div><p><strong>Administration Tasks that use this playbook</strong></p>
<ul>
<li><a href="/docs/pgsql/admin/#remove-replica"><code>Remove Replica</code></a></li>
<li><a href="/docs/pgsql/admin/#remove-cluster"><code>Remove Cluster</code></a></li>
</ul>
<p><strong>Some notes about this playbook</strong></p>
<p>Do not run this playbook on single cluster primary directly when there are still replicas.</p>
<ul>
<li>otherwise the rest replicas will trigger automatic failover.</li>
<li>It won&rsquo;t be a problem if you remove all replicas before removing primary.</li>
<li>If you run this on the entire cluster, you don&rsquo;t have to worry about this.</li>
</ul>
<p>Reload service after removing replicas from cluster</p>
<ul>
<li>When a replica is removed, it is still in the configuration file of the haproxy load balancer.</li>
<li>It is a dead server, so it won&rsquo;t affect the cluster service.</li>
<li>But you should <a href="/docs/pgsql/admin/#reload-service">reload service</a> in time to ensure the consistency between the environment and the config inventory.</li>
</ul>
<hr>
<h2 id="pgsql-useryml"><code>pgsql-user.yml</code></h2>
<p>The playbook <a href="https://github.com/Vonng/pigsty/blob/main/pgsql-user.yml"><code>pgsql-user.yml</code></a> can add new business user to existing PostgreSQL cluster.</p>
<p>Check admin SOP: <a href="/docs/pgsql/admin/#create-user"><code>Create User</code></a></p>
<hr>
<h2 id="pgsql-dbyml"><code>pgsql-db.yml</code></h2>
<p>The playbook <a href="https://github.com/Vonng/pigsty/blob/main/pgsql-db.yml"><code>pgsql-db.yml</code></a> can add new business database to existing PostgreSQL cluster.</p>
<p>Check admin SOP: <a href="/docs/pgsql/admin/#create-database"><code>Create Database</code></a></p>
<hr>
<h2 id="pgsql-monitoryml"><code>pgsql-monitor.yml</code></h2>
<p>The playbook <a href="https://github.com/Vonng/pigsty/blob/main/pgsql-monitor.yml"><code>pgsql-monitor.yml</code></a> can monitor remote postgres instance with local exporters.</p>
<p>Check admin SOP: <a href="PGSQL-MONITOR#remote-postgres"><code>Monitor Postgres</code></a></p>
<hr>
<h2 id="pgsql-migrationyml"><code>pgsql-migration.yml</code></h2>
<p>The playbook <a href="https://github.com/Vonng/pigsty/blob/main/pgsql-migration.yml"><code>pgsql-migration.yml</code></a> can generate migration manual &amp; scripts for existing PostgreSQL cluster.</p>
<p>Check admin SOP: <a href="PGSQL-MIGRATION">Migration</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7002dbf9503f9bb5f791aa73eb5fabe9">9 - Administration</h1>
    <div class="lead">Administration standard operation procedures to manage PostgreSQL clusters in production environment.</div>
	<hr>
<blockquote>
<p>How to maintain an existing PostgreSQL cluster with Pigsty?</p>
</blockquote>
<p>Here are some SOP for common pgsql admin tasks</p>
<ul>
<li>Case 1:  <a href="/docs/pgsql/admin/#create-cluster">Create Cluster</a></li>
<li>Case 2:  <a href="/docs/pgsql/admin/#create-user">Create User</a></li>
<li>Case 3:  <a href="/docs/pgsql/admin/#create-database">Create Database</a></li>
<li>Case 4:  <a href="/docs/pgsql/admin/#reload-service">Reload Service</a></li>
<li>Case 5:  <a href="/docs/pgsql/admin/#reload-hbarule">Reload HBARule</a></li>
<li>Case 6:  <a href="/docs/pgsql/admin/#config-cluster">Config Cluster</a></li>
<li>Case 7:  <a href="/docs/pgsql/admin/#append-replica">Append Replica</a></li>
<li>Case 8:  <a href="/docs/pgsql/admin/#remove-replica">Remove Replica</a></li>
<li>Case 9:  <a href="/docs/pgsql/admin/#remove-cluster">Remove Cluster</a></li>
<li>Case 10: <a href="/docs/pgsql/admin/#switchover">Switchover</a></li>
<li>Case 11: <a href="/docs/pgsql/admin/#backup-cluster">Backup Cluster</a></li>
<li>Case 12: <a href="/docs/pgsql/admin/#restore-cluster">Restore Cluster</a></li>
<li>Case 13: <a href="/docs/pgsql/admin/#adding-packages">Adding Packages</a></li>
<li>Case 14: <a href="/docs/pgsql/admin/#install-extension">Install Extension</a></li>
<li>Case 15: <a href="/docs/pgsql/admin/#minor-upgrade">Minor Upgrade</a></li>
<li>Case 16: <a href="/docs/pgsql/admin/#major-upgrade">Major Upgrade</a></li>
</ul>
<hr>
<h2 id="cheatsheet">Cheatsheet</h2>
<p>PGSQL playbooks and shortcuts:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-add   &lt;cls&gt;                   <span style="color:#8f5902;font-style:italic"># create pgsql cluster &lt;cls&gt;</span>
</span></span><span style="display:flex;"><span>bin/pgsql-user  &lt;cls&gt; &lt;username&gt;        <span style="color:#8f5902;font-style:italic"># create pg user &lt;username&gt; on &lt;cls&gt;</span>
</span></span><span style="display:flex;"><span>bin/pgsql-db    &lt;cls&gt; &lt;dbname&gt;          <span style="color:#8f5902;font-style:italic"># create pg database &lt;dbname&gt; on &lt;cls&gt;</span>
</span></span><span style="display:flex;"><span>bin/pgsql-svc   &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>...ip<span style="color:#ce5c00;font-weight:bold">]</span>           <span style="color:#8f5902;font-style:italic"># reload pg service of cluster &lt;cls&gt;</span>
</span></span><span style="display:flex;"><span>bin/pgsql-hba   &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>...ip<span style="color:#ce5c00;font-weight:bold">]</span>           <span style="color:#8f5902;font-style:italic"># reload postgres/pgbouncer HBA rules of cluster &lt;cls&gt;</span>
</span></span><span style="display:flex;"><span>bin/pgsql-add   &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>...ip<span style="color:#ce5c00;font-weight:bold">]</span>           <span style="color:#8f5902;font-style:italic"># append replicas for cluster &lt;cls&gt;</span>
</span></span><span style="display:flex;"><span>bin/pgsql-rm    &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>...ip<span style="color:#ce5c00;font-weight:bold">]</span>           <span style="color:#8f5902;font-style:italic"># remove replicas from cluster &lt;cls&gt;</span>
</span></span><span style="display:flex;"><span>bin/pgsql-rm    &lt;cls&gt;                   <span style="color:#8f5902;font-style:italic"># remove pgsql cluster &lt;cls&gt;</span>
</span></span></code></pre></div><p>Patroni admin command and shortcuts:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg list        &lt;cls&gt;                    <span style="color:#8f5902;font-style:italic"># print cluster info</span>
</span></span><span style="display:flex;"><span>pg edit-config &lt;cls&gt;                    <span style="color:#8f5902;font-style:italic"># edit cluster config </span>
</span></span><span style="display:flex;"><span>pg reload      &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>ins<span style="color:#ce5c00;font-weight:bold">]</span>              <span style="color:#8f5902;font-style:italic"># reload cluster config</span>
</span></span><span style="display:flex;"><span>pg restart     &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>ins<span style="color:#ce5c00;font-weight:bold">]</span>              <span style="color:#8f5902;font-style:italic"># restart pgsql cluster</span>
</span></span><span style="display:flex;"><span>pg reinit      &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>ins<span style="color:#ce5c00;font-weight:bold">]</span>              <span style="color:#8f5902;font-style:italic"># reinit cluster members</span>
</span></span><span style="display:flex;"><span>pg pause       &lt;cls&gt;                    <span style="color:#8f5902;font-style:italic"># entering maintenance mode (no auto failover)</span>
</span></span><span style="display:flex;"><span>pg resume      &lt;cls&gt;                    <span style="color:#8f5902;font-style:italic"># exiting maintenance mode</span>
</span></span><span style="display:flex;"><span>pg switchover  &lt;cls&gt;                    <span style="color:#8f5902;font-style:italic"># switchover on cluster &lt;cls&gt;</span>
</span></span><span style="display:flex;"><span>pg failover    &lt;cls&gt;                    <span style="color:#8f5902;font-style:italic"># failover on cluster &lt;cls&gt;</span>
</span></span></code></pre></div><p>pgBackRest backup &amp; restore command and shortcuts:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pb info                                 <span style="color:#8f5902;font-style:italic"># print pgbackrest repo info</span>
</span></span><span style="display:flex;"><span>pg-backup                               <span style="color:#8f5902;font-style:italic"># make a backup, incr, or full backup if necessary</span>
</span></span><span style="display:flex;"><span>pg-backup full                          <span style="color:#8f5902;font-style:italic"># make a full backup</span>
</span></span><span style="display:flex;"><span>pg-backup diff                          <span style="color:#8f5902;font-style:italic"># make a differential backup</span>
</span></span><span style="display:flex;"><span>pg-backup incr                          <span style="color:#8f5902;font-style:italic"># make a incremental backup</span>
</span></span><span style="display:flex;"><span>pg-pitr -i                              <span style="color:#8f5902;font-style:italic"># restore to the time of latest backup complete (not often used)</span>
</span></span><span style="display:flex;"><span>pg-pitr --time<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2022-12-30 14:44:44+08&#34;</span> <span style="color:#8f5902;font-style:italic"># restore to specific time point (in case of drop db, drop table)</span>
</span></span><span style="display:flex;"><span>pg-pitr --name<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;my-restore-point&#34;</span>       <span style="color:#8f5902;font-style:italic"># restore TO a named restore point create by pg_create_restore_point</span>
</span></span><span style="display:flex;"><span>pg-pitr --lsn<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;0/7C82CB8&#34;</span> -X            <span style="color:#8f5902;font-style:italic"># restore right BEFORE a LSN</span>
</span></span><span style="display:flex;"><span>pg-pitr --xid<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;1234567&#34;</span> -X -P           <span style="color:#8f5902;font-style:italic"># restore right BEFORE a specific transaction id, then promote</span>
</span></span><span style="display:flex;"><span>pg-pitr --backup<span style="color:#ce5c00;font-weight:bold">=</span>latest                 <span style="color:#8f5902;font-style:italic"># restore to latest backup set</span>
</span></span><span style="display:flex;"><span>pg-pitr --backup<span style="color:#ce5c00;font-weight:bold">=</span>20221108-105325        <span style="color:#8f5902;font-style:italic"># restore to a specific backup set, which can be checked with pgbackrest info</span>
</span></span></code></pre></div><p>Systemd components quick reference</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl stop patroni                  <span style="color:#8f5902;font-style:italic"># start stop restart reload</span>
</span></span><span style="display:flex;"><span>systemctl stop pgbouncer                <span style="color:#8f5902;font-style:italic"># start stop restart reload</span>
</span></span><span style="display:flex;"><span>systemctl stop pg_exporter              <span style="color:#8f5902;font-style:italic"># start stop restart reload</span>
</span></span><span style="display:flex;"><span>systemctl stop pgbouncer_exporter       <span style="color:#8f5902;font-style:italic"># start stop restart reload</span>
</span></span><span style="display:flex;"><span>systemctl stop node_exporter            <span style="color:#8f5902;font-style:italic"># start stop restart</span>
</span></span><span style="display:flex;"><span>systemctl stop haproxy                  <span style="color:#8f5902;font-style:italic"># start stop restart reload</span>
</span></span><span style="display:flex;"><span>systemctl stop vip-manager              <span style="color:#8f5902;font-style:italic"># start stop restart reload</span>
</span></span><span style="display:flex;"><span>systemctl stop postgres                 <span style="color:#8f5902;font-style:italic"># only when patroni_mode == &#39;remove&#39;</span>
</span></span></code></pre></div><hr>
<h2 id="create-cluster">Create Cluster</h2>
<p>To create a new Postgres cluster, define it in the inventory first, then init with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/node-add &lt;cls&gt;                <span style="color:#8f5902;font-style:italic"># init nodes for cluster &lt;cls&gt;           # ./node.yml  -l &lt;cls&gt; </span>
</span></span><span style="display:flex;"><span>bin/pgsql-add &lt;cls&gt;               <span style="color:#8f5902;font-style:italic"># init pgsql instances of cluster &lt;cls&gt;  # ./pgsql.yml -l &lt;cls&gt;</span>
</span></span></code></pre></div><blockquote>
<p>Beware, perform <code>bin/node-add</code> first, then <code>bin/pgsql-add</code>, PGSQL works on managed nodes only.</p>
</blockquote>
<details><summary>Example: Create Cluster</summary>
<p><a href="https://asciinema.org/a/568810"><img alt="asciicast" src="https://asciinema.org/a/568810.svg"></a></p>
</details>
<hr>
<h2 id="create-user">Create User</h2>
<p>To create a new business user on the existing Postgres cluster, add user definition to <code>all.children.&lt;cls&gt;.pg_users</code>, then create the user as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;   <span style="color:#8f5902;font-style:italic"># ./pgsql-user.yml -l &lt;cls&gt; -e username=&lt;username&gt;</span>
</span></span></code></pre></div><details><summary>Example: Create Business User</summary>
<p><a href="https://asciinema.org/a/568789"><img alt="asciicast" src="https://asciinema.org/a/568789.svg"></a></p>
</details>
<hr>
<h2 id="create-database">Create Database</h2>
<p>To create a new database user on the existing Postgres cluster, add database definition to <code>all.children.&lt;cls&gt;.pg_databases</code>, then create the database as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-db &lt;cls&gt; &lt;dbname&gt;       <span style="color:#8f5902;font-style:italic"># ./pgsql-db.yml -l &lt;cls&gt; -e dbname=&lt;dbname&gt;</span>
</span></span></code></pre></div><p>Note: If the database has specified an owner, the user should already exist, or you&rsquo;ll have to <a href="/docs/pgsql/admin/#create-user">Create User</a> first.</p>
<details><summary>Example: Create Business Database</summary>
<p><a href="https://asciinema.org/a/568790"><img alt="asciicast" src="https://asciinema.org/a/568790.svg"></a></p>
</details>
<hr>
<h2 id="reload-service">Reload Service</h2>
<p>Services are exposed access point served by HAProxy.</p>
<p>This task is used when cluster membership has changed, e.g., <a href="/docs/pgsql/admin/#append-replica">append</a>/<a href="/docs/pgsql/admin/#remove-replica">remove</a> replicas, <a href="/docs/pgsql/admin/#switchover">switchover</a>/failover / exposing new service or updating existing service&rsquo;s config (e.g., LB Weight)</p>
<p>To create new services or reload existing services on entire proxy cluster or specific instances:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-svc &lt;cls&gt;               <span style="color:#8f5902;font-style:italic"># pgsql.yml -l &lt;cls&gt; -t pg_service -e pg_reload=true</span>
</span></span><span style="display:flex;"><span>bin/pgsql-svc &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>ip...<span style="color:#ce5c00;font-weight:bold">]</span>       <span style="color:#8f5902;font-style:italic"># pgsql.yml -l ip... -t pg_service -e pg_reload=true</span>
</span></span></code></pre></div><details><summary>Example: Reload PG Service to Kick one Instance</summary>
<p><a href="https://asciinema.org/a/568815"><img alt="asciicast" src="https://asciinema.org/a/568815.svg"></a></p>
</details>
<hr>
<h2 id="reload-hbarule">Reload HBARule</h2>
<p>This task is used when your Postgres/Pgbouncer HBA rules have changed, you <em>may</em> have to reload hba to apply changes.</p>
<p>If you have any role-specific HBA rules, you may have to reload hba after a switchover/failover, too.</p>
<p>To reload postgres &amp; pgbouncer HBA rules on entire cluster or specific instances:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-hba &lt;cls&gt;               <span style="color:#8f5902;font-style:italic"># pgsql.yml -l &lt;cls&gt; -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e pg_reload=true</span>
</span></span><span style="display:flex;"><span>bin/pgsql-hba &lt;cls&gt; <span style="color:#ce5c00;font-weight:bold">[</span>ip...<span style="color:#ce5c00;font-weight:bold">]</span>       <span style="color:#8f5902;font-style:italic"># pgsql.yml -l ip... -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e pg_reload=true</span>
</span></span></code></pre></div><details><summary>Example: Reload Cluster HBA Rules</summary>
<p><a href="https://asciinema.org/a/568794"><img alt="asciicast" src="https://asciinema.org/a/568794.svg"></a></p>
</details>
<hr>
<h2 id="config-cluster">Config Cluster</h2>
<p>To change the config of a existing Postgres cluster, you have to initiate control command on <strong>admin node with admin user</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg edit-config &lt;cls&gt;              <span style="color:#8f5902;font-style:italic"># interactive config a cluster with patronictl</span>
</span></span></code></pre></div><p>Change patroni parameters &amp; <code>postgresql.parameters</code>, save &amp; apply changes with the wizard.</p>
<details><summary>Example: Config Cluster in Non-Interactive Manner</summary>
<p>You can skip interactive mode and use <code>-p</code> option to override postgres parameters, for example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg edit-config -p <span style="color:#000">log_min_duration_statement</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1000</span> pg-test
</span></span><span style="display:flex;"><span>pg edit-config --force -p <span style="color:#000">shared_preload_libraries</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;timescaledb, pg_cron, pg_stat_statements, auto_explain&#39;</span>
</span></span></code></pre></div></details>
<details><summary>Example: Change Cluster Config with Patroni REST API</summary>
<p>You can also use <a href="https://patroni.readthedocs.io/en/latest/rest_api.html">Patroni REST API</a> to change the config in a non-interactive mode, for example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -s 10.10.10.11:8008/config <span style="color:#000;font-weight:bold">|</span> jq .  <span style="color:#8f5902;font-style:italic"># get current config</span>
</span></span><span style="display:flex;"><span>$ curl -u <span style="color:#4e9a06">&#39;postgres:Patroni.API&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>        -d <span style="color:#4e9a06">&#39;{&#34;postgresql&#34;:{&#34;parameters&#34;: {&#34;log_min_duration_statement&#34;:200}}}&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>        -s -X PATCH http://10.10.10.11:8008/config <span style="color:#000;font-weight:bold">|</span> jq .
</span></span></code></pre></div><p>Note: patroni unsafe RestAPI access is limit from infra/admin nodes and protected with an HTTP basic auth username/password and an optional HTTPS mode.</p>
</details>
<details><summary>Example: Config Cluster with patronictl</summary>
<p><a href="https://asciinema.org/a/568799"><img alt="asciicast" src="https://asciinema.org/a/568799.svg"></a></p>
</details>
<hr>
<h2 id="append-replica">Append Replica</h2>
<p>To add a new replica to the existing Postgres cluster, you have to add its definition to the inventory: <code>all.children.&lt;cls&gt;.hosts</code>, then:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/node-add &lt;ip&gt;                 <span style="color:#8f5902;font-style:italic"># init node &lt;ip&gt; for the new replica               </span>
</span></span><span style="display:flex;"><span>bin/pgsql-add &lt;cls&gt; &lt;ip&gt;          <span style="color:#8f5902;font-style:italic"># init pgsql instances on &lt;ip&gt; for cluster &lt;cls&gt;  </span>
</span></span></code></pre></div><p>It will add node <code>&lt;ip&gt;</code> to pigsty and init it as a replica of the cluster <code>&lt;cls&gt;</code>.</p>
<p>Cluster services will be <a href="/docs/pgsql/admin/#reload-service">reloaded</a> to adopt the new member</p>
<details><summary>Example: Add replica to pg-test </summary>
<p><a href="https://asciinema.org/a/566421"><img alt="asciicast" src="https://asciinema.org/a/566421.svg"></a></p>
<p>For example, if you want to add a <code>pg-test-3 / 10.10.10.13</code> to the existing cluster <code>pg-test</code>, you&rsquo;ll have to update the inventory first:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg-test:
</span></span><span style="display:flex;"><span>  hosts:
</span></span><span style="display:flex;"><span>    10.10.10.11: <span style="color:#ce5c00;font-weight:bold">{</span> pg_seq: 1, pg_role: primary <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#8f5902;font-style:italic"># existing member</span>
</span></span><span style="display:flex;"><span>    10.10.10.12: <span style="color:#ce5c00;font-weight:bold">{</span> pg_seq: 2, pg_role: replica <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#8f5902;font-style:italic"># existing member</span>
</span></span><span style="display:flex;"><span>    10.10.10.13: <span style="color:#ce5c00;font-weight:bold">{</span> pg_seq: 3, pg_role: replica <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#8f5902;font-style:italic"># &lt;--- new member</span>
</span></span><span style="display:flex;"><span>  vars: <span style="color:#ce5c00;font-weight:bold">{</span> pg_cluster: pg-test <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>then apply the change as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/node-add          10.10.10.13   <span style="color:#8f5902;font-style:italic"># add node to pigsty</span>
</span></span><span style="display:flex;"><span>bin/pgsql-add pg-test 10.10.10.13   <span style="color:#8f5902;font-style:italic"># init new replica on 10.10.10.13 for cluster pg-test</span>
</span></span></code></pre></div><p>which is similar to cluster init but only works on single instance.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> init instances  10.10.10.11 to pgsql cluster <span style="color:#4e9a06">&#39;pg-test&#39;</span>:
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span>   reminder: add nodes to pigsty, <span style="color:#204a87;font-weight:bold">then</span> install additional module <span style="color:#4e9a06">&#39;pgsql&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>HINT<span style="color:#ce5c00;font-weight:bold">]</span>     $ bin/node-add  10.10.10.11  <span style="color:#8f5902;font-style:italic"># run this ahead, except infra nodes</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span>   init instances from cluster:
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span>     $ ./pgsql.yml -l <span style="color:#4e9a06">&#39;10.10.10.11,&amp;pg-test&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span>   reload pg_service on existing instances:
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span>     $ ./pgsql.yml -l <span style="color:#4e9a06">&#39;pg-test,!10.10.10.11&#39;</span> -t pg_service
</span></span></code></pre></div></details>
<hr>
<h2 id="remove-replica">Remove Replica</h2>
<p>To remove a replica from the existing PostgreSQL cluster:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-rm &lt;cls&gt; &lt;ip...&gt;        <span style="color:#8f5902;font-style:italic"># ./pgsql-rm.yml -l &lt;ip&gt;</span>
</span></span></code></pre></div><p>It will remove instance <code>&lt;ip&gt;</code> from cluster <code>&lt;cls&gt;</code>.
Cluster services will be <a href="/docs/pgsql/admin/#reload-service">reloaded</a> to kick the removed instance from load balancer.</p>
<details><summary>Example: Remove replica from pg-test </summary>
<p><a href="https://asciinema.org/a/566419"><img alt="asciicast" src="https://asciinema.org/a/566419.svg"></a></p>
<p>For example, if you want to remove <code>pg-test-3 / 10.10.10.13</code> from the existing cluster <code>pg-test</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-rm pg-test 10.10.10.13  <span style="color:#8f5902;font-style:italic"># remove pgsql instance 10.10.10.13 from pg-test</span>
</span></span><span style="display:flex;"><span>bin/node-rm  10.10.10.13          <span style="color:#8f5902;font-style:italic"># remove that node from pigsty (optional)</span>
</span></span><span style="display:flex;"><span>vi pigsty.yml                     <span style="color:#8f5902;font-style:italic"># remove instance definition from inventory</span>
</span></span><span style="display:flex;"><span>bin/pgsql-svc pg-test             <span style="color:#8f5902;font-style:italic"># refresh pg_service on existing instances to kick removed instance from load balancer</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span> remove pgsql instances from  10.10.10.13 of <span style="color:#4e9a06">&#39;pg-test&#39;</span>:
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARN<span style="color:#ce5c00;font-weight:bold">]</span>   remove instances from cluster:
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> OK <span style="color:#ce5c00;font-weight:bold">]</span>     $ ./pgsql-rm.yml -l <span style="color:#4e9a06">&#39;10.10.10.13,&amp;pg-test&#39;</span>
</span></span></code></pre></div><p>And remove instance definition from the inventory:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.12</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.13</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 3, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replica }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;--- remove this after execution</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Finally, you can update pg service and kick the removed instance from load balancer:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-svc pg-test             <span style="color:#8f5902;font-style:italic"># reload pg service on pg-test</span>
</span></span></code></pre></div></details>
<hr>
<h2 id="remove-cluster">Remove Cluster</h2>
<p>To remove the entire Postgres cluster, just run:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgsql-rm &lt;cls&gt;                <span style="color:#8f5902;font-style:italic"># ./pgsql-rm.yml -l &lt;cls&gt;</span>
</span></span></code></pre></div><details><summary>Example: Remove Cluster</summary>
<p><a href="https://asciinema.org/a/566418"><img alt="asciicast" src="https://asciinema.org/a/566418.svg"></a></p>
</details>
<details><summary>Example: Force removing a cluster</summary>
<p>Note: if <a href="/docs/reference/param/#pg_safeguard"><code>pg_safeguard</code></a> is configured for this cluster (or globally configured to <code>true</code>), <code>pgsql-rm.yml</code> will abort to avoid removing a cluster by accident.</p>
<p>You can use playbook command line args to explicitly overwrite it to force the purge:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql-rm.yml -l pg-meta -e <span style="color:#000">pg_safeguard</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span>    <span style="color:#8f5902;font-style:italic"># force removing pg cluster pg-meta</span>
</span></span></code></pre></div></details>
<hr>
<h2 id="switchover">Switchover</h2>
<p>You can perform a PostgreSQL cluster switchover with patroni cmd.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg switchover &lt;cls&gt;   <span style="color:#8f5902;font-style:italic"># interactive mode, you can skip that with following options</span>
</span></span><span style="display:flex;"><span>pg switchover --leader pg-test-1 --candidate<span style="color:#ce5c00;font-weight:bold">=</span>pg-test-2 --scheduled<span style="color:#ce5c00;font-weight:bold">=</span>now --force pg-test
</span></span></code></pre></div><details><summary>Example: Switchover pg-test</summary>
<p><a href="https://asciinema.org/a/566248"><img alt="asciicast" src="https://asciinema.org/a/566248.svg"></a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg switchover pg-test
</span></span><span style="display:flex;"><span>Master <span style="color:#ce5c00;font-weight:bold">[</span>pg-test-1<span style="color:#ce5c00;font-weight:bold">]</span>:
</span></span><span style="display:flex;"><span>Candidate <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#39;pg-test-2&#39;</span>, <span style="color:#4e9a06">&#39;pg-test-3&#39;</span><span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[]</span>: pg-test-2
</span></span><span style="display:flex;"><span>When should the switchover take place <span style="color:#ce5c00;font-weight:bold">(</span>e.g. 2022-12-26T07:39 <span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#ce5c00;font-weight:bold">[</span>now<span style="color:#ce5c00;font-weight:bold">]</span>: now
</span></span><span style="display:flex;"><span>Current cluster topology
</span></span><span style="display:flex;"><span>+ Cluster: pg-test <span style="color:#ce5c00;font-weight:bold">(</span>7181325041648035869<span style="color:#ce5c00;font-weight:bold">)</span> -----+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> Member    <span style="color:#000;font-weight:bold">|</span> Host        <span style="color:#000;font-weight:bold">|</span> Role    <span style="color:#000;font-weight:bold">|</span> State   <span style="color:#000;font-weight:bold">|</span> TL <span style="color:#000;font-weight:bold">|</span> Lag in MB <span style="color:#000;font-weight:bold">|</span> Tags            <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+---------+---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-1 <span style="color:#000;font-weight:bold">|</span> 10.10.10.11 <span style="color:#000;font-weight:bold">|</span> Leader  <span style="color:#000;font-weight:bold">|</span> running <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> conf: tiny.yml  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> spec: 1C.2G.50G <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> version: <span style="color:#4e9a06">&#39;15&#39;</span>   <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+---------+---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-2 <span style="color:#000;font-weight:bold">|</span> 10.10.10.12 <span style="color:#000;font-weight:bold">|</span> Replica <span style="color:#000;font-weight:bold">|</span> running <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> conf: tiny.yml  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> spec: 1C.2G.50G <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> version: <span style="color:#4e9a06">&#39;15&#39;</span>   <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+---------+---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-3 <span style="color:#000;font-weight:bold">|</span> 10.10.10.13 <span style="color:#000;font-weight:bold">|</span> Replica <span style="color:#000;font-weight:bold">|</span> running <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> conf: tiny.yml  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> spec: 1C.2G.50G <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> version: <span style="color:#4e9a06">&#39;15&#39;</span>   <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+---------+---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span>Are you sure you want to switchover cluster pg-test, demoting current master pg-test-1? <span style="color:#ce5c00;font-weight:bold">[</span>y/N<span style="color:#ce5c00;font-weight:bold">]</span>: y
</span></span><span style="display:flex;"><span>2022-12-26 06:39:58.02468 Successfully switched over to <span style="color:#4e9a06">&#34;pg-test-2&#34;</span>
</span></span><span style="display:flex;"><span>+ Cluster: pg-test <span style="color:#ce5c00;font-weight:bold">(</span>7181325041648035869<span style="color:#ce5c00;font-weight:bold">)</span> -----+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> Member    <span style="color:#000;font-weight:bold">|</span> Host        <span style="color:#000;font-weight:bold">|</span> Role    <span style="color:#000;font-weight:bold">|</span> State   <span style="color:#000;font-weight:bold">|</span> TL <span style="color:#000;font-weight:bold">|</span> Lag in MB <span style="color:#000;font-weight:bold">|</span> Tags            <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+---------+---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-1 <span style="color:#000;font-weight:bold">|</span> 10.10.10.11 <span style="color:#000;font-weight:bold">|</span> Replica <span style="color:#000;font-weight:bold">|</span> stopped <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>   unknown <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> conf: tiny.yml  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> spec: 1C.2G.50G <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> version: <span style="color:#4e9a06">&#39;15&#39;</span>   <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+---------+---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-2 <span style="color:#000;font-weight:bold">|</span> 10.10.10.12 <span style="color:#000;font-weight:bold">|</span> Leader  <span style="color:#000;font-weight:bold">|</span> running <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> conf: tiny.yml  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> spec: 1C.2G.50G <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> version: <span style="color:#4e9a06">&#39;15&#39;</span>   <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+---------+---------+----+-----------+-----------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> pg-test-3 <span style="color:#000;font-weight:bold">|</span> 10.10.10.13 <span style="color:#000;font-weight:bold">|</span> Replica <span style="color:#000;font-weight:bold">|</span> running <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">|</span> clonefrom: <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> conf: tiny.yml  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> spec: 1C.2G.50G <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>             <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>         <span style="color:#000;font-weight:bold">|</span>    <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span> version: <span style="color:#4e9a06">&#39;15&#39;</span>   <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------+-------------+---------+---------+----+-----------+-----------------+
</span></span></code></pre></div><p>To do so with Patroni API (schedule a switchover from 2 to 1 at a specific time):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -u <span style="color:#4e9a06">&#39;postgres:Patroni.API&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -d <span style="color:#4e9a06">&#39;{&#34;leader&#34;:&#34;pg-test-2&#34;, &#34;candidate&#34;: &#34;pg-test-1&#34;,&#34;scheduled_at&#34;:&#34;2022-12-26T14:47+08&#34;}&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -s -X POST http://10.10.10.11:8008/switchover
</span></span></code></pre></div></details>
<hr>
<h2 id="backup-cluster">Backup Cluster</h2>
<p>To create a backup with pgBackRest, run as local dbsu:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg-backup                         <span style="color:#8f5902;font-style:italic"># make a postgres base backup</span>
</span></span><span style="display:flex;"><span>pg-backup full                    <span style="color:#8f5902;font-style:italic"># make a full backup</span>
</span></span><span style="display:flex;"><span>pg-backup diff                    <span style="color:#8f5902;font-style:italic"># make a differential backup</span>
</span></span><span style="display:flex;"><span>pg-backup incr                    <span style="color:#8f5902;font-style:italic"># make a incremental backup</span>
</span></span><span style="display:flex;"><span>pb info                           <span style="color:#8f5902;font-style:italic"># check backup information</span>
</span></span></code></pre></div><p>Check <a href="/docs/pgsql/pitr/">Backup</a> &amp; PITR for details.</p>
<details><summary>Example: Make Backups</summary>
<p><a href="https://asciinema.org/a/568813"><img alt="asciicast" src="https://asciinema.org/a/568813.svg"></a></p>
</details>
<details><summary>Example: Create routine backup crontab</summary>
<p>You can add crontab to <a href="/docs/reference/param/#node_crontab"><code>node_crontab</code></a> to specify your backup policy.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># make a full backup 1 am everyday</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#4e9a06">&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># rotate backup: make a full backup on monday 1am, and an incremental backup during weekdays</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#4e9a06">&#39;00 01 * * 1 postgres /pg/bin/pg-backup full&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#4e9a06">&#39;00 01 * * 2,3,4,5,6,7 postgres /pg/bin/pg-backup&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></details>
<hr>
<h2 id="restore-cluster">Restore Cluster</h2>
<p>To restore a cluster to a previous time point (PITR), run as local dbsu:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg-pitr -i                              <span style="color:#8f5902;font-style:italic"># restore to the time of latest backup complete (not often used)</span>
</span></span><span style="display:flex;"><span>pg-pitr --time<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2022-12-30 14:44:44+08&#34;</span> <span style="color:#8f5902;font-style:italic"># restore to specific time point (in case of drop db, drop table)</span>
</span></span><span style="display:flex;"><span>pg-pitr --name<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;my-restore-point&#34;</span>       <span style="color:#8f5902;font-style:italic"># restore TO a named restore point create by pg_create_restore_point</span>
</span></span><span style="display:flex;"><span>pg-pitr --lsn<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;0/7C82CB8&#34;</span> -X            <span style="color:#8f5902;font-style:italic"># restore right BEFORE a LSN</span>
</span></span><span style="display:flex;"><span>pg-pitr --xid<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;1234567&#34;</span> -X -P           <span style="color:#8f5902;font-style:italic"># restore right BEFORE a specific transaction id, then promote</span>
</span></span><span style="display:flex;"><span>pg-pitr --backup<span style="color:#ce5c00;font-weight:bold">=</span>latest                 <span style="color:#8f5902;font-style:italic"># restore to latest backup set</span>
</span></span><span style="display:flex;"><span>pg-pitr --backup<span style="color:#ce5c00;font-weight:bold">=</span>20221108-105325        <span style="color:#8f5902;font-style:italic"># restore to a specific backup set, which can be checked with pgbackrest info</span>
</span></span></code></pre></div><p>And follow the instructions wizard, Check Backup &amp; <a href="/docs/pgsql/pitr/">PITR</a> for details.</p>
<details><summary>Example: PITR with raw pgBackRest Command</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># restore to the latest available point (e.g. hardware failure)</span>
</span></span><span style="display:flex;"><span>pgbackrest --stanza<span style="color:#ce5c00;font-weight:bold">=</span>pg-meta restore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># PITR to specific time point (e.g. drop table by accident)</span>
</span></span><span style="display:flex;"><span>pgbackrest --stanza<span style="color:#ce5c00;font-weight:bold">=</span>pg-meta --type<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">time</span> --target<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2022-11-08 10:58:48&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>   --target-action<span style="color:#ce5c00;font-weight:bold">=</span>promote restore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># restore specific backup point and then promote (or pause|shutdown)</span>
</span></span><span style="display:flex;"><span>pgbackrest --stanza<span style="color:#ce5c00;font-weight:bold">=</span>pg-meta --type<span style="color:#ce5c00;font-weight:bold">=</span>immediate --target-action<span style="color:#ce5c00;font-weight:bold">=</span>promote <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --set<span style="color:#ce5c00;font-weight:bold">=</span>20221108-105325F_20221108-105938I restore
</span></span></code></pre></div></details>
<hr>
<h2 id="adding-packages">Adding Packages</h2>
<p>To add newer version of RPM packages, you have to add them to <a href="/docs/reference/param/#repo_packages"><code>repo_packages</code></a> and <a href="/docs/reference/param/#repo_url_packages"><code>repo_url_packages</code></a></p>
<p>Then rebuild repo on infra nodes with <code>./infra.yml -t repo_build</code> subtask, Then you can install these packages with <code>ansible</code> module <code>package</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible pg-test -b -m package -a <span style="color:#4e9a06">&#34;name=pg_cron_15,topn_15,pg_stat_monitor_15*&#34;</span>  <span style="color:#8f5902;font-style:italic"># install some packages</span>
</span></span></code></pre></div><details><summary>Update Packages Manually</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># add repo upstream on admin node, then download them manually</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty<span style="color:#000;font-weight:bold">;</span> ./infra.yml -t repo_upstream,repo_cache <span style="color:#8f5902;font-style:italic"># add upstream repo (internet)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> /www/pigsty<span style="color:#000;font-weight:bold">;</span>  repotrack <span style="color:#4e9a06">&#34;some_new_package_name&#34;</span>   <span style="color:#8f5902;font-style:italic"># download the latest RPMs</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># re-create local repo on admin node, then refresh yum/apt cache on all nodes</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty<span style="color:#000;font-weight:bold">;</span> ./infra.yml -t repo_create              <span style="color:#8f5902;font-style:italic"># recreate local repo on admin node</span>
</span></span><span style="display:flex;"><span>./node.yml -t node_repo                              <span style="color:#8f5902;font-style:italic"># refresh yum/apt cache on all nodes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># alternatives: clean and remake cache on all nodes with ansible command</span>
</span></span><span style="display:flex;"><span>ansible all -b -a <span style="color:#4e9a06">&#39;yum clean all&#39;</span>                         <span style="color:#8f5902;font-style:italic"># clean node repo cache</span>
</span></span><span style="display:flex;"><span>ansible all -b -a <span style="color:#4e9a06">&#39;yum makecache&#39;</span>                         <span style="color:#8f5902;font-style:italic"># remake cache from the new repo</span>
</span></span><span style="display:flex;"><span>ansible all -b -a <span style="color:#4e9a06">&#39;apt clean&#39;</span>                             <span style="color:#8f5902;font-style:italic"># clean node repo cache (Ubuntu/Debian)</span>
</span></span><span style="display:flex;"><span>ansible all -b -a <span style="color:#4e9a06">&#39;apt update&#39;</span>                            <span style="color:#8f5902;font-style:italic"># remake cache from the new repo (Ubuntu/Debian)</span>
</span></span></code></pre></div><p>For example, you can then install or upgrade packages with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible pg-test -b -m package -a <span style="color:#4e9a06">&#34;name=postgresql15* state=latest&#34;</span>
</span></span></code></pre></div></details>
<hr>
<h2 id="install-extension">Install Extension</h2>
<p>If you want to install extension on pg clusters, Add them to <a href="/docs/reference/param/#pg_extensions"><code>pg_extensions</code></a> and make sure them installed with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_extension     <span style="color:#8f5902;font-style:italic"># install extensions</span>
</span></span></code></pre></div><p>Some extension needs to be loaded in <code>shared_preload_libraries</code>, You can add them to <a href="/docs/reference/param/#pg_libs"><code>pg_libs</code></a>, or <a href="/docs/pgsql/admin/#config-cluster">Config</a> an existing cluster.</p>
<p>Finally, <code>CREATE EXTENSION &lt;extname&gt;;</code> on the cluster primary instance to install it.</p>
<details><summary>Example: Install pg_cron on pg-test cluster</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible pg-test -b -m package -a <span style="color:#4e9a06">&#34;name=pg_cron_15&#34;</span>          <span style="color:#8f5902;font-style:italic"># install pg_cron packages on all nodes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># add pg_cron to shared_preload_libraries</span>
</span></span><span style="display:flex;"><span>pg edit-config --force -p <span style="color:#000">shared_preload_libraries</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;timescaledb, pg_cron, pg_stat_statements, auto_explain&#39;</span>
</span></span><span style="display:flex;"><span>pg restart --force pg-test                                  <span style="color:#8f5902;font-style:italic"># restart cluster</span>
</span></span><span style="display:flex;"><span>psql -h pg-test -d postgres -c <span style="color:#4e9a06">&#39;CREATE EXTENSION pg_cron;&#39;</span>  <span style="color:#8f5902;font-style:italic"># install pg_cron on primary</span>
</span></span></code></pre></div></details>
<p>Check <a href="/docs/pgext/usage/install/">PGSQL Extensions: Install</a> for details.</p>
<hr>
<h2 id="minor-upgrade">Minor Upgrade</h2>
<p>To perform a minor server version upgrade/downgrade, you have to <a href="/docs/pgsql/admin/#adding-packages">add packages</a> to yum/apt repo first.</p>
<p>Then perform a rolling upgrade/downgrade from all replicas, then switchover the cluster to upgrade the leader.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible &lt;cls&gt; -b -a <span style="color:#4e9a06">&#34;yum upgrade/downgrade -y &lt;pkg&gt;&#34;</span>    <span style="color:#8f5902;font-style:italic"># upgrade/downgrade packages</span>
</span></span><span style="display:flex;"><span>pg restart --force &lt;cls&gt;                                <span style="color:#8f5902;font-style:italic"># restart cluster</span>
</span></span></code></pre></div><details><summary>Example: Downgrade PostgreSQL 15.2 to 15.1</summary>
<p>Add 15.1 packages to yum/apt repo and refresh node package manager cache:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty<span style="color:#000;font-weight:bold">;</span> ./infra.yml -t repo_upstream               <span style="color:#8f5902;font-style:italic"># add upstream repo backup</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> /www/pigsty<span style="color:#000;font-weight:bold">;</span> repotrack postgresql15-*-15.1           <span style="color:#8f5902;font-style:italic"># add 15.1 packages to yum repo</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/pigsty<span style="color:#000;font-weight:bold">;</span> ./infra.yml -t repo_create                 <span style="color:#8f5902;font-style:italic"># re-create repo</span>
</span></span><span style="display:flex;"><span>ansible pg-test -b -a <span style="color:#4e9a06">&#39;yum clean all&#39;</span>                   <span style="color:#8f5902;font-style:italic"># clean node repo cache (use apt in debian/ubuntu)</span>
</span></span><span style="display:flex;"><span>ansible pg-test -b -a <span style="color:#4e9a06">&#39;yum makecache&#39;</span>                   <span style="color:#8f5902;font-style:italic"># remake yum cache from the new repo</span>
</span></span></code></pre></div><p>Perform a downgrade and restart the cluster:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible pg-test -b -a <span style="color:#4e9a06">&#34;yum downgrade -y postgresql15*&#34;</span>  <span style="color:#8f5902;font-style:italic"># downgrade packages</span>
</span></span><span style="display:flex;"><span>pg restart --force pg-test                              <span style="color:#8f5902;font-style:italic"># restart entire cluster to finish upgrade</span>
</span></span></code></pre></div></details>
<details><summary>Example: Upgrade PostgreSQL 15.1 back to 15.2</summary>
<p>This time we upgrade in a rolling fashion:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible pg-test -b -a <span style="color:#4e9a06">&#34;yum upgrade -y postgresql15*&#34;</span>    <span style="color:#8f5902;font-style:italic"># upgrade packages</span>
</span></span><span style="display:flex;"><span>ansible pg-test -b -a <span style="color:#4e9a06">&#39;/usr/pgsql/bin/pg_ctl --version&#39;</span> <span style="color:#8f5902;font-style:italic"># check binary version is 15.2</span>
</span></span><span style="display:flex;"><span>pg restart --role replica --force pg-test               <span style="color:#8f5902;font-style:italic"># restart replicas</span>
</span></span><span style="display:flex;"><span>pg switchover --leader pg-test-1 --candidate<span style="color:#ce5c00;font-weight:bold">=</span>pg-test-2 --scheduled<span style="color:#ce5c00;font-weight:bold">=</span>now --force pg-test    <span style="color:#8f5902;font-style:italic"># switchover</span>
</span></span><span style="display:flex;"><span>pg restart --role primary --force pg-test               <span style="color:#8f5902;font-style:italic"># restart primary</span>
</span></span></code></pre></div></details>
<hr>
<h2 id="major-upgrade">Major Upgrade</h2>
<p>The simplest way to achieve a major version upgrade is to create a new cluster with the new version, then <a href="/docs/pgsql/migration/">migration</a> with logical replication &amp; green/blue deployment.</p>
<p>You can also perform an in-place major upgrade, which is not recommended especially when certain extensions are installed. But it is possible.</p>
<p>Assume you want to upgrade PostgreSQL 14 to 15, you have to <a href="/docs/pgsql/admin/#adding-packages">add packages</a> to yum/apt repo, and guarantee the extensions has exact same version too.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_pkg -e <span style="color:#000">pg_version</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">15</span>                         <span style="color:#8f5902;font-style:italic"># install packages for pg 15</span>
</span></span><span style="display:flex;"><span>sudo su - postgres<span style="color:#000;font-weight:bold">;</span> mkdir -p /data/postgres/pg-meta-15/data/   <span style="color:#8f5902;font-style:italic"># prepare directories for 15</span>
</span></span><span style="display:flex;"><span>pg_upgrade -b /usr/pgsql-14/bin/ -B /usr/pgsql-15/bin/ -d /data/postgres/pg-meta-14/data/ -D /data/postgres/pg-meta-15/data/ -v -c <span style="color:#8f5902;font-style:italic"># preflight</span>
</span></span><span style="display:flex;"><span>pg_upgrade -b /usr/pgsql-14/bin/ -B /usr/pgsql-15/bin/ -d /data/postgres/pg-meta-14/data/ -D /data/postgres/pg-meta-15/data/ --link -j8 -v -c
</span></span><span style="display:flex;"><span>rm -rf /usr/pgsql<span style="color:#000;font-weight:bold">;</span> ln -s /usr/pgsql-15 /usr/pgsql<span style="color:#000;font-weight:bold">;</span>             <span style="color:#8f5902;font-style:italic"># fix binary links </span>
</span></span><span style="display:flex;"><span>mv /data/postgres/pg-meta-14 /data/postgres/pg-meta-15         <span style="color:#8f5902;font-style:italic"># rename data directory</span>
</span></span><span style="display:flex;"><span>rm -rf /pg<span style="color:#000;font-weight:bold">;</span> ln -s /data/postgres/pg-meta-15 /pg                <span style="color:#8f5902;font-style:italic"># fix data dir links</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-54447441a605cf594e517be7f37ae788">10 - Access Control</h1>
    <div class="lead">Built-in roles system, and battery-included access control model in Pigsty.</div>
	<blockquote>
<p>Pigsty has a battery-included access control model based on <a href="/docs/pgsql/acl/#role-system">Role System</a> and <a href="/docs/pgsql/acl/#privileges">Privileges</a>.</p>
</blockquote>
<hr>
<h2 id="role-system">Role System</h2>
<p>Pigsty has a default role system consist of four <a href="/docs/pgsql/acl/#default-roles">default roles</a> and four <a href="/docs/pgsql/acl/#default-users">default users</a>:</p>
<table>
<thead>
<tr>
<th>Role name</th>
<th>Attributes</th>
<th>Member of</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dbrole_readonly</code></td>
<td><code>NOLOGIN</code></td>
<td></td>
<td>role for global read-only access</td>
</tr>
<tr>
<td><code>dbrole_readwrite</code></td>
<td><code>NOLOGIN</code></td>
<td>dbrole_readonly</td>
<td>role for global read-write access</td>
</tr>
<tr>
<td><code>dbrole_admin</code></td>
<td><code>NOLOGIN</code></td>
<td>pg_monitor,dbrole_readwrite</td>
<td>role for object creation</td>
</tr>
<tr>
<td><code>dbrole_offline</code></td>
<td><code>NOLOGIN</code></td>
<td></td>
<td>role for restricted read-only access</td>
</tr>
<tr>
<td><code>postgres</code></td>
<td><code>SUPERUSER</code></td>
<td></td>
<td>system superuser</td>
</tr>
<tr>
<td><code>replicator</code></td>
<td><code>REPLICATION</code></td>
<td>pg_monitor,dbrole_readonly</td>
<td>system replicator</td>
</tr>
<tr>
<td><code>dbuser_dba</code></td>
<td><code>SUPERUSER</code></td>
<td>dbrole_admin</td>
<td>pgsql admin user</td>
</tr>
<tr>
<td><code>dbuser_monitor</code></td>
<td></td>
<td>pg_monitor</td>
<td>pgsql monitor user</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_default_roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># default roles and users in postgres cluster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_readonly  ,login: false ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for global read-only access     }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_offline   ,login: false ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for restricted read-only access }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for global read-write access }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for object creation }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: postgres     ,superuser: true  ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system superuser }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly] ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system replicator }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_monitor ,roles: [pg_monitor] ,pgbouncer: true ,parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql monitor user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="default-roles">Default Roles</h2>
<p>There are four default roles in pigsty:</p>
<ul>
<li>Read Only (<code>dbrole_readonly</code>): Role for global read-only access</li>
<li>Read Write (<code>dbrole_readwrite</code>): Role for global read-write access, inherits <code>dbrole_readonly</code>.</li>
<li>Admin (<code>dbrole_admin</code>): Role for DDL commands, inherits <code>dbrole_readwrite</code>.</li>
<li>Offline (<code>dbrole_offline</code>): Role for restricted read-only access (<a href="/docs/pgsql/conf#offline">offline</a> instance)</li>
</ul>
<p>Default roles are defined in <a href="/docs/reference/param/#pg_default_roles"><code>pg_default_roles</code></a>, change default roles is not recommended.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_readonly  , login: false , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for global read-only access  }                           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># production read-only role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_offline ,   login: false , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for restricted read-only access (offline instance) }     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># restricted-read-only role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_readwrite , login: false , roles: [dbrole_readonly], comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for global read-write access } </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># production read-write role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbrole_admin , login: false , roles: [pg_monitor, dbrole_readwrite] , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role for object creation }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># production DDL change role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="default-users">Default Users</h2>
<p>There are four default users in pigsty, too.</p>
<ul>
<li>Superuser (<code>postgres</code>), the owner and creator of the cluster, same as the OS dbsu.</li>
<li>Replication user (<code>replicator</code>), the system user used for primary-replica.</li>
<li>Monitor user (<code>dbuser_monitor</code>), a user used to monitor database and connection pool metrics.</li>
<li>Admin user (<code>dbuser_dba</code>), the admin user who performs daily operations and database changes.</li>
</ul>
<p>Default users&rsquo; username/password are defined with dedicate parameters (except for dbsu password):</p>
<ul>
<li><a href="/docs/reference/param/#pg_dbsu"><code>pg_dbsu</code></a>                                 : os dbsu name, postgres by default, better not change it</li>
<li><a href="/docs/reference/param/#pg_replication_username"><code>pg_replication_username</code></a> : postgres replication username, <code>replicator</code> by default</li>
<li><a href="/docs/reference/param/#pg_replication_password"><code>pg_replication_password</code></a> : postgres replication password, <code>DBUser.Replicator</code> by default</li>
<li><a href="/docs/reference/param/#pg_admin_username"><code>pg_admin_username</code></a>             : postgres admin username, <code>dbuser_dba</code> by default</li>
<li><a href="/docs/reference/param/#pg_admin_password"><code>pg_admin_password</code></a>             : postgres admin password in plain text, <code>DBUser.DBA</code> by default</li>
<li><a href="/docs/reference/param/#pg_monitor_username"><code>pg_monitor_username</code></a>         : postgres monitor username, <code>dbuser_monitor</code> by default</li>
<li><a href="/docs/reference/param/#pg_monitor_password"><code>pg_monitor_password</code></a>         : postgres monitor password, <code>DBUser.Monitor</code> by default</li>
</ul>
<p>!&gt; <strong>Remember to change these password in production deployment !</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_dbsu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres                            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># os user for the database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_replication_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replicator          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># system replication user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_replication_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Replicator   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># system replication password</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_monitor_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># system monitor user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_monitor_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Monitor          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># system monitor password</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_admin_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_dba                </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># system admin user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_admin_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.DBA                </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># system admin password</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>To define extra options, specify them in <a href="/docs/reference/param/#pg_default_roles"><code>pg_default_roles</code></a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: postgres     ,superuser: true                                          ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system superuser }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">system replicator }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql admin user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_monitor   ,roles: [pg_monitor, dbrole_readonly] ,pgbouncer: true ,parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#204a87;font-weight:bold">log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql monitor user }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="privileges">Privileges</h2>
<p>Pigsty has a battery-included privilege model that works with <a href="/docs/pgsql/acl/#default-roles">default roles</a>.</p>
<ul>
<li>All users have access to all schemas.</li>
<li>Read-Only user can read from all tables. (SELECT, EXECUTE)</li>
<li>Read-Write user can write to all tables run DML. (INSERT, UPDATE, DELETE).</li>
<li>Admin user can create object and run DDL (CREATE, USAGE, TRUNCATE, REFERENCES, TRIGGER).</li>
<li>Offline user is Read-Only user with limited access on offline instance (<code>pg_role = 'offline'</code> or <code>pg_offline_query = true</code>)</li>
<li>Object created by admin users will have correct privilege.</li>
<li>Default privileges are installed on all databases, including template database.</li>
<li>Database connect privilege is covered by database <a href="/docs/pgsql/db/#define-database">definition</a></li>
<li><code>CREATE</code> privileges of database &amp; public schema are revoked from <code>PUBLIC</code> by default</li>
</ul>
<hr>
<h2 id="object-privilege">Object Privilege</h2>
<p>Default object privileges are defined in <a href="/docs/reference/param/#pg_default_privileges"><code>pg_default_privileges</code></a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#000">GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Newly created objects will have corresponding privileges when it is <strong>created by admin users</strong></p>
<p>The <code>\ddp+</code> may looks like:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Access privileges</th>
</tr>
</thead>
<tbody>
<tr>
<td>function</td>
<td>=X</td>
</tr>
<tr>
<td></td>
<td>dbrole_readonly=X</td>
</tr>
<tr>
<td></td>
<td>dbrole_offline=X</td>
</tr>
<tr>
<td></td>
<td>dbrole_admin=X</td>
</tr>
<tr>
<td>schema</td>
<td>dbrole_readonly=U</td>
</tr>
<tr>
<td></td>
<td>dbrole_offline=U</td>
</tr>
<tr>
<td></td>
<td>dbrole_admin=UC</td>
</tr>
<tr>
<td>sequence</td>
<td>dbrole_readonly=r</td>
</tr>
<tr>
<td></td>
<td>dbrole_offline=r</td>
</tr>
<tr>
<td></td>
<td>dbrole_readwrite=wU</td>
</tr>
<tr>
<td></td>
<td>dbrole_admin=rwU</td>
</tr>
<tr>
<td>table</td>
<td>dbrole_readonly=r</td>
</tr>
<tr>
<td></td>
<td>dbrole_offline=r</td>
</tr>
<tr>
<td></td>
<td>dbrole_readwrite=awd</td>
</tr>
<tr>
<td></td>
<td>dbrole_admin=arwdDxt</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="default-privilege">Default Privilege</h2>
<p><a href="https://www.postgresql.org/docs/current/sql-alterdefaultprivileges.html"><code>ALTER DEFAULT PRIVILEGES</code></a> allows you to set the privileges that will be applied to objects created in the future.
It does not affect privileges assigned to already-existing objects, and objects created by non-admin users.</p>
<p>Pigsty will use the following default privileges:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_default_privileges</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIVILEGES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_dbsu</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}}</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">endfor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_default_privileges</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIVILEGES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_admin_username</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}}</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}}</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">endfor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- for additional business admin, they can SET ROLE to dbrole_admin
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_default_privileges</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIVILEGES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;dbrole_admin&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">priv</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">}}</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">{</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">endfor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#a40000">}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Which will be rendered in <a href="https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql"><code>pg-init-template.sql</code></a> alone with <code>ALTER DEFAULT PRIVILEGES</code> statement for admin users.</p>
<p>These SQL command will be executed on <code>postgres</code> &amp; <code>template1</code> during cluster bootstrap, and newly created database will inherit it from <code>tempalte1</code> by default.</p>
<p>That is to say, to maintain the correct object privilege, you have to run DDL with <strong>admin users</strong>, which could be:</p>
<ol>
<li><a href="/docs/reference/param/#pg_dbsu"><code>{{ pg_dbsu }}</code></a>, <code>postgres</code> by default</li>
<li><a href="/docs/reference/param/#pg_admin_username"><code>{{ pg_admin_username }}</code></a>, <code>dbuser_dba</code> by default</li>
<li>Business admin user granted with <code>dbrole_admin</code></li>
</ol>
<p>It&rsquo;s wise to use <code>postgres</code> as global object owner to perform DDL changes.
If you wish to create objects with business admin user, YOU MUST USE <code>SET ROLE dbrole_admin</code> before running that DDL to maintain the correct privileges.</p>
<p>You can also <code>ALTER DEFAULT PRIVILEGE FOR ROLE &lt;some_biz_admin&gt; XXX</code> to grant default privilege to business admin user, too.</p>
<hr>
<h2 id="database-privilege">Database Privilege</h2>
<p>Database privilege is covered by <a href="/docs/pgsql/db/#define-database">database definition</a>.</p>
<p>There are 3 database level privileges: <code>CONNECT</code>, <code>CREATE</code>, <code>TEMP</code>, and a special &lsquo;privilege&rsquo;: <code>OWNERSHIP</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta        </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># required, `name` is the only mandatory field of a database definition</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, specify a database owner, {{ pg_dbsu }} by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">allowconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># optional, allow connection, true by default. false will disable connect at all</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">revokeconn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># optional, revoke public connection privilege. false by default. (leave connect with grant option to owner)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>If <code>owner</code> exists, it will be used as database owner instead of default <a href="/docs/reference/param/#pg_dbsu"><code>{{ pg_dbsu }}</code></a></li>
<li>If <code>revokeconn</code> is <code>false</code>, all users have the <code>CONNECT</code> privilege of the database, this is the default behavior.</li>
<li>If <code>revokeconn</code> is set to <code>true</code> explicitly:
<ul>
<li><code>CONNECT</code> privilege of the database will be revoked from <code>PUBLIC</code></li>
<li><code>CONNECT</code> privilege will be granted to <code>{{ pg_replication_username }}</code>, <code>{{ pg_monitor_username }}</code> and <code>{{ pg_admin_username }}</code></li>
<li><code>CONNECT</code> privilege will be granted to database owner with <code>GRANT OPTION</code></li>
</ul>
</li>
</ul>
<p><code>revokeconn</code> flag can be used for database access isolation, you can create different business users as the owners for each database and set the <code>revokeconn</code> option for all of them.</p>
<details><summary>Example: Database Isolation</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg-infra</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.40</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 1, pg_role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">10.10.10.41</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_seq: 2, pg_role: replica , pg_offline_query</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-infra</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_confluence, password: mc2iohos , pgbouncer: true, roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_admin ] }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_gitlab, password: sdf23g22sfdd , pgbouncer: true, roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_readwrite ] }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: dbuser_jira, password: sdpijfsfdsfdfs , pgbouncer: true, roles</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbrole_admin ] }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: confluence , revokeconn: true, owner: dbuser_confluence , connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: gitlab , revokeconn: true, owner: dbuser_gitlab, connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name: jira , revokeconn: true, owner: dbuser_jira , connlimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></details>
<hr>
<h2 id="create-privilege">Create Privilege</h2>
<p>Pigsty revokes the <code>CREATE</code> privilege on database from <code>PUBLIC</code> by default, for security consideration.
And this is the default behavior since PostgreSQL 15.</p>
<p>The database owner have the full capability to adjust these privileges as they see fit.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cd0c200c9f6515f7a7ac9cc0f4b856bf">11 - Backup &amp; PITR</h1>
    <div class="lead">How to perform base backup &amp; PITR with pgBackRest?</div>
	<blockquote>
<p>Pigsty uses <a href="https://pgbackrest.org/">pgBackRest</a> for PITR backup &amp; restore.</p>
</blockquote>
<p>In the case of a hardware failure, a physical replica failover could be the best choice. Whereas for data corruption scenarios (whether machine or human errors), Point-in-Time Recovery (PITR) is often more appropriate.</p>
<h2 id="backup">Backup</h2>
<p>Use the following command to perform the <a href="https://pgbackrest.org/command.html#command-backup">backup</a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># stanza name = {{ pg_cluster }} by default</span>
</span></span><span style="display:flex;"><span>pgbackrest --stanza<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">stanza</span><span style="color:#4e9a06">}</span> --type<span style="color:#ce5c00;font-weight:bold">=</span>full<span style="color:#000;font-weight:bold">|</span>diff<span style="color:#000;font-weight:bold">|</span>incr backup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># you can also use the following command in pigsty (/pg/bin/pg-backup)</span>
</span></span><span style="display:flex;"><span>pg-backup       <span style="color:#8f5902;font-style:italic"># make a backup, incr, or full backup if necessary</span>
</span></span><span style="display:flex;"><span>pg-backup full  <span style="color:#8f5902;font-style:italic"># make a full backup</span>
</span></span><span style="display:flex;"><span>pg-backup diff  <span style="color:#8f5902;font-style:italic"># make a differential backup</span>
</span></span><span style="display:flex;"><span>pg-backup incr  <span style="color:#8f5902;font-style:italic"># make a incremental backup</span>
</span></span></code></pre></div><p>Use the following command to print backup info:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pb info  <span style="color:#8f5902;font-style:italic"># print backup info</span>
</span></span></code></pre></div><p>You can also acquire backup info from the monitoring system: <a href="https://demo.pigsty.cc/d/pgcat-instance/pgcat-instance?from=now-1h&to=now&var-job=pgsql&var-ds=Prometheus&orgId=1&viewPanel=158">PGCAT Instance - Backup</a></p>
<details><summary>Backup Info Example</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pb info
</span></span><span style="display:flex;"><span>stanza: pg-meta
</span></span><span style="display:flex;"><span>    status: ok
</span></span><span style="display:flex;"><span>    cipher: none
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    db <span style="color:#ce5c00;font-weight:bold">(</span>current<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        wal archive min/max <span style="color:#ce5c00;font-weight:bold">(</span>14<span style="color:#ce5c00;font-weight:bold">)</span>: 000000010000000000000001/000000010000000000000023
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        full backup: 20221108-105325F
</span></span><span style="display:flex;"><span>            timestamp start/stop: 2022-11-08 10:53:25 / 2022-11-08 10:53:29
</span></span><span style="display:flex;"><span>            wal start/stop: <span style="color:#0000cf;font-weight:bold">000000010000000000000004</span> / <span style="color:#0000cf;font-weight:bold">000000010000000000000004</span>
</span></span><span style="display:flex;"><span>            database size: 96.6MB, database backup size: 96.6MB
</span></span><span style="display:flex;"><span>            repo1: backup <span style="color:#204a87">set</span> size: 18.9MB, backup size: 18.9MB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        incr backup: 20221108-105325F_20221108-105938I
</span></span><span style="display:flex;"><span>            timestamp start/stop: 2022-11-08 10:59:38 / 2022-11-08 10:59:41
</span></span><span style="display:flex;"><span>            wal start/stop: 00000001000000000000000F / 00000001000000000000000F
</span></span><span style="display:flex;"><span>            database size: 246.7MB, database backup size: 167.3MB
</span></span><span style="display:flex;"><span>            repo1: backup <span style="color:#204a87">set</span> size: 35.4MB, backup size: 20.4MB
</span></span><span style="display:flex;"><span>            backup reference list: 20221108-105325F
</span></span></code></pre></div></details>
<h2 id="restore">Restore</h2>
<p>Use the following command to perform <a href="https://pgbackrest.org/command.html#command-restore">restore</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pg-pitr                                 # restore to wal archive stream end (e.g. used in case of entire DC failure)
</span></span><span style="display:flex;"><span>pg-pitr -i                              # restore to the time of latest backup complete (not often used)
</span></span><span style="display:flex;"><span>pg-pitr --time=&#34;2022-12-30 14:44:44+08&#34; # restore to specific time point (in case of drop db, drop table)
</span></span><span style="display:flex;"><span>pg-pitr --name=&#34;my-restore-point&#34;       # restore TO a named restore point create by pg_create_restore_point
</span></span><span style="display:flex;"><span>pg-pitr --lsn=&#34;0/7C82CB8&#34; -X            # restore right BEFORE a LSN
</span></span><span style="display:flex;"><span>pg-pitr --xid=&#34;1234567&#34; -X -P           # restore right BEFORE a specific transaction id, then promote
</span></span><span style="display:flex;"><span>pg-pitr --backup=latest                 # restore to latest backup set
</span></span><span style="display:flex;"><span>pg-pitr --backup=20221108-105325        # restore to a specific backup set, which can be checked with pgbackrest info
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pg-pitr                                 # pgbackrest --stanza=pg-meta restore
</span></span><span style="display:flex;"><span>pg-pitr -i                              # pgbackrest --stanza=pg-meta --type=immediate restore
</span></span><span style="display:flex;"><span>pg-pitr -t &#34;2022-12-30 14:44:44+08&#34;     # pgbackrest --stanza=pg-meta --type=time --target=&#34;2022-12-30 14:44:44+08&#34; restore
</span></span><span style="display:flex;"><span>pg-pitr -n &#34;my-restore-point&#34;           # pgbackrest --stanza=pg-meta --type=name --target=my-restore-point restore
</span></span><span style="display:flex;"><span>pg-pitr -b 20221108-105325F             # pgbackrest --stanza=pg-meta --type=name --set=20221230-120101F restore
</span></span><span style="display:flex;"><span>pg-pitr -l &#34;0/7C82CB8&#34; -X               # pgbackrest --stanza=pg-meta --type=lsn --target=&#34;0/7C82CB8&#34; --target-exclusive restore
</span></span><span style="display:flex;"><span>pg-pitr -x 1234567 -X -P                # pgbackrest --stanza=pg-meta --type=xid --target=&#34;0/7C82CB8&#34; --target-exclusive --target-action=promote restore
</span></span></code></pre></div><p>The <code>pg-pitr</code> script will generate instructions for you to perform PITR.</p>
<p>For example, if you wish to rollback current cluster status back to <code>&quot;2023-02-07 12:38:00+08&quot;</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pg-pitr -t <span style="color:#4e9a06">&#34;2023-02-07 12:38:00+08&#34;</span>
</span></span><span style="display:flex;"><span>pgbackrest --stanza<span style="color:#ce5c00;font-weight:bold">=</span>pg-meta --type<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">time</span> --target<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;2023-02-07 12:38:00+08&#39;</span> restore
</span></span><span style="display:flex;"><span>Perform <span style="color:#204a87">time</span> PITR on pg-meta
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>1. Stop PostgreSQL<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span><span style="display:flex;"><span>   1.1 Pause Patroni <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">if</span> there are any replicas<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       $ pg pause &lt;cls&gt;  <span style="color:#8f5902;font-style:italic"># pause patroni auto failover</span>
</span></span><span style="display:flex;"><span>   1.2 Shutdown Patroni
</span></span><span style="display:flex;"><span>       $ pt-stop         <span style="color:#8f5902;font-style:italic"># sudo systemctl stop patroni</span>
</span></span><span style="display:flex;"><span>   1.3 Shutdown Postgres
</span></span><span style="display:flex;"><span>       $ pg-stop         <span style="color:#8f5902;font-style:italic"># pg_ctl -D /pg/data stop -m fast</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>2. Perform PITR<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span><span style="display:flex;"><span>   2.1 Restore Backup
</span></span><span style="display:flex;"><span>       $ pgbackrest --stanza<span style="color:#ce5c00;font-weight:bold">=</span>pg-meta --type<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">time</span> --target<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;2023-02-07 12:38:00+08&#39;</span> restore
</span></span><span style="display:flex;"><span>   2.2 Start PG to Replay WAL
</span></span><span style="display:flex;"><span>       $ pg-start        <span style="color:#8f5902;font-style:italic"># pg_ctl -D /pg/data start</span>
</span></span><span style="display:flex;"><span>   2.3 Validate and Promote
</span></span><span style="display:flex;"><span>     - If database content is ok, promote it to finish recovery, otherwise goto 2.1
</span></span><span style="display:flex;"><span>       $ pg-promote      <span style="color:#8f5902;font-style:italic"># pg_ctl -D /pg/data promote</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>3. Restart Patroni<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span><span style="display:flex;"><span>   3.1 Start Patroni
</span></span><span style="display:flex;"><span>       $ pt-start<span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic"># sudo systemctl start patroni</span>
</span></span><span style="display:flex;"><span>   3.2 Enable Archive Again
</span></span><span style="display:flex;"><span>       $ psql -c <span style="color:#4e9a06">&#39;ALTER SYSTEM SET archive_mode = on; SELECT pg_reload_conf();&#39;</span>
</span></span><span style="display:flex;"><span>   3.3 Restart Patroni
</span></span><span style="display:flex;"><span>       $ pt-restart      <span style="color:#8f5902;font-style:italic"># sudo systemctl start patroni</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>4. Restore Cluster<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===========================================</span>
</span></span><span style="display:flex;"><span>   3.1 Re-Init All Replicas <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">if</span> any replicas<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       $ pg reinit &lt;cls&gt; &lt;ins&gt;
</span></span><span style="display:flex;"><span>   3.2 Resume Patroni
</span></span><span style="display:flex;"><span>       $ pg resume &lt;cls&gt; <span style="color:#8f5902;font-style:italic"># resume patroni auto failover</span>
</span></span><span style="display:flex;"><span>   3.2 Make Full Backup <span style="color:#ce5c00;font-weight:bold">(</span>optional<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       $ pg-backup full  <span style="color:#8f5902;font-style:italic"># pgbackrest --stanza=pg-meta backup --type=full</span>
</span></span></code></pre></div><h2 id="policy">Policy</h2>
<p>You can customize your backup policy with <a href="/docs/reference/param/#node_crontab"><code>node_crontab</code></a> and <a href="/docs/reference/param/#pgbackrest_repo"><code>pgbackrest_repo</code></a></p>
<ul>
<li>Schedule full or incr backup with <a href="/docs/reference/param/#node_crontab"><code>node_crontab</code></a></li>
<li>setup backup retention policy with <a href="/docs/reference/param/#pgbackrest_repo"><code>pgbackrest_repo</code></a></li>
</ul>
<p><strong>local repo</strong></p>
<p>For example, the default <code>pg-meta</code> will take a full backup every day at 1 am.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>node_crontab:  # make a full backup 1 am everyday
</span></span><span style="display:flex;"><span>  - &#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;
</span></span></code></pre></div><p>With the default local repo retention policy, it will keep at most two full backups and temporarily allow three during backup.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pgbackrest_repo:                  # pgbackrest repo</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://pgbackrest.org/configuration.html#section-repository</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">local</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># default pgbackrest repo with local posix fs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/pg/backup             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># local backup directory, `/pg/backup` by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">retention_full_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">count   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># retention full backups by count</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">retention_full</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># keep 2, at most 3 full backup when using local fs repo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Your backup disk storage should be at least three x database file size + WAL archive in 3 days.</p>
<p><strong>MinIO repo</strong></p>
<p>When using MinIO, storage capacity is usually not a problem. You can keep backups as long as you want.</p>
<p>For example, the default <code>pg-test</code> will take a full backup on Monday and incr backup on other weekdays.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">node_crontab</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># make a full backup 1 am everyday</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#39;00 01 * * 1 postgres /pg/bin/pg-backup full&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#39;00 01 * * 2,3,4,5,6,7 postgres /pg/bin/pg-backup&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>And with a 14-day time retention policy, backup in the last two weeks will be kept. But beware, this guarantees a week&rsquo;s PITR period only.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pgbackrest_repo:                  # pgbackrest repo</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://pgbackrest.org/configuration.html#section-repository=</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">minio</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># optional minio repo for pgbackrest</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3                     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio is s3-compatible, so s3 is used</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_endpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sss.pigsty      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio endpoint domain name, `sss.pigsty` by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">us-east-1         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio region, us-east-1 by default, useless for minio</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_bucket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgsql             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio bucket name, `pgsql` by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgbackrest           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio user access key for pgbackrest</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_key_secret</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">S3User.Backup </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio user secret key for pgbackrest</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">s3_uri_style</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># use path style uri for minio rather than host style</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/pgbackrest            </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio backup path, default is `/pgbackrest`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">storage_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9000</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># minio port, 9000 by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">storage_ca_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/pki/ca.crt </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># minio ca file path, `/etc/pki/ca.crt` by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">bundle</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">y</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># bundle small files into a single file</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">cipher_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aes-256-cbc     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># enable AES encryption for remote backup repo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">cipher_pass</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgBackRest      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># AES encryption password, default is &#39;pgBackRest&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">retention_full_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">time    </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># retention full backup by time on minio repo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">retention_full</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># keep full backup for last 14 days</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9df6c956772e8cb04fe4f58165034338">12 - Migration</h1>
    <div class="lead">How to migrate existing postgres into Pigsty-managed cluster with mimial downtime? The blue-green online migration playbook</div>
	<p>Pigsty has a built-in playbook <a href="https://github.com/Vonng/pigsty/blob/main/pgsql-migration.yml"><code>pgsql-migration.yml</code></a> to perform online database migration based on logical replication.</p>
<p>With proper automation, the downtime could be minimized to several seconds. But beware that logical replication requires PostgreSQL 10+ to work. You can still use the facility here and use a pg_dump | psql instead of logical replication.</p>
<hr>
<h2 id="define-a-migration-task">Define a Migration Task</h2>
<p>You have to create a migration task definition file to use this playbook.</p>
<p>Check <a href="https://github.com/Vonng/pigsty/blob/main/files/migration/pg-meta.yml"><code>files/migration/pg-meta.yml</code></a> for example.</p>
<p>It will try to migrate the <code>pg-meta.meta</code> to <code>pg-test.test</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg-meta-1	10.10.10.10  --&gt; pg-test-1	10.10.10.11 <span style="color:#ce5c00;font-weight:bold">(</span>10.10.10.12,10.10.10.13<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>You have to tell pigsty where is the source cluster and destination cluster. The database to be migrated, and the primary IP address.</p>
<p>You should have superuser privileges on both sides to proceed</p>
<p>You can overwrite the superuser connection to the source cluster with <code>src_pg</code>, and logical replication connection string with <code>sub_conn</code>, Otherwise, pigsty default admin &amp; replicator credentials will be used.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># PG_MIGRATION</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">context_dir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">~/migration          </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># migration manuals &amp; scripts</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># SRC Cluster (The OLD Cluster)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">src_cls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-meta     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># src cluster name         &lt;REQUIRED&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">src_db</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># src database name        &lt;REQUIRED&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">src_ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># src cluster primary ip   &lt;REQUIRED&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#src_pg: &#39;&#39;            # if defined, use this as src dbsu pgurl instead of:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                      # postgres://{{ pg_admin_username }}@{{ src_ip }}/{{ src_db }}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                      # e.g. &#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#sub_conn: &#39;&#39;          # if defined, use this as subscription connstr instead of:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                      # host={{ src_ip }} dbname={{ src_db }} user={{ pg_replication_username }}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                      # e.g. &#39;host=10.10.10.10 dbname=meta user=replicator password=DBUser.Replicator&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># DST Cluster (The New Cluster)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">dst_cls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-test     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># dst cluster name         &lt;REQUIRED&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">dst_db</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># dst database name        &lt;REQUIRED&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">dst_ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.11</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># dst cluster primary ip   &lt;REQUIRED&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#dst_pg: &#39;&#39;            # if defined, use this as dst dbsu pgurl instead of:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                      # postgres://{{ pg_admin_username }}@{{ dst_ip }}/{{ dst_db }}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                      # e.g. &#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.11:5432/test&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># PGSQL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_dbsu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_replication_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">replicator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_replication_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Replicator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_admin_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_dba</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_admin_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.DBA</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_monitor_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_monitor_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Monitor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#-----------------------------------------------------------------</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="generate-migration-plan">Generate Migration Plan</h2>
<p>The playbook does not migrate src to dst, but it will generate everything your need to do so.</p>
<p>After the execution, you will find migration context dir under <code>~/migration/pg-meta.meta</code>  by default</p>
<p>Following the <code>README.md</code> and executing these scripts one by one, you will do the trick!</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># this script will setup migration context with env vars</span>
</span></span><span style="display:flex;"><span>. ~/migration/pg-meta.meta/activate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># these scripts are used for check src cluster status</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># and help generating new cluster definition in pigsty</span>
</span></span><span style="display:flex;"><span>./check-user     <span style="color:#8f5902;font-style:italic"># check src users</span>
</span></span><span style="display:flex;"><span>./check-db       <span style="color:#8f5902;font-style:italic"># check src databases</span>
</span></span><span style="display:flex;"><span>./check-hba      <span style="color:#8f5902;font-style:italic"># check src hba rules</span>
</span></span><span style="display:flex;"><span>./check-repl     <span style="color:#8f5902;font-style:italic"># check src replica identities</span>
</span></span><span style="display:flex;"><span>./check-misc     <span style="color:#8f5902;font-style:italic"># check src special objects</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># these scripts are used for building logical replication</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># between existing src cluster and pigsty managed dst cluster</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># schema, data will be synced in realtime, except for sequences</span>
</span></span><span style="display:flex;"><span>./copy-schema    <span style="color:#8f5902;font-style:italic"># copy schema to dest</span>
</span></span><span style="display:flex;"><span>./create-pub     <span style="color:#8f5902;font-style:italic"># create publication on src</span>
</span></span><span style="display:flex;"><span>./create-sub     <span style="color:#8f5902;font-style:italic"># create subscription on dst</span>
</span></span><span style="display:flex;"><span>./copy-progress  <span style="color:#8f5902;font-style:italic"># print logical replication progress</span>
</span></span><span style="display:flex;"><span>./copy-diff      <span style="color:#8f5902;font-style:italic"># quick src &amp; dst diff by counting tables</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># these scripts will run in an online migration, which will</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># stop src cluster, copy sequence numbers (which is not synced with logical replication)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># you have to reroute you app traffic according to your access method (dns,vip,haproxy,pgbouncer,etc...)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># then perform cleanup to drop subscription and publication</span>
</span></span><span style="display:flex;"><span>./copy-seq <span style="color:#ce5c00;font-weight:bold">[</span>n<span style="color:#ce5c00;font-weight:bold">]</span>   <span style="color:#8f5902;font-style:italic"># sync sequence numbers, if n is given, an additional shift will applied</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#./disable-src   # restrict src cluster access to admin node &amp; new cluster (YOUR IMPLEMENTATION)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#./re-routing    # ROUTING APPLICATION TRAFFIC FROM SRC TO DST!            (YOUR IMPLEMENTATION)</span>
</span></span><span style="display:flex;"><span>./drop-sub       <span style="color:#8f5902;font-style:italic"># drop subscription on dst after migration</span>
</span></span><span style="display:flex;"><span>./drop-pub       <span style="color:#8f5902;font-style:italic"># drop publication on src after migration</span>
</span></span></code></pre></div><p><strong>Caveats</strong></p>
<p>You can use <code>./copy-seq 1000</code> to advance all sequences by a number (e.g. <code>1000</code>) after syncing sequences.
Which may prevent potential serial primary key conflict in new clusters.</p>
<p>You have to implement your own <code>./re-routing</code> script to route your application traffic from src to dst.
Since we don&rsquo;t know how your traffic is routed (e.g dns, VIP, haproxy, or pgbouncer).
Of course, you can always do that by hand&hellip;</p>
<p>You have to implement your own <code>./disable-src</code> script to restrict the src cluster.
You can do that by changing HBA rules &amp; reload (recommended), or just shutting down postgres, pgbouncer, or haproxy&hellip;</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d62cf100c93be858ce7b3c37726c8061">13 - Monitoring</h1>
    <div class="lead">How PostgreSQL monitoring works, and how to monitor remote (existing) PostgreSQL instances?</div>
	<hr>
<h2 id="overview">Overview</h2>
<p>Pigsty uses the modern observability stack for PostgreSQL monitoring:</p>
<ul>
<li>Grafana for metrics visualization and PostgreSQL datasource.</li>
<li>Prometheus for PostgreSQL / Pgbouncer / Patroni / HAProxy / Node metrics</li>
<li>Loki for PostgreSQL / Pgbouncer / Patroni / pgBackRest logs</li>
<li>Battery-Include <a href="/docs/pgsql/dashboard/">dashboards</a> for PostgreSQL and everything else</li>
</ul>
<p><strong>Metrics</strong></p>
<p>PostgreSQL&rsquo;s metrics are defined by collector files: <a href="https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg_exporter.yml"><code>pg_exporter.yml</code></a>. Prometheus record rules and alert evaluation will further process it: <a href="https://github.com/Vonng/pigsty/blob/main/files/prometheus/rules/pgsql.yml"><code>files/prometheus/rules/pgsql.yml</code></a></p>
<p>There are three identity labels: <code>cls</code>, <code>ins</code>, <code>ip</code>, which will be attached to all metrics &amp; logs. node &amp; haproxy will try to reuse the same identity to provide consistent metrics &amp; logs.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cls: pg-meta, ins: pg-meta-1, ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cls: pg-meta, ins: pg-test-1, ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.11</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cls: pg-meta, ins: pg-test-2, ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.12</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cls: pg-meta, ins: pg-test-3, ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.13</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>Logs</strong></p>
<p>PostgreSQL-related logs are collected by promtail and sent to Loki on infra nodes by default.</p>
<ul>
<li><a href="/docs/reference/param/#pg_log_dir"><code>pg_log_dir</code></a> : postgres log dir, <code>/pg/log/postgres</code> by default</li>
<li><a href="/docs/reference/param/#pgbouncer_log_dir"><code>pgbouncer_log_dir</code></a> : pgbouncer log dir, <code>/pg/log/pgbouncer</code> by default</li>
<li><a href="/docs/reference/param/#patroni_log_dir"><code>patroni_log_dir</code></a> : patroni log dir, <code>/pg/log/patroni</code> by default</li>
<li><a href="/docs/reference/param/#pgbackrest_log_dir"><code>pgbackrest_log_dir</code></a> : pgbackrest log dir, <code>/pg/log/pgbackrest</code> by default</li>
</ul>
<p><strong>Targets</strong></p>
<p>Prometheus monitoring targets are defined in static files under <code>/etc/prometheus/targets/pgsql/</code>. Each instance will have a corresponding file. Take <code>pg-meta-1</code> as an example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pg-meta-1 [primary] @ 10.10.10.10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">cls: pg-meta, ins: pg-meta-1, ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">targets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9630</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># &lt;--- pg_exporter for PostgreSQL metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">9631</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># &lt;--- pg_exporter for Pgbouncer metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">8008</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># &lt;--- patroni metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>When the global flag <a href="/docs/reference/param/#patroni_ssl_enabled"><code>patroni_ssl_enabled</code></a> is set, the patroni target will be managed as <code>/etc/prometheus/targets/patroni/&lt;ins&gt;.yml</code> because it requires a different scrape endpoint (https).</p>
<p>Prometheus monitoring target will be removed when a cluster is removed by <code>bin/pgsql-rm</code> or <code>pgsql-rm.yml</code>. You can use playbook subtasks, or remove them manually:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgmon-rm &lt;ins&gt;      <span style="color:#8f5902;font-style:italic"># remove prometheus targets from all infra nodes</span>
</span></span></code></pre></div><p>Remote RDS targets are managed as <code>/etc/prometheus/targets/pgrds/&lt;cls&gt;.yml</code>. It will be created by the <a href="/docs/pgsql/playbook/#pgsql-monitor"><code>pgsql-monitor.yml</code></a> playbook or <code>bin/pgmon-add</code> script.</p>
<hr>
<h2 id="monitor-mode">Monitor Mode</h2>
<p>There are three ways to monitor PostgreSQL instances in Pigsty:</p>
<table>
<thead>
<tr>
<th style="text-align:center">Item \ Level</th>
<th style="text-align:center">L1</th>
<th style="text-align:center">L2</th>
<th style="text-align:center">L3</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Name</td>
<td style="text-align:center"><a href="monitor-rds">Remote Database Service</a></td>
<td style="text-align:center"><a href="monitor-existing-cluster">Existing Deployment</a></td>
<td style="text-align:center">Fully Managed Deployment</td>
</tr>
<tr>
<td style="text-align:center">Abbr</td>
<td style="text-align:center"><strong>RDS</strong></td>
<td style="text-align:center"><strong>MANAGED</strong></td>
<td style="text-align:center"><strong>FULL</strong></td>
</tr>
<tr>
<td style="text-align:center">Scenes</td>
<td style="text-align:center">connect string URL only</td>
<td style="text-align:center">ssh-sudo-able</td>
<td style="text-align:center">Instances created by Pigsty</td>
</tr>
<tr>
<td style="text-align:center">PGCAT Functionality</td>
<td style="text-align:center">✅ Full Availability</td>
<td style="text-align:center">✅ Full Availability</td>
<td style="text-align:center">✅ Full Availability</td>
</tr>
<tr>
<td style="text-align:center">PGSQL Functionality</td>
<td style="text-align:center">✅ PG metrics only</td>
<td style="text-align:center">✅  PG and node metrics</td>
<td style="text-align:center">✅ Full Support</td>
</tr>
<tr>
<td style="text-align:center">Connection Pool Metrics</td>
<td style="text-align:center">❌ Not available</td>
<td style="text-align:center">⚠️ Optional</td>
<td style="text-align:center">✅ Pre-Configured</td>
</tr>
<tr>
<td style="text-align:center">Load Balancer Metrics</td>
<td style="text-align:center">❌ Not available</td>
<td style="text-align:center">⚠️ Optional</td>
<td style="text-align:center">✅ Pre-Configured</td>
</tr>
<tr>
<td style="text-align:center">PGLOG Functionality</td>
<td style="text-align:center">❌  Not Available</td>
<td style="text-align:center">⚠️  Optional</td>
<td style="text-align:center">⚠️  Optional</td>
</tr>
<tr>
<td style="text-align:center">PG Exporter</td>
<td style="text-align:center">⚠️ On infra nodes</td>
<td style="text-align:center">✅ On DB nodes</td>
<td style="text-align:center">✅ On DB nodes</td>
</tr>
<tr>
<td style="text-align:center">Node Exporter</td>
<td style="text-align:center">❌ Not Deployed</td>
<td style="text-align:center">✅  On DB nodes</td>
<td style="text-align:center">✅ On DB nodes</td>
</tr>
<tr>
<td style="text-align:center">Intrusion into DB nodes</td>
<td style="text-align:center">✅ Non-Intrusive</td>
<td style="text-align:center">⚠️ Installing Exporter</td>
<td style="text-align:center">⚠️ Fully Managed by Pigsty</td>
</tr>
<tr>
<td style="text-align:center">Instance Already Exists</td>
<td style="text-align:center">✅ Yes</td>
<td style="text-align:center">✅ Yes</td>
<td style="text-align:center">⚠️ Created by Pigsty</td>
</tr>
<tr>
<td style="text-align:center">Monitoring users and views</td>
<td style="text-align:center">⚠️Manually Setup</td>
<td style="text-align:center">⚠️Manually Setup</td>
<td style="text-align:center">✅ Auto configured</td>
</tr>
<tr>
<td style="text-align:center">Deployment Usage Playbook</td>
<td style="text-align:center"><code>bin/pgmon-add &lt;cls&gt;</code></td>
<td style="text-align:center">subtasks of <code>pgsql.ym</code>/<code>node.yml</code></td>
<td style="text-align:center"><code>pgsql.yml</code></td>
</tr>
<tr>
<td style="text-align:center">Required Privileges</td>
<td style="text-align:center">connectable PGURL from infra nodes</td>
<td style="text-align:center">DB node ssh and sudo privileges</td>
<td style="text-align:center">DB node ssh and sudo privileges</td>
</tr>
<tr>
<td style="text-align:center">Function Overview</td>
<td style="text-align:center">PGCAT + PGRDS</td>
<td style="text-align:center">Most Functionality</td>
<td style="text-align:center">Full Functionality</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="monitor-existing-cluster">Monitor Existing Cluster</h2>
<p>Suppose the target DB node can be managed by Pigsty (accessible via ssh and sudo is available). In that case, you can use the <code>pg_exporter</code> task in the <a href="/docs/pgsql/playbook/#pgsqlyml"><code>pgsql.yml</code></a> playbook to deploy the monitoring component PG Exporter on the target node in the same manner as a standard deployment.</p>
<p>You can also deploy the connection pool and its monitoring on existing instance nodes using the <code>pgbouncer</code> and <code>pgbouncer_exporter</code> tasks from the same playbook. Additionally, you can deploy host monitoring, load balancing, and log collection components using the <code>node_exporter</code>, <code>haproxy</code>, and <code>promtail</code> tasks from the <a href="/docs/node/#nodeyml"><code>node.yml</code></a> playbook, achieving a similar user experience with the native Pigsty cluster.</p>
<p>The definition method for existing clusters is very similar to the normal clusters managed by Pigsty. Selectively run certain tasks from the <code>pgsql.yml</code> playbook instead of running the entire playbook.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./node.yml  -l &lt;cls&gt; -t node_repo,node_pkg           <span style="color:#8f5902;font-style:italic"># Add YUM sources for INFRA nodes on host nodes and install packages.</span>
</span></span><span style="display:flex;"><span>./node.yml  -l &lt;cls&gt; -t node_exporter,node_register  <span style="color:#8f5902;font-style:italic"># Configure host monitoring and add to Prometheus.</span>
</span></span><span style="display:flex;"><span>./node.yml  -l &lt;cls&gt; -t promtail                     <span style="color:#8f5902;font-style:italic"># Configure host log collection and send to Loki.</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -l &lt;cls&gt; -t pg_exporter,pg_register      <span style="color:#8f5902;font-style:italic"># Configure PostgreSQL monitoring and register with Prometheus/Grafana.</span>
</span></span></code></pre></div><p>Since the target database cluster already exists, you must manually <a href="/docs/pgsql/monitor/#monitor-setup">setup monitoring users, schemas, and extensions</a> on the target database cluster.</p>
<hr>
<h2 id="monitor-rds">Monitor RDS</h2>
<p>If you can <strong>only access the target database via PGURL</strong> (database connection string), you can refer to the instructions here for configuration. In this mode, Pigsty deploys the corresponding PG Exporter on the <a href="/docs/node/#infra节点">INFRA node</a> to fetch metrics from the remote database, as shown below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">------</span> <span style="color:#000">infra</span> <span style="color:#ce5c00;font-weight:bold">------</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>                 <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>   <span style="color:#000">prometheus</span>    <span style="color:#ce5c00;font-weight:bold">|</span>            <span style="color:#000">v</span><span style="color:#ce5c00;font-weight:bold">----</span> <span style="color:#000">pg</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">----</span><span style="color:#000">v</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>       <span style="color:#ce5c00;font-weight:bold">^</span>         <span style="color:#ce5c00;font-weight:bold">|</span>  <span style="color:#000">metrics</span>   <span style="color:#ce5c00;font-weight:bold">|</span>         <span style="color:#ce5c00;font-weight:bold">^</span>        <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>   <span style="color:#000">pg_exporter</span> <span style="color:#ce5c00;font-weight:bold">&lt;-|------------|----</span>  <span style="color:#000">postgres</span>    <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">(</span><span style="color:#000">port</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">20001</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">|</span>            <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">10.10</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">5432</span> <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>       <span style="color:#ce5c00;font-weight:bold">^</span>         <span style="color:#ce5c00;font-weight:bold">|</span>            <span style="color:#ce5c00;font-weight:bold">^------------------^</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>       <span style="color:#ce5c00;font-weight:bold">^</span>         <span style="color:#ce5c00;font-weight:bold">|</span>                      <span style="color:#ce5c00;font-weight:bold">^</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>       <span style="color:#ce5c00;font-weight:bold">^</span>         <span style="color:#ce5c00;font-weight:bold">|</span>            <span style="color:#000">v</span><span style="color:#ce5c00;font-weight:bold">----</span> <span style="color:#000">pg</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">----</span><span style="color:#000">v</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>       <span style="color:#ce5c00;font-weight:bold">^</span>         <span style="color:#ce5c00;font-weight:bold">|</span>  <span style="color:#000">metrics</span>   <span style="color:#ce5c00;font-weight:bold">|</span>         <span style="color:#ce5c00;font-weight:bold">^</span>        <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>   <span style="color:#000">pg_exporter</span> <span style="color:#ce5c00;font-weight:bold">&lt;-|------------|----</span>  <span style="color:#000">postgres</span>    <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">(</span><span style="color:#000">port</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">20002</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">|</span>            <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">10.10</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">10.11</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">5433</span> <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">-------------------</span>            <span style="color:#ce5c00;font-weight:bold">^------------------^</span>
</span></span></code></pre></div><p>The monitoring system will no longer have host/pooler/load balancer metrics. But the PostgreSQL metrics &amp; catalog info are still available. Pigsty has two dedicated dashboards for that: <a href="https://demo.pigsty.cc/d/pgrds-cluster">PGRDS Cluster</a> and <a href="https://demo.pigsty.cc/d/pgrds-instance">PGRDS Instance</a>. Overview and Database level dashboards are reused. Since Pigsty cannot manage your RDS, you have to <a href="/docs/pgsql/monitor/#monitor-setup">setup monitor</a> on the target database in advance.</p>
<p>Below, we use a sandbox environment as an example: now we assume that the <code>pg-meta</code> cluster is an RDS instance <code>pg-foo-1</code> to be monitored, and the <code>pg-test</code> cluster is an RDS cluster <code>pg-bar</code> to be monitored:</p>
<ol>
<li>
<p>Create monitoring schemas, users, and permissions on the target. Refer to <a href="/docs/pgsql/monitor/#MonitoringObjectConfiguration">Monitoring Object Configuration</a> for details.</p>
</li>
<li>
<p>Declare the cluster in the configuration list. For example, suppose we want to monitor the &ldquo;remote&rdquo; <code>pg-meta</code> &amp; <code>pg-test</code> clusters:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">infra</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># Infra cluster for proxies, monitoring, alerts, etc.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">infra_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># Install pg_exporter on &#39;infra&#39; group for remote postgres RDS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_exporters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># List all remote instances here, assign a unique unused local port for k</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20001</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-foo, pg_seq: 1, pg_host: 10.10.10.10 , pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">meta }] }</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Register meta database as Grafana data source</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20002</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-bar, pg_seq: 1, pg_host: 10.10.10.11 , pg_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5432</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Several different connection string concatenation methods</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20003</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-bar, pg_seq: 2, pg_host: 10.10.10.12 , pg_exporter_url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;postgres://dbuser_monitor:DBUser.Monitor@10.10.10.12:5432/postgres?sslmode=disable&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20004</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-bar, pg_seq: 3, pg_host: 10.10.10.13 , pg_monitor_username: dbuser_monitor, pg_monitor_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Monitor }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>The databases listed in the <code>pg_databases</code> field will be registered in Grafana as a PostgreSQL data source, providing data support for the PGCAT monitoring panel. If you don&rsquo;t want to use PGCAT and register the database in Grafana, set <code>pg_databases</code> to an empty array or leave it blank.</p>
<p><img alt="pigsty-monitor.jpg" src="/img/pigsty/monitor.jpg"></p>
</li>
<li>
<p>Execute the command to add monitoring: <code>bin/pgmon-add &lt;clsname&gt;</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgmon-add pg-foo  <span style="color:#8f5902;font-style:italic"># Bring the pg-foo cluster into monitoring</span>
</span></span><span style="display:flex;"><span>bin/pgmon-add pg-bar  <span style="color:#8f5902;font-style:italic"># Bring the pg-bar cluster into monitoring</span>
</span></span></code></pre></div></li>
<li>
<p>To remove a remote cluster from monitoring, use <code>bin/pgmon-rm &lt;clsname&gt;</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgmon-rm pg-foo  <span style="color:#8f5902;font-style:italic"># Remove pg-foo from Pigsty monitoring</span>
</span></span><span style="display:flex;"><span>bin/pgmon-rm pg-bar  <span style="color:#8f5902;font-style:italic"># Remove pg-bar from Pigsty monitoring</span>
</span></span></code></pre></div></li>
</ol>
<p>You can use more parameters to override the default <code>pg_exporter</code> options. Here is an example for monitoring Aliyun RDS and PolarDB with Pigsty:</p>
<details><summary>Example: Monitor Aliyun RDS PG & PolarDB</summary>
<p>Check <a href="https://github.com/Vonng/pigsty/blob/main/conf/demo/remote.yml">remote.yml</a> config for details.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">infra</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># infra cluster for proxy, monitor, alert, etc..</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">10.10.10.10</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">infra_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># install pg_exporter for remote postgres RDS on a group &#39;infra&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pg_exporters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># list all remote instances here, alloc a unique unused local port as k</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20001</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-foo, pg_seq: 1, pg_host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.10.10.10</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20002</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-bar, pg_seq: 1, pg_host: 10.10.10.11 , pg_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5432</span><span style="color:#f8f8f8;text-decoration:underline"> </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20003</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-bar, pg_seq: 2, pg_host: 10.10.10.12 , pg_exporter_url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;postgres://dbuser_monitor:DBUser.Monitor@10.10.10.12:5432/postgres?sslmode=disable&#39;</span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20004</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">pg_cluster: pg-bar, pg_seq: 3, pg_host: 10.10.10.13 , pg_monitor_username: dbuser_monitor, pg_monitor_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser.Monitor }</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20011</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-polar                       </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># RDS Cluster Name (Identity, Explicitly Assigned, used as &#39;cls&#39;)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">                                   </span><span style="color:#8f5902;font-style:italic"># RDS Instance Seq (Identity, Explicitly Assigned, used as part of &#39;ins&#39;)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pxx.polardbpg.rds.aliyuncs.com    </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># RDS Host Address</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1921</span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#8f5902;font-style:italic"># RDS Port</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_exporter_include_database</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;test&#39;</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># Only monitoring database in this list</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_monitor_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor        </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># monitor username, overwrite default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_monitor_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser_Monitor        </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># monitor password, overwrite default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test }]             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># database to be added to grafana datasource</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20012</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-polar                       </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># RDS Cluster Name (Identity, Explicitly Assigned, used as &#39;cls&#39;)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">                                   </span><span style="color:#8f5902;font-style:italic"># RDS Instance Seq (Identity, Explicitly Assigned, used as part of &#39;ins&#39;)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pe-xx.polarpgmxs.rds.aliyuncs.com </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># RDS Host Address</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1521</span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#8f5902;font-style:italic"># RDS Port</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test }]             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># database to be added to grafana datasource</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20014</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-rds</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgm-xx.pg.rds.aliyuncs.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5432</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_exporter_auto_discovery</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_exporter_include_database</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;rds&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_monitor_username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_monitor_password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DBUser_Monitor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rds } ]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20015</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-rdsha</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgm-2xx8wu.pg.rds.aliyuncs.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5432</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_exporter_auto_discovery</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_exporter_include_database</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;rds&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test }, {name: rds}]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">20016</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg-rdsha</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_seq</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pgr-xx.pg.rds.aliyuncs.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_exporter_auto_discovery</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_exporter_include_database</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;rds&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pg_databases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test }, {name: rds}]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></details>
<hr>
<h2 id="monitor-setup">Monitor Setup</h2>
<p>When you want to monitor existing instances, whether it&rsquo;s RDS or a self-built PostgreSQL instance, you need to make some configurations on the target database so that Pigsty can access them.</p>
<p>To bring an external existing PostgreSQL instance into monitoring, you need a connection string that can access that instance/cluster. Any accessible connection string (business user, superuser) can be used, but we recommend using a dedicated monitoring user to avoid permission leaks.</p>
<ul>
<li><input disabled="" type="checkbox"> <a href="/docs/pgsql/monitor/#monitor-user">Monitor User</a>: The default username used is <code>dbuser_monitor</code>. This user belongs to the <code>pg_monitor</code> group, or ensure it has the necessary view permissions.</li>
<li><input disabled="" type="checkbox"> <a href="/docs/pgsql/monitor/#monitor-hba">Monitor HBA</a>: Default password is <code>DBUser.Monitor</code>. You need to ensure that the HBA policy allows the monitoring user to access the database from the infra nodes.</li>
<li><input disabled="" type="checkbox"> <a href="/docs/pgsql/monitor/#monitor-schema">Monitor Schema</a>: It&rsquo;s optional but recommended to create a dedicate schema <code>monitor</code> for monitoring views and extensions.</li>
<li><input disabled="" type="checkbox"> <a href="/docs/pgsql/monitor/#monitor-extension">Monitor Extension</a>: It is strongly recommended to enable the built-in extension <code>pg_stat_statements</code>.</li>
<li><input disabled="" type="checkbox"> <a href="/docs/pgsql/monitor/#monitor-view">Monitor View</a>: Monitoring views are optional but can provide additional metrics. Which is recommended.</li>
</ul>
<hr>
<h3 id="monitor-user">Monitor User</h3>
<p>Create a monitor user on the target database cluster. For example, <code>dbuser_monitor</code> is used by default in Pigsty.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic">-- create the monitor user
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;system monitor user&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic">-- comment the monitor user
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#8f5902;font-style:italic">-- grant system role pg_monitor to monitor user
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;DBUser.Monitor&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic">-- set password for monitor user
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">log_min_duration_statement</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- set this to avoid log flooding
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">search_path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic">-- set this to avoid pg_stat_statements extension not working
</span></span></span></code></pre></div><p>The monitor user here should have consistent <a href="/docs/reference/param/#pg_monitor_username"><code>pg_monitor_username</code></a> and <a href="/docs/reference/param/#pg_monitor_password"><code>pg_monitor_password</code></a> with Pigsty config inventory.</p>
<hr>
<h3 id="monitor-hba">Monitor HBA</h3>
<p>You also need to configure <code>pg_hba.conf</code> to allow monitoring user access from infra/admin nodes.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allow local role monitor with password</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">local   all  dbuser_monitor                    md5</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host    all  dbuser_monitor  127.0.0.1/32      md5</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host    all  dbuser_monitor  &lt;admin_ip&gt;/32     md5</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">host    all  dbuser_monitor  &lt;infra_ip&gt;/32     md5</span>
</span></span></code></pre></div><p>If your RDS does not support the RAW HBA format, add admin/infra node IP to the whitelist.</p>
<hr>
<h3 id="monitor-schema">Monitor Schema</h3>
<p>Monitor schema is <strong>optional</strong>, but we strongly recommend creating one.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SCHEMA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic">-- create dedicate monitor schema
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SCHEMA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">-- allow monitor user to use this schema
</span></span></span></code></pre></div><hr>
<h3 id="monitor-extension">Monitor Extension</h3>
<p>Monitor extension is <strong>optional</strong>, but we strongly recommend enabling <code>pg_stat_statements</code> extension.</p>
<p>Note that this extension must be listed in <code>shared_preload_libraries</code> to take effect, and changing this parameter requires a database restart.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;pg_stat_statements&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WITH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SCHEMA</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;monitor&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You should create this extension inside the admin database: <code>postgres</code>. If your RDS does not grant <code>CREATE</code> on the database <code>postgres</code>. You can create that extension in the default <code>public</code> schema:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">EXTENSION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;pg_stat_statements&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dbuser_monitor</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">search_path</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>As long as your monitor user can access <code>pg_stat_statements</code> view without schema qualification, it should be fine.</p>
<hr>
<h3 id="monitor-view">Monitor View</h3>
<p>It&rsquo;s recommended to create the monitor views in all databases that need to be monitored.</p>
<details><summary>Monitor Schema & View Definition</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- Table bloat estimate : monitor.pg_table_bloat
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CURRENT_CATALOG</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bs</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">est_tblpages_ff</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tblpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">est_tblpages_ff</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">tblpages</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ceil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">reltuples</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bs</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">page_hdr</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">fillfactor</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tpl_size</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ceil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toasttuples</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">est_tblpages_ff</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#000">tblpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fillfactor</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bs</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">is_na</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tpl_hdr_size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tpl_data_size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tpl_hdr_size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tpl_hdr_size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ceil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tpl_data_size</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">INT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ceil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tpl_data_size</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">INT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tpl_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">heappages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toastpages</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">heappages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#000">toastpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toasttuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bs</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">page_hdr</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fillfactor</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">is_na</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ns</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">heappages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">toast</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toastpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">toast</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">toasttuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">array_to_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reloptions</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39; &#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;fillfactor=([0-9]+)&#39;</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">smallint</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fillfactor</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#000">current_setting</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;block_size&#39;</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">numeric</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bs</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#4e9a06">&#39;mingw32&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#4e9a06">&#39;64-bit|x86_64|ppc64|ia64|amd64&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">page_hdr</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#0000cf;font-weight:bold">23</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">MAX</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">null_frac</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">int</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                   </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bool_or</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">att</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;oid&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">att</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attnum</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tpl_hdr_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">null_frac</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">avg_width</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tpl_data_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#000">bool_or</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">att</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">atttypid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pg_catalog.name&#39;</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">regtype</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                   </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">att</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attnum</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">is_na</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_attribute</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">att</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">att</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_namespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ns</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ns</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#204a87;font-weight:bold">LEFT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schemaname</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">ns</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">inherited</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">att</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#204a87;font-weight:bold">LEFT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">toast</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltoastrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">toast</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">att</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attisdropped</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relkind</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;r&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pg_catalog&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;information_schema&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">is_na</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;postgres table bloat estimate&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- Index bloat estimate : monitor.pg_index_bloat
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CURRENT_CATALOG</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idxname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idxid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">BIGINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bs</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">COALESCE</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">relpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">reltuples</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_tuple_hdr</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_tuple_hdr</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                               </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nulldatawidth</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nulldatawidth</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nulldatawidth</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bs</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pagehdr</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">FLOAT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">idxname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">indrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idxid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#000">current_setting</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;block_size&#39;</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline">                                                               </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bs</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;mingw32&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;64-bit|x86_64|ppc64|ia64|amd64&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ma</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#f8f8f8;text-decoration:underline">                                                                                                   </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pagehdr</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">COALESCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">null_frac</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                               </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_tuple_hdr</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">COALESCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">null_frac</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">COALESCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">avg_width</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">))::</span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline">                                                     </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nulldatawidth</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_attribute</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_namespace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">ic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline">                                                   </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idxname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">ic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reltuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">ic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indrelid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">tc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline">                                                   </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tablename</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">regexp_split_to_table</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indkey</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">TEXT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39; &#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">INTEGER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">attnum</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline">                                          </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">index_oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_index</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ic</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_class</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tc</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_namespace</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_namespace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relnamespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_am</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relam</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_am</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_am</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">amname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;btree&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relpages</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pg_catalog&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;information_schema&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexrelid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attnum</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attnum</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schemaname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_get_indexdef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attrelid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attnum</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tablename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ind_atts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">idxname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attname</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_attribute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attnum</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">est</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;postgres index bloat estimate (btree-only)&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- Relation Bloat : monitor.pg_bloat
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                                                   </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                                                   </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                                                       </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">RegClass</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#f8f8f8;text-decoration:underline">                                                                            </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratio</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_ratio</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratio</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">NUMERIC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">BIGINT</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">idxid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nspname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">||</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relname</span><span style="color:#f8f8f8;text-decoration:underline">                                                    </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idxname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#f8f8f8;text-decoration:underline">                                                                            </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratio</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_ratio</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">CASE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratio</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">THEN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ELSE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ratio</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">NUMERIC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">END</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">BIGINT</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_wasted</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ib</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">FULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OUTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">JOIN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ib</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tblid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tblid</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;postgres relation bloat detail&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_bloat</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- monitor.pg_index_bloat_human
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat_human</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat_human</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idxname</span><span style="color:#f8f8f8;text-decoration:underline">                            </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">tblname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">idx_wasted</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx_size</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_ratio</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_ratio</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx_wasted</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl_size</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_ratio</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_ratio</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl_wasted</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_wasted</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_bloat</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idxname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat_human</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;postgres index bloat info in human-readable format&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_index_bloat_human</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- monitor.pg_table_bloat_human
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat_human</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat_human</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblname</span><span style="color:#f8f8f8;text-decoration:underline">                                          </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">idx_wasted</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_wasted</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx_wasted</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_wasted</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">all_wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl_wasted</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl_size</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">tbl_ratio</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx_wasted</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">pg_size_pretty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx_size</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx_wasted</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">NUMERIC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_ratio</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">tblname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl_wasted</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl_size</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_size</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tbl_ratio</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)::</span><span style="color:#204a87">NUMERIC</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tbl_ratio</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx_wasted</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_wasted</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx_size</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idx_size</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_bloat</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tblname</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat_human</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;postgres table bloat info in human-readable format&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_table_bloat_human</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- Activity Overview: monitor.pg_session
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_session</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_session</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">coalesce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;all&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbackends</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">active</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idle</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ixact</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_duration</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_tx_duration</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_conn_duration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                                         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">numbackends</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FILTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">state</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;active&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">active</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FILTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">state</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;idle&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">idle</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FILTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">state</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;idle in transaction&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">state</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;idle in transaction (aborted)&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ixact</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">extract</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">epoch</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">state_change</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#000">FILTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">state</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;active&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_duration</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">extract</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">epoch</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">xact_start</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_tx_duration</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">extract</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">epoch</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">backend_start</span><span style="color:#000;font-weight:bold">))</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">max_conn_duration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stat_activity</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">backend_type</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;client backend&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_backend_pid</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">GROUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ROLLUP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NULLS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FIRST</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_session</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;postgres activity group by session&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_session</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- Sequential Scan: monitor.pg_seq_scan
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_seq_scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_seq_scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">schemaname</span><span style="color:#f8f8f8;text-decoration:underline">                                                        </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nspname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">relname</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">seq_scan</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">seq_tup_read</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">seq_tup_read</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">seq_scan</span><span style="color:#f8f8f8;text-decoration:underline">                                           </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">seq_tup_avg</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">idx_scan</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">n_live_tup</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n_dead_tup</span><span style="color:#f8f8f8;text-decoration:underline">                                           </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tuples</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n_live_tup</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">::</span><span style="color:#204a87">NUMERIC</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n_live_tup</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n_dead_tup</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">live_ratio</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_stat_user_tables</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">seq_scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n_live_tup</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">n_dead_tup</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ORDER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">seq_scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DESC</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">VIEW</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_seq_scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;table that have seq scan&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_seq_scan</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></details>
<details><summary>Shmem allocation for PostgreSQL 13+</summary>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IF</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXISTS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_shmem</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CASCADE</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">OR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPLACE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_shmem</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">RETURNS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SETOF</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">pg_shmem_allocations</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SELECT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_shmem_allocations</span><span style="color:#000;font-weight:bold">;</span><span style="color:#a40000">$$</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">LANGUAGE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SQL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SECURITY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFINER</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">COMMENT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_shmem</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">IS</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;security wrapper for system view pg_shmem&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">REVOKE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_shmem</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PUBLIC</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">GRANT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">EXECUTE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ON</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FUNCTION</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pg_shmem</span><span style="color:#000;font-weight:bold">()</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TO</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pg_monitor</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></details>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0ce334f57e9d6869b53659cc6bab754e">14 - Dashboards</h1>
    <div class="lead">Grafana dashboards provided by Pigsty</div>
	<blockquote>
<p>Grafana Dashboards for PostgreSQL clusters:  <a href="https://demo.pigsty.cc/d/pgsql-overview">Demo</a> &amp; <a href="https://github.com/Vonng/pigsty/wiki/Gallery">Gallery</a>.</p>
</blockquote>
<p><a href="https://github.com/Vonng/pigsty/wiki/Gallery"><img alt="pigsty-dashboard.jpg" src="/img/pigsty/dashboard.jpg"></a></p>
<p>There are 26 default grafana dashboards about PostgreSQL and categorized into 4 levels. and categorized into <a href="/docs/pgsql/dashboard/#overview">PGSQL</a>, <a href="/docs/pgsql/dashboard/#pgcat">PGCAT</a> &amp; <a href="/docs/pgsql/dashboard/#pglog">PGLOG</a> by datasource.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Overview</th>
<th style="text-align:center">Cluster</th>
<th style="text-align:center">Instance</th>
<th style="text-align:center">Database</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-overview">PGSQL Overview</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-cluster">PGSQL Cluster</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-instance">PGSQL Instance</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-database">PGSQL Database</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-alert">PGSQL Alert</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgrds-cluster">PGRDS Cluster</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgrds-instance">PGRDS Instance</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-database">PGCAT Database</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-shard">PGSQL Shard</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-activity">PGSQL Activity</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-instance">PGCAT Instance</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-tables">PGSQL Tables</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-replication">PGSQL Replication</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-persist">PGSQL Persist</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-table">PGSQL Table</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-service">PGSQL Service</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-proxy">PGSQL Proxy</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-table">PGCAT Table</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-databases">PGSQL Databases</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-pgbouncer">PGSQL Pgbouncer</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-query">PGSQL Query</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-patroni">PGSQL Patroni</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-session">PGSQL Session</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-query">PGCAT Query</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-pitr">PGSQL PITR</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-xacts">PGSQL Xacts</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-locks">PGCAT Locks</a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgsql-exporter">PGSQL Exporter</a></td>
<td style="text-align:center"><a href="https://demo.pigsty.cc/d/pgcat-schema">PGCAT Schema</a></td>
</tr>
</tbody>
</table>
<p><strong>Overview</strong></p>
<ul>
<li><a href="https://demo.pigsty.cc/d/pgsql-overview">pgsql-overview</a> : The main dashboard for PGSQL module</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-alert">pgsql-alert</a> : Global PGSQL key metrics and alerting events</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-shard">pgsql-shard</a> : Overview of a horizontal sharded PGSQL cluster, e.g. citus / gpsql cluster</li>
</ul>
<p><strong>Cluster</strong></p>
<ul>
<li><a href="https://demo.pigsty.cc/d/pgsql-cluster">pgsql-cluster</a>: The main dashboard for a PGSQL cluster</li>
<li><a href="https://demo.pigsty.cc/d/pgrds-cluster">pgrds-cluster</a>: The PGSQL Cluster dashboard for RDS, focus on all postgres metrics only.</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-activity">pgsql-activity</a>: Cares about the Session/Load/QPS/TPS/Locks of a PGSQL cluster</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-replication">pgsql-replication</a>: Cares about PGSQL cluster replication, slots, and pub/sub.</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-service">pgsql-service</a>: Cares about PGSQL cluster services, proxies, routes, and load balancers.</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-databases">pgsql-databases</a>: Cares about database CRUD, slow queries, and table statistics cross all instances.</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-patroni">pgsql-patroni</a>: Cares about cluster HA agent: patroni status.</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-pitr">pgsql-pitr</a>: Cares about context of cluster status during PITR procedure</li>
</ul>
<p><strong>Instance</strong></p>
<ul>
<li><a href="https://demo.pigsty.cc/d/pgsql-instance">pgsql-instance</a>: The main dashboard for a single PGSQL instance</li>
<li><a href="https://demo.pigsty.cc/d/pgrds-instance">pgrds-instance</a>: The PGSQL Instance dashboard for RDS, focus on all postgres metrics only.</li>
<li><a href="https://demo.pigsty.cc/d/pgcat-instance">pgcat-instance</a>: Instance information from database catalog directly</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-persist">pgsql-persist</a>: Metrics about persistence: WAL, XID, Checkpoint, Archive, IO</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-proxy">pgsql-proxy</a>: Metrics about haproxy the service provider</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-queries">pgsql-queries</a>: Overview of all queries in a single instance</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-session">pgsql-session</a>: Metrics about sessions and active/idle time in a single instance</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-xacts">pgsql-xacts</a>: Metrics about transactions, locks, queries, etc&hellip;</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-exporter">pgsql-exporter</a>: Postgres &amp; Pgbouncer exporter self monitoring metrics</li>
</ul>
<p><strong>Database</strong></p>
<ul>
<li><a href="https://demo.pigsty.cc/d/pgsql-database">pgsql-database</a>: The main dashboard for a single PGSQL database</li>
<li><a href="https://demo.pigsty.cc/d/pgcat-database">pgcat-database</a>: Database information from database catalog directly</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-tables">pgsql-tables</a> : Table/Index access metrics inside a single database</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-table">pgsql-table</a>: Detailed information (QPS/RT/Index/Seq&hellip;) about a single table</li>
<li><a href="https://demo.pigsty.cc/d/pgcat-table">pgcat-table</a>: Detailed information (Stats/Bloat/&hellip;) about a single table from database catalog directly</li>
<li><a href="https://demo.pigsty.cc/d/pgsql-query">pgsql-query</a>: Detailed information (QPS/RT) about a single query</li>
<li><a href="https://demo.pigsty.cc/d/pgcat-query">pgcat-query</a>: Detailed information (SQL/Stats) about a single query from database catalog directly</li>
</ul>
<hr>
<h2 id="overview">Overview</h2>
<p><a href="https://demo.pigsty.cc/d/pgsql-overview">PGSQL Overview</a> : The main dashboard for PGSQL module</p>
<details><summary>PGSQL Overview</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-overview"><img alt="pgsql-overview.jpg" src="/img/dashboard/pgsql-overview.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-alert">PGSQL Alert</a> : Global PGSQL key metrics and alerting events</p>
<details><summary>PGSQL Alert</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-alert"><img alt="pgsql-alert.jpg" src="/img/dashboard/pgsql-alert.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-shard">PGSQL Shard</a> : Overview of a horizontal sharded PGSQL cluster, e.g. CITUS / GPSQL cluster</p>
<details><summary>PGSQL Shard</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-shard"><img alt="pgsql-shard.jpg" src="/img/dashboard/pgsql-shard.jpg"></a></p>
</details>
<hr>
<h2 id="cluster">Cluster</h2>
<p><a href="https://demo.pigsty.cc/d/pgsql-cluster">PGSQL Cluster</a>: The main dashboard for a PGSQL cluster</p>
<details><summary>PGSQL Cluster</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-cluster"><img alt="pgsql-cluster.jpg" src="/img/dashboard/pgsql-cluster.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgrds-cluster">PGRDS Cluster</a>: The PGSQL Cluster dashboard for RDS, focus on all postgres metrics only.</p>
<details><summary>PGRDS Cluster</summary>
<p><a href="https://demo.pigsty.cc/d/pgrds-cluster"><img alt="pgrds-cluster.jpg" src="/img/dashboard/pgrds-cluster.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-service">PGSQL Service</a>: Cares about PGSQL cluster services, proxies, routes, and load balancers.</p>
<details><summary>PGSQL Service</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-service"><img alt="pgsql-service.jpg" src="/img/dashboard/pgsql-service.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-activity">PGSQL Activity</a>: Cares about the Session/Load/QPS/TPS/Locks of a PGSQL cluster</p>
<details><summary>PGSQL Activity</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-activity"><img alt="pgsql-activity.jpg" src="/img/dashboard/pgsql-activity.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-replication">PGSQL Replication</a>: Cares about PGSQL cluster replication, slots, and pub/sub.</p>
<details><summary>PGSQL Replication</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-replication"><img alt="pgsql-replication.jpg" src="/img/dashboard/pgsql-replication.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-databases">PGSQL Databases</a>: Cares about database CRUD, slow queries, and table statistics cross all instances.</p>
<details><summary>PGSQL Databases</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-databases"><img alt="pgsql-databases.jpg" src="/img/dashboard/pgsql-databases.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-patroni">PGSQL Patroni</a>: Cares about cluster HA agent: patroni status.</p>
<details><summary>PGSQL Patroni</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-patroni"><img alt="pgsql-patroni.jpg" src="/img/dashboard/pgsql-patroni.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-pitr">PGSQL PITR</a>:  Cares about context of cluster status during PITR procedure</p>
<details><summary>PGSQL PITR</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-pitr"><img alt="pgsql-patroni.jpg" src="/img/dashboard/pgsql-pitr.jpg"></a></p>
</details>
<hr>
<h2 id="instance">Instance</h2>
<p><a href="https://demo.pigsty.cc/d/pgsql-instance">PGSQL Instance</a>: The main dashboard for a single PGSQL instance</p>
<details><summary>PGSQL Instance</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-instance"><img alt="pgsql-instance.jpg" src="/img/dashboard/pgsql-instance.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgrds-instance">PGRDS Instance</a>: The PGSQL Instance dashboard for RDS, focus on all postgres metrics only.</p>
<details><summary>PGRDS Instance</summary>
<p><a href="https://demo.pigsty.cc/d/pgrds-instance"><img alt="pgrds-instance.jpg" src="/img/dashboard/pgrds-instance.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-proxy">PGSQL Proxy</a>: Metrics about haproxy the service provider</p>
<details><summary>PGSQL Proxy</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-proxy"><img alt="pgsql-proxy.jpg" src="/img/dashboard/pgsql-proxy.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-pgbouncer">PGSQL Pgbouncer</a>: Metrics about one single pgbouncer connection pool instance</p>
<details><summary>PGSQL Pgbouncer</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-pgbouncer"><img alt="pgsql-pgbouncer.jpg" src="/img/dashboard/pgsql-pgbouncer.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-persist">PGSQL Persist</a>: Metrics about persistence: WAL, XID, Checkpoint, Archive, IO</p>
<details><summary>PGSQL Persist</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-persist"><img alt="pgsql-persist.jpg" src="/img/dashboard/pgsql-persist.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-xacts">PGSQL Xacts</a>: Metrics about transactions, locks, queries, etc&hellip;</p>
<details><summary>PGSQL Xacts</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-xacts"><img alt="pgsql-xacts.jpg" src="/img/dashboard/pgsql-xacts.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-session">PGSQL Session</a>: Metrics about sessions and active/idle time in a single instance</p>
<details><summary>PGSQL Session</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-session"><img alt="pgsql-session.jpg" src="/img/dashboard/pgsql-session.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-exporter">PGSQL Exporter</a>: Postgres &amp; Pgbouncer exporter self monitoring metrics</p>
<details><summary>PGSQL Exporter</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-exporter"><img alt="pgsql-exporter.jpg" src="/img/dashboard/pgsql-exporter.jpg"></a></p>
</details>
<hr>
<h2 id="database">Database</h2>
<p><a href="https://demo.pigsty.cc/d/pgsql-database">PGSQL Database</a>: The main dashboard for a single PGSQL database</p>
<details><summary>PGSQL Database</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-database"><img alt="pgsql-database.jpg" src="/img/dashboard/pgsql-database.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-tables">PGSQL Tables</a> : Table/Index access metrics inside a single database</p>
<details><summary>PGSQL Tables</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-tables"><img alt="pgsql-tables.jpg" src="/img/dashboard/pgsql-tables.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-table">PGSQL Table</a>: Detailed information (QPS/RT/Index/Seq&hellip;) about a single table</p>
<details><summary>PGSQL Table</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-table"><img alt="pgsql-table.jpg" src="/img/dashboard/pgsql-table.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgsql-query">PGSQL Query</a>: Detailed information (QPS/RT) about a single query</p>
<details><summary>PGSQL Query</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-query"><img alt="pgsql-query.jpg" src="/img/dashboard/pgsql-query.jpg"></a></p>
</details>
<hr>
<h2 id="pgcat">PGCAT</h2>
<p><a href="https://demo.pigsty.cc/d/pgcat-instance">PGCAT Instance</a>: Instance information from database catalog directly</p>
<details><summary>PGCAT Instance</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-instance"><img alt="pgcat-instance.jpg" src="/img/dashboard/pgcat-instance.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgcat-database">PGCAT Database</a>: Database information from database catalog directly</p>
<details><summary>PGCAT Database</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-database"><img alt="pgcat-database.jpg" src="/img/dashboard/pgcat-database.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgcat-schema">PGCAT Schema</a>: Detailed information about one single schema from database catalog directly</p>
<details><summary>PGCAT Schema</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-schema"><img alt="pgcat-schema.jpg" src="/img/dashboard/pgcat-schema.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgcat-table">PGCAT Table</a>: Detailed information about one single table from database catalog directly</p>
<details><summary>PGCAT Table</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-table"><img alt="pgcat-table.jpg" src="/img/dashboard/pgcat-table.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgcat-query">PGCAT Query</a>: Detailed information about one single type of query from database catalog directly</p>
<details><summary>PGCAT Query</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-query"><img alt="pgcat-query.jpg" src="/img/dashboard/pgcat-query.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pgcat-locks">PGCAT Locks</a>: Detailed information about live locks &amp; activity from database catalog directly</p>
<details><summary>PGCAT Locks</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-locks"><img alt="pgcat-locks.jpg" src="/img/dashboard/pgcat-locks.jpg"></a></p>
</details>
<hr>
<h2 id="pglog">PGLOG</h2>
<p><a href="https://demo.pigsty.cc/d/pglog-overview">PGLOG Overview</a>: Overview of csv log sample in pigsty meta database</p>
<details><summary>PGLOG Overview</summary>
<p><a href="https://demo.pigsty.cc/d/pglog-overview"><img alt="pglog-overview.jpg" src="/img/dashboard/pglog-overview.jpg"></a></p>
</details>
<p><a href="https://demo.pigsty.cc/d/pglog-overview">PGLOG Overview</a>: Detail of one single session of csv log sample in pigsty meta database</p>
<details><summary>PGLOG Session</summary>
<p><a href="https://demo.pigsty.cc/d/pglog-session"><img alt="pglog-session.jpg" src="/img/dashboard/pglog-session.jpg"></a></p>
</details>
<hr>
<h2 id="gallery">Gallery</h2>
<details><summary>PGSQL Shard</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-shard"><img alt="pgsql-shard.jpg" src="/img/dashboard/pgsql-shard.jpg"></a></p>
</details>
<details><summary>PGSQL Cluster</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-cluster"><img alt="pgsql-cluster.jpg" src="/img/dashboard/pgsql-cluster.jpg"></a></p>
</details>
<details><summary>PGSQL Service</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-service"><img alt="pgsql-service.jpg" src="/img/dashboard/pgsql-service.jpg"></a></p>
</details>
<details><summary>PGSQL Activity</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-activity"><img alt="pgsql-activity.jpg" src="/img/dashboard/pgsql-activity.jpg"></a></p>
</details>
<details><summary>PGSQL Replication</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-replication"><img alt="pgsql-replication.jpg" src="/img/dashboard/pgsql-replication.jpg"></a></p>
</details>
<details><summary>PGSQL Databases</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-databases"><img alt="pgsql-databases.jpg" src="/img/dashboard/pgsql-databases.jpg"></a></p>
</details>
<details><summary>PGSQL Instance</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-instance"><img alt="pgsql-instance.jpg" src="/img/dashboard/pgsql-instance.jpg"></a></p>
</details>
<details><summary>PGSQL Proxy</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-proxy"><img alt="pgsql-proxy.jpg" src="/img/dashboard/pgsql-proxy.jpg"></a></p>
</details>
<details><summary>PGSQL Pgbouncer</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-pgbouncer"><img alt="pgsql-pgbouncer.jpg" src="/img/dashboard/pgsql-pgbouncer.jpg"></a></p>
</details>
<details><summary>PGSQL Session</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-session"><img alt="pgsql-session.jpg" src="/img/dashboard/pgsql-session.jpg"></a></p>
</details>
<details><summary>PGSQL Xacts</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-xacts"><img alt="pgsql-xacts.jpg" src="/img/dashboard/pgsql-xacts.jpg"></a></p>
</details>
<details><summary>PGSQL Persist</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-persist"><img alt="pgsql-persist.jpg" src="/img/dashboard/pgsql-persist.jpg"></a></p>
</details>
<details><summary>PGSQL Database</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-database"><img alt="pgsql-database.jpg" src="/img/dashboard/pgsql-database.jpg"></a></p>
</details>
<details><summary>PGSQL Tables</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-tables"><img alt="pgsql-tables.jpg" src="/img/dashboard/pgsql-tables.jpg"></a></p>
</details>
<details><summary>PGSQL Table</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-table"><img alt="pgsql-table.jpg" src="/img/dashboard/pgsql-table.jpg"></a></p>
</details>
<details><summary>PGSQL Query</summary>
<p><a href="https://demo.pigsty.cc/d/pgsql-query"><img alt="pgsql-query.jpg" src="/img/dashboard/pgsql-query.jpg"></a></p>
</details>
<details><summary>PGCAT Instance</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-instance"><img alt="pgcat-instance.jpg" src="/img/dashboard/pgcat-instance.jpg"></a></p>
</details>
<details><summary>PGCAT Database</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-database"><img alt="pgcat-database.jpg" src="/img/dashboard/pgcat-database.jpg"></a></p>
</details>
<details><summary>PGCAT Schema</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-schema"><img alt="pgcat-schema.jpg" src="/img/dashboard/pgcat-schema.jpg"></a></p>
</details>
<details><summary>PGCAT Table</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-table"><img alt="pgcat-table.jpg" src="/img/dashboard/pgcat-table.jpg"></a></p>
</details>
<details><summary>PGCAT Lock</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-locks"><img alt="pgcat-locks.jpg" src="/img/dashboard/pgcat-locks.jpg"></a></p>
</details>
<details><summary>PGCAT Query</summary>
<p><a href="https://demo.pigsty.cc/d/pgcat-query"><img alt="pgcat-query.jpg" src="/img/dashboard/pgcat-query.jpg"></a></p>
</details>
<details><summary>PGLOG Overview</summary>
<p><a href="https://demo.pigsty.cc/d/pglog-overview"><img alt="pglog-overview.jpg" src="/img/dashboard/pglog-overview.jpg"></a></p>
</details>
<details><summary>PGLOG Session</summary>
<p><a href="https://demo.pigsty.cc/d/pglog-session"><img alt="pglog-session.jpg" src="/img/dashboard/pglog-session.jpg"></a></p>
</details>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1f69b3f46163cb973f38581bf88a88a8">15 - Metrics</h1>
    <div class="lead">Pigsty PGSQL module metric list</div>
	<p><a href="/docs/pgsql/"><strong><code>PGSQL</code></strong></a> module has 638 available metrics</p>
<table>
<thead>
<tr>
<th>Metric Name</th>
<th>Type</th>
<th>Labels</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ALERTS</td>
<td>Unknown</td>
<td><code>category</code>, <code>job</code>, <code>level</code>, <code>ins</code>, <code>severity</code>, <code>ip</code>, <code>alertname</code>, <code>alertstate</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>ALERTS_FOR_STATE</td>
<td>Unknown</td>
<td><code>category</code>, <code>job</code>, <code>level</code>, <code>ins</code>, <code>severity</code>, <code>ip</code>, <code>alertname</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>cls:pressure1</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>cls:pressure15</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>cls:pressure5</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>go_gc_duration_seconds</td>
<td>summary</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>quantile</code>, <code>cls</code></td>
<td>A summary of the pause duration of garbage collection cycles.</td>
</tr>
<tr>
<td>go_gc_duration_seconds_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>go_gc_duration_seconds_sum</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>go_goroutines</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of goroutines that currently exist.</td>
</tr>
<tr>
<td>go_info</td>
<td>gauge</td>
<td><code>version</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Information about the Go environment.</td>
</tr>
<tr>
<td>go_memstats_alloc_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes allocated and still in use.</td>
</tr>
<tr>
<td>go_memstats_alloc_bytes_total</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of bytes allocated, even if freed.</td>
</tr>
<tr>
<td>go_memstats_buck_hash_sys_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes used by the profiling bucket hash table.</td>
</tr>
<tr>
<td>go_memstats_frees_total</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of frees.</td>
</tr>
<tr>
<td>go_memstats_gc_sys_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes used for garbage collection system metadata.</td>
</tr>
<tr>
<td>go_memstats_heap_alloc_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of heap bytes allocated and still in use.</td>
</tr>
<tr>
<td>go_memstats_heap_idle_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of heap bytes waiting to be used.</td>
</tr>
<tr>
<td>go_memstats_heap_inuse_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of heap bytes that are in use.</td>
</tr>
<tr>
<td>go_memstats_heap_objects</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of allocated objects.</td>
</tr>
<tr>
<td>go_memstats_heap_released_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of heap bytes released to OS.</td>
</tr>
<tr>
<td>go_memstats_heap_sys_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of heap bytes obtained from system.</td>
</tr>
<tr>
<td>go_memstats_last_gc_time_seconds</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of seconds since 1970 of last garbage collection.</td>
</tr>
<tr>
<td>go_memstats_lookups_total</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of pointer lookups.</td>
</tr>
<tr>
<td>go_memstats_mallocs_total</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of mallocs.</td>
</tr>
<tr>
<td>go_memstats_mcache_inuse_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes in use by mcache structures.</td>
</tr>
<tr>
<td>go_memstats_mcache_sys_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes used for mcache structures obtained from system.</td>
</tr>
<tr>
<td>go_memstats_mspan_inuse_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes in use by mspan structures.</td>
</tr>
<tr>
<td>go_memstats_mspan_sys_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes used for mspan structures obtained from system.</td>
</tr>
<tr>
<td>go_memstats_next_gc_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of heap bytes when next garbage collection will take place.</td>
</tr>
<tr>
<td>go_memstats_other_sys_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes used for other system allocations.</td>
</tr>
<tr>
<td>go_memstats_stack_inuse_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes in use by the stack allocator.</td>
</tr>
<tr>
<td>go_memstats_stack_sys_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes obtained from system for stack allocator.</td>
</tr>
<tr>
<td>go_memstats_sys_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of bytes obtained from system.</td>
</tr>
<tr>
<td>go_threads</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of OS threads created.</td>
</tr>
<tr>
<td>ins:pressure1</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>ins:pressure15</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>ins:pressure5</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>patroni_cluster_unlocked</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if the cluster is unlocked, 0 if locked.</td>
</tr>
<tr>
<td>patroni_dcs_last_seen</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Epoch timestamp when DCS was last contacted successfully by Patroni.</td>
</tr>
<tr>
<td>patroni_failsafe_mode_is_active</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if failsafe mode is active, 0 if inactive.</td>
</tr>
<tr>
<td>patroni_is_paused</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if auto failover is disabled, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_master</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if this node is the leader, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_pending_restart</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if the node needs a restart, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_postgres_in_archive_recovery</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if Postgres is replicating from archive, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_postgres_running</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if Postgres is running, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_postgres_server_version</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Version of Postgres (if running), 0 otherwise.</td>
</tr>
<tr>
<td>patroni_postgres_streaming</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if Postgres is streaming, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_postgres_timeline</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Postgres timeline of this node (if running), 0 otherwise.</td>
</tr>
<tr>
<td>patroni_postmaster_start_time</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Epoch seconds since Postgres started.</td>
</tr>
<tr>
<td>patroni_primary</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if this node is the leader, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_replica</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if this node is a replica, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_standby_leader</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if this node is the standby_leader, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_sync_standby</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if this node is a sync standby replica, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_up</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>patroni_version</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Patroni semver without periods.</td>
</tr>
<tr>
<td>patroni_xlog_location</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Current location of the Postgres transaction log, 0 if this node is not the leader.</td>
</tr>
<tr>
<td>patroni_xlog_paused</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Value is 1 if the Postgres xlog is paused, 0 otherwise.</td>
</tr>
<tr>
<td>patroni_xlog_received_location</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Current location of the received Postgres transaction log, 0 if this node is not a replica.</td>
</tr>
<tr>
<td>patroni_xlog_replayed_location</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Current location of the replayed Postgres transaction log, 0 if this node is not a replica.</td>
</tr>
<tr>
<td>patroni_xlog_replayed_timestamp</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td>
<td>Current timestamp of the replayed Postgres transaction log, 0 if null.</td>
</tr>
<tr>
<td>pg:cls:active_backends</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:active_time_rate15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:active_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:active_time_rate5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:age</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:buf_alloc_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:buf_clean_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:buf_flush_backend_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:buf_flush_checkpoint_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:cpu_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:cpu_usage</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:cpu_usage_15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:cpu_usage_1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:cpu_usage_5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:db_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:file_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:ixact_backends</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:ixact_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:lag_bytes</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:lag_seconds</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:leader</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:load1</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:load15</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:load5</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:lock_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:locks</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code>, <code>mode</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:log_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:lsn_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:members</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:num_backends</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:partition</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:receiver</td>
<td>Unknown</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>appname</code>, <code>ip</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:rlock_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:saturation1</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:saturation15</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:saturation5</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:sender</td>
<td>Unknown</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:session_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:size</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:slot_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:slot_retained_bytes</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:standby_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:sync_state</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:timeline</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:tup_deleted_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:tup_fetched_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:tup_inserted_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:tup_modified_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:tup_returned_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:wal_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_commit_rate15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_commit_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_commit_rate5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_rollback_rate15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_rollback_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_rollback_rate5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_total_rate15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_total_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xact_total_sigma15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:cls:xlock_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:active_backends</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:active_time_rate15m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:active_time_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:active_time_rate5m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:age</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:age_deriv1h</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:age_exhaust</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:blk_io_time_seconds_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:blk_read_time_seconds_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:blk_write_time_seconds_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:blks_access_1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:blks_hit_1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:blks_hit_ratio1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:blks_read_1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:conn_limit</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:conn_usage</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:db_size</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:ixact_backends</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:ixact_time_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:lock_count</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:num_backends</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:rlock_count</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:session_time_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:temp_bytes_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:temp_files_1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:tup_deleted_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:tup_fetched_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:tup_inserted_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:tup_modified_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:tup_returned_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:wlock_count</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_commit_rate15m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_commit_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_commit_rate5m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_rollback_rate15m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_rollback_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_rollback_rate5m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_total_rate15m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_total_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_total_rate5m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xact_total_sigma15m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:db:xlock_count</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:active_backends</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:active_time_rate15m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:active_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:active_time_rate5m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:age</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:cpu_count</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:cpu_usage</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:cpu_usage_15m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:cpu_usage_1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:cpu_usage_5m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:ixact_backends</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:ixact_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:lag_bytes</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:lag_seconds</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:lsn_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:session_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:tup_deleted_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:tup_fetched_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:tup_inserted_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:tup_modified_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:tup_returned_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_commit_rate15m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_commit_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_commit_rate5m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_rollback_rate15m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_rollback_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_rollback_rate5m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_total_rate15m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_total_rate1m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:env:xact_total_sigma15m</td>
<td>Unknown</td>
<td><code>job</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:active_backends</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:active_time_rate15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:active_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:active_time_rate5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:age</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:blks_hit_ratio1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:buf_alloc_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:buf_clean_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:buf_flush_backend_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:buf_flush_checkpoint_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:ckpt_1h</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:ckpt_req_1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:ckpt_timed_1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:conn_limit</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:conn_usage</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:cpu_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:cpu_usage</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:cpu_usage_15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:cpu_usage_1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:cpu_usage_5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:db_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:file_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:fs_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:is_leader</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:ixact_backends</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:ixact_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:lag_bytes</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:lag_seconds</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:load1</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:load15</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:load5</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:lock_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:locks</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>mode</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:log_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:lsn_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:mem_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:num_backends</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:rlock_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:saturation1</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:saturation15</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:saturation5</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:session_time_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:slot_retained_bytes</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:space_usage</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:status</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:sync_state</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:target_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code>, <code>ins</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:timeline</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:tup_deleted_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:tup_fetched_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:tup_inserted_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:tup_modified_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:tup_returned_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:wal_size</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:wlock_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_commit_rate15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_commit_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_commit_rate5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_rollback_rate15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_rollback_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_rollback_rate5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_total_rate15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_total_rate1m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_total_rate5m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xact_total_sigma15m</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:ins:xlock_count</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:query:call_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:query:rt_1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg:table:scan_rate1m</td>
<td>Unknown</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg_activity_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Count of connection among (datname,state)</td>
</tr>
<tr>
<td>pg_activity_max_conn_duration</td>
<td>gauge</td>
<td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Max backend session duration since state change among (datname, state)</td>
</tr>
<tr>
<td>pg_activity_max_duration</td>
<td>gauge</td>
<td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Max duration since last state change among (datname, state)</td>
</tr>
<tr>
<td>pg_activity_max_tx_duration</td>
<td>gauge</td>
<td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Max transaction duration since state change among (datname, state)</td>
</tr>
<tr>
<td>pg_archiver_failed_count</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of failed attempts for archiving WAL files</td>
</tr>
<tr>
<td>pg_archiver_finish_count</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of WAL files that have been successfully archived</td>
</tr>
<tr>
<td>pg_archiver_last_failed_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time of the last failed archival operation</td>
</tr>
<tr>
<td>pg_archiver_last_finish_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time of the last successful archive operation</td>
</tr>
<tr>
<td>pg_archiver_reset_time</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time at which archive statistics were last reset</td>
</tr>
<tr>
<td>pg_backend_count</td>
<td>gauge</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Database backend process count by backend_type</td>
</tr>
<tr>
<td>pg_bgwriter_buffers_alloc</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of buffers allocated</td>
</tr>
<tr>
<td>pg_bgwriter_buffers_backend</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of buffers written directly by a backend</td>
</tr>
<tr>
<td>pg_bgwriter_buffers_backend_fsync</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times a backend had to execute its own fsync call</td>
</tr>
<tr>
<td>pg_bgwriter_buffers_checkpoint</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of buffers written during checkpoints</td>
</tr>
<tr>
<td>pg_bgwriter_buffers_clean</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of buffers written by the background writer</td>
</tr>
<tr>
<td>pg_bgwriter_checkpoint_sync_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total amount of time that has been spent in the portion of checkpoint processing where files are synchronized to disk, in seconds</td>
</tr>
<tr>
<td>pg_bgwriter_checkpoint_write_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total amount of time that has been spent in the portion of checkpoint processing where files are written to disk, in seconds</td>
</tr>
<tr>
<td>pg_bgwriter_checkpoints_req</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of requested checkpoints that have been performed</td>
</tr>
<tr>
<td>pg_bgwriter_checkpoints_timed</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of scheduled checkpoints that have been performed</td>
</tr>
<tr>
<td>pg_bgwriter_maxwritten_clean</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times the background writer stopped a cleaning scan because it had written too many buffers</td>
</tr>
<tr>
<td>pg_bgwriter_reset_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time at which bgwriter statistics were last reset</td>
</tr>
<tr>
<td>pg_boot_time</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>unix timestamp when postmaster boot</td>
</tr>
<tr>
<td>pg_checkpoint_checkpoint_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint location</td>
</tr>
<tr>
<td>pg_checkpoint_elapse</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Seconds elapsed since latest checkpoint in seconds</td>
</tr>
<tr>
<td>pg_checkpoint_full_page_writes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s full_page_writes enabled</td>
</tr>
<tr>
<td>pg_checkpoint_newest_commit_ts_xid</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s newestCommitTsXid</td>
</tr>
<tr>
<td>pg_checkpoint_next_multi_offset</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s NextMultiOffset</td>
</tr>
<tr>
<td>pg_checkpoint_next_multixact_id</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s NextMultiXactId</td>
</tr>
<tr>
<td>pg_checkpoint_next_oid</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s NextOID</td>
</tr>
<tr>
<td>pg_checkpoint_next_xid</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s NextXID xid</td>
</tr>
<tr>
<td>pg_checkpoint_next_xid_epoch</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s NextXID epoch</td>
</tr>
<tr>
<td>pg_checkpoint_oldest_active_xid</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s oldestActiveXID</td>
</tr>
<tr>
<td>pg_checkpoint_oldest_commit_ts_xid</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s oldestCommitTsXid</td>
</tr>
<tr>
<td>pg_checkpoint_oldest_multi_dbid</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s oldestMulti&rsquo;s DB OID</td>
</tr>
<tr>
<td>pg_checkpoint_oldest_multi_xid</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s oldestMultiXid</td>
</tr>
<tr>
<td>pg_checkpoint_oldest_xid</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s oldestXID</td>
</tr>
<tr>
<td>pg_checkpoint_oldest_xid_dbid</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s oldestXID&rsquo;s DB OID</td>
</tr>
<tr>
<td>pg_checkpoint_prev_tli</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s PrevTimeLineID</td>
</tr>
<tr>
<td>pg_checkpoint_redo_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s REDO location</td>
</tr>
<tr>
<td>pg_checkpoint_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time of latest checkpoint</td>
</tr>
<tr>
<td>pg_checkpoint_tli</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Latest checkpoint&rsquo;s TimeLineID</td>
</tr>
<tr>
<td>pg_conf_reload_time</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds since last configuration reload</td>
</tr>
<tr>
<td>pg_db_active_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent executing SQL statements in this database, in seconds</td>
</tr>
<tr>
<td>pg_db_age</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Age of database calculated from datfrozenxid</td>
</tr>
<tr>
<td>pg_db_allow_conn</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>If false(0) then no one can connect to this database.</td>
</tr>
<tr>
<td>pg_db_blk_read_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent reading data file blocks by backends in this database, in seconds</td>
</tr>
<tr>
<td>pg_db_blk_write_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent writing data file blocks by backends in this database, in seconds</td>
</tr>
<tr>
<td>pg_db_blks_access</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times disk blocks that accessed read+hit</td>
</tr>
<tr>
<td>pg_db_blks_hit</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times disk blocks were found already in the buffer cache</td>
</tr>
<tr>
<td>pg_db_blks_read</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of disk blocks read in this database</td>
</tr>
<tr>
<td>pg_db_cks_fail_time</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time at which the last data page checksum failure was detected in this database</td>
</tr>
<tr>
<td>pg_db_cks_fails</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of data page checksum failures detected in this database, -1 for not enabled</td>
</tr>
<tr>
<td>pg_db_confl_confl_bufferpin</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of queries in this database that have been canceled due to pinned buffers</td>
</tr>
<tr>
<td>pg_db_confl_confl_deadlock</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of queries in this database that have been canceled due to deadlocks</td>
</tr>
<tr>
<td>pg_db_confl_confl_lock</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of queries in this database that have been canceled due to lock timeouts</td>
</tr>
<tr>
<td>pg_db_confl_confl_snapshot</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of queries in this database that have been canceled due to old snapshots</td>
</tr>
<tr>
<td>pg_db_confl_confl_tablespace</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of queries in this database that have been canceled due to dropped tablespaces</td>
</tr>
<tr>
<td>pg_db_conflicts</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of queries canceled due to conflicts with recovery in this database</td>
</tr>
<tr>
<td>pg_db_conn_limit</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Sets maximum number of concurrent connections that can be made to this database. -1 means no limit.</td>
</tr>
<tr>
<td>pg_db_datid</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>OID of the database</td>
</tr>
<tr>
<td>pg_db_deadlocks</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of deadlocks detected in this database</td>
</tr>
<tr>
<td>pg_db_frozen_xid</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>All transaction IDs before this one have been frozened</td>
</tr>
<tr>
<td>pg_db_is_template</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>If true(1), then this database can be cloned by any user with CREATEDB privileges</td>
</tr>
<tr>
<td>pg_db_ixact_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent idling while in a transaction in this database, in seconds</td>
</tr>
<tr>
<td>pg_db_numbackends</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of backends currently connected to this database</td>
</tr>
<tr>
<td>pg_db_reset_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time at which database statistics were last reset</td>
</tr>
<tr>
<td>pg_db_session_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent by database sessions in this database, in seconds</td>
</tr>
<tr>
<td>pg_db_sessions</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of sessions established to this database</td>
</tr>
<tr>
<td>pg_db_sessions_abandoned</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of database sessions to this database that were terminated because connection to the client was lost</td>
</tr>
<tr>
<td>pg_db_sessions_fatal</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of database sessions to this database that were terminated by fatal errors</td>
</tr>
<tr>
<td>pg_db_sessions_killed</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of database sessions to this database that were terminated by operator intervention</td>
</tr>
<tr>
<td>pg_db_temp_bytes</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total amount of data written to temporary files by queries in this database.</td>
</tr>
<tr>
<td>pg_db_temp_files</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of temporary files created by queries in this database</td>
</tr>
<tr>
<td>pg_db_tup_deleted</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows deleted by queries in this database</td>
</tr>
<tr>
<td>pg_db_tup_fetched</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows fetched by queries in this database</td>
</tr>
<tr>
<td>pg_db_tup_inserted</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows inserted by queries in this database</td>
</tr>
<tr>
<td>pg_db_tup_modified</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows modified by queries in this database</td>
</tr>
<tr>
<td>pg_db_tup_returned</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows returned by queries in this database</td>
</tr>
<tr>
<td>pg_db_tup_updated</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows updated by queries in this database</td>
</tr>
<tr>
<td>pg_db_xact_commit</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of transactions in this database that have been committed</td>
</tr>
<tr>
<td>pg_db_xact_rollback</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of transactions in this database that have been rolled back</td>
</tr>
<tr>
<td>pg_db_xact_total</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of transactions in this database</td>
</tr>
<tr>
<td>pg_downstream_count</td>
<td>gauge</td>
<td><code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Count of corresponding state</td>
</tr>
<tr>
<td>pg_exporter_agent_up</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg_exporter_last_scrape_time</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds exporter spending on scrapping</td>
</tr>
<tr>
<td>pg_exporter_query_cache_ttl</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times to live of query cache</td>
</tr>
<tr>
<td>pg_exporter_query_scrape_duration</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds query spending on scrapping</td>
</tr>
<tr>
<td>pg_exporter_query_scrape_error_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times the query failed</td>
</tr>
<tr>
<td>pg_exporter_query_scrape_hit_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>numbers been scrapped from this query</td>
</tr>
<tr>
<td>pg_exporter_query_scrape_metric_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>numbers of metrics been scrapped from this query</td>
</tr>
<tr>
<td>pg_exporter_query_scrape_total_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times exporter server was scraped for metrics</td>
</tr>
<tr>
<td>pg_exporter_scrape_duration</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds exporter spending on scrapping</td>
</tr>
<tr>
<td>pg_exporter_scrape_error_count</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times exporter was scraped for metrics and failed</td>
</tr>
<tr>
<td>pg_exporter_scrape_total_count</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times exporter was scraped for metrics</td>
</tr>
<tr>
<td>pg_exporter_server_scrape_duration</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds exporter server spending on scrapping</td>
</tr>
<tr>
<td>pg_exporter_server_scrape_error_count</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pg_exporter_server_scrape_total_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times exporter server was scraped for metrics</td>
</tr>
<tr>
<td>pg_exporter_server_scrape_total_seconds</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds exporter server spending on scrapping</td>
</tr>
<tr>
<td>pg_exporter_up</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>always be 1 if your could retrieve metrics</td>
</tr>
<tr>
<td>pg_exporter_uptime</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds since exporter primary server inited</td>
</tr>
<tr>
<td>pg_flush_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>primary only, location of current wal syncing</td>
</tr>
<tr>
<td>pg_func_calls</td>
<td>counter</td>
<td><code>datname</code>, <code>funcname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times this function has been called</td>
</tr>
<tr>
<td>pg_func_self_time</td>
<td>counter</td>
<td><code>datname</code>, <code>funcname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total time spent in this function itself, not including other functions called by it, in ms</td>
</tr>
<tr>
<td>pg_func_total_time</td>
<td>counter</td>
<td><code>datname</code>, <code>funcname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total time spent in this function and all other functions called by it, in ms</td>
</tr>
<tr>
<td>pg_in_recovery</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>server is in recovery mode? 1 for yes 0 for no</td>
</tr>
<tr>
<td>pg_index_idx_blks_hit</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td>
<td>Number of buffer hits in this index</td>
</tr>
<tr>
<td>pg_index_idx_blks_read</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td>
<td>Number of disk blocks read from this index</td>
</tr>
<tr>
<td>pg_index_idx_scan</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td>
<td>Number of index scans initiated on this index</td>
</tr>
<tr>
<td>pg_index_idx_tup_fetch</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td>
<td>Number of live table rows fetched by simple index scans using this index</td>
</tr>
<tr>
<td>pg_index_idx_tup_read</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td>
<td>Number of index entries returned by scans on this index</td>
</tr>
<tr>
<td>pg_index_relpages</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td>
<td>Size of the on-disk representation of this index in pages</td>
</tr>
<tr>
<td>pg_index_reltuples</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td>
<td>Estimate relation tuples</td>
</tr>
<tr>
<td>pg_insert_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>primary only, location of current wal inserting</td>
</tr>
<tr>
<td>pg_io_evictions</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times a block has been written out from a shared or local buffer</td>
</tr>
<tr>
<td>pg_io_extend_time</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent in extend operations in seconds</td>
</tr>
<tr>
<td>pg_io_extends</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of relation extend operations, each of the size specified in op_bytes.</td>
</tr>
<tr>
<td>pg_io_fsync_time</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent in fsync operations in seconds</td>
</tr>
<tr>
<td>pg_io_fsyncs</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of fsync calls. These are only tracked in context normal</td>
</tr>
<tr>
<td>pg_io_hits</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>The number of times a desired block was found in a shared buffer.</td>
</tr>
<tr>
<td>pg_io_op_bytes</td>
<td>gauge</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>The number of bytes per unit of I/O read, written, or extended. 8192 by default</td>
</tr>
<tr>
<td>pg_io_read_time</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent in read operations in seconds</td>
</tr>
<tr>
<td>pg_io_reads</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of read operations, each of the size specified in op_bytes.</td>
</tr>
<tr>
<td>pg_io_reset_time</td>
<td>gauge</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Timestamp at which these statistics were last reset</td>
</tr>
<tr>
<td>pg_io_reuses</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>The number of times an existing buffer in reused</td>
</tr>
<tr>
<td>pg_io_write_time</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent in write operations in seconds</td>
</tr>
<tr>
<td>pg_io_writeback_time</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent in writeback operations in seconds</td>
</tr>
<tr>
<td>pg_io_writebacks</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of units of size op_bytes which the process requested the kernel write out to permanent storage.</td>
</tr>
<tr>
<td>pg_io_writes</td>
<td>counter</td>
<td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of write operations, each of the size specified in op_bytes.</td>
</tr>
<tr>
<td>pg_is_in_recovery</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>1 if in recovery mode</td>
</tr>
<tr>
<td>pg_is_wal_replay_paused</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>1 if wal play paused</td>
</tr>
<tr>
<td>pg_lag</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>replica only, replication lag in seconds</td>
</tr>
<tr>
<td>pg_last_replay_time</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>time when last transaction been replayed</td>
</tr>
<tr>
<td>pg_lock_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>mode</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of locks of corresponding mode and database</td>
</tr>
<tr>
<td>pg_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>log sequence number, current write location</td>
</tr>
<tr>
<td>pg_meta_info</td>
<td>gauge</td>
<td><code>cls</code>, <code>extensions</code>, <code>version</code>, <code>job</code>, <code>ins</code>, <code>primary_conninfo</code>, <code>conf_path</code>, <code>hba_path</code>, <code>ip</code>, <code>cluster_id</code>, <code>instance</code>, <code>listen_port</code>, <code>wal_level</code>, <code>ver_num</code>, <code>cluster_name</code>, <code>data_dir</code></td>
<td>constant 1</td>
</tr>
<tr>
<td>pg_query_calls</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times the statement was executed</td>
</tr>
<tr>
<td>pg_query_exec_time</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total time spent executing the statement, in seconds</td>
</tr>
<tr>
<td>pg_query_io_time</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total time the statement spent reading and writing blocks, in seconds</td>
</tr>
<tr>
<td>pg_query_rows</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of rows retrieved or affected by the statement</td>
</tr>
<tr>
<td>pg_query_sblk_dirtied</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of shared blocks dirtied by the statement</td>
</tr>
<tr>
<td>pg_query_sblk_hit</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of shared block cache hits by the statement</td>
</tr>
<tr>
<td>pg_query_sblk_read</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of shared blocks read by the statement</td>
</tr>
<tr>
<td>pg_query_sblk_written</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of shared blocks written by the statement</td>
</tr>
<tr>
<td>pg_query_wal_bytes</td>
<td>counter</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total amount of WAL bytes generated by the statement</td>
</tr>
<tr>
<td>pg_receive_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>replica only, location of wal synced to disk</td>
</tr>
<tr>
<td>pg_recovery_backup_end_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Backup end location</td>
</tr>
<tr>
<td>pg_recovery_backup_start_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Backup start location</td>
</tr>
<tr>
<td>pg_recovery_min_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Minimum recovery ending location</td>
</tr>
<tr>
<td>pg_recovery_min_timeline</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Min recovery ending loc&rsquo;s timeline</td>
</tr>
<tr>
<td>pg_recovery_prefetch_block_distance</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>How many blocks ahead the prefetcher is looking</td>
</tr>
<tr>
<td>pg_recovery_prefetch_hit</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of blocks not prefetched because they were already in the buffer pool</td>
</tr>
<tr>
<td>pg_recovery_prefetch_io_depth</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>How many prefetches have been initiated but are not yet known to have completed</td>
</tr>
<tr>
<td>pg_recovery_prefetch_prefetch</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of blocks prefetched because they were not in the buffer pool</td>
</tr>
<tr>
<td>pg_recovery_prefetch_reset_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time at which these recovery prefetch statistics were last reset</td>
</tr>
<tr>
<td>pg_recovery_prefetch_skip_fpw</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of blocks not prefetched because a full page image was included in the WAL</td>
</tr>
<tr>
<td>pg_recovery_prefetch_skip_init</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of blocks not prefetched because they would be zero-initialized</td>
</tr>
<tr>
<td>pg_recovery_prefetch_skip_new</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of blocks not prefetched because they didn&rsquo;t exist yet</td>
</tr>
<tr>
<td>pg_recovery_prefetch_skip_rep</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of blocks not prefetched because they were already recently prefetched</td>
</tr>
<tr>
<td>pg_recovery_prefetch_wal_distance</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>How many bytes ahead the prefetcher is looking</td>
</tr>
<tr>
<td>pg_recovery_require_record</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>End-of-backup record required</td>
</tr>
<tr>
<td>pg_recv_flush_lsn</td>
<td>counter</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Last write-ahead log location already received and flushed to disk</td>
</tr>
<tr>
<td>pg_recv_flush_tli</td>
<td>counter</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Timeline number of last write-ahead log location received and flushed to disk</td>
</tr>
<tr>
<td>pg_recv_init_lsn</td>
<td>counter</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>First write-ahead log location used when WAL receiver is started</td>
</tr>
<tr>
<td>pg_recv_init_tli</td>
<td>counter</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>First timeline number used when WAL receiver is started</td>
</tr>
<tr>
<td>pg_recv_msg_recv_time</td>
<td>gauge</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Receipt time of last message received from origin WAL sender</td>
</tr>
<tr>
<td>pg_recv_msg_send_time</td>
<td>gauge</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Send time of last message received from origin WAL sender</td>
</tr>
<tr>
<td>pg_recv_pid</td>
<td>gauge</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Process ID of the WAL receiver process</td>
</tr>
<tr>
<td>pg_recv_reported_lsn</td>
<td>counter</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Last write-ahead log location reported to origin WAL sender</td>
</tr>
<tr>
<td>pg_recv_reported_time</td>
<td>gauge</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Time of last write-ahead log location reported to origin WAL sender</td>
</tr>
<tr>
<td>pg_recv_time</td>
<td>gauge</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Time of current snapshot</td>
</tr>
<tr>
<td>pg_recv_write_lsn</td>
<td>counter</td>
<td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td>
<td>Last write-ahead log location already received and written to disk, but not flushed.</td>
</tr>
<tr>
<td>pg_relkind_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>relkind</code></td>
<td>Number of relations of corresponding relkind</td>
</tr>
<tr>
<td>pg_repl_backend_xmin</td>
<td>counter</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>This standby&rsquo;s xmin horizon reported by hot_standby_feedback.</td>
</tr>
<tr>
<td>pg_repl_client_port</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>TCP port number that the client is using for communication with this WAL sender, or -1 if a Unix socket is used</td>
</tr>
<tr>
<td>pg_repl_flush_diff</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Last log position flushed to disk by this standby server diff with current lsn</td>
</tr>
<tr>
<td>pg_repl_flush_lag</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written and flushed it</td>
</tr>
<tr>
<td>pg_repl_flush_lsn</td>
<td>counter</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Last write-ahead log location flushed to disk by this standby server</td>
</tr>
<tr>
<td>pg_repl_launch_time</td>
<td>counter</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time when this process was started, i.e., when the client connected to this WAL sender</td>
</tr>
<tr>
<td>pg_repl_lsn</td>
<td>counter</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Current log position on this server</td>
</tr>
<tr>
<td>pg_repl_replay_diff</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Last log position replayed into the database on this standby server diff with current lsn</td>
</tr>
<tr>
<td>pg_repl_replay_lag</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written, flushed and applied it</td>
</tr>
<tr>
<td>pg_repl_replay_lsn</td>
<td>counter</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Last write-ahead log location replayed into the database on this standby server</td>
</tr>
<tr>
<td>pg_repl_reply_time</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Send time of last reply message received from standby server</td>
</tr>
<tr>
<td>pg_repl_sent_diff</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Last log position sent to this standby server diff with current lsn</td>
</tr>
<tr>
<td>pg_repl_sent_lsn</td>
<td>counter</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Last write-ahead log location sent on this connection</td>
</tr>
<tr>
<td>pg_repl_state</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Current WAL sender encoded state 0-4 for streaming startup catchup backup stopping</td>
</tr>
<tr>
<td>pg_repl_sync_priority</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Priority of this standby server for being chosen as the synchronous standby</td>
</tr>
<tr>
<td>pg_repl_sync_state</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Encoded synchronous state of this standby server, 0-3 for async potential sync quorum</td>
</tr>
<tr>
<td>pg_repl_time</td>
<td>counter</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Current timestamp in unix epoch</td>
</tr>
<tr>
<td>pg_repl_write_diff</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Last log position written to disk by this standby server diff with current lsn</td>
</tr>
<tr>
<td>pg_repl_write_lag</td>
<td>gauge</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written it</td>
</tr>
<tr>
<td>pg_repl_write_lsn</td>
<td>counter</td>
<td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Last write-ahead log location written to disk by this standby server</td>
</tr>
<tr>
<td>pg_replay_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>replica only, location of wal applied</td>
</tr>
<tr>
<td>pg_seq_blks_hit</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>seqname</code></td>
<td>Number of buffer hits in this sequence</td>
</tr>
<tr>
<td>pg_seq_blks_read</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>seqname</code></td>
<td>Number of disk blocks read from this sequence</td>
</tr>
<tr>
<td>pg_seq_last_value</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>seqname</code></td>
<td>The last sequence value written to disk</td>
</tr>
<tr>
<td>pg_setting_block_size</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>pg page block size, 8192 by default</td>
</tr>
<tr>
<td>pg_setting_data_checksums</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>whether data checksum is enabled, 1 enabled 0 disabled</td>
</tr>
<tr>
<td>pg_setting_max_connections</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>number of concurrent connections to the database server</td>
</tr>
<tr>
<td>pg_setting_max_locks_per_transaction</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>no more than this many distinct objects can be locked at any one time</td>
</tr>
<tr>
<td>pg_setting_max_prepared_transactions</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>maximum number of transactions that can be in the prepared state simultaneously</td>
</tr>
<tr>
<td>pg_setting_max_replication_slots</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>maximum number of replication slots</td>
</tr>
<tr>
<td>pg_setting_max_wal_senders</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>maximum number of concurrent connections from standby servers</td>
</tr>
<tr>
<td>pg_setting_max_worker_processes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>maximum number of background processes that the system can support</td>
</tr>
<tr>
<td>pg_setting_wal_log_hints</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>whether wal_log_hints is enabled, 1 enabled 0 disabled</td>
</tr>
<tr>
<td>pg_size_bytes</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>File size in bytes</td>
</tr>
<tr>
<td>pg_slot_active</td>
<td>gauge</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>True(1) if this slot is currently actively being used</td>
</tr>
<tr>
<td>pg_slot_catalog_xmin</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>The oldest transaction affecting the system catalogs that this slot needs the database to retain.</td>
</tr>
<tr>
<td>pg_slot_confirm_lsn</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>The address (LSN) up to which the logical slot&rsquo;s consumer has confirmed receiving data.</td>
</tr>
<tr>
<td>pg_slot_reset_time</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>When statistics were last reset</td>
</tr>
<tr>
<td>pg_slot_restart_lsn</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>The address (LSN) of oldest WAL which still might be required by the consumer of this slot</td>
</tr>
<tr>
<td>pg_slot_retained_bytes</td>
<td>gauge</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Size of bytes that retained for this slot</td>
</tr>
<tr>
<td>pg_slot_safe_wal_size</td>
<td>gauge</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>bytes that can be written to WAL which will not make slot into lost</td>
</tr>
<tr>
<td>pg_slot_spill_bytes</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Bytes that spilled to disk due to logical decode mem exceeding</td>
</tr>
<tr>
<td>pg_slot_spill_count</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Xacts that spilled to disk due to logical decode mem exceeding (a xact can be spilled multiple times)</td>
</tr>
<tr>
<td>pg_slot_spill_txns</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Xacts that spilled to disk due to logical decode mem exceeding (subtrans included)</td>
</tr>
<tr>
<td>pg_slot_stream_bytes</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Bytes that streamed to decoding output plugin after mem exceed</td>
</tr>
<tr>
<td>pg_slot_stream_count</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Xacts that streamed to decoding output plugin after mem exceed  (a xact can be streamed multiple times)</td>
</tr>
<tr>
<td>pg_slot_stream_txns</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Xacts that streamed to decoding output plugin after mem exceed</td>
</tr>
<tr>
<td>pg_slot_temporary</td>
<td>gauge</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>True(1) if this is a temporary replication slot.</td>
</tr>
<tr>
<td>pg_slot_total_bytes</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of decoded bytes sent to the decoding output plugin for this slot</td>
</tr>
<tr>
<td>pg_slot_total_txns</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of decoded xacts sent to the decoding output plugin for this slot</td>
</tr>
<tr>
<td>pg_slot_wal_status</td>
<td>gauge</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>WAL reserve status 0-3 means reserved,extended,unreserved,lost, -1 means other</td>
</tr>
<tr>
<td>pg_slot_xmin</td>
<td>counter</td>
<td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>The oldest transaction that this slot needs the database to retain.</td>
</tr>
<tr>
<td>pg_slru_blks_exists</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of blocks checked for existence for this SLRU</td>
</tr>
<tr>
<td>pg_slru_blks_hit</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times disk blocks were found already in the SLRU, so that a read was not necessary</td>
</tr>
<tr>
<td>pg_slru_blks_read</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of disk blocks read for this SLRU</td>
</tr>
<tr>
<td>pg_slru_blks_written</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of disk blocks written for this SLRU</td>
</tr>
<tr>
<td>pg_slru_blks_zeroed</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of blocks zeroed during initializations</td>
</tr>
<tr>
<td>pg_slru_flushes</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of flushes of dirty data for this SLRU</td>
</tr>
<tr>
<td>pg_slru_reset_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time at which these statistics were last reset</td>
</tr>
<tr>
<td>pg_slru_truncates</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of truncates for this SLRU</td>
</tr>
<tr>
<td>pg_ssl_disabled</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of client connection that does not use ssl</td>
</tr>
<tr>
<td>pg_ssl_enabled</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of client connection that use ssl</td>
</tr>
<tr>
<td>pg_sync_standby_enabled</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>names</code>, <code>instance</code>, <code>cls</code></td>
<td>Synchronous commit enabled, 1 if enabled, 0 if disabled</td>
</tr>
<tr>
<td>pg_table_age</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Age of this table in vacuum cycles</td>
</tr>
<tr>
<td>pg_table_analyze_count</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times this table has been manually analyzed</td>
</tr>
<tr>
<td>pg_table_autoanalyze_count</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times this table has been analyzed by the autovacuum daemon</td>
</tr>
<tr>
<td>pg_table_autovacuum_count</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times this table has been vacuumed by the autovacuum daemon</td>
</tr>
<tr>
<td>pg_table_frozenxid</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>All txid before this have been frozen on this table</td>
</tr>
<tr>
<td>pg_table_heap_blks_hit</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of buffer hits in this table</td>
</tr>
<tr>
<td>pg_table_heap_blks_read</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of disk blocks read from this table</td>
</tr>
<tr>
<td>pg_table_idx_blks_hit</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of buffer hits in all indexes on this table</td>
</tr>
<tr>
<td>pg_table_idx_blks_read</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of disk blocks read from all indexes on this table</td>
</tr>
<tr>
<td>pg_table_idx_scan</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of index scans initiated on this table</td>
</tr>
<tr>
<td>pg_table_idx_tup_fetch</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of live rows fetched by index scans</td>
</tr>
<tr>
<td>pg_table_kind</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Relation kind r/table/114</td>
</tr>
<tr>
<td>pg_table_n_dead_tup</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Estimated number of dead rows</td>
</tr>
<tr>
<td>pg_table_n_ins_since_vacuum</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Estimated number of rows inserted since this table was last vacuumed</td>
</tr>
<tr>
<td>pg_table_n_live_tup</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Estimated number of live rows</td>
</tr>
<tr>
<td>pg_table_n_mod_since_analyze</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Estimated number of rows modified since this table was last analyzed</td>
</tr>
<tr>
<td>pg_table_n_tup_del</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows deleted</td>
</tr>
<tr>
<td>pg_table_n_tup_hot_upd</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows HOT updated (i.e with no separate index update required)</td>
</tr>
<tr>
<td>pg_table_n_tup_ins</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows inserted</td>
</tr>
<tr>
<td>pg_table_n_tup_mod</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows modified (insert + update + delete)</td>
</tr>
<tr>
<td>pg_table_n_tup_newpage_upd</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows updated where the successor version goes onto a new heap page</td>
</tr>
<tr>
<td>pg_table_n_tup_upd</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of rows updated (includes HOT updated rows)</td>
</tr>
<tr>
<td>pg_table_ncols</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of columns in the table</td>
</tr>
<tr>
<td>pg_table_pages</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Size of the on-disk representation of this table in pages</td>
</tr>
<tr>
<td>pg_table_relid</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Relation oid of this table</td>
</tr>
<tr>
<td>pg_table_seq_scan</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of sequential scans initiated on this table</td>
</tr>
<tr>
<td>pg_table_seq_tup_read</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of live rows fetched by sequential scans</td>
</tr>
<tr>
<td>pg_table_size_bytes</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total bytes of this table (including toast, index, toast index)</td>
</tr>
<tr>
<td>pg_table_size_indexsize</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Bytes of all related indexes of this table</td>
</tr>
<tr>
<td>pg_table_size_relsize</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Bytes of this table itself (main, vm, fsm)</td>
</tr>
<tr>
<td>pg_table_size_toastsize</td>
<td>gauge</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Bytes of toast tables of this table</td>
</tr>
<tr>
<td>pg_table_tbl_scan</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of scans initiated on this table</td>
</tr>
<tr>
<td>pg_table_tup_read</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of live rows fetched by scans</td>
</tr>
<tr>
<td>pg_table_tuples</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>All txid before this have been frozen on this table</td>
</tr>
<tr>
<td>pg_table_vacuum_count</td>
<td>counter</td>
<td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times this table has been manually vacuumed (not counting VACUUM FULL)</td>
</tr>
<tr>
<td>pg_timestamp</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>database current timestamp</td>
</tr>
<tr>
<td>pg_up</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>last scrape was able to connect to the server: 1 for yes, 0 for no</td>
</tr>
<tr>
<td>pg_uptime</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds since postmaster start</td>
</tr>
<tr>
<td>pg_version</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>server version number</td>
</tr>
<tr>
<td>pg_wait_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>event</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Count of WaitEvent on target database</td>
</tr>
<tr>
<td>pg_wal_buffers_full</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times WAL data was written to disk because WAL buffers became full</td>
</tr>
<tr>
<td>pg_wal_bytes</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total amount of WAL generated in bytes</td>
</tr>
<tr>
<td>pg_wal_fpi</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of WAL full page images generated</td>
</tr>
<tr>
<td>pg_wal_records</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of WAL records generated</td>
</tr>
<tr>
<td>pg_wal_reset_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>When statistics were last reset</td>
</tr>
<tr>
<td>pg_wal_sync</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times WAL files were synced to disk via issue_xlog_fsync request</td>
</tr>
<tr>
<td>pg_wal_sync_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total amount of time spent syncing WAL files to disk via issue_xlog_fsync request, in seconds</td>
</tr>
<tr>
<td>pg_wal_write</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of times WAL buffers were written out to disk via XLogWrite request.</td>
</tr>
<tr>
<td>pg_wal_write_time</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total amount of time spent writing WAL buffers to disk via XLogWrite request in seconds</td>
</tr>
<tr>
<td>pg_write_lsn</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>primary only, location of current wal writing</td>
</tr>
<tr>
<td>pg_xact_xmax</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>First as-yet-unassigned txid. txid &gt;= this are invisible.</td>
</tr>
<tr>
<td>pg_xact_xmin</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Earliest txid that is still active</td>
</tr>
<tr>
<td>pg_xact_xnum</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Current active transaction count</td>
</tr>
<tr>
<td>pgbouncer:cls:load1</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:cls:load15</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:cls:load5</td>
<td>Unknown</td>
<td><code>job</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:db:conn_usage</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:db:conn_usage_reserve</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:db:pool_current_conn</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:db:pool_disabled</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:db:pool_max_conn</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:db:pool_paused</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:db:pool_reserve_size</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:db:pool_size</td>
<td>Unknown</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:free_clients</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:free_servers</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:load1</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:load15</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:load5</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:login_clients</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:pool_databases</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:pool_users</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:pools</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer:ins:used_clients</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer_database_current_connections</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>Current number of connections for this database</td>
</tr>
<tr>
<td>pgbouncer_database_disabled</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>True(1) if this database is currently disabled, else 0</td>
</tr>
<tr>
<td>pgbouncer_database_max_connections</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>Maximum number of allowed connections for this database</td>
</tr>
<tr>
<td>pgbouncer_database_min_pool_size</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>Minimum number of server connections</td>
</tr>
<tr>
<td>pgbouncer_database_paused</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>True(1) if this database is currently paused, else 0</td>
</tr>
<tr>
<td>pgbouncer_database_pool_size</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>Maximum number of server connections</td>
</tr>
<tr>
<td>pgbouncer_database_reserve_pool</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td>
<td>Maximum number of additional connections for this database</td>
</tr>
<tr>
<td>pgbouncer_exporter_agent_up</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>pgbouncer_exporter_last_scrape_time</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds exporter spending on scrapping</td>
</tr>
<tr>
<td>pgbouncer_exporter_query_cache_ttl</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times to live of query cache</td>
</tr>
<tr>
<td>pgbouncer_exporter_query_scrape_duration</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds query spending on scrapping</td>
</tr>
<tr>
<td>pgbouncer_exporter_query_scrape_error_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times the query failed</td>
</tr>
<tr>
<td>pgbouncer_exporter_query_scrape_hit_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>numbers been scrapped from this query</td>
</tr>
<tr>
<td>pgbouncer_exporter_query_scrape_metric_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>numbers of metrics been scrapped from this query</td>
</tr>
<tr>
<td>pgbouncer_exporter_query_scrape_total_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times exporter server was scraped for metrics</td>
</tr>
<tr>
<td>pgbouncer_exporter_scrape_duration</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds exporter spending on scrapping</td>
</tr>
<tr>
<td>pgbouncer_exporter_scrape_error_count</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times exporter was scraped for metrics and failed</td>
</tr>
<tr>
<td>pgbouncer_exporter_scrape_total_count</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times exporter was scraped for metrics</td>
</tr>
<tr>
<td>pgbouncer_exporter_server_scrape_duration</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds exporter server spending on scrapping</td>
</tr>
<tr>
<td>pgbouncer_exporter_server_scrape_total_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>times exporter server was scraped for metrics</td>
</tr>
<tr>
<td>pgbouncer_exporter_server_scrape_total_seconds</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds exporter server spending on scrapping</td>
</tr>
<tr>
<td>pgbouncer_exporter_up</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>always be 1 if your could retrieve metrics</td>
</tr>
<tr>
<td>pgbouncer_exporter_uptime</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>seconds since exporter primary server inited</td>
</tr>
<tr>
<td>pgbouncer_in_recovery</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>server is in recovery mode? 1 for yes 0 for no</td>
</tr>
<tr>
<td>pgbouncer_list_items</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>list</code>, <code>cls</code></td>
<td>Number of corresponding pgbouncer object</td>
</tr>
<tr>
<td>pgbouncer_pool_active_cancel_clients</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Client connections that have forwarded query cancellations to the server and are waiting for the server response.</td>
</tr>
<tr>
<td>pgbouncer_pool_active_cancel_servers</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Server connections that are currently forwarding a cancel request</td>
</tr>
<tr>
<td>pgbouncer_pool_active_clients</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Client connections that are linked to server connection and can process queries</td>
</tr>
<tr>
<td>pgbouncer_pool_active_servers</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Server connections that are linked to a client</td>
</tr>
<tr>
<td>pgbouncer_pool_cancel_clients</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Client connections that have not forwarded query cancellations to the server yet.</td>
</tr>
<tr>
<td>pgbouncer_pool_cancel_servers</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>cancel requests have completed that were sent to cancel a query on this server</td>
</tr>
<tr>
<td>pgbouncer_pool_idle_servers</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Server connections that are unused and immediately usable for client queries</td>
</tr>
<tr>
<td>pgbouncer_pool_login_servers</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Server connections currently in the process of logging in</td>
</tr>
<tr>
<td>pgbouncer_pool_maxwait</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>How long the first(oldest) client in the queue has waited, in seconds, key metric</td>
</tr>
<tr>
<td>pgbouncer_pool_maxwait_us</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Microsecond part of the maximum waiting time.</td>
</tr>
<tr>
<td>pgbouncer_pool_tested_servers</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Server connections that are currently running reset or check query</td>
</tr>
<tr>
<td>pgbouncer_pool_used_servers</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Server connections that have been idle for more than server_check_delay (means have to run check query)</td>
</tr>
<tr>
<td>pgbouncer_pool_waiting_clients</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td>
<td>Client connections that have sent queries but have not yet got a server connection</td>
</tr>
<tr>
<td>pgbouncer_stat_avg_query_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Average queries per second in last stat period</td>
</tr>
<tr>
<td>pgbouncer_stat_avg_query_time</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Average query duration, in seconds</td>
</tr>
<tr>
<td>pgbouncer_stat_avg_recv</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Average received (from clients) bytes per second</td>
</tr>
<tr>
<td>pgbouncer_stat_avg_sent</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Average sent (to clients) bytes per second</td>
</tr>
<tr>
<td>pgbouncer_stat_avg_wait_time</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent by clients waiting for a server, in seconds (average per second).</td>
</tr>
<tr>
<td>pgbouncer_stat_avg_xact_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Average transactions per second in last stat period</td>
</tr>
<tr>
<td>pgbouncer_stat_avg_xact_time</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Average transaction duration, in seconds</td>
</tr>
<tr>
<td>pgbouncer_stat_total_query_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of SQL queries pooled by pgbouncer</td>
</tr>
<tr>
<td>pgbouncer_stat_total_query_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of seconds spent when executing queries</td>
</tr>
<tr>
<td>pgbouncer_stat_total_received</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total volume in bytes of network traffic received by pgbouncer</td>
</tr>
<tr>
<td>pgbouncer_stat_total_sent</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total volume in bytes of network traffic sent by pgbouncer</td>
</tr>
<tr>
<td>pgbouncer_stat_total_wait_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Time spent by clients waiting for a server, in seconds</td>
</tr>
<tr>
<td>pgbouncer_stat_total_xact_count</td>
<td>gauge</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of SQL transactions pooled by pgbouncer</td>
</tr>
<tr>
<td>pgbouncer_stat_total_xact_time</td>
<td>counter</td>
<td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of seconds spent when in a transaction</td>
</tr>
<tr>
<td>pgbouncer_up</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>last scrape was able to connect to the server: 1 for yes, 0 for no</td>
</tr>
<tr>
<td>pgbouncer_version</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>server version number</td>
</tr>
<tr>
<td>process_cpu_seconds_total</td>
<td>counter</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total user and system CPU time spent in seconds.</td>
</tr>
<tr>
<td>process_max_fds</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Maximum number of open file descriptors.</td>
</tr>
<tr>
<td>process_open_fds</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Number of open file descriptors.</td>
</tr>
<tr>
<td>process_resident_memory_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Resident memory size in bytes.</td>
</tr>
<tr>
<td>process_start_time_seconds</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Start time of the process since unix epoch in seconds.</td>
</tr>
<tr>
<td>process_virtual_memory_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Virtual memory size in bytes.</td>
</tr>
<tr>
<td>process_virtual_memory_max_bytes</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Maximum amount of virtual memory available in bytes.</td>
</tr>
<tr>
<td>promhttp_metric_handler_requests_in_flight</td>
<td>gauge</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Current number of scrapes being served.</td>
</tr>
<tr>
<td>promhttp_metric_handler_requests_total</td>
<td>counter</td>
<td><code>code</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>Total number of scrapes by HTTP status code.</td>
</tr>
<tr>
<td>scrape_duration_seconds</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>scrape_samples_post_metric_relabeling</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>scrape_samples_scraped</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>scrape_series_added</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
<tr>
<td>up</td>
<td>Unknown</td>
<td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td>
<td>N/A</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-06a73ab7adbd73b0e635c3d9403cab4e">16 - FAQ</h1>
    <div class="lead">Pigsty PGSQL module frequently asked questions</div>
	<hr>
<h2 id="abort-due-to-postgres-exists">ABORT due to postgres exists</h2>
<blockquote>
<p>Set <code>pg_clean</code> = <code>true</code> and <code>pg_safeguard</code> = <code>false</code> to force clean postgres data during <code>pgsql.yml</code></p>
</blockquote>
<p>This happens when you run <code>pgsql.yml</code> on a node with postgres running, and <a href="/docs/reference/param/#pg_clean"><code>pg_clean</code></a> is set to <code>false</code>.</p>
<p>If <code>pg_clean</code> is true (and the <code>pg_safeguard</code> is <code>false</code>, too), the <code>pgsql.yml</code> playbook will remove the existing pgsql data and re-init it as a new one, which makes this playbook fully idempotent.</p>
<p>You can still purge the existing PostgreSQL data by using a special task tag <code>pg_purge</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_clean      <span style="color:#8f5902;font-style:italic"># honor pg_clean and pg_safeguard</span>
</span></span><span style="display:flex;"><span>./pgsql.yml -t pg_purge      <span style="color:#8f5902;font-style:italic"># ignore pg_clean and pg_safeguard</span>
</span></span></code></pre></div><hr>
<h2 id="abort-due-to-pg_safeguard-enabled">ABORT due to pg_safeguard enabled</h2>
<blockquote>
<p>Disable <code>pg_safeguard</code> to remove the Postgres instance.</p>
</blockquote>
<p>If <a href="/docs/reference/param/#pg_safeguard"><code>pg_safeguard</code></a> is enabled, you can not remove the running pgsql instance with <code>bin/pgsql-rm</code> and <code>pgsql-rm.yml</code> playbook.</p>
<p>To disable <code>pg_safeguard</code>, you can set <code>pg_safeguard</code> to <code>false</code> in the inventory or pass <code>-e pg_safeguard=false</code> as cli arg to the playbook:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql-rm.yml -e <span style="color:#000">pg_safeguard</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span> -l &lt;cls_to_remove&gt;    <span style="color:#8f5902;font-style:italic"># force override pg_safeguard</span>
</span></span></code></pre></div><hr>
<h2 id="fail-to-wait-for-postgrespatroni-primary">Fail to wait for postgres/patroni primary</h2>
<p>There are several possible reasons for this error, and you need to <a href="https://github.com/Vonng/pigsty/discussions/338">check</a> the system logs to determine the actual cause.</p>
<p>This usually happens when the cluster is misconfigured, or the previous primary is improperly removed. (e.g., trash metadata in DCS with the same cluster name).</p>
<p>You must check <code>/pg/log/*</code> to find the reason.</p>
<p>To delete trash meta from etcd, you can use <code>etcdctl del --prefix /pg/&lt;cls&gt;</code>, do with caution!</p>
<ul>
<li>1: Misconfiguration. Identify the incorrect parameters, modify them, and apply the changes.</li>
<li>2: Another cluster with the same cls name already exists in the deployment</li>
<li>3: The previous cluster on the node, or previous cluster with same name was not correctly removed.
<ul>
<li>To remove obsolete cluster metadata, you can use <code>etcdctl del --prefix /pg/&lt;cls&gt;</code> to manually delete the residual data.</li>
</ul>
</li>
<li>4: The RPM packages related to your PostgreSQL or node were not successfully installed.</li>
<li>5: Your Watchdog kernel module was not correctly enabled or loaded, but required.</li>
<li>6: The locale or ctype specified <code>pg_lc_collate</code> and <code>pg_lc_ctype</code> does not exist in OS</li>
</ul>
<p>Feel free to submit an issue or seek help from the community.</p>
<hr>
<h2 id="fail-to-wait-for-postgrespatroni-replica">Fail to wait for postgres/patroni replica</h2>
<p><strong>Failed Immediately</strong>: Usually, this happens because of misconfiguration, network issues, broken DCS metadata, etc&hellip;, you have to inspect <code>/pg/log</code> to find out the actual reason.</p>
<p><strong>Failed After a While</strong>: This may be due to source instance data corruption. Check PGSQL FAQ: How to create replicas when data is corrupted?</p>
<p><strong>Timeout</strong>: If the <code>wait for postgres replica</code> task takes 30min or more and fails due to timeout, This is common for a huge cluster (e.g., 1TB+, which may take hours to create a replica). In this case, the underlying creating replica procedure is still proceeding. You can check cluster status with <code>pg list &lt;cls&gt;</code> and wait until the replica catches up with the primary. Then continue the following tasks:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql.yml -t pg_hba,pg_param,pg_backup,pgbouncer,pg_vip,pg_dns,pg_service,pg_exporter,pg_register -l &lt;problematic_replica&gt;
</span></span></code></pre></div><hr>
<h2 id="install-postgresql-12---15">Install PostgreSQL 12 - 15</h2>
<p>To install PostgreSQL 12 - 15, you have to set <code>pg_version</code> to <code>12</code>, <code>13</code>, <code>14</code>, or <code>15</code> in the inventory. (usually at cluster level)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">pg_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#8f5902;font-style:italic"># install pg 16 in this template</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_libs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;pg_stat_statements, auto_explain&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># remove timescaledb from pg 16 beta</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pg_extensions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># missing pg16 extensions for now</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><hr>
<h2 id="how-enable-hugepage-for-postgresql">How enable hugepage for PostgreSQL?</h2>
<blockquote>
<p>use <code>node_hugepage_count</code> and <code>node_hugepage_ratio</code> or <code>/pg/bin/pg-tune-hugepage</code></p>
</blockquote>
<p>If you plan to enable hugepage, consider using <code>node_hugepage_count</code> and <code>node_hugepage_ratio</code> and apply with <code>./node.yml -t node_tune</code> .</p>
<p>It&rsquo;s good to allocate <strong>enough</strong> hugepage before postgres start, and use <code>pg_tune_hugepage</code> to shrink them later.</p>
<p>If your postgres is already running, you can use <code>/pg/bin/pg-tune-hugepage</code> to enable hugepage on the fly. Note that this only works on PostgreSQL 15+</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sync<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">echo</span> <span style="color:#0000cf;font-weight:bold">3</span> &gt; /proc/sys/vm/drop_caches   <span style="color:#8f5902;font-style:italic"># drop system cache (ready for performance impact)</span>
</span></span><span style="display:flex;"><span>sudo /pg/bin/pg-tune-hugepage             <span style="color:#8f5902;font-style:italic"># write nr_hugepages to /etc/sysctl.d/hugepage.conf</span>
</span></span><span style="display:flex;"><span>pg restart &lt;cls&gt;                          <span style="color:#8f5902;font-style:italic"># restart postgres to use hugepage</span>
</span></span></code></pre></div><hr>
<h2 id="how-to-guarantee-zero-data-loss-during-failover">How to guarantee zero data loss during failover?</h2>
<blockquote>
<p>Use <code>crit.yml</code> template, or setting <code>pg_rpo</code> to <code>0</code>, or <a href="/docs/pgsql/admin/#config-cluster">config cluster</a> with synchronous mode.</p>
</blockquote>
<p>Consider using <a href="/docs/pgsql/conf#sync-standby">Sync Standby</a> and <a href="/docs/pgsql/conf#quorum-commit">Quorum Comit</a> to guarantee 0 data loss during failover.</p>
<hr>
<h2 id="how-to-survive-from-disk-full">How to survive from disk full?</h2>
<blockquote>
<p><code>rm -rf /pg/dummy</code> will free some emergency space.</p>
</blockquote>
<p>The <a href="/docs/reference/param/#pg_dummy_filesize"><code>pg_dummy_filesize</code></a> is set to <code>64MB</code> by default. Consider increasing it to <code>8GB</code> or larger in the production environment.</p>
<p>It will be placed on <code>/pg/dummy</code> same disk as the PGSQL main data disk. You can remove that file to free some emergency space. At least you can run some shell scripts on that node.</p>
<hr>
<h2 id="how-to-create-replicas-when-data-is-corrupted">How to create replicas when data is corrupted?</h2>
<blockquote>
<p>Disable <code>clonefrom</code> on bad instances and reload patroni config.</p>
</blockquote>
<p>Pigsty sets the <code>cloneform: true</code> tag on all instances&rsquo; patroni config, which marks the instance available for cloning replica.</p>
<p>If this instance has corrupt data files, you can set <code>clonefrom: false</code> to avoid pulling data from the evil instance. To do so:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ vi /pg/bin/patroni.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tags:
</span></span><span style="display:flex;"><span>  nofailover: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  clonefrom: <span style="color:#204a87">true</span>      <span style="color:#8f5902;font-style:italic"># ----------&gt; change to false</span>
</span></span><span style="display:flex;"><span>  noloadbalance: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  nosync: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  version:  <span style="color:#4e9a06">&#39;15&#39;</span>
</span></span><span style="display:flex;"><span>  spec: <span style="color:#4e9a06">&#39;4C.8G.50G&#39;</span>
</span></span><span style="display:flex;"><span>  conf: <span style="color:#4e9a06">&#39;oltp.yml&#39;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>$ systemctl reload patroni
</span></span></code></pre></div><hr>
<h2 id="how-to-create-replicas-when-data-is-corrupted-1">How to create replicas when data is corrupted?</h2>
<blockquote>
<p>Disable <code>clonefrom</code> on bad instances and reload patroni config.</p>
</blockquote>
<p>Pigsty sets the <code>cloneform: true</code> tag on all instances&rsquo; patroni config, which marks the instance available for cloning replica.</p>
<p>If this instance has corrupt data files, you can set <code>clonefrom: false</code> to avoid pulling data from the evil instance. To do so:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ vi /pg/bin/patroni.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tags:
</span></span><span style="display:flex;"><span>  nofailover: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  clonefrom: <span style="color:#204a87">true</span>      <span style="color:#8f5902;font-style:italic"># ----------&gt; change to false</span>
</span></span><span style="display:flex;"><span>  noloadbalance: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  nosync: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  version:  <span style="color:#4e9a06">&#39;15&#39;</span>
</span></span><span style="display:flex;"><span>  spec: <span style="color:#4e9a06">&#39;4C.8G.50G&#39;</span>
</span></span><span style="display:flex;"><span>  conf: <span style="color:#4e9a06">&#39;oltp.yml&#39;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>$ systemctl reload patroni
</span></span></code></pre></div><hr>
<h2 id="performance-impact-of-monitoring-exporter">Performance impact of monitoring exporter</h2>
<p>Not very much, 200ms per 10 ~ 15 seconds, won&rsquo;t affect the database performance.</p>
<p>The default scrape interval for prometheus is 10s in pigsty, make sure the exporter can finish the scrape within that period.</p>
<hr>
<h2 id="how-to-monitor-an-existing-postgresql-instance">How to monitor an existing PostgreSQL instance?</h2>
<p>Check <a href="/docs/pgsql/monitor/">PGSQL Monitor</a> for details.</p>
<hr>
<h2 id="how-to-remove-monitor-targets-from-prometheus">How to remove monitor targets from prometheus?</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./pgsql-rm.yml -t prometheus -l &lt;cls&gt;     <span style="color:#8f5902;font-style:italic"># remove prometheus targets of cluster &#39;cls&#39;</span>
</span></span></code></pre></div><p>Or</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bin/pgmon-rm &lt;ins&gt;     <span style="color:#8f5902;font-style:italic"># shortcut for removing prometheus targets of pgsql instance &#39;ins&#39;</span>
</span></span></code></pre></div>
</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Mail" aria-label="Mail">
    <a target="_blank" rel="noopener" href="mailto:rh@vonng.com" aria-label="Mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Vonng/pigsty" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://twitter.com/GobeUncleWang" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="WeChat" aria-label="WeChat">
    <a target="_blank" rel="noopener" href="/img/pigsty/pigsty-cc.jpg" aria-label="WeChat">
      <i class="fa fa-comment"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Discord" aria-label="Discord">
    <a target="_blank" rel="noopener" href="https://discord.gg/wDzt5VyWEz" aria-label="Discord">
      <i class="fab fa-discord"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Telegram" aria-label="Telegram">
    <a target="_blank" rel="noopener" href="https://t.me/joinchat/gV9zfZraNPM3YjFh" aria-label="Telegram">
      <i class="fab fa-telegram"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2018&ndash;2025
    <span class="td-footer__authors">Ruohang Feng</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span></span><span class="ms-2"><a href="https://vonng.com/en/" target="_blank" rel="noopener">@Vonng</a></span>
<br><span>Pigsty® distributed under <a href="/docs/about/license" target="_blank" rel="noopener">AGPLv3</a></span>
<br><span class="ms-2"><a href="/docs/about/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
<span><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">浙ICP备15016890号</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.248655eb216150e39da254c2f7aa5357805d0ec66bdb741b591cd35fb5f629ab.js" integrity="sha256-JIZV6yFhUOOdolTC96pTV4BdDsZr23QbWRzTX7X2Kas=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
